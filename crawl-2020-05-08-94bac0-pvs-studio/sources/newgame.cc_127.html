
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=US-ASCII" />
  <title>newgame.cc</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">/**</a>
<a name="ln2"> * @file</a>
<a name="ln3"> * @brief Functions used when starting a new game.</a>
<a name="ln4">**/</a>
<a name="ln5"> </a>
<a name="ln6">#include &quot;AppHdr.h&quot;</a>
<a name="ln7"> </a>
<a name="ln8">#include &quot;newgame.h&quot;</a>
<a name="ln9"> </a>
<a name="ln10">#include &quot;cio.h&quot;</a>
<a name="ln11">#include &quot;command.h&quot;</a>
<a name="ln12">#include &quot;database.h&quot;</a>
<a name="ln13">#include &quot;end.h&quot;</a>
<a name="ln14">#include &quot;english.h&quot;</a>
<a name="ln15">#include &quot;files.h&quot;</a>
<a name="ln16">#include &quot;hints.h&quot;</a>
<a name="ln17">#include &quot;initfile.h&quot;</a>
<a name="ln18">#include &quot;item-name.h&quot; // make_name</a>
<a name="ln19">#include &quot;item-prop.h&quot;</a>
<a name="ln20">#include &quot;jobs.h&quot;</a>
<a name="ln21">#include &quot;libutil.h&quot;</a>
<a name="ln22">#include &quot;macro.h&quot;</a>
<a name="ln23">#include &quot;maps.h&quot;</a>
<a name="ln24">#include &quot;menu.h&quot;</a>
<a name="ln25">#include &quot;ng-input.h&quot;</a>
<a name="ln26">#include &quot;ng-restr.h&quot;</a>
<a name="ln27">#include &quot;options.h&quot;</a>
<a name="ln28">#include &quot;playable.h&quot;</a>
<a name="ln29">#include &quot;prompt.h&quot;</a>
<a name="ln30">#include &quot;skills.h&quot;</a>
<a name="ln31">#include &quot;species-groups.h&quot;</a>
<a name="ln32">#include &quot;state.h&quot;</a>
<a name="ln33">#include &quot;stringutil.h&quot;</a>
<a name="ln34">#ifdef USE_TILE</a>
<a name="ln35">#include &quot;tilereg-crt.h&quot;</a>
<a name="ln36">#include &quot;tilepick.h&quot;</a>
<a name="ln37">#include &quot;tilepick-p.h&quot;</a>
<a name="ln38">#include &quot;tilefont.h&quot;</a>
<a name="ln39">#include &quot;rltiles/tiledef-main.h&quot;</a>
<a name="ln40">#include &quot;rltiles/tiledef-feat.h&quot;</a>
<a name="ln41">#endif</a>
<a name="ln42">#include &quot;version.h&quot;</a>
<a name="ln43">#include &quot;ui.h&quot;</a>
<a name="ln44">#include &quot;outer-menu.h&quot;</a>
<a name="ln45"> </a>
<a name="ln46">using namespace ui;</a>
<a name="ln47"> </a>
<a name="ln48">static void _choose_gamemode_map(newgame_def&amp; ng, newgame_def&amp; ng_choice,</a>
<a name="ln49">                                 const newgame_def&amp; defaults);</a>
<a name="ln50">static bool _choose_weapon(newgame_def&amp; ng, newgame_def&amp; ng_choice,</a>
<a name="ln51">                          const newgame_def&amp; defaults);</a>
<a name="ln52"> </a>
<a name="ln53">#ifdef USE_TILE_LOCAL</a>
<a name="ln54">#  define STARTUP_HIGHLIGHT_NORMAL LIGHTGRAY</a>
<a name="ln55">#  define STARTUP_HIGHLIGHT_BAD LIGHTGRAY</a>
<a name="ln56">#  define STARTUP_HIGHLIGHT_CONTROL LIGHTGRAY</a>
<a name="ln57">#  define STARTUP_HIGHLIGHT_GOOD LIGHTGREEN</a>
<a name="ln58">#else</a>
<a name="ln59">#  define STARTUP_HIGHLIGHT_NORMAL BLUE</a>
<a name="ln60">#  define STARTUP_HIGHLIGHT_BAD LIGHTGRAY</a>
<a name="ln61">#  define STARTUP_HIGHLIGHT_CONTROL BLUE</a>
<a name="ln62">#  define STARTUP_HIGHLIGHT_GOOD GREEN</a>
<a name="ln63">#endif</a>
<a name="ln64"> </a>
<a name="ln65">////////////////////////////////////////////////////////////////////////</a>
<a name="ln66">// Remember player's startup options</a>
<a name="ln67">//</a>
<a name="ln68"> </a>
<a name="ln69">newgame_def::newgame_def()</a>
<a name="ln70">    : name(), type(GAME_TYPE_NORMAL),</a>
<a name="ln71">      seed(0), pregenerate(false),</a>
<a name="ln72">      species(SP_UNKNOWN), job(JOB_UNKNOWN),</a>
<a name="ln73">      weapon(WPN_UNKNOWN),</a>
<a name="ln74">      fully_random(false)</a>
<a name="ln75">{</a>
<a name="ln76">}</a>
<a name="ln77"> </a>
<a name="ln78">void newgame_def::clear_character()</a>
<a name="ln79">{</a>
<a name="ln80">    species  = SP_UNKNOWN;</a>
<a name="ln81">    job      = JOB_UNKNOWN;</a>
<a name="ln82">    weapon   = WPN_UNKNOWN;</a>
<a name="ln83">}</a>
<a name="ln84"> </a>
<a name="ln85">enum MenuOptions</a>
<a name="ln86">{</a>
<a name="ln87">    M_QUIT = -1,</a>
<a name="ln88">    M_ABORT = -2,</a>
<a name="ln89">    M_APTITUDES  = -3,</a>
<a name="ln90">    M_HELP = -4,</a>
<a name="ln91">    M_VIABLE = -5,</a>
<a name="ln92">    M_RANDOM = -6,</a>
<a name="ln93">    M_VIABLE_CHAR = -7,</a>
<a name="ln94">    M_RANDOM_CHAR = -8,</a>
<a name="ln95">    M_DEFAULT_CHOICE = -9,</a>
<a name="ln96">};</a>
<a name="ln97"> </a>
<a name="ln98">enum MenuChoices</a>
<a name="ln99">{</a>
<a name="ln100">    C_SPECIES = 0,</a>
<a name="ln101">    C_JOB = 1,</a>
<a name="ln102">};</a>
<a name="ln103"> </a>
<a name="ln104">enum MenuItemStatuses</a>
<a name="ln105">{</a>
<a name="ln106">    ITEM_STATUS_UNKNOWN,</a>
<a name="ln107">    ITEM_STATUS_RESTRICTED,</a>
<a name="ln108">    ITEM_STATUS_ALLOWED</a>
<a name="ln109">};</a>
<a name="ln110"> </a>
<a name="ln111">static bool _is_random_species(species_type sp)</a>
<a name="ln112">{</a>
<a name="ln113">    return sp == SP_RANDOM || sp == SP_VIABLE;</a>
<a name="ln114">}</a>
<a name="ln115"> </a>
<a name="ln116">static bool _is_random_job(job_type job)</a>
<a name="ln117">{</a>
<a name="ln118">    return job == JOB_RANDOM || job == JOB_VIABLE;</a>
<a name="ln119">}</a>
<a name="ln120"> </a>
<a name="ln121">static bool _is_random_choice(const newgame_def&amp; choice)</a>
<a name="ln122">{</a>
<a name="ln123">    return _is_random_species(choice.species)</a>
<a name="ln124">           &amp;&amp; _is_random_job(choice.job);</a>
<a name="ln125">}</a>
<a name="ln126"> </a>
<a name="ln127">static bool _is_random_viable_choice(const newgame_def&amp; choice)</a>
<a name="ln128">{</a>
<a name="ln129">    return _is_random_choice(choice) &amp;&amp;</a>
<a name="ln130">           (choice.job == JOB_VIABLE || choice.species == SP_VIABLE);</a>
<a name="ln131">}</a>
<a name="ln132"> </a>
<a name="ln133">static bool _char_defined(const newgame_def&amp; ng)</a>
<a name="ln134">{</a>
<a name="ln135">    return ng.species != SP_UNKNOWN &amp;&amp; ng.job != JOB_UNKNOWN;</a>
<a name="ln136">}</a>
<a name="ln137"> </a>
<a name="ln138">string newgame_char_description(const newgame_def&amp; ng)</a>
<a name="ln139">{</a>
<a name="ln140">    if (_is_random_viable_choice(ng))</a>
<a name="ln141">        return &quot;Recommended character&quot;;</a>
<a name="ln142">    else if (_is_random_choice(ng))</a>
<a name="ln143">        return &quot;Random character&quot;;</a>
<a name="ln144">    else if (_is_random_job(ng.job))</a>
<a name="ln145">    {</a>
<a name="ln146">        const string j = (ng.job == JOB_RANDOM ? &quot;Random &quot; : &quot;Recommended &quot;);</a>
<a name="ln147">        return j + species_name(ng.species);</a>
<a name="ln148">    }</a>
<a name="ln149">    else if (_is_random_species(ng.species))</a>
<a name="ln150">    {</a>
<a name="ln151">        const string s = (ng.species == SP_RANDOM ? &quot;Random &quot; : &quot;Recommended &quot;);</a>
<a name="ln152">        return s + get_job_name(ng.job);</a>
<a name="ln153">    }</a>
<a name="ln154">    else</a>
<a name="ln155">        return species_name(ng.species) + &quot; &quot; + get_job_name(ng.job);</a>
<a name="ln156">}</a>
<a name="ln157"> </a>
<a name="ln158">static string _welcome(const newgame_def&amp; ng)</a>
<a name="ln159">{</a>
<a name="ln160">    string text;</a>
<a name="ln161">    if (ng.species != SP_UNKNOWN)</a>
<a name="ln162">        text = species_name(ng.species);</a>
<a name="ln163">    if (ng.job != JOB_UNKNOWN)</a>
<a name="ln164">    {</a>
<a name="ln165">        if (!text.empty())</a>
<a name="ln166">            text += &quot; &quot;;</a>
<a name="ln167">        text += get_job_name(ng.job);</a>
<a name="ln168">    }</a>
<a name="ln169">    if (!ng.name.empty())</a>
<a name="ln170">    {</a>
<a name="ln171">        if (!text.empty())</a>
<a name="ln172">            text = &quot; the &quot; + text;</a>
<a name="ln173">        text = ng.name + text;</a>
<a name="ln174">    }</a>
<a name="ln175">    else if (!text.empty())</a>
<a name="ln176">        text = &quot;unnamed &quot; + text;</a>
<a name="ln177">    if (!text.empty())</a>
<a name="ln178">        text = &quot;, &quot; + text;</a>
<a name="ln179">    text = &quot;Welcome&quot; + text + &quot;.&quot;;</a>
<a name="ln180">    return text;</a>
<a name="ln181">}</a>
<a name="ln182"> </a>
<a name="ln183">void choose_tutorial_character(newgame_def&amp; ng_choice)</a>
<a name="ln184">{</a>
<a name="ln185">    ng_choice.species = SP_HUMAN;</a>
<a name="ln186">    ng_choice.job = JOB_FIGHTER;</a>
<a name="ln187">    ng_choice.weapon = WPN_FLAIL;</a>
<a name="ln188">}</a>
<a name="ln189"> </a>
<a name="ln190">static void _resolve_species(newgame_def&amp; ng, const newgame_def&amp; ng_choice)</a>
<a name="ln191">{</a>
<a name="ln192">    // Don't overwrite existing species.</a>
<a name="ln193">    if (ng.species != SP_UNKNOWN)</a>
<a name="ln194">        return;</a>
<a name="ln195"> </a>
<a name="ln196">    if (ng_choice.species != SP_VIABLE &amp;&amp; ng_choice.species != SP_RANDOM)</a>
<a name="ln197">    {</a>
<a name="ln198">        ng.species = ng_choice.species;</a>
<a name="ln199">        return;</a>
<a name="ln200">    }</a>
<a name="ln201"> </a>
<a name="ln202">    if (!is_starting_job(ng.job)) // VIABLE, RANDOM, UNKNOWN, or disabled</a>
<a name="ln203">    {</a>
<a name="ln204">        ng.species = random_starting_species();</a>
<a name="ln205">        return;</a>
<a name="ln206">    }</a>
<a name="ln207"> </a>
<a name="ln208">    auto candidate_species = playable_species();</a>
<a name="ln209"> </a>
<a name="ln210">    if (ng_choice.species == SP_VIABLE)</a>
<a name="ln211">    {</a>
<a name="ln212">        erase_if(candidate_species, [&amp;](const species_type sp) {</a>
<a name="ln213">            return !job_recommends_species(ng.job, sp);</a>
<a name="ln214">        });</a>
<a name="ln215">    }</a>
<a name="ln216">    else</a>
<a name="ln217">        erase_if(candidate_species, [&amp;](const species_type sp) {</a>
<a name="ln218">            return !character_is_allowed(sp, ng.job);</a>
<a name="ln219">        });</a>
<a name="ln220"> </a>
<a name="ln221">    ASSERT(candidate_species.size() &gt; 0);</a>
<a name="ln222">    ng.species = candidate_species[random2(candidate_species.size())];</a>
<a name="ln223">}</a>
<a name="ln224"> </a>
<a name="ln225">static void _resolve_job(newgame_def&amp; ng, const newgame_def&amp; ng_choice)</a>
<a name="ln226">{</a>
<a name="ln227">    if (ng.job != JOB_UNKNOWN)</a>
<a name="ln228">        return;</a>
<a name="ln229"> </a>
<a name="ln230">    if (ng_choice.job != JOB_VIABLE &amp;&amp; ng_choice.job != JOB_RANDOM)</a>
<a name="ln231">    {</a>
<a name="ln232">        ng.job = ng_choice.job;</a>
<a name="ln233">        return;</a>
<a name="ln234">    }</a>
<a name="ln235"> </a>
<a name="ln236">    if (!is_starting_species(ng.species)) // VIABLE, RANDOM, UNKNOWN, or disabled</a>
<a name="ln237">    {</a>
<a name="ln238">        ng.job = random_starting_job();</a>
<a name="ln239">        return;</a>
<a name="ln240">    }</a>
<a name="ln241"> </a>
<a name="ln242">    auto candidate_jobs = playable_jobs();</a>
<a name="ln243"> </a>
<a name="ln244">    if (ng_choice.job == JOB_VIABLE)</a>
<a name="ln245">    {</a>
<a name="ln246">        erase_if(candidate_jobs, [&amp;](const job_type job) {</a>
<a name="ln247">            return !species_recommends_job(ng.species, job);</a>
<a name="ln248">        });</a>
<a name="ln249">    }</a>
<a name="ln250">    else</a>
<a name="ln251">        erase_if(candidate_jobs, [&amp;](const job_type job) {</a>
<a name="ln252">            return !character_is_allowed(ng.species, job);</a>
<a name="ln253">        });</a>
<a name="ln254"> </a>
<a name="ln255">    ASSERT(candidate_jobs.size() &gt; 0);</a>
<a name="ln256">    ng.job = candidate_jobs[random2(candidate_jobs.size())];</a>
<a name="ln257">}</a>
<a name="ln258"> </a>
<a name="ln259">static void _resolve_species_job(newgame_def&amp; ng, const newgame_def&amp; ng_choice)</a>
<a name="ln260">{</a>
<a name="ln261">    // Since recommendations are no longer bidirectional, pick one of</a>
<a name="ln262">    // species or job to start. If one but not the other was specified</a>
<a name="ln263">    // as &quot;viable&quot;, always choose that one last; otherwise use a random</a>
<a name="ln264">    // order.</a>
<a name="ln265">    const bool spfirst  = ng_choice.species != SP_VIABLE</a>
<a name="ln266">                          &amp;&amp; ng_choice.job == JOB_VIABLE;</a>
<a name="ln267">    const bool jobfirst = ng_choice.species == SP_VIABLE</a>
<a name="ln268">                          &amp;&amp; ng_choice.job != JOB_VIABLE;</a>
<a name="ln269">    if (spfirst || !jobfirst &amp;&amp; coinflip())</a>
<a name="ln270">    {</a>
<a name="ln271">        _resolve_species(ng, ng_choice);</a>
<a name="ln272">        _resolve_job(ng, ng_choice);</a>
<a name="ln273">    }</a>
<a name="ln274">    else</a>
<a name="ln275">    {</a>
<a name="ln276">        _resolve_job(ng, ng_choice);</a>
<a name="ln277">        _resolve_species(ng, ng_choice);</a>
<a name="ln278">    }</a>
<a name="ln279">}</a>
<a name="ln280"> </a>
<a name="ln281">static string _highlight_pattern(const newgame_def&amp; ng)</a>
<a name="ln282">{</a>
<a name="ln283">    if (ng.species != SP_UNKNOWN)</a>
<a name="ln284">        return species_name(ng.species) + &quot;  &quot;;</a>
<a name="ln285"> </a>
<a name="ln286">    if (ng.job == JOB_UNKNOWN)</a>
<a name="ln287">        return &quot;&quot;;</a>
<a name="ln288"> </a>
<a name="ln289">    string ret;</a>
<a name="ln290"> </a>
<a name="ln291">    for (const auto sp : playable_species())</a>
<a name="ln292">        if (species_allowed(ng.job, sp) == CC_UNRESTRICTED)</a>
<a name="ln293">            ret += species_name(sp) + &quot;  |&quot;;</a>
<a name="ln294"> </a>
<a name="ln295">    if (!ret.empty())</a>
<a name="ln296">        ret.resize(ret.size() - 1);</a>
<a name="ln297">    return ret;</a>
<a name="ln298">}</a>
<a name="ln299"> </a>
<a name="ln300">static void _prompt_choice(int choice_type, newgame_def&amp; ng, newgame_def&amp; ng_choice,</a>
<a name="ln301">                        const newgame_def&amp; defaults);</a>
<a name="ln302"> </a>
<a name="ln303">static void _choose_species_job(newgame_def&amp; ng, newgame_def&amp; ng_choice,</a>
<a name="ln304">                                const newgame_def&amp; defaults)</a>
<a name="ln305">{</a>
<a name="ln306">    _resolve_species_job(ng, ng_choice);</a>
<a name="ln307"> </a>
<a name="ln308">    while (ng_choice.species == SP_UNKNOWN || ng_choice.job == JOB_UNKNOWN)</a>
<a name="ln309">    {</a>
<a name="ln310">        // Slightly non-obvious behaviour here is due to the fact that</a>
<a name="ln311">        // both types of _prompt_choice can ask for an entirely</a>
<a name="ln312">        // random character to be rolled. They will reset relevant fields</a>
<a name="ln313">        // in ng for this purpose.</a>
<a name="ln314">        if (ng_choice.species == SP_UNKNOWN)</a>
<a name="ln315">            _prompt_choice(C_SPECIES, ng, ng_choice, defaults);</a>
<a name="ln316">        _resolve_species_job(ng, ng_choice);</a>
<a name="ln317">        if (ng_choice.job == JOB_UNKNOWN)</a>
<a name="ln318">            _prompt_choice(C_JOB, ng, ng_choice, defaults);</a>
<a name="ln319">        _resolve_species_job(ng, ng_choice);</a>
<a name="ln320">    }</a>
<a name="ln321"> </a>
<a name="ln322">    if (!job_allowed(ng.species, ng.job))</a>
<a name="ln323">    {</a>
<a name="ln324">        // Either an invalid combination was passed in through options,</a>
<a name="ln325">        // or we messed up.</a>
<a name="ln326">        end(1, false, &quot;Incompatible species and background (%s) selected.&quot;,</a>
<a name="ln327">                                newgame_char_description(ng).c_str());</a>
<a name="ln328">    }</a>
<a name="ln329">}</a>
<a name="ln330"> </a>
<a name="ln331">// For completely random combinations (!, #, or Options.game.fully_random)</a>
<a name="ln332">// reroll characters until the player accepts one of them or quits.</a>
<a name="ln333">static bool _reroll_random(newgame_def&amp; ng)</a>
<a name="ln334">{</a>
<a name="ln335">    string specs = chop_string(species_name(ng.species), 79, false);</a>
<a name="ln336"> </a>
<a name="ln337">    formatted_string prompt;</a>
<a name="ln338">    prompt.cprintf(&quot;You are a%s %s %s.&quot;,</a>
<a name="ln339">            (is_vowel(specs[0])) ? &quot;n&quot; : &quot;&quot;, specs.c_str(),</a>
<a name="ln340">            get_job_name(ng.job));</a>
<a name="ln341"> </a>
<a name="ln342">    auto title_hbox = make_shared&lt;Box&gt;(Widget::HORZ);</a>
<a name="ln343">#ifdef USE_TILE</a>
<a name="ln344">    dolls_data doll;</a>
<a name="ln345">    fill_doll_for_newgame(doll, ng);</a>
<a name="ln346">#ifdef USE_TILE_LOCAL</a>
<a name="ln347">    auto tile = make_shared&lt;ui::PlayerDoll&gt;(doll);</a>
<a name="ln348">    tile-&gt;set_margin_for_sdl(0, 10, 0, 0);</a>
<a name="ln349">    title_hbox-&gt;add_child(move(tile));</a>
<a name="ln350">#endif</a>
<a name="ln351">#endif</a>
<a name="ln352">    title_hbox-&gt;add_child(make_shared&lt;Text&gt;(prompt));</a>
<a name="ln353">    title_hbox-&gt;set_cross_alignment(Widget::CENTER);</a>
<a name="ln354">    title_hbox-&gt;set_margin_for_sdl(0, 0, 20, 0);</a>
<a name="ln355">    title_hbox-&gt;set_margin_for_crt(0, 0, 1, 0);</a>
<a name="ln356"> </a>
<a name="ln357">    auto vbox = make_shared&lt;Box&gt;(Box::VERT);</a>
<a name="ln358">    vbox-&gt;add_child(move(title_hbox));</a>
<a name="ln359">    vbox-&gt;add_child(make_shared&lt;Text&gt;(&quot;Do you want to play this combination? [Y/n/q]&quot;));</a>
<a name="ln360">    auto popup = make_shared&lt;ui::Popup&gt;(move(vbox));</a>
<a name="ln361"> </a>
<a name="ln362">    bool done = false;</a>
<a name="ln363">    char c;</a>
<a name="ln364">    popup-&gt;on_keydown_event([&amp;](const KeyEvent&amp; ev) {</a>
<a name="ln365">        c = ev.key();</a>
<a name="ln366">        return done = true;</a>
<a name="ln367">    });</a>
<a name="ln368"> </a>
<a name="ln369">#ifdef USE_TILE_WEB</a>
<a name="ln370">    tiles.json_open_object();</a>
<a name="ln371">    tiles.json_write_string(&quot;prompt&quot;, prompt.to_colour_string());</a>
<a name="ln372">    tiles.send_doll(doll, false, false);</a>
<a name="ln373">    tiles.push_ui_layout(&quot;newgame-random-combo&quot;, 0);</a>
<a name="ln374">    popup-&gt;on_layout_pop([](){ tiles.pop_ui_layout(); });</a>
<a name="ln375">#endif</a>
<a name="ln376">    ui::run_layout(move(popup), done);</a>
<a name="ln377"> </a>
<a name="ln378">    if (key_is_escape(c) || toalower(c) == 'q' || crawl_state.seen_hups)</a>
<a name="ln379">        game_ended(game_exit::abort);</a>
<a name="ln380">    return toalower(c) == 'n' || c == '\t' || c == '!' || c == '#';</a>
<a name="ln381">}</a>
<a name="ln382"> </a>
<a name="ln383">static void _choose_char(newgame_def&amp; ng, newgame_def&amp; choice,</a>
<a name="ln384">                         newgame_def defaults)</a>
<a name="ln385">{</a>
<a name="ln386">    const newgame_def ng_reset = ng;</a>
<a name="ln387"> </a>
<a name="ln388">    if (ng.type == GAME_TYPE_TUTORIAL)</a>
<a name="ln389">    {</a>
<a name="ln390">        choose_tutorial_character(choice);</a>
<a name="ln391">        choice.allowed_jobs.clear();</a>
<a name="ln392">        choice.allowed_species.clear();</a>
<a name="ln393">        choice.allowed_weapons.clear();</a>
<a name="ln394">    }</a>
<a name="ln395">    else if (ng.type == GAME_TYPE_HINTS)</a>
<a name="ln396">    {</a>
<a name="ln397">        pick_hints(choice);</a>
<a name="ln398">        choice.allowed_jobs.clear();</a>
<a name="ln399">        choice.allowed_species.clear();</a>
<a name="ln400">        choice.allowed_weapons.clear();</a>
<a name="ln401">    }</a>
<a name="ln402"> </a>
<a name="ln403">#if defined(DGAMELAUNCH) &amp;&amp; defined(TOURNEY)</a>
<a name="ln404">    // Apologies to non-public servers.</a>
<a name="ln405">    if (ng.type == GAME_TYPE_NORMAL)</a>
<a name="ln406">    {</a>
<a name="ln407">        if (!yesno(&quot;Trunk games don't count for the tournament, you want &quot;</a>
<a name="ln408">                   TOURNEY &quot;. Play trunk anyway? (Y/N)&quot;, false, 'n'))</a>
<a name="ln409">        {</a>
<a name="ln410">            game_ended(game_exit::abort);</a>
<a name="ln411">        }</a>
<a name="ln412">    }</a>
<a name="ln413">#endif</a>
<a name="ln414"> </a>
<a name="ln415">    while (true)</a>
<a name="ln416">    {</a>
<a name="ln417">        if (choice.allowed_combos.size())</a>
<a name="ln418">        {</a>
<a name="ln419">            choice.species = SP_UNKNOWN;</a>
<a name="ln420">            choice.job = JOB_UNKNOWN;</a>
<a name="ln421">            choice.weapon = WPN_UNKNOWN;</a>
<a name="ln422">            string combo =</a>
<a name="ln423">                choice.allowed_combos[random2(choice.allowed_combos.size())];</a>
<a name="ln424"> </a>
<a name="ln425">            vector&lt;string&gt; parts = split_string(&quot;.&quot;, combo);</a>
<a name="ln426">            if (parts.size() &gt; 0)</a>
<a name="ln427">            {</a>
<a name="ln428">                string character = trim_string(parts[0]);</a>
<a name="ln429"> </a>
<a name="ln430">                if (character.length() == 4)</a>
<a name="ln431">                {</a>
<a name="ln432">                    choice.species =</a>
<a name="ln433">                        get_species_by_abbrev(</a>
<a name="ln434">                            character.substr(0, 2).c_str());</a>
<a name="ln435">                    choice.job =</a>
<a name="ln436">                        get_job_by_abbrev(</a>
<a name="ln437">                            character.substr(2, 2).c_str());</a>
<a name="ln438">                }</a>
<a name="ln439">                else</a>
<a name="ln440">                {</a>
<a name="ln441">                    for (const auto sp : playable_species())</a>
<a name="ln442">                    {</a>
<a name="ln443">                        if (starts_with(character, species_name(sp)))</a>
<a name="ln444">                        {</a>
<a name="ln445">                            choice.species = sp;</a>
<a name="ln446">                            string temp =</a>
<a name="ln447">                                character.substr(species_name(sp).length());</a>
<a name="ln448">                            choice.job = str_to_job(trim_string(temp));</a>
<a name="ln449">                            break;</a>
<a name="ln450">                        }</a>
<a name="ln451">                    }</a>
<a name="ln452">                }</a>
<a name="ln453"> </a>
<a name="ln454">                if (parts.size() &gt; 1)</a>
<a name="ln455">                {</a>
<a name="ln456">                    string weapon = trim_string(parts[1]);</a>
<a name="ln457">                    choice.weapon = str_to_weapon(weapon);</a>
<a name="ln458">                }</a>
<a name="ln459">            }</a>
<a name="ln460">        }</a>
<a name="ln461">        else</a>
<a name="ln462">        {</a>
<a name="ln463">            if (choice.allowed_species.size())</a>
<a name="ln464">            {</a>
<a name="ln465">                choice.species =</a>
<a name="ln466">                    choice.allowed_species[</a>
<a name="ln467">                        random2(choice.allowed_species.size())];</a>
<a name="ln468">            }</a>
<a name="ln469">            if (choice.allowed_jobs.size())</a>
<a name="ln470">            {</a>
<a name="ln471">                choice.job =</a>
<a name="ln472">                    choice.allowed_jobs[random2(choice.allowed_jobs.size())];</a>
<a name="ln473">            }</a>
<a name="ln474">            if (choice.allowed_weapons.size())</a>
<a name="ln475">            {</a>
<a name="ln476">                choice.weapon =</a>
<a name="ln477">                    choice.allowed_weapons[</a>
<a name="ln478">                        random2(choice.allowed_weapons.size())];</a>
<a name="ln479">            }</a>
<a name="ln480">        }</a>
<a name="ln481"> </a>
<a name="ln482">        _choose_species_job(ng, choice, defaults);</a>
<a name="ln483"> </a>
<a name="ln484">        if (choice.fully_random &amp;&amp; _reroll_random(ng))</a>
<a name="ln485">        {</a>
<a name="ln486">            ng = ng_reset;</a>
<a name="ln487">            continue;</a>
<a name="ln488">        }</a>
<a name="ln489"> </a>
<a name="ln490">        if (_choose_weapon(ng, choice, defaults))</a>
<a name="ln491">        {</a>
<a name="ln492">            // We're done!</a>
<a name="ln493">            return;</a>
<a name="ln494">        }</a>
<a name="ln495"> </a>
<a name="ln496">        // Else choose again, name and type stays same.</a>
<a name="ln497">        defaults = choice;</a>
<a name="ln498">        ng = ng_reset;</a>
<a name="ln499">        choice = ng_reset;</a>
<a name="ln500">    }</a>
<a name="ln501">}</a>
<a name="ln502"> </a>
<a name="ln503">static void _add_menu_sub_item(shared_ptr&lt;OuterMenu&gt;&amp; menu, int x, int y, const string&amp; text, const string&amp; description, char letter, int id)</a>
<a name="ln504">{</a>
<a name="ln505">    auto tmp = make_shared&lt;Text&gt;();</a>
<a name="ln506">    tmp-&gt;set_text(formatted_string(text, BROWN));</a>
<a name="ln507">    tmp-&gt;set_margin_for_sdl(4,8);</a>
<a name="ln508">    tmp-&gt;set_margin_for_crt(0, 2, 0, 0);</a>
<a name="ln509"> </a>
<a name="ln510">    auto btn = make_shared&lt;MenuButton&gt;();</a>
<a name="ln511">    btn-&gt;set_child(move(tmp));</a>
<a name="ln512">    btn-&gt;id = id;</a>
<a name="ln513">    btn-&gt;description = description;</a>
<a name="ln514">    btn-&gt;hotkey = letter;</a>
<a name="ln515">    btn-&gt;highlight_colour = STARTUP_HIGHLIGHT_CONTROL;</a>
<a name="ln516">    menu-&gt;add_button(move(btn), x, y);</a>
<a name="ln517">}</a>
<a name="ln518"> </a>
<a name="ln519">#ifndef DGAMELAUNCH</a>
<a name="ln520">/**</a>
<a name="ln521"> * Attempt to generate a random name for a character that doesn't collide with</a>
<a name="ln522"> * an existing save name.</a>
<a name="ln523"> *</a>
<a name="ln524"> * @return  A random name, or the empty string if no good name could be</a>
<a name="ln525"> *          generated after several tries.</a>
<a name="ln526"> */</a>
<a name="ln527">string newgame_random_name()</a>
<a name="ln528">{</a>
<a name="ln529">    for (int i = 0; i &lt; 100; ++i)</a>
<a name="ln530">    {</a>
<a name="ln531">        const string name = make_name();</a>
<a name="ln532">        const string filename = get_save_filename(name);</a>
<a name="ln533">        if (!save_exists(filename))</a>
<a name="ln534">            return name;</a>
<a name="ln535">    }</a>
<a name="ln536"> </a>
<a name="ln537">    return &quot;&quot;;</a>
<a name="ln538">}</a>
<a name="ln539"> </a>
<a name="ln540">static void _choose_name(newgame_def&amp; ng, newgame_def&amp; choice)</a>
<a name="ln541">{</a>
<a name="ln542">    char buf[MAX_NAME_LENGTH + 1]; // FIXME: make line_reader handle widths</a>
<a name="ln543">    buf[0] = '\0';</a>
<a name="ln544">    resumable_line_reader reader(buf, sizeof(buf));</a>
<a name="ln545"> </a>
<a name="ln546">    bool done = false;</a>
<a name="ln547">    bool overwrite_prompt = false;</a>
<a name="ln548">    bool good_name = true;</a>
<a name="ln549">    bool cancel = false;</a>
<a name="ln550"> </a>
<a name="ln551">    string specs = chop_string(species_name(ng.species), 79, false);</a>
<a name="ln552"> </a>
<a name="ln553">    formatted_string title;</a>
<a name="ln554">    title.cprintf(&quot;You are a%s %s %s.&quot;,</a>
<a name="ln555">            (is_vowel(specs[0])) ? &quot;n&quot; : &quot;&quot;, specs.c_str(),</a>
<a name="ln556">            get_job_name(ng.job));</a>
<a name="ln557"> </a>
<a name="ln558">    auto title_hbox = make_shared&lt;Box&gt;(Widget::HORZ);</a>
<a name="ln559">#ifdef USE_TILE</a>
<a name="ln560">    dolls_data doll;</a>
<a name="ln561">    fill_doll_for_newgame(doll, ng);</a>
<a name="ln562">#ifdef USE_TILE_LOCAL</a>
<a name="ln563">    auto tile = make_shared&lt;ui::PlayerDoll&gt;(doll);</a>
<a name="ln564">    tile-&gt;set_margin_for_sdl(0, 10, 0, 0);</a>
<a name="ln565">    title_hbox-&gt;add_child(move(tile));</a>
<a name="ln566">#endif</a>
<a name="ln567">#endif</a>
<a name="ln568">    title_hbox-&gt;add_child(make_shared&lt;Text&gt;(title));</a>
<a name="ln569">    title_hbox-&gt;set_cross_alignment(Widget::CENTER);</a>
<a name="ln570">    title_hbox-&gt;set_margin_for_sdl(0, 0, 20, 0);</a>
<a name="ln571">    title_hbox-&gt;set_margin_for_crt(0, 0, 1, 0);</a>
<a name="ln572"> </a>
<a name="ln573">    auto vbox = make_shared&lt;Box&gt;(Box::VERT);</a>
<a name="ln574">    vbox-&gt;add_child(move(title_hbox));</a>
<a name="ln575">    auto prompt_ui = make_shared&lt;Text&gt;();</a>
<a name="ln576">    vbox-&gt;add_child(prompt_ui);</a>
<a name="ln577"> </a>
<a name="ln578">    auto sub_items = make_shared&lt;OuterMenu&gt;(false, 3, 1);</a>
<a name="ln579">    vbox-&gt;add_child(sub_items);</a>
<a name="ln580"> </a>
<a name="ln581">    _add_menu_sub_item(sub_items, 0, 0,</a>
<a name="ln582">            &quot;Esc - Quit&quot;, &quot;&quot;, CK_ESCAPE, CK_ESCAPE);</a>
<a name="ln583">    _add_menu_sub_item(sub_items, 1, 0,</a>
<a name="ln584">            &quot;* - Random name&quot;, &quot;&quot;, '*', '*');</a>
<a name="ln585"> </a>
<a name="ln586">    auto ok_switcher = make_shared&lt;Switcher&gt;();</a>
<a name="ln587">    ok_switcher-&gt;align_y = Widget::STRETCH;</a>
<a name="ln588">    {</a>
<a name="ln589">        auto tmp = make_shared&lt;Text&gt;();</a>
<a name="ln590">        tmp-&gt;set_text(formatted_string(&quot;Enter - Begin!&quot;, BROWN));</a>
<a name="ln591"> </a>
<a name="ln592">        auto btn = make_shared&lt;MenuButton&gt;();</a>
<a name="ln593">        btn-&gt;on_activate_event([&amp;](const ActivateEvent&amp;) {</a>
<a name="ln594">            choice.name = buf;</a>
<a name="ln595">            trim_string(choice.name);</a>
<a name="ln596">            if (choice.name.empty())</a>
<a name="ln597">                choice.name = newgame_random_name();</a>
<a name="ln598">            if (good_name)</a>
<a name="ln599">            {</a>
<a name="ln600">                ng.name = choice.name;</a>
<a name="ln601">                ng.filename = get_save_filename(choice.name);</a>
<a name="ln602">                overwrite_prompt = save_exists(ng.filename);</a>
<a name="ln603">                if (!overwrite_prompt)</a>
<a name="ln604">                    done = true;</a>
<a name="ln605">            }</a>
<a name="ln606">            return true;</a>
<a name="ln607">        });</a>
<a name="ln608">        tmp-&gt;set_margin_for_sdl(4,8);</a>
<a name="ln609">        tmp-&gt;set_margin_for_crt(0, 2, 0, 0);</a>
<a name="ln610">        btn-&gt;set_child(move(tmp));</a>
<a name="ln611">        btn-&gt;id = CK_ENTER;</a>
<a name="ln612">        btn-&gt;description = &quot;&quot;;</a>
<a name="ln613">        btn-&gt;hotkey = CK_ENTER;</a>
<a name="ln614">        btn-&gt;highlight_colour = STARTUP_HIGHLIGHT_CONTROL;</a>
<a name="ln615"> </a>
<a name="ln616">        auto err = make_shared&lt;Text&gt;(</a>
<a name="ln617">                formatted_string(&quot;That's a silly name!&quot;, LIGHTRED));</a>
<a name="ln618">        err-&gt;set_margin_for_sdl(0, 0, 0, 10);</a>
<a name="ln619">        auto box = make_shared&lt;Box&gt;(Box::HORZ);</a>
<a name="ln620">        box-&gt;set_cross_alignment(Widget::CENTER);</a>
<a name="ln621">        box-&gt;add_child(err);</a>
<a name="ln622"> </a>
<a name="ln623">        ok_switcher-&gt;add_child(btn);</a>
<a name="ln624">        ok_switcher-&gt;add_child(box);</a>
<a name="ln625">        sub_items-&gt;add_button(btn, 2, 0);</a>
<a name="ln626">    }</a>
<a name="ln627"> </a>
<a name="ln628">    auto popup = make_shared&lt;ui::Popup&gt;(move(vbox));</a>
<a name="ln629"> </a>
<a name="ln630">    sub_items-&gt;on_activate_event([&amp;](const ActivateEvent&amp; event) {</a>
<a name="ln631">        const auto button = static_pointer_cast&lt;MenuButton&gt;(event.target());</a>
<a name="ln632">        const auto id = button-&gt;id;</a>
<a name="ln633">        switch (id)</a>
<a name="ln634">        {</a>
<a name="ln635">            case '*':</a>
<a name="ln636">                reader.putkey(CK_END);</a>
<a name="ln637">                reader.putkey(CONTROL('U'));</a>
<a name="ln638">                for (char ch : newgame_random_name())</a>
<a name="ln639">                    reader.putkey(ch);</a>
<a name="ln640">                break;</a>
<a name="ln641">            case CK_ESCAPE:</a>
<a name="ln642">                done = cancel = true;</a>
<a name="ln643">                break;</a>
<a name="ln644">        }</a>
<a name="ln645">        return true;</a>
<a name="ln646">    });</a>
<a name="ln647"> </a>
<a name="ln648">    popup-&gt;on_keydown_event([&amp;](const KeyEvent&amp; ev) {</a>
<a name="ln649">        auto key = ev.key();</a>
<a name="ln650"> </a>
<a name="ln651">        if (!overwrite_prompt)</a>
<a name="ln652">        {</a>
<a name="ln653">            key = reader.putkey(key);</a>
<a name="ln654">            good_name = is_good_name(buf, true);</a>
<a name="ln655">            ok_switcher-&gt;current() = good_name ? 0 : 1;</a>
<a name="ln656">        }</a>
<a name="ln657">        else</a>
<a name="ln658">        {</a>
<a name="ln659">            overwrite_prompt = false;</a>
<a name="ln660">            if (key == 'Y')</a>
<a name="ln661">                return done = true;</a>
<a name="ln662">        }</a>
<a name="ln663">        return true;</a>
<a name="ln664">    });</a>
<a name="ln665"> </a>
<a name="ln666">    ui::push_layout(move(popup));</a>
<a name="ln667">    while (!done &amp;&amp; !crawl_state.seen_hups)</a>
<a name="ln668">    {</a>
<a name="ln669">        formatted_string prompt;</a>
<a name="ln670">        prompt.textcolour(CYAN);</a>
<a name="ln671">        prompt.cprintf(&quot;What is your name today? &quot;);</a>
<a name="ln672">        prompt.textcolour(LIGHTGREY);</a>
<a name="ln673">        prompt.cprintf(&quot;%s\n&quot;, buf);</a>
<a name="ln674">        prompt.textcolour(LIGHTRED);</a>
<a name="ln675">        if (overwrite_prompt)</a>
<a name="ln676">            prompt.cprintf(&quot;You have an existing game under this name; really overwrite? [Y/n]&quot;);</a>
<a name="ln677">        prompt_ui-&gt;set_text(prompt);</a>
<a name="ln678"> </a>
<a name="ln679">        ui::pump_events();</a>
<a name="ln680">    }</a>
<a name="ln681">    ui::pop_layout();</a>
<a name="ln682"> </a>
<a name="ln683">    if (cancel || crawl_state.seen_hups)</a>
<a name="ln684">        game_ended(game_exit::abort);</a>
<a name="ln685">}</a>
<a name="ln686"> </a>
<a name="ln687">#endif</a>
<a name="ln688"> </a>
<a name="ln689">static keyfun_action _keyfun_seed_input(int &amp;ch)</a>
<a name="ln690">{</a>
<a name="ln691">    // CK_ENTER is excluded because processing it will cause the TextEntry to</a>
<a name="ln692">    // lose focus. (TODO: maybe handle this better in TextEntry somehow?)</a>
<a name="ln693">    if (ch == CONTROL('K') || ch == CONTROL('D') || ch == CONTROL('W') ||</a>
<a name="ln694">            ch == CONTROL('U') || ch == CONTROL('A') || ch == CONTROL('E') ||</a>
<a name="ln695">            ch == CK_BKSP || ch == CK_ESCAPE ||</a>
<a name="ln696">            ch &lt; 0 || // this should get all other special keys</a>
<a name="ln697">            isadigit(ch))</a>
<a name="ln698">    {</a>
<a name="ln699">        return KEYFUN_PROCESS;</a>
<a name="ln700">    }</a>
<a name="ln701">    return KEYFUN_IGNORE;</a>
<a name="ln702">}</a>
<a name="ln703"> </a>
<a name="ln704">// TODO: is there a more elevant way to set this up without a full-on custom</a>
<a name="ln705">// class?</a>
<a name="ln706">class SeedTextEntry : public ui::TextEntry</a>
<a name="ln707">{</a>
<a name="ln708">public:</a>
<a name="ln709">    SeedTextEntry(ui::Text *_begin_button)</a>
<a name="ln710">        : ui::TextEntry(), begin_button(_begin_button)</a>
<a name="ln711">    { }</a>
<a name="ln712"> </a>
<a name="ln713">    bool on_event(const Event&amp; event) override</a>
<a name="ln714">    {</a>
<a name="ln715">#ifdef USE_TILE_LOCAL</a>
<a name="ln716">        // some ugly code duplication here, but we need to preempt the internal</a>
<a name="ln717">        // class version of pasting</a>
<a name="ln718">        if (event.type() == Event::Type::KeyDown)</a>
<a name="ln719">        {</a>
<a name="ln720">            const auto key = static_cast&lt;const KeyEvent&amp;&gt;(event).key();</a>
<a name="ln721">            if (key == 'p' || key == 'P' || key == CONTROL('V'))</a>
<a name="ln722">            {</a>
<a name="ln723">                paste();</a>
<a name="ln724">                update_buttons();</a>
<a name="ln725">                return true;</a>
<a name="ln726">            }</a>
<a name="ln727">        }</a>
<a name="ln728">#endif</a>
<a name="ln729">        bool result = ui::TextEntry::on_event(event);</a>
<a name="ln730">        if (event.type() == Event::Type::KeyDown)</a>
<a name="ln731">            update_buttons();</a>
<a name="ln732">        return result;</a>
<a name="ln733">    }</a>
<a name="ln734"> </a>
<a name="ln735">    bool valid_seed()</a>
<a name="ln736">    {</a>
<a name="ln737">        return begin_button &amp;&amp; get_text().size() &gt; 0;</a>
<a name="ln738">    }</a>
<a name="ln739"> </a>
<a name="ln740">    void update_buttons()</a>
<a name="ln741">    {</a>
<a name="ln742">        if (valid_seed())</a>
<a name="ln743">            begin_button-&gt;set_text(formatted_string(&quot;[Enter] Begin!&quot;, BROWN));</a>
<a name="ln744">        else</a>
<a name="ln745">            begin_button-&gt;set_text(formatted_string(&quot;[Enter] Begin!&quot;, DARKGRAY));</a>
<a name="ln746">    }</a>
<a name="ln747"> </a>
<a name="ln748">    void set_text(const string &amp;s) // why is it `string s` in TextEntry?</a>
<a name="ln749">    {</a>
<a name="ln750">        ui::TextEntry::set_text(s);</a>
<a name="ln751">        update_buttons();</a>
<a name="ln752">    }</a>
<a name="ln753"> </a>
<a name="ln754">#ifdef USE_TILE_LOCAL</a>
<a name="ln755">    void paste()</a>
<a name="ln756">    {</a>
<a name="ln757">        // this is set up to completely preempt</a>
<a name="ln758">        // TextEntry::LineReader::clipboard_paste</a>
<a name="ln759">        if (wm-&gt;has_clipboard())</a>
<a name="ln760">        {</a>
<a name="ln761">            string clip = wm-&gt;get_clipboard();</a>
<a name="ln762">            // try to avoid pasting in crazy garbage, by parsing as uint64</a>
<a name="ln763">            // this could be done better</a>
<a name="ln764">            uint64_t clip_seed;</a>
<a name="ln765">            int clip_found = sscanf(clip.c_str(), &quot;%&quot; SCNu64, &amp;clip_seed);</a>
<a name="ln766">            if (clip_found)</a>
<a name="ln767">                set_text(make_stringf(&quot;%&quot; PRIu64, clip_seed));</a>
<a name="ln768">        }</a>
<a name="ln769">    }</a>
<a name="ln770">#endif</a>
<a name="ln771">private:</a>
<a name="ln772">    ui::Text *begin_button;</a>
<a name="ln773">};</a>
<a name="ln774"> </a>
<a name="ln775">static void _choose_seed(newgame_def&amp; ng, newgame_def&amp; choice,</a>
<a name="ln776">    const newgame_def&amp; defaults)</a>
<a name="ln777">{</a>
<a name="ln778">    UNUSED(ng, defaults);</a>
<a name="ln779"> </a>
<a name="ln780">    if (Options.seed)</a>
<a name="ln781">        choice.seed = Options.seed;</a>
<a name="ln782">    else if (Options.seed_from_rc)</a>
<a name="ln783">        choice.seed = Options.seed_from_rc;</a>
<a name="ln784"> </a>
<a name="ln785">    const bool show_pregen_toggle =</a>
<a name="ln786">#ifndef DGAMELAUNCH</a>
<a name="ln787">                        true;</a>
<a name="ln788">#else</a>
<a name="ln789">                        false;</a>
<a name="ln790">#endif</a>
<a name="ln791"> </a>
<a name="ln792">    bool done = false;</a>
<a name="ln793">    bool cancel = false;</a>
<a name="ln794"> </a>
<a name="ln795">    auto begin_label = make_shared&lt;ui::Text&gt;();</a>
<a name="ln796">    begin_label-&gt;set_text(formatted_string(&quot;[Enter] Begin!&quot;, BROWN));</a>
<a name="ln797">    begin_label-&gt;set_margin_for_sdl(4,8);</a>
<a name="ln798">    begin_label-&gt;set_margin_for_crt(0, 2, 0, 0);</a>
<a name="ln799"> </a>
<a name="ln800">    auto prompt_ui = make_shared&lt;Text&gt;();</a>
<a name="ln801">    auto box = make_shared&lt;ui::Box&gt;(ui::Widget::VERT);</a>
<a name="ln802">    box-&gt;set_cross_alignment(Widget::Align::STRETCH);</a>
<a name="ln803">    auto popup = make_shared&lt;ui::Popup&gt;(box);</a>
<a name="ln804"> </a>
<a name="ln805">    const string title_text = make_stringf(</a>
<a name="ln806">        &quot;Play a game with a custom seed for version %s.\n&quot;,</a>
<a name="ln807">        Version::Long);</a>
<a name="ln808">    box-&gt;add_child(make_shared&lt;ui::Text&gt;(formatted_string(title_text, CYAN)));</a>
<a name="ln809"> </a>
<a name="ln810">    const string body_text = &quot;Choose 0 for a random seed. &quot;</a>
<a name="ln811">            &quot;[Tab]/[Shift-Tab] to cycle input focus.\n&quot;;</a>
<a name="ln812">    box-&gt;add_child(make_shared&lt;ui::Text&gt;(body_text));</a>
<a name="ln813"> </a>
<a name="ln814">    auto seed_hbox = make_shared&lt;ui::Box&gt;(ui::Box::HORZ);</a>
<a name="ln815">    box-&gt;add_child(seed_hbox);</a>
<a name="ln816"> </a>
<a name="ln817">    const string prompt_text = &quot;Seed: &quot;;</a>
<a name="ln818">    seed_hbox-&gt;add_child(make_shared&lt;ui::Text&gt;(prompt_text));</a>
<a name="ln819">    auto seed_input = make_shared&lt;SeedTextEntry&gt;(begin_label.get());</a>
<a name="ln820">    seed_input-&gt;set_sync_id(&quot;seed&quot;);</a>
<a name="ln821">    seed_input-&gt;set_text(make_stringf(&quot;%&quot; PRIu64, choice.seed));</a>
<a name="ln822">    seed_input-&gt;set_keyproc(_keyfun_seed_input);</a>
<a name="ln823"> </a>
<a name="ln824">#ifndef USE_TILE_LOCAL</a>
<a name="ln825">    seed_input-&gt;max_size().width = 21;</a>
<a name="ln826">#endif</a>
<a name="ln827">    seed_hbox-&gt;add_child(seed_input);</a>
<a name="ln828">    seed_hbox-&gt;set_cross_alignment(Widget::CENTER);</a>
<a name="ln829"> </a>
<a name="ln830">    auto clear_btn_label = make_shared&lt;ui::Text&gt;();</a>
<a name="ln831">    clear_btn_label-&gt;set_text(formatted_string(&quot;[-] Clear&quot;, BROWN));</a>
<a name="ln832">    clear_btn_label-&gt;set_margin_for_sdl(4, 4);</a>
<a name="ln833">    clear_btn_label-&gt;set_margin_for_crt(0, 1, 0, 1);</a>
<a name="ln834">    auto clear_btn = make_shared&lt;MenuButton&gt;();</a>
<a name="ln835">    clear_btn-&gt;set_child(move(clear_btn_label));</a>
<a name="ln836">    clear_btn-&gt;set_sync_id(&quot;btn-clear&quot;);</a>
<a name="ln837">    clear_btn-&gt;hotkey = '-';</a>
<a name="ln838">    clear_btn-&gt;set_margin_for_sdl(0,0,0,10);</a>
<a name="ln839">    clear_btn-&gt;set_margin_for_crt(0, 0, 0, 1);</a>
<a name="ln840">    clear_btn-&gt;on_activate_event([&amp;seed_input](const ActivateEvent&amp;) {</a>
<a name="ln841">        seed_input-&gt;set_text(&quot;&quot;);</a>
<a name="ln842">        ui::set_focused_widget(seed_input.get());</a>
<a name="ln843">        return true;</a>
<a name="ln844">    });</a>
<a name="ln845">    seed_hbox-&gt;add_child(move(clear_btn));</a>
<a name="ln846"> </a>
<a name="ln847">    auto d_btn_label = make_shared&lt;ui::Text&gt;();</a>
<a name="ln848">    d_btn_label-&gt;set_text(formatted_string(&quot;[d] Today's daily seed&quot;, BROWN));</a>
<a name="ln849">    d_btn_label-&gt;set_margin_for_sdl(4,8);</a>
<a name="ln850">    d_btn_label-&gt;set_margin_for_crt(0, 2, 0, 0);</a>
<a name="ln851"> </a>
<a name="ln852">    auto daily_seed_btn = make_shared&lt;MenuButton&gt;();</a>
<a name="ln853">    daily_seed_btn-&gt;set_child(move(d_btn_label));</a>
<a name="ln854">    daily_seed_btn-&gt;set_sync_id(&quot;btn-daily&quot;);</a>
<a name="ln855">    daily_seed_btn-&gt;hotkey = 'd';</a>
<a name="ln856">    daily_seed_btn-&gt;set_margin_for_sdl(0,0,0,10);</a>
<a name="ln857">    daily_seed_btn-&gt;set_margin_for_crt(0, 0, 0, 1);</a>
<a name="ln858">    daily_seed_btn-&gt;on_activate_event([&amp;seed_input](const ActivateEvent&amp;) {</a>
<a name="ln859">        time_t now;</a>
<a name="ln860">        time(&amp;now);</a>
<a name="ln861">        struct tm * timeinfo = localtime(&amp;now);</a>
<a name="ln862">        char timebuf[9];</a>
<a name="ln863">        strftime(timebuf, sizeof(timebuf), &quot;%Y%m%d&quot;, timeinfo);</a>
<a name="ln864">        seed_input-&gt;set_text(string(timebuf));</a>
<a name="ln865">        ui::set_focused_widget(seed_input.get());</a>
<a name="ln866">        return true;</a>
<a name="ln867">    });</a>
<a name="ln868">    seed_hbox-&gt;add_child(move(daily_seed_btn));</a>
<a name="ln869"> </a>
<a name="ln870">    const string footer_text =</a>
<a name="ln871">        &quot;\n&quot;</a>
<a name="ln872">        &quot;The seed will determine the dungeon layout, monsters, and items\n&quot;</a>
<a name="ln873">        &quot;that you discover, relative to this version of crawl. Upgrading\n&quot;</a>
<a name="ln874">        &quot;mid-game may affect seeding. (See the manual for more details.)\n&quot;</a>
<a name="ln875">#ifdef SEEDING_UNRELIABLE</a>
<a name="ln876">        &quot;Warning: your build of crawl does not support stable seeding!\n&quot;</a>
<a name="ln877">        &quot;Levels may differ from 'official' seeded games.\n&quot;</a>
<a name="ln878">#endif</a>
<a name="ln879">        ;</a>
<a name="ln880">    box-&gt;add_child(make_shared&lt;ui::Text&gt;(footer_text));</a>
<a name="ln881"> </a>
<a name="ln882">    auto pregen_check = make_shared&lt;ui::Checkbox&gt;();</a>
<a name="ln883">    pregen_check-&gt;set_sync_id(&quot;pregenerate&quot;);</a>
<a name="ln884">    pregen_check-&gt;set_checked(choice.pregenerate = Options.pregen_dungeon);</a>
<a name="ln885">    pregen_check-&gt;set_visible(show_pregen_toggle);</a>
<a name="ln886">    pregen_check-&gt;set_child(make_shared&lt;ui::Text&gt;(&quot;Fully pregenerate the dungeon&quot;));</a>
<a name="ln887">    box-&gt;add_child(pregen_check);</a>
<a name="ln888"> </a>
<a name="ln889">    auto button_hbox = make_shared&lt;ui::Box&gt;(ui::Box::HORZ);</a>
<a name="ln890">    button_hbox-&gt;set_main_alignment(Widget::Align::END);</a>
<a name="ln891">    box-&gt;add_child(button_hbox);</a>
<a name="ln892"> </a>
<a name="ln893">    auto begin_btn = make_shared&lt;MenuButton&gt;();</a>
<a name="ln894">    begin_btn-&gt;set_child(begin_label);</a>
<a name="ln895">    begin_btn-&gt;set_sync_id(&quot;btn-begin&quot;);</a>
<a name="ln896">    begin_btn-&gt;hotkey = CK_ENTER;</a>
<a name="ln897">    begin_btn-&gt;on_activate_event(</a>
<a name="ln898">        [&amp;done, &amp;seed_input, &amp;begin_btn](const ActivateEvent&amp;)</a>
<a name="ln899">    {</a>
<a name="ln900">        if (!seed_input-&gt;valid_seed())</a>
<a name="ln901">            return false; // TODO: message why this failed</a>
<a name="ln902">        auto cur_focus = ui::get_focused_widget();</a>
<a name="ln903">        if (</a>
<a name="ln904">#ifdef USE_TILE_WEB</a>
<a name="ln905">            // focus doesn't seem to be tracked right from web?</a>
<a name="ln906">            tiles.is_controlled_from_web() ||</a>
<a name="ln907">#endif</a>
<a name="ln908">            cur_focus == begin_btn.get() || cur_focus == seed_input.get())</a>
<a name="ln909">        {</a>
<a name="ln910">            return done = true;</a>
<a name="ln911">        }</a>
<a name="ln912">        // let the other buttons activate on enter</a>
<a name="ln913">        return false;</a>
<a name="ln914">    });</a>
<a name="ln915">    button_hbox-&gt;add_child(begin_btn);</a>
<a name="ln916"> </a>
<a name="ln917">    // TODO: ESC gets absorbed by active buttons, does this make sense?</a>
<a name="ln918">    popup-&gt;on_keydown_event([&amp;](const KeyEvent&amp; ev) {</a>
<a name="ln919">        const auto key = ev.key();</a>
<a name="ln920">        if (key == '?') // TODO: text box absorbs this still</a>
<a name="ln921">            show_help('D', &quot;Seeded play&quot;); // TODO: scroll to section</a>
<a name="ln922">#ifdef USE_TILE_LOCAL</a>
<a name="ln923">        else if ((key == 'p' || key == 'P' || key == CONTROL('V')))</a>
<a name="ln924">        {</a>
<a name="ln925">            seed_input-&gt;paste();</a>
<a name="ln926">            ui::set_focused_widget(seed_input.get());</a>
<a name="ln927">            return false;</a>
<a name="ln928">        }</a>
<a name="ln929">#endif</a>
<a name="ln930">        else if (key_is_escape(key))</a>
<a name="ln931">            return done = cancel = true;</a>
<a name="ln932">        return false;</a>
<a name="ln933">    });</a>
<a name="ln934"> </a>
<a name="ln935">#ifdef USE_TILE_WEB</a>
<a name="ln936">    tiles.json_open_object();</a>
<a name="ln937">    tiles.json_write_string(&quot;body&quot;, body_text);</a>
<a name="ln938">    tiles.json_write_string(&quot;title&quot;, title_text);</a>
<a name="ln939">    tiles.json_write_string(&quot;footer&quot;, footer_text);</a>
<a name="ln940">    tiles.json_write_bool(&quot;show_pregen_toggle&quot;, show_pregen_toggle);</a>
<a name="ln941">    tiles.push_ui_layout(&quot;seed-selection&quot;, 0);</a>
<a name="ln942">    popup-&gt;on_layout_pop([](){ tiles.pop_ui_layout(); });</a>
<a name="ln943">#endif</a>
<a name="ln944"> </a>
<a name="ln945">    ui::run_layout(move(popup), done, seed_input);</a>
<a name="ln946"> </a>
<a name="ln947">    string result = seed_input-&gt;get_text();</a>
<a name="ln948">    uint64_t tmp_seed = 0;</a>
<a name="ln949">    // TODO: if the user types in a number that exceeds the max value, sscanf</a>
<a name="ln950">    // will give back the max value. Probably better to print an error?</a>
<a name="ln951">    int found = sscanf(result.c_str(), &quot;%&quot; SCNu64, &amp;tmp_seed);</a>
<a name="ln952"> </a>
<a name="ln953">    if (cancel || crawl_state.seen_hups || !found || result.size() == 0)</a>
<a name="ln954">        game_ended(game_exit::abort);</a>
<a name="ln955"> </a>
<a name="ln956">    Options.seed = choice.seed = tmp_seed;</a>
<a name="ln957">    Options.pregen_dungeon = choice.pregenerate = pregen_check-&gt;checked();</a>
<a name="ln958">}</a>
<a name="ln959"> </a>
<a name="ln960">// Read a choice of game into ng.</a>
<a name="ln961">// Returns false if a game (with name ng.name) should</a>
<a name="ln962">// be restored instead of starting a new character.</a>
<a name="ln963">bool choose_game(newgame_def&amp; ng, newgame_def&amp; choice,</a>
<a name="ln964">                 const newgame_def&amp; defaults)</a>
<a name="ln965">{</a>
<a name="ln966">#ifdef USE_TILE_WEB</a>
<a name="ln967">    tiles.set_ui_state(UI_CRT);</a>
<a name="ln968">#endif</a>
<a name="ln969"> </a>
<a name="ln970">    clrscr();</a>
<a name="ln971"> </a>
<a name="ln972">    textcolour(LIGHTGREY);</a>
<a name="ln973"> </a>
<a name="ln974">    ng.name = choice.name;</a>
<a name="ln975">    ng.type = choice.type;</a>
<a name="ln976">    ng.map  = choice.map;</a>
<a name="ln977"> </a>
<a name="ln978">    if (ng.type == GAME_TYPE_SPRINT</a>
<a name="ln979">        || ng.type == GAME_TYPE_TUTORIAL)</a>
<a name="ln980">    {</a>
<a name="ln981">        _choose_gamemode_map(ng, choice, defaults);</a>
<a name="ln982">    }</a>
<a name="ln983">    else if (ng.type == GAME_TYPE_CUSTOM_SEED)</a>
<a name="ln984">        _choose_seed(ng, choice, defaults);</a>
<a name="ln985"> </a>
<a name="ln986">    _choose_char(ng, choice, defaults);</a>
<a name="ln987"> </a>
<a name="ln988">    // Set these again, since _mark_fully_random may reset ng.</a>
<a name="ln989">    ng.name = choice.name;</a>
<a name="ln990">    ng.type = choice.type;</a>
<a name="ln991">    ng.seed = choice.seed;</a>
<a name="ln992">    ng.pregenerate = choice.pregenerate;</a>
<a name="ln993"> </a>
<a name="ln994">#ifndef DGAMELAUNCH</a>
<a name="ln995">    // New: pick name _after_ character choices.</a>
<a name="ln996">    if (choice.name.empty())</a>
<a name="ln997">        _choose_name(ng, choice);</a>
<a name="ln998">#endif</a>
<a name="ln999"> </a>
<a name="ln1000">    if (ng.name.empty())</a>
<a name="ln1001">        end(1, false, &quot;No player name specified.&quot;);</a>
<a name="ln1002"> </a>
<a name="ln1003">    ASSERT(is_good_name(ng.name, false)</a>
<a name="ln1004">           &amp;&amp; job_allowed(ng.species, ng.job)</a>
<a name="ln1005">           &amp;&amp; ng.type != NUM_GAME_TYPE);</a>
<a name="ln1006"> </a>
<a name="ln1007">    write_newgame_options_file(choice);</a>
<a name="ln1008"> </a>
<a name="ln1009">    return false;</a>
<a name="ln1010">}</a>
<a name="ln1011"> </a>
<a name="ln1012">// Set ng_choice to defaults without overwriting name and game type.</a>
<a name="ln1013">static void _set_default_choice(newgame_def&amp; ng, newgame_def&amp; ng_choice,</a>
<a name="ln1014">                                const newgame_def&amp; defaults)</a>
<a name="ln1015">{</a>
<a name="ln1016">    // Reset ng so _resolve_species_job will work properly.</a>
<a name="ln1017">    ng.clear_character();</a>
<a name="ln1018"> </a>
<a name="ln1019">    const string name = ng_choice.name;</a>
<a name="ln1020">    const game_type type   = ng_choice.type;</a>
<a name="ln1021">    ng_choice = defaults;</a>
<a name="ln1022">    ng_choice.name = name;</a>
<a name="ln1023">    ng_choice.type = type;</a>
<a name="ln1024">}</a>
<a name="ln1025"> </a>
<a name="ln1026">static void _mark_fully_random(newgame_def&amp; ng, newgame_def&amp; ng_choice,</a>
<a name="ln1027">                               bool viable)</a>
<a name="ln1028">{</a>
<a name="ln1029">    // Reset ng so _resolve_species_job will work properly.</a>
<a name="ln1030">    ng.clear_character();</a>
<a name="ln1031"> </a>
<a name="ln1032">    ng_choice.fully_random = true;</a>
<a name="ln1033">    if (viable)</a>
<a name="ln1034">    {</a>
<a name="ln1035">        ng_choice.species = SP_VIABLE;</a>
<a name="ln1036">        ng_choice.job = JOB_VIABLE;</a>
<a name="ln1037">    }</a>
<a name="ln1038">    else</a>
<a name="ln1039">    {</a>
<a name="ln1040">        ng_choice.species = SP_RANDOM;</a>
<a name="ln1041">        ng_choice.job = JOB_RANDOM;</a>
<a name="ln1042">    }</a>
<a name="ln1043">}</a>
<a name="ln1044"> </a>
<a name="ln1045">class UINewGameMenu;</a>
<a name="ln1046"> </a>
<a name="ln1047">static void _construct_species_menu(const newgame_def&amp; ng,</a>
<a name="ln1048">                                    const newgame_def&amp; defaults,</a>
<a name="ln1049">                                    UINewGameMenu* ng_menu)</a>
<a name="ln1050">{</a>
<a name="ln1051">    menu_letter letter = 'a';</a>
<a name="ln1052">    // Add entries for any species groups with at least one playable species.</a>
<a name="ln1053">    for (species_group&amp; group : species_groups)</a>
<a name="ln1054">    {</a>
<a name="ln1055">        if (ng.job == JOB_UNKNOWN</a>
<a name="ln1056">            ||  any_of(begin(group.species_list),</a>
<a name="ln1057">                      end(group.species_list),</a>
<a name="ln1058">                      [&amp;ng](species_type species)</a>
<a name="ln1059">                      { return species_allowed(ng.job, species) != CC_BANNED; }</a>
<a name="ln1060">                )</a>
<a name="ln1061">        )</a>
<a name="ln1062">        {</a>
<a name="ln1063">            group.attach(ng, defaults, ng_menu, letter);</a>
<a name="ln1064">        }</a>
<a name="ln1065">    }</a>
<a name="ln1066">}</a>
<a name="ln1067"> </a>
<a name="ln1068">static job_group jobs_order[] =</a>
<a name="ln1069">{</a>
<a name="ln1070">    {</a>
<a name="ln1071">        &quot;Warrior&quot;,</a>
<a name="ln1072">        coord_def(0, 0), 20,</a>
<a name="ln1073">        { JOB_FIGHTER, JOB_GLADIATOR, JOB_MONK, JOB_HUNTER, JOB_ASSASSIN }</a>
<a name="ln1074">    },</a>
<a name="ln1075">    {</a>
<a name="ln1076">        &quot;Adventurer&quot;,</a>
<a name="ln1077">        coord_def(0, 7), 20,</a>
<a name="ln1078">        { JOB_ARTIFICER, JOB_WANDERER }</a>
<a name="ln1079">    },</a>
<a name="ln1080">    {</a>
<a name="ln1081">        &quot;Zealot&quot;,</a>
<a name="ln1082">        coord_def(1, 0), 25,</a>
<a name="ln1083">        { JOB_BERSERKER, JOB_ABYSSAL_KNIGHT, JOB_CHAOS_KNIGHT }</a>
<a name="ln1084">    },</a>
<a name="ln1085">    {</a>
<a name="ln1086">        &quot;Warrior-mage&quot;,</a>
<a name="ln1087">        coord_def(1, 5), 26,</a>
<a name="ln1088">        { JOB_SKALD, JOB_TRANSMUTER, JOB_WARPER, JOB_ARCANE_MARKSMAN,</a>
<a name="ln1089">          JOB_ENCHANTER }</a>
<a name="ln1090">    },</a>
<a name="ln1091">    {</a>
<a name="ln1092">        &quot;Mage&quot;,</a>
<a name="ln1093">        coord_def(2, 0), 22,</a>
<a name="ln1094">        { JOB_WIZARD, JOB_CONJURER, JOB_SUMMONER, JOB_NECROMANCER,</a>
<a name="ln1095">          JOB_FIRE_ELEMENTALIST, JOB_ICE_ELEMENTALIST,</a>
<a name="ln1096">          JOB_AIR_ELEMENTALIST, JOB_EARTH_ELEMENTALIST, JOB_VENOM_MAGE }</a>
<a name="ln1097">    }</a>
<a name="ln1098">};</a>
<a name="ln1099"> </a>
<a name="ln1100">/**</a>
<a name="ln1101"> * Helper for _choose_job</a>
<a name="ln1102"> * constructs the menu used and highlights the previous job if there is one</a>
<a name="ln1103"> */</a>
<a name="ln1104">static void _construct_backgrounds_menu(const newgame_def&amp; ng,</a>
<a name="ln1105">                                        const newgame_def&amp; defaults,</a>
<a name="ln1106">                                        UINewGameMenu* ng_menu)</a>
<a name="ln1107">{</a>
<a name="ln1108">    menu_letter letter = 'a';</a>
<a name="ln1109">    // Add entries for any job groups with at least one playable background.</a>
<a name="ln1110">    for (job_group&amp; group : jobs_order)</a>
<a name="ln1111">    {</a>
<a name="ln1112">        if (ng.species == SP_UNKNOWN</a>
<a name="ln1113">            || any_of(begin(group.jobs), end(group.jobs), [&amp;ng](job_type job)</a>
<a name="ln1114">                      { return job_allowed(ng.species, job) != CC_BANNED; }))</a>
<a name="ln1115">        {</a>
<a name="ln1116">            group.attach(ng, defaults, ng_menu, letter);</a>
<a name="ln1117">        }</a>
<a name="ln1118">    }</a>
<a name="ln1119">}</a>
<a name="ln1120"> </a>
<a name="ln1121">class UINewGameMenu : public Widget</a>
<a name="ln1122">{</a>
<a name="ln1123">public:</a>
<a name="ln1124">    UINewGameMenu(int _choice_type, newgame_def&amp; _ng, newgame_def&amp; _ng_choice, const newgame_def&amp; _defaults) : m_choice_type(_choice_type), m_ng(_ng), m_ng_choice(_ng_choice), m_defaults(_defaults)</a>
<a name="ln1125">    {</a>
<a name="ln1126">        m_vbox = make_shared&lt;Box&gt;(Box::VERT);</a>
<a name="ln1127">        add_internal_child(m_vbox);</a>
<a name="ln1128">        m_vbox-&gt;set_cross_alignment(Widget::Align::STRETCH);</a>
<a name="ln1129"> </a>
<a name="ln1130">        welcome.textcolour(BROWN);</a>
<a name="ln1131">        welcome.cprintf(&quot;%s&quot;, _welcome(m_ng).c_str());</a>
<a name="ln1132">        welcome.textcolour(YELLOW);</a>
<a name="ln1133">        welcome.cprintf(&quot; Please select your &quot;);</a>
<a name="ln1134">        welcome.cprintf(m_choice_type == C_JOB ? &quot;background.&quot; : &quot;species.&quot;);</a>
<a name="ln1135">        m_vbox-&gt;add_child(make_shared&lt;Text&gt;(welcome));</a>
<a name="ln1136"> </a>
<a name="ln1137">        descriptions = make_shared&lt;Switcher&gt;();</a>
<a name="ln1138"> </a>
<a name="ln1139">        m_main_items = make_shared&lt;OuterMenu&gt;(true, 3, 20);</a>
<a name="ln1140">        m_main_items-&gt;menu_id = m_choice_type == C_JOB ?</a>
<a name="ln1141">            &quot;background-main&quot; : &quot;species-main&quot;;</a>
<a name="ln1142">        m_main_items-&gt;set_margin_for_crt(1, 0);</a>
<a name="ln1143">        m_main_items-&gt;set_margin_for_sdl(15, 0);</a>
<a name="ln1144">        m_main_items-&gt;descriptions = descriptions;</a>
<a name="ln1145">        m_vbox-&gt;add_child(m_main_items);</a>
<a name="ln1146"> </a>
<a name="ln1147">#ifndef USE_TILE_LOCAL</a>
<a name="ln1148">        m_vbox-&gt;expand_h = true;</a>
<a name="ln1149">        max_size() = { 80, INT_MAX };</a>
<a name="ln1150">#endif</a>
<a name="ln1151"> </a>
<a name="ln1152">        descriptions-&gt;set_margin_for_crt(1, 0);</a>
<a name="ln1153">        descriptions-&gt;set_margin_for_sdl(0, 0, 15, 0);</a>
<a name="ln1154">        descriptions-&gt;current() = -1;</a>
<a name="ln1155">        descriptions-&gt;shrink_h = true;</a>
<a name="ln1156">        m_vbox-&gt;add_child(descriptions);</a>
<a name="ln1157"> </a>
<a name="ln1158">        if (m_choice_type == C_JOB)</a>
<a name="ln1159">            _construct_backgrounds_menu(m_ng, m_defaults, this);</a>
<a name="ln1160">        else</a>
<a name="ln1161">            _construct_species_menu(m_ng, m_defaults, this);</a>
<a name="ln1162"> </a>
<a name="ln1163">        m_sub_items = make_shared&lt;OuterMenu&gt;(false, 2, 4);</a>
<a name="ln1164">        m_sub_items-&gt;menu_id = m_choice_type == C_JOB ?</a>
<a name="ln1165">            &quot;background-sub&quot; : &quot;species-sub&quot;;</a>
<a name="ln1166">        m_sub_items-&gt;descriptions = descriptions;</a>
<a name="ln1167">        m_vbox-&gt;add_child(m_sub_items);</a>
<a name="ln1168">        _add_choice_menu_options(m_choice_type, m_ng, m_defaults);</a>
<a name="ln1169"> </a>
<a name="ln1170">        m_main_items-&gt;linked_menus[2] = m_sub_items;</a>
<a name="ln1171">        m_sub_items-&gt;linked_menus[0] = m_main_items;</a>
<a name="ln1172"> </a>
<a name="ln1173">        m_vbox-&gt;on_activate_event([this](const ActivateEvent&amp; event) {</a>
<a name="ln1174">            const auto button = static_pointer_cast&lt;MenuButton&gt;(event.target());</a>
<a name="ln1175">            this-&gt;menu_item_activated(button-&gt;id);</a>
<a name="ln1176">            return true;</a>
<a name="ln1177">        });</a>
<a name="ln1178"> </a>
<a name="ln1179">        m_vbox-&gt;on_hotkey_event([this](const KeyEvent&amp; event) {</a>
<a name="ln1180">            switch (event.key())</a>
<a name="ln1181">            {</a>
<a name="ln1182">            case 'X':</a>
<a name="ln1183">            case CONTROL('Q'):</a>
<a name="ln1184">#ifdef USE_TILE_WEB</a>
<a name="ln1185">                tiles.send_exit_reason(&quot;cancel&quot;);</a>
<a name="ln1186">#endif</a>
<a name="ln1187">                return done = end_game = true;</a>
<a name="ln1188">            CASE_ESCAPE</a>
<a name="ln1189">            case CK_MOUSE_CMD:</a>
<a name="ln1190">                return done = cancel = true;</a>
<a name="ln1191">            case CK_BKSP:</a>
<a name="ln1192">                if (m_choice_type == C_JOB)</a>
<a name="ln1193">                    m_ng_choice.job = JOB_UNKNOWN;</a>
<a name="ln1194">                else</a>
<a name="ln1195">                    m_ng_choice.species = SP_UNKNOWN;</a>
<a name="ln1196">                return done = true;</a>
<a name="ln1197">            default:</a>
<a name="ln1198">                return false;</a>
<a name="ln1199">            }</a>
<a name="ln1200">        });</a>
<a name="ln1201">    };</a>
<a name="ln1202"> </a>
<a name="ln1203">    virtual shared_ptr&lt;Widget&gt; get_child_at_offset(int, int) override {</a>
<a name="ln1204">        return static_pointer_cast&lt;Widget&gt;(m_vbox);</a>
<a name="ln1205">    }</a>
<a name="ln1206"> </a>
<a name="ln1207">    virtual void _render() override;</a>
<a name="ln1208">    virtual SizeReq _get_preferred_size(Direction dim, int prosp_width) override;</a>
<a name="ln1209">    virtual void _allocate_region() override;</a>
<a name="ln1210"> </a>
<a name="ln1211">#ifdef USE_TILE_WEB</a>
<a name="ln1212">    void serialize();</a>
<a name="ln1213">#endif</a>
<a name="ln1214"> </a>
<a name="ln1215">    void menu_item_activated(int id);</a>
<a name="ln1216"> </a>
<a name="ln1217">    bool done = false;</a>
<a name="ln1218">    bool end_game = false;</a>
<a name="ln1219">    bool cancel = false;</a>
<a name="ln1220"> </a>
<a name="ln1221">protected:</a>
<a name="ln1222">    friend struct job_group;</a>
<a name="ln1223">    friend struct species_group;</a>
<a name="ln1224">    void _add_group_item(menu_letter &amp;letter,</a>
<a name="ln1225">                                int id,</a>
<a name="ln1226">                                int item_status,</a>
<a name="ln1227">                                string item_name,</a>
<a name="ln1228">#ifdef USE_TILE</a>
<a name="ln1229">                                tile_def item_tile,</a>
<a name="ln1230">#endif</a>
<a name="ln1231">                                bool is_active_item,</a>
<a name="ln1232">                                coord_def position)</a>
<a name="ln1233"> </a>
<a name="ln1234">    {</a>
<a name="ln1235">        auto label = make_shared&lt;Text&gt;();</a>
<a name="ln1236"> </a>
<a name="ln1237">#ifdef USE_TILE</a>
<a name="ln1238">        auto hbox = make_shared&lt;Box&gt;(Box::HORZ);</a>
<a name="ln1239">        hbox-&gt;set_cross_alignment(Widget::Align::CENTER);</a>
<a name="ln1240">        hbox-&gt;set_main_alignment(Widget::Align::STRETCH);</a>
<a name="ln1241">        auto tile = make_shared&lt;Image&gt;();</a>
<a name="ln1242">        tile-&gt;set_tile(item_tile);</a>
<a name="ln1243">        tile-&gt;set_margin_for_sdl(0, 6, 0, 0);</a>
<a name="ln1244">        tile-&gt;flex_grow = 0;</a>
<a name="ln1245">        hbox-&gt;add_child(move(tile));</a>
<a name="ln1246">        hbox-&gt;add_child(label);</a>
<a name="ln1247">#endif</a>
<a name="ln1248"> </a>
<a name="ln1249">        COLOURS fg, hl;</a>
<a name="ln1250"> </a>
<a name="ln1251">        if (item_status == ITEM_STATUS_UNKNOWN)</a>
<a name="ln1252">        {</a>
<a name="ln1253">            fg = LIGHTGRAY;</a>
<a name="ln1254">            hl = STARTUP_HIGHLIGHT_NORMAL;</a>
<a name="ln1255">        }</a>
<a name="ln1256">        else if (item_status == ITEM_STATUS_RESTRICTED)</a>
<a name="ln1257">        {</a>
<a name="ln1258">            fg = DARKGRAY;</a>
<a name="ln1259">            hl = STARTUP_HIGHLIGHT_BAD;</a>
<a name="ln1260">        }</a>
<a name="ln1261">        else</a>
<a name="ln1262">        {</a>
<a name="ln1263">            fg = WHITE;</a>
<a name="ln1264">            hl = STARTUP_HIGHLIGHT_GOOD;</a>
<a name="ln1265">        }</a>
<a name="ln1266"> </a>
<a name="ln1267">        string text;</a>
<a name="ln1268">        text += letter;</a>
<a name="ln1269">        text += &quot; - &quot;;</a>
<a name="ln1270">        text += item_name;</a>
<a name="ln1271">        label-&gt;set_text(formatted_string(text, fg));</a>
<a name="ln1272"> </a>
<a name="ln1273">        string desc = unwrap_desc(getGameStartDescription(item_name));</a>
<a name="ln1274">        trim_string(desc);</a>
<a name="ln1275"> </a>
<a name="ln1276">        auto btn = make_shared&lt;MenuButton&gt;();</a>
<a name="ln1277">#ifdef USE_TILE</a>
<a name="ln1278">        hbox-&gt;set_margin_for_sdl(2, 10, 2, 2);</a>
<a name="ln1279">        btn-&gt;set_child(move(hbox));</a>
<a name="ln1280">#else</a>
<a name="ln1281">        btn-&gt;set_child(move(label));</a>
<a name="ln1282">#endif</a>
<a name="ln1283">        btn-&gt;id = id;</a>
<a name="ln1284">        btn-&gt;description = desc;</a>
<a name="ln1285">        btn-&gt;hotkey = letter;</a>
<a name="ln1286">        btn-&gt;highlight_colour = hl;</a>
<a name="ln1287">        btn-&gt;set_margin_for_crt(0, 1, 0, 0);</a>
<a name="ln1288"> </a>
<a name="ln1289">        m_main_items-&gt;add_button(btn, position.x, position.y);</a>
<a name="ln1290"> </a>
<a name="ln1291">        if (is_active_item || position == coord_def(0, 1))</a>
<a name="ln1292">            m_main_items-&gt;set_initial_focus(btn.get());</a>
<a name="ln1293">    }</a>
<a name="ln1294"> </a>
<a name="ln1295">    void _add_group_title(const char* name, coord_def position)</a>
<a name="ln1296">    {</a>
<a name="ln1297">        auto text = make_shared&lt;Text&gt;(formatted_string(name, LIGHTBLUE));</a>
<a name="ln1298">        text-&gt;set_margin_for_sdl(7, 0, 7, 32+2+6);</a>
<a name="ln1299">        m_main_items-&gt;add_label(move(text), position.x, position.y);</a>
<a name="ln1300">    }</a>
<a name="ln1301"> </a>
<a name="ln1302">    void _add_choice_menu_option(int x, int y, const string&amp; text, char letter,</a>
<a name="ln1303">            int id, const string&amp; desc)</a>
<a name="ln1304">    {</a>
<a name="ln1305">        _add_menu_sub_item(m_sub_items, x, y, text, desc, letter, id);</a>
<a name="ln1306">    }</a>
<a name="ln1307"> </a>
<a name="ln1308">    void _add_choice_menu_options(int choice_type,</a>
<a name="ln1309">                                        const newgame_def&amp; ng,</a>
<a name="ln1310">                                        const newgame_def&amp; defaults)</a>
<a name="ln1311">    {</a>
<a name="ln1312">        string choice_name = choice_type == C_JOB ? &quot;background&quot; : &quot;species&quot;;</a>
<a name="ln1313">        string other_choice_name = choice_type == C_JOB ? &quot;species&quot; : &quot;background&quot;;</a>
<a name="ln1314"> </a>
<a name="ln1315">        string text, desc;</a>
<a name="ln1316"> </a>
<a name="ln1317">        if (choice_type == C_SPECIES)</a>
<a name="ln1318">            text = &quot;+ - Recommended species&quot;;</a>
<a name="ln1319">        else</a>
<a name="ln1320">            text = &quot;+ - Recommended background&quot;;</a>
<a name="ln1321"> </a>
<a name="ln1322">        int id;</a>
<a name="ln1323">        // If the player has species chosen, use VIABLE, otherwise use RANDOM</a>
<a name="ln1324">        if ((choice_type == C_SPECIES &amp;&amp; ng.job != JOB_UNKNOWN)</a>
<a name="ln1325">        || (choice_type == C_JOB &amp;&amp; ng.species != SP_UNKNOWN))</a>
<a name="ln1326">        {</a>
<a name="ln1327">            id = M_VIABLE;</a>
<a name="ln1328">        }</a>
<a name="ln1329">        else</a>
<a name="ln1330">            id = M_RANDOM;</a>
<a name="ln1331">        desc = &quot;Picks a random recommended &quot; + other_choice_name + &quot; based on your current &quot; + choice_name + &quot; choice.&quot;;</a>
<a name="ln1332"> </a>
<a name="ln1333">        _add_choice_menu_option(0, 0,</a>
<a name="ln1334">                text, '+', id, desc);</a>
<a name="ln1335"> </a>
<a name="ln1336">        _add_choice_menu_option(0, 1,</a>
<a name="ln1337">                &quot;# - Recommended character&quot;, '#', M_VIABLE_CHAR,</a>
<a name="ln1338">                &quot;Shuffles through random recommended character combinations &quot;</a>
<a name="ln1339">                &quot;until you accept one.&quot;);</a>
<a name="ln1340"> </a>
<a name="ln1341">        _add_choice_menu_option(0, 2,</a>
<a name="ln1342">                &quot;% - List aptitudes&quot;, '%', M_APTITUDES,</a>
<a name="ln1343">                &quot;Lists the numerical skill train aptitudes for all races.&quot;);</a>
<a name="ln1344"> </a>
<a name="ln1345">        _add_choice_menu_option(0, 3,</a>
<a name="ln1346">                &quot;? - Help&quot;, '?', M_HELP,</a>
<a name="ln1347">                &quot;Opens the help screen.&quot;);</a>
<a name="ln1348"> </a>
<a name="ln1349">        _add_choice_menu_option(1, 0,</a>
<a name="ln1350">                &quot;    * - Random &quot; + choice_name, '*', M_RANDOM,</a>
<a name="ln1351">                &quot;Picks a random &quot; + choice_name + &quot;.&quot;);</a>
<a name="ln1352"> </a>
<a name="ln1353">        _add_choice_menu_option(1, 1,</a>
<a name="ln1354">                &quot;    ! - Random character&quot;, '!', M_RANDOM_CHAR,</a>
<a name="ln1355">                &quot;Shuffles through random character combinations &quot;</a>
<a name="ln1356">                &quot;until you accept one.&quot;);</a>
<a name="ln1357"> </a>
<a name="ln1358">        if ((choice_type == C_JOB &amp;&amp; ng.species != SP_UNKNOWN)</a>
<a name="ln1359">            || (choice_type == C_SPECIES &amp;&amp; ng.job != JOB_UNKNOWN))</a>
<a name="ln1360">        {</a>
<a name="ln1361">            text = &quot;Space - Change &quot; + other_choice_name;</a>
<a name="ln1362">            desc = &quot;Lets you change your &quot; + other_choice_name + &quot; choice.&quot;;</a>
<a name="ln1363">        }</a>
<a name="ln1364">        else</a>
<a name="ln1365">        {</a>
<a name="ln1366">            text = &quot;Space - Pick &quot; + other_choice_name + &quot; first&quot;;</a>
<a name="ln1367">            desc = &quot;Lets you pick your &quot; + other_choice_name + &quot; first.&quot;;</a>
<a name="ln1368">        }</a>
<a name="ln1369">        _add_choice_menu_option(1, 2,</a>
<a name="ln1370">                text, ' ', M_ABORT, desc);</a>
<a name="ln1371"> </a>
<a name="ln1372">        if (_char_defined(defaults))</a>
<a name="ln1373">        {</a>
<a name="ln1374">            _add_choice_menu_option(1, 3,</a>
<a name="ln1375">                    &quot;  Tab - &quot; + newgame_char_description(defaults), '\t',</a>
<a name="ln1376">                    M_DEFAULT_CHOICE,</a>
<a name="ln1377">                    &quot;Play a new game with your previous choice.&quot;);</a>
<a name="ln1378">        }</a>
<a name="ln1379">    }</a>
<a name="ln1380"> </a>
<a name="ln1381">private:</a>
<a name="ln1382">    formatted_string welcome;</a>
<a name="ln1383">    int m_choice_type;</a>
<a name="ln1384">    newgame_def&amp; m_ng;</a>
<a name="ln1385">    newgame_def&amp; m_ng_choice;</a>
<a name="ln1386">    const newgame_def&amp; m_defaults;</a>
<a name="ln1387"> </a>
<a name="ln1388">    shared_ptr&lt;Box&gt; m_vbox;</a>
<a name="ln1389">    shared_ptr&lt;OuterMenu&gt; m_main_items;</a>
<a name="ln1390">    shared_ptr&lt;OuterMenu&gt; m_sub_items;</a>
<a name="ln1391">    shared_ptr&lt;Text&gt; description;</a>
<a name="ln1392">    shared_ptr&lt;Switcher&gt; descriptions;</a>
<a name="ln1393">};</a>
<a name="ln1394"> </a>
<a name="ln1395">void UINewGameMenu::_render()</a>
<a name="ln1396">{</a>
<a name="ln1397">    m_vbox-&gt;render();</a>
<a name="ln1398">}</a>
<a name="ln1399"> </a>
<a name="ln1400">SizeReq UINewGameMenu::_get_preferred_size(Direction dim, int prosp_width)</a>
<a name="ln1401">{</a>
<a name="ln1402">    return m_vbox-&gt;get_preferred_size(dim, prosp_width);</a>
<a name="ln1403">}</a>
<a name="ln1404"> </a>
<a name="ln1405">void UINewGameMenu::_allocate_region()</a>
<a name="ln1406">{</a>
<a name="ln1407">    m_vbox-&gt;allocate_region(m_region);</a>
<a name="ln1408">}</a>
<a name="ln1409"> </a>
<a name="ln1410">#ifdef USE_TILE_WEB</a>
<a name="ln1411">void UINewGameMenu::serialize()</a>
<a name="ln1412">{</a>
<a name="ln1413">    tiles.json_write_string(&quot;title&quot;, welcome.to_colour_string());</a>
<a name="ln1414">    m_main_items-&gt;serialize(&quot;main-items&quot;);</a>
<a name="ln1415">    m_sub_items-&gt;serialize(&quot;sub-items&quot;);</a>
<a name="ln1416">}</a>
<a name="ln1417">#endif</a>
<a name="ln1418"> </a>
<a name="ln1419">void UINewGameMenu::menu_item_activated(int id)</a>
<a name="ln1420">{</a>
<a name="ln1421">    bool viable = false;</a>
<a name="ln1422">    switch (id)</a>
<a name="ln1423">    {</a>
<a name="ln1424">    case M_VIABLE_CHAR:</a>
<a name="ln1425">        viable = true;</a>
<a name="ln1426">        // intentional fall-through</a>
<a name="ln1427">    case M_RANDOM_CHAR:</a>
<a name="ln1428">        _mark_fully_random(m_ng, m_ng_choice, viable);</a>
<a name="ln1429">        done = true;</a>
<a name="ln1430">        return;</a>
<a name="ln1431">    case M_DEFAULT_CHOICE:</a>
<a name="ln1432">        if (_char_defined(m_defaults))</a>
<a name="ln1433">        {</a>
<a name="ln1434">            _set_default_choice(m_ng, m_ng_choice, m_defaults);</a>
<a name="ln1435">            done = true;</a>
<a name="ln1436">        }</a>
<a name="ln1437">            // ignore default because we don't have previous start options</a>
<a name="ln1438">        return;</a>
<a name="ln1439">    case M_ABORT:</a>
<a name="ln1440">        m_ng.species = m_ng_choice.species = SP_UNKNOWN;</a>
<a name="ln1441">        m_ng.job     = m_ng_choice.job     = JOB_UNKNOWN;</a>
<a name="ln1442">        done = true;</a>
<a name="ln1443">        return;</a>
<a name="ln1444">    case M_HELP:</a>
<a name="ln1445">        show_help(m_choice_type == C_JOB ? '2' : '1');</a>
<a name="ln1446">        return;</a>
<a name="ln1447">    case M_APTITUDES:</a>
<a name="ln1448">        show_help('%', _highlight_pattern(m_ng));</a>
<a name="ln1449">        return;</a>
<a name="ln1450">    case M_VIABLE:</a>
<a name="ln1451">        if (m_choice_type == C_JOB)</a>
<a name="ln1452">            m_ng_choice.job = JOB_VIABLE;</a>
<a name="ln1453">        else</a>
<a name="ln1454">            m_ng_choice.species = SP_VIABLE;</a>
<a name="ln1455">        done = true;</a>
<a name="ln1456">        return;</a>
<a name="ln1457">    case M_RANDOM:</a>
<a name="ln1458">        if (m_choice_type == C_JOB)</a>
<a name="ln1459">            m_ng_choice.job = JOB_RANDOM;</a>
<a name="ln1460">        else</a>
<a name="ln1461">            m_ng_choice.species = SP_RANDOM;</a>
<a name="ln1462">        done = true;</a>
<a name="ln1463">        return;</a>
<a name="ln1464">    default:</a>
<a name="ln1465">        // we have a selection</a>
<a name="ln1466">        if (m_choice_type == C_JOB)</a>
<a name="ln1467">        {</a>
<a name="ln1468">            job_type job = static_cast&lt;job_type&gt; (id);</a>
<a name="ln1469">            if (m_ng.species == SP_UNKNOWN</a>
<a name="ln1470">                || job_allowed(m_ng.species, job) != CC_BANNED)</a>
<a name="ln1471">            {</a>
<a name="ln1472">                m_ng_choice.job = job;</a>
<a name="ln1473">                done = true;</a>
<a name="ln1474">            }</a>
<a name="ln1475">        }</a>
<a name="ln1476">        else</a>
<a name="ln1477">        {</a>
<a name="ln1478">            species_type species = static_cast&lt;species_type&gt; (id);</a>
<a name="ln1479">            if (m_ng.job == JOB_UNKNOWN</a>
<a name="ln1480">                || species_allowed(m_ng.job, species) != CC_BANNED)</a>
<a name="ln1481">            {</a>
<a name="ln1482">                m_ng_choice.species = species;</a>
<a name="ln1483">                done = true;</a>
<a name="ln1484">            }</a>
<a name="ln1485">        }</a>
<a name="ln1486">        return;</a>
<a name="ln1487">    }</a>
<a name="ln1488">}</a>
<a name="ln1489"> </a>
<a name="ln1490">void job_group::attach(const newgame_def&amp; ng, const newgame_def&amp; defaults,</a>
<a name="ln1491">                       UINewGameMenu* ng_menu, menu_letter &amp;letter)</a>
<a name="ln1492">{</a>
<a name="ln1493">    ng_menu-&gt;_add_group_title(name, position);</a>
<a name="ln1494"> </a>
<a name="ln1495">    coord_def pos(position);</a>
<a name="ln1496"> </a>
<a name="ln1497">    for (job_type &amp;job : jobs)</a>
<a name="ln1498">    {</a>
<a name="ln1499">        if (job == JOB_UNKNOWN)</a>
<a name="ln1500">            break;</a>
<a name="ln1501"> </a>
<a name="ln1502">        if (ng.species != SP_UNKNOWN</a>
<a name="ln1503">            &amp;&amp; job_allowed(ng.species, job) == CC_BANNED)</a>
<a name="ln1504">        {</a>
<a name="ln1505">            continue;</a>
<a name="ln1506">        }</a>
<a name="ln1507"> </a>
<a name="ln1508">        int item_status;</a>
<a name="ln1509">        if (ng.species == SP_UNKNOWN)</a>
<a name="ln1510">            item_status = ITEM_STATUS_UNKNOWN;</a>
<a name="ln1511">        else if (job_allowed(ng.species, job) == CC_RESTRICTED)</a>
<a name="ln1512">            item_status = ITEM_STATUS_RESTRICTED;</a>
<a name="ln1513">        else</a>
<a name="ln1514">            item_status = ITEM_STATUS_ALLOWED;</a>
<a name="ln1515"> </a>
<a name="ln1516">        const bool is_active_item = defaults.job == job;</a>
<a name="ln1517"> </a>
<a name="ln1518">        ++pos.y;</a>
<a name="ln1519"> </a>
<a name="ln1520">        ng_menu-&gt;_add_group_item(</a>
<a name="ln1521">            letter,</a>
<a name="ln1522">            job,</a>
<a name="ln1523">            item_status,</a>
<a name="ln1524">            get_job_name(job),</a>
<a name="ln1525">#ifdef USE_TILE</a>
<a name="ln1526">            tile_def(tileidx_player_job(job,</a>
<a name="ln1527">                    item_status != ITEM_STATUS_RESTRICTED), TEX_GUI),</a>
<a name="ln1528">#endif</a>
<a name="ln1529">            is_active_item,</a>
<a name="ln1530">            pos</a>
<a name="ln1531">        );</a>
<a name="ln1532"> </a>
<a name="ln1533">        ++letter;</a>
<a name="ln1534">    }</a>
<a name="ln1535">}</a>
<a name="ln1536"> </a>
<a name="ln1537">void species_group::attach(const newgame_def&amp; ng, const newgame_def&amp; defaults,</a>
<a name="ln1538">                       UINewGameMenu* ng_menu, menu_letter &amp;letter)</a>
<a name="ln1539">{</a>
<a name="ln1540">    ng_menu-&gt;_add_group_title(name, position);</a>
<a name="ln1541"> </a>
<a name="ln1542">    coord_def pos(position);</a>
<a name="ln1543"> </a>
<a name="ln1544">    for (species_type &amp;this_species : species_list)</a>
<a name="ln1545">    {</a>
<a name="ln1546">        if (this_species == SP_UNKNOWN)</a>
<a name="ln1547">            break;</a>
<a name="ln1548"> </a>
<a name="ln1549">        if (ng.job == JOB_UNKNOWN &amp;&amp; !is_starting_species(this_species))</a>
<a name="ln1550">            continue;</a>
<a name="ln1551"> </a>
<a name="ln1552">        if (ng.job != JOB_UNKNOWN</a>
<a name="ln1553">            &amp;&amp; species_allowed(ng.job, this_species) == CC_BANNED)</a>
<a name="ln1554">        {</a>
<a name="ln1555">            continue;</a>
<a name="ln1556">        }</a>
<a name="ln1557"> </a>
<a name="ln1558">        int item_status;</a>
<a name="ln1559">        if (ng.job == JOB_UNKNOWN)</a>
<a name="ln1560">            item_status = ITEM_STATUS_UNKNOWN;</a>
<a name="ln1561">        else if (species_allowed(ng.job, this_species) == CC_RESTRICTED)</a>
<a name="ln1562">            item_status = ITEM_STATUS_RESTRICTED;</a>
<a name="ln1563">        else</a>
<a name="ln1564">            item_status = ITEM_STATUS_ALLOWED;</a>
<a name="ln1565"> </a>
<a name="ln1566">        const bool is_active_item = defaults.species == this_species;</a>
<a name="ln1567"> </a>
<a name="ln1568">        ++pos.y;</a>
<a name="ln1569"> </a>
<a name="ln1570">        ng_menu-&gt;_add_group_item(</a>
<a name="ln1571">            letter,</a>
<a name="ln1572">            this_species,</a>
<a name="ln1573">            item_status,</a>
<a name="ln1574">            species_name(this_species),</a>
<a name="ln1575">#ifdef USE_TILE</a>
<a name="ln1576">            tile_def(tileidx_player_species(this_species,</a>
<a name="ln1577">                    item_status != ITEM_STATUS_RESTRICTED), TEX_GUI),</a>
<a name="ln1578">#endif</a>
<a name="ln1579">            is_active_item,</a>
<a name="ln1580">            pos</a>
<a name="ln1581">        );</a>
<a name="ln1582"> </a>
<a name="ln1583">        ++letter;</a>
<a name="ln1584">    }</a>
<a name="ln1585">}</a>
<a name="ln1586"> </a>
<a name="ln1587"> </a>
<a name="ln1588">/**</a>
<a name="ln1589"> * Prompt for job or species menu</a>
<a name="ln1590"> * Saves the choice to ng_choice, doesn't resolve random choices.</a>
<a name="ln1591"> *</a>
<a name="ln1592"> * ng should be const, but we need to reset it for _resolve_species_job</a>
<a name="ln1593"> * to work correctly in view of fully random characters.</a>
<a name="ln1594"> */</a>
<a name="ln1595">static void _prompt_choice(int choice_type, newgame_def&amp; ng, newgame_def&amp; ng_choice,</a>
<a name="ln1596">                        const newgame_def&amp; defaults)</a>
<a name="ln1597">{</a>
<a name="ln1598">    auto newgame_ui = make_shared&lt;UINewGameMenu&gt;(choice_type, ng, ng_choice, defaults);</a>
<a name="ln1599">    auto popup = make_shared&lt;ui::Popup&gt;(newgame_ui);</a>
<a name="ln1600"> </a>
<a name="ln1601">#ifdef USE_TILE_WEB</a>
<a name="ln1602">    tiles.json_open_object();</a>
<a name="ln1603">    newgame_ui-&gt;serialize();</a>
<a name="ln1604">    tiles.push_ui_layout(&quot;newgame-choice&quot;, 1);</a>
<a name="ln1605">    popup-&gt;on_layout_pop([](){ tiles.pop_ui_layout(); });</a>
<a name="ln1606">#endif</a>
<a name="ln1607"> </a>
<a name="ln1608">    ui::run_layout(move(popup), newgame_ui-&gt;done);</a>
<a name="ln1609"> </a>
<a name="ln1610">    if (newgame_ui-&gt;end_game)</a>
<a name="ln1611">        end(0);</a>
<a name="ln1612">    if (newgame_ui-&gt;cancel || crawl_state.seen_hups)</a>
<a name="ln1613">        game_ended(game_exit::abort);</a>
<a name="ln1614">}</a>
<a name="ln1615"> </a>
<a name="ln1616">typedef pair&lt;weapon_type, char_choice_restriction&gt; weapon_choice;</a>
<a name="ln1617"> </a>
<a name="ln1618">static weapon_type _fixup_weapon(weapon_type wp,</a>
<a name="ln1619">                                 const vector&lt;weapon_choice&gt;&amp; weapons)</a>
<a name="ln1620">{</a>
<a name="ln1621">    if (wp == WPN_UNKNOWN || wp == WPN_RANDOM || wp == WPN_VIABLE)</a>
<a name="ln1622">        return wp;</a>
<a name="ln1623">    for (weapon_choice choice : weapons)</a>
<a name="ln1624">        if (wp == choice.first)</a>
<a name="ln1625">            return wp;</a>
<a name="ln1626">    return WPN_UNKNOWN;</a>
<a name="ln1627">}</a>
<a name="ln1628"> </a>
<a name="ln1629">static void _construct_weapon_menu(const newgame_def&amp; ng,</a>
<a name="ln1630">                                   const weapon_type&amp; defweapon,</a>
<a name="ln1631">                                   const vector&lt;weapon_choice&gt;&amp; weapons,</a>
<a name="ln1632">                                   shared_ptr&lt;OuterMenu&gt;&amp; main_items,</a>
<a name="ln1633">                                   shared_ptr&lt;OuterMenu&gt;&amp; sub_items)</a>
<a name="ln1634">{</a>
<a name="ln1635">    struct weapon_menu_item {</a>
<a name="ln1636">        skill_type skill;</a>
<a name="ln1637">        string label;</a>
<a name="ln1638">        tileidx_t tile;</a>
<a name="ln1639">        weapon_menu_item(skill_type _skill, string _label, tileidx_t _tile)</a>
<a name="ln1640">            : skill(move(_skill)), label(move(_label)), tile(move(_tile)) {};</a>
<a name="ln1641">        weapon_menu_item(skill_type _skill, string _label)</a>
<a name="ln1642">            : skill(move(_skill)), label(move(_label)), tile(0) {};</a>
<a name="ln1643">    };</a>
<a name="ln1644">    vector&lt;weapon_menu_item&gt; choices;</a>
<a name="ln1645"> </a>
<a name="ln1646">    string thrown_name;</a>
<a name="ln1647"> </a>
<a name="ln1648">    for (unsigned int i = 0; i &lt; weapons.size(); ++i)</a>
<a name="ln1649">    {</a>
<a name="ln1650">        weapon_type wpn_type = weapons[i].first;</a>
<a name="ln1651"> </a>
<a name="ln1652">        switch (wpn_type)</a>
<a name="ln1653">        {</a>
<a name="ln1654">        case WPN_UNARMED:</a>
<a name="ln1655">            choices.emplace_back(SK_UNARMED_COMBAT, species_has_claws(ng.species) ? &quot;claws&quot; : &quot;unarmed&quot;);</a>
<a name="ln1656">            break;</a>
<a name="ln1657">        case WPN_THROWN:</a>
<a name="ln1658">        {</a>
<a name="ln1659">            // We don't support choosing among multiple thrown weapons.</a>
<a name="ln1660">            tileidx_t tile = 0;</a>
<a name="ln1661">            if (species_can_throw_large_rocks(ng.species))</a>
<a name="ln1662">            {</a>
<a name="ln1663">                thrown_name = &quot;large rocks&quot;;</a>
<a name="ln1664">#ifdef USE_TILE</a>
<a name="ln1665">                tile = TILE_MI_LARGE_ROCK;</a>
<a name="ln1666">#endif</a>
<a name="ln1667">            }</a>
<a name="ln1668">            else if (species_size(ng.species, PSIZE_TORSO) &lt;= SIZE_SMALL)</a>
<a name="ln1669">            {</a>
<a name="ln1670">                thrown_name = &quot;boomerangs&quot;;</a>
<a name="ln1671">#ifdef USE_TILE</a>
<a name="ln1672">                tile = TILE_MI_BOOMERANG;</a>
<a name="ln1673">#endif</a>
<a name="ln1674">            }</a>
<a name="ln1675">            else</a>
<a name="ln1676">            {</a>
<a name="ln1677">                thrown_name = &quot;javelins&quot;;</a>
<a name="ln1678">#ifdef USE_TILE</a>
<a name="ln1679">                tile = TILE_MI_JAVELIN;</a>
<a name="ln1680">#endif</a>
<a name="ln1681">            }</a>
<a name="ln1682">            choices.emplace_back(SK_THROWING,</a>
<a name="ln1683">                    thrown_name + &quot; and throwing nets&quot;, tile);</a>
<a name="ln1684">            break;</a>
<a name="ln1685">        }</a>
<a name="ln1686">        default:</a>
<a name="ln1687">            string text = weapon_base_name(wpn_type);</a>
<a name="ln1688">            item_def dummy;</a>
<a name="ln1689">            dummy.base_type = OBJ_WEAPONS;</a>
<a name="ln1690">            dummy.sub_type = wpn_type;</a>
<a name="ln1691">            if (is_ranged_weapon_type(wpn_type))</a>
<a name="ln1692">            {</a>
<a name="ln1693">                text += &quot; and &quot;;</a>
<a name="ln1694">                text += wpn_type == WPN_HUNTING_SLING ? ammo_name(MI_SLING_BULLET)</a>
<a name="ln1695">                                                      : ammo_name(wpn_type);</a>
<a name="ln1696">                text += &quot;s&quot;;</a>
<a name="ln1697">            }</a>
<a name="ln1698">            choices.emplace_back(item_attack_skill(dummy), text</a>
<a name="ln1699">#ifdef USE_TILE</a>
<a name="ln1700">                    , tileidx_item(dummy)</a>
<a name="ln1701">#endif</a>
<a name="ln1702">            );</a>
<a name="ln1703">            break;</a>
<a name="ln1704">        }</a>
<a name="ln1705">    }</a>
<a name="ln1706"> </a>
<a name="ln1707">    int max_text_width = 0;</a>
<a name="ln1708">    for (const auto&amp; choice : choices)</a>
<a name="ln1709">        max_text_width = max(max_text_width, strwidth(choice.label));</a>
<a name="ln1710"> </a>
<a name="ln1711">    for (unsigned int i = 0; i &lt; weapons.size(); ++i)</a>
<a name="ln1712">    {</a>
<a name="ln1713">        const auto&amp; choice = choices[i];</a>
<a name="ln1714"> </a>
<a name="ln1715">        auto hbox = make_shared&lt;Box&gt;(Box::HORZ);</a>
<a name="ln1716">        hbox-&gt;set_cross_alignment(Widget::Align::CENTER);</a>
<a name="ln1717">        hbox-&gt;set_margin_for_sdl(2, 10, 2, 2);</a>
<a name="ln1718"> </a>
<a name="ln1719">#ifdef USE_TILE</a>
<a name="ln1720">        auto tile_stack = make_shared&lt;Stack&gt;();</a>
<a name="ln1721">        tile_stack-&gt;set_margin_for_sdl(0, 6, 0, 0);</a>
<a name="ln1722">        tile_stack-&gt;flex_grow = 0;</a>
<a name="ln1723">        hbox-&gt;add_child(tile_stack);</a>
<a name="ln1724"> </a>
<a name="ln1725">        if (choice.skill == SK_THROWING)</a>
<a name="ln1726">        {</a>
<a name="ln1727">            tile_stack-&gt;add_child(make_shared&lt;Image&gt;(</a>
<a name="ln1728">                    tile_def(TILE_MI_THROWING_NET, TEX_DEFAULT)));</a>
<a name="ln1729">        }</a>
<a name="ln1730">        if (choice.skill == SK_UNARMED_COMBAT)</a>
<a name="ln1731">        {</a>
<a name="ln1732">#ifndef USE_TILE_WEB</a>
<a name="ln1733">            tile_stack-&gt;min_size() = Size{TILE_Y};</a>
<a name="ln1734">#endif</a>
<a name="ln1735">        }</a>
<a name="ln1736">        else</a>
<a name="ln1737">        {</a>
<a name="ln1738">            tile_stack-&gt;add_child(make_shared&lt;Image&gt;(</a>
<a name="ln1739">                    tile_def(choice.tile, TEX_DEFAULT)));</a>
<a name="ln1740">        }</a>
<a name="ln1741">#endif</a>
<a name="ln1742"> </a>
<a name="ln1743">        auto label = make_shared&lt;Text&gt;();</a>
<a name="ln1744">        hbox-&gt;add_child(label);</a>
<a name="ln1745"> </a>
<a name="ln1746">        const char letter = 'a' + i;</a>
<a name="ln1747"> </a>
<a name="ln1748">        string text = make_stringf(&quot; %c - %s&quot;, letter,</a>
<a name="ln1749">                chop_string(choice.label, max_text_width, true).c_str()</a>
<a name="ln1750">                );</a>
<a name="ln1751"> </a>
<a name="ln1752">        weapon_type wpn_type = weapons[i].first;</a>
<a name="ln1753">        char_choice_restriction wpn_restriction = weapons[i].second;</a>
<a name="ln1754"> </a>
<a name="ln1755">        const auto fg = wpn_restriction == CC_UNRESTRICTED ? WHITE : LIGHTGREY;</a>
<a name="ln1756">        const auto bg = wpn_restriction == CC_UNRESTRICTED ?</a>
<a name="ln1757">            STARTUP_HIGHLIGHT_GOOD : STARTUP_HIGHLIGHT_BAD;</a>
<a name="ln1758"> </a>
<a name="ln1759">        label-&gt;set_text(formatted_string(text, fg));</a>
<a name="ln1760"> </a>
<a name="ln1761">        hbox-&gt;set_main_alignment(Widget::Align::STRETCH);</a>
<a name="ln1762">        string apt_text = make_stringf(&quot;(%+d apt)&quot;,</a>
<a name="ln1763">                species_apt(choice.skill, ng.species));</a>
<a name="ln1764">        auto suffix = make_shared&lt;Text&gt;(formatted_string(apt_text, fg));</a>
<a name="ln1765">        hbox-&gt;add_child(suffix);</a>
<a name="ln1766"> </a>
<a name="ln1767">        auto btn = make_shared&lt;MenuButton&gt;();</a>
<a name="ln1768">        btn-&gt;set_child(move(hbox));</a>
<a name="ln1769">        btn-&gt;id = wpn_type;</a>
<a name="ln1770">        btn-&gt;hotkey = letter;</a>
<a name="ln1771">        btn-&gt;highlight_colour = bg;</a>
<a name="ln1772"> </a>
<a name="ln1773">        // Is this item our default weapon?</a>
<a name="ln1774">        if (wpn_type == defweapon || (defweapon == WPN_UNKNOWN &amp;&amp; i == 0))</a>
<a name="ln1775">            main_items-&gt;set_initial_focus(btn.get());</a>
<a name="ln1776">        main_items-&gt;add_button(move(btn), 0, i);</a>
<a name="ln1777">    }</a>
<a name="ln1778"> </a>
<a name="ln1779">    _add_menu_sub_item(sub_items, 0, 0, &quot;+ - Recommended random choice&quot;,</a>
<a name="ln1780">            &quot;Picks a random recommended weapon&quot;, '+', M_VIABLE);</a>
<a name="ln1781">    _add_menu_sub_item(sub_items, 0, 1, &quot;% - List aptitudes&quot;,</a>
<a name="ln1782">            &quot;Lists the numerical skill train aptitudes for all races&quot;, '%',</a>
<a name="ln1783">            M_APTITUDES);</a>
<a name="ln1784">    _add_menu_sub_item(sub_items, 0, 2, &quot;? - Help&quot;,</a>
<a name="ln1785">            &quot;Opens the help screen&quot;, '?', M_HELP);</a>
<a name="ln1786">    _add_menu_sub_item(sub_items, 1, 0, &quot;* - Random weapon&quot;,</a>
<a name="ln1787">            &quot;Picks a random weapon&quot;, '*', WPN_RANDOM);</a>
<a name="ln1788">    _add_menu_sub_item(sub_items, 1, 1, &quot;Bksp - Return to character menu&quot;,</a>
<a name="ln1789">            &quot;Lets you return back to Character choice menu&quot;, CK_BKSP, M_ABORT);</a>
<a name="ln1790"> </a>
<a name="ln1791">    if (defweapon != WPN_UNKNOWN)</a>
<a name="ln1792">    {</a>
<a name="ln1793">        string text = &quot;Tab - &quot;;</a>
<a name="ln1794"> </a>
<a name="ln1795">        ASSERT(defweapon != WPN_THROWN || thrown_name != &quot;&quot;);</a>
<a name="ln1796">        text += defweapon == WPN_RANDOM  ? &quot;Random&quot; :</a>
<a name="ln1797">                defweapon == WPN_VIABLE  ? &quot;Recommended&quot; :</a>
<a name="ln1798">                defweapon == WPN_UNARMED ? &quot;unarmed&quot; :</a>
<a name="ln1799">                defweapon == WPN_THROWN  ? thrown_name :</a>
<a name="ln1800">                weapon_base_name(defweapon);</a>
<a name="ln1801"> </a>
<a name="ln1802">        _add_menu_sub_item(sub_items, 1, 2, text,</a>
<a name="ln1803">                &quot;Select your old weapon&quot;, '\t', M_DEFAULT_CHOICE);</a>
<a name="ln1804">    }</a>
<a name="ln1805">}</a>
<a name="ln1806"> </a>
<a name="ln1807">/**</a>
<a name="ln1808"> * Returns false if user escapes</a>
<a name="ln1809"> */</a>
<a name="ln1810">static bool _prompt_weapon(const newgame_def&amp; ng, newgame_def&amp; ng_choice,</a>
<a name="ln1811">                           const newgame_def&amp; defaults,</a>
<a name="ln1812">                           const vector&lt;weapon_choice&gt;&amp; weapons)</a>
<a name="ln1813">{</a>
<a name="ln1814">    weapon_type defweapon = _fixup_weapon(defaults.weapon, weapons);</a>
<a name="ln1815"> </a>
<a name="ln1816">    auto title_hbox = make_shared&lt;Box&gt;(Widget::HORZ);</a>
<a name="ln1817">#ifdef USE_TILE</a>
<a name="ln1818">    dolls_data doll;</a>
<a name="ln1819">    fill_doll_for_newgame(doll, ng);</a>
<a name="ln1820">#ifdef USE_TILE_LOCAL</a>
<a name="ln1821">    auto tile = make_shared&lt;ui::PlayerDoll&gt;(doll);</a>
<a name="ln1822">    tile-&gt;set_margin_for_sdl(0, 10, 0, 0);</a>
<a name="ln1823">    title_hbox-&gt;add_child(move(tile));</a>
<a name="ln1824">#endif</a>
<a name="ln1825">#endif</a>
<a name="ln1826">    auto title = make_shared&lt;Text&gt;(formatted_string(_welcome(ng), BROWN));</a>
<a name="ln1827">    title_hbox-&gt;add_child(title);</a>
<a name="ln1828">    title_hbox-&gt;set_cross_alignment(Widget::CENTER);</a>
<a name="ln1829">    title_hbox-&gt;set_margin_for_sdl(0, 0, 20, 0);</a>
<a name="ln1830">    title_hbox-&gt;set_margin_for_crt(0, 0, 1, 0);</a>
<a name="ln1831"> </a>
<a name="ln1832">    auto vbox = make_shared&lt;Box&gt;(Box::VERT);</a>
<a name="ln1833">    vbox-&gt;set_cross_alignment(Widget::Align::STRETCH);</a>
<a name="ln1834">    vbox-&gt;add_child(title_hbox);</a>
<a name="ln1835">    auto prompt = make_shared&lt;Text&gt;(formatted_string(&quot;You have a choice of weapons.&quot;, CYAN));</a>
<a name="ln1836">    vbox-&gt;add_child(prompt);</a>
<a name="ln1837"> </a>
<a name="ln1838">    auto main_items = make_shared&lt;OuterMenu&gt;(true, 1, weapons.size());</a>
<a name="ln1839">    main_items-&gt;menu_id = &quot;weapon-main&quot;;</a>
<a name="ln1840">    main_items-&gt;set_margin_for_sdl(15, 0);</a>
<a name="ln1841">    main_items-&gt;set_margin_for_crt(1, 0);</a>
<a name="ln1842">    vbox-&gt;add_child(main_items);</a>
<a name="ln1843"> </a>
<a name="ln1844">    auto sub_items = make_shared&lt;OuterMenu&gt;(false, 2, 3);</a>
<a name="ln1845">    sub_items-&gt;menu_id = &quot;weapon-sub&quot;;</a>
<a name="ln1846">    vbox-&gt;add_child(sub_items);</a>
<a name="ln1847"> </a>
<a name="ln1848">    main_items-&gt;linked_menus[2] = sub_items;</a>
<a name="ln1849">    sub_items-&gt;linked_menus[0] = main_items;</a>
<a name="ln1850"> </a>
<a name="ln1851">    _construct_weapon_menu(ng, defweapon, weapons, main_items, sub_items);</a>
<a name="ln1852"> </a>
<a name="ln1853">    bool done = false, ret = false;</a>
<a name="ln1854"> </a>
<a name="ln1855">    vbox-&gt;on_activate_event([&amp;](const ActivateEvent&amp; event) {</a>
<a name="ln1856">        const auto button = static_pointer_cast&lt;MenuButton&gt;(event.target());</a>
<a name="ln1857">        const auto id = button-&gt;id;</a>
<a name="ln1858">        switch (id)</a>
<a name="ln1859">        {</a>
<a name="ln1860">            case M_ABORT:</a>
<a name="ln1861">                ret = false;</a>
<a name="ln1862">                return done = true;</a>
<a name="ln1863">            case M_APTITUDES:</a>
<a name="ln1864">                show_help('%', _highlight_pattern(ng));</a>
<a name="ln1865">                return true;</a>
<a name="ln1866">            case M_HELP:</a>
<a name="ln1867">                show_help('?');</a>
<a name="ln1868">                return true;</a>
<a name="ln1869">            case M_DEFAULT_CHOICE:</a>
<a name="ln1870">                if (defweapon != WPN_UNKNOWN)</a>
<a name="ln1871">                    ng_choice.weapon = defweapon;</a>
<a name="ln1872">                // No default weapon defined.</a>
<a name="ln1873">                // This case should never happen in those cases but just in case</a>
<a name="ln1874">                return true;</a>
<a name="ln1875">            case M_VIABLE:</a>
<a name="ln1876">                ng_choice.weapon = WPN_VIABLE;</a>
<a name="ln1877">                break;</a>
<a name="ln1878">            case M_RANDOM:</a>
<a name="ln1879">                ng_choice.weapon = WPN_RANDOM;</a>
<a name="ln1880">                break;</a>
<a name="ln1881">            default:</a>
<a name="ln1882">                ng_choice.weapon = static_cast&lt;weapon_type&gt; (id);</a>
<a name="ln1883">                break;</a>
<a name="ln1884">        }</a>
<a name="ln1885">        return ret = done = true;</a>
<a name="ln1886">    });</a>
<a name="ln1887"> </a>
<a name="ln1888">    auto popup = make_shared&lt;ui::Popup&gt;(vbox);</a>
<a name="ln1889">    popup-&gt;on_hotkey_event([&amp;](const KeyEvent&amp; ev) {</a>
<a name="ln1890">        switch (ev.key())</a>
<a name="ln1891">        {</a>
<a name="ln1892">            case 'X':</a>
<a name="ln1893">            case CONTROL('Q'):</a>
<a name="ln1894">#ifdef USE_TILE_WEB</a>
<a name="ln1895">                tiles.send_exit_reason(&quot;cancel&quot;);</a>
<a name="ln1896">#endif</a>
<a name="ln1897">                end(0);</a>
<a name="ln1898">                break;</a>
<a name="ln1899">            case ' ':</a>
<a name="ln1900">            CASE_ESCAPE</a>
<a name="ln1901">            case CK_MOUSE_CMD:</a>
<a name="ln1902">                ret = false;</a>
<a name="ln1903">                return done = true;</a>
<a name="ln1904">            default:</a>
<a name="ln1905">                break;</a>
<a name="ln1906">        }</a>
<a name="ln1907"> </a>
<a name="ln1908">        return false;</a>
<a name="ln1909">    });</a>
<a name="ln1910"> </a>
<a name="ln1911">#ifdef USE_TILE_WEB</a>
<a name="ln1912">    tiles.json_open_object();</a>
<a name="ln1913">    tiles.json_write_string(&quot;title&quot;, title-&gt;get_text().to_colour_string());</a>
<a name="ln1914">    tiles.json_write_string(&quot;prompt&quot;, prompt-&gt;get_text().to_colour_string());</a>
<a name="ln1915">    main_items-&gt;serialize(&quot;main-items&quot;);</a>
<a name="ln1916">    sub_items-&gt;serialize(&quot;sub-items&quot;);</a>
<a name="ln1917">    tiles.send_doll(doll, false, false);</a>
<a name="ln1918">    tiles.push_ui_layout(&quot;newgame-choice&quot;, 1);</a>
<a name="ln1919">    popup-&gt;on_layout_pop([](){ tiles.pop_ui_layout(); });</a>
<a name="ln1920">#endif</a>
<a name="ln1921">    ui::run_layout(move(popup), done);</a>
<a name="ln1922"> </a>
<a name="ln1923">    return ret;</a>
<a name="ln1924">}</a>
<a name="ln1925"> </a>
<a name="ln1926">static weapon_type _starting_weapon_upgrade(weapon_type wp, job_type job,</a>
<a name="ln1927">                                            species_type species)</a>
<a name="ln1928">{</a>
<a name="ln1929">    const bool fighter = job == JOB_FIGHTER;</a>
<a name="ln1930">    const size_type size = species_size(species, PSIZE_TORSO);</a>
<a name="ln1931"> </a>
<a name="ln1932">    // TODO: actually query itemprop for one-handedness.</a>
<a name="ln1933">    switch (wp)</a>
<a name="ln1934">    {</a>
<a name="ln1935">    case WPN_SHORT_SWORD:</a>
<a name="ln1936">        return WPN_RAPIER;</a>
<a name="ln1937">    case WPN_MACE:</a>
<a name="ln1938">        return WPN_FLAIL;</a>
<a name="ln1939">    case WPN_HAND_AXE:</a>
<a name="ln1940">        return WPN_WAR_AXE;</a>
<a name="ln1941">    case WPN_SPEAR:</a>
<a name="ln1942">        // Small fighters can't use tridents with a shield.</a>
<a name="ln1943">        return fighter &amp;&amp; size &lt;= SIZE_SMALL  ? wp : WPN_TRIDENT;</a>
<a name="ln1944">    case WPN_FALCHION:</a>
<a name="ln1945">        return WPN_LONG_SWORD;</a>
<a name="ln1946">    default:</a>
<a name="ln1947">        return wp;</a>
<a name="ln1948">    }</a>
<a name="ln1949">}</a>
<a name="ln1950"> </a>
<a name="ln1951">static vector&lt;weapon_choice&gt; _get_weapons(const newgame_def&amp; ng)</a>
<a name="ln1952">{</a>
<a name="ln1953">    vector&lt;weapon_choice&gt; weapons;</a>
<a name="ln1954">    if (job_gets_ranged_weapons(ng.job))</a>
<a name="ln1955">    {</a>
<a name="ln1956">        weapon_type startwep[4] = { WPN_THROWN, WPN_HUNTING_SLING,</a>
<a name="ln1957">                                    WPN_SHORTBOW, WPN_HAND_CROSSBOW };</a>
<a name="ln1958"> </a>
<a name="ln1959">        for (int i = 0; i &lt; 4; i++)</a>
<a name="ln1960">        {</a>
<a name="ln1961">            weapon_choice wp;</a>
<a name="ln1962">            wp.first = startwep[i];</a>
<a name="ln1963"> </a>
<a name="ln1964">            wp.second = weapon_restriction(wp.first, ng);</a>
<a name="ln1965">            if (wp.second != CC_BANNED)</a>
<a name="ln1966">                weapons.push_back(wp);</a>
<a name="ln1967">        }</a>
<a name="ln1968">    }</a>
<a name="ln1969">    else</a>
<a name="ln1970">    {</a>
<a name="ln1971">        weapon_type startwep[7] = { WPN_SHORT_SWORD, WPN_MACE, WPN_HAND_AXE,</a>
<a name="ln1972">                                    WPN_SPEAR, WPN_FALCHION, WPN_QUARTERSTAFF,</a>
<a name="ln1973">                                    WPN_UNARMED };</a>
<a name="ln1974">        for (int i = 0; i &lt; 7; ++i)</a>
<a name="ln1975">        {</a>
<a name="ln1976">            weapon_choice wp;</a>
<a name="ln1977">            wp.first = startwep[i];</a>
<a name="ln1978">            if (job_gets_good_weapons(ng.job))</a>
<a name="ln1979">            {</a>
<a name="ln1980">                wp.first = _starting_weapon_upgrade(wp.first, ng.job,</a>
<a name="ln1981">                                                    ng.species);</a>
<a name="ln1982">            }</a>
<a name="ln1983"> </a>
<a name="ln1984">            wp.second = weapon_restriction(wp.first, ng);</a>
<a name="ln1985">            if (wp.second != CC_BANNED)</a>
<a name="ln1986">                weapons.push_back(wp);</a>
<a name="ln1987">        }</a>
<a name="ln1988">    }</a>
<a name="ln1989">    return weapons;</a>
<a name="ln1990">}</a>
<a name="ln1991"> </a>
<a name="ln1992">static void _resolve_weapon(newgame_def&amp; ng, newgame_def&amp; ng_choice,</a>
<a name="ln1993">                            const vector&lt;weapon_choice&gt;&amp; weapons)</a>
<a name="ln1994">{</a>
<a name="ln1995">    int weapon = ng_choice.weapon;</a>
<a name="ln1996"> </a>
<a name="ln1997">    if (ng_choice.allowed_weapons.size())</a>
<a name="ln1998">    {</a>
<a name="ln1999">        weapon =</a>
<a name="ln2000">            ng_choice.allowed_weapons[</a>
<a name="ln2001">                random2(ng_choice.allowed_weapons.size())];</a>
<a name="ln2002">    }</a>
<a name="ln2003"> </a>
<a name="ln2004">    switch (weapon)</a>
<a name="ln2005">    {</a>
<a name="ln2006">    case WPN_VIABLE:</a>
<a name="ln2007">    {</a>
<a name="ln2008">        int good_choices = 0;</a>
<a name="ln2009">        for (weapon_choice choice : weapons)</a>
<a name="ln2010">        {</a>
<a name="ln2011">            if (choice.second == CC_UNRESTRICTED</a>
<a name="ln2012">                &amp;&amp; one_chance_in(++good_choices))</a>
<a name="ln2013">            {</a>
<a name="ln2014">                ng.weapon = choice.first;</a>
<a name="ln2015">            }</a>
<a name="ln2016">        }</a>
<a name="ln2017">        if (good_choices)</a>
<a name="ln2018">            return;</a>
<a name="ln2019">    }</a>
<a name="ln2020">        // intentional fall-through</a>
<a name="ln2021">    case WPN_RANDOM:</a>
<a name="ln2022">        ng.weapon = weapons[random2(weapons.size())].first;</a>
<a name="ln2023">        return;</a>
<a name="ln2024"> </a>
<a name="ln2025">    default:</a>
<a name="ln2026">        // _fixup_weapon will return WPN_UNKNOWN, allowing the player</a>
<a name="ln2027">        // to select the weapon, if the weapon option is incompatible.</a>
<a name="ln2028">        ng.weapon = _fixup_weapon(ng_choice.weapon, weapons);</a>
<a name="ln2029">        return;</a>
<a name="ln2030">    }</a>
<a name="ln2031">}</a>
<a name="ln2032"> </a>
<a name="ln2033">// Returns false if aborted, else an actual weapon choice</a>
<a name="ln2034">// is written to ng.weapon for the jobs that call</a>
<a name="ln2035">// _update_weapon() later.</a>
<a name="ln2036">static bool _choose_weapon(newgame_def&amp; ng, newgame_def&amp; ng_choice,</a>
<a name="ln2037">                           const newgame_def&amp; defaults)</a>
<a name="ln2038">{</a>
<a name="ln2039">    // No weapon use at all. The actual item will be removed later.</a>
<a name="ln2040">    if (ng.species == SP_FELID)</a>
<a name="ln2041">        return true;</a>
<a name="ln2042"> </a>
<a name="ln2043">    if (!job_has_weapon_choice(ng.job))</a>
<a name="ln2044">        return true;</a>
<a name="ln2045"> </a>
<a name="ln2046">    vector&lt;weapon_choice&gt; weapons = _get_weapons(ng);</a>
<a name="ln2047"> </a>
<a name="ln2048">    ASSERT(!weapons.empty());</a>
<a name="ln2049">    if (weapons.size() == 1)</a>
<a name="ln2050">    {</a>
<a name="ln2051">        ng.weapon = ng_choice.weapon = weapons[0].first;</a>
<a name="ln2052">        return true;</a>
<a name="ln2053">    }</a>
<a name="ln2054"> </a>
<a name="ln2055">    _resolve_weapon(ng, ng_choice, weapons);</a>
<a name="ln2056">    if (ng.weapon == WPN_UNKNOWN)</a>
<a name="ln2057">    {</a>
<a name="ln2058">        if (!_prompt_weapon(ng, ng_choice, defaults, weapons))</a>
<a name="ln2059">            return false;</a>
<a name="ln2060">        _resolve_weapon(ng, ng_choice, weapons);</a>
<a name="ln2061">    }</a>
<a name="ln2062"> </a>
<a name="ln2063">    return true;</a>
<a name="ln2064">}</a>
<a name="ln2065"> </a>
<a name="ln2066">#ifdef USE_TILE</a>
<a name="ln2067">static tile_def tile_for_map_name(string name)</a>
<a name="ln2068">{</a>
<a name="ln2069">    if (starts_with(name, &quot;Lesson &quot;))</a>
<a name="ln2070">    {</a>
<a name="ln2071">        const int i = name[7]-'1';</a>
<a name="ln2072">        ASSERT_RANGE(i, 0, 5);</a>
<a name="ln2073">        constexpr tileidx_t tutorial_tiles[5] = {</a>
<a name="ln2074">            TILEG_TUT_MOVEMENT,</a>
<a name="ln2075">            TILEG_TUT_COMBAT,</a>
<a name="ln2076">            TILEG_CMD_DISPLAY_INVENTORY,</a>
<a name="ln2077">            TILEG_CMD_CAST_SPELL,</a>
<a name="ln2078">            TILEG_CMD_USE_ABILITY,</a>
<a name="ln2079">        };</a>
<a name="ln2080">        return tile_def(tutorial_tiles[i], TEX_GUI);</a>
<a name="ln2081">    }</a>
<a name="ln2082"> </a>
<a name="ln2083">    if (name == &quot;Sprint I: \&quot;Red Sonja\&quot;&quot;)</a>
<a name="ln2084">        return tile_def(TILEP_MONS_SONJA, TEX_PLAYER);</a>
<a name="ln2085">    if (name == &quot;Sprint II: \&quot;The Violet Keep of Menkaure\&quot;&quot;)</a>
<a name="ln2086">        return tile_def(TILEP_MONS_MENKAURE, TEX_PLAYER);</a>
<a name="ln2087">    if (name == &quot;Sprint III: \&quot;The Ten Rune Challenge\&quot;&quot;)</a>
<a name="ln2088">        return tile_def(TILE_MISC_RUNE_OF_ZOT, TEX_DEFAULT);</a>
<a name="ln2089">    if (name == &quot;Sprint IV: \&quot;Fedhas' Mad Dash\&quot;&quot;)</a>
<a name="ln2090">        return tile_def(TILE_DNGN_ALTAR_FEDHAS, TEX_FEAT);</a>
<a name="ln2091">    if (name == &quot;Sprint V: \&quot;Ziggurat Sprint\&quot;&quot;)</a>
<a name="ln2092">        return tile_def(TILE_DNGN_PORTAL_ZIGGURAT, TEX_FEAT);</a>
<a name="ln2093">    if (name == &quot;Sprint VI: \&quot;Thunderdome\&quot;&quot;)</a>
<a name="ln2094">        return tile_def(TILE_GOLD16, TEX_DEFAULT);</a>
<a name="ln2095">    if (name == &quot;Sprint VII: \&quot;The Pits\&quot;&quot;)</a>
<a name="ln2096">        return tile_def(TILE_WALL_CRYPT_METAL + 2, TEX_WALL);</a>
<a name="ln2097">    if (name == &quot;Sprint VIII: \&quot;Arena of Blood\&quot;&quot;)</a>
<a name="ln2098">        return tile_def(TILE_UNRAND_WOE, TEX_DEFAULT);</a>
<a name="ln2099">    if (name == &quot;Sprint IX: \&quot;|||||||||||||||||||||||||||||\&quot;&quot;)</a>
<a name="ln2100">        return tile_def(TILE_WALL_LAB_METAL + 2, TEX_WALL);</a>
<a name="ln2101">    return tile_def(0, TEX_GUI);</a>
<a name="ln2102">}</a>
<a name="ln2103">#endif</a>
<a name="ln2104"> </a>
<a name="ln2105">static void _construct_gamemode_map_menu(const mapref_vector&amp; maps,</a>
<a name="ln2106">                                         const newgame_def&amp; defaults,</a>
<a name="ln2107">                                         shared_ptr&lt;OuterMenu&gt;&amp; main_items,</a>
<a name="ln2108">                                         shared_ptr&lt;OuterMenu&gt;&amp; sub_items)</a>
<a name="ln2109">{</a>
<a name="ln2110">    string text;</a>
<a name="ln2111">    bool activate_next = defaults.map == &quot;&quot;;</a>
<a name="ln2112"> </a>
<a name="ln2113">    for (int i = 0; i &lt; static_cast&lt;int&gt; (maps.size()); i++)</a>
<a name="ln2114">    {</a>
<a name="ln2115">        auto label = make_shared&lt;Text&gt;();</a>
<a name="ln2116"> </a>
<a name="ln2117">        const char letter = 'a' + i;</a>
<a name="ln2118"> </a>
<a name="ln2119">        const string map_name = maps[i]-&gt;desc_or_name();</a>
<a name="ln2120">        text = &quot; &quot;;</a>
<a name="ln2121">        text += letter;</a>
<a name="ln2122">        text += &quot; - &quot;;</a>
<a name="ln2123">        text += map_name;</a>
<a name="ln2124"> </a>
<a name="ln2125">#ifdef USE_TILE</a>
<a name="ln2126">        auto hbox = make_shared&lt;Box&gt;(Box::HORZ);</a>
<a name="ln2127">        hbox-&gt;set_cross_alignment(Widget::Align::CENTER);</a>
<a name="ln2128">        auto tile = make_shared&lt;Image&gt;();</a>
<a name="ln2129">        tile-&gt;set_tile(tile_for_map_name(map_name));</a>
<a name="ln2130">        tile-&gt;set_margin_for_sdl(0, 6, 0, 0);</a>
<a name="ln2131">        hbox-&gt;add_child(move(tile));</a>
<a name="ln2132">        hbox-&gt;add_child(label);</a>
<a name="ln2133">#endif</a>
<a name="ln2134"> </a>
<a name="ln2135">        label-&gt;set_text(formatted_string(text, LIGHTGREY));</a>
<a name="ln2136"> </a>
<a name="ln2137">        auto btn = make_shared&lt;MenuButton&gt;();</a>
<a name="ln2138">#ifdef USE_TILE</a>
<a name="ln2139">        hbox-&gt;set_margin_for_sdl(2, 10, 2, 2);</a>
<a name="ln2140">        btn-&gt;set_child(move(hbox));</a>
<a name="ln2141">#else</a>
<a name="ln2142">        btn-&gt;set_child(move(label));</a>
<a name="ln2143">#endif</a>
<a name="ln2144">        btn-&gt;id = i; // ID corresponds to location in vector</a>
<a name="ln2145">        btn-&gt;hotkey = letter;</a>
<a name="ln2146">        main_items-&gt;add_button(btn, 0, i);</a>
<a name="ln2147"> </a>
<a name="ln2148">        if (activate_next)</a>
<a name="ln2149">        {</a>
<a name="ln2150">            main_items-&gt;set_initial_focus(btn.get());</a>
<a name="ln2151">            activate_next = false;</a>
<a name="ln2152">        }</a>
<a name="ln2153">        // Is this item our default map?</a>
<a name="ln2154">        else if (defaults.map == maps[i]-&gt;name)</a>
<a name="ln2155">        {</a>
<a name="ln2156">            if (crawl_state.last_game_exit.exit_reason == game_exit::win)</a>
<a name="ln2157">                activate_next = true;</a>
<a name="ln2158">            else</a>
<a name="ln2159">                main_items-&gt;set_initial_focus(btn.get());</a>
<a name="ln2160">        }</a>
<a name="ln2161">    }</a>
<a name="ln2162"> </a>
<a name="ln2163">    // Don't overwhelm new players with aptitudes or the full list of commands!</a>
<a name="ln2164">    if (!crawl_state.game_is_tutorial())</a>
<a name="ln2165">    {</a>
<a name="ln2166">        _add_menu_sub_item(sub_items, 0, 0, &quot;% - List aptitudes&quot;,</a>
<a name="ln2167">                &quot;Lists the numerical skill train aptitudes for all races&quot;,</a>
<a name="ln2168">                '%', M_APTITUDES);</a>
<a name="ln2169">        _add_menu_sub_item(sub_items, 0, 1, &quot;? - Help&quot;,</a>
<a name="ln2170">                &quot;Opens the help screen&quot;, '?', M_HELP);</a>
<a name="ln2171">        _add_menu_sub_item(sub_items, 1, 0, &quot;* - Random map&quot;,</a>
<a name="ln2172">                &quot;Picks a random sprint map&quot;, '*', M_RANDOM);</a>
<a name="ln2173">    }</a>
<a name="ln2174"> </a>
<a name="ln2175">    // TODO: let players escape back to first screen menu</a>
<a name="ln2176">    // Adjust the end marker to align the - because Bksp text is longer by 3</a>
<a name="ln2177">    //tmp = new TextItem();</a>
<a name="ln2178">    //tmp-&gt;set_text(&quot;Bksp - Return to character menu&quot;);</a>
<a name="ln2179">    //tmp-&gt;set_description_text(&quot;Lets you return back to Character choice menu&quot;);</a>
<a name="ln2180">    //tmp-&gt;set_fg_colour(BROWN);</a>
<a name="ln2181">    //tmp-&gt;add_hotkey(CK_BKSP);</a>
<a name="ln2182">    //tmp-&gt;set_id(M_ABORT);</a>
<a name="ln2183">    //tmp-&gt;set_highlight_colour(LIGHTGRAY);</a>
<a name="ln2184">    //menu-&gt;attach_item(tmp);</a>
<a name="ln2185"> </a>
<a name="ln2186">    // Only add tab entry if we have a previous map choice</a>
<a name="ln2187">    if (crawl_state.game_is_sprint() &amp;&amp; !defaults.map.empty()</a>
<a name="ln2188">        &amp;&amp; defaults.type == GAME_TYPE_SPRINT &amp;&amp; _char_defined(defaults))</a>
<a name="ln2189">    {</a>
<a name="ln2190">        text.clear();</a>
<a name="ln2191">        text += &quot;Tab - &quot;;</a>
<a name="ln2192">        text += defaults.map;</a>
<a name="ln2193">        _add_menu_sub_item(sub_items, 1, 1, text,</a>
<a name="ln2194">                &quot;Select your previous sprint map and character&quot;, '\t',</a>
<a name="ln2195">                M_DEFAULT_CHOICE);</a>
<a name="ln2196">    }</a>
<a name="ln2197">}</a>
<a name="ln2198"> </a>
<a name="ln2199">// Compare two maps by their ORDER: header, falling back to desc or name if equal.</a>
<a name="ln2200">static bool _cmp_map_by_order(const map_def* m1, const map_def* m2)</a>
<a name="ln2201">{</a>
<a name="ln2202">    return m1-&gt;order &lt; m2-&gt;order</a>
<a name="ln2203">           || m1-&gt;order == m2-&gt;order &amp;&amp; m1-&gt;desc_or_name() &lt; m2-&gt;desc_or_name();</a>
<a name="ln2204">}</a>
<a name="ln2205"> </a>
<a name="ln2206">static void _prompt_gamemode_map(newgame_def&amp; ng, newgame_def&amp; ng_choice,</a>
<a name="ln2207">                                 const newgame_def&amp; defaults,</a>
<a name="ln2208">                                 mapref_vector maps)</a>
<a name="ln2209">{</a>
<a name="ln2210">    formatted_string welcome;</a>
<a name="ln2211">    welcome.textcolour(BROWN);</a>
<a name="ln2212">    welcome.cprintf(&quot;%s\n&quot;, _welcome(ng).c_str());</a>
<a name="ln2213">    if (Options.seed_from_rc)</a>
<a name="ln2214">        welcome.cprintf(&quot;Custom seed: %&quot; PRIu64 &quot;\n&quot;, Options.seed_from_rc);</a>
<a name="ln2215"> </a>
<a name="ln2216">    welcome.textcolour(CYAN);</a>
<a name="ln2217">    welcome.cprintf(&quot;\nYou have a choice of %s:&quot;,</a>
<a name="ln2218">            ng_choice.type == GAME_TYPE_TUTORIAL ? &quot;lessons&quot; : &quot;maps&quot;);</a>
<a name="ln2219"> </a>
<a name="ln2220">    auto vbox = make_shared&lt;Box&gt;(Box::VERT);</a>
<a name="ln2221">    vbox-&gt;set_cross_alignment(Widget::Align::STRETCH);</a>
<a name="ln2222">    vbox-&gt;add_child(make_shared&lt;Text&gt;(welcome));</a>
<a name="ln2223"> </a>
<a name="ln2224">    auto main_items = make_shared&lt;OuterMenu&gt;(true, 1, maps.size());</a>
<a name="ln2225">    main_items-&gt;menu_id = &quot;map-main&quot;;</a>
<a name="ln2226">    main_items-&gt;set_margin_for_sdl(15, 0);</a>
<a name="ln2227">    main_items-&gt;set_margin_for_crt(1, 0);</a>
<a name="ln2228">    vbox-&gt;add_child(main_items);</a>
<a name="ln2229"> </a>
<a name="ln2230">    auto sub_items = make_shared&lt;OuterMenu&gt;(false, 2, 2);</a>
<a name="ln2231">    sub_items-&gt;menu_id = &quot;map-sub&quot;;</a>
<a name="ln2232">    vbox-&gt;add_child(sub_items);</a>
<a name="ln2233"> </a>
<a name="ln2234">    main_items-&gt;linked_menus[2] = sub_items;</a>
<a name="ln2235">    sub_items-&gt;linked_menus[0] = main_items;</a>
<a name="ln2236"> </a>
<a name="ln2237">    sort(maps.begin(), maps.end(), _cmp_map_by_order);</a>
<a name="ln2238">    _construct_gamemode_map_menu(maps, defaults, main_items, sub_items);</a>
<a name="ln2239"> </a>
<a name="ln2240">    bool done = false, cancel = false;</a>
<a name="ln2241"> </a>
<a name="ln2242">    vbox-&gt;on_activate_event([&amp;](const ActivateEvent&amp; event) {</a>
<a name="ln2243">        const auto button = static_pointer_cast&lt;MenuButton&gt;(event.target());</a>
<a name="ln2244">        const auto id = button-&gt;id;</a>
<a name="ln2245">        switch (id)</a>
<a name="ln2246">        {</a>
<a name="ln2247">            case M_ABORT:</a>
<a name="ln2248">                // TODO: fix</a>
<a name="ln2249">                break;</a>
<a name="ln2250">            case M_APTITUDES:</a>
<a name="ln2251">                show_help('%', _highlight_pattern(ng));</a>
<a name="ln2252">                return true;</a>
<a name="ln2253">            case M_HELP:</a>
<a name="ln2254">                ASSERT(ng_choice.type == GAME_TYPE_SPRINT);</a>
<a name="ln2255">                show_help('6');</a>
<a name="ln2256">                return true;</a>
<a name="ln2257">            case M_DEFAULT_CHOICE:</a>
<a name="ln2258">                _set_default_choice(ng, ng_choice, defaults);</a>
<a name="ln2259">                break;</a>
<a name="ln2260">            case M_RANDOM:</a>
<a name="ln2261">                // FIXME setting this to &quot;random&quot; is broken</a>
<a name="ln2262">                ng_choice.map.clear();</a>
<a name="ln2263">                break;</a>
<a name="ln2264">            default:</a>
<a name="ln2265">                // We got an item selection</a>
<a name="ln2266">                ng_choice.map = maps.at(id)-&gt;name;</a>
<a name="ln2267">                break;</a>
<a name="ln2268">        }</a>
<a name="ln2269">        return done = true;</a>
<a name="ln2270">    });</a>
<a name="ln2271"> </a>
<a name="ln2272">    auto popup = make_shared&lt;ui::Popup&gt;(vbox);</a>
<a name="ln2273">    popup-&gt;on_hotkey_event([&amp;](const KeyEvent&amp; ev) {</a>
<a name="ln2274">        switch (ev.key())</a>
<a name="ln2275">        {</a>
<a name="ln2276">            case 'X':</a>
<a name="ln2277">            case CONTROL('Q'):</a>
<a name="ln2278">#ifdef USE_TILE_WEB</a>
<a name="ln2279">                tiles.send_exit_reason(&quot;cancel&quot;);</a>
<a name="ln2280">#endif</a>
<a name="ln2281">                end(0);</a>
<a name="ln2282">                break;</a>
<a name="ln2283">            CASE_ESCAPE</a>
<a name="ln2284">                return done = cancel = true;</a>
<a name="ln2285">                break;</a>
<a name="ln2286">            case ' ':</a>
<a name="ln2287">                return done = true;</a>
<a name="ln2288">            default:</a>
<a name="ln2289">                break;</a>
<a name="ln2290">        }</a>
<a name="ln2291"> </a>
<a name="ln2292">        return false;</a>
<a name="ln2293">    });</a>
<a name="ln2294">#ifdef USE_TILE_WEB</a>
<a name="ln2295">    tiles.json_open_object();</a>
<a name="ln2296">    tiles.json_write_string(&quot;title&quot;, welcome.to_colour_string());</a>
<a name="ln2297">    main_items-&gt;serialize(&quot;main-items&quot;);</a>
<a name="ln2298">    sub_items-&gt;serialize(&quot;sub-items&quot;);</a>
<a name="ln2299">    tiles.push_ui_layout(&quot;newgame-choice&quot;, 1);</a>
<a name="ln2300">    popup-&gt;on_layout_pop([](){ tiles.pop_ui_layout(); });</a>
<a name="ln2301">#endif</a>
<a name="ln2302">    ui::run_layout(move(popup), done);</a>
<a name="ln2303"> </a>
<a name="ln2304">    if (cancel || crawl_state.seen_hups)</a>
<a name="ln2305">        game_ended(game_exit::abort);</a>
<a name="ln2306">}</a>
<a name="ln2307"> </a>
<a name="ln2308">static void _resolve_gamemode_map(newgame_def&amp; ng, const newgame_def&amp; ng_choice,</a>
<a name="ln2309">                                  const mapref_vector&amp; maps)</a>
<a name="ln2310">{</a>
<a name="ln2311">    if (ng_choice.map == &quot;random&quot; || ng_choice.map.empty())</a>
<a name="ln2312">        ng.map = maps[random2(maps.size())]-&gt;name;</a>
<a name="ln2313">    else</a>
<a name="ln2314">        ng.map = ng_choice.map;</a>
<a name="ln2315">}</a>
<a name="ln2316"> </a>
<a name="ln2317">static void _choose_gamemode_map(newgame_def&amp; ng, newgame_def&amp; ng_choice,</a>
<a name="ln2318">                                 const newgame_def&amp; defaults)</a>
<a name="ln2319">{</a>
<a name="ln2320">    // Sprint, otherwise Tutorial.</a>
<a name="ln2321">    const bool is_sprint = (ng_choice.type == GAME_TYPE_SPRINT);</a>
<a name="ln2322"> </a>
<a name="ln2323">    const string type_name = gametype_to_str(ng_choice.type);</a>
<a name="ln2324"> </a>
<a name="ln2325">    const mapref_vector maps = find_maps_for_tag(type_name);</a>
<a name="ln2326"> </a>
<a name="ln2327">    if (maps.empty())</a>
<a name="ln2328">        end(1, true, &quot;No %s maps found.&quot;, type_name.c_str());</a>
<a name="ln2329"> </a>
<a name="ln2330">    if (ng_choice.map.empty())</a>
<a name="ln2331">    {</a>
<a name="ln2332">        if (is_sprint</a>
<a name="ln2333">            &amp;&amp; ng_choice.type == !crawl_state.sprint_map.empty())</a>
<a name="ln2334">        {</a>
<a name="ln2335">            ng_choice.map = crawl_state.sprint_map;</a>
<a name="ln2336">        }</a>
<a name="ln2337">        else if (maps.size() &gt; 1)</a>
<a name="ln2338">            _prompt_gamemode_map(ng, ng_choice, defaults, maps);</a>
<a name="ln2339">        else</a>
<a name="ln2340">            ng_choice.map = maps[0]-&gt;name;</a>
<a name="ln2341">    }</a>
<a name="ln2342"> </a>
<a name="ln2343">    _resolve_gamemode_map(ng, ng_choice, maps);</a>
<a name="ln2344">}</a>

</code></pre>
<div class="balloon" rel="269"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v648/" target="_blank">V648</a> Priority of the '&&' operation is higher than that of the '||' operation. Consider inspecting the 'spfirst ||!jobfirst && coinflip()' expression.</p></div>
<div class="balloon" rel="322"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v768/" target="_blank">V768</a> The expression 'job_allowed(ng.species, ng.job)' is of enum type. It is odd that it is used as an expression of a Boolean-type.</p></div>
<div class="balloon" rel="1003"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v768/" target="_blank">V768</a> The expression 'job_allowed(ng.species, ng.job)' is of enum type. It is odd that it is used as an expression of a Boolean-type.</p></div>
<div class="balloon" rel="2333"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v562/" target="_blank">V562</a> It's odd to compare a bool type value with a value of 4.</p></div>
<div class="balloon" rel="2333"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v560/" target="_blank">V560</a> A part of conditional expression is always false.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
