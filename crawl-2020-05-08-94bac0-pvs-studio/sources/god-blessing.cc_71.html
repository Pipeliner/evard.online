
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=US-ASCII" />
  <title>god-blessing.cc</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">/**</a>
<a name="ln2"> * @file</a>
<a name="ln3"> * @brief Functions for gods blessing followers.</a>
<a name="ln4"> **/</a>
<a name="ln5"> </a>
<a name="ln6">#include &quot;AppHdr.h&quot;</a>
<a name="ln7"> </a>
<a name="ln8">#include &quot;god-blessing.h&quot;</a>
<a name="ln9"> </a>
<a name="ln10">#include &quot;artefact.h&quot;</a>
<a name="ln11">#include &quot;env.h&quot;</a>
<a name="ln12">#include &quot;item-prop.h&quot;</a>
<a name="ln13">#include &quot;item-status-flag-type.h&quot;</a>
<a name="ln14">#include &quot;items.h&quot;</a>
<a name="ln15">#include &quot;item-use.h&quot;</a>
<a name="ln16">#include &quot;makeitem.h&quot;</a>
<a name="ln17">#include &quot;message.h&quot;</a>
<a name="ln18">#include &quot;mon-gear.h&quot;</a>
<a name="ln19">#include &quot;mon-place.h&quot;</a>
<a name="ln20">#include &quot;religion.h&quot;</a>
<a name="ln21">#include &quot;stringutil.h&quot;</a>
<a name="ln22">#include &quot;view.h&quot;</a>
<a name="ln23"> </a>
<a name="ln24">/**</a>
<a name="ln25"> * Given the weapon type, find an upgrade.</a>
<a name="ln26"> *</a>
<a name="ln27"> * @param old_type the current weapon_type of the weapon.</a>
<a name="ln28"> * @param has_shield whether we can go from 1h -&gt; 2h.</a>
<a name="ln29"> * @param highlevel whether the orc is a strong type.</a>
<a name="ln30"> * @returns a new weapon type (or sometimes the old one).</a>
<a name="ln31"> */</a>
<a name="ln32">// TODO: a less awful way of doing this?</a>
<a name="ln33">static int _upgrade_weapon_type(int old_type, bool has_shield, bool highlevel)</a>
<a name="ln34">{</a>
<a name="ln35">    switch (old_type)</a>
<a name="ln36">    {</a>
<a name="ln37">        case WPN_CLUB:</a>
<a name="ln38">        case WPN_WHIP:</a>
<a name="ln39">        case WPN_MACE:        return WPN_FLAIL;</a>
<a name="ln40">        case WPN_FLAIL:       return WPN_MORNINGSTAR;</a>
<a name="ln41">        case WPN_MORNINGSTAR: return !has_shield ? WPN_DIRE_FLAIL  :</a>
<a name="ln42">                                     highlevel   ? WPN_EVENINGSTAR :</a>
<a name="ln43">                                                   WPN_MORNINGSTAR;</a>
<a name="ln44">        case WPN_DIRE_FLAIL:  return WPN_GREAT_MACE;</a>
<a name="ln45"> </a>
<a name="ln46">        case WPN_DAGGER:      return WPN_FALCHION;</a>
<a name="ln47">        case WPN_SHORT_SWORD: return WPN_LONG_SWORD;</a>
<a name="ln48">        case WPN_RAPIER:      return WPN_SCIMITAR;</a>
<a name="ln49">        case WPN_FALCHION:    return WPN_LONG_SWORD;</a>
<a name="ln50">        case WPN_LONG_SWORD:  return WPN_SCIMITAR;</a>
<a name="ln51">        case WPN_SCIMITAR:    return !has_shield ? WPN_GREAT_SWORD   :</a>
<a name="ln52">                                     highlevel   ? WPN_DOUBLE_SWORD :</a>
<a name="ln53">                                                   WPN_SCIMITAR;</a>
<a name="ln54">        case WPN_GREAT_SWORD: return highlevel ? WPN_TRIPLE_SWORD :</a>
<a name="ln55">                                                 WPN_GREAT_SWORD;</a>
<a name="ln56"> </a>
<a name="ln57">        case WPN_HAND_AXE:    return WPN_WAR_AXE;</a>
<a name="ln58">            // Low level orcs shouldn't get fairly rare items.</a>
<a name="ln59">        case WPN_WAR_AXE:     return !highlevel  ? WPN_WAR_AXE   :</a>
<a name="ln60">                                     has_shield  ? WPN_BROAD_AXE :</a>
<a name="ln61">                                                   WPN_BATTLEAXE;</a>
<a name="ln62">        case WPN_BATTLEAXE:   return highlevel ? WPN_EXECUTIONERS_AXE :</a>
<a name="ln63">                                                 WPN_BATTLEAXE;</a>
<a name="ln64"> </a>
<a name="ln65">        case WPN_SPEAR:       return WPN_TRIDENT;</a>
<a name="ln66">        case WPN_TRIDENT:     return has_shield ? WPN_TRIDENT : WPN_HALBERD;</a>
<a name="ln67">        case WPN_HALBERD:     return WPN_GLAIVE;</a>
<a name="ln68">        case WPN_GLAIVE:      return highlevel ? WPN_BARDICHE : WPN_GLAIVE;</a>
<a name="ln69"> </a>
<a name="ln70">        case WPN_HUNTING_SLING: return WPN_FUSTIBALUS;</a>
<a name="ln71">        case WPN_HAND_CROSSBOW: return !has_shield ? WPN_ARBALEST :</a>
<a name="ln72">                                                     WPN_HAND_CROSSBOW;</a>
<a name="ln73">        case WPN_ARBALEST:      return highlevel ? WPN_TRIPLE_CROSSBOW :</a>
<a name="ln74">                                                   WPN_ARBALEST;</a>
<a name="ln75">        case WPN_SHORTBOW:      return highlevel ? WPN_LONGBOW : WPN_SHORTBOW;</a>
<a name="ln76"> </a>
<a name="ln77">        default:              return old_type;</a>
<a name="ln78">    }</a>
<a name="ln79">}</a>
<a name="ln80"> </a>
<a name="ln81">/**</a>
<a name="ln82"> * Try to upgrade an orc's melee weapon or launcher.</a>
<a name="ln83"> *</a>
<a name="ln84"> * @param mon The owner of the weapon.</a>
<a name="ln85"> * @param wpn The weapon to upgrade.</a>
<a name="ln86"> * @returns True if the weapon was upgraded.</a>
<a name="ln87"> */</a>
<a name="ln88">static bool _upgrade_orc_weapon(monster* mon, item_def&amp; wpn)</a>
<a name="ln89">{</a>
<a name="ln90">    const int old_weapon_type = wpn.sub_type;</a>
<a name="ln91"> </a>
<a name="ln92">    // lower chance of upgrading to very good weapon types</a>
<a name="ln93">    bool highlevel_ok = mon-&gt;type == MONS_ORC_KNIGHT &amp;&amp; one_chance_in(6)</a>
<a name="ln94">                        || mon-&gt;type == MONS_ORC_WARLORD &amp;&amp; one_chance_in(3);</a>
<a name="ln95"> </a>
<a name="ln96">    wpn.sub_type = _upgrade_weapon_type(wpn.sub_type,</a>
<a name="ln97">                                        mon-&gt;inv[MSLOT_SHIELD] != NON_ITEM,</a>
<a name="ln98">                                        highlevel_ok);</a>
<a name="ln99"> </a>
<a name="ln100">    return wpn.sub_type != old_weapon_type;</a>
<a name="ln101">}</a>
<a name="ln102"> </a>
<a name="ln103">/**</a>
<a name="ln104"> * Get a weapon for beogh to gift to a weaponless orc.</a>
<a name="ln105"> *</a>
<a name="ln106"> * Tries to give something decent, but worse than player gifts.</a>
<a name="ln107"> *</a>
<a name="ln108"> * @param[in] mon_type   The type of orc to gift to.</a>
<a name="ln109"> * @return               A weapon type to gift.</a>
<a name="ln110"> */</a>
<a name="ln111">static int _orc_weapon_gift_type(monster_type mon_type)</a>
<a name="ln112">{</a>
<a name="ln113">    switch (mon_type)</a>
<a name="ln114">    {</a>
<a name="ln115">        case MONS_ORC:</a>
<a name="ln116">        case MONS_ORC_WIZARD:</a>
<a name="ln117">        case MONS_ORC_PRIEST:</a>
<a name="ln118">        case MONS_ORC_HIGH_PRIEST:</a>
<a name="ln119">        case MONS_ORC_SORCERER:</a>
<a name="ln120">            return random_choose_weighted(2, WPN_HAND_AXE, // orcs love axes</a>
<a name="ln121">                                          1, WPN_SHORT_SWORD,</a>
<a name="ln122">                                          1, WPN_MACE);</a>
<a name="ln123">        case MONS_ORC_WARRIOR:</a>
<a name="ln124">        case MONS_ORC_KNIGHT:</a>
<a name="ln125">        case MONS_ORC_WARLORD:</a>
<a name="ln126">            return random_choose_weighted(2, WPN_WAR_AXE, // orcs love axes</a>
<a name="ln127">                                          1, WPN_LONG_SWORD,</a>
<a name="ln128">                                          1, WPN_FLAIL,</a>
<a name="ln129">                                          1, WPN_SPEAR);</a>
<a name="ln130">            // give a lower tier of polearms; reaching is good on followers</a>
<a name="ln131">        default:</a>
<a name="ln132">            return WPN_CLUB; // shouldn't ever come up?</a>
<a name="ln133">    }</a>
<a name="ln134">}</a>
<a name="ln135"> </a>
<a name="ln136">/**</a>
<a name="ln137"> * Give a weapon to an orc that doesn't have one.</a>
<a name="ln138"> *</a>
<a name="ln139"> * @param[in] orc    The orc to give a weapon to.</a>
<a name="ln140"> * @param weapon_type  What weapon type to give the orc.</a>
<a name="ln141"> */</a>
<a name="ln142">static void _gift_weapon_to_orc(monster* orc, int weapon_type)</a>
<a name="ln143">{</a>
<a name="ln144">    ASSERT(weapon_type != NUM_WEAPONS);</a>
<a name="ln145"> </a>
<a name="ln146">    item_def weapon;</a>
<a name="ln147">    weapon.base_type = OBJ_WEAPONS;</a>
<a name="ln148">    weapon.sub_type = weapon_type;</a>
<a name="ln149">    weapon.quantity = 1;</a>
<a name="ln150">    set_ident_flags(weapon, ISFLAG_IDENT_MASK);</a>
<a name="ln151">    give_specific_item(orc, weapon);</a>
<a name="ln152">}</a>
<a name="ln153"> </a>
<a name="ln154">/**</a>
<a name="ln155"> * Attempt to give a follower appropriate ammo.</a>
<a name="ln156"> *</a>
<a name="ln157"> * @param[in] orc               The orc to give ammo to.</a>
<a name="ln158"> * @param[in] initial_gift      Whether this is starting ammo or a restock.</a>
<a name="ln159"> * (Give more ammo when restocking than initially.)</a>
<a name="ln160"> */</a>
<a name="ln161">void gift_ammo_to_orc(monster* orc, bool initial_gift)</a>
<a name="ln162">{</a>
<a name="ln163">    const item_def* launcher = orc-&gt;launcher();</a>
<a name="ln164"> </a>
<a name="ln165">    item_def ammo;</a>
<a name="ln166">    ammo.base_type = OBJ_MISSILES;</a>
<a name="ln167"> </a>
<a name="ln168">    if (!launcher)</a>
<a name="ln169">        ammo.sub_type = MI_BOOMERANG;</a>
<a name="ln170">    else</a>
<a name="ln171">        ammo.sub_type = fires_ammo_type(*launcher);</a>
<a name="ln172"> </a>
<a name="ln173">    if (ammo.sub_type == MI_STONE)</a>
<a name="ln174">        ammo.sub_type = MI_SLING_BULLET; // ugly special case</a>
<a name="ln175"> </a>
<a name="ln176">    ammo.quantity = 30 + random2(10);</a>
<a name="ln177">    if (initial_gift || !launcher)</a>
<a name="ln178">        ammo.quantity /= 2;</a>
<a name="ln179"> </a>
<a name="ln180">    const item_def* old_ammo = orc-&gt;missiles();</a>
<a name="ln181">    // don't give a drop message - it'd come before the bless message</a>
<a name="ln182">    if (old_ammo &amp;&amp; !items_stack(*old_ammo, ammo) &amp;&amp;</a>
<a name="ln183">        !orc-&gt;drop_item(MSLOT_MISSILE, false))</a>
<a name="ln184">    {</a>
<a name="ln185">        return; // can't force them to drop the ammo, for some reason?</a>
<a name="ln186">    }</a>
<a name="ln187"> </a>
<a name="ln188">    set_ident_flags(ammo, ISFLAG_IDENT_MASK);</a>
<a name="ln189"> </a>
<a name="ln190">    give_specific_item(orc, ammo);</a>
<a name="ln191">}</a>
<a name="ln192"> </a>
<a name="ln193">/**</a>
<a name="ln194"> * Attempt to bless a follower's melee weapon.</a>
<a name="ln195"> *</a>
<a name="ln196"> * @param[in] mon      The follower whose weapon should be blessed.</a>
<a name="ln197"> * @return             The type of blessing given; may be empty.</a>
<a name="ln198"> */</a>
<a name="ln199">static string _beogh_bless_melee_weapon(monster* mon)</a>
<a name="ln200">{</a>
<a name="ln201">    bool blessed = false;</a>
<a name="ln202">    item_def* wpn_ptr = mon-&gt;melee_weapon();</a>
<a name="ln203">    ASSERT(wpn_ptr != nullptr);</a>
<a name="ln204">    item_def&amp; wpn = *wpn_ptr;</a>
<a name="ln205"> </a>
<a name="ln206">    // 50% chance of upgrading weapon type.</a>
<a name="ln207">    if (!is_artefact(wpn)</a>
<a name="ln208">        &amp;&amp; coinflip()</a>
<a name="ln209">        &amp;&amp; _upgrade_orc_weapon(mon, wpn))</a>
<a name="ln210">    {</a>
<a name="ln211">        blessed = true;</a>
<a name="ln212">    }</a>
<a name="ln213">    // Enchant and uncurse it. (Lower odds at high weapon enchantment.)</a>
<a name="ln214">    if (!x_chance_in_y(wpn.plus, MAX_WPN_ENCHANT)</a>
<a name="ln215">        &amp;&amp; enchant_weapon(wpn, true))</a>
<a name="ln216">    {</a>
<a name="ln217">        set_ident_flags(wpn, ISFLAG_KNOW_PLUSES);</a>
<a name="ln218">        blessed = true;</a>
<a name="ln219">    }</a>
<a name="ln220">    if (wpn.cursed())</a>
<a name="ln221">    {</a>
<a name="ln222">        do_uncurse_item(wpn);</a>
<a name="ln223">        if (!blessed)</a>
<a name="ln224">            return &quot;uncursed armament&quot;;</a>
<a name="ln225">    }</a>
<a name="ln226"> </a>
<a name="ln227">    if (!blessed)</a>
<a name="ln228">    {</a>
<a name="ln229">        dprf(&quot;Couldn't bless follower's weapon!&quot;);</a>
<a name="ln230">        return &quot;&quot;;</a>
<a name="ln231">    }</a>
<a name="ln232"> </a>
<a name="ln233">    item_set_appearance(wpn);</a>
<a name="ln234">    return &quot;superior armament&quot;;</a>
<a name="ln235">}</a>
<a name="ln236"> </a>
<a name="ln237">/**</a>
<a name="ln238"> * Attempt to give a follower a ranged weapon/ammo.</a>
<a name="ln239"> *</a>
<a name="ln240"> * @param[in] mon      The follower who should be blessed.</a>
<a name="ln241"> * @return             The type of blessing given; may be empty.</a>
<a name="ln242"> */</a>
<a name="ln243">static string _beogh_bless_ranged_weapon(monster* mon)</a>
<a name="ln244">{</a>
<a name="ln245">    bool blessed = false;</a>
<a name="ln246">    const bool mon_has_launcher = mon-&gt;launcher() != nullptr;</a>
<a name="ln247"> </a>
<a name="ln248">    if (mon_has_launcher)</a>
<a name="ln249">    {</a>
<a name="ln250">        item_def&amp; launcher = *mon-&gt;launcher();</a>
<a name="ln251"> </a>
<a name="ln252">        // 50% chance of upgrading weapon type.</a>
<a name="ln253">        if (!is_artefact(launcher)</a>
<a name="ln254">            &amp;&amp; coinflip()</a>
<a name="ln255">            &amp;&amp; _upgrade_orc_weapon(mon, launcher))</a>
<a name="ln256">        {</a>
<a name="ln257">           blessed = true;</a>
<a name="ln258">        }</a>
<a name="ln259">        // Enchant and uncurse it. (Lower odds at high weapon enchantment.)</a>
<a name="ln260">        if (!x_chance_in_y(launcher.plus, MAX_WPN_ENCHANT)</a>
<a name="ln261">            &amp;&amp; enchant_weapon(launcher, true))</a>
<a name="ln262">        {</a>
<a name="ln263">            set_ident_flags(launcher, ISFLAG_KNOW_PLUSES);</a>
<a name="ln264">            blessed = true;</a>
<a name="ln265">        }</a>
<a name="ln266">        if (launcher.cursed())</a>
<a name="ln267">        {</a>
<a name="ln268">            do_uncurse_item(launcher);</a>
<a name="ln269">            if (!blessed)</a>
<a name="ln270">                return &quot;uncursed armament&quot;;</a>
<a name="ln271">        }</a>
<a name="ln272"> </a>
<a name="ln273">        // Otherwise gift ammunition.</a>
<a name="ln274">        if (!blessed)</a>
<a name="ln275">        {</a>
<a name="ln276">            gift_ammo_to_orc(mon);</a>
<a name="ln277">            if (mon-&gt;missiles() != nullptr)</a>
<a name="ln278">                return &quot;ammunition&quot;;</a>
<a name="ln279"> </a>
<a name="ln280">            dprf(&quot;Couldn't give ammo to follower!&quot;);</a>
<a name="ln281">            return &quot;&quot;; // ?</a>
<a name="ln282">        }</a>
<a name="ln283">        else</a>
<a name="ln284">        {</a>
<a name="ln285">            item_set_appearance(launcher);</a>
<a name="ln286">            return &quot;superior armament&quot;;</a>
<a name="ln287">        }</a>
<a name="ln288">    }</a>
<a name="ln289"> </a>
<a name="ln290">    // If they have a shield but no launcher, give boomerangs.</a>
<a name="ln291">    if (mon-&gt;shield() != nullptr)</a>
<a name="ln292">    {</a>
<a name="ln293">        gift_ammo_to_orc(mon);</a>
<a name="ln294">        if (mon-&gt;missiles() != nullptr)</a>
<a name="ln295">            return &quot;ranged armament&quot;;</a>
<a name="ln296"> </a>
<a name="ln297">        dprf(&quot;Couldn't give ammo to follower!&quot;);</a>
<a name="ln298">        return &quot;&quot;; // ?</a>
<a name="ln299">    }</a>
<a name="ln300"> </a>
<a name="ln301">    // No launcher, no shield: give them a crossbow &amp; some ammo.</a>
<a name="ln302">    _gift_weapon_to_orc(mon, WPN_ARBALEST);</a>
<a name="ln303">    if (mon-&gt;launcher() == nullptr)</a>
<a name="ln304">    {</a>
<a name="ln305">        dprf(&quot;Couldn't give crossbow to follower!&quot;);</a>
<a name="ln306">        return &quot;&quot;; // ?</a>
<a name="ln307">    }</a>
<a name="ln308"> </a>
<a name="ln309">    gift_ammo_to_orc(mon, true);</a>
<a name="ln310">    if (mon-&gt;missiles() == nullptr)</a>
<a name="ln311">        dprf(&quot;Couldn't give initial ammo to follower&quot;);</a>
<a name="ln312">    return &quot;ranged armament&quot;;</a>
<a name="ln313">}</a>
<a name="ln314"> </a>
<a name="ln315">/**</a>
<a name="ln316"> * Attempt to bless a follower's weapon.</a>
<a name="ln317"> *</a>
<a name="ln318"> * @param[in] mon      The follower whose weapon should be blessed.</a>
<a name="ln319"> * @return             The type of blessing given; may be empty.</a>
<a name="ln320"> */</a>
<a name="ln321">static string _beogh_bless_weapon(monster* mon)</a>
<a name="ln322">{</a>
<a name="ln323">    const item_def* wpn_ptr = mon-&gt;melee_weapon();</a>
<a name="ln324">    if (wpn_ptr == nullptr)</a>
<a name="ln325">    {</a>
<a name="ln326">        _gift_weapon_to_orc(mon, _orc_weapon_gift_type(mon-&gt;type));</a>
<a name="ln327">        if (mon-&gt;weapon() != nullptr)</a>
<a name="ln328">            return &quot;armament&quot;;</a>
<a name="ln329"> </a>
<a name="ln330">        dprf(&quot;Couldn't give a weapon to follower!&quot;);</a>
<a name="ln331">        return &quot;&quot;; // ?</a>
<a name="ln332">    }</a>
<a name="ln333"> </a>
<a name="ln334">    const item_def* launch_ptr = mon-&gt;launcher();</a>
<a name="ln335">    const item_def* ammo_ptr = mon-&gt;missiles();</a>
<a name="ln336">    if (launch_ptr != nullptr &amp;&amp; ammo_ptr == nullptr)</a>
<a name="ln337">    {</a>
<a name="ln338">        gift_ammo_to_orc(mon);</a>
<a name="ln339">        if (mon-&gt;missiles() != nullptr)</a>
<a name="ln340">            return &quot;ammunition&quot;;</a>
<a name="ln341"> </a>
<a name="ln342">        dprf(&quot;Couldn't give ammo to follower!&quot;);</a>
<a name="ln343">        return &quot;&quot;; // ?</a>
<a name="ln344">    }</a>
<a name="ln345"> </a>
<a name="ln346">    if (coinflip())</a>
<a name="ln347">        return _beogh_bless_melee_weapon(mon);</a>
<a name="ln348">    return _beogh_bless_ranged_weapon(mon);</a>
<a name="ln349">}</a>
<a name="ln350"> </a>
<a name="ln351">static void _upgrade_shield(item_def &amp;sh)</a>
<a name="ln352">{</a>
<a name="ln353">    // Promote from buckler up through tower shield.</a>
<a name="ln354">    if (sh.sub_type &gt;= ARM_FIRST_SHIELD &amp;&amp; sh.sub_type &lt; ARM_LAST_SHIELD)</a>
<a name="ln355">        sh.sub_type++;</a>
<a name="ln356">}</a>
<a name="ln357"> </a>
<a name="ln358">static void _upgrade_body_armour(item_def &amp;arm)</a>
<a name="ln359">{</a>
<a name="ln360">    const auto type = static_cast&lt;armour_type&gt;(arm.sub_type);</a>
<a name="ln361"> </a>
<a name="ln362">    // Promote from robe up through plate.</a>
<a name="ln363">    if (type &gt;= ARM_FIRST_MUNDANE_BODY &amp;&amp; type &lt; ARM_LAST_MUNDANE_BODY</a>
<a name="ln364">        // These are supposed to be robe-only.</a>
<a name="ln365">        &amp;&amp; arm.brand != SPARM_ARCHMAGI</a>
<a name="ln366">        &amp;&amp; arm.brand != SPARM_RESISTANCE)</a>
<a name="ln367">    {</a>
<a name="ln368">        arm.sub_type++;</a>
<a name="ln369">    }</a>
<a name="ln370">}</a>
<a name="ln371"> </a>
<a name="ln372">/**</a>
<a name="ln373"> * Give armour (a shield or body armour) to an orc that doesn't have one.</a>
<a name="ln374"> *</a>
<a name="ln375"> * @param[in] orc       The orc to give armour to.</a>
<a name="ln376"> * @param[in] shield    Whether to give a shield (default is body armour)</a>
<a name="ln377"> */</a>
<a name="ln378">static void _gift_armour_to_orc(monster* orc, bool shield = false)</a>
<a name="ln379">{</a>
<a name="ln380">    const bool highlevel = orc-&gt;type == MONS_ORC_KNIGHT</a>
<a name="ln381">                           || orc-&gt;type == MONS_ORC_WARLORD;</a>
<a name="ln382"> </a>
<a name="ln383">    item_def armour;</a>
<a name="ln384">    armour.base_type = OBJ_ARMOUR;</a>
<a name="ln385">    if (shield)</a>
<a name="ln386">        armour.sub_type = highlevel ? ARM_KITE_SHIELD : ARM_BUCKLER;</a>
<a name="ln387">    else</a>
<a name="ln388">        armour.sub_type = highlevel ? ARM_SCALE_MAIL : ARM_RING_MAIL;</a>
<a name="ln389">    armour.quantity = 1;</a>
<a name="ln390">    set_ident_flags(armour, ISFLAG_IDENT_MASK);</a>
<a name="ln391">    give_specific_item(orc, armour);</a>
<a name="ln392">}</a>
<a name="ln393"> </a>
<a name="ln394">/**</a>
<a name="ln395"> * Attempt to bless a follower's armour.</a>
<a name="ln396"> *</a>
<a name="ln397"> * @param[in] mon           The follower whose armour should be blessed.</a>
<a name="ln398"> * @return                  The type of blessing; may be empty.</a>
<a name="ln399"> */</a>
<a name="ln400">static string _beogh_bless_armour(monster* mon)</a>
<a name="ln401">{</a>
<a name="ln402">    const int armour = mon-&gt;inv[MSLOT_ARMOUR];</a>
<a name="ln403">    const int shield = mon-&gt;inv[MSLOT_SHIELD];</a>
<a name="ln404"> </a>
<a name="ln405">    // always give naked orcs armour, if possible</a>
<a name="ln406">    if (armour == NON_ITEM)</a>
<a name="ln407">    {</a>
<a name="ln408">        _gift_armour_to_orc(mon);</a>
<a name="ln409">        if (mon-&gt;inv[MSLOT_ARMOUR] != NON_ITEM)</a>
<a name="ln410">            return &quot;armour&quot;;</a>
<a name="ln411">        dprf(&quot;Couldn't give armour to an orc!&quot;); //?</a>
<a name="ln412">        return &quot;&quot;;</a>
<a name="ln413">    }</a>
<a name="ln414"> </a>
<a name="ln415">    // Pick either a monster's armour or its shield.</a>
<a name="ln416">    const item_def* melee_weap = mon-&gt;melee_weapon();</a>
<a name="ln417">    const item_def* launcher = mon-&gt;launcher();</a>
<a name="ln418">    const bool can_use_shield = (melee_weap == nullptr</a>
<a name="ln419">                                 || mon-&gt;hands_reqd(*melee_weap) != HANDS_TWO)</a>
<a name="ln420">                                &amp;&amp; (launcher == nullptr</a>
<a name="ln421">                                   || mon-&gt;hands_reqd(*launcher) != HANDS_TWO);</a>
<a name="ln422">    const int slot = coinflip() &amp;&amp; can_use_shield ? shield : armour;</a>
<a name="ln423"> </a>
<a name="ln424">    if (slot == NON_ITEM)</a>
<a name="ln425">    {</a>
<a name="ln426">        ASSERT(slot == shield);</a>
<a name="ln427">        _gift_armour_to_orc(mon, true);</a>
<a name="ln428">        if (mon-&gt;inv[MSLOT_SHIELD] != NON_ITEM)</a>
<a name="ln429">            return &quot;a shield&quot;;</a>
<a name="ln430">        dprf(&quot;Couldn't give a shield to an orc!&quot;); //?</a>
<a name="ln431">        return &quot;&quot;;</a>
<a name="ln432">    }</a>
<a name="ln433"> </a>
<a name="ln434">    item_def&amp; arm(mitm[slot]);</a>
<a name="ln435"> </a>
<a name="ln436">    const int old_subtype = arm.sub_type;</a>
<a name="ln437">    // 50% chance of improving armour/shield type</a>
<a name="ln438">    if (!is_artefact(arm) &amp;&amp; coinflip())</a>
<a name="ln439">    {</a>
<a name="ln440">        if (slot == shield)</a>
<a name="ln441">            _upgrade_shield(arm);</a>
<a name="ln442">        else</a>
<a name="ln443">            _upgrade_body_armour(arm);</a>
<a name="ln444">    }</a>
<a name="ln445"> </a>
<a name="ln446">    // And enchant or uncurse it. (Lower chance for higher enchantment.)</a>
<a name="ln447">    int ac_change;</a>
<a name="ln448">    const bool enchanted = !x_chance_in_y(arm.plus, armour_max_enchant(arm))</a>
<a name="ln449">                           &amp;&amp; enchant_armour(ac_change, true, arm);</a>
<a name="ln450"> </a>
<a name="ln451">    if (enchanted)</a>
<a name="ln452">        set_ident_flags(arm, ISFLAG_KNOW_PLUSES);</a>
<a name="ln453"> </a>
<a name="ln454">    if (!enchanted &amp;&amp; old_subtype == arm.sub_type)</a>
<a name="ln455">    {</a>
<a name="ln456">        dprf(&quot;Couldn't enchant follower's armour!&quot;);</a>
<a name="ln457">        return &quot;&quot;;</a>
<a name="ln458">    }</a>
<a name="ln459"> </a>
<a name="ln460">    item_set_appearance(arm);</a>
<a name="ln461">    return &quot;improved armour&quot;;</a>
<a name="ln462">}</a>
<a name="ln463"> </a>
<a name="ln464">static bool _blessing_balms(monster* mon)</a>
<a name="ln465">{</a>
<a name="ln466">    // Remove poisoning, sickness and confusion, like a potion of</a>
<a name="ln467">    // curing, but without the healing. Also, remove slowing and</a>
<a name="ln468">    // fatigue.</a>
<a name="ln469">    bool success = false;</a>
<a name="ln470"> </a>
<a name="ln471">    if (mon-&gt;del_ench(ENCH_POISON, true))</a>
<a name="ln472">        success = true;</a>
<a name="ln473"> </a>
<a name="ln474">    if (mon-&gt;del_ench(ENCH_SICK, true))</a>
<a name="ln475">        success = true;</a>
<a name="ln476"> </a>
<a name="ln477">    if (mon-&gt;del_ench(ENCH_CONFUSION, true))</a>
<a name="ln478">        success = true;</a>
<a name="ln479"> </a>
<a name="ln480">    if (mon-&gt;del_ench(ENCH_SLOW, true))</a>
<a name="ln481">        success = true;</a>
<a name="ln482"> </a>
<a name="ln483">    if (mon-&gt;del_ench(ENCH_FATIGUE, true))</a>
<a name="ln484">        success = true;</a>
<a name="ln485"> </a>
<a name="ln486">    if (mon-&gt;del_ench(ENCH_WRETCHED, true))</a>
<a name="ln487">        success = true;</a>
<a name="ln488"> </a>
<a name="ln489">    return success;</a>
<a name="ln490">}</a>
<a name="ln491"> </a>
<a name="ln492">static bool _blessing_healing(monster* mon)</a>
<a name="ln493">{</a>
<a name="ln494">    const int healing = mon-&gt;max_hit_points / 4 + 1;</a>
<a name="ln495"> </a>
<a name="ln496">    // Heal a monster.</a>
<a name="ln497">    if (mon-&gt;heal(healing + random2(healing + 1)))</a>
<a name="ln498">    {</a>
<a name="ln499">        // A high-HP monster might get a unique name.</a>
<a name="ln500">        if (x_chance_in_y(mon-&gt;max_hit_points + 1, 100))</a>
<a name="ln501">            give_monster_proper_name(*mon);</a>
<a name="ln502">        return true;</a>
<a name="ln503">    }</a>
<a name="ln504"> </a>
<a name="ln505">    return false;</a>
<a name="ln506">}</a>
<a name="ln507"> </a>
<a name="ln508">static bool _increase_ench_duration(monster* mon,</a>
<a name="ln509">                                    mon_enchant ench,</a>
<a name="ln510">                                    const int increase)</a>
<a name="ln511">{</a>
<a name="ln512">    // Durations are saved as 16-bit signed ints, so clamp at the largest such.</a>
<a name="ln513">    const int MARSHALL_MAX = (1 &lt;&lt; 15) - 1;</a>
<a name="ln514"> </a>
<a name="ln515">    const int newdur = min(ench.duration + increase, MARSHALL_MAX);</a>
<a name="ln516">    if (ench.duration &gt;= newdur)</a>
<a name="ln517">        return false;</a>
<a name="ln518"> </a>
<a name="ln519">    ench.duration = newdur;</a>
<a name="ln520">    mon-&gt;update_ench(ench);</a>
<a name="ln521"> </a>
<a name="ln522">    return true;</a>
<a name="ln523">}</a>
<a name="ln524"> </a>
<a name="ln525">static bool _tso_blessing_extend_stay(monster* mon)</a>
<a name="ln526">{</a>
<a name="ln527">    if (!mon-&gt;has_ench(ENCH_ABJ))</a>
<a name="ln528">        return false;</a>
<a name="ln529"> </a>
<a name="ln530">    mon_enchant abj = mon-&gt;get_ench(ENCH_ABJ);</a>
<a name="ln531"> </a>
<a name="ln532">    // These numbers are tenths of a player turn. Holy monsters get a</a>
<a name="ln533">    // much bigger boost than random beasties, which get at most double</a>
<a name="ln534">    // their current summon duration.</a>
<a name="ln535">    if (mon-&gt;is_holy())</a>
<a name="ln536">        return _increase_ench_duration(mon, abj, 1100 + random2(1100));</a>
<a name="ln537">    else</a>
<a name="ln538">        return _increase_ench_duration(mon, abj, min(abj.duration,</a>
<a name="ln539">                                                     500 + random2(500)));</a>
<a name="ln540">}</a>
<a name="ln541"> </a>
<a name="ln542">static bool _tso_blessing_friendliness(monster* mon)</a>
<a name="ln543">{</a>
<a name="ln544">    if (!mon-&gt;has_ench(ENCH_CHARM))</a>
<a name="ln545">        return false;</a>
<a name="ln546"> </a>
<a name="ln547">    // [ds] Just increase charm duration, no permanent friendliness.</a>
<a name="ln548">    const int base_increase = 700;</a>
<a name="ln549">    return _increase_ench_duration(mon, mon-&gt;get_ench(ENCH_CHARM),</a>
<a name="ln550">                                   base_increase + random2(base_increase));</a>
<a name="ln551">}</a>
<a name="ln552"> </a>
<a name="ln553">static void _beogh_reinf_callback(const mgen_data &amp;mg, monster *&amp;mon, int placed)</a>
<a name="ln554">{</a>
<a name="ln555">    UNUSED(placed);</a>
<a name="ln556">    ASSERT(mg.god == GOD_BEOGH);</a>
<a name="ln557"> </a>
<a name="ln558">    // Beogh tries a second time to place reinforcements.</a>
<a name="ln559">    if (!mon)</a>
<a name="ln560">        mon = create_monster(mg);</a>
<a name="ln561"> </a>
<a name="ln562">    if (!mon)</a>
<a name="ln563">        return;</a>
<a name="ln564"> </a>
<a name="ln565">    mon-&gt;flags |= MF_ATT_CHANGE_ATTEMPT;</a>
<a name="ln566"> </a>
<a name="ln567">    bool high_level = (mon-&gt;type == MONS_ORC_PRIEST</a>
<a name="ln568">                       || mon-&gt;type == MONS_ORC_WARRIOR</a>
<a name="ln569">                       || mon-&gt;type == MONS_ORC_KNIGHT);</a>
<a name="ln570"> </a>
<a name="ln571">    // For high level orcs, there's a chance of being named.</a>
<a name="ln572">    if (high_level &amp;&amp; one_chance_in(5))</a>
<a name="ln573">        give_monster_proper_name(*mon);</a>
<a name="ln574">}</a>
<a name="ln575"> </a>
<a name="ln576">// If you don't currently have any followers, send a small band to help</a>
<a name="ln577">// you out.</a>
<a name="ln578">static void _beogh_blessing_reinforcements()</a>
<a name="ln579">{</a>
<a name="ln580">    // Don't gift orcs if Toxic radiance is up, to avoid the player being</a>
<a name="ln581">    // penanced through no fault of their own.</a>
<a name="ln582">    if (you.duration[DUR_TOXIC_RADIANCE])</a>
<a name="ln583">        return;</a>
<a name="ln584"> </a>
<a name="ln585">    // Possible reinforcement.</a>
<a name="ln586">    const monster_type followers[] =</a>
<a name="ln587">    {</a>
<a name="ln588">        MONS_ORC, MONS_ORC, MONS_ORC_WIZARD, MONS_ORC_PRIEST</a>
<a name="ln589">    };</a>
<a name="ln590"> </a>
<a name="ln591">    const monster_type high_xl_followers[] =</a>
<a name="ln592">    {</a>
<a name="ln593">        MONS_ORC_PRIEST, MONS_ORC_WARRIOR, MONS_ORC_KNIGHT</a>
<a name="ln594">    };</a>
<a name="ln595"> </a>
<a name="ln596">    // Send up to four followers.</a>
<a name="ln597">    int how_many = random2(4) + 1;</a>
<a name="ln598"> </a>
<a name="ln599">    monster_type follower_type;</a>
<a name="ln600">    for (int i = 0; i &lt; how_many; ++i)</a>
<a name="ln601">    {</a>
<a name="ln602">        if (random2(you.experience_level) &gt;= 9 &amp;&amp; coinflip())</a>
<a name="ln603">            follower_type = RANDOM_ELEMENT(high_xl_followers);</a>
<a name="ln604">        else</a>
<a name="ln605">            follower_type = RANDOM_ELEMENT(followers);</a>
<a name="ln606"> </a>
<a name="ln607">        delayed_monster(mgen_data(follower_type, BEH_FRIENDLY, you.pos(),</a>
<a name="ln608">                                   MHITYOU)</a>
<a name="ln609">                        .set_summoned(&amp;you, 0, 0, GOD_BEOGH),</a>
<a name="ln610">                        _beogh_reinf_callback);</a>
<a name="ln611">    }</a>
<a name="ln612">}</a>
<a name="ln613"> </a>
<a name="ln614">static bool _beogh_blessing_priesthood(monster* mon)</a>
<a name="ln615">{</a>
<a name="ln616">    if (mon-&gt;type != MONS_ORC)</a>
<a name="ln617">        return false;</a>
<a name="ln618"> </a>
<a name="ln619">    mon-&gt;upgrade_type(MONS_ORC_PRIEST, true, true);</a>
<a name="ln620">    return true;</a>
<a name="ln621">}</a>
<a name="ln622"> </a>
<a name="ln623">/**</a>
<a name="ln624"> * Attempt to bless a follower with curing and/or healing.</a>
<a name="ln625"> *</a>
<a name="ln626"> * @param[in] follower      The follower to heal.</a>
<a name="ln627"> * @return                  The type of healing that occurred; may be empty.</a>
<a name="ln628"> */</a>
<a name="ln629">static string _bless_with_healing(monster* follower)</a>
<a name="ln630">{</a>
<a name="ln631">    string blessing = &quot;&quot;;</a>
<a name="ln632"> </a>
<a name="ln633">    // Maybe try to cure status conditions.</a>
<a name="ln634">    bool balms = false;</a>
<a name="ln635">    if (coinflip())</a>
<a name="ln636">    {</a>
<a name="ln637">        balms = _blessing_balms(follower);</a>
<a name="ln638">        if (balms)</a>
<a name="ln639">            blessing = &quot;divine balms&quot;;</a>
<a name="ln640">        else</a>
<a name="ln641">            dprf(&quot;Couldn't apply balms.&quot;);</a>
<a name="ln642">    }</a>
<a name="ln643"> </a>
<a name="ln644">    // Heal the follower.</a>
<a name="ln645">    bool healing = _blessing_healing(follower);</a>
<a name="ln646"> </a>
<a name="ln647">    // Maybe heal the follower again.</a>
<a name="ln648">    if ((!healing || coinflip()) &amp;&amp; _blessing_healing(follower))</a>
<a name="ln649">        healing = true;</a>
<a name="ln650"> </a>
<a name="ln651">    if (healing)</a>
<a name="ln652">    {</a>
<a name="ln653">        if (balms)</a>
<a name="ln654">            blessing += &quot; and &quot;;</a>
<a name="ln655">        blessing += &quot;healing&quot;;</a>
<a name="ln656">    }</a>
<a name="ln657">    else</a>
<a name="ln658">        dprf(&quot;Couldn't heal monster.&quot;);</a>
<a name="ln659"> </a>
<a name="ln660">    return blessing;</a>
<a name="ln661">}</a>
<a name="ln662"> </a>
<a name="ln663"> </a>
<a name="ln664">/**</a>
<a name="ln665"> * Print a message for a god blessing a follower.</a>
<a name="ln666"> *</a>
<a name="ln667"> * Also flash the screen, in local tiles.</a>
<a name="ln668"> *</a>
<a name="ln669"> * @param[in] follower  The follower being blessed.</a>
<a name="ln670"> * @param god           The god doing the blessing.</a>
<a name="ln671"> * @param blessing      The blessing being delivered.</a>
<a name="ln672"> */</a>
<a name="ln673">static void _display_god_blessing(monster* follower, god_type god,</a>
<a name="ln674">                                  string blessing)</a>
<a name="ln675">{</a>
<a name="ln676">    ASSERT(follower); // XXX: change to monster &amp;follower</a>
<a name="ln677"> </a>
<a name="ln678">    string whom = you.can_see(*follower) ? follower-&gt;name(DESC_THE)</a>
<a name="ln679">    : &quot;a follower&quot;;</a>
<a name="ln680"> </a>
<a name="ln681">    simple_god_message(make_stringf(&quot; blesses %s with %s.&quot;,</a>
<a name="ln682">                                    whom.c_str(), blessing.c_str()).c_str(),</a>
<a name="ln683">                       god);</a>
<a name="ln684"> </a>
<a name="ln685">#ifndef USE_TILE_LOCAL</a>
<a name="ln686">    flash_monster_colour(follower, god_colour(god), 200);</a>
<a name="ln687">#endif</a>
<a name="ln688">}</a>
<a name="ln689"> </a>
<a name="ln690">/**</a>
<a name="ln691"> * Have Beogh attempt to bless the specified follower.</a>
<a name="ln692"> *</a>
<a name="ln693"> * If no follower is specified, there is a chance of sending reinforcements.</a>
<a name="ln694"> *</a>
<a name="ln695"> * @param[in] follower      The follower to try to bless.</a>
<a name="ln696"> * @param[in] force         Whether to check follower validity.</a>
<a name="ln697"> * @return Whether a blessing occurred.</a>
<a name="ln698"> */</a>
<a name="ln699">static bool _beogh_bless_follower(monster* follower, bool force)</a>
<a name="ln700">{</a>
<a name="ln701">    if (!follower)</a>
<a name="ln702">    {</a>
<a name="ln703">        // 1/20 chance of spawning a palband</a>
<a name="ln704">        if (!one_chance_in(5))</a>
<a name="ln705">            return false;</a>
<a name="ln706"> </a>
<a name="ln707">        // If no follower was found, attempt to send</a>
<a name="ln708">        // reinforcements.</a>
<a name="ln709">        _beogh_blessing_reinforcements();</a>
<a name="ln710"> </a>
<a name="ln711">        // Possibly send more reinforcements.</a>
<a name="ln712">        if (coinflip())</a>
<a name="ln713">            _beogh_blessing_reinforcements();</a>
<a name="ln714"> </a>
<a name="ln715">        delayed_monster_done(&quot;Beogh blesses you with reinforcements.&quot;);</a>
<a name="ln716"> </a>
<a name="ln717">        // Return true, even though the reinforcements might</a>
<a name="ln718">        // not be placed.</a>
<a name="ln719">        return true;</a>
<a name="ln720">    }</a>
<a name="ln721"> </a>
<a name="ln722">    string blessing = &quot;&quot;;</a>
<a name="ln723"> </a>
<a name="ln724">    // 10% chance of blessing to priesthood.</a>
<a name="ln725">    if (force || one_chance_in(10))</a>
<a name="ln726">    {</a>
<a name="ln727">        if (_beogh_blessing_priesthood(follower))</a>
<a name="ln728">            blessing = &quot;priesthood&quot;;</a>
<a name="ln729">        else</a>
<a name="ln730">            dprf(&quot;Couldn't promote monster to priesthood&quot;);</a>
<a name="ln731">    }</a>
<a name="ln732"> </a>
<a name="ln733">    // ~15% chance of blessing armament (assume that most priest buffs fail)</a>
<a name="ln734">    if (blessing.empty() &amp;&amp; mons_genus(follower-&gt;type) == MONS_ORC</a>
<a name="ln735">        &amp;&amp; (force || one_chance_in(7)))</a>
<a name="ln736">    {</a>
<a name="ln737">        blessing = coinflip() ? _beogh_bless_weapon(follower)</a>
<a name="ln738">                              : _beogh_bless_armour(follower);</a>
<a name="ln739">    }</a>
<a name="ln740"> </a>
<a name="ln741">    // If they got a good blessing (priesthood or equipment), maybe give them</a>
<a name="ln742">    // a name.</a>
<a name="ln743">    if (!blessing.empty())</a>
<a name="ln744">        give_monster_proper_name(*follower);</a>
<a name="ln745"> </a>
<a name="ln746">    // ~85% chance of trying to heal.</a>
<a name="ln747">    if (blessing.empty())</a>
<a name="ln748">        blessing = _bless_with_healing(follower);</a>
<a name="ln749"> </a>
<a name="ln750">    if (blessing.empty())</a>
<a name="ln751">        return false;</a>
<a name="ln752"> </a>
<a name="ln753">    _display_god_blessing(follower, GOD_BEOGH, blessing);</a>
<a name="ln754">    return true;</a>
<a name="ln755">}</a>
<a name="ln756"> </a>
<a name="ln757">/**</a>
<a name="ln758"> * Attempt to increase the duration of a follower.</a>
<a name="ln759"> *</a>
<a name="ln760"> * Their summon duration, if summoned, or charm duration, if charmed.</a>
<a name="ln761"> *</a>
<a name="ln762"> * @param[in] follower    The follower to bless.</a>
<a name="ln763"> * @return                The type of blessing that was given; may be empty.</a>
<a name="ln764"> */</a>
<a name="ln765">static string _tso_bless_duration(monster* follower)</a>
<a name="ln766">{</a>
<a name="ln767">    // Extend a monster's stay if it's abjurable, or extend charm</a>
<a name="ln768">    // duration. If neither is possible, deliberately fall through.</a>
<a name="ln769">    const bool more_time = _tso_blessing_extend_stay(follower);</a>
<a name="ln770">    const bool friendliness = _tso_blessing_friendliness(follower);</a>
<a name="ln771"> </a>
<a name="ln772">    if (!more_time &amp;&amp; !friendliness)</a>
<a name="ln773">    {</a>
<a name="ln774">        dprf(&quot;Couldn't increase monster's friendliness or summon time.&quot;);</a>
<a name="ln775">        return &quot;&quot;;</a>
<a name="ln776">    }</a>
<a name="ln777"> </a>
<a name="ln778">    string blessing = &quot;&quot;;</a>
<a name="ln779">    if (friendliness)</a>
<a name="ln780">    {</a>
<a name="ln781">        blessing += &quot;friendliness&quot;;</a>
<a name="ln782">        if (more_time)</a>
<a name="ln783">            blessing += &quot; and &quot;;</a>
<a name="ln784">    }</a>
<a name="ln785"> </a>
<a name="ln786">    if (more_time)</a>
<a name="ln787">        blessing += &quot;more time in this world&quot;;</a>
<a name="ln788"> </a>
<a name="ln789">    return blessing;</a>
<a name="ln790">}</a>
<a name="ln791"> </a>
<a name="ln792">/**</a>
<a name="ln793"> * Have The Shining One attempt to bless the specified follower.</a>
<a name="ln794"> *</a>
<a name="ln795"> * Blessings can increase duration, or heal &amp; cure.</a>
<a name="ln796"> *</a>
<a name="ln797"> * @param[in] follower      The follower to try to bless.</a>
<a name="ln798"> * @param[in] force         Whether to check follower validity.</a>
<a name="ln799"> * @return Whether a blessing occurred.</a>
<a name="ln800"> */</a>
<a name="ln801">static bool _tso_bless_follower(monster* follower, bool force)</a>
<a name="ln802">{</a>
<a name="ln803"> </a>
<a name="ln804">    if (!follower || (!force &amp;&amp; !is_follower(*follower)))</a>
<a name="ln805">        return false;</a>
<a name="ln806"> </a>
<a name="ln807">    string blessing = &quot;&quot;;</a>
<a name="ln808">    if (blessing.empty() &amp;&amp; coinflip())</a>
<a name="ln809">        blessing = _bless_with_healing(follower);</a>
<a name="ln810">    if (blessing.empty())</a>
<a name="ln811">        blessing = _tso_bless_duration(follower);</a>
<a name="ln812"> </a>
<a name="ln813">    if (blessing.empty())</a>
<a name="ln814">        return false;</a>
<a name="ln815"> </a>
<a name="ln816">    _display_god_blessing(follower, GOD_SHINING_ONE, blessing);</a>
<a name="ln817">    return true;</a>
<a name="ln818">}</a>
<a name="ln819"> </a>
<a name="ln820">static bool _is_friendly_follower(const monster&amp; mon)</a>
<a name="ln821">{</a>
<a name="ln822">    return mon.friendly() &amp;&amp; is_follower(mon);</a>
<a name="ln823">}</a>
<a name="ln824"> </a>
<a name="ln825">// Bless the follower indicated in follower, if any. If there isn't</a>
<a name="ln826">// one, bless a random follower within sight of the player, if any, or</a>
<a name="ln827">// any follower on the level.</a>
<a name="ln828">// Blessing can be enforced with a wizard mode command.</a>
<a name="ln829">bool bless_follower(monster* follower,</a>
<a name="ln830">                    god_type god,</a>
<a name="ln831">                    bool force)</a>
<a name="ln832">{</a>
<a name="ln833">    // most blessings fail, tragically...</a>
<a name="ln834">    if (!force &amp;&amp; !one_chance_in(4))</a>
<a name="ln835">        return false;</a>
<a name="ln836"> </a>
<a name="ln837">    // If a follower was specified, and it's suitable, pick it.</a>
<a name="ln838">    // Otherwise, pick a random follower.</a>
<a name="ln839">    // XXX: factor out into another function?</a>
<a name="ln840">    if (!follower || (!force &amp;&amp; !is_follower(*follower)))</a>
<a name="ln841">    {</a>
<a name="ln842">        // Choose a random follower in LOS, preferably a named or</a>
<a name="ln843">        // priestly one.</a>
<a name="ln844">        follower = choose_random_nearby_monster(0, _is_friendly_follower,</a>
<a name="ln845">                                                god == GOD_BEOGH);</a>
<a name="ln846">    }</a>
<a name="ln847"> </a>
<a name="ln848">    // Try *again*, on the entire level</a>
<a name="ln849">    if (!follower)</a>
<a name="ln850">    {</a>
<a name="ln851">        follower = choose_random_monster_on_level(0, _is_friendly_follower,</a>
<a name="ln852">                                                  god == GOD_BEOGH);</a>
<a name="ln853">    }</a>
<a name="ln854"> </a>
<a name="ln855">    switch (god)</a>
<a name="ln856">    {</a>
<a name="ln857">        case GOD_BEOGH: return _beogh_bless_follower(follower, force);</a>
<a name="ln858">        case GOD_SHINING_ONE:   return _tso_bless_follower(follower, force);</a>
<a name="ln859">        default: return false; // XXX: print something here?</a>
<a name="ln860">    }</a>
<a name="ln861">}</a>

</code></pre>
<div class="balloon" rel="808"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v560/" target="_blank">V560</a> A part of conditional expression is always true: blessing.empty().</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
