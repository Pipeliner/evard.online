
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=US-ASCII" />
  <title>tilepick-p.cc</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">#include &quot;AppHdr.h&quot;</a>
<a name="ln2"> </a>
<a name="ln3">#ifdef USE_TILE</a>
<a name="ln4">#include &quot;tilepick-p.h&quot;</a>
<a name="ln5"> </a>
<a name="ln6">#include &lt;cstdio&gt;</a>
<a name="ln7"> </a>
<a name="ln8">#include &quot;artefact.h&quot;</a>
<a name="ln9">#include &quot;describe.h&quot;</a>
<a name="ln10">#include &quot;item-name.h&quot;</a>
<a name="ln11">#include &quot;item-prop.h&quot;</a>
<a name="ln12">#include &quot;player.h&quot;</a>
<a name="ln13">#include &quot;tile-flags.h&quot;</a>
<a name="ln14">#include &quot;tile-player-flag-cut.h&quot;</a>
<a name="ln15">#include &quot;rltiles/tiledef-player.h&quot;</a>
<a name="ln16">#include &quot;rltiles/tiledef-unrand.h&quot;</a>
<a name="ln17">#include &quot;tiledoll.h&quot;</a>
<a name="ln18">#include &quot;tilepick.h&quot;</a>
<a name="ln19">#include &quot;transform.h&quot;</a>
<a name="ln20">#include &quot;traps.h&quot;</a>
<a name="ln21"> </a>
<a name="ln22">static tileidx_t _modrng(int mod, tileidx_t first, tileidx_t last)</a>
<a name="ln23">{</a>
<a name="ln24">    return first + mod % (last - first + 1);</a>
<a name="ln25">}</a>
<a name="ln26"> </a>
<a name="ln27">static tileidx_t _mon_mod(tileidx_t tile, int offset)</a>
<a name="ln28">{</a>
<a name="ln29">    int count = tile_player_count(tile);</a>
<a name="ln30">    return tile + offset % count;</a>
<a name="ln31">}</a>
<a name="ln32"> </a>
<a name="ln33">tileidx_t tilep_equ_weapon(const item_def &amp;item)</a>
<a name="ln34">{</a>
<a name="ln35">    if (item.props.exists(&quot;worn_tile&quot;))</a>
<a name="ln36">        return item.props[&quot;worn_tile&quot;].get_short();</a>
<a name="ln37"> </a>
<a name="ln38">    if (item.base_type == OBJ_STAVES)</a>
<a name="ln39">    {</a>
<a name="ln40">        int orig_special = you.item_description[IDESC_STAVES][item.sub_type];</a>
<a name="ln41">        int desc = (orig_special / NDSC_STAVE_PRI) % NDSC_STAVE_SEC;</a>
<a name="ln42">        return TILEP_HAND1_STAFF_LARGE + desc;</a>
<a name="ln43">    }</a>
<a name="ln44"> </a>
<a name="ln45">#if TAG_MAJOR_VERSION == 34</a>
<a name="ln46">    if (item.base_type == OBJ_RODS)</a>
<a name="ln47">        return _mon_mod(TILEP_HAND1_ROD_FIRST, item.rnd);</a>
<a name="ln48">#endif</a>
<a name="ln49"> </a>
<a name="ln50">    if (item.base_type == OBJ_MISCELLANY)</a>
<a name="ln51">    {</a>
<a name="ln52">        switch (item.sub_type)</a>
<a name="ln53">        {</a>
<a name="ln54">#if TAG_MAJOR_VERSION == 34</a>
<a name="ln55">        case MISC_BOTTLED_EFREET:             return TILEP_HAND1_BOTTLE;</a>
<a name="ln56">        case MISC_FAN_OF_GALES:               return TILEP_HAND1_FAN;</a>
<a name="ln57">        case MISC_STONE_OF_TREMORS:           return TILEP_HAND1_STONE;</a>
<a name="ln58">#endif</a>
<a name="ln59">        case MISC_LIGHTNING_ROD:              return 0;</a>
<a name="ln60"> </a>
<a name="ln61">#if TAG_MAJOR_VERSION == 34</a>
<a name="ln62">        case MISC_CRYSTAL_BALL_OF_ENERGY:     return TILEP_HAND1_CRYSTAL;</a>
<a name="ln63">        case MISC_LAMP_OF_FIRE:               return TILEP_HAND1_LANTERN;</a>
<a name="ln64">        case MISC_BUGGY_LANTERN_OF_SHADOWS:   return TILEP_HAND1_BONE_LANTERN;</a>
<a name="ln65">#endif</a>
<a name="ln66">        case MISC_HORN_OF_GERYON:             return TILEP_HAND1_HORN;</a>
<a name="ln67">        case MISC_BOX_OF_BEASTS:              return TILEP_HAND1_BOX;</a>
<a name="ln68"> </a>
<a name="ln69">#if TAG_MAJOR_VERSION == 34</a>
<a name="ln70">        case MISC_DECK_OF_ESCAPE:</a>
<a name="ln71">        case MISC_DECK_OF_DESTRUCTION:</a>
<a name="ln72">        case MISC_DECK_OF_DUNGEONS:</a>
<a name="ln73">        case MISC_DECK_OF_SUMMONING:</a>
<a name="ln74">        case MISC_DECK_OF_WONDERS:</a>
<a name="ln75">        case MISC_DECK_OF_PUNISHMENT:</a>
<a name="ln76">        case MISC_DECK_OF_WAR:</a>
<a name="ln77">        case MISC_DECK_OF_CHANGES:</a>
<a name="ln78">        case MISC_DECK_OF_DEFENCE:</a>
<a name="ln79">            return 0;</a>
<a name="ln80">#endif</a>
<a name="ln81">        }</a>
<a name="ln82">    }</a>
<a name="ln83"> </a>
<a name="ln84">    if (item.base_type != OBJ_WEAPONS)</a>
<a name="ln85">        return 0;</a>
<a name="ln86"> </a>
<a name="ln87">    if (is_unrandom_artefact(item))</a>
<a name="ln88">    {</a>
<a name="ln89">        const tileidx_t tile = unrandart_to_doll_tile(find_unrandart_index(item));</a>
<a name="ln90">        if (tile)</a>
<a name="ln91">            return tile;</a>
<a name="ln92">    }</a>
<a name="ln93"> </a>
<a name="ln94">    tileidx_t tile = 0;</a>
<a name="ln95"> </a>
<a name="ln96">    switch (item.sub_type)</a>
<a name="ln97">    {</a>
<a name="ln98">    // Blunt</a>
<a name="ln99">    case WPN_CLUB:</a>
<a name="ln100">        tile = TILEP_HAND1_CLUB_SLANT;</a>
<a name="ln101">        break;</a>
<a name="ln102">    case WPN_MACE:</a>
<a name="ln103">        tile = TILEP_HAND1_MACE;</a>
<a name="ln104">        break;</a>
<a name="ln105">    case WPN_GREAT_MACE:</a>
<a name="ln106">        tile = TILEP_HAND1_GREAT_MACE;</a>
<a name="ln107">        break;</a>
<a name="ln108">    case WPN_FLAIL:</a>
<a name="ln109">        tile = TILEP_HAND1_FLAIL;</a>
<a name="ln110">        break;</a>
<a name="ln111">    case WPN_DIRE_FLAIL:</a>
<a name="ln112">        tile = TILEP_HAND1_GREAT_FLAIL;</a>
<a name="ln113">        break;</a>
<a name="ln114">    case WPN_MORNINGSTAR:</a>
<a name="ln115">        tile = TILEP_HAND1_MORNINGSTAR;</a>
<a name="ln116">        break;</a>
<a name="ln117">    case WPN_EVENINGSTAR:</a>
<a name="ln118">        tile = TILEP_HAND1_EVENINGSTAR;</a>
<a name="ln119">        break;</a>
<a name="ln120">    case WPN_GIANT_CLUB:</a>
<a name="ln121">        tile = TILEP_HAND1_GIANT_CLUB_PLAIN;</a>
<a name="ln122">        break;</a>
<a name="ln123">    case WPN_GIANT_SPIKED_CLUB:</a>
<a name="ln124">        tile = TILEP_HAND1_GIANT_CLUB_SPIKE_SLANT;</a>
<a name="ln125">        break;</a>
<a name="ln126">    case WPN_WHIP:</a>
<a name="ln127">        tile = TILEP_HAND1_WHIP;</a>
<a name="ln128">        break;</a>
<a name="ln129">    case WPN_DEMON_WHIP:</a>
<a name="ln130">        tile = TILEP_HAND1_BLACK_WHIP;</a>
<a name="ln131">        break;</a>
<a name="ln132">    case WPN_SACRED_SCOURGE:</a>
<a name="ln133">        tile = TILEP_HAND1_SACRED_SCOURGE;</a>
<a name="ln134">        break;</a>
<a name="ln135"> </a>
<a name="ln136">    // Edge</a>
<a name="ln137">    case WPN_DAGGER:</a>
<a name="ln138">        tile = TILEP_HAND1_DAGGER_SLANT;</a>
<a name="ln139">        break;</a>
<a name="ln140">    case WPN_SHORT_SWORD:</a>
<a name="ln141">        tile = TILEP_HAND1_SHORT_SWORD_SLANT;</a>
<a name="ln142">        break;</a>
<a name="ln143">    case WPN_LONG_SWORD:</a>
<a name="ln144">        tile = TILEP_HAND1_LONG_SWORD_SLANT;</a>
<a name="ln145">        break;</a>
<a name="ln146">    case WPN_GREAT_SWORD:</a>
<a name="ln147">        tile = TILEP_HAND1_GREAT_SWORD_SLANT;</a>
<a name="ln148">        break;</a>
<a name="ln149">    case WPN_SCIMITAR:</a>
<a name="ln150">        tile = TILEP_HAND1_SCIMITAR;</a>
<a name="ln151">        break;</a>
<a name="ln152">    case WPN_FALCHION:</a>
<a name="ln153">        tile = TILEP_HAND1_FALCHION;</a>
<a name="ln154">        break;</a>
<a name="ln155">    case WPN_RAPIER:</a>
<a name="ln156">        tile = TILEP_HAND1_RAPIER;</a>
<a name="ln157">        break;</a>
<a name="ln158">    case WPN_DEMON_BLADE:</a>
<a name="ln159">        tile = TILEP_HAND1_DEMON_BLADE;</a>
<a name="ln160">        break;</a>
<a name="ln161">    case WPN_QUICK_BLADE:</a>
<a name="ln162">        tile = TILEP_HAND1_DAGGER;</a>
<a name="ln163">        break;</a>
<a name="ln164">    case WPN_DOUBLE_SWORD:</a>
<a name="ln165">        tile = TILEP_HAND1_DOUBLE_SWORD;</a>
<a name="ln166">        break;</a>
<a name="ln167">    case WPN_TRIPLE_SWORD:</a>
<a name="ln168">        tile = TILEP_HAND1_TRIPLE_SWORD;</a>
<a name="ln169">        break;</a>
<a name="ln170">    case WPN_EUDEMON_BLADE:</a>
<a name="ln171">        tile = TILEP_HAND1_BLESSED_BLADE;</a>
<a name="ln172">        break;</a>
<a name="ln173"> </a>
<a name="ln174">    // Axe</a>
<a name="ln175">    case WPN_HAND_AXE:</a>
<a name="ln176">        tile = TILEP_HAND1_HAND_AXE;</a>
<a name="ln177">        break;</a>
<a name="ln178">    case WPN_BATTLEAXE:</a>
<a name="ln179">        tile = TILEP_HAND1_BATTLEAXE;</a>
<a name="ln180">        break;</a>
<a name="ln181">    case WPN_BROAD_AXE:</a>
<a name="ln182">        tile = TILEP_HAND1_BROAD_AXE;</a>
<a name="ln183">        break;</a>
<a name="ln184">    case WPN_WAR_AXE:</a>
<a name="ln185">        tile = TILEP_HAND1_WAR_AXE;</a>
<a name="ln186">        break;</a>
<a name="ln187">    case WPN_EXECUTIONERS_AXE:</a>
<a name="ln188">        tile = TILEP_HAND1_EXECUTIONERS_AXE;</a>
<a name="ln189">        break;</a>
<a name="ln190">    case WPN_BARDICHE:</a>
<a name="ln191">        tile = TILEP_HAND1_GLAIVE3;</a>
<a name="ln192">        break;</a>
<a name="ln193"> </a>
<a name="ln194">    // Pole</a>
<a name="ln195">    case WPN_SPEAR:</a>
<a name="ln196">        tile = TILEP_HAND1_SPEAR;</a>
<a name="ln197">        break;</a>
<a name="ln198">    case WPN_HALBERD:</a>
<a name="ln199">        tile = TILEP_HAND1_HALBERD;</a>
<a name="ln200">        break;</a>
<a name="ln201">    case WPN_GLAIVE:</a>
<a name="ln202">        tile = TILEP_HAND1_GLAIVE;</a>
<a name="ln203">        break;</a>
<a name="ln204">#if TAG_MAJOR_VERSION == 34</a>
<a name="ln205">    case WPN_STAFF:</a>
<a name="ln206">        tile = TILEP_HAND1_STAFF;</a>
<a name="ln207">        break;</a>
<a name="ln208">#endif</a>
<a name="ln209">    case WPN_QUARTERSTAFF:</a>
<a name="ln210">        tile = TILEP_HAND1_QUARTERSTAFF1;</a>
<a name="ln211">        break;</a>
<a name="ln212">    case WPN_LAJATANG:</a>
<a name="ln213">        tile = TILEP_HAND1_LAJATANG;</a>
<a name="ln214">        break;</a>
<a name="ln215"> </a>
<a name="ln216">    case WPN_SCYTHE:</a>
<a name="ln217">        tile = TILEP_HAND1_SCYTHE;</a>
<a name="ln218">        break;</a>
<a name="ln219">    case WPN_TRIDENT:</a>
<a name="ln220">        tile = TILEP_HAND1_TRIDENT2;</a>
<a name="ln221">        break;</a>
<a name="ln222">    case WPN_DEMON_TRIDENT:</a>
<a name="ln223">        tile = TILEP_HAND1_DEMON_TRIDENT;</a>
<a name="ln224">        break;</a>
<a name="ln225">    case WPN_TRISHULA:</a>
<a name="ln226">        tile = TILEP_HAND1_TRISHULA;</a>
<a name="ln227">        break;</a>
<a name="ln228"> </a>
<a name="ln229">    // Ranged</a>
<a name="ln230">    case WPN_HUNTING_SLING:</a>
<a name="ln231">        tile = TILEP_HAND1_HUNTING_SLING;</a>
<a name="ln232">        break;</a>
<a name="ln233">    case WPN_FUSTIBALUS:</a>
<a name="ln234">        tile = TILEP_HAND1_FUSTIBALUS;</a>
<a name="ln235">        break;</a>
<a name="ln236">    case WPN_SHORTBOW:</a>
<a name="ln237">        tile = TILEP_HAND1_BOW2;</a>
<a name="ln238">        break;</a>
<a name="ln239">    case WPN_HAND_CROSSBOW:</a>
<a name="ln240">        tile = TILEP_HAND1_HAND_CROSSBOW;</a>
<a name="ln241">        break;</a>
<a name="ln242">    case WPN_ARBALEST:</a>
<a name="ln243">        tile = TILEP_HAND1_ARBALEST;</a>
<a name="ln244">        break;</a>
<a name="ln245">    case WPN_TRIPLE_CROSSBOW:</a>
<a name="ln246">        tile = TILEP_HAND1_TRIPLE_CROSSBOW;</a>
<a name="ln247">        break;</a>
<a name="ln248">#if TAG_MAJOR_VERSION == 34</a>
<a name="ln249">    case WPN_BLOWGUN:</a>
<a name="ln250">        tile = TILEP_HAND1_BLOWGUN;</a>
<a name="ln251">        break;</a>
<a name="ln252">#endif</a>
<a name="ln253">    case WPN_LONGBOW:</a>
<a name="ln254">        tile = TILEP_HAND1_BOW3;</a>
<a name="ln255">        break;</a>
<a name="ln256"> </a>
<a name="ln257">    default: tile = 0;</a>
<a name="ln258">    }</a>
<a name="ln259"> </a>
<a name="ln260">    return tile ? tileidx_enchant_equ(item, tile, true) : 0;</a>
<a name="ln261">}</a>
<a name="ln262"> </a>
<a name="ln263">tileidx_t tilep_equ_shield(const item_def &amp;item)</a>
<a name="ln264">{</a>
<a name="ln265">    if (item.base_type != OBJ_ARMOUR)</a>
<a name="ln266">        return 0;</a>
<a name="ln267"> </a>
<a name="ln268">    if (item.props.exists(&quot;worn_tile&quot;))</a>
<a name="ln269">        return item.props[&quot;worn_tile&quot;].get_short();</a>
<a name="ln270"> </a>
<a name="ln271">    if (is_unrandom_artefact(item))</a>
<a name="ln272">    {</a>
<a name="ln273">        const tileidx_t tile = unrandart_to_doll_tile(find_unrandart_index(item));</a>
<a name="ln274">        if (tile)</a>
<a name="ln275">            return tile;</a>
<a name="ln276">    }</a>
<a name="ln277"> </a>
<a name="ln278">    switch (item.sub_type)</a>
<a name="ln279">    {</a>
<a name="ln280">        case ARM_KITE_SHIELD:</a>
<a name="ln281">            return _modrng(item.rnd, TILEP_HAND2_KITE_SHIELD_FIRST_NORM,</a>
<a name="ln282">                           TILEP_HAND2_KITE_SHIELD_LAST_NORM);</a>
<a name="ln283">        case ARM_BUCKLER:</a>
<a name="ln284">            return _modrng(item.rnd, TILEP_HAND2_BUCKLER_FIRST_NORM,</a>
<a name="ln285">                           TILEP_HAND2_BUCKLER_LAST_NORM);</a>
<a name="ln286">        case ARM_TOWER_SHIELD:</a>
<a name="ln287">            return _modrng(item.rnd, TILEP_HAND2_TOWER_SHIELD_FIRST_NORM,</a>
<a name="ln288">                           TILEP_HAND2_TOWER_SHIELD_LAST_NORM);</a>
<a name="ln289">        default: return 0;</a>
<a name="ln290">    }</a>
<a name="ln291">}</a>
<a name="ln292"> </a>
<a name="ln293">tileidx_t tilep_equ_armour(const item_def &amp;item)</a>
<a name="ln294">{</a>
<a name="ln295">    if (item.base_type != OBJ_ARMOUR)</a>
<a name="ln296">        return 0;</a>
<a name="ln297"> </a>
<a name="ln298">    if (item.props.exists(&quot;worn_tile&quot;))</a>
<a name="ln299">        return item.props[&quot;worn_tile&quot;].get_short();</a>
<a name="ln300"> </a>
<a name="ln301">    if (is_unrandom_artefact(item))</a>
<a name="ln302">    {</a>
<a name="ln303">        const tileidx_t tile = unrandart_to_doll_tile(find_unrandart_index(item));</a>
<a name="ln304">        if (tile)</a>
<a name="ln305">            return tile;</a>
<a name="ln306">    }</a>
<a name="ln307"> </a>
<a name="ln308">    if (item.sub_type == ARM_ROBE)</a>
<a name="ln309">    {</a>
<a name="ln310">        return _modrng(item.rnd, TILEP_BODY_ROBE_FIRST_NORM,</a>
<a name="ln311">                       TILEP_BODY_ROBE_LAST_NORM);</a>
<a name="ln312">    }</a>
<a name="ln313"> </a>
<a name="ln314">    tileidx_t tile = 0;</a>
<a name="ln315">    switch (item.sub_type)</a>
<a name="ln316">    {</a>
<a name="ln317">    case ARM_LEATHER_ARMOUR:        tile = TILEP_BODY_LEATHER_ARMOUR; break;</a>
<a name="ln318">    case ARM_RING_MAIL:             tile = TILEP_BODY_RINGMAIL; break;</a>
<a name="ln319">    case ARM_CHAIN_MAIL:            tile = TILEP_BODY_CHAINMAIL; break;</a>
<a name="ln320">    case ARM_SCALE_MAIL:            tile = TILEP_BODY_SCALEMAIL; break;</a>
<a name="ln321">    case ARM_PLATE_ARMOUR:          tile = TILEP_BODY_PLATE; break;</a>
<a name="ln322">    case ARM_CRYSTAL_PLATE_ARMOUR:  tile = TILEP_BODY_CRYSTAL_PLATE; break;</a>
<a name="ln323"> </a>
<a name="ln324">    case ARM_FIRE_DRAGON_ARMOUR:    tile = TILEP_BODY_DRAGONARM_RED; break;</a>
<a name="ln325">    case ARM_ICE_DRAGON_ARMOUR:     tile = TILEP_BODY_DRAGONARM_CYAN; break;</a>
<a name="ln326">    case ARM_STEAM_DRAGON_ARMOUR:   tile = TILEP_BODY_DRAGONARM_WHITE; break;</a>
<a name="ln327">    case ARM_ACID_DRAGON_ARMOUR:    tile = TILEP_BODY_DRAGONARM_YELLOW; break;</a>
<a name="ln328">    case ARM_QUICKSILVER_DRAGON_ARMOUR: tile = TILEP_BODY_DRAGONARM_QUICKSILVER; break;</a>
<a name="ln329">    case ARM_STORM_DRAGON_ARMOUR:   tile = TILEP_BODY_DRAGONARM_BLUE; break;</a>
<a name="ln330">    case ARM_SHADOW_DRAGON_ARMOUR:  tile = TILEP_BODY_DRAGONARM_SHADOW; break;</a>
<a name="ln331">    case ARM_GOLD_DRAGON_ARMOUR:    tile = TILEP_BODY_DRAGONARM_GOLD; break;</a>
<a name="ln332">    case ARM_SWAMP_DRAGON_ARMOUR:   tile = TILEP_BODY_DRAGONARM_BROWN; break;</a>
<a name="ln333">    case ARM_PEARL_DRAGON_ARMOUR:   tile = TILEP_BODY_DRAGONARM_PEARL; break;</a>
<a name="ln334"> </a>
<a name="ln335">    case ARM_ANIMAL_SKIN:           tile = TILEP_BODY_ANIMAL_SKIN; break;</a>
<a name="ln336">    case ARM_TROLL_LEATHER_ARMOUR:  tile = TILEP_BODY_TROLL_LEATHER; break;</a>
<a name="ln337"> </a>
<a name="ln338">    default:                        tile = 0;</a>
<a name="ln339">    }</a>
<a name="ln340"> </a>
<a name="ln341">    return tileidx_enchant_equ(item, tile, true);</a>
<a name="ln342">}</a>
<a name="ln343"> </a>
<a name="ln344">tileidx_t tilep_equ_cloak(const item_def &amp;item)</a>
<a name="ln345">{</a>
<a name="ln346">    if (item.base_type != OBJ_ARMOUR)</a>
<a name="ln347">        return 0;</a>
<a name="ln348"> </a>
<a name="ln349">    if (item.props.exists(&quot;worn_tile&quot;))</a>
<a name="ln350">        return item.props[&quot;worn_tile&quot;].get_short();</a>
<a name="ln351"> </a>
<a name="ln352">    if (is_unrandom_artefact(item))</a>
<a name="ln353">    {</a>
<a name="ln354">        const tileidx_t tile = unrandart_to_doll_tile(find_unrandart_index(item));</a>
<a name="ln355">        if (tile)</a>
<a name="ln356">            return tile;</a>
<a name="ln357">    }</a>
<a name="ln358"> </a>
<a name="ln359">    switch (item.sub_type)</a>
<a name="ln360">    {</a>
<a name="ln361">        case ARM_CLOAK:</a>
<a name="ln362">            return _modrng(item.rnd, TILEP_CLOAK_FIRST_NORM,</a>
<a name="ln363">                           TILEP_CLOAK_LAST_NORM);</a>
<a name="ln364"> </a>
<a name="ln365">        case ARM_SCARF:</a>
<a name="ln366">            return _modrng(item.rnd, TILEP_CLOAK_SCARF_FIRST_NORM,</a>
<a name="ln367">                           TILEP_CLOAK_SCARF_LAST_NORM);</a>
<a name="ln368">    }</a>
<a name="ln369"> </a>
<a name="ln370">    return 0;</a>
<a name="ln371">}</a>
<a name="ln372"> </a>
<a name="ln373">tileidx_t tilep_equ_helm(const item_def &amp;item)</a>
<a name="ln374">{</a>
<a name="ln375">    if (item.base_type != OBJ_ARMOUR)</a>
<a name="ln376">        return 0;</a>
<a name="ln377"> </a>
<a name="ln378">    if (item.props.exists(&quot;worn_tile&quot;))</a>
<a name="ln379">        return item.props[&quot;worn_tile&quot;].get_short();</a>
<a name="ln380"> </a>
<a name="ln381">    if (is_unrandom_artefact(item))</a>
<a name="ln382">    {</a>
<a name="ln383">        const tileidx_t tile = unrandart_to_doll_tile(find_unrandart_index(item));</a>
<a name="ln384">        if (tile)</a>
<a name="ln385">            return tile;</a>
<a name="ln386"> </a>
<a name="ln387">        // Although there shouldn't be any, just in case</a>
<a name="ln388">        // unhandled artefacts fall through to defaults...</a>
<a name="ln389">    }</a>
<a name="ln390"> </a>
<a name="ln391">    switch (item.sub_type)</a>
<a name="ln392">    {</a>
<a name="ln393">#if TAG_MAJOR_VERSION == 34</a>
<a name="ln394">        case ARM_CAP:</a>
<a name="ln395">#endif</a>
<a name="ln396">        case ARM_HAT:</a>
<a name="ln397">            return _modrng(item.rnd, TILEP_HELM_HAT_FIRST_NORM,</a>
<a name="ln398">                           TILEP_HELM_HAT_LAST_NORM);</a>
<a name="ln399"> </a>
<a name="ln400">        case ARM_HELMET:</a>
<a name="ln401">            return _modrng(item.rnd, TILEP_HELM_FIRST_NORM,</a>
<a name="ln402">                           TILEP_HELM_LAST_NORM);</a>
<a name="ln403">    }</a>
<a name="ln404"> </a>
<a name="ln405">    return 0;</a>
<a name="ln406">}</a>
<a name="ln407"> </a>
<a name="ln408">tileidx_t tilep_equ_gloves(const item_def &amp;item)</a>
<a name="ln409">{</a>
<a name="ln410">    if (item.base_type != OBJ_ARMOUR || item.sub_type != ARM_GLOVES)</a>
<a name="ln411">        return 0;</a>
<a name="ln412"> </a>
<a name="ln413">    if (item.props.exists(&quot;worn_tile&quot;))</a>
<a name="ln414">        return item.props[&quot;worn_tile&quot;].get_short();</a>
<a name="ln415"> </a>
<a name="ln416">    if (is_unrandom_artefact(item))</a>
<a name="ln417">    {</a>
<a name="ln418">        const tileidx_t tile = unrandart_to_doll_tile(find_unrandart_index(item));</a>
<a name="ln419">        if (tile)</a>
<a name="ln420">            return tile;</a>
<a name="ln421">    }</a>
<a name="ln422"> </a>
<a name="ln423">    return _modrng(item.rnd, TILEP_ARM_FIRST_NORM, TILEP_ARM_LAST_NORM);</a>
<a name="ln424">}</a>
<a name="ln425"> </a>
<a name="ln426">tileidx_t tilep_equ_boots(const item_def &amp;item)</a>
<a name="ln427">{</a>
<a name="ln428">    if (item.base_type != OBJ_ARMOUR)</a>
<a name="ln429">        return 0;</a>
<a name="ln430"> </a>
<a name="ln431">    if (item.props.exists(&quot;worn_tile&quot;))</a>
<a name="ln432">        return item.props[&quot;worn_tile&quot;].get_short();</a>
<a name="ln433"> </a>
<a name="ln434">    int etype = enchant_to_int(item);</a>
<a name="ln435"> </a>
<a name="ln436">    if (is_unrandom_artefact(item))</a>
<a name="ln437">    {</a>
<a name="ln438">        const tileidx_t tile = unrandart_to_doll_tile(find_unrandart_index(item));</a>
<a name="ln439">        if (tile)</a>
<a name="ln440">            return tile;</a>
<a name="ln441">    }</a>
<a name="ln442"> </a>
<a name="ln443">    if (item.sub_type == ARM_NAGA_BARDING)</a>
<a name="ln444">        return TILEP_BOOTS_NAGA_BARDING + min(etype, 3);</a>
<a name="ln445"> </a>
<a name="ln446">    if (item.sub_type == ARM_CENTAUR_BARDING)</a>
<a name="ln447">        return TILEP_BOOTS_CENTAUR_BARDING + min(etype, 3);</a>
<a name="ln448"> </a>
<a name="ln449">    if (item.sub_type != ARM_BOOTS)</a>
<a name="ln450">        return 0;</a>
<a name="ln451"> </a>
<a name="ln452">    return _modrng(item.rnd, TILEP_BOOTS_FIRST_NORM, TILEP_BOOTS_LAST_NORM);</a>
<a name="ln453">}</a>
<a name="ln454"> </a>
<a name="ln455">tileidx_t tileidx_player()</a>
<a name="ln456">{</a>
<a name="ln457">    tileidx_t ch = TILEP_PLAYER;</a>
<a name="ln458"> </a>
<a name="ln459">    // Handle shapechange first</a>
<a name="ln460">    switch (you.form)</a>
<a name="ln461">    {</a>
<a name="ln462">    // equipment-using forms are handled regularly</a>
<a name="ln463">    case transformation::statue:</a>
<a name="ln464">    case transformation::lich:</a>
<a name="ln465">    case transformation::tree:</a>
<a name="ln466">        break;</a>
<a name="ln467">    // animals</a>
<a name="ln468">    case transformation::bat:       ch = TILEP_TRAN_BAT;       break;</a>
<a name="ln469">    case transformation::spider:    ch = TILEP_TRAN_SPIDER;    break;</a>
<a name="ln470">    case transformation::pig:       ch = TILEP_TRAN_PIG;       break;</a>
<a name="ln471">#if TAG_MAJOR_VERSION == 34</a>
<a name="ln472">    case transformation::porcupine: ch = TILEP_MONS_PORCUPINE; break;</a>
<a name="ln473">#endif</a>
<a name="ln474">    // non-animals</a>
<a name="ln475">    case transformation::ice_beast: ch = TILEP_TRAN_ICE_BEAST; break;</a>
<a name="ln476">    case transformation::wisp:      ch = TILEP_MONS_INSUBSTANTIAL_WISP; break;</a>
<a name="ln477">#if TAG_MAJOR_VERSION == 34</a>
<a name="ln478">    case transformation::jelly:     ch = TILEP_MONS_JELLY;     break;</a>
<a name="ln479">#endif</a>
<a name="ln480">    case transformation::fungus:    ch = TILEP_TRAN_MUSHROOM;  break;</a>
<a name="ln481">    case transformation::shadow:    ch = TILEP_TRAN_SHADOW;    break;</a>
<a name="ln482">    case transformation::hydra:     ch = tileidx_mon_clamp(TILEP_MONS_HYDRA,</a>
<a name="ln483">                                                           you.heads() - 1);</a>
<a name="ln484">                                    break;</a>
<a name="ln485">    case transformation::dragon:</a>
<a name="ln486">    {</a>
<a name="ln487">        switch (you.species)</a>
<a name="ln488">        {</a>
<a name="ln489">        case SP_BLACK_DRACONIAN:   ch = TILEP_TRAN_DRAGON_BLACK;   break;</a>
<a name="ln490">        case SP_YELLOW_DRACONIAN:  ch = TILEP_TRAN_DRAGON_YELLOW;  break;</a>
<a name="ln491">        case SP_GREY_DRACONIAN:    ch = TILEP_TRAN_DRAGON_GREY;    break;</a>
<a name="ln492">        case SP_GREEN_DRACONIAN:   ch = TILEP_TRAN_DRAGON_GREEN;   break;</a>
<a name="ln493">        case SP_PALE_DRACONIAN:    ch = TILEP_TRAN_DRAGON_PALE;    break;</a>
<a name="ln494">        case SP_PURPLE_DRACONIAN:  ch = TILEP_TRAN_DRAGON_PURPLE;  break;</a>
<a name="ln495">        case SP_WHITE_DRACONIAN:   ch = TILEP_TRAN_DRAGON_WHITE;   break;</a>
<a name="ln496">        case SP_RED_DRACONIAN:     ch = TILEP_TRAN_DRAGON_RED;     break;</a>
<a name="ln497">        default:                   ch = TILEP_TRAN_DRAGON;         break;</a>
<a name="ln498">        }</a>
<a name="ln499">        break;</a>
<a name="ln500">    }</a>
<a name="ln501">    // no special tile</a>
<a name="ln502">    case transformation::blade_hands:</a>
<a name="ln503">    case transformation::appendage:</a>
<a name="ln504">    case transformation::none:</a>
<a name="ln505">    default:</a>
<a name="ln506">        break;</a>
<a name="ln507">    }</a>
<a name="ln508"> </a>
<a name="ln509">    // Currently, the flying flag is only used for not drawing the tile in the</a>
<a name="ln510">    // water. in_water() checks Beogh's water walking. If the flying flag is</a>
<a name="ln511">    // used for something else, we would need to add an in_water flag.</a>
<a name="ln512">    if (!you.in_water())</a>
<a name="ln513">        ch |= TILE_FLAG_FLYING;</a>
<a name="ln514"> </a>
<a name="ln515">    if (you.attribute[ATTR_HELD])</a>
<a name="ln516">    {</a>
<a name="ln517">        if (get_trapping_net(you.pos()) == NON_ITEM)</a>
<a name="ln518">            ch |= TILE_FLAG_WEB;</a>
<a name="ln519">        else</a>
<a name="ln520">            ch |= TILE_FLAG_NET;</a>
<a name="ln521">    }</a>
<a name="ln522"> </a>
<a name="ln523">    if (you.duration[DUR_POISONING])</a>
<a name="ln524">    {</a>
<a name="ln525">        int pois_perc = (you.hp &lt;= 0) ? 100</a>
<a name="ln526">                                  : ((you.hp - max(0, poison_survival())) * 100 / you.hp);</a>
<a name="ln527">        if (pois_perc &gt;= 100)</a>
<a name="ln528">            ch |= TILE_FLAG_MAX_POISON;</a>
<a name="ln529">        else if (pois_perc &gt;= 35)</a>
<a name="ln530">            ch |= TILE_FLAG_MORE_POISON;</a>
<a name="ln531">        else</a>
<a name="ln532">            ch |= TILE_FLAG_POISON;</a>
<a name="ln533">    }</a>
<a name="ln534"> </a>
<a name="ln535">    return ch;</a>
<a name="ln536">}</a>
<a name="ln537"> </a>
<a name="ln538">bool is_player_tile(tileidx_t tile, tileidx_t base_tile)</a>
<a name="ln539">{</a>
<a name="ln540">    return tile &gt;= base_tile</a>
<a name="ln541">           &amp;&amp; tile &lt; base_tile + tile_player_count(base_tile);</a>
<a name="ln542">}</a>
<a name="ln543"> </a>
<a name="ln544">static int _draconian_colour(int race, int level)</a>
<a name="ln545">{</a>
<a name="ln546">    if (level &lt; 0) // hack:monster</a>
<a name="ln547">    {</a>
<a name="ln548">        switch (race)</a>
<a name="ln549">        {</a>
<a name="ln550">        case MONS_DRACONIAN:        return 0;</a>
<a name="ln551">        case MONS_BLACK_DRACONIAN:  return 1;</a>
<a name="ln552">        case MONS_YELLOW_DRACONIAN: return 2;</a>
<a name="ln553">        case MONS_GREY_DRACONIAN:   return 3;</a>
<a name="ln554">        case MONS_GREEN_DRACONIAN:  return 4;</a>
<a name="ln555">        case MONS_PALE_DRACONIAN:   return 5;</a>
<a name="ln556">        case MONS_PURPLE_DRACONIAN: return 6;</a>
<a name="ln557">        case MONS_RED_DRACONIAN:    return 7;</a>
<a name="ln558">        case MONS_WHITE_DRACONIAN:  return 8;</a>
<a name="ln559">        }</a>
<a name="ln560">    }</a>
<a name="ln561">    switch (race)</a>
<a name="ln562">    {</a>
<a name="ln563">    case SP_BLACK_DRACONIAN:   return 1;</a>
<a name="ln564">    case SP_YELLOW_DRACONIAN:  return 2;</a>
<a name="ln565">    case SP_GREY_DRACONIAN:    return 3;</a>
<a name="ln566">    case SP_GREEN_DRACONIAN:   return 4;</a>
<a name="ln567">    case SP_PALE_DRACONIAN:    return 5;</a>
<a name="ln568">    case SP_PURPLE_DRACONIAN:  return 6;</a>
<a name="ln569">    case SP_RED_DRACONIAN:     return 7;</a>
<a name="ln570">    case SP_WHITE_DRACONIAN:   return 8;</a>
<a name="ln571">    }</a>
<a name="ln572">    return 0;</a>
<a name="ln573">}</a>
<a name="ln574"> </a>
<a name="ln575">tileidx_t tilep_species_to_base_tile(int sp, int level)</a>
<a name="ln576">{</a>
<a name="ln577">    switch (sp)</a>
<a name="ln578">    {</a>
<a name="ln579">    case SP_HUMAN:</a>
<a name="ln580">        return TILEP_BASE_HUMAN;</a>
<a name="ln581">#if TAG_MAJOR_VERSION == 34</a>
<a name="ln582">    case SP_HIGH_ELF:</a>
<a name="ln583">    case SP_SLUDGE_ELF:</a>
<a name="ln584">#endif</a>
<a name="ln585">    case SP_DEEP_ELF:</a>
<a name="ln586">        return TILEP_BASE_DEEP_ELF;</a>
<a name="ln587">    case SP_HALFLING:</a>
<a name="ln588">        return TILEP_BASE_HALFLING;</a>
<a name="ln589">    case SP_HILL_ORC:</a>
<a name="ln590">        return TILEP_BASE_ORC;</a>
<a name="ln591">    case SP_KOBOLD:</a>
<a name="ln592">        return TILEP_BASE_KOBOLD;</a>
<a name="ln593">    case SP_MUMMY:</a>
<a name="ln594">        return TILEP_BASE_MUMMY;</a>
<a name="ln595">    case SP_NAGA:</a>
<a name="ln596">        return TILEP_BASE_NAGA;</a>
<a name="ln597">    case SP_OGRE:</a>
<a name="ln598">        return TILEP_BASE_OGRE;</a>
<a name="ln599">    case SP_TROLL:</a>
<a name="ln600">        return TILEP_BASE_TROLL;</a>
<a name="ln601">    case SP_BASE_DRACONIAN:</a>
<a name="ln602">    case SP_RED_DRACONIAN:</a>
<a name="ln603">    case SP_WHITE_DRACONIAN:</a>
<a name="ln604">    case SP_GREEN_DRACONIAN:</a>
<a name="ln605">    case SP_YELLOW_DRACONIAN:</a>
<a name="ln606">    case SP_GREY_DRACONIAN:</a>
<a name="ln607">    case SP_BLACK_DRACONIAN:</a>
<a name="ln608">    case SP_PURPLE_DRACONIAN:</a>
<a name="ln609">    case SP_PALE_DRACONIAN:</a>
<a name="ln610">    {</a>
<a name="ln611">        const int colour_offset = _draconian_colour(sp, level);</a>
<a name="ln612">        return TILEP_BASE_DRACONIAN + colour_offset * 2;</a>
<a name="ln613">    }</a>
<a name="ln614">    case SP_CENTAUR:</a>
<a name="ln615">        return TILEP_BASE_CENTAUR;</a>
<a name="ln616">    case SP_DEMIGOD:</a>
<a name="ln617">        return TILEP_BASE_DEMIGOD;</a>
<a name="ln618">    case SP_SPRIGGAN:</a>
<a name="ln619">        return TILEP_BASE_SPRIGGAN;</a>
<a name="ln620">    case SP_MINOTAUR:</a>
<a name="ln621">        return TILEP_BASE_MINOTAUR;</a>
<a name="ln622">    case SP_DEMONSPAWN:</a>
<a name="ln623">        return TILEP_BASE_DEMONSPAWN;</a>
<a name="ln624">    case SP_GHOUL:</a>
<a name="ln625">        return TILEP_BASE_GHOUL;</a>
<a name="ln626">    case SP_TENGU:</a>
<a name="ln627">        return TILEP_BASE_TENGU;</a>
<a name="ln628">    case SP_MERFOLK:</a>
<a name="ln629">        return TILEP_BASE_MERFOLK;</a>
<a name="ln630">    case SP_VAMPIRE:</a>
<a name="ln631">        return TILEP_BASE_VAMPIRE;</a>
<a name="ln632">    case SP_DEEP_DWARF:</a>
<a name="ln633">        return TILEP_BASE_DEEP_DWARF;</a>
<a name="ln634">    case SP_GARGOYLE:</a>
<a name="ln635">        return TILEP_BASE_GARGOYLE;</a>
<a name="ln636">    case SP_FELID:</a>
<a name="ln637">        return TILEP_BASE_FELID;</a>
<a name="ln638">    case SP_OCTOPODE:</a>
<a name="ln639">        return TILEP_BASE_OCTOPODE;</a>
<a name="ln640">    case SP_FORMICID:</a>
<a name="ln641">        return TILEP_BASE_FORMICID;</a>
<a name="ln642">    case SP_VINE_STALKER:</a>
<a name="ln643">        return TILEP_BASE_VINE_STALKER;</a>
<a name="ln644">    case SP_BARACHI:</a>
<a name="ln645">        return TILEP_BASE_BARACHI;</a>
<a name="ln646">    case SP_GNOLL:</a>
<a name="ln647">        return TILEP_BASE_GNOLL;</a>
<a name="ln648">    default:</a>
<a name="ln649">        return TILEP_BASE_HUMAN;</a>
<a name="ln650">    }</a>
<a name="ln651">}</a>
<a name="ln652">void tilep_draconian_init(int sp, int level, tileidx_t *base,</a>
<a name="ln653">                          tileidx_t *head, tileidx_t *wing)</a>
<a name="ln654">{</a>
<a name="ln655">    const int colour_offset = _draconian_colour(sp, level);</a>
<a name="ln656">    *base = TILEP_BASE_DRACONIAN + colour_offset * 2;</a>
<a name="ln657">    *head = tile_player_part_start[TILEP_PART_DRCHEAD] + colour_offset;</a>
<a name="ln658"> </a>
<a name="ln659">    if (you.has_mutation(MUT_BIG_WINGS))</a>
<a name="ln660">        *wing = tile_player_part_start[TILEP_PART_DRCWING] + colour_offset;</a>
<a name="ln661">}</a>
<a name="ln662"> </a>
<a name="ln663">// Set default parts of each race: body + optional beard, hair, etc.</a>
<a name="ln664">// This function needs to be entirely deterministic.</a>
<a name="ln665">void tilep_race_default(int sp, int level, dolls_data *doll)</a>
<a name="ln666">{</a>
<a name="ln667">    tileidx_t *parts = doll-&gt;parts;</a>
<a name="ln668"> </a>
<a name="ln669">    tileidx_t result = tilep_species_to_base_tile(sp, level);</a>
<a name="ln670">    if (parts[TILEP_PART_BASE] != TILEP_SHOW_EQUIP)</a>
<a name="ln671">        result = parts[TILEP_PART_BASE];</a>
<a name="ln672"> </a>
<a name="ln673">    tileidx_t hair   = 0;</a>
<a name="ln674">    tileidx_t beard  = 0;</a>
<a name="ln675">    tileidx_t wing   = 0;</a>
<a name="ln676">    tileidx_t head   = 0;</a>
<a name="ln677"> </a>
<a name="ln678">    hair = TILEP_HAIR_SHORT_BLACK;</a>
<a name="ln679"> </a>
<a name="ln680">    switch (sp)</a>
<a name="ln681">    {</a>
<a name="ln682">#if TAG_MAJOR_VERSION == 34</a>
<a name="ln683">        case SP_HIGH_ELF:</a>
<a name="ln684">        case SP_SLUDGE_ELF:</a>
<a name="ln685">            hair = TILEP_HAIR_ELF_YELLOW;</a>
<a name="ln686">            break;</a>
<a name="ln687">#endif</a>
<a name="ln688">        case SP_DEEP_ELF:</a>
<a name="ln689">            hair = TILEP_HAIR_ELF_WHITE;</a>
<a name="ln690">            break;</a>
<a name="ln691">        case SP_TROLL:</a>
<a name="ln692">            hair = TILEP_HAIR_TROLL;</a>
<a name="ln693">            break;</a>
<a name="ln694">        case SP_BASE_DRACONIAN:</a>
<a name="ln695">        case SP_RED_DRACONIAN:</a>
<a name="ln696">        case SP_WHITE_DRACONIAN:</a>
<a name="ln697">        case SP_GREEN_DRACONIAN:</a>
<a name="ln698">        case SP_YELLOW_DRACONIAN:</a>
<a name="ln699">        case SP_GREY_DRACONIAN:</a>
<a name="ln700">        case SP_BLACK_DRACONIAN:</a>
<a name="ln701">        case SP_PURPLE_DRACONIAN:</a>
<a name="ln702">        case SP_PALE_DRACONIAN:</a>
<a name="ln703">        {</a>
<a name="ln704">            tilep_draconian_init(sp, level, &amp;result, &amp;head, &amp;wing);</a>
<a name="ln705">            hair   = 0;</a>
<a name="ln706">            break;</a>
<a name="ln707">        }</a>
<a name="ln708">        case SP_MERFOLK:</a>
<a name="ln709">            result = you.fishtail ? TILEP_BASE_MERFOLK_WATER</a>
<a name="ln710">                                  : TILEP_BASE_MERFOLK;</a>
<a name="ln711">            hair = TILEP_HAIR_GREEN;</a>
<a name="ln712">            break;</a>
<a name="ln713">        case SP_NAGA:</a>
<a name="ln714">            hair = TILEP_HAIR_PART2_RED;</a>
<a name="ln715">            break;</a>
<a name="ln716">        case SP_VAMPIRE:</a>
<a name="ln717">            hair = TILEP_HAIR_ARWEN;</a>
<a name="ln718">            break;</a>
<a name="ln719">        case SP_DEEP_DWARF:</a>
<a name="ln720">            hair  = TILEP_HAIR_SHORT_WHITE;</a>
<a name="ln721">            beard = TILEP_BEARD_GARIBALDI_WHITE;</a>
<a name="ln722">            break;</a>
<a name="ln723">        case SP_SPRIGGAN:</a>
<a name="ln724">            hair = 0;</a>
<a name="ln725">            beard = TILEP_BEARD_MEDIUM_GREEN;</a>
<a name="ln726">            break;</a>
<a name="ln727">        case SP_MINOTAUR:</a>
<a name="ln728">        case SP_DEMONSPAWN:</a>
<a name="ln729">        case SP_GHOUL:</a>
<a name="ln730">        case SP_HILL_ORC:</a>
<a name="ln731">        case SP_KOBOLD:</a>
<a name="ln732">        case SP_MUMMY:</a>
<a name="ln733">        case SP_FORMICID:</a>
<a name="ln734">        case SP_BARACHI:</a>
<a name="ln735">        case SP_GNOLL:</a>
<a name="ln736">        case SP_GARGOYLE:</a>
<a name="ln737">        case SP_VINE_STALKER:</a>
<a name="ln738">            hair = 0;</a>
<a name="ln739">            break;</a>
<a name="ln740">        default:</a>
<a name="ln741">            // nothing to do</a>
<a name="ln742">            break;</a>
<a name="ln743">    }</a>
<a name="ln744"> </a>
<a name="ln745">    parts[TILEP_PART_BASE] = result;</a>
<a name="ln746"> </a>
<a name="ln747">    // Don't overwrite doll parts defined elsewhere.</a>
<a name="ln748">    if (parts[TILEP_PART_HAIR] == TILEP_SHOW_EQUIP)</a>
<a name="ln749">        parts[TILEP_PART_HAIR] = hair;</a>
<a name="ln750">    if (parts[TILEP_PART_BEARD] == TILEP_SHOW_EQUIP)</a>
<a name="ln751">        parts[TILEP_PART_BEARD] = beard;</a>
<a name="ln752">    if (parts[TILEP_PART_SHADOW] == TILEP_SHOW_EQUIP)</a>
<a name="ln753">        parts[TILEP_PART_SHADOW] = TILEP_SHADOW_SHADOW;</a>
<a name="ln754">    if (parts[TILEP_PART_DRCHEAD] == TILEP_SHOW_EQUIP)</a>
<a name="ln755">        parts[TILEP_PART_DRCHEAD] = head;</a>
<a name="ln756">    if (parts[TILEP_PART_DRCWING] == TILEP_SHOW_EQUIP)</a>
<a name="ln757">        parts[TILEP_PART_DRCWING] = wing;</a>
<a name="ln758">}</a>
<a name="ln759"> </a>
<a name="ln760">// This function needs to be entirely deterministic.</a>
<a name="ln761">void tilep_job_default(int job, dolls_data *doll)</a>
<a name="ln762">{</a>
<a name="ln763">    tileidx_t *parts = doll-&gt;parts;</a>
<a name="ln764"> </a>
<a name="ln765">    parts[TILEP_PART_CLOAK] = TILEP_SHOW_EQUIP;</a>
<a name="ln766">    parts[TILEP_PART_BOOTS] = TILEP_SHOW_EQUIP;</a>
<a name="ln767">    parts[TILEP_PART_LEG]   = TILEP_SHOW_EQUIP;</a>
<a name="ln768">    parts[TILEP_PART_BODY]  = TILEP_SHOW_EQUIP;</a>
<a name="ln769">    parts[TILEP_PART_ARM]   = TILEP_SHOW_EQUIP;</a>
<a name="ln770">    parts[TILEP_PART_HAND1] = TILEP_SHOW_EQUIP;</a>
<a name="ln771">    parts[TILEP_PART_HAND2] = TILEP_SHOW_EQUIP;</a>
<a name="ln772">    parts[TILEP_PART_HELM]  = TILEP_SHOW_EQUIP;</a>
<a name="ln773"> </a>
<a name="ln774">    switch (job)</a>
<a name="ln775">    {</a>
<a name="ln776">        case JOB_FIGHTER:</a>
<a name="ln777">            parts[TILEP_PART_LEG]   = TILEP_LEG_METAL_SILVER;</a>
<a name="ln778">            break;</a>
<a name="ln779"> </a>
<a name="ln780">        case JOB_SKALD:</a>
<a name="ln781">            parts[TILEP_PART_BODY]  = TILEP_BODY_SHIRT_WHITE3;</a>
<a name="ln782">            parts[TILEP_PART_LEG]   = TILEP_LEG_SKIRT_OFS;</a>
<a name="ln783">            parts[TILEP_PART_HELM]  = TILEP_HELM_HELM_IRON;</a>
<a name="ln784">            parts[TILEP_PART_ARM]   = TILEP_ARM_GLOVE_GRAY;</a>
<a name="ln785">            parts[TILEP_PART_BOOTS] = TILEP_BOOTS_MIDDLE_GRAY;</a>
<a name="ln786">            parts[TILEP_PART_CLOAK] = TILEP_CLOAK_BLUE;</a>
<a name="ln787">            break;</a>
<a name="ln788"> </a>
<a name="ln789">        case JOB_CHAOS_KNIGHT:</a>
<a name="ln790">            parts[TILEP_PART_BODY]  = TILEP_BODY_MESH_BLACK;</a>
<a name="ln791">            parts[TILEP_PART_LEG]   = TILEP_LEG_PANTS_SHORT_DARKBROWN;</a>
<a name="ln792">            parts[TILEP_PART_HELM]  = TILEP_HELM_CLOWN; // Xom</a>
<a name="ln793">            break;</a>
<a name="ln794"> </a>
<a name="ln795">        case JOB_ABYSSAL_KNIGHT:</a>
<a name="ln796">            parts[TILEP_PART_BODY]  = TILEP_BODY_SHOULDER_PAD;</a>
<a name="ln797">            parts[TILEP_PART_LEG]   = TILEP_LEG_METAL_GRAY;</a>
<a name="ln798">            parts[TILEP_PART_HELM]  = TILEP_HELM_FHELM_PLUME;</a>
<a name="ln799">            break;</a>
<a name="ln800"> </a>
<a name="ln801">        case JOB_BERSERKER:</a>
<a name="ln802">            parts[TILEP_PART_BODY]  = TILEP_BODY_ANIMAL_SKIN;</a>
<a name="ln803">            parts[TILEP_PART_LEG]   = TILEP_LEG_BELT_REDBROWN;</a>
<a name="ln804">            break;</a>
<a name="ln805"> </a>
<a name="ln806">#if TAG_MAJOR_VERSION == 34</a>
<a name="ln807">        case JOB_STALKER:</a>
<a name="ln808">            parts[TILEP_PART_HELM]  = TILEP_HELM_HOOD_GREEN;</a>
<a name="ln809">            parts[TILEP_PART_BODY]  = TILEP_BODY_LEATHER_JACKET;</a>
<a name="ln810">            parts[TILEP_PART_LEG]   = TILEP_LEG_PANTS_SHORT_GRAY;</a>
<a name="ln811">            parts[TILEP_PART_HAND1] = TILEP_HAND1_SWORD_THIEF;</a>
<a name="ln812">            parts[TILEP_PART_HAND2] = TILEP_HAND2_BOOK_GREEN_DIM;</a>
<a name="ln813">            parts[TILEP_PART_ARM]   = TILEP_ARM_GLOVE_WRIST_PURPLE;</a>
<a name="ln814">            parts[TILEP_PART_CLOAK] = TILEP_CLOAK_GREEN;</a>
<a name="ln815">            parts[TILEP_PART_BOOTS] = TILEP_BOOTS_MIDDLE_BROWN2;</a>
<a name="ln816">            break;</a>
<a name="ln817">#endif</a>
<a name="ln818"> </a>
<a name="ln819">        case JOB_ASSASSIN:</a>
<a name="ln820">            parts[TILEP_PART_HELM]  = TILEP_HELM_MASK_NINJA_BLACK;</a>
<a name="ln821">            parts[TILEP_PART_BODY]  = TILEP_BODY_SHIRT_BLACK3;</a>
<a name="ln822">            parts[TILEP_PART_LEG]   = TILEP_LEG_PANTS_BLACK;</a>
<a name="ln823">            parts[TILEP_PART_HAND1] = TILEP_HAND1_SWORD_THIEF;</a>
<a name="ln824">            parts[TILEP_PART_ARM]   = TILEP_ARM_GLOVE_BLACK;</a>
<a name="ln825">            parts[TILEP_PART_CLOAK] = TILEP_CLOAK_BLACK;</a>
<a name="ln826">            parts[TILEP_PART_BOOTS] = TILEP_BOOTS_SHORT_BROWN2;</a>
<a name="ln827">            break;</a>
<a name="ln828"> </a>
<a name="ln829">        case JOB_WIZARD:</a>
<a name="ln830">            parts[TILEP_PART_BODY]  = TILEP_BODY_GANDALF_G;</a>
<a name="ln831">            parts[TILEP_PART_HAND1] = TILEP_HAND1_GANDALF;</a>
<a name="ln832">            parts[TILEP_PART_HAND2] = TILEP_HAND2_BOOK_CYAN_DIM;</a>
<a name="ln833">            parts[TILEP_PART_BOOTS] = TILEP_BOOTS_SHORT_BROWN;</a>
<a name="ln834">            parts[TILEP_PART_HELM]  = TILEP_HELM_WIZARD_GRAY;</a>
<a name="ln835">            break;</a>
<a name="ln836"> </a>
<a name="ln837">#if TAG_MAJOR_VERSION == 34</a>
<a name="ln838">        case JOB_PRIEST:</a>
<a name="ln839">            parts[TILEP_PART_BODY]  = TILEP_BODY_ROBE_WHITE;</a>
<a name="ln840">            parts[TILEP_PART_ARM]   = TILEP_ARM_GLOVE_WHITE;</a>
<a name="ln841">            parts[TILEP_PART_BOOTS] = TILEP_BOOTS_SHORT_BROWN;</a>
<a name="ln842">            break;</a>
<a name="ln843"> </a>
<a name="ln844">        case JOB_HEALER:</a>
<a name="ln845">            parts[TILEP_PART_BODY]  = TILEP_BODY_ROBE_WHITE;</a>
<a name="ln846">            parts[TILEP_PART_ARM]   = TILEP_ARM_GLOVE_WHITE;</a>
<a name="ln847">            parts[TILEP_PART_HAND1] = TILEP_HAND1_DAGGER;</a>
<a name="ln848">            parts[TILEP_PART_BOOTS] = TILEP_BOOTS_SHORT_BROWN;</a>
<a name="ln849">            parts[TILEP_PART_HELM]  = TILEP_HELM_FHELM_HEALER;</a>
<a name="ln850">            break;</a>
<a name="ln851">#endif</a>
<a name="ln852"> </a>
<a name="ln853">        case JOB_NECROMANCER:</a>
<a name="ln854">            parts[TILEP_PART_BODY]  = TILEP_BODY_ROBE_BLACK;</a>
<a name="ln855">            parts[TILEP_PART_HAND1] = TILEP_HAND1_STAFF_SKULL;</a>
<a name="ln856">            parts[TILEP_PART_HAND2] = TILEP_HAND2_BOOK_BLACK;</a>
<a name="ln857">            parts[TILEP_PART_BOOTS] = TILEP_BOOTS_SHORT_BROWN;</a>
<a name="ln858">            break;</a>
<a name="ln859"> </a>
<a name="ln860">        case JOB_FIRE_ELEMENTALIST:</a>
<a name="ln861">            parts[TILEP_PART_BODY]  = TILEP_BODY_ROBE_RED;</a>
<a name="ln862">            parts[TILEP_PART_HAND1] = TILEP_HAND1_GANDALF;</a>
<a name="ln863">            parts[TILEP_PART_HAND2] = TILEP_HAND2_BOOK_RED_DIM;</a>
<a name="ln864">            parts[TILEP_PART_BOOTS] = TILEP_BOOTS_SHORT_BROWN;</a>
<a name="ln865">            break;</a>
<a name="ln866"> </a>
<a name="ln867">        case JOB_ICE_ELEMENTALIST:</a>
<a name="ln868">            parts[TILEP_PART_BODY]  = TILEP_BODY_ROBE_BLUE;</a>
<a name="ln869">            parts[TILEP_PART_HAND1] = TILEP_HAND1_GANDALF;</a>
<a name="ln870">            parts[TILEP_PART_HAND2] = TILEP_HAND2_BOOK_BLUE_DIM;</a>
<a name="ln871">            parts[TILEP_PART_BOOTS] = TILEP_BOOTS_SHORT_BROWN;</a>
<a name="ln872">            break;</a>
<a name="ln873"> </a>
<a name="ln874">        case JOB_AIR_ELEMENTALIST:</a>
<a name="ln875">            parts[TILEP_PART_BODY]  = TILEP_BODY_ROBE_CYAN;</a>
<a name="ln876">            parts[TILEP_PART_HAND1] = TILEP_HAND1_GANDALF;</a>
<a name="ln877">            parts[TILEP_PART_HAND2] = TILEP_HAND2_BOOK_CYAN_DIM;</a>
<a name="ln878">            parts[TILEP_PART_BOOTS] = TILEP_BOOTS_SHORT_BROWN;</a>
<a name="ln879">            break;</a>
<a name="ln880"> </a>
<a name="ln881">        case JOB_EARTH_ELEMENTALIST:</a>
<a name="ln882">            parts[TILEP_PART_BODY]  = TILEP_BODY_ROBE_YELLOW;</a>
<a name="ln883">            parts[TILEP_PART_HAND1] = TILEP_HAND1_GANDALF;</a>
<a name="ln884">            parts[TILEP_PART_HAND2] = TILEP_HAND2_BOOK_YELLOW_DIM;</a>
<a name="ln885">            parts[TILEP_PART_BOOTS] = TILEP_BOOTS_SHORT_BROWN;</a>
<a name="ln886">            break;</a>
<a name="ln887"> </a>
<a name="ln888">        case JOB_VENOM_MAGE:</a>
<a name="ln889">            parts[TILEP_PART_BODY]  = TILEP_BODY_ROBE_GREEN;</a>
<a name="ln890">            parts[TILEP_PART_HAND1] = TILEP_HAND1_GANDALF;</a>
<a name="ln891">            parts[TILEP_PART_HAND2] = TILEP_HAND2_BOOK_GREEN_DIM;</a>
<a name="ln892">            parts[TILEP_PART_BOOTS] = TILEP_BOOTS_SHORT_BROWN;</a>
<a name="ln893">            break;</a>
<a name="ln894"> </a>
<a name="ln895">        case JOB_TRANSMUTER:</a>
<a name="ln896">            parts[TILEP_PART_BODY]  = TILEP_BODY_ROBE_RAINBOW;</a>
<a name="ln897">            parts[TILEP_PART_HAND1] = TILEP_HAND1_STAFF_RUBY;</a>
<a name="ln898">            parts[TILEP_PART_HAND2] = TILEP_HAND2_BOOK_MAGENTA_DIM;</a>
<a name="ln899">            parts[TILEP_PART_BOOTS] = TILEP_BOOTS_SHORT_BROWN;</a>
<a name="ln900">            break;</a>
<a name="ln901"> </a>
<a name="ln902">        case JOB_CONJURER:</a>
<a name="ln903">            parts[TILEP_PART_BODY]  = TILEP_BODY_ROBE_MAGENTA;</a>
<a name="ln904">            parts[TILEP_PART_HELM]  = TILEP_HELM_WIZARD_GRAY;</a>
<a name="ln905">            parts[TILEP_PART_HAND1] = TILEP_HAND1_STAFF_MAGE2;</a>
<a name="ln906">            parts[TILEP_PART_HAND2] = TILEP_HAND2_BOOK_RED_DIM;</a>
<a name="ln907">            parts[TILEP_PART_BOOTS] = TILEP_BOOTS_SHORT_BROWN;</a>
<a name="ln908">            break;</a>
<a name="ln909"> </a>
<a name="ln910">        case JOB_ENCHANTER:</a>
<a name="ln911">            parts[TILEP_PART_BODY]  = TILEP_BODY_ROBE_YELLOW;</a>
<a name="ln912">            parts[TILEP_PART_HELM]  = TILEP_HELM_WIZARD_GRAY;</a>
<a name="ln913">            parts[TILEP_PART_HAND1] = TILEP_HAND1_STAFF_MAGE;</a>
<a name="ln914">            parts[TILEP_PART_HAND2] = TILEP_HAND2_BOOK_BLUE_DIM;</a>
<a name="ln915">            parts[TILEP_PART_BOOTS] = TILEP_BOOTS_SHORT_BROWN;</a>
<a name="ln916">            break;</a>
<a name="ln917"> </a>
<a name="ln918">        case JOB_SUMMONER:</a>
<a name="ln919">            parts[TILEP_PART_BODY]  = TILEP_BODY_ROBE_BROWN;</a>
<a name="ln920">            parts[TILEP_PART_HELM]  = TILEP_HELM_WIZARD_GRAY;</a>
<a name="ln921">            parts[TILEP_PART_HAND1] = TILEP_HAND1_STAFF_RING_BLUE;</a>
<a name="ln922">            parts[TILEP_PART_HAND2] = TILEP_HAND2_BOOK_YELLOW_DIM;</a>
<a name="ln923">            parts[TILEP_PART_BOOTS] = TILEP_BOOTS_SHORT_BROWN;</a>
<a name="ln924">            break;</a>
<a name="ln925"> </a>
<a name="ln926">        case JOB_WARPER:</a>
<a name="ln927">            parts[TILEP_PART_BODY]  = TILEP_BODY_ROBE_BROWN;</a>
<a name="ln928">            parts[TILEP_PART_HELM]  = TILEP_HELM_WIZARD_GRAY;</a>
<a name="ln929">            parts[TILEP_PART_HAND1] = TILEP_HAND1_SARUMAN;</a>
<a name="ln930">            parts[TILEP_PART_HAND2] = TILEP_HAND2_BOOK_WHITE;</a>
<a name="ln931">            parts[TILEP_PART_BOOTS] = TILEP_BOOTS_SHORT_BROWN;</a>
<a name="ln932">            parts[TILEP_PART_CLOAK] = TILEP_CLOAK_RED;</a>
<a name="ln933">            break;</a>
<a name="ln934"> </a>
<a name="ln935">        case JOB_ARCANE_MARKSMAN:</a>
<a name="ln936">            parts[TILEP_PART_BODY]  = TILEP_BODY_ROBE_BROWN;</a>
<a name="ln937">            parts[TILEP_PART_HELM]  = TILEP_HELM_WIZARD_GRAY;</a>
<a name="ln938">            parts[TILEP_PART_HAND1] = TILEP_HAND1_SARUMAN;</a>
<a name="ln939">            parts[TILEP_PART_HAND2] = TILEP_HAND2_BOOK_WHITE;</a>
<a name="ln940">            parts[TILEP_PART_BOOTS] = TILEP_BOOTS_SHORT_BROWN;</a>
<a name="ln941">            parts[TILEP_PART_CLOAK] = TILEP_CLOAK_RED;</a>
<a name="ln942">            break;</a>
<a name="ln943"> </a>
<a name="ln944">        case JOB_HUNTER:</a>
<a name="ln945">            parts[TILEP_PART_BODY]  = TILEP_BODY_LEGOLAS;</a>
<a name="ln946">            parts[TILEP_PART_HELM]  = TILEP_HELM_FEATHER_GREEN;</a>
<a name="ln947">            parts[TILEP_PART_LEG]   = TILEP_LEG_PANTS_DARKGREEN;</a>
<a name="ln948">            parts[TILEP_PART_BOOTS] = TILEP_BOOTS_MIDDLE_BROWN3;</a>
<a name="ln949">            break;</a>
<a name="ln950"> </a>
<a name="ln951">        case JOB_GLADIATOR:</a>
<a name="ln952">            parts[TILEP_PART_HAND2] = TILEP_HAND2_KITE_SHIELD_ROUND2;</a>
<a name="ln953">            parts[TILEP_PART_BODY]  = TILEP_BODY_BELT1;</a>
<a name="ln954">            parts[TILEP_PART_LEG]   = TILEP_LEG_BELT_GRAY;</a>
<a name="ln955">            parts[TILEP_PART_BOOTS] = TILEP_BOOTS_MIDDLE_GRAY;</a>
<a name="ln956">            break;</a>
<a name="ln957"> </a>
<a name="ln958">        case JOB_MONK:</a>
<a name="ln959">            parts[TILEP_PART_BODY]  = TILEP_BODY_MONK_BLACK;</a>
<a name="ln960">            break;</a>
<a name="ln961"> </a>
<a name="ln962">        case JOB_WANDERER:</a>
<a name="ln963">            parts[TILEP_PART_BODY]  = TILEP_BODY_SHIRT_HAWAII;</a>
<a name="ln964">            parts[TILEP_PART_LEG]   = TILEP_LEG_PANTS_SHORT_BROWN;</a>
<a name="ln965">            parts[TILEP_PART_BOOTS] = TILEP_BOOTS_MIDDLE_BROWN3;</a>
<a name="ln966">            break;</a>
<a name="ln967"> </a>
<a name="ln968">        case JOB_ARTIFICER:</a>
<a name="ln969">            parts[TILEP_PART_HAND1] = TILEP_HAND1_SCEPTRE;</a>
<a name="ln970">            parts[TILEP_PART_BODY]  = TILEP_BODY_LEATHER_ARMOUR;</a>
<a name="ln971">            parts[TILEP_PART_LEG]   = TILEP_LEG_PANTS_BLACK;</a>
<a name="ln972">            break;</a>
<a name="ln973">    }</a>
<a name="ln974">}</a>
<a name="ln975"> </a>
<a name="ln976">void tilep_calc_flags(const dolls_data &amp;doll, int flag[])</a>
<a name="ln977">{</a>
<a name="ln978">    for (unsigned i = 0; i &lt; TILEP_PART_MAX; i++)</a>
<a name="ln979">        flag[i] = TILEP_FLAG_NORMAL;</a>
<a name="ln980"> </a>
<a name="ln981">    if (doll.parts[TILEP_PART_HELM] &gt;= TILEP_HELM_HELM_OFS)</a>
<a name="ln982">        flag[TILEP_PART_HAIR] = TILEP_FLAG_HIDE;</a>
<a name="ln983"> </a>
<a name="ln984">    if (doll.parts[TILEP_PART_HELM] &gt;= TILEP_HELM_FHELM_OFS)</a>
<a name="ln985">        flag[TILEP_PART_BEARD] = TILEP_FLAG_HIDE;</a>
<a name="ln986"> </a>
<a name="ln987">    if (doll.parts[TILEP_PART_HELM] &gt;= TILEP_HELM_HELM_OFS)</a>
<a name="ln988">        flag[TILEP_PART_DRCHEAD] = TILEP_FLAG_HIDE;</a>
<a name="ln989"> </a>
<a name="ln990">    if (is_player_tile(doll.parts[TILEP_PART_BASE], TILEP_BASE_NAGA))</a>
<a name="ln991">    {</a>
<a name="ln992">        flag[TILEP_PART_BOOTS] = flag[TILEP_PART_LEG] = TILEP_FLAG_HIDE;</a>
<a name="ln993">        flag[TILEP_PART_BODY]  = TILEP_FLAG_CUT_NAGA;</a>
<a name="ln994">    }</a>
<a name="ln995">    else if (is_player_tile(doll.parts[TILEP_PART_BASE], TILEP_BASE_CENTAUR))</a>
<a name="ln996">    {</a>
<a name="ln997">        flag[TILEP_PART_BOOTS] = flag[TILEP_PART_LEG] = TILEP_FLAG_HIDE;</a>
<a name="ln998">        flag[TILEP_PART_BODY]  = TILEP_FLAG_CUT_CENTAUR;</a>
<a name="ln999">    }</a>
<a name="ln1000">    else if (is_player_tile(doll.parts[TILEP_PART_BASE], TILEP_BASE_MERFOLK_WATER))</a>
<a name="ln1001">    {</a>
<a name="ln1002">        flag[TILEP_PART_BOOTS]  = TILEP_FLAG_HIDE;</a>
<a name="ln1003">        flag[TILEP_PART_LEG]    = TILEP_FLAG_HIDE;</a>
<a name="ln1004">        flag[TILEP_PART_SHADOW] = TILEP_FLAG_HIDE;</a>
<a name="ln1005">    }</a>
<a name="ln1006">    else if (doll.parts[TILEP_PART_BASE] &gt;= TILEP_BASE_DRACONIAN_FIRST</a>
<a name="ln1007">             &amp;&amp; doll.parts[TILEP_PART_BASE] &lt;= TILEP_BASE_DRACONIAN_LAST)</a>
<a name="ln1008">    {</a>
<a name="ln1009">        flag[TILEP_PART_HAIR] = TILEP_FLAG_HIDE;</a>
<a name="ln1010">    }</a>
<a name="ln1011">    else if (is_player_tile(doll.parts[TILEP_PART_BASE], TILEP_BASE_FELID))</a>
<a name="ln1012">    {</a>
<a name="ln1013">        flag[TILEP_PART_CLOAK] = TILEP_FLAG_HIDE;</a>
<a name="ln1014">        flag[TILEP_PART_BOOTS] = TILEP_FLAG_HIDE;</a>
<a name="ln1015">        flag[TILEP_PART_LEG]   = TILEP_FLAG_HIDE;</a>
<a name="ln1016">        flag[TILEP_PART_BODY]  = TILEP_FLAG_HIDE;</a>
<a name="ln1017">        flag[TILEP_PART_ARM]   = TILEP_FLAG_HIDE;</a>
<a name="ln1018">        if (!is_player_tile(doll.parts[TILEP_PART_HAND1],</a>
<a name="ln1019">                            TILEP_HAND1_BLADEHAND_FE))</a>
<a name="ln1020">        {</a>
<a name="ln1021">            flag[TILEP_PART_HAND1] = TILEP_FLAG_HIDE;</a>
<a name="ln1022">            flag[TILEP_PART_HAND2] = TILEP_FLAG_HIDE;</a>
<a name="ln1023">        }</a>
<a name="ln1024">        if (!is_player_tile(doll.parts[TILEP_PART_HELM], TILEP_HELM_HORNS_CAT))</a>
<a name="ln1025">            flag[TILEP_PART_HELM] = TILEP_FLAG_HIDE;</a>
<a name="ln1026">        flag[TILEP_PART_HAIR]  = TILEP_FLAG_HIDE;</a>
<a name="ln1027">        flag[TILEP_PART_BEARD] = TILEP_FLAG_HIDE;</a>
<a name="ln1028">        flag[TILEP_PART_SHADOW]= TILEP_FLAG_HIDE;</a>
<a name="ln1029">        flag[TILEP_PART_DRCWING]=TILEP_FLAG_HIDE;</a>
<a name="ln1030">        flag[TILEP_PART_DRCHEAD]=TILEP_FLAG_HIDE;</a>
<a name="ln1031">    }</a>
<a name="ln1032">    else if (is_player_tile(doll.parts[TILEP_PART_BASE], TILEP_BASE_OCTOPODE))</a>
<a name="ln1033">    {</a>
<a name="ln1034">        flag[TILEP_PART_CLOAK] = TILEP_FLAG_HIDE;</a>
<a name="ln1035">        flag[TILEP_PART_BOOTS] = TILEP_FLAG_HIDE;</a>
<a name="ln1036">        flag[TILEP_PART_LEG]   = TILEP_FLAG_HIDE;</a>
<a name="ln1037">        flag[TILEP_PART_BODY]  = TILEP_FLAG_HIDE;</a>
<a name="ln1038">        if (doll.parts[TILEP_PART_ARM] != TILEP_ARM_OCTOPODE_SPIKE)</a>
<a name="ln1039">            flag[TILEP_PART_ARM] = TILEP_FLAG_HIDE;</a>
<a name="ln1040">        flag[TILEP_PART_HAIR]  = TILEP_FLAG_HIDE;</a>
<a name="ln1041">        flag[TILEP_PART_BEARD] = TILEP_FLAG_HIDE;</a>
<a name="ln1042">        flag[TILEP_PART_SHADOW]= TILEP_FLAG_HIDE;</a>
<a name="ln1043">        flag[TILEP_PART_DRCWING]=TILEP_FLAG_HIDE;</a>
<a name="ln1044">        flag[TILEP_PART_DRCHEAD]=TILEP_FLAG_HIDE;</a>
<a name="ln1045">    }</a>
<a name="ln1046"> </a>
<a name="ln1047">    if (doll.parts[TILEP_PART_ARM] == TILEP_ARM_OCTOPODE_SPIKE</a>
<a name="ln1048">        &amp;&amp; !is_player_tile(doll.parts[TILEP_PART_BASE], TILEP_BASE_OCTOPODE))</a>
<a name="ln1049">    {</a>
<a name="ln1050">        flag[TILEP_PART_ARM] = TILEP_FLAG_HIDE;</a>
<a name="ln1051">    }</a>
<a name="ln1052">    if (is_player_tile(doll.parts[TILEP_PART_HELM], TILEP_HELM_HORNS_CAT)</a>
<a name="ln1053">        &amp;&amp; (!is_player_tile(doll.parts[TILEP_PART_BASE],</a>
<a name="ln1054">                            TILEP_BASE_FELID)</a>
<a name="ln1055">            &amp;&amp; (!is_player_tile(doll.parts[TILEP_PART_BASE],</a>
<a name="ln1056">                                TILEP_TRAN_STATUE_FELID)</a>
<a name="ln1057">            // Every felid tile has its own horns.</a>
<a name="ln1058">            || doll.parts[TILEP_PART_BASE] - TILEP_BASE_FELID</a>
<a name="ln1059">               != doll.parts[TILEP_PART_HELM] - TILEP_HELM_HORNS_CAT)))</a>
<a name="ln1060">    {</a>
<a name="ln1061">        flag[TILEP_PART_ARM] = TILEP_FLAG_HIDE;</a>
<a name="ln1062">    }</a>
<a name="ln1063">}</a>
<a name="ln1064"> </a>
<a name="ln1065">// Parts index to string</a>
<a name="ln1066">static void _tilep_part_to_str(int number, char *buf)</a>
<a name="ln1067">{</a>
<a name="ln1068">    //special</a>
<a name="ln1069">    if (number == TILEP_SHOW_EQUIP)</a>
<a name="ln1070">        buf[0] = buf[1] = buf[2] = '*';</a>
<a name="ln1071">    else</a>
<a name="ln1072">    {</a>
<a name="ln1073">        //normal 2 digits</a>
<a name="ln1074">        buf[0] = '0' + (number/100) % 10;</a>
<a name="ln1075">        buf[1] = '0' + (number/ 10) % 10;</a>
<a name="ln1076">        buf[2] = '0' +  number      % 10;</a>
<a name="ln1077">    }</a>
<a name="ln1078">    buf[3] = '\0';</a>
<a name="ln1079">}</a>
<a name="ln1080"> </a>
<a name="ln1081">// Parts string to index</a>
<a name="ln1082">static int _tilep_str_to_part(char *str)</a>
<a name="ln1083">{</a>
<a name="ln1084">    //special</a>
<a name="ln1085">    if (str[0] == '*')</a>
<a name="ln1086">        return TILEP_SHOW_EQUIP;</a>
<a name="ln1087"> </a>
<a name="ln1088">    //normal 3 digits</a>
<a name="ln1089">    return atoi(str);</a>
<a name="ln1090">}</a>
<a name="ln1091"> </a>
<a name="ln1092">// This order is to preserve dolls.txt integrity over multiple versions.</a>
<a name="ln1093">// Newer entries should be added to the end before the -1 terminator.</a>
<a name="ln1094">const int parts_saved[TILEP_PART_MAX + 1] =</a>
<a name="ln1095">{</a>
<a name="ln1096">    TILEP_PART_SHADOW,</a>
<a name="ln1097">    TILEP_PART_BASE,</a>
<a name="ln1098">    TILEP_PART_CLOAK,</a>
<a name="ln1099">    TILEP_PART_BOOTS,</a>
<a name="ln1100">    TILEP_PART_LEG,</a>
<a name="ln1101">    TILEP_PART_BODY,</a>
<a name="ln1102">    TILEP_PART_ARM,</a>
<a name="ln1103">    TILEP_PART_HAND1,</a>
<a name="ln1104">    TILEP_PART_HAND2,</a>
<a name="ln1105">    TILEP_PART_HAIR,</a>
<a name="ln1106">    TILEP_PART_BEARD,</a>
<a name="ln1107">    TILEP_PART_HELM,</a>
<a name="ln1108">    TILEP_PART_HALO,</a>
<a name="ln1109">    TILEP_PART_ENCH,</a>
<a name="ln1110">    TILEP_PART_DRCWING,</a>
<a name="ln1111">    TILEP_PART_DRCHEAD,</a>
<a name="ln1112">    -1</a>
<a name="ln1113">};</a>
<a name="ln1114"> </a>
<a name="ln1115">/*</a>
<a name="ln1116"> * scan input line from dolls.txt</a>
<a name="ln1117"> */</a>
<a name="ln1118">void tilep_scan_parts(char *fbuf, dolls_data &amp;doll, int species, int level)</a>
<a name="ln1119">{</a>
<a name="ln1120">    char  ibuf[8];</a>
<a name="ln1121"> </a>
<a name="ln1122">    int gcount = 0;</a>
<a name="ln1123">    int ccount = 0;</a>
<a name="ln1124">    for (int i = 0; parts_saved[i] != -1; ++i)</a>
<a name="ln1125">    {</a>
<a name="ln1126">        ccount = 0;</a>
<a name="ln1127">        int p = parts_saved[i];</a>
<a name="ln1128"> </a>
<a name="ln1129">        while (fbuf[gcount] != ':' &amp;&amp; fbuf[gcount] != '\n'</a>
<a name="ln1130">               &amp;&amp; ccount &lt; 4 &amp;&amp; gcount &lt; (i+1)*4)</a>
<a name="ln1131">        {</a>
<a name="ln1132">            ibuf[ccount++] = fbuf[gcount++];</a>
<a name="ln1133">        }</a>
<a name="ln1134"> </a>
<a name="ln1135">        ibuf[ccount] = '\0';</a>
<a name="ln1136">        gcount++;</a>
<a name="ln1137"> </a>
<a name="ln1138">        const tileidx_t idx = _tilep_str_to_part(ibuf);</a>
<a name="ln1139">        if (idx == TILEP_SHOW_EQUIP)</a>
<a name="ln1140">            doll.parts[p] = TILEP_SHOW_EQUIP;</a>
<a name="ln1141">        else if (p == TILEP_PART_BASE)</a>
<a name="ln1142">        {</a>
<a name="ln1143">            const tileidx_t base_tile = tilep_species_to_base_tile(species, level);</a>
<a name="ln1144">            if (idx &gt;= tile_player_count(base_tile))</a>
<a name="ln1145">                doll.parts[p] = base_tile;</a>
<a name="ln1146">            else</a>
<a name="ln1147">                doll.parts[p] = base_tile + idx;</a>
<a name="ln1148">        }</a>
<a name="ln1149">        else if (idx == 0)</a>
<a name="ln1150">            doll.parts[p] = 0;</a>
<a name="ln1151">        else if (idx &gt; tile_player_part_count[p])</a>
<a name="ln1152">            doll.parts[p] = tile_player_part_start[p];</a>
<a name="ln1153">        else</a>
<a name="ln1154">        {</a>
<a name="ln1155">            const tileidx_t idx2 = tile_player_part_start[p] + idx - 1;</a>
<a name="ln1156">            if (idx2 &lt; TILE_MAIN_MAX || idx2 &gt;= TILEP_PLAYER_MAX)</a>
<a name="ln1157">                doll.parts[p] = TILEP_SHOW_EQUIP;</a>
<a name="ln1158">            else</a>
<a name="ln1159">                doll.parts[p] = idx2;</a>
<a name="ln1160">        }</a>
<a name="ln1161">    }</a>
<a name="ln1162">}</a>
<a name="ln1163"> </a>
<a name="ln1164">/*</a>
<a name="ln1165"> * format-print parts</a>
<a name="ln1166"> */</a>
<a name="ln1167">void tilep_print_parts(char *fbuf, const dolls_data &amp;doll)</a>
<a name="ln1168">{</a>
<a name="ln1169">    char *ptr = fbuf;</a>
<a name="ln1170">    for (unsigned i = 0; parts_saved[i] != -1; ++i)</a>
<a name="ln1171">    {</a>
<a name="ln1172">        const int p = parts_saved[i];</a>
<a name="ln1173">        tileidx_t idx = doll.parts[p];</a>
<a name="ln1174">        if (idx != TILEP_SHOW_EQUIP)</a>
<a name="ln1175">        {</a>
<a name="ln1176">            if (p == TILEP_PART_BASE)</a>
<a name="ln1177">            {</a>
<a name="ln1178">                idx -= tilep_species_to_base_tile(you.species,</a>
<a name="ln1179">                                                  you.experience_level);</a>
<a name="ln1180">            }</a>
<a name="ln1181">            else if (idx != 0)</a>
<a name="ln1182">            {</a>
<a name="ln1183">                idx = doll.parts[p] - tile_player_part_start[p] + 1;</a>
<a name="ln1184">                if (idx &gt; tile_player_part_count[p])</a>
<a name="ln1185">                    idx = 0;</a>
<a name="ln1186">            }</a>
<a name="ln1187">        }</a>
<a name="ln1188">        _tilep_part_to_str(idx, ptr);</a>
<a name="ln1189"> </a>
<a name="ln1190">        ptr += 3;</a>
<a name="ln1191"> </a>
<a name="ln1192">        *ptr = ':';</a>
<a name="ln1193">        ptr++;</a>
<a name="ln1194">    }</a>
<a name="ln1195">    ptr[0] = '\n'; // erase the last ':'</a>
<a name="ln1196">    ptr[1] = 0;</a>
<a name="ln1197">}</a>
<a name="ln1198"> </a>
<a name="ln1199">#endif</a>

</code></pre>
<div class="balloon" rel="927"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v1037/" target="_blank">V1037</a> Two or more case-branches perform the same actions. Check lines: 927, 936</p></div>
<div class="balloon" rel="1129"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v781/" target="_blank">V781</a> The value of the 'gcount' index is checked after it was used. Perhaps there is a mistake in program logic.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
