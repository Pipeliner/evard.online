
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=US-ASCII" />
  <title>command.cc</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">/**</a>
<a name="ln2"> * @file</a>
<a name="ln3"> * @brief Misc commands.</a>
<a name="ln4">**/</a>
<a name="ln5"> </a>
<a name="ln6">#include &quot;AppHdr.h&quot;</a>
<a name="ln7"> </a>
<a name="ln8">#include &quot;command.h&quot;</a>
<a name="ln9"> </a>
<a name="ln10">#include &lt;cctype&gt;</a>
<a name="ln11">#include &lt;cinttypes&gt;</a>
<a name="ln12">#include &lt;cstdio&gt;</a>
<a name="ln13">#include &lt;cstring&gt;</a>
<a name="ln14">#include &lt;sstream&gt;</a>
<a name="ln15"> </a>
<a name="ln16">#include &quot;chardump.h&quot;</a>
<a name="ln17">#include &quot;database.h&quot;</a>
<a name="ln18">#include &quot;describe.h&quot;</a>
<a name="ln19">#include &quot;env.h&quot;</a>
<a name="ln20">#include &quot;files.h&quot;</a>
<a name="ln21">#include &quot;hints.h&quot;</a>
<a name="ln22">#include &quot;invent.h&quot;</a>
<a name="ln23">#include &quot;item-prop.h&quot;</a>
<a name="ln24">#include &quot;items.h&quot;</a>
<a name="ln25">#include &quot;libutil.h&quot;</a>
<a name="ln26">#include &quot;lookup-help.h&quot;</a>
<a name="ln27">#include &quot;macro.h&quot;</a>
<a name="ln28">#include &quot;message.h&quot;</a>
<a name="ln29">#include &quot;prompt.h&quot;</a>
<a name="ln30">#include &quot;scroller.h&quot;</a>
<a name="ln31">#include &quot;showsymb.h&quot;</a>
<a name="ln32">#include &quot;state.h&quot;</a>
<a name="ln33">#include &quot;stringutil.h&quot;</a>
<a name="ln34">#include &quot;syscalls.h&quot;</a>
<a name="ln35">#include &quot;unicode.h&quot;</a>
<a name="ln36">#include &quot;version.h&quot;</a>
<a name="ln37">#include &quot;viewchar.h&quot;</a>
<a name="ln38"> </a>
<a name="ln39">using namespace ui;</a>
<a name="ln40"> </a>
<a name="ln41">#ifdef USE_TILE</a>
<a name="ln42"> #include &quot;rltiles/tiledef-gui.h&quot;</a>
<a name="ln43">#endif</a>
<a name="ln44"> </a>
<a name="ln45">static const char *features[] =</a>
<a name="ln46">{</a>
<a name="ln47">#ifdef CLUA_BINDINGS</a>
<a name="ln48">    &quot;Lua user scripts&quot;,</a>
<a name="ln49">#endif</a>
<a name="ln50"> </a>
<a name="ln51">#ifdef USE_TILE_LOCAL</a>
<a name="ln52">    &quot;Tile support&quot;,</a>
<a name="ln53">#endif</a>
<a name="ln54"> </a>
<a name="ln55">#ifdef USE_TILE_WEB</a>
<a name="ln56">    &quot;Web Tile support&quot;,</a>
<a name="ln57">#endif</a>
<a name="ln58"> </a>
<a name="ln59">#ifdef WIZARD</a>
<a name="ln60">    &quot;Wizard mode&quot;,</a>
<a name="ln61">#endif</a>
<a name="ln62"> </a>
<a name="ln63">#ifdef DEBUG</a>
<a name="ln64">    &quot;Debug mode&quot;,</a>
<a name="ln65">#endif</a>
<a name="ln66"> </a>
<a name="ln67">#if defined(REGEX_POSIX)</a>
<a name="ln68">    &quot;POSIX regexps&quot;,</a>
<a name="ln69">#elif defined(REGEX_PCRE)</a>
<a name="ln70">    &quot;PCRE regexps&quot;,</a>
<a name="ln71">#else</a>
<a name="ln72">    &quot;Glob patterns&quot;,</a>
<a name="ln73">#endif</a>
<a name="ln74"> </a>
<a name="ln75">#if defined(USE_SOUND) &amp;&amp; defined(SOUND_BACKEND)</a>
<a name="ln76">    SOUND_BACKEND,</a>
<a name="ln77">#endif</a>
<a name="ln78"> </a>
<a name="ln79">#ifdef DGL_MILESTONES</a>
<a name="ln80">    &quot;Milestones&quot;,</a>
<a name="ln81">#endif</a>
<a name="ln82">};</a>
<a name="ln83"> </a>
<a name="ln84">static string _get_version_information()</a>
<a name="ln85">{</a>
<a name="ln86">    string result = string(&quot;This is &lt;w&gt;&quot; CRAWL &quot; &quot;) + Version::Long + &quot;&lt;/w&gt;&quot;;</a>
<a name="ln87">    return result;</a>
<a name="ln88">}</a>
<a name="ln89"> </a>
<a name="ln90">static string _get_version_features()</a>
<a name="ln91">{</a>
<a name="ln92">    string result;</a>
<a name="ln93">    if (crawl_state.need_save</a>
<a name="ln94">#ifdef DGAMELAUNCH</a>
<a name="ln95">        &amp;&amp; (you.wizard || crawl_state.type == GAME_TYPE_CUSTOM_SEED)</a>
<a name="ln96">#endif</a>
<a name="ln97">       )</a>
<a name="ln98">    {</a>
<a name="ln99">        if (you.fully_seeded)</a>
<a name="ln100">        {</a>
<a name="ln101">            result += make_stringf(</a>
<a name="ln102">                &quot;Game seed: %&quot; PRIu64 &quot;, levelgen mode: %s&quot;,</a>
<a name="ln103">                crawl_state.seed, you.deterministic_levelgen</a>
<a name="ln104">                                                ? &quot;deterministic&quot; : &quot;classic&quot;);</a>
<a name="ln105">            if (Version::history_size() &gt; 1)</a>
<a name="ln106">                result += &quot; (seed may be affected by game upgrades)&quot;;</a>
<a name="ln107">        }</a>
<a name="ln108">        else</a>
<a name="ln109">            result += &quot;Game is not seeded.&quot;;</a>
<a name="ln110">        result += &quot;\n\n&quot;;</a>
<a name="ln111">    }</a>
<a name="ln112">    if (Version::history_size() &gt; 1)</a>
<a name="ln113">    {</a>
<a name="ln114">        result += &quot;Version history for your current game:\n&quot;;</a>
<a name="ln115">        result += Version::history();</a>
<a name="ln116">        result += &quot;\n\n&quot;;</a>
<a name="ln117">    }</a>
<a name="ln118"> </a>
<a name="ln119">    result += &quot;&lt;w&gt;Features&lt;/w&gt;\n&quot;</a>
<a name="ln120">                 &quot;--------\n&quot;;</a>
<a name="ln121"> </a>
<a name="ln122">    for (const char *feature : features)</a>
<a name="ln123">    {</a>
<a name="ln124">        result += &quot; * &quot;;</a>
<a name="ln125">        result += feature;</a>
<a name="ln126">        result += &quot;\n&quot;;</a>
<a name="ln127">    }</a>
<a name="ln128"> </a>
<a name="ln129">    return result;</a>
<a name="ln130">}</a>
<a name="ln131"> </a>
<a name="ln132">static string _get_version_changes()</a>
<a name="ln133">{</a>
<a name="ln134">    // Attempts to print &quot;Highlights&quot; of the latest version.</a>
<a name="ln135">    FILE* fp = fopen_u(datafile_path(&quot;changelog.txt&quot;, false).c_str(), &quot;r&quot;);</a>
<a name="ln136">    if (!fp)</a>
<a name="ln137">        return &quot;&quot;;</a>
<a name="ln138"> </a>
<a name="ln139">    string result = &quot;&quot;;</a>
<a name="ln140">    string help;</a>
<a name="ln141">    char buf[200];</a>
<a name="ln142">    bool start = false;</a>
<a name="ln143">    while (fgets(buf, sizeof buf, fp))</a>
<a name="ln144">    {</a>
<a name="ln145">        // Remove trailing spaces.</a>
<a name="ln146">        for (int i = strlen(buf) - 1; i &gt;= 0; i++)</a>
<a name="ln147">        {</a>
<a name="ln148">            if (isspace(buf[i]))</a>
<a name="ln149">                buf[i] = 0;</a>
<a name="ln150">            else</a>
<a name="ln151">                break;</a>
<a name="ln152">        }</a>
<a name="ln153">        help = buf;</a>
<a name="ln154"> </a>
<a name="ln155">        // Look for version headings</a>
<a name="ln156">        if (starts_with(help, &quot;Stone Soup &quot;))</a>
<a name="ln157">        {</a>
<a name="ln158">            // Stop if this is for an older major version; otherwise, highlight</a>
<a name="ln159">            if (help.find(string(&quot;Stone Soup &quot;)+Version::Major) == string::npos)</a>
<a name="ln160">                break;</a>
<a name="ln161">            else</a>
<a name="ln162">                goto highlight;</a>
<a name="ln163">        }</a>
<a name="ln164"> </a>
<a name="ln165">        if (help.find(&quot;Highlights&quot;) != string::npos)</a>
<a name="ln166">        {</a>
<a name="ln167">        highlight:</a>
<a name="ln168">            // Highlight the Highlights, so to speak.</a>
<a name="ln169">            result += &quot;&lt;w&gt;&quot; + help + &quot;&lt;/w&gt;\n&quot;;</a>
<a name="ln170">            // And start printing from now on.</a>
<a name="ln171">            start = true;</a>
<a name="ln172">        }</a>
<a name="ln173">        else if (!start)</a>
<a name="ln174">            continue;</a>
<a name="ln175">        else</a>
<a name="ln176">        {</a>
<a name="ln177">            result += buf;</a>
<a name="ln178">            result += &quot;\n&quot;;</a>
<a name="ln179">        }</a>
<a name="ln180">    }</a>
<a name="ln181">    fclose(fp);</a>
<a name="ln182"> </a>
<a name="ln183">    // Did we ever get to print the Highlights?</a>
<a name="ln184">    if (start)</a>
<a name="ln185">    {</a>
<a name="ln186">        result.erase(1+result.find_last_not_of('\n'));</a>
<a name="ln187">        result += &quot;\n\n&quot;;</a>
<a name="ln188">        result += &quot;For earlier changes, see changelog.txt &quot;</a>
<a name="ln189">                  &quot;in the docs/ directory.&quot;;</a>
<a name="ln190">    }</a>
<a name="ln191">    else</a>
<a name="ln192">    {</a>
<a name="ln193">        result += &quot;For a list of changes, see changelog.txt in the docs/ &quot;</a>
<a name="ln194">                  &quot;directory.&quot;;</a>
<a name="ln195">    }</a>
<a name="ln196"> </a>
<a name="ln197">    return result;</a>
<a name="ln198">}</a>
<a name="ln199"> </a>
<a name="ln200">//#define DEBUG_FILES</a>
<a name="ln201">static void _print_version()</a>
<a name="ln202">{</a>
<a name="ln203">    const string info = _get_version_information(),</a>
<a name="ln204">          feats = _get_version_features(),</a>
<a name="ln205">          changes = _get_version_changes();</a>
<a name="ln206"> </a>
<a name="ln207">    auto vbox = make_shared&lt;Box&gt;(Widget::VERT);</a>
<a name="ln208"> </a>
<a name="ln209">#ifdef USE_TILE_LOCAL</a>
<a name="ln210">    vbox-&gt;max_size().width = tiles.get_crt_font()-&gt;char_width()*80;</a>
<a name="ln211">#endif</a>
<a name="ln212"> </a>
<a name="ln213">    auto title_hbox = make_shared&lt;Box&gt;(Widget::HORZ);</a>
<a name="ln214">#ifdef USE_TILE</a>
<a name="ln215">    auto icon = make_shared&lt;Image&gt;();</a>
<a name="ln216">    icon-&gt;set_tile(tile_def(TILEG_STARTUP_STONESOUP, TEX_GUI));</a>
<a name="ln217">    title_hbox-&gt;add_child(move(icon));</a>
<a name="ln218">#endif</a>
<a name="ln219"> </a>
<a name="ln220">    auto title = make_shared&lt;Text&gt;(formatted_string::parse_string(info));</a>
<a name="ln221">    title-&gt;set_margin_for_sdl(0, 0, 0, 10);</a>
<a name="ln222">    title_hbox-&gt;add_child(move(title));</a>
<a name="ln223"> </a>
<a name="ln224">    title_hbox-&gt;set_cross_alignment(Widget::CENTER);</a>
<a name="ln225">    title_hbox-&gt;set_margin_for_crt(0, 0, 1, 0);</a>
<a name="ln226">    title_hbox-&gt;set_margin_for_sdl(0, 0, 20, 0);</a>
<a name="ln227">    vbox-&gt;add_child(move(title_hbox));</a>
<a name="ln228"> </a>
<a name="ln229">    auto scroller = make_shared&lt;Scroller&gt;();</a>
<a name="ln230">    auto content = formatted_string::parse_string(feats + &quot;\n\n&quot; + changes);</a>
<a name="ln231">    auto text = make_shared&lt;Text&gt;(move(content));</a>
<a name="ln232">    text-&gt;set_wrap_text(true);</a>
<a name="ln233">    scroller-&gt;set_child(move(text));</a>
<a name="ln234">    vbox-&gt;add_child(scroller);</a>
<a name="ln235"> </a>
<a name="ln236">    auto popup = make_shared&lt;ui::Popup&gt;(vbox);</a>
<a name="ln237"> </a>
<a name="ln238">    bool done = false;</a>
<a name="ln239">    popup-&gt;on_keydown_event([&amp;](const KeyEvent&amp; ev) {</a>
<a name="ln240">        done = !scroller-&gt;on_event(ev);</a>
<a name="ln241">        return true;</a>
<a name="ln242">    });</a>
<a name="ln243"> </a>
<a name="ln244">#ifdef USE_TILE_WEB</a>
<a name="ln245">    tiles.json_open_object();</a>
<a name="ln246">    tiles.json_write_string(&quot;information&quot;, info);</a>
<a name="ln247">    tiles.json_write_string(&quot;features&quot;, feats);</a>
<a name="ln248">    tiles.json_write_string(&quot;changes&quot;, changes);</a>
<a name="ln249">    tiles.push_ui_layout(&quot;version&quot;, 0);</a>
<a name="ln250">    popup-&gt;on_layout_pop([](){ tiles.pop_ui_layout(); });</a>
<a name="ln251">#endif</a>
<a name="ln252"> </a>
<a name="ln253">    ui::run_layout(move(popup), done);</a>
<a name="ln254">}</a>
<a name="ln255"> </a>
<a name="ln256">void list_armour()</a>
<a name="ln257">{</a>
<a name="ln258">    ostringstream estr;</a>
<a name="ln259">    for (int j = EQ_MIN_ARMOUR; j &lt;= EQ_MAX_ARMOUR; j++)</a>
<a name="ln260">    {</a>
<a name="ln261">        const equipment_type i = static_cast&lt;equipment_type&gt;(j);</a>
<a name="ln262">        const int armour_id = you.equip[i];</a>
<a name="ln263">        int       colour    = MSGCOL_BLACK;</a>
<a name="ln264"> </a>
<a name="ln265">        estr.str(&quot;&quot;);</a>
<a name="ln266">        estr.clear();</a>
<a name="ln267"> </a>
<a name="ln268">        estr &lt;&lt; ((i == EQ_CLOAK)       ? &quot;Cloak  &quot; :</a>
<a name="ln269">                 (i == EQ_HELMET)      ? &quot;Helmet &quot; :</a>
<a name="ln270">                 (i == EQ_GLOVES)      ? &quot;Gloves &quot; :</a>
<a name="ln271">                 (i == EQ_SHIELD)      ? &quot;Shield &quot; :</a>
<a name="ln272">                 (i == EQ_BODY_ARMOUR) ? &quot;Armour &quot; :</a>
<a name="ln273">                 (i == EQ_BOOTS) ?</a>
<a name="ln274">                 ((you.species == SP_CENTAUR</a>
<a name="ln275">                   || you.species == SP_NAGA) ? &quot;Barding&quot;</a>
<a name="ln276">                                              : &quot;Boots  &quot;)</a>
<a name="ln277">                                 : &quot;unknown&quot;)</a>
<a name="ln278">             &lt;&lt; &quot; : &quot;;</a>
<a name="ln279"> </a>
<a name="ln280">        if (you_can_wear(i) == MB_FALSE)</a>
<a name="ln281">            estr &lt;&lt; &quot;    (unavailable)&quot;;</a>
<a name="ln282">        else if (you_can_wear(i, true) == MB_FALSE)</a>
<a name="ln283">            estr &lt;&lt; &quot;    (currently unavailable)&quot;;</a>
<a name="ln284">        else if (armour_id != -1)</a>
<a name="ln285">        {</a>
<a name="ln286">            estr &lt;&lt; you.inv[armour_id].name(DESC_INVENTORY);</a>
<a name="ln287">            colour = menu_colour(estr.str(), item_prefix(you.inv[armour_id]),</a>
<a name="ln288">                                 &quot;equip&quot;);</a>
<a name="ln289">        }</a>
<a name="ln290">        else if (you_can_wear(i) == MB_MAYBE)</a>
<a name="ln291">            estr &lt;&lt; &quot;    (restricted)&quot;;</a>
<a name="ln292">        else</a>
<a name="ln293">            estr &lt;&lt; &quot;    none&quot;;</a>
<a name="ln294"> </a>
<a name="ln295">        if (colour == MSGCOL_BLACK)</a>
<a name="ln296">            colour = menu_colour(estr.str(), &quot;&quot;, &quot;equip&quot;);</a>
<a name="ln297"> </a>
<a name="ln298">        mprf(MSGCH_EQUIPMENT, colour, &quot;%s&quot;, estr.str().c_str());</a>
<a name="ln299">    }</a>
<a name="ln300">}</a>
<a name="ln301"> </a>
<a name="ln302">void list_jewellery()</a>
<a name="ln303">{</a>
<a name="ln304">    string jstr;</a>
<a name="ln305">    int cols = get_number_of_cols() - 1;</a>
<a name="ln306">    bool split = you.species == SP_OCTOPODE &amp;&amp; cols &gt; 84;</a>
<a name="ln307"> </a>
<a name="ln308">    for (int j = EQ_LEFT_RING; j &lt; NUM_EQUIP; j++)</a>
<a name="ln309">    {</a>
<a name="ln310">        const equipment_type i = static_cast&lt;equipment_type&gt;(j);</a>
<a name="ln311">        if (!you_can_wear(i))</a>
<a name="ln312">            continue;</a>
<a name="ln313"> </a>
<a name="ln314">        const int jewellery_id = you.equip[i];</a>
<a name="ln315">        int       colour       = MSGCOL_BLACK;</a>
<a name="ln316"> </a>
<a name="ln317">        const char *slot =</a>
<a name="ln318">                 (i == EQ_LEFT_RING)   ? &quot;Left ring&quot; :</a>
<a name="ln319">                 (i == EQ_RIGHT_RING)  ? &quot;Right ring&quot; :</a>
<a name="ln320">                 (i == EQ_AMULET)      ? &quot;Amulet&quot; :</a>
<a name="ln321">                 (i == EQ_RING_ONE)    ? &quot;1st ring&quot; :</a>
<a name="ln322">                 (i == EQ_RING_TWO)    ? &quot;2nd ring&quot; :</a>
<a name="ln323">                 (i == EQ_RING_THREE)  ? &quot;3rd ring&quot; :</a>
<a name="ln324">                 (i == EQ_RING_FOUR)   ? &quot;4th ring&quot; :</a>
<a name="ln325">                 (i == EQ_RING_FIVE)   ? &quot;5th ring&quot; :</a>
<a name="ln326">                 (i == EQ_RING_SIX)    ? &quot;6th ring&quot; :</a>
<a name="ln327">                 (i == EQ_RING_SEVEN)  ? &quot;7th ring&quot; :</a>
<a name="ln328">                 (i == EQ_RING_EIGHT)  ? &quot;8th ring&quot; :</a>
<a name="ln329">                 (i == EQ_RING_AMULET) ? &quot;Amulet ring&quot;</a>
<a name="ln330">                                       : &quot;unknown&quot;;</a>
<a name="ln331"> </a>
<a name="ln332">        string item;</a>
<a name="ln333">        if (you_can_wear(i, true) == MB_FALSE)</a>
<a name="ln334">            item = &quot;    (currently unavailable)&quot;;</a>
<a name="ln335">        else if (jewellery_id != -1)</a>
<a name="ln336">        {</a>
<a name="ln337">            item = you.inv[jewellery_id].name(DESC_INVENTORY);</a>
<a name="ln338">            string prefix = item_prefix(you.inv[jewellery_id]);</a>
<a name="ln339">            colour = menu_colour(item, prefix, &quot;equip&quot;);</a>
<a name="ln340">        }</a>
<a name="ln341">        else</a>
<a name="ln342">            item = &quot;    none&quot;;</a>
<a name="ln343"> </a>
<a name="ln344">        if (colour == MSGCOL_BLACK)</a>
<a name="ln345">            colour = menu_colour(item, &quot;&quot;, &quot;equip&quot;);</a>
<a name="ln346"> </a>
<a name="ln347">        item = chop_string(make_stringf(&quot;%-*s: %s&quot;,</a>
<a name="ln348">                                        split ? cols &gt; 96 ? 9 : 8 : 11,</a>
<a name="ln349">                                        slot, item.c_str()),</a>
<a name="ln350">                           split &amp;&amp; i &gt; EQ_AMULET ? (cols - 1) / 2 : cols);</a>
<a name="ln351">        item = colour_string(item, colour);</a>
<a name="ln352"> </a>
<a name="ln353">        if (i == EQ_RING_SEVEN &amp;&amp; you.species == SP_OCTOPODE &amp;&amp;</a>
<a name="ln354">                you.get_mutation_level(MUT_MISSING_HAND))</a>
<a name="ln355">        {</a>
<a name="ln356">            mprf(MSGCH_EQUIPMENT, &quot;%s&quot;, item.c_str());</a>
<a name="ln357">        }</a>
<a name="ln358">        else if (split &amp;&amp; i &gt; EQ_AMULET &amp;&amp; (i - EQ_AMULET) % 2)</a>
<a name="ln359">            jstr = item + &quot; &quot;;</a>
<a name="ln360">        else</a>
<a name="ln361">            mprf(MSGCH_EQUIPMENT, &quot;%s%s&quot;, jstr.c_str(), item.c_str());</a>
<a name="ln362">    }</a>
<a name="ln363">}</a>
<a name="ln364"> </a>
<a name="ln365">static const char *targeting_help_1 =</a>
<a name="ln366">    &quot;&lt;h&gt;Examine surroundings ('&lt;w&gt;x&lt;/w&gt;&lt;h&gt;' in main):\n&quot;</a>
<a name="ln367">    &quot;&lt;w&gt;Esc&lt;/w&gt; : cancel (also &lt;w&gt;Space&lt;/w&gt;, &lt;w&gt;x&lt;/w&gt;)\n&quot;</a>
<a name="ln368">    &quot;&lt;w&gt;Dir.&lt;/w&gt;: move cursor in that direction\n&quot;</a>
<a name="ln369">    &quot;&lt;w&gt;.&lt;/w&gt; : move to cursor (also &lt;w&gt;Enter&lt;/w&gt;, &lt;w&gt;Del&lt;/w&gt;)\n&quot;</a>
<a name="ln370">    &quot;&lt;w&gt;g&lt;/w&gt; : pick up item at cursor\n&quot;</a>
<a name="ln371">    &quot;&lt;w&gt;v&lt;/w&gt; : describe monster under cursor\n&quot;</a>
<a name="ln372">    &quot;&lt;w&gt;+&lt;/w&gt; : cycle monsters forward (also &lt;w&gt;=&lt;/w&gt;)\n&quot;</a>
<a name="ln373">    &quot;&lt;w&gt;-&lt;/w&gt; : cycle monsters backward\n&quot;</a>
<a name="ln374">    &quot;&lt;w&gt;*&lt;/w&gt; : cycle objects forward (also &lt;w&gt;'&lt;/w&gt;)\n&quot;</a>
<a name="ln375">    &quot;&lt;w&gt;/&lt;/w&gt; : cycle objects backward (also &lt;w&gt;;&lt;/w&gt;)\n&quot;</a>
<a name="ln376">    &quot;&lt;w&gt;^&lt;/w&gt; : cycle through traps\n&quot;</a>
<a name="ln377">    &quot;&lt;w&gt;_&lt;/w&gt; : cycle through altars\n&quot;</a>
<a name="ln378">    &quot;&lt;w&gt;&lt;&lt;&lt;/w&gt;/&lt;w&gt;&gt;&lt;/w&gt; : cycle through up/down stairs\n&quot;</a>
<a name="ln379">    &quot;&lt;w&gt;Tab&lt;/w&gt; : cycle through shops and portals\n&quot;</a>
<a name="ln380">    &quot;&lt;w&gt;r&lt;/w&gt; : move cursor to you\n&quot;</a>
<a name="ln381">    &quot;&lt;w&gt;e&lt;/w&gt; : create/remove travel exclusion\n&quot;</a>
<a name="ln382">    &quot;&lt;w&gt;Ctrl-P&lt;/w&gt; : repeat prompt\n&quot;</a>
<a name="ln383">;</a>
<a name="ln384">#ifdef WIZARD</a>
<a name="ln385">static const char *targeting_help_wiz =</a>
<a name="ln386">    &quot;&lt;h&gt;Wizard targeting commands:&lt;/h&gt;\n&quot;</a>
<a name="ln387">    &quot;&lt;w&gt;Ctrl-C&lt;/w&gt; : cycle through beam paths\n&quot;</a>
<a name="ln388">    &quot;&lt;w&gt;D&lt;/w&gt;: get debugging information about the monster\n&quot;</a>
<a name="ln389">    &quot;&lt;w&gt;o&lt;/w&gt;: give item to monster\n&quot;</a>
<a name="ln390">    &quot;&lt;w&gt;F&lt;/w&gt;: cycle monster friendly/good neutral/neutral/hostile\n&quot;</a>
<a name="ln391">    &quot;&lt;w&gt;G&lt;/w&gt;: make monster gain experience\n&quot;</a>
<a name="ln392">    &quot;&lt;w&gt;Ctrl-H&lt;/w&gt;: heal the monster fully\n&quot;</a>
<a name="ln393">    &quot;&lt;w&gt;P&lt;/w&gt;: apply divine blessing to monster\n&quot;</a>
<a name="ln394">    &quot;&lt;w&gt;m&lt;/w&gt;: move monster or player\n&quot;</a>
<a name="ln395">    &quot;&lt;w&gt;M&lt;/w&gt;: cause spell miscast for monster or player\n&quot;</a>
<a name="ln396">    &quot;&lt;w&gt;s&lt;/w&gt;: force monster to shout or speak\n&quot;</a>
<a name="ln397">    &quot;&lt;w&gt;S&lt;/w&gt;: make monster a summoned monster\n&quot;</a>
<a name="ln398">    &quot;&lt;w&gt;w&lt;/w&gt;: calculate shortest path to any point on the map\n&quot;</a>
<a name="ln399">    &quot;&lt;w&gt;\&quot;&lt;/w&gt;: get debugging information about a portal\n&quot;</a>
<a name="ln400">    &quot;&lt;w&gt;~&lt;/w&gt;: polymorph monster to specific type\n&quot;</a>
<a name="ln401">    &quot;&lt;w&gt;,&lt;/w&gt;: bring down the monster to 1 hp\n&quot;</a>
<a name="ln402">    &quot;&lt;w&gt;(&lt;/w&gt;: place a mimic\n&quot;</a>
<a name="ln403">    &quot;&lt;w&gt;Ctrl-B&lt;/w&gt;: banish monster\n&quot;</a>
<a name="ln404">    &quot;&lt;w&gt;Ctrl-K&lt;/w&gt;: kill monster\n&quot;</a>
<a name="ln405">;</a>
<a name="ln406">#endif</a>
<a name="ln407"> </a>
<a name="ln408">static const char *targeting_help_2 =</a>
<a name="ln409">    &quot;&lt;h&gt;Targeting (zap wands, cast spells, etc.):\n&quot;</a>
<a name="ln410">    &quot;Most keys from examine surroundings work.\n&quot;</a>
<a name="ln411">    &quot;Some keys fire at the target. By default,\n&quot;</a>
<a name="ln412">    &quot;range is respected and beams don't stop.\n&quot;</a>
<a name="ln413">    &quot;&lt;w&gt;Enter&lt;/w&gt; : fire (&lt;w&gt;Space&lt;/w&gt;, &lt;w&gt;Del&lt;/w&gt;)\n&quot;</a>
<a name="ln414">    &quot;&lt;w&gt;.&lt;/w&gt; : fire, stop at target\n&quot;</a>
<a name="ln415">    &quot;&lt;w&gt;@&lt;/w&gt; : fire, stop at target, ignore range\n&quot;</a>
<a name="ln416">    &quot;&lt;w&gt;!&lt;/w&gt; : fire, don't stop, ignore range\n&quot;</a>
<a name="ln417">    &quot;&lt;w&gt;p&lt;/w&gt; : fire at Previous target (also &lt;w&gt;f&lt;/w&gt;)\n&quot;</a>
<a name="ln418">    &quot;&lt;w&gt;:&lt;/w&gt; : show/hide beam path\n&quot;</a>
<a name="ln419">    &quot;&lt;w&gt;Shift-Dir.&lt;/w&gt; : fire straight-line beam\n&quot;</a>
<a name="ln420">    &quot;\n&quot;</a>
<a name="ln421">    &quot;&lt;h&gt;Firing or throwing a missile:\n&quot;</a>
<a name="ln422">    &quot;&lt;w&gt;(&lt;/w&gt; : cycle to next suitable missile.\n&quot;</a>
<a name="ln423">    &quot;&lt;w&gt;)&lt;/w&gt; : cycle to previous suitable missile.\n&quot;</a>
<a name="ln424">    &quot;&lt;w&gt;i&lt;/w&gt; : choose from Inventory.\n&quot;</a>
<a name="ln425">;</a>
<a name="ln426"> </a>
<a name="ln427">struct help_file</a>
<a name="ln428">{</a>
<a name="ln429">    const char* name;</a>
<a name="ln430">    int hotkey;</a>
<a name="ln431">    bool auto_hotkey;</a>
<a name="ln432">};</a>
<a name="ln433"> </a>
<a name="ln434">static help_file help_files[] =</a>
<a name="ln435">{</a>
<a name="ln436">    { &quot;crawl_manual.txt&quot;,  '*', true },</a>
<a name="ln437">    { &quot;aptitudes.txt&quot;,     '%', false },</a>
<a name="ln438">    { &quot;quickstart.txt&quot;,    '^', false },</a>
<a name="ln439">    { &quot;macros_guide.txt&quot;,  '~', false },</a>
<a name="ln440">    { &quot;options_guide.txt&quot;, '&amp;', false },</a>
<a name="ln441">#ifdef USE_TILE_LOCAL</a>
<a name="ln442">    { &quot;tiles_help.txt&quot;,    't', false },</a>
<a name="ln443">#endif</a>
<a name="ln444">    { nullptr, 0, false }</a>
<a name="ln445">};</a>
<a name="ln446"> </a>
<a name="ln447">// Reads all questions from database/FAQ.txt, outputs them in the form of</a>
<a name="ln448">// a selectable menu and prints the corresponding answer for a chosen question.</a>
<a name="ln449">static void _handle_FAQ()</a>
<a name="ln450">{</a>
<a name="ln451">    vector&lt;string&gt; question_keys = getAllFAQKeys();</a>
<a name="ln452">    if (question_keys.empty())</a>
<a name="ln453">    {</a>
<a name="ln454">        mpr(&quot;No questions found in FAQ! Please submit a bug report!&quot;);</a>
<a name="ln455">        return;</a>
<a name="ln456">    }</a>
<a name="ln457">    Menu FAQmenu(MF_SINGLESELECT | MF_ANYPRINTABLE | MF_ALLOW_FORMATTING);</a>
<a name="ln458">    MenuEntry *title = new MenuEntry(&quot;Frequently Asked Questions&quot;);</a>
<a name="ln459">    title-&gt;colour = YELLOW;</a>
<a name="ln460">    FAQmenu.set_title(title);</a>
<a name="ln461"> </a>
<a name="ln462">    for (unsigned int i = 0, size = question_keys.size(); i &lt; size; i++)</a>
<a name="ln463">    {</a>
<a name="ln464">        const char letter = index_to_letter(i);</a>
<a name="ln465">        string question = getFAQ_Question(question_keys[i]);</a>
<a name="ln466">        trim_string_right(question);</a>
<a name="ln467">        MenuEntry *me = new MenuEntry(question, MEL_ITEM, 1, letter);</a>
<a name="ln468">        me-&gt;data = &amp;question_keys[i];</a>
<a name="ln469">        FAQmenu.add_entry(me);</a>
<a name="ln470">    }</a>
<a name="ln471"> </a>
<a name="ln472">    while (true)</a>
<a name="ln473">    {</a>
<a name="ln474">        vector&lt;MenuEntry*&gt; sel = FAQmenu.show();</a>
<a name="ln475">        if (sel.empty())</a>
<a name="ln476">            return;</a>
<a name="ln477">        else</a>
<a name="ln478">        {</a>
<a name="ln479">            ASSERT(sel.size() == 1);</a>
<a name="ln480">            ASSERT(sel[0]-&gt;hotkeys.size() == 1);</a>
<a name="ln481"> </a>
<a name="ln482">            string key = *((string*) sel[0]-&gt;data);</a>
<a name="ln483">            string answer = getFAQ_Answer(key);</a>
<a name="ln484">            if (answer.empty())</a>
<a name="ln485">            {</a>
<a name="ln486">                answer = &quot;No answer found in the FAQ! Please submit a &quot;</a>
<a name="ln487">                         &quot;bug report!&quot;;</a>
<a name="ln488">            }</a>
<a name="ln489">            answer = &quot;Q: &quot; + getFAQ_Question(key) + &quot;\n&quot; + answer;</a>
<a name="ln490">            show_description(answer);</a>
<a name="ln491">        }</a>
<a name="ln492">    }</a>
<a name="ln493"> </a>
<a name="ln494">    return;</a>
<a name="ln495">}</a>
<a name="ln496"> </a>
<a name="ln497">////////////////////////////////////////////////////////////////////////////</a>
<a name="ln498"> </a>
<a name="ln499">int show_keyhelp_menu(const vector&lt;formatted_string&gt; &amp;lines)</a>
<a name="ln500">{</a>
<a name="ln501">    int flags = FS_PREWRAPPED_TEXT | FS_EASY_EXIT;</a>
<a name="ln502">    formatted_scroller cmd_help(flags);</a>
<a name="ln503">    cmd_help.set_tag(&quot;help&quot;);</a>
<a name="ln504">    cmd_help.set_more();</a>
<a name="ln505"> </a>
<a name="ln506">    for (unsigned i = 0; i &lt; lines.size(); ++i)</a>
<a name="ln507">        cmd_help.add_formatted_string(lines[i], i &lt; lines.size()-1);</a>
<a name="ln508"> </a>
<a name="ln509">    cmd_help.show();</a>
<a name="ln510"> </a>
<a name="ln511">    return cmd_help.get_lastch();</a>
<a name="ln512">}</a>
<a name="ln513"> </a>
<a name="ln514">void show_specific_help(const string &amp;key)</a>
<a name="ln515">{</a>
<a name="ln516">    string help = getHelpString(key);</a>
<a name="ln517">    trim_string_right(help);</a>
<a name="ln518">    vector&lt;formatted_string&gt; formatted_lines;</a>
<a name="ln519">    for (const string &amp;line : split_string(&quot;\n&quot;, help, false, true))</a>
<a name="ln520">        formatted_lines.push_back(formatted_string::parse_string(line));</a>
<a name="ln521">    show_keyhelp_menu(formatted_lines);</a>
<a name="ln522">}</a>
<a name="ln523"> </a>
<a name="ln524">void show_levelmap_help()</a>
<a name="ln525">{</a>
<a name="ln526">    show_specific_help(&quot;level-map&quot;);</a>
<a name="ln527">}</a>
<a name="ln528"> </a>
<a name="ln529">void show_targeting_help()</a>
<a name="ln530">{</a>
<a name="ln531">    column_composer cols(2, 40);</a>
<a name="ln532">    cols.add_formatted(0, targeting_help_1, true);</a>
<a name="ln533">#ifdef WIZARD</a>
<a name="ln534">    if (you.wizard)</a>
<a name="ln535">        cols.add_formatted(0, targeting_help_wiz, true);</a>
<a name="ln536">#endif</a>
<a name="ln537">    cols.add_formatted(1, targeting_help_2, true);</a>
<a name="ln538">    show_keyhelp_menu(cols.formatted_lines());</a>
<a name="ln539">}</a>
<a name="ln540">void show_interlevel_travel_branch_help()</a>
<a name="ln541">{</a>
<a name="ln542">    show_specific_help(&quot;interlevel-travel.branch.prompt&quot;);</a>
<a name="ln543">}</a>
<a name="ln544"> </a>
<a name="ln545">void show_interlevel_travel_depth_help()</a>
<a name="ln546">{</a>
<a name="ln547">    show_specific_help(&quot;interlevel-travel.depth.prompt&quot;);</a>
<a name="ln548">}</a>
<a name="ln549"> </a>
<a name="ln550">void show_interlevel_travel_altar_help()</a>
<a name="ln551">{</a>
<a name="ln552">    show_specific_help(&quot;interlevel-travel.altar.prompt&quot;);</a>
<a name="ln553">}</a>
<a name="ln554"> </a>
<a name="ln555">void show_stash_search_help()</a>
<a name="ln556">{</a>
<a name="ln557">    show_specific_help(&quot;stash-search.prompt&quot;);</a>
<a name="ln558">}</a>
<a name="ln559"> </a>
<a name="ln560">void show_butchering_help()</a>
<a name="ln561">{</a>
<a name="ln562">    show_specific_help(&quot;butchering&quot;);</a>
<a name="ln563">}</a>
<a name="ln564"> </a>
<a name="ln565">void show_skill_menu_help()</a>
<a name="ln566">{</a>
<a name="ln567">    show_specific_help(&quot;skill-menu&quot;);</a>
<a name="ln568">}</a>
<a name="ln569"> </a>
<a name="ln570">void show_spell_library_help()</a>
<a name="ln571">{</a>
<a name="ln572">    if (crawl_state.game_is_hints_tutorial())</a>
<a name="ln573">    {</a>
<a name="ln574">        const string help1 = hints_memorise_info() + &quot;\n\n&quot;;</a>
<a name="ln575">        vector&lt;formatted_string&gt; formatted_lines;</a>
<a name="ln576">        for (const string &amp;line : split_string(&quot;\n&quot;, help1, false, true))</a>
<a name="ln577">        {</a>
<a name="ln578">            formatted_lines.push_back(formatted_string::parse_string(line,</a>
<a name="ln579">                                        channel_to_colour(MSGCH_TUTORIAL)));</a>
<a name="ln580">        }</a>
<a name="ln581">        const string help2 = getHelpString(&quot;spell-library&quot;);</a>
<a name="ln582">        for (const string &amp;line : split_string(&quot;\n&quot;, help2, false, true))</a>
<a name="ln583">            formatted_lines.push_back(formatted_string::parse_string(line));</a>
<a name="ln584">        show_keyhelp_menu(formatted_lines);</a>
<a name="ln585">    }</a>
<a name="ln586">    else</a>
<a name="ln587">        show_specific_help(&quot;spell-library&quot;);</a>
<a name="ln588">}</a>
<a name="ln589"> </a>
<a name="ln590">static void _add_command(column_composer &amp;cols, const int column,</a>
<a name="ln591">                         const command_type cmd,</a>
<a name="ln592">                         const string &amp;desc,</a>
<a name="ln593">                         const unsigned int space_to_colon = 7)</a>
<a name="ln594">{</a>
<a name="ln595">    string command_name = command_to_string(cmd);</a>
<a name="ln596">    if (strcmp(command_name.c_str(), &quot;&lt;&quot;) == 0)</a>
<a name="ln597">        command_name += &quot;&lt;&quot;;</a>
<a name="ln598"> </a>
<a name="ln599">    const int cmd_len = strwidth(command_name);</a>
<a name="ln600">    string line = &quot;&lt;w&gt;&quot; + command_name + &quot;&lt;/w&gt;&quot;;</a>
<a name="ln601">    for (unsigned int i = cmd_len; i &lt; space_to_colon; ++i)</a>
<a name="ln602">        line += &quot; &quot;;</a>
<a name="ln603">    line += &quot;: &quot; + untag_tiles_console(desc) + &quot;\n&quot;;</a>
<a name="ln604"> </a>
<a name="ln605">    cols.add_formatted(</a>
<a name="ln606">            column,</a>
<a name="ln607">            line.c_str(),</a>
<a name="ln608">            false);</a>
<a name="ln609">}</a>
<a name="ln610"> </a>
<a name="ln611">static void _add_insert_commands(column_composer &amp;cols, const int column,</a>
<a name="ln612">                                 const unsigned int space_to_colon,</a>
<a name="ln613">                                 command_type lead_cmd, string desc,</a>
<a name="ln614">                                 const vector&lt;command_type&gt; &amp;cmd_vector)</a>
<a name="ln615">{</a>
<a name="ln616">    insert_commands(desc, cmd_vector);</a>
<a name="ln617">    desc += &quot;\n&quot;;</a>
<a name="ln618">    _add_command(cols, column, lead_cmd, desc, space_to_colon);</a>
<a name="ln619">}</a>
<a name="ln620"> </a>
<a name="ln621">static void _add_insert_commands(column_composer &amp;cols, const int column,</a>
<a name="ln622">                                 string desc,</a>
<a name="ln623">                                 const vector&lt;command_type&gt; &amp;cmd_vector)</a>
<a name="ln624">{</a>
<a name="ln625">    insert_commands(desc, cmd_vector);</a>
<a name="ln626">    desc += &quot;\n&quot;;</a>
<a name="ln627">    cols.add_formatted(column, desc.c_str(), false);</a>
<a name="ln628">}</a>
<a name="ln629"> </a>
<a name="ln630">static void _add_formatted_help_menu(column_composer &amp;cols)</a>
<a name="ln631">{</a>
<a name="ln632">    cols.add_formatted(</a>
<a name="ln633">        0,</a>
<a name="ln634">        &quot;&lt;h&gt;Dungeon Crawl Help\n&quot;</a>
<a name="ln635">        &quot;\n&quot;</a>
<a name="ln636">        &quot;Press one of the following keys to\n&quot;</a>
<a name="ln637">        &quot;obtain more information on a certain\n&quot;</a>
<a name="ln638">        &quot;aspect of Dungeon Crawl.\n&quot;</a>
<a name="ln639"> </a>
<a name="ln640">        &quot;&lt;w&gt;?&lt;/w&gt;: List of commands\n&quot;</a>
<a name="ln641">        &quot;&lt;w&gt;^&lt;/w&gt;: Quickstart Guide\n&quot;</a>
<a name="ln642">        &quot;&lt;w&gt;:&lt;/w&gt;: Browse character notes\n&quot;</a>
<a name="ln643">        &quot;&lt;w&gt;#&lt;/w&gt;: Browse character dump\n&quot;</a>
<a name="ln644">        &quot;&lt;w&gt;~&lt;/w&gt;: Macros help\n&quot;</a>
<a name="ln645">        &quot;&lt;w&gt;&amp;&lt;/w&gt;: Options help\n&quot;</a>
<a name="ln646">        &quot;&lt;w&gt;%&lt;/w&gt;: Table of aptitudes\n&quot;</a>
<a name="ln647">        &quot;&lt;w&gt;/&lt;/w&gt;: Lookup description\n&quot;</a>
<a name="ln648">        &quot;&lt;w&gt;Q&lt;/w&gt;: FAQ\n&quot;</a>
<a name="ln649">#ifdef USE_TILE_LOCAL</a>
<a name="ln650">        &quot;&lt;w&gt;T&lt;/w&gt;: Tiles key help\n&quot;</a>
<a name="ln651">#endif</a>
<a name="ln652">        &quot;&lt;w&gt;V&lt;/w&gt;: Version information\n&quot;</a>
<a name="ln653">        &quot;&lt;w&gt;Home&lt;/w&gt;: This screen\n&quot;);</a>
<a name="ln654"> </a>
<a name="ln655">    // TODO: generate this from the manual somehow</a>
<a name="ln656">    cols.add_formatted(</a>
<a name="ln657">        1,</a>
<a name="ln658">        &quot;&lt;h&gt;Manual Contents\n\n&quot;</a>
<a name="ln659">        &quot;&lt;w&gt;*&lt;/w&gt;       Table of contents\n&quot;</a>
<a name="ln660">        &quot;&lt;w&gt;A&lt;/w&gt;.      Overview\n&quot;</a>
<a name="ln661">        &quot;&lt;w&gt;B&lt;/w&gt;.      Starting Screen\n&quot;</a>
<a name="ln662">        &quot;&lt;w&gt;C&lt;/w&gt;.      Attributes and Stats\n&quot;</a>
<a name="ln663">        &quot;&lt;w&gt;D&lt;/w&gt;.      Exploring the Dungeon\n&quot;</a>
<a name="ln664">        &quot;&lt;w&gt;E&lt;/w&gt;.      Experience and Skills\n&quot;</a>
<a name="ln665">        &quot;&lt;w&gt;F&lt;/w&gt;.      Monsters\n&quot;</a>
<a name="ln666">        &quot;&lt;w&gt;G&lt;/w&gt;.      Items\n&quot;</a>
<a name="ln667">        &quot;&lt;w&gt;H&lt;/w&gt;.      Spellcasting\n&quot;</a>
<a name="ln668">        &quot;&lt;w&gt;I&lt;/w&gt;.      Targeting\n&quot;</a>
<a name="ln669">        &quot;&lt;w&gt;J&lt;/w&gt;.      Religion\n&quot;</a>
<a name="ln670">        &quot;&lt;w&gt;K&lt;/w&gt;.      Mutations\n&quot;</a>
<a name="ln671">        &quot;&lt;w&gt;L&lt;/w&gt;.      Licence, Contact, History\n&quot;</a>
<a name="ln672">        &quot;&lt;w&gt;M&lt;/w&gt;.      Macros, Options, Performance\n&quot;</a>
<a name="ln673">        &quot;&lt;w&gt;N&lt;/w&gt;.      Philosophy\n&quot;</a>
<a name="ln674">        &quot;&lt;w&gt;1&lt;/w&gt;.      List of Character Species\n&quot;</a>
<a name="ln675">        &quot;&lt;w&gt;2&lt;/w&gt;.      List of Character Backgrounds\n&quot;</a>
<a name="ln676">        &quot;&lt;w&gt;3&lt;/w&gt;.      List of Skills\n&quot;</a>
<a name="ln677">        &quot;&lt;w&gt;4&lt;/w&gt;.      List of Keys and Commands\n&quot;</a>
<a name="ln678">        &quot;&lt;w&gt;5&lt;/w&gt;.      Inscriptions\n&quot;</a>
<a name="ln679">        &quot;&lt;w&gt;6&lt;/w&gt;.      Dungeon sprint modes\n&quot;);</a>
<a name="ln680">}</a>
<a name="ln681"> </a>
<a name="ln682">static void _add_formatted_keyhelp(column_composer &amp;cols)</a>
<a name="ln683">{</a>
<a name="ln684">    cols.add_formatted(</a>
<a name="ln685">            0,</a>
<a name="ln686">            &quot;&lt;h&gt;Movement:\n&quot;</a>
<a name="ln687">            &quot;To move in a direction or to attack, \n&quot;</a>
<a name="ln688">            &quot;use the numpad (try Numlock off and \n&quot;</a>
<a name="ln689">            &quot;on) or vi keys:\n&quot;);</a>
<a name="ln690"> </a>
<a name="ln691">    _add_insert_commands(cols, 0, &quot;                 &lt;w&gt;7 8 9      % % %&quot;,</a>
<a name="ln692">                         { CMD_MOVE_UP_LEFT, CMD_MOVE_UP, CMD_MOVE_UP_RIGHT });</a>
<a name="ln693">    _add_insert_commands(cols, 0, &quot;                  \\|/        \\|/&quot;, {});</a>
<a name="ln694">    _add_insert_commands(cols, 0, &quot;                 &lt;w&gt;4&lt;/w&gt;-&lt;w&gt;5&lt;/w&gt;-&lt;w&gt;6&lt;/w&gt;&quot;</a>
<a name="ln695">                                  &quot;      &lt;w&gt;%&lt;/w&gt;-&lt;w&gt;%&lt;/w&gt;-&lt;w&gt;%&lt;/w&gt;&quot;,</a>
<a name="ln696">                         { CMD_MOVE_LEFT, CMD_WAIT, CMD_MOVE_RIGHT });</a>
<a name="ln697">    _add_insert_commands(cols, 0, &quot;                  /|\\        /|\\&quot;, {});</a>
<a name="ln698">    _add_insert_commands(cols, 0, &quot;                 &lt;w&gt;1 2 3      % % %&quot;,</a>
<a name="ln699">                         { CMD_MOVE_DOWN_LEFT, CMD_MOVE_DOWN,</a>
<a name="ln700">                           CMD_MOVE_DOWN_RIGHT });</a>
<a name="ln701"> </a>
<a name="ln702">    cols.add_formatted(</a>
<a name="ln703">            0,</a>
<a name="ln704">            &quot;&lt;h&gt;Rest:\n&quot;);</a>
<a name="ln705"> </a>
<a name="ln706">    _add_command(cols, 0, CMD_WAIT, &quot;wait a turn (also &lt;w&gt;s&lt;/w&gt;, &lt;w&gt;Del&lt;/w&gt;)&quot;, 2);</a>
<a name="ln707">    _add_command(cols, 0, CMD_REST, &quot;rest and long wait; stops when&quot;, 2);</a>
<a name="ln708">    cols.add_formatted(</a>
<a name="ln709">            0,</a>
<a name="ln710">            &quot;    Health or Magic become full or\n&quot;</a>
<a name="ln711">            &quot;    something is detected. If Health\n&quot;</a>
<a name="ln712">            &quot;    and Magic are already full, stops\n&quot;</a>
<a name="ln713">            &quot;    when 100 turns over (&lt;w&gt;numpad-5&lt;/w&gt;)\n&quot;,</a>
<a name="ln714">            false);</a>
<a name="ln715"> </a>
<a name="ln716">    cols.add_formatted(</a>
<a name="ln717">            0,</a>
<a name="ln718">            &quot;&lt;h&gt;Extended Movement:\n&quot;);</a>
<a name="ln719"> </a>
<a name="ln720">    _add_command(cols, 0, CMD_EXPLORE, &quot;auto-explore&quot;);</a>
<a name="ln721">    _add_command(cols, 0, CMD_INTERLEVEL_TRAVEL, &quot;interlevel travel&quot;);</a>
<a name="ln722">    _add_command(cols, 0, CMD_SEARCH_STASHES, &quot;Find items&quot;);</a>
<a name="ln723">    _add_command(cols, 0, CMD_FIX_WAYPOINT, &quot;set Waypoint&quot;);</a>
<a name="ln724"> </a>
<a name="ln725">    cols.add_formatted(</a>
<a name="ln726">            0,</a>
<a name="ln727">            &quot;&lt;w&gt;/ Dir.&lt;/w&gt;, &lt;w&gt;Shift-Dir.&lt;/w&gt;: long walk\n&quot;</a>
<a name="ln728">            &quot;&lt;w&gt;* Dir.&lt;/w&gt;, &lt;w&gt;Ctrl-Dir.&lt;/w&gt; : attack without move \n&quot;,</a>
<a name="ln729">            false);</a>
<a name="ln730"> </a>
<a name="ln731">    cols.add_formatted(</a>
<a name="ln732">            0,</a>
<a name="ln733">            &quot;&lt;h&gt;Autofight:\n&quot;</a>
<a name="ln734">            &quot;&lt;w&gt;Tab&lt;/w&gt;       : attack nearest monster,\n&quot;</a>
<a name="ln735">            &quot;            moving if necessary\n&quot;</a>
<a name="ln736">            &quot;&lt;w&gt;Shift-Tab&lt;/w&gt; : attack nearest monster\n&quot;</a>
<a name="ln737">            &quot;            without moving\n&quot;);</a>
<a name="ln738"> </a>
<a name="ln739">    cols.add_formatted(</a>
<a name="ln740">            0,</a>
<a name="ln741">            &quot;&lt;h&gt;Item types (and common commands)\n&quot;);</a>
<a name="ln742"> </a>
<a name="ln743">    _add_insert_commands(cols, 0, &quot;&lt;cyan&gt;)&lt;/cyan&gt; : hand weapons (&lt;w&gt;%&lt;/w&gt;ield)&quot;,</a>
<a name="ln744">                         { CMD_WIELD_WEAPON });</a>
<a name="ln745">    _add_insert_commands(cols, 0, &quot;&lt;brown&gt;(&lt;/brown&gt; : missiles (&lt;w&gt;%&lt;/w&gt;uiver, &quot;</a>
<a name="ln746">                                  &quot;&lt;w&gt;%&lt;/w&gt;ire, &lt;w&gt;%&lt;/w&gt;/&lt;w&gt;%&lt;/w&gt; cycle)&quot;,</a>
<a name="ln747">                         { CMD_QUIVER_ITEM, CMD_FIRE, CMD_CYCLE_QUIVER_FORWARD,</a>
<a name="ln748">                           CMD_CYCLE_QUIVER_BACKWARD });</a>
<a name="ln749">    _add_insert_commands(cols, 0, &quot;&lt;cyan&gt;[&lt;/cyan&gt; : armour (&lt;w&gt;%&lt;/w&gt;ear and &lt;w&gt;%&lt;/w&gt;ake off)&quot;,</a>
<a name="ln750">                         { CMD_WEAR_ARMOUR, CMD_REMOVE_ARMOUR });</a>
<a name="ln751">    _add_insert_commands(cols, 0, &quot;&lt;brown&gt;percent&lt;/brown&gt; : corpses and food &quot;</a>
<a name="ln752">                                  &quot;(&lt;w&gt;%&lt;/w&gt;hop up and &lt;w&gt;%&lt;/w&gt;at)&quot;,</a>
<a name="ln753">                         { CMD_BUTCHER, CMD_EAT });</a>
<a name="ln754">    _add_insert_commands(cols, 0, &quot;&lt;w&gt;?&lt;/w&gt; : scrolls (&lt;w&gt;%&lt;/w&gt;ead)&quot;,</a>
<a name="ln755">                         { CMD_READ });</a>
<a name="ln756">    _add_insert_commands(cols, 0, &quot;&lt;magenta&gt;!&lt;/magenta&gt; : potions (&lt;w&gt;%&lt;/w&gt;uaff)&quot;,</a>
<a name="ln757">                         { CMD_QUAFF });</a>
<a name="ln758">    _add_insert_commands(cols, 0, &quot;&lt;blue&gt;=&lt;/blue&gt; : rings (&lt;w&gt;%&lt;/w&gt;ut on and &lt;w&gt;%&lt;/w&gt;emove)&quot;,</a>
<a name="ln759">                         { CMD_WEAR_JEWELLERY, CMD_REMOVE_JEWELLERY });</a>
<a name="ln760">    _add_insert_commands(cols, 0, &quot;&lt;red&gt;\&quot;&lt;/red&gt; : amulets (&lt;w&gt;%&lt;/w&gt;ut on and &lt;w&gt;%&lt;/w&gt;emove)&quot;,</a>
<a name="ln761">                         { CMD_WEAR_JEWELLERY, CMD_REMOVE_JEWELLERY });</a>
<a name="ln762">    _add_insert_commands(cols, 0, &quot;&lt;lightgrey&gt;/&lt;/lightgrey&gt; : wands (e&lt;w&gt;%&lt;/w&gt;oke)&quot;,</a>
<a name="ln763">                         { CMD_EVOKE });</a>
<a name="ln764"> </a>
<a name="ln765">    string item_types = &quot;&lt;lightcyan&gt;&quot;;</a>
<a name="ln766">    item_types += stringize_glyph(get_item_symbol(SHOW_ITEM_BOOK));</a>
<a name="ln767">    item_types +=</a>
<a name="ln768">        &quot;&lt;/lightcyan&gt; : books (&lt;w&gt;%&lt;/w&gt;emorise, &lt;w&gt;%&lt;/w&gt;ap, &lt;w&gt;%&lt;/w&gt;ap,\n&quot;</a>
<a name="ln769">        &quot;    pick up to add to library)&quot;;</a>
<a name="ln770">    _add_insert_commands(cols, 0, item_types,</a>
<a name="ln771">                         { CMD_MEMORISE_SPELL, CMD_CAST_SPELL,</a>
<a name="ln772">                           CMD_FORCE_CAST_SPELL });</a>
<a name="ln773">    _add_insert_commands(cols, 0, &quot;&lt;brown&gt;\\&lt;/brown&gt; : staves (&lt;w&gt;%&lt;/w&gt;ield and e&lt;w&gt;%&lt;/w&gt;oke)&quot;,</a>
<a name="ln774">                         { CMD_WIELD_WEAPON, CMD_EVOKE_WIELDED });</a>
<a name="ln775">    _add_insert_commands(cols, 0, &quot;&lt;lightgreen&gt;}&lt;/lightgreen&gt; : miscellaneous items (e&lt;w&gt;%&lt;/w&gt;oke)&quot;,</a>
<a name="ln776">                         { CMD_EVOKE });</a>
<a name="ln777">    _add_insert_commands(cols, 0, &quot;&lt;yellow&gt;$&lt;/yellow&gt; : gold (&lt;w&gt;%&lt;/w&gt; counts gold)&quot;,</a>
<a name="ln778">                         { CMD_LIST_GOLD });</a>
<a name="ln779"> </a>
<a name="ln780">    cols.add_formatted(</a>
<a name="ln781">            0,</a>
<a name="ln782">            &quot;&lt;lightmagenta&gt;0&lt;/lightmagenta&gt; : the Orb of Zot\n&quot;</a>
<a name="ln783">            &quot;    Carry it to the surface and win!\n&quot;,</a>
<a name="ln784">            false);</a>
<a name="ln785"> </a>
<a name="ln786">    cols.add_formatted(</a>
<a name="ln787">            0,</a>
<a name="ln788">            &quot;&lt;h&gt;Other Gameplay Actions:\n&quot;);</a>
<a name="ln789"> </a>
<a name="ln790">    _add_insert_commands(cols, 0, 2, CMD_USE_ABILITY,</a>
<a name="ln791">                         &quot;use special Ability (&lt;w&gt;%!&lt;/w&gt; for help)&quot;,</a>
<a name="ln792">                         { CMD_USE_ABILITY });</a>
<a name="ln793">    _add_command(cols, 0, CMD_CAST_SPELL, &quot;cast spell, abort without targets&quot;, 2);</a>
<a name="ln794">    _add_command(cols, 0, CMD_FORCE_CAST_SPELL, &quot;cast spell, no matter what&quot;, 2);</a>
<a name="ln795">    _add_command(cols, 0, CMD_DISPLAY_SPELLS, &quot;list all memorised spells&quot;, 2);</a>
<a name="ln796">    _add_command(cols, 0, CMD_MEMORISE_SPELL, &quot;Memorise a spell from your library&quot;, 2);</a>
<a name="ln797"> </a>
<a name="ln798">    _add_insert_commands(cols, 0, 2, CMD_SHOUT,</a>
<a name="ln799">                         &quot;tell allies (&lt;w&gt;%t&lt;/w&gt; to shout)&quot;,</a>
<a name="ln800">                         { CMD_SHOUT });</a>
<a name="ln801">    _add_command(cols, 0, CMD_PREV_CMD_AGAIN, &quot;re-do previous command&quot;, 2);</a>
<a name="ln802">    _add_command(cols, 0, CMD_REPEAT_CMD, &quot;repeat next command # of times&quot;, 2);</a>
<a name="ln803"> </a>
<a name="ln804">    cols.add_formatted(</a>
<a name="ln805">            0,</a>
<a name="ln806">            &quot;&lt;h&gt;Non-Gameplay Commands / Info\n&quot;);</a>
<a name="ln807"> </a>
<a name="ln808">    _add_command(cols, 0, CMD_REPLAY_MESSAGES, &quot;show Previous messages&quot;);</a>
<a name="ln809">    _add_command(cols, 0, CMD_REDRAW_SCREEN, &quot;Redraw screen&quot;);</a>
<a name="ln810">    _add_command(cols, 0, CMD_CLEAR_MAP, &quot;Clear main and level maps&quot;);</a>
<a name="ln811">    _add_command(cols, 0, CMD_ANNOTATE_LEVEL, &quot;annotate the dungeon level&quot;, 2);</a>
<a name="ln812">    _add_command(cols, 0, CMD_CHARACTER_DUMP, &quot;dump character to file&quot;, 2);</a>
<a name="ln813">    _add_insert_commands(cols, 0, 2, CMD_MAKE_NOTE,</a>
<a name="ln814">                         &quot;add note (use &lt;w&gt;%:&lt;/w&gt; to read notes)&quot;,</a>
<a name="ln815">                         { CMD_DISPLAY_COMMANDS });</a>
<a name="ln816">    _add_command(cols, 0, CMD_MACRO_ADD, &quot;add macro (also &lt;w&gt;Ctrl-D&lt;/w&gt;)&quot;, 2);</a>
<a name="ln817">    _add_command(cols, 0, CMD_ADJUST_INVENTORY, &quot;reassign inventory/spell letters&quot;, 2);</a>
<a name="ln818">#ifdef USE_TILE_LOCAL</a>
<a name="ln819">    _add_command(cols, 0, CMD_EDIT_PLAYER_TILE, &quot;edit player doll&quot;, 2);</a>
<a name="ln820">#else</a>
<a name="ln821">#ifdef USE_TILE_WEB</a>
<a name="ln822">    if (tiles.is_controlled_from_web())</a>
<a name="ln823">    {</a>
<a name="ln824">        cols.add_formatted(0, &quot;&lt;w&gt;F12&lt;/w&gt; : read messages (online play only)&quot;,</a>
<a name="ln825">                           false);</a>
<a name="ln826">    }</a>
<a name="ln827">    else</a>
<a name="ln828">#endif</a>
<a name="ln829">    _add_command(cols, 0, CMD_READ_MESSAGES, &quot;read messages (online play only)&quot;, 2);</a>
<a name="ln830">#endif</a>
<a name="ln831"> </a>
<a name="ln832">    cols.add_formatted(</a>
<a name="ln833">            1,</a>
<a name="ln834">            &quot;&lt;h&gt;Game Saving and Quitting:\n&quot;);</a>
<a name="ln835"> </a>
<a name="ln836">    _add_command(cols, 1, CMD_SAVE_GAME, &quot;Save game and exit&quot;);</a>
<a name="ln837">    _add_command(cols, 1, CMD_SAVE_GAME_NOW, &quot;Save and exit without query&quot;);</a>
<a name="ln838">    _add_command(cols, 1, CMD_QUIT, &quot;Abandon the current character&quot;);</a>
<a name="ln839">    cols.add_formatted(1, &quot;         and quit the game\n&quot;,</a>
<a name="ln840">                       false);</a>
<a name="ln841"> </a>
<a name="ln842">    cols.add_formatted(</a>
<a name="ln843">            1,</a>
<a name="ln844">            &quot;&lt;h&gt;Player Character Information:\n&quot;);</a>
<a name="ln845"> </a>
<a name="ln846">    _add_command(cols, 1, CMD_DISPLAY_CHARACTER_STATUS, &quot;display character status&quot;, 2);</a>
<a name="ln847">    _add_command(cols, 1, CMD_DISPLAY_SKILLS, &quot;show skill screen&quot;, 2);</a>
<a name="ln848">    _add_command(cols, 1, CMD_RESISTS_SCREEN, &quot;character overview&quot;, 2);</a>
<a name="ln849">    _add_command(cols, 1, CMD_DISPLAY_RELIGION, &quot;show religion screen&quot;, 2);</a>
<a name="ln850">    _add_command(cols, 1, CMD_DISPLAY_MUTATIONS, &quot;show Abilities/mutations&quot;, 2);</a>
<a name="ln851">    _add_command(cols, 1, CMD_DISPLAY_KNOWN_OBJECTS, &quot;show item knowledge&quot;, 2);</a>
<a name="ln852">    _add_command(cols, 1, CMD_MEMORISE_SPELL, &quot;show your spell library&quot;, 2);</a>
<a name="ln853">    _add_command(cols, 1, CMD_DISPLAY_RUNES, &quot;show runes collected&quot;, 2);</a>
<a name="ln854">    _add_command(cols, 1, CMD_LIST_ARMOUR, &quot;display worn armour&quot;, 2);</a>
<a name="ln855">    _add_command(cols, 1, CMD_LIST_JEWELLERY, &quot;display worn jewellery&quot;, 2);</a>
<a name="ln856">    _add_command(cols, 1, CMD_LIST_GOLD, &quot;display gold in possession&quot;, 2);</a>
<a name="ln857">    _add_command(cols, 1, CMD_EXPERIENCE_CHECK, &quot;display experience info&quot;, 2);</a>
<a name="ln858"> </a>
<a name="ln859">    cols.add_formatted(</a>
<a name="ln860">            1,</a>
<a name="ln861">            &quot;&lt;h&gt;Dungeon Interaction and Information:\n&quot;);</a>
<a name="ln862"> </a>
<a name="ln863">    _add_insert_commands(cols, 1, &quot;&lt;w&gt;%&lt;/w&gt;/&lt;w&gt;%&lt;/w&gt;    : Open/Close door&quot;,</a>
<a name="ln864">                         { CMD_OPEN_DOOR, CMD_CLOSE_DOOR });</a>
<a name="ln865">    _add_insert_commands(cols, 1, &quot;&lt;w&gt;%&lt;/w&gt;/&lt;w&gt;%&lt;/w&gt;    : use staircase&quot;,</a>
<a name="ln866">                         { CMD_GO_UPSTAIRS, CMD_GO_DOWNSTAIRS });</a>
<a name="ln867"> </a>
<a name="ln868">    _add_command(cols, 1, CMD_INSPECT_FLOOR, &quot;examine occupied tile and&quot;);</a>
<a name="ln869">    cols.add_formatted(1, &quot;         pickup part of a single stack\n&quot;,</a>
<a name="ln870">                       false);</a>
<a name="ln871"> </a>
<a name="ln872">    _add_command(cols, 1, CMD_LOOK_AROUND, &quot;eXamine surroundings/targets&quot;);</a>
<a name="ln873">    _add_insert_commands(cols, 1, 7, CMD_DISPLAY_MAP,</a>
<a name="ln874">                         &quot;eXamine level map (&lt;w&gt;%?&lt;/w&gt; for help)&quot;,</a>
<a name="ln875">                         { CMD_DISPLAY_MAP });</a>
<a name="ln876">    _add_command(cols, 1, CMD_FULL_VIEW, &quot;list monsters, items, features&quot;);</a>
<a name="ln877">    cols.add_formatted(1, &quot;         in view\n&quot;,</a>
<a name="ln878">                       false);</a>
<a name="ln879">    _add_command(cols, 1, CMD_SHOW_TERRAIN, &quot;toggle view layers&quot;);</a>
<a name="ln880">    _add_command(cols, 1, CMD_DISPLAY_OVERMAP, &quot;show dungeon Overview&quot;);</a>
<a name="ln881">    _add_command(cols, 1, CMD_TOGGLE_AUTOPICKUP, &quot;toggle auto-pickup&quot;);</a>
<a name="ln882">#ifdef USE_SOUND</a>
<a name="ln883">    _add_command(cols, 1, CMD_TOGGLE_SOUND, &quot;mute/unmute sound effects&quot;);</a>
<a name="ln884">#endif</a>
<a name="ln885">    _add_command(cols, 1, CMD_TOGGLE_TRAVEL_SPEED, &quot;set your travel speed to your&quot;);</a>
<a name="ln886">    cols.add_formatted(1, &quot;         slowest ally\n&quot;,</a>
<a name="ln887">                           false);</a>
<a name="ln888">#ifdef USE_TILE_LOCAL</a>
<a name="ln889">    _add_insert_commands(cols, 1, &quot;&lt;w&gt;%&lt;/w&gt;/&lt;w&gt;%&lt;/w&gt; : zoom out/in&quot;,</a>
<a name="ln890">                        { CMD_ZOOM_OUT, CMD_ZOOM_IN });</a>
<a name="ln891">#endif</a>
<a name="ln892"> </a>
<a name="ln893">    cols.add_formatted(</a>
<a name="ln894">            1,</a>
<a name="ln895">            &quot;&lt;h&gt;Inventory management:\n&quot;);</a>
<a name="ln896"> </a>
<a name="ln897">    _add_command(cols, 1, CMD_DISPLAY_INVENTORY, &quot;show Inventory list&quot;, 2);</a>
<a name="ln898">    _add_command(cols, 1, CMD_PICKUP, &quot;pick up items (also &lt;w&gt;g&lt;/w&gt;)&quot;, 2);</a>
<a name="ln899">    cols.add_formatted(</a>
<a name="ln900">            1,</a>
<a name="ln901">            &quot;    (press twice for pick up menu)\n&quot;,</a>
<a name="ln902">            false);</a>
<a name="ln903"> </a>
<a name="ln904">    _add_command(cols, 1, CMD_DROP, &quot;Drop an item&quot;, 2);</a>
<a name="ln905">    _add_insert_commands(cols, 1, &quot;&lt;w&gt;%#&lt;/w&gt;: Drop exact number of items&quot;,</a>
<a name="ln906">                         { CMD_DROP });</a>
<a name="ln907">    _add_command(cols, 1, CMD_DROP_LAST, &quot;Drop the last item(s) you picked up&quot;, 2);</a>
<a name="ln908"> </a>
<a name="ln909">    cols.add_formatted(</a>
<a name="ln910">            1,</a>
<a name="ln911">            &quot;&lt;h&gt;Item Interaction:\n&quot;);</a>
<a name="ln912"> </a>
<a name="ln913">    _add_command(cols, 1, CMD_INSCRIBE_ITEM, &quot;inscribe item&quot;, 2);</a>
<a name="ln914">    _add_command(cols, 1, CMD_BUTCHER, &quot;Chop up a corpse on floor&quot;, 2);</a>
<a name="ln915">    _add_command(cols, 1, CMD_EAT, &quot;Eat food (tries floor first) \n&quot;, 2);</a>
<a name="ln916">    _add_command(cols, 1, CMD_FIRE, &quot;Fire next appropriate item&quot;, 2);</a>
<a name="ln917">    _add_command(cols, 1, CMD_THROW_ITEM_NO_QUIVER, &quot;select an item and Fire it&quot;, 2);</a>
<a name="ln918">    _add_command(cols, 1, CMD_QUIVER_ITEM, &quot;select item slot to be Quivered&quot;, 2);</a>
<a name="ln919">    _add_command(cols, 1, CMD_QUAFF, &quot;Quaff a potion&quot;, 2);</a>
<a name="ln920">    _add_command(cols, 1, CMD_READ, &quot;Read a scroll (or book on floor)&quot;, 2);</a>
<a name="ln921">    _add_command(cols, 1, CMD_WIELD_WEAPON, &quot;Wield an item (&lt;w&gt;-&lt;/w&gt; for none)&quot;, 2);</a>
<a name="ln922">    _add_command(cols, 1, CMD_WEAPON_SWAP, &quot;wield item a, or switch to b&quot;, 2);</a>
<a name="ln923"> </a>
<a name="ln924">    _add_insert_commands(cols, 1, &quot;    (use &lt;w&gt;%&lt;/w&gt; to assign slots)&quot;,</a>
<a name="ln925">                         { CMD_ADJUST_INVENTORY });</a>
<a name="ln926"> </a>
<a name="ln927">    _add_command(cols, 1, CMD_EVOKE_WIELDED, &quot;eVoke power of wielded item&quot;, 2);</a>
<a name="ln928">    _add_command(cols, 1, CMD_EVOKE, &quot;eVoke wand and miscellaneous item&quot;, 2);</a>
<a name="ln929"> </a>
<a name="ln930">    _add_insert_commands(cols, 1, &quot;&lt;w&gt;%&lt;/w&gt;/&lt;w&gt;%&lt;/w&gt; : Wear or Take off armour&quot;,</a>
<a name="ln931">                         { CMD_WEAR_ARMOUR, CMD_REMOVE_ARMOUR });</a>
<a name="ln932">    _add_insert_commands(cols, 1, &quot;&lt;w&gt;%&lt;/w&gt;/&lt;w&gt;%&lt;/w&gt; : Put on or Remove jewellery&quot;,</a>
<a name="ln933">                         { CMD_WEAR_JEWELLERY, CMD_REMOVE_JEWELLERY });</a>
<a name="ln934"> </a>
<a name="ln935">    cols.add_formatted(</a>
<a name="ln936">            1,</a>
<a name="ln937">            &quot;&lt;h&gt;Additional help:\n&quot;);</a>
<a name="ln938"> </a>
<a name="ln939">    string text =</a>
<a name="ln940">            &quot;Many commands have context sensitive &quot;</a>
<a name="ln941">            &quot;help, among them &lt;w&gt;%&lt;/w&gt;, &lt;w&gt;%&lt;/w&gt;, &lt;w&gt;%&lt;/w&gt; (or any &quot;</a>
<a name="ln942">            &quot;form of targeting), &lt;w&gt;%&lt;/w&gt;, and &lt;w&gt;%&lt;/w&gt;.\n&quot;</a>
<a name="ln943">            &quot;You can read descriptions of your &quot;</a>
<a name="ln944">            &quot;current spells (&lt;w&gt;%&lt;/w&gt;), skills (&lt;w&gt;%?&lt;/w&gt;) and &quot;</a>
<a name="ln945">            &quot;abilities (&lt;w&gt;%!&lt;/w&gt;).&quot;;</a>
<a name="ln946">    insert_commands(text, { CMD_DISPLAY_MAP, CMD_LOOK_AROUND, CMD_FIRE,</a>
<a name="ln947">                            CMD_SEARCH_STASHES, CMD_INTERLEVEL_TRAVEL,</a>
<a name="ln948">                            CMD_DISPLAY_SPELLS, CMD_DISPLAY_SKILLS,</a>
<a name="ln949">                            CMD_USE_ABILITY</a>
<a name="ln950">                          });</a>
<a name="ln951">    linebreak_string(text, 40);</a>
<a name="ln952"> </a>
<a name="ln953">    cols.add_formatted(</a>
<a name="ln954">            1, text,</a>
<a name="ln955">            false);</a>
<a name="ln956">}</a>
<a name="ln957"> </a>
<a name="ln958">static void _add_formatted_hints_help(column_composer &amp;cols)</a>
<a name="ln959">{</a>
<a name="ln960">    // First column.</a>
<a name="ln961">    cols.add_formatted(</a>
<a name="ln962">            0,</a>
<a name="ln963">            &quot;&lt;h&gt;Movement:\n&quot;</a>
<a name="ln964">            &quot;To move in a direction or to attack, \n&quot;</a>
<a name="ln965">            &quot;use the numpad (try Numlock off and \n&quot;</a>
<a name="ln966">            &quot;on) or vi keys:\n&quot;,</a>
<a name="ln967">            false);</a>
<a name="ln968"> </a>
<a name="ln969">    _add_insert_commands(cols, 0, &quot;                 &lt;w&gt;7 8 9      % % %&quot;,</a>
<a name="ln970">                         { CMD_MOVE_UP_LEFT, CMD_MOVE_UP, CMD_MOVE_UP_RIGHT });</a>
<a name="ln971">    _add_insert_commands(cols, 0, &quot;                  \\|/        \\|/&quot;, {});</a>
<a name="ln972">    _add_insert_commands(cols, 0, &quot;                 &lt;w&gt;4&lt;/w&gt;-&lt;w&gt;5&lt;/w&gt;-&lt;w&gt;6&lt;/w&gt;&quot;</a>
<a name="ln973">                                  &quot;      &lt;w&gt;%&lt;/w&gt;-&lt;w&gt;%&lt;/w&gt;-&lt;w&gt;%&lt;/w&gt;&quot;,</a>
<a name="ln974">                         { CMD_MOVE_LEFT, CMD_WAIT, CMD_MOVE_RIGHT });</a>
<a name="ln975">    _add_insert_commands(cols, 0, &quot;                  /|\\        /|\\&quot;, {});</a>
<a name="ln976">    _add_insert_commands(cols, 0, &quot;                 &lt;w&gt;1 2 3      % % %&quot;,</a>
<a name="ln977">                         { CMD_MOVE_DOWN_LEFT, CMD_MOVE_DOWN,</a>
<a name="ln978">                           CMD_MOVE_DOWN_RIGHT });</a>
<a name="ln979"> </a>
<a name="ln980">    cols.add_formatted(0, &quot; &quot;, false);</a>
<a name="ln981">    cols.add_formatted(0, &quot;&lt;w&gt;Shift-Dir.&lt;/w&gt; runs into one direction&quot;,</a>
<a name="ln982">                       false);</a>
<a name="ln983">    _add_insert_commands(cols, 0, &quot;&lt;w&gt;%&lt;/w&gt; or &lt;w&gt;%&lt;/w&gt; : ascend/descend the stairs&quot;,</a>
<a name="ln984">                         { CMD_GO_UPSTAIRS, CMD_GO_DOWNSTAIRS });</a>
<a name="ln985">    _add_command(cols, 0, CMD_EXPLORE, &quot;autoexplore&quot;, 2);</a>
<a name="ln986"> </a>
<a name="ln987">    cols.add_formatted(</a>
<a name="ln988">            0,</a>
<a name="ln989">            &quot;&lt;h&gt;Rest:\n&quot;);</a>
<a name="ln990"> </a>
<a name="ln991">    _add_command(cols, 0, CMD_WAIT, &quot;wait a turn (also &lt;w&gt;s&lt;/w&gt;, &lt;w&gt;Del&lt;/w&gt;)&quot;, 2);</a>
<a name="ln992">    _add_command(cols, 0, CMD_REST, &quot;rest and long wait; stops when&quot;, 2);</a>
<a name="ln993">    cols.add_formatted(</a>
<a name="ln994">            0,</a>
<a name="ln995">            &quot;    Health or Magic become full or\n&quot;</a>
<a name="ln996">            &quot;    something is detected. If Health\n&quot;</a>
<a name="ln997">            &quot;    and Magic are already full, stops\n&quot;</a>
<a name="ln998">            &quot;    when 100 turns over (&lt;w&gt;numpad-5&lt;/w&gt;)\n&quot;,</a>
<a name="ln999">            false);</a>
<a name="ln1000"> </a>
<a name="ln1001">    cols.add_formatted(</a>
<a name="ln1002">            0,</a>
<a name="ln1003">            &quot;\n&lt;h&gt;Attacking monsters\n&quot;</a>
<a name="ln1004">            &quot;Walking into a monster will attack it\n&quot;</a>
<a name="ln1005">            &quot;with the wielded weapon or barehanded.&quot;,</a>
<a name="ln1006">            false);</a>
<a name="ln1007"> </a>
<a name="ln1008">    cols.add_formatted(</a>
<a name="ln1009">            0,</a>
<a name="ln1010">            &quot;\n&lt;h&gt;Ranged combat and magic\n&quot;,</a>
<a name="ln1011">            false);</a>
<a name="ln1012"> </a>
<a name="ln1013">    _add_insert_commands(cols, 0, &quot;&lt;w&gt;%&lt;/w&gt; to throw/fire missiles&quot;,</a>
<a name="ln1014">                         { CMD_FIRE });</a>
<a name="ln1015">    _add_insert_commands(cols, 0, &quot;&lt;w&gt;%&lt;/w&gt;/&lt;w&gt;%&lt;/w&gt; to cast spells &quot;</a>
<a name="ln1016">                                  &quot;(&lt;w&gt;%?/%&lt;/w&gt; lists spells)&quot;,</a>
<a name="ln1017">                         { CMD_CAST_SPELL, CMD_FORCE_CAST_SPELL, CMD_CAST_SPELL,</a>
<a name="ln1018">                           CMD_DISPLAY_SPELLS });</a>
<a name="ln1019">    _add_command(cols, 0, CMD_MEMORISE_SPELL, &quot;Memorise spells and view spell\n&quot;</a>
<a name="ln1020">                                              &quot;    library (get books to add to it)&quot;, 2);</a>
<a name="ln1021"> </a>
<a name="ln1022">    // Second column.</a>
<a name="ln1023">    cols.add_formatted(</a>
<a name="ln1024">            1, &quot;&lt;h&gt;Item types and inventory management\n&quot;,</a>
<a name="ln1025">            false);</a>
<a name="ln1026"> </a>
<a name="ln1027">    _add_insert_commands(cols, 1,</a>
<a name="ln1028">                         &quot;&lt;console&gt;&lt;cyan&gt;)&lt;/cyan&gt; : &lt;/console&gt;&quot;</a>
<a name="ln1029">                         &quot;hand weapons (&lt;w&gt;%&lt;/w&gt;ield)&quot;,</a>
<a name="ln1030">                         { CMD_WIELD_WEAPON });</a>
<a name="ln1031">    _add_insert_commands(cols, 1,</a>
<a name="ln1032">                         &quot;&lt;console&gt;&lt;brown&gt;(&lt;/brown&gt; : &lt;/console&gt;&quot;</a>
<a name="ln1033">                         &quot;missiles (&lt;w&gt;%&lt;/w&gt;uiver, &lt;w&gt;%&lt;/w&gt;ire, &lt;w&gt;%&lt;/w&gt;/&lt;w&gt;%&lt;/w&gt; cycle)&quot;,</a>
<a name="ln1034">                         { CMD_QUIVER_ITEM, CMD_FIRE, CMD_CYCLE_QUIVER_FORWARD,</a>
<a name="ln1035">                           CMD_CYCLE_QUIVER_BACKWARD });</a>
<a name="ln1036">    _add_insert_commands(cols, 1,</a>
<a name="ln1037">                         &quot;&lt;console&gt;&lt;cyan&gt;[&lt;/cyan&gt; : &lt;/console&gt;&quot;</a>
<a name="ln1038">                         &quot;armour (&lt;w&gt;%&lt;/w&gt;ear and &lt;w&gt;%&lt;/w&gt;ake off)&quot;,</a>
<a name="ln1039">                         { CMD_WEAR_ARMOUR, CMD_REMOVE_ARMOUR });</a>
<a name="ln1040">    _add_insert_commands(cols, 1,</a>
<a name="ln1041">                         &quot;&lt;console&gt;&lt;brown&gt;percent&lt;/brown&gt; : &lt;/console&gt;&quot;</a>
<a name="ln1042">                         &quot;corpses and food (&lt;w&gt;%&lt;/w&gt;hop up and &lt;w&gt;%&lt;/w&gt;at)&quot;,</a>
<a name="ln1043">                         { CMD_BUTCHER, CMD_EAT });</a>
<a name="ln1044">    _add_insert_commands(cols, 1,</a>
<a name="ln1045">                         &quot;&lt;console&gt;&lt;w&gt;?&lt;/w&gt; : &lt;/console&gt;&quot;</a>
<a name="ln1046">                         &quot;scrolls (&lt;w&gt;%&lt;/w&gt;ead)&quot;,</a>
<a name="ln1047">                         { CMD_READ });</a>
<a name="ln1048">    _add_insert_commands(cols, 1,</a>
<a name="ln1049">                         &quot;&lt;console&gt;&lt;magenta&gt;!&lt;/magenta&gt; : &lt;/console&gt;&quot;</a>
<a name="ln1050">                         &quot;potions (&lt;w&gt;%&lt;/w&gt;uaff)&quot;,</a>
<a name="ln1051">                         { CMD_QUAFF });</a>
<a name="ln1052">    _add_insert_commands(cols, 1,</a>
<a name="ln1053">                         &quot;&lt;console&gt;&lt;blue&gt;=&lt;/blue&gt; : &lt;/console&gt;&quot;</a>
<a name="ln1054">                         &quot;rings (&lt;w&gt;%&lt;/w&gt;ut on and &lt;w&gt;%&lt;/w&gt;emove)&quot;,</a>
<a name="ln1055">                         { CMD_WEAR_JEWELLERY, CMD_REMOVE_JEWELLERY });</a>
<a name="ln1056">    _add_insert_commands(cols, 1,</a>
<a name="ln1057">                         &quot;&lt;console&gt;&lt;red&gt;\&quot;&lt;/red&gt; : &lt;/console&gt;&quot;</a>
<a name="ln1058">                         &quot;amulets (&lt;w&gt;%&lt;/w&gt;ut on and &lt;w&gt;%&lt;/w&gt;emove)&quot;,</a>
<a name="ln1059">                         { CMD_WEAR_JEWELLERY, CMD_REMOVE_JEWELLERY });</a>
<a name="ln1060">    _add_insert_commands(cols, 1,</a>
<a name="ln1061">                         &quot;&lt;console&gt;&lt;lightgrey&gt;/&lt;/lightgrey&gt; : &lt;/console&gt;&quot;</a>
<a name="ln1062">                         &quot;wands (e&lt;w&gt;%&lt;/w&gt;oke)&quot;,</a>
<a name="ln1063">                         { CMD_EVOKE });</a>
<a name="ln1064"> </a>
<a name="ln1065">    string item_types =</a>
<a name="ln1066">                  &quot;&lt;console&gt;&lt;lightcyan&gt;&quot;;</a>
<a name="ln1067">    item_types += stringize_glyph(get_item_symbol(SHOW_ITEM_BOOK));</a>
<a name="ln1068">    item_types +=</a>
<a name="ln1069">        &quot;&lt;/lightcyan&gt; : &lt;/console&gt;&quot;</a>
<a name="ln1070">        &quot;books (&lt;w&gt;%&lt;/w&gt;emorise, &lt;w&gt;%&lt;/w&gt;ap, &lt;w&gt;%&lt;/w&gt;ap,\n&quot;</a>
<a name="ln1071">        &quot;    pick up to add to spell library)&quot;;</a>
<a name="ln1072">    _add_insert_commands(cols, 1, item_types,</a>
<a name="ln1073">                         { CMD_MEMORISE_SPELL, CMD_CAST_SPELL,</a>
<a name="ln1074">                           CMD_FORCE_CAST_SPELL });</a>
<a name="ln1075"> </a>
<a name="ln1076">    item_types =</a>
<a name="ln1077">                  &quot;&lt;console&gt;&lt;brown&gt;&quot;;</a>
<a name="ln1078">    item_types += stringize_glyph(get_item_symbol(SHOW_ITEM_STAFF));</a>
<a name="ln1079">    item_types +=</a>
<a name="ln1080">        &quot;&lt;/brown&gt; : &lt;/console&gt;&quot;</a>
<a name="ln1081">        &quot;staves (&lt;w&gt;%&lt;/w&gt;ield and e&lt;w&gt;%&lt;/w&gt;oke)&quot;;</a>
<a name="ln1082">    _add_insert_commands(cols, 1, item_types,</a>
<a name="ln1083">                         { CMD_WIELD_WEAPON, CMD_EVOKE_WIELDED });</a>
<a name="ln1084"> </a>
<a name="ln1085">    cols.add_formatted(1, &quot; &quot;, false);</a>
<a name="ln1086">    _add_command(cols, 1, CMD_DISPLAY_INVENTORY, &quot;inventory (select item to view)&quot;, 2);</a>
<a name="ln1087">    _add_command(cols, 1, CMD_PICKUP, &quot;pick up item from ground (also &lt;w&gt;g&lt;/w&gt;)&quot;, 2);</a>
<a name="ln1088">    _add_command(cols, 1, CMD_DROP, &quot;drop item&quot;, 2);</a>
<a name="ln1089">    _add_command(cols, 1, CMD_DROP_LAST, &quot;drop the last item(s) you picked up&quot;, 2);</a>
<a name="ln1090"> </a>
<a name="ln1091">    cols.add_formatted(</a>
<a name="ln1092">            1,</a>
<a name="ln1093">            &quot;&lt;h&gt;Additional important commands\n&quot;);</a>
<a name="ln1094"> </a>
<a name="ln1095">    _add_command(cols, 1, CMD_SAVE_GAME_NOW, &quot;Save the game and exit&quot;, 2);</a>
<a name="ln1096">    _add_command(cols, 1, CMD_REPLAY_MESSAGES, &quot;show previous messages&quot;, 2);</a>
<a name="ln1097">    _add_command(cols, 1, CMD_USE_ABILITY, &quot;use an ability&quot;, 2);</a>
<a name="ln1098">    _add_command(cols, 1, CMD_RESISTS_SCREEN, &quot;show character overview&quot;, 2);</a>
<a name="ln1099">    _add_command(cols, 1, CMD_DISPLAY_RELIGION, &quot;show religion overview&quot;, 2);</a>
<a name="ln1100">    _add_command(cols, 1, CMD_DISPLAY_MAP, &quot;show map of the whole level&quot;, 2);</a>
<a name="ln1101">    _add_command(cols, 1, CMD_DISPLAY_OVERMAP, &quot;show dungeon overview&quot;, 2);</a>
<a name="ln1102"> </a>
<a name="ln1103">    cols.add_formatted(</a>
<a name="ln1104">            1,</a>
<a name="ln1105">            &quot;\n&lt;h&gt;Targeting\n&quot;</a>
<a name="ln1106">            &quot;&lt;w&gt;Enter&lt;/w&gt; or &lt;w&gt;.&lt;/w&gt; or &lt;w&gt;Del&lt;/w&gt; : confirm target\n&quot;</a>
<a name="ln1107">            &quot;&lt;w&gt;+&lt;/w&gt; and &lt;w&gt;-&lt;/w&gt; : cycle between targets\n&quot;</a>
<a name="ln1108">            &quot;&lt;w&gt;f&lt;/w&gt; or &lt;w&gt;p&lt;/w&gt; : shoot at previous target\n&quot;</a>
<a name="ln1109">            &quot;         if still alive and in sight\n&quot;,</a>
<a name="ln1110">            false);</a>
<a name="ln1111">}</a>
<a name="ln1112"> </a>
<a name="ln1113">static formatted_string _col_conv(void (*func)(column_composer &amp;))</a>
<a name="ln1114">{</a>
<a name="ln1115">    column_composer cols(2, 42);</a>
<a name="ln1116">    func(cols);</a>
<a name="ln1117">    formatted_string contents;</a>
<a name="ln1118">    for (const auto&amp; line : cols.formatted_lines())</a>
<a name="ln1119">    {</a>
<a name="ln1120">        contents += line;</a>
<a name="ln1121">        contents += &quot;\n&quot;;</a>
<a name="ln1122">    }</a>
<a name="ln1123">    contents.ops.pop_back();</a>
<a name="ln1124">    return contents;</a>
<a name="ln1125">}</a>
<a name="ln1126"> </a>
<a name="ln1127">static int _get_help_section(int section, formatted_string &amp;header_out, formatted_string &amp;text_out, int &amp;scroll_out)</a>
<a name="ln1128">{</a>
<a name="ln1129">    static map&lt;int, int&gt; hotkeys;</a>
<a name="ln1130">    static map&lt;int, formatted_string&gt; page_text;</a>
<a name="ln1131">    static map&lt;int, string&gt; headers = {</a>
<a name="ln1132">        {'*', &quot;Manual&quot;}, {'%', &quot;Aptitudes&quot;}, {'^', &quot;Quickstart&quot;},</a>
<a name="ln1133">        {'~', &quot;Macros&quot;}, {'&amp;', &quot;Options&quot;}, {'t', &quot;Tiles&quot;},</a>
<a name="ln1134">        {'?', &quot;Key help&quot;}</a>
<a name="ln1135">    };</a>
<a name="ln1136"> </a>
<a name="ln1137">    if (!page_text.size())</a>
<a name="ln1138">    {</a>
<a name="ln1139">        for (int i = 0; help_files[i].name != nullptr; ++i)</a>
<a name="ln1140">        {</a>
<a name="ln1141">            formatted_string text;</a>
<a name="ln1142">            bool next_is_hotkey = false;</a>
<a name="ln1143">            char buf[200];</a>
<a name="ln1144">            string fname = canonicalise_file_separator(help_files[i].name);</a>
<a name="ln1145">            FILE* fp = fopen_u(datafile_path(fname, false).c_str(), &quot;r&quot;);</a>
<a name="ln1146">            ASSERTM(fp, &quot;Failed to open '%s'!&quot;, fname.c_str());</a>
<a name="ln1147">            while (fgets(buf, sizeof buf, fp))</a>
<a name="ln1148">            {</a>
<a name="ln1149">                text += string(buf);</a>
<a name="ln1150">                if (next_is_hotkey &amp;&amp; (isaupper(buf[0]) || isadigit(buf[0])))</a>
<a name="ln1151">                {</a>
<a name="ln1152">                    int hotkey = tolower_safe(buf[0]);</a>
<a name="ln1153">                    hotkeys[hotkey] = count_occurrences(text.tostring(), &quot;\n&quot;);</a>
<a name="ln1154">                }</a>
<a name="ln1155"> </a>
<a name="ln1156">                next_is_hotkey =</a>
<a name="ln1157">                    strstr(buf, &quot;------------------------------------------&quot;</a>
<a name="ln1158">                                        &quot;------------------------------&quot;) == buf;</a>
<a name="ln1159">            }</a>
<a name="ln1160">            trim_string_right(text.ops.back().text);</a>
<a name="ln1161">            page_text[help_files[i].hotkey] = text;</a>
<a name="ln1162">        }</a>
<a name="ln1163">    }</a>
<a name="ln1164"> </a>
<a name="ln1165">    // All hotkeys are currently on *-page</a>
<a name="ln1166">    const int page = hotkeys.count(section) ? '*' : section;</a>
<a name="ln1167"> </a>
<a name="ln1168">    string header = headers.count(page) ? &quot;: &quot;+headers[page] : &quot;&quot;;</a>
<a name="ln1169">    header_out = formatted_string::parse_string(</a>
<a name="ln1170">                    &quot;&lt;yellow&gt;Dungeon Crawl Help&quot;+header+&quot;&lt;/yellow&gt;&quot;);</a>
<a name="ln1171">    scroll_out = 0;</a>
<a name="ln1172">    switch (section)</a>
<a name="ln1173">    {</a>
<a name="ln1174">        case '?':</a>
<a name="ln1175">            if (crawl_state.game_is_hints_tutorial())</a>
<a name="ln1176">                text_out = _col_conv(_add_formatted_hints_help);</a>
<a name="ln1177">            else</a>
<a name="ln1178">                text_out = _col_conv(_add_formatted_keyhelp);</a>
<a name="ln1179">            return page;</a>
<a name="ln1180">        case CK_HOME:</a>
<a name="ln1181">            text_out = _col_conv(_add_formatted_help_menu);</a>
<a name="ln1182">            return page;</a>
<a name="ln1183">        default:</a>
<a name="ln1184">            if (hotkeys.count(section))</a>
<a name="ln1185">                scroll_out = hotkeys[section];</a>
<a name="ln1186">            if (page_text.count(page))</a>
<a name="ln1187">            {</a>
<a name="ln1188">                text_out = page_text[page];</a>
<a name="ln1189">                return page;</a>
<a name="ln1190">            }</a>
<a name="ln1191">            break;</a>
<a name="ln1192">    }</a>
<a name="ln1193">    return 0;</a>
<a name="ln1194">}</a>
<a name="ln1195"> </a>
<a name="ln1196">class help_popup : public formatted_scroller</a>
<a name="ln1197">{</a>
<a name="ln1198">public:</a>
<a name="ln1199">    help_popup(int key) : formatted_scroller(FS_PREWRAPPED_TEXT) {</a>
<a name="ln1200">        set_tag(&quot;help&quot;);</a>
<a name="ln1201">        process_key(key);</a>
<a name="ln1202">    };</a>
<a name="ln1203">private:</a>
<a name="ln1204">    bool process_key(int ch) override</a>
<a name="ln1205">    {</a>
<a name="ln1206">        int key = toalower(ch);</a>
<a name="ln1207"> </a>
<a name="ln1208">#ifdef USE_TILE_LOCAL</a>
<a name="ln1209">        const int line_height = tiles.get_crt_font()-&gt;char_height();</a>
<a name="ln1210">#else</a>
<a name="ln1211">        const int line_height = 1;</a>
<a name="ln1212">#endif</a>
<a name="ln1213"> </a>
<a name="ln1214">        int scroll, page;</a>
<a name="ln1215">        formatted_string header_text, help_text;</a>
<a name="ln1216">        switch (key)</a>
<a name="ln1217">        {</a>
<a name="ln1218">            case CK_ESCAPE: case ':': case '#': case '/': case 'q': case 'v':</a>
<a name="ln1219">                return false;</a>
<a name="ln1220">            default:</a>
<a name="ln1221">                if (!(page = _get_help_section(key, header_text, help_text, scroll)))</a>
<a name="ln1222">                    break;</a>
<a name="ln1223">                if (page != prev_page)</a>
<a name="ln1224">                {</a>
<a name="ln1225">                    contents = help_text;</a>
<a name="ln1226">                    m_contents_dirty = true;</a>
<a name="ln1227">                    prev_page = page;</a>
<a name="ln1228">                }</a>
<a name="ln1229">                scroll = scroll ? (scroll-2)*line_height : 0;</a>
<a name="ln1230">                set_scroll(scroll);</a>
<a name="ln1231">                return true;</a>
<a name="ln1232">        }</a>
<a name="ln1233"> </a>
<a name="ln1234">        return formatted_scroller::process_key(ch);</a>
<a name="ln1235">    };</a>
<a name="ln1236">    int prev_page{0};</a>
<a name="ln1237">};</a>
<a name="ln1238"> </a>
<a name="ln1239">static bool _show_help_special(int key)</a>
<a name="ln1240">{</a>
<a name="ln1241">    switch (key)</a>
<a name="ln1242">    {</a>
<a name="ln1243">        case ':':</a>
<a name="ln1244">            // If the game has begun, show notes.</a>
<a name="ln1245">            if (crawl_state.need_save)</a>
<a name="ln1246">                display_notes();</a>
<a name="ln1247">            return true;</a>
<a name="ln1248">        case '#':</a>
<a name="ln1249">            // If the game has begun, show dump.</a>
<a name="ln1250">            if (crawl_state.need_save)</a>
<a name="ln1251">                display_char_dump();</a>
<a name="ln1252">            return true;</a>
<a name="ln1253">        case '/':</a>
<a name="ln1254">            keyhelp_query_descriptions();</a>
<a name="ln1255">            return true;</a>
<a name="ln1256">        case 'q':</a>
<a name="ln1257">            _handle_FAQ();</a>
<a name="ln1258">            return true;</a>
<a name="ln1259">        case 'v':</a>
<a name="ln1260">            _print_version();</a>
<a name="ln1261">            return true;</a>
<a name="ln1262">        default:</a>
<a name="ln1263">            return false;</a>
<a name="ln1264">    }</a>
<a name="ln1265">}</a>
<a name="ln1266"> </a>
<a name="ln1267">void show_help(int section, string highlight_string)</a>
<a name="ln1268">{</a>
<a name="ln1269">    // if `section` is a special case, don't instantiate a help popup at all.</a>
<a name="ln1270">    if (_show_help_special(toalower(section)))</a>
<a name="ln1271">        return;</a>
<a name="ln1272">    help_popup help(section);</a>
<a name="ln1273">    help.highlight = highlight_string;</a>
<a name="ln1274">    int key = toalower(help.show());</a>
<a name="ln1275">    // handle the case where one of the special case help sections is triggered</a>
<a name="ln1276">    // from the help main menu.</a>
<a name="ln1277">    _show_help_special(key);</a>
<a name="ln1278">}</a>

</code></pre>
<div class="balloon" rel="1201"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v1053/" target="_blank">V1053</a> Calling the 'process_key' virtual function in the constructor may lead to unexpected result at runtime.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
