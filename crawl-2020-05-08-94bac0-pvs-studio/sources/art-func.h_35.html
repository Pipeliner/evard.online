
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=US-ASCII" />
  <title>art-func.h</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">/**</a>
<a name="ln2"> * @file</a>
<a name="ln3"> * @brief Functions non-standard unrandarts uses.</a>
<a name="ln4">**/</a>
<a name="ln5"> </a>
<a name="ln6">/*</a>
<a name="ln7"> * util/art-data.pl scans through this file to grab the functions</a>
<a name="ln8"> * non-standard unrandarts use and put them into the unranddata structs</a>
<a name="ln9"> * in art-data.h, so the function names must have the form of</a>
<a name="ln10"> * _UNRAND_ENUM_func_name() in order to be recognised.</a>
<a name="ln11"> */</a>
<a name="ln12"> </a>
<a name="ln13">#ifdef ART_FUNC_H</a>
<a name="ln14">#error &quot;art-func.h included twice!&quot;</a>
<a name="ln15">#endif</a>
<a name="ln16"> </a>
<a name="ln17">#ifdef ART_DATA_H</a>
<a name="ln18">#error &quot;art-func.h must be included before art-data.h&quot;</a>
<a name="ln19">#endif</a>
<a name="ln20"> </a>
<a name="ln21">#define ART_FUNC_H</a>
<a name="ln22"> </a>
<a name="ln23">#include &quot;areas.h&quot;         // For silenced() and invalidate_agrid()</a>
<a name="ln24">#include &quot;attack.h&quot;        // For attack_strength_punctuation()</a>
<a name="ln25">#include &quot;beam.h&quot;          // For Lajatang of Order's silver damage</a>
<a name="ln26">#include &quot;cloud.h&quot;         // For storm bow's and robe of clouds' rain</a>
<a name="ln27">#include &quot;coordit.h&quot;       // For distance_iterator()</a>
<a name="ln28">#include &quot;death-curse.h&quot;   // For the Scythe of Curses</a>
<a name="ln29">#include &quot;english.h&quot;       // For apostrophise</a>
<a name="ln30">#include &quot;exercise.h&quot;      // For practise_evoking</a>
<a name="ln31">#include &quot;fight.h&quot;</a>
<a name="ln32">#include &quot;food.h&quot;          // For evokes</a>
<a name="ln33">#include &quot;ghost.h&quot;         // For is_dragonkind ghost_demon datas</a>
<a name="ln34">#include &quot;god-conduct.h&quot;   // did_god_conduct</a>
<a name="ln35">#include &quot;god-passive.h&quot;   // passive_t::want_curses</a>
<a name="ln36">#include &quot;mgen-data.h&quot;     // For Sceptre of Asmodeus evoke</a>
<a name="ln37">#include &quot;monster.h&quot;</a>
<a name="ln38">#include &quot;mon-death.h&quot;     // For demon axe's SAME_ATTITUDE</a>
<a name="ln39">#include &quot;mon-place.h&quot;     // For Sceptre of Asmodeus evoke</a>
<a name="ln40">#include &quot;nearby-danger.h&quot; // For Zhor</a>
<a name="ln41">#include &quot;player.h&quot;</a>
<a name="ln42">#include &quot;player-stats.h&quot;</a>
<a name="ln43">#include &quot;showsymb.h&quot;      // For Cigotuvi's Embrace</a>
<a name="ln44">#include &quot;spl-cast.h&quot;      // For evokes</a>
<a name="ln45">#include &quot;spl-damage.h&quot;    // For the Singing Sword.</a>
<a name="ln46">#include &quot;spl-goditem.h&quot;   // For Sceptre of Torment tormenting</a>
<a name="ln47">#include &quot;spl-miscast.h&quot;   // For Spellbinder and plutonium sword miscasts</a>
<a name="ln48">#include &quot;spl-monench.h&quot;   // For Zhor's aura</a>
<a name="ln49">#include &quot;spl-summoning.h&quot; // For Zonguldrok animating dead</a>
<a name="ln50">#include &quot;terrain.h&quot;       // For storm bow</a>
<a name="ln51">#include &quot;view.h&quot;          // For arc blade's discharge effect</a>
<a name="ln52"> </a>
<a name="ln53">// prop recording whether the singing sword has said hello yet</a>
<a name="ln54">#define SS_WELCOME_KEY &quot;ss_welcome&quot;</a>
<a name="ln55">// similarly, for the majin-bo</a>
<a name="ln56">#define MB_WELCOME_KEY &quot;mb_welcome&quot;</a>
<a name="ln57"> </a>
<a name="ln58">/*******************</a>
<a name="ln59"> * Helper functions.</a>
<a name="ln60"> *******************/</a>
<a name="ln61"> </a>
<a name="ln62">static void _equip_mpr(bool* show_msgs, const char* msg,</a>
<a name="ln63">                       msg_channel_type chan = MSGCH_PLAIN)</a>
<a name="ln64">{</a>
<a name="ln65">    bool do_show = true;</a>
<a name="ln66">    if (show_msgs == nullptr)</a>
<a name="ln67">        show_msgs = &amp;do_show;</a>
<a name="ln68"> </a>
<a name="ln69">    if (*show_msgs)</a>
<a name="ln70">        mprf(chan, &quot;%s&quot;, msg);</a>
<a name="ln71"> </a>
<a name="ln72">    // Caller shouldn't give any more messages.</a>
<a name="ln73">    *show_msgs = false;</a>
<a name="ln74">}</a>
<a name="ln75"> </a>
<a name="ln76">/*******************</a>
<a name="ln77"> * Unrand functions.</a>
<a name="ln78"> *******************/</a>
<a name="ln79"> </a>
<a name="ln80">static bool _evoke_sceptre_of_asmodeus()</a>
<a name="ln81">{</a>
<a name="ln82">    if (!x_chance_in_y(you.skill(SK_EVOCATIONS, 100), 3000))</a>
<a name="ln83">        return false;</a>
<a name="ln84"> </a>
<a name="ln85">    const monster_type mon = random_choose_weighted(</a>
<a name="ln86">                                   3, MONS_EFREET,</a>
<a name="ln87">                                   3, MONS_SUN_DEMON,</a>
<a name="ln88">                                   3, MONS_BALRUG,</a>
<a name="ln89">                                   2, MONS_HELLION,</a>
<a name="ln90">                                   1, MONS_BRIMSTONE_FIEND);</a>
<a name="ln91"> </a>
<a name="ln92">    mgen_data mg(mon, BEH_CHARMED, you.pos(), MHITYOU,</a>
<a name="ln93">                 MG_FORCE_BEH, you.religion);</a>
<a name="ln94">    mg.set_summoned(&amp;you, 0, 0);</a>
<a name="ln95">    mg.extra_flags |= (MF_NO_REWARD | MF_HARD_RESET);</a>
<a name="ln96"> </a>
<a name="ln97">    monster *m = create_monster(mg);</a>
<a name="ln98"> </a>
<a name="ln99">    if (m)</a>
<a name="ln100">    {</a>
<a name="ln101">        mpr(&quot;The sceptre summons one of its servants.&quot;);</a>
<a name="ln102">        did_god_conduct(DID_EVIL, 3);</a>
<a name="ln103"> </a>
<a name="ln104">        m-&gt;add_ench(mon_enchant(ENCH_FAKE_ABJURATION, 6));</a>
<a name="ln105"> </a>
<a name="ln106">        if (!player_angers_monster(m))</a>
<a name="ln107">            mpr(&quot;You don't feel so good about this...&quot;);</a>
<a name="ln108">    }</a>
<a name="ln109">    else</a>
<a name="ln110">        mpr(&quot;The air shimmers briefly.&quot;);</a>
<a name="ln111"> </a>
<a name="ln112">    return true;</a>
<a name="ln113">}</a>
<a name="ln114"> </a>
<a name="ln115">static bool _ASMODEUS_evoke(item_def */*item*/, bool* did_work,</a>
<a name="ln116">                            bool* /*unevokable*/)</a>
<a name="ln117">{</a>
<a name="ln118">    if (_evoke_sceptre_of_asmodeus())</a>
<a name="ln119">    {</a>
<a name="ln120">        make_hungry(200, false, true);</a>
<a name="ln121">        *did_work = true;</a>
<a name="ln122">        practise_evoking(1);</a>
<a name="ln123">    }</a>
<a name="ln124"> </a>
<a name="ln125">    return false;</a>
<a name="ln126">}</a>
<a name="ln127"> </a>
<a name="ln128">////////////////////////////////////////////////////</a>
<a name="ln129">static void _CEREBOV_melee_effects(item_def* /*weapon*/, actor* attacker,</a>
<a name="ln130">                                   actor* defender, bool mondied, int dam)</a>
<a name="ln131">{</a>
<a name="ln132">    if (dam)</a>
<a name="ln133">    {</a>
<a name="ln134">        if (defender-&gt;is_player()</a>
<a name="ln135">            &amp;&amp; defender-&gt;res_fire() &lt;= 3</a>
<a name="ln136">            &amp;&amp; !you.duration[DUR_FIRE_VULN])</a>
<a name="ln137">        {</a>
<a name="ln138">            mpr(&quot;The sword of Cerebov burns away your fire resistance.&quot;);</a>
<a name="ln139">            you.increase_duration(DUR_FIRE_VULN, 3 + random2(dam), 50);</a>
<a name="ln140">        }</a>
<a name="ln141">        if (defender-&gt;is_monster()</a>
<a name="ln142">            &amp;&amp; !mondied</a>
<a name="ln143">            &amp;&amp; !defender-&gt;as_monster()-&gt;has_ench(ENCH_FIRE_VULN))</a>
<a name="ln144">        {</a>
<a name="ln145">            if (you.can_see(*attacker))</a>
<a name="ln146">            {</a>
<a name="ln147">                mprf(&quot;The sword of Cerebov burns away %s fire resistance.&quot;,</a>
<a name="ln148">                     defender-&gt;name(DESC_ITS).c_str());</a>
<a name="ln149">            }</a>
<a name="ln150">            defender-&gt;as_monster()-&gt;add_ench(</a>
<a name="ln151">                mon_enchant(ENCH_FIRE_VULN, 1, attacker,</a>
<a name="ln152">                            (3 + random2(dam)) * BASELINE_DELAY));</a>
<a name="ln153">        }</a>
<a name="ln154">    }</a>
<a name="ln155">}</a>
<a name="ln156"> </a>
<a name="ln157">////////////////////////////////////////////////////</a>
<a name="ln158"> </a>
<a name="ln159">static void _CURSES_equip(item_def */*item*/, bool *show_msgs, bool unmeld)</a>
<a name="ln160">{</a>
<a name="ln161">    _equip_mpr(show_msgs, &quot;A shiver runs down your spine.&quot;);</a>
<a name="ln162">    if (!unmeld)</a>
<a name="ln163">        death_curse(you, nullptr, &quot;the scythe of Curses&quot;, 0);</a>
<a name="ln164">}</a>
<a name="ln165"> </a>
<a name="ln166">static void _CURSES_melee_effects(item_def* /*weapon*/, actor* attacker,</a>
<a name="ln167">                                  actor* defender, bool mondied, int dam)</a>
<a name="ln168">{</a>
<a name="ln169">    if (attacker-&gt;is_player())</a>
<a name="ln170">        did_god_conduct(DID_EVIL, 3);</a>
<a name="ln171">    if (!mondied &amp;&amp; defender-&gt;holiness() == MH_NATURAL)</a>
<a name="ln172">        death_curse(*defender, attacker, &quot;the scythe of Curses&quot;, min(dam, 27));</a>
<a name="ln173">}</a>
<a name="ln174"> </a>
<a name="ln175">/////////////////////////////////////////////////////</a>
<a name="ln176"> </a>
<a name="ln177">static bool _DISPATER_evoke(item_def */*item*/, bool* did_work, bool* unevokable)</a>
<a name="ln178">{</a>
<a name="ln179">    if (!enough_hp(14, true))</a>
<a name="ln180">    {</a>
<a name="ln181">        mpr(&quot;You're too close to death to use this item.&quot;);</a>
<a name="ln182">        *unevokable = true;</a>
<a name="ln183">        return true;</a>
<a name="ln184">    }</a>
<a name="ln185"> </a>
<a name="ln186">    if (!enough_mp(4, false))</a>
<a name="ln187">    {</a>
<a name="ln188">        *unevokable = true;</a>
<a name="ln189">        return true;</a>
<a name="ln190">    }</a>
<a name="ln191"> </a>
<a name="ln192">    *did_work = true;</a>
<a name="ln193">    int power = you.skill(SK_EVOCATIONS, 8);</a>
<a name="ln194"> </a>
<a name="ln195">    if (your_spells(SPELL_HURL_DAMNATION, power, false) == spret::abort)</a>
<a name="ln196">    {</a>
<a name="ln197">        *unevokable = true;</a>
<a name="ln198">        return false;</a>
<a name="ln199">    }</a>
<a name="ln200"> </a>
<a name="ln201">    mpr(&quot;You feel the staff feeding on your energy!&quot;);</a>
<a name="ln202">    dec_hp(14, false);</a>
<a name="ln203">    dec_mp(4);</a>
<a name="ln204">    make_hungry(100, false, true);</a>
<a name="ln205">    practise_evoking(random_range(1, 2));</a>
<a name="ln206"> </a>
<a name="ln207">    return false;</a>
<a name="ln208">}</a>
<a name="ln209"> </a>
<a name="ln210">////////////////////////////////////////////////////</a>
<a name="ln211"> </a>
<a name="ln212">static void _FINISHER_melee_effects(item_def* /*weapon*/, actor* attacker,</a>
<a name="ln213">                                  actor* defender, bool mondied, int dam)</a>
<a name="ln214">{</a>
<a name="ln215">    // Can't kill a monster that's already dead.</a>
<a name="ln216">    // Can't kill a monster if we don't do damage.</a>
<a name="ln217">    // Don't insta-kill the player</a>
<a name="ln218">    if (mondied || dam == 0 || defender-&gt;is_player())</a>
<a name="ln219">        return;</a>
<a name="ln220"> </a>
<a name="ln221">    // Chance to insta-kill based on HD. From 1/4 for small HD popcorn down to</a>
<a name="ln222">    // 1/10 for an Orb of Fire (compare to the 3/20 chance for banish or</a>
<a name="ln223">    // instant teleport on distortion).</a>
<a name="ln224">    if (x_chance_in_y(50 - defender-&gt;get_hit_dice(), 200))</a>
<a name="ln225">    {</a>
<a name="ln226">        monster* mons = defender-&gt;as_monster();</a>
<a name="ln227">        mons-&gt;flags |= MF_EXPLODE_KILL;</a>
<a name="ln228">        mons-&gt;hurt(attacker, INSTANT_DEATH);</a>
<a name="ln229">    }</a>
<a name="ln230">}</a>
<a name="ln231"> </a>
<a name="ln232">////////////////////////////////////////////////////</a>
<a name="ln233"> </a>
<a name="ln234">// XXX: Staff giving a boost to poison spells is hardcoded in</a>
<a name="ln235">// player_spec_poison()</a>
<a name="ln236"> </a>
<a name="ln237">static void _OLGREB_equip(item_def */*item*/, bool *show_msgs, bool /*unmeld*/)</a>
<a name="ln238">{</a>
<a name="ln239">    if (you.can_smell())</a>
<a name="ln240">        _equip_mpr(show_msgs, &quot;You smell chlorine.&quot;);</a>
<a name="ln241">    else</a>
<a name="ln242">        _equip_mpr(show_msgs, &quot;The staff glows a sickly green.&quot;);</a>
<a name="ln243">}</a>
<a name="ln244"> </a>
<a name="ln245">static void _OLGREB_unequip(item_def */*item*/, bool *show_msgs)</a>
<a name="ln246">{</a>
<a name="ln247">    if (you.can_smell())</a>
<a name="ln248">        _equip_mpr(show_msgs, &quot;The smell of chlorine vanishes.&quot;);</a>
<a name="ln249">    else</a>
<a name="ln250">        _equip_mpr(show_msgs, &quot;The staff's sickly green glow vanishes.&quot;);</a>
<a name="ln251">}</a>
<a name="ln252"> </a>
<a name="ln253">static bool _OLGREB_evoke(item_def */*item*/, bool* did_work, bool* unevokable)</a>
<a name="ln254">{</a>
<a name="ln255">    if (!enough_mp(4, false))</a>
<a name="ln256">    {</a>
<a name="ln257">        *unevokable = true;</a>
<a name="ln258">        return true;</a>
<a name="ln259">    }</a>
<a name="ln260"> </a>
<a name="ln261">    if (!x_chance_in_y(you.skill(SK_EVOCATIONS, 100) + 100, 600))</a>
<a name="ln262">        return false;</a>
<a name="ln263"> </a>
<a name="ln264">    *did_work = true;</a>
<a name="ln265"> </a>
<a name="ln266">    int power = div_rand_round(20 + you.skill(SK_EVOCATIONS, 20), 4);</a>
<a name="ln267"> </a>
<a name="ln268">    // Allow aborting (for example if friendlies are nearby).</a>
<a name="ln269">    if (your_spells(SPELL_OLGREBS_TOXIC_RADIANCE, power, false) == spret::abort)</a>
<a name="ln270">    {</a>
<a name="ln271">        *unevokable = true;</a>
<a name="ln272">        return false;</a>
<a name="ln273">    }</a>
<a name="ln274"> </a>
<a name="ln275">    dec_mp(4);</a>
<a name="ln276">    make_hungry(50, false, true);</a>
<a name="ln277">    practise_evoking(1);</a>
<a name="ln278">    did_god_conduct(DID_WIZARDLY_ITEM, 10);</a>
<a name="ln279"> </a>
<a name="ln280">    return false;</a>
<a name="ln281">}</a>
<a name="ln282"> </a>
<a name="ln283">// Based on melee_attack::staff_damage(), but using only evocations skill.</a>
<a name="ln284">static int _calc_olgreb_damage(actor* attacker, actor* defender)</a>
<a name="ln285">{</a>
<a name="ln286">    int base_dam = 0;</a>
<a name="ln287">    if (x_chance_in_y(attacker-&gt;skill(SK_EVOCATIONS, 100), 1000))</a>
<a name="ln288">        base_dam = random2(attacker-&gt;skill(SK_EVOCATIONS, 150) / 80);</a>
<a name="ln289"> </a>
<a name="ln290">    return resist_adjust_damage(defender, BEAM_POISON_ARROW, base_dam);</a>
<a name="ln291">}</a>
<a name="ln292"> </a>
<a name="ln293"> </a>
<a name="ln294">static void _OLGREB_melee_effects(item_def* /*weapon*/, actor* attacker,</a>
<a name="ln295">                                  actor* defender, bool mondied,</a>
<a name="ln296">                                  int /*dam*/)</a>
<a name="ln297">{</a>
<a name="ln298">    const int bonus_dam = _calc_olgreb_damage(attacker, defender);</a>
<a name="ln299"> </a>
<a name="ln300">    if (!mondied &amp;&amp; bonus_dam)</a>
<a name="ln301">    {</a>
<a name="ln302">        mprf(&quot;%s %s %s%s&quot;,</a>
<a name="ln303">             attacker-&gt;name(DESC_THE).c_str(),</a>
<a name="ln304">             attacker-&gt;conj_verb(&quot;envenom&quot;).c_str(),</a>
<a name="ln305">             defender-&gt;name(DESC_THE).c_str(),</a>
<a name="ln306">             attack_strength_punctuation(bonus_dam).c_str());</a>
<a name="ln307"> </a>
<a name="ln308">        defender-&gt;hurt(attacker, bonus_dam);</a>
<a name="ln309">        if (defender-&gt;alive())</a>
<a name="ln310">            defender-&gt;poison(attacker, 2, true);</a>
<a name="ln311">    }</a>
<a name="ln312">}</a>
<a name="ln313"> </a>
<a name="ln314">////////////////////////////////////////////////////</a>
<a name="ln315"> </a>
<a name="ln316">static void _power_pluses(item_def *item)</a>
<a name="ln317">{</a>
<a name="ln318">    item-&gt;plus = min(you.hp / 10, 27);</a>
<a name="ln319">}</a>
<a name="ln320"> </a>
<a name="ln321">static void _POWER_equip(item_def *item, bool *show_msgs, bool /*unmeld*/)</a>
<a name="ln322">{</a>
<a name="ln323">    _equip_mpr(show_msgs, &quot;You sense an aura of extreme power.&quot;);</a>
<a name="ln324">    _power_pluses(item);</a>
<a name="ln325">}</a>
<a name="ln326"> </a>
<a name="ln327">static void _POWER_world_reacts(item_def *item)</a>
<a name="ln328">{</a>
<a name="ln329">    _power_pluses(item);</a>
<a name="ln330">}</a>
<a name="ln331"> </a>
<a name="ln332">////////////////////////////////////////////////////</a>
<a name="ln333"> </a>
<a name="ln334">static void _SINGING_SWORD_equip(item_def *item, bool *show_msgs, bool /*unmeld*/)</a>
<a name="ln335">{</a>
<a name="ln336">    bool def_show = true;</a>
<a name="ln337"> </a>
<a name="ln338">    if (show_msgs == nullptr)</a>
<a name="ln339">        show_msgs = &amp;def_show;</a>
<a name="ln340"> </a>
<a name="ln341">    if (!*show_msgs)</a>
<a name="ln342">        return;</a>
<a name="ln343"> </a>
<a name="ln344">    if (!item-&gt;props.exists(SS_WELCOME_KEY))</a>
<a name="ln345">    {</a>
<a name="ln346">        mprf(MSGCH_TALK, &quot;The sword says, \&quot;Hi! I'm the Singing Sword!\&quot;&quot;);</a>
<a name="ln347">        item-&gt;props[SS_WELCOME_KEY].get_bool() = true;</a>
<a name="ln348">    }</a>
<a name="ln349">    else</a>
<a name="ln350">        mprf(MSGCH_TALK, &quot;The Singing Sword hums in delight!&quot;);</a>
<a name="ln351"> </a>
<a name="ln352">    *show_msgs = false;</a>
<a name="ln353">}</a>
<a name="ln354"> </a>
<a name="ln355">static void _SINGING_SWORD_unequip(item_def *item, bool *show_msgs)</a>
<a name="ln356">{</a>
<a name="ln357">    set_artefact_name(*item, &quot;Singing Sword&quot;);</a>
<a name="ln358">    _equip_mpr(show_msgs, &quot;The Singing Sword sighs.&quot;, MSGCH_TALK);</a>
<a name="ln359">}</a>
<a name="ln360"> </a>
<a name="ln361">static void _SINGING_SWORD_world_reacts(item_def *item)</a>
<a name="ln362">{</a>
<a name="ln363">    int tension = get_tension(GOD_NO_GOD);</a>
<a name="ln364">    int tier = max(1, min(4, 1 + tension / 20));</a>
<a name="ln365">    bool silent = silenced(you.pos());</a>
<a name="ln366"> </a>
<a name="ln367">    string old_name = get_artefact_name(*item);</a>
<a name="ln368">    string new_name;</a>
<a name="ln369">    if (silent)</a>
<a name="ln370">        new_name = &quot;Sulking Sword&quot;;</a>
<a name="ln371">    else if (tier &lt; 4)</a>
<a name="ln372">        new_name = &quot;Singing Sword&quot;;</a>
<a name="ln373">    else</a>
<a name="ln374">        new_name = &quot;Screaming Sword&quot;;</a>
<a name="ln375">    if (old_name != new_name)</a>
<a name="ln376">    {</a>
<a name="ln377">        set_artefact_name(*item, new_name);</a>
<a name="ln378">        you.wield_change = true;</a>
<a name="ln379">    }</a>
<a name="ln380">}</a>
<a name="ln381"> </a>
<a name="ln382">static void _SINGING_SWORD_melee_effects(item_def* weapon, actor* attacker,</a>
<a name="ln383">                                         actor* /* defender */,</a>
<a name="ln384">                                         bool /*mondied*/, int /*dam*/)</a>
<a name="ln385">{</a>
<a name="ln386">    int tier;</a>
<a name="ln387"> </a>
<a name="ln388">    if (attacker-&gt;is_player())</a>
<a name="ln389">        tier = max(1, min(4, 1 + get_tension(GOD_NO_GOD) / 20));</a>
<a name="ln390">    // Don't base the sword on player state when the player isn't wielding it.</a>
<a name="ln391">    else</a>
<a name="ln392">        tier = 1;</a>
<a name="ln393"> </a>
<a name="ln394">    if (silenced(attacker-&gt;pos()))</a>
<a name="ln395">        tier = 0;</a>
<a name="ln396"> </a>
<a name="ln397">    dprf(DIAG_COMBAT, &quot;Singing sword tension: %d, tier: %d&quot;,</a>
<a name="ln398">                attacker-&gt;is_player() ? get_tension(GOD_NO_GOD) : -1, tier);</a>
<a name="ln399"> </a>
<a name="ln400">    // Not as spammy at low tension. Max chance reached at tier 3, allowing</a>
<a name="ln401">    // tier 0 to have a high chance so that the sword is likely to express its</a>
<a name="ln402">    // unhappiness with being silenced.</a>
<a name="ln403">    if (!x_chance_in_y(6, (tier == 1) ? 24: (tier == 2) ? 16: 12))</a>
<a name="ln404">        return;</a>
<a name="ln405"> </a>
<a name="ln406">    const char *tenname[] =  {&quot;silenced&quot;, &quot;no_tension&quot;, &quot;low_tension&quot;,</a>
<a name="ln407">                              &quot;high_tension&quot;, &quot;SCREAM&quot;};</a>
<a name="ln408">    const string key = tenname[tier];</a>
<a name="ln409">    string msg = getSpeakString(&quot;singing sword &quot; + key);</a>
<a name="ln410"> </a>
<a name="ln411">    const int loudness[] = {0, 0, 20, 30, 40};</a>
<a name="ln412"> </a>
<a name="ln413">    item_noise(*weapon, *attacker, msg, loudness[tier]);</a>
<a name="ln414"> </a>
<a name="ln415">    if (tier &lt; 1)</a>
<a name="ln416">        return; // Can't cast when silenced.</a>
<a name="ln417"> </a>
<a name="ln418">    const int spellpower = 100 + 13 * (tier - 1) + (tier == 4 ? 36 : 0);</a>
<a name="ln419">    fire_los_attack_spell(SPELL_SONIC_WAVE, spellpower, attacker);</a>
<a name="ln420">}</a>
<a name="ln421">////////////////////////////////////////////////////</a>
<a name="ln422"> </a>
<a name="ln423">static void _PRUNE_equip(item_def */*item*/, bool *show_msgs, bool /*unmeld*/)</a>
<a name="ln424">{</a>
<a name="ln425">    _equip_mpr(show_msgs, &quot;You feel pruney.&quot;);</a>
<a name="ln426">}</a>
<a name="ln427"> </a>
<a name="ln428">static void _PRUNE_world_reacts(item_def */*item*/)</a>
<a name="ln429">{</a>
<a name="ln430">    if (one_chance_in(10))</a>
<a name="ln431">        did_god_conduct(DID_CHAOS, 1);</a>
<a name="ln432">}</a>
<a name="ln433"> </a>
<a name="ln434">////////////////////////////////////////////////////</a>
<a name="ln435"> </a>
<a name="ln436">static void _TORMENT_equip(item_def */*item*/, bool *show_msgs, bool /*unmeld*/)</a>
<a name="ln437">{</a>
<a name="ln438">    _equip_mpr(show_msgs, &quot;A terribly searing pain shoots up your arm!&quot;);</a>
<a name="ln439">}</a>
<a name="ln440"> </a>
<a name="ln441">static void _TORMENT_melee_effects(item_def* /*weapon*/, actor* attacker,</a>
<a name="ln442">                                   actor* /*defender*/, bool /*mondied*/,</a>
<a name="ln443">                                   int /*dam*/)</a>
<a name="ln444">{</a>
<a name="ln445">    if (one_chance_in(5))</a>
<a name="ln446">        torment(attacker, TORMENT_SCEPTRE, attacker-&gt;pos());</a>
<a name="ln447">}</a>
<a name="ln448"> </a>
<a name="ln449">/////////////////////////////////////////////////////</a>
<a name="ln450"> </a>
<a name="ln451">static void _TROG_equip(item_def */*item*/, bool *show_msgs, bool /*unmeld*/)</a>
<a name="ln452">{</a>
<a name="ln453">    _equip_mpr(show_msgs, &quot;You feel bloodthirsty!&quot;);</a>
<a name="ln454">}</a>
<a name="ln455"> </a>
<a name="ln456">static void _TROG_unequip(item_def */*item*/, bool *show_msgs)</a>
<a name="ln457">{</a>
<a name="ln458">    _equip_mpr(show_msgs, &quot;You feel less violent.&quot;);</a>
<a name="ln459">}</a>
<a name="ln460"> </a>
<a name="ln461">////////////////////////////////////////////////////</a>
<a name="ln462"> </a>
<a name="ln463">static void _wucad_backfire()</a>
<a name="ln464">{</a>
<a name="ln465">    switch (random2(7))</a>
<a name="ln466">    {</a>
<a name="ln467">    case 0:</a>
<a name="ln468">    case 1:</a>
<a name="ln469">        switch (random2(4))</a>
<a name="ln470">        {</a>
<a name="ln471">        case 0:</a>
<a name="ln472">            mpr(&quot;Weird images run through your mind.&quot;);</a>
<a name="ln473">            break;</a>
<a name="ln474">        case 1:</a>
<a name="ln475">            mpr(&quot;Your head hurts.&quot;);</a>
<a name="ln476">            break;</a>
<a name="ln477">        case 2:</a>
<a name="ln478">            mpr(&quot;You feel a strange surge of energy.&quot;);</a>
<a name="ln479">            break;</a>
<a name="ln480">        case 3:</a>
<a name="ln481">            mpr(&quot;You feel uncomfortable.&quot;);</a>
<a name="ln482">            break;</a>
<a name="ln483">        }</a>
<a name="ln484">        break;</a>
<a name="ln485">    case 2:</a>
<a name="ln486">    case 3:</a>
<a name="ln487">        confuse_player(2 + random2(4));</a>
<a name="ln488">        break;</a>
<a name="ln489">    case 4:</a>
<a name="ln490">    case 5:</a>
<a name="ln491">        dec_mp(5 + random2(20));</a>
<a name="ln492">        break;</a>
<a name="ln493">    case 6:</a>
<a name="ln494">        lose_stat(STAT_INT, 1 + random2avg(5, 2));</a>
<a name="ln495">        break;</a>
<a name="ln496">    }</a>
<a name="ln497">}</a>
<a name="ln498"> </a>
<a name="ln499">static bool _WUCAD_MU_evoke(item_def */*item*/, bool* did_work, bool* unevokable)</a>
<a name="ln500">{</a>
<a name="ln501">    if (you.magic_points == you.max_magic_points)</a>
<a name="ln502">    {</a>
<a name="ln503">        mpr(&quot;Your reserves of magic are full.&quot;);</a>
<a name="ln504">        *unevokable = true;</a>
<a name="ln505">        return true;</a>
<a name="ln506">    }</a>
<a name="ln507"> </a>
<a name="ln508">    if (!x_chance_in_y(you.skill(SK_EVOCATIONS, 100) + 100, 2500))</a>
<a name="ln509">        return false;</a>
<a name="ln510"> </a>
<a name="ln511">    if (one_chance_in(4))</a>
<a name="ln512">    {</a>
<a name="ln513">        _wucad_backfire();</a>
<a name="ln514">        did_god_conduct(DID_CHANNEL, 10, true);</a>
<a name="ln515">        did_god_conduct(DID_WIZARDLY_ITEM, 10);</a>
<a name="ln516">        return false;</a>
<a name="ln517">    }</a>
<a name="ln518"> </a>
<a name="ln519">    mpr(&quot;Magical energy flows into your mind!&quot;);</a>
<a name="ln520"> </a>
<a name="ln521">    const int mp_inc_base = 3 + random2(5);</a>
<a name="ln522">    inc_mp(mp_inc_base + you.skill_rdiv(SK_EVOCATIONS, 1, 3));</a>
<a name="ln523">    make_hungry(50, false, true);</a>
<a name="ln524"> </a>
<a name="ln525">    *did_work = true;</a>
<a name="ln526">    practise_evoking(1);</a>
<a name="ln527">    did_god_conduct(DID_CHANNEL, 10, true);</a>
<a name="ln528">    did_god_conduct(DID_WIZARDLY_ITEM, 10);</a>
<a name="ln529"> </a>
<a name="ln530">    return false;</a>
<a name="ln531">}</a>
<a name="ln532"> </a>
<a name="ln533">///////////////////////////////////////////////////</a>
<a name="ln534"> </a>
<a name="ln535">// XXX: Always getting maximal vampiric drain is hardcoded in</a>
<a name="ln536">// attack::apply_damage_brand()</a>
<a name="ln537"> </a>
<a name="ln538">static void _VAMPIRES_TOOTH_equip(item_def */*item*/, bool *show_msgs, bool /*unmeld*/)</a>
<a name="ln539">{</a>
<a name="ln540">    if (you.undead_state() == US_ALIVE</a>
<a name="ln541">        &amp;&amp; (you.species == SP_VAMPIRE || !you_foodless()))</a>
<a name="ln542">    {</a>
<a name="ln543">        _equip_mpr(show_msgs,</a>
<a name="ln544">                   &quot;You feel a strange hunger, and smell blood in the air...&quot;);</a>
<a name="ln545">    }</a>
<a name="ln546">    else if (you.species != SP_VAMPIRE)</a>
<a name="ln547">        _equip_mpr(show_msgs, &quot;You feel strangely empty.&quot;);</a>
<a name="ln548">    // else let player-equip.cc handle message</a>
<a name="ln549">}</a>
<a name="ln550"> </a>
<a name="ln551">///////////////////////////////////////////////////</a>
<a name="ln552"> </a>
<a name="ln553">static void _VARIABILITY_melee_effects(item_def* /*weapon*/, actor* attacker,</a>
<a name="ln554">                                       actor* /*defender*/, bool mondied,</a>
<a name="ln555">                                       int /*dam*/)</a>
<a name="ln556">{</a>
<a name="ln557">    if (!mondied &amp;&amp; one_chance_in(5))</a>
<a name="ln558">    {</a>
<a name="ln559">        const int pow = 75 + random2avg(75, 2);</a>
<a name="ln560">        if (you.can_see(*attacker))</a>
<a name="ln561">            mpr(&quot;The mace of Variability scintillates.&quot;);</a>
<a name="ln562">        cast_chain_spell(SPELL_CHAIN_OF_CHAOS, pow, attacker);</a>
<a name="ln563">    }</a>
<a name="ln564">}</a>
<a name="ln565"> </a>
<a name="ln566">///////////////////////////////////////////////////</a>
<a name="ln567"> </a>
<a name="ln568">static void _ZONGULDROK_equip(item_def */*item*/, bool *show_msgs,</a>
<a name="ln569">                              bool /*unmeld*/)</a>
<a name="ln570">{</a>
<a name="ln571">    _equip_mpr(show_msgs, &quot;You sense an extremely unholy aura.&quot;);</a>
<a name="ln572">}</a>
<a name="ln573"> </a>
<a name="ln574">static void _ZONGULDROK_melee_effects(item_def* /*weapon*/, actor* attacker,</a>
<a name="ln575">                                      actor* /*defender*/, bool /*mondied*/,</a>
<a name="ln576">                                      int /*dam*/)</a>
<a name="ln577">{</a>
<a name="ln578">    if (attacker-&gt;is_player())</a>
<a name="ln579">        did_god_conduct(DID_EVIL, 3);</a>
<a name="ln580">}</a>
<a name="ln581"> </a>
<a name="ln582">///////////////////////////////////////////////////</a>
<a name="ln583"> </a>
<a name="ln584">static void _GONG_melee_effects(item_def* /*item*/, actor* wearer,</a>
<a name="ln585">                                actor* /*attacker*/, bool /*dummy*/,</a>
<a name="ln586">                                int /*dam*/)</a>
<a name="ln587">{</a>
<a name="ln588">    if (silenced(wearer-&gt;pos()))</a>
<a name="ln589">        return;</a>
<a name="ln590"> </a>
<a name="ln591">    string msg = getSpeakString(&quot;shield of the gong&quot;);</a>
<a name="ln592">    if (msg.empty())</a>
<a name="ln593">        msg = &quot;You hear a strange loud sound.&quot;;</a>
<a name="ln594">    mprf(MSGCH_SOUND, &quot;%s&quot;, msg.c_str());</a>
<a name="ln595"> </a>
<a name="ln596">    noisy(40, wearer-&gt;pos());</a>
<a name="ln597">}</a>
<a name="ln598"> </a>
<a name="ln599">///////////////////////////////////////////////////</a>
<a name="ln600"> </a>
<a name="ln601">static void _DEMON_AXE_melee_effects(item_def* /*item*/, actor* attacker,</a>
<a name="ln602">                                     actor* /*defender*/, bool /*mondied*/,</a>
<a name="ln603">                                     int /*dam*/)</a>
<a name="ln604">{</a>
<a name="ln605">    if (one_chance_in(10))</a>
<a name="ln606">    {</a>
<a name="ln607">        if (monster* mons = attacker-&gt;as_monster())</a>
<a name="ln608">        {</a>
<a name="ln609">            create_monster(</a>
<a name="ln610">                mgen_data(summon_any_demon(RANDOM_DEMON_COMMON),</a>
<a name="ln611">                          SAME_ATTITUDE(mons), mons-&gt;pos(), mons-&gt;foe)</a>
<a name="ln612">                .set_summoned(mons, 6, SPELL_SUMMON_DEMON));</a>
<a name="ln613">        }</a>
<a name="ln614">        else</a>
<a name="ln615">            cast_summon_demon(50+random2(100));</a>
<a name="ln616">    }</a>
<a name="ln617">}</a>
<a name="ln618"> </a>
<a name="ln619">static monster* _find_nearest_possible_beholder()</a>
<a name="ln620">{</a>
<a name="ln621">    for (distance_iterator di(you.pos(), true, true, LOS_RADIUS); di; ++di)</a>
<a name="ln622">    {</a>
<a name="ln623">        monster *mon = monster_at(*di);</a>
<a name="ln624">        if (mon &amp;&amp; you.can_see(*mon)</a>
<a name="ln625">            &amp;&amp; you.possible_beholder(mon)</a>
<a name="ln626">            &amp;&amp; mons_is_threatening(*mon))</a>
<a name="ln627">        {</a>
<a name="ln628">            return mon;</a>
<a name="ln629">        }</a>
<a name="ln630">    }</a>
<a name="ln631"> </a>
<a name="ln632">    return nullptr;</a>
<a name="ln633">}</a>
<a name="ln634"> </a>
<a name="ln635">static void _DEMON_AXE_world_reacts(item_def */*item*/)</a>
<a name="ln636">{</a>
<a name="ln637"> </a>
<a name="ln638">    monster* mon = _find_nearest_possible_beholder();</a>
<a name="ln639"> </a>
<a name="ln640">    if (!mon)</a>
<a name="ln641">        return;</a>
<a name="ln642"> </a>
<a name="ln643">    monster&amp; closest = *mon;</a>
<a name="ln644"> </a>
<a name="ln645">    if (!you.beheld_by(closest))</a>
<a name="ln646">    {</a>
<a name="ln647">        mprf(&quot;Visions of slaying %s flood into your mind.&quot;,</a>
<a name="ln648">             closest.name(DESC_THE).c_str());</a>
<a name="ln649"> </a>
<a name="ln650">        // The monsters (if any) currently mesmerising the player do not include</a>
<a name="ln651">        // this monster. To avoid trapping the player, all other beholders</a>
<a name="ln652">        // are removed.</a>
<a name="ln653"> </a>
<a name="ln654">        you.clear_beholders();</a>
<a name="ln655">    }</a>
<a name="ln656"> </a>
<a name="ln657">    if (you.confused())</a>
<a name="ln658">    {</a>
<a name="ln659">        mpr(&quot;Your confusion fades away as the thirst for blood takes over your mind.&quot;);</a>
<a name="ln660">        you.duration[DUR_CONF] = 0;</a>
<a name="ln661">    }</a>
<a name="ln662"> </a>
<a name="ln663">    you.add_beholder(closest, true);</a>
<a name="ln664">}</a>
<a name="ln665"> </a>
<a name="ln666">static void _DEMON_AXE_unequip(item_def */*item*/, bool */*show_msgs*/)</a>
<a name="ln667">{</a>
<a name="ln668">    if (you.beheld())</a>
<a name="ln669">    {</a>
<a name="ln670">        // This shouldn't clear sirens and merfolk avatars, but we lack the</a>
<a name="ln671">        // information why they behold us -- usually, it's due to the axe.</a>
<a name="ln672">        // Since unwielding it costs scrolls of rem curse, we might say getting</a>
<a name="ln673">        // the demon away is enough of a shock to get you back to senses.</a>
<a name="ln674">        you.clear_beholders();</a>
<a name="ln675">        mpr(&quot;Your thirst for blood fades away.&quot;);</a>
<a name="ln676">    }</a>
<a name="ln677">}</a>
<a name="ln678"> </a>
<a name="ln679">///////////////////////////////////////////////////</a>
<a name="ln680"> </a>
<a name="ln681">static void _WYRMBANE_equip(item_def */*item*/, bool *show_msgs, bool /*unmeld*/)</a>
<a name="ln682">{</a>
<a name="ln683">    _equip_mpr(show_msgs,</a>
<a name="ln684">               species_is_draconian(you.species)</a>
<a name="ln685">                || you.form == transformation::dragon</a>
<a name="ln686">                   ? &quot;You feel an overwhelming desire to commit suicide.&quot;</a>
<a name="ln687">                   : &quot;You feel an overwhelming desire to slay dragons!&quot;);</a>
<a name="ln688">}</a>
<a name="ln689"> </a>
<a name="ln690">static bool is_dragonkind(const actor *act)</a>
<a name="ln691">{</a>
<a name="ln692">    if (mons_genus(act-&gt;mons_species()) == MONS_DRAGON</a>
<a name="ln693">        || mons_genus(act-&gt;mons_species()) == MONS_DRAKE</a>
<a name="ln694">        || mons_genus(act-&gt;mons_species()) == MONS_DRACONIAN)</a>
<a name="ln695">    {</a>
<a name="ln696">        return true;</a>
<a name="ln697">    }</a>
<a name="ln698"> </a>
<a name="ln699">    if (act-&gt;is_player())</a>
<a name="ln700">        return you.form == transformation::dragon;</a>
<a name="ln701"> </a>
<a name="ln702">    // Else the actor is a monster.</a>
<a name="ln703">    const monster* mon = act-&gt;as_monster();</a>
<a name="ln704"> </a>
<a name="ln705">    if (mons_is_zombified(*mon)</a>
<a name="ln706">        &amp;&amp; (mons_genus(mon-&gt;base_monster) == MONS_DRAGON</a>
<a name="ln707">            || mons_genus(mon-&gt;base_monster) == MONS_DRAKE</a>
<a name="ln708">            || mons_genus(mon-&gt;base_monster) == MONS_DRACONIAN))</a>
<a name="ln709">    {</a>
<a name="ln710">        return true;</a>
<a name="ln711">    }</a>
<a name="ln712"> </a>
<a name="ln713">    if (mons_is_ghost_demon(mon-&gt;type)</a>
<a name="ln714">        &amp;&amp; species_is_draconian(mon-&gt;ghost-&gt;species))</a>
<a name="ln715">    {</a>
<a name="ln716">        return true;</a>
<a name="ln717">    }</a>
<a name="ln718"> </a>
<a name="ln719">    return false;</a>
<a name="ln720">}</a>
<a name="ln721"> </a>
<a name="ln722">static void _WYRMBANE_melee_effects(item_def* weapon, actor* attacker,</a>
<a name="ln723">                                    actor* defender, bool mondied, int dam)</a>
<a name="ln724">{</a>
<a name="ln725">    if (!defender || !is_dragonkind(defender))</a>
<a name="ln726">        return;</a>
<a name="ln727"> </a>
<a name="ln728">    // Since the target will become a DEAD MONSTER if it dies due to the extra</a>
<a name="ln729">    // damage to dragons, we need to grab this information now.</a>
<a name="ln730">    int hd = min(defender-&gt;get_experience_level(), 18);</a>
<a name="ln731">    string name = defender-&gt;name(DESC_THE);</a>
<a name="ln732"> </a>
<a name="ln733">    if (!mondied)</a>
<a name="ln734">    {</a>
<a name="ln735">        int bonus_dam = 1 + random2(3 * dam / 2);</a>
<a name="ln736">        mprf(&quot;%s %s%s&quot;,</a>
<a name="ln737">            defender-&gt;name(DESC_THE).c_str(),</a>
<a name="ln738">            defender-&gt;conj_verb(&quot;convulse&quot;).c_str(),</a>
<a name="ln739">            attack_strength_punctuation(bonus_dam).c_str());</a>
<a name="ln740"> </a>
<a name="ln741">        defender-&gt;hurt(attacker, bonus_dam);</a>
<a name="ln742"> </a>
<a name="ln743">        // Allow the lance to charge when killing dragonform felid players.</a>
<a name="ln744">        mondied = defender-&gt;is_player() ? defender-&gt;as_player()-&gt;pending_revival</a>
<a name="ln745">                                        : !defender-&gt;alive();</a>
<a name="ln746">    }</a>
<a name="ln747"> </a>
<a name="ln748">    if (!mondied || defender-&gt;is_summoned()</a>
<a name="ln749">        || (defender-&gt;is_monster()</a>
<a name="ln750">            &amp;&amp; testbits(defender-&gt;as_monster()-&gt;flags, MF_NO_REWARD)))</a>
<a name="ln751">    {</a>
<a name="ln752">        return;</a>
<a name="ln753">    }</a>
<a name="ln754"> </a>
<a name="ln755">    // The cap can be reached by:</a>
<a name="ln756">    // * iron dragon, golden dragon, pearl dragon (18)</a>
<a name="ln757">    // * Xtahua (19)</a>
<a name="ln758">    // * bone dragon, Serpent of Hell (20)</a>
<a name="ln759">    // * Tiamat (22)</a>
<a name="ln760">    // * pghosts (up to 27)</a>
<a name="ln761">    dprf(&quot;Killed a drac with hd %d.&quot;, hd);</a>
<a name="ln762"> </a>
<a name="ln763">    if (weapon-&gt;plus &lt; hd)</a>
<a name="ln764">    {</a>
<a name="ln765">        weapon-&gt;plus++;</a>
<a name="ln766"> </a>
<a name="ln767">        // Including you, if you were a dragonform felid with lives left.</a>
<a name="ln768">        if (weapon-&gt;plus == 18)</a>
<a name="ln769">        {</a>
<a name="ln770">            mprf(&quot;&lt;white&gt;The lance glows brightly as it skewers %s. You feel &quot;</a>
<a name="ln771">                 &quot;that it has reached its full power.&lt;/white&gt;&quot;,</a>
<a name="ln772">                 name.c_str());</a>
<a name="ln773">        }</a>
<a name="ln774">        else</a>
<a name="ln775">        {</a>
<a name="ln776">            mprf(&quot;&lt;green&gt;The lance glows as it skewers %s.&lt;/green&gt;&quot;,</a>
<a name="ln777">                 name.c_str());</a>
<a name="ln778">        }</a>
<a name="ln779"> </a>
<a name="ln780">        you.wield_change = true;</a>
<a name="ln781">    }</a>
<a name="ln782">}</a>
<a name="ln783"> </a>
<a name="ln784">///////////////////////////////////////////////////</a>
<a name="ln785"> </a>
<a name="ln786">static void _UNDEADHUNTER_melee_effects(item_def* /*item*/, actor* attacker,</a>
<a name="ln787">                                        actor* defender, bool mondied, int dam)</a>
<a name="ln788">{</a>
<a name="ln789">    if (defender-&gt;holiness() &amp; MH_UNDEAD &amp;&amp; !one_chance_in(3)</a>
<a name="ln790">        &amp;&amp; !mondied &amp;&amp; dam)</a>
<a name="ln791">    {</a>
<a name="ln792">        int bonus_dam = random2avg((1 + (dam * 3)), 3);</a>
<a name="ln793">        mprf(&quot;%s %s blasted by disruptive energy%s&quot;,</a>
<a name="ln794">              defender-&gt;name(DESC_THE).c_str(),</a>
<a name="ln795">              defender-&gt;conj_verb(&quot;be&quot;).c_str(),</a>
<a name="ln796">              attack_strength_punctuation(bonus_dam).c_str());</a>
<a name="ln797">        defender-&gt;hurt(attacker, bonus_dam);</a>
<a name="ln798">    }</a>
<a name="ln799">}</a>
<a name="ln800"> </a>
<a name="ln801">///////////////////////////////////////////////////</a>
<a name="ln802">static void _EOS_equip(item_def */*item*/, bool */*show_msgs*/, bool /*unmeld*/)</a>
<a name="ln803">{</a>
<a name="ln804">    invalidate_agrid(true);</a>
<a name="ln805">}</a>
<a name="ln806"> </a>
<a name="ln807">static void _EOS_unequip(item_def */*item*/, bool */*show_msgs*/)</a>
<a name="ln808">{</a>
<a name="ln809">    invalidate_agrid(true);</a>
<a name="ln810">}</a>
<a name="ln811"> </a>
<a name="ln812">///////////////////////////////////////////////////</a>
<a name="ln813">static void _SHADOWS_equip(item_def */*item*/, bool */*show_msgs*/, bool /*unmeld*/)</a>
<a name="ln814">{</a>
<a name="ln815">    invalidate_agrid(true);</a>
<a name="ln816">}</a>
<a name="ln817"> </a>
<a name="ln818">static void _SHADOWS_unequip(item_def */*item*/, bool */*show_msgs*/)</a>
<a name="ln819">{</a>
<a name="ln820">    invalidate_agrid(true);</a>
<a name="ln821">}</a>
<a name="ln822"> </a>
<a name="ln823">///////////////////////////////////////////////////</a>
<a name="ln824">static void _DEVASTATOR_equip(item_def */*item*/, bool *show_msgs,</a>
<a name="ln825">                              bool /*unmeld*/)</a>
<a name="ln826">{</a>
<a name="ln827">    _equip_mpr(show_msgs, &quot;Time to lay down the shillelagh law.&quot;);</a>
<a name="ln828">}</a>
<a name="ln829"> </a>
<a name="ln830">static void _DEVASTATOR_melee_effects(item_def* /*item*/, actor* attacker,</a>
<a name="ln831">                                      actor* defender, bool /*mondied*/,</a>
<a name="ln832">                                      int dam)</a>
<a name="ln833">{</a>
<a name="ln834">    if (dam)</a>
<a name="ln835">        shillelagh(attacker, defender-&gt;pos(), dam);</a>
<a name="ln836">}</a>
<a name="ln837"> </a>
<a name="ln838">///////////////////////////////////////////////////</a>
<a name="ln839">static void _DRAGONSKIN_equip(item_def */*item*/, bool *show_msgs, bool /*unmeld*/)</a>
<a name="ln840">{</a>
<a name="ln841">    _equip_mpr(show_msgs, &quot;You feel oddly protected from the elements.&quot;);</a>
<a name="ln842">}</a>
<a name="ln843"> </a>
<a name="ln844">static void _DRAGONSKIN_unequip(item_def */*item*/, bool *show_msgs)</a>
<a name="ln845">{</a>
<a name="ln846">    _equip_mpr(show_msgs, &quot;You no longer feel protected from the elements.&quot;);</a>
<a name="ln847">}</a>
<a name="ln848"> </a>
<a name="ln849">///////////////////////////////////////////////////</a>
<a name="ln850">static void _BLACK_KNIGHT_HORSE_world_reacts(item_def */*item*/)</a>
<a name="ln851">{</a>
<a name="ln852">    if (one_chance_in(10))</a>
<a name="ln853">        did_god_conduct(DID_EVIL, 1);</a>
<a name="ln854">}</a>
<a name="ln855"> </a>
<a name="ln856">///////////////////////////////////////////////////</a>
<a name="ln857">static void _NIGHT_equip(item_def */*item*/, bool *show_msgs, bool /*unmeld*/)</a>
<a name="ln858">{</a>
<a name="ln859">    update_vision_range();</a>
<a name="ln860">    _equip_mpr(show_msgs, &quot;The light fades from your surroundings.&quot;);</a>
<a name="ln861">}</a>
<a name="ln862"> </a>
<a name="ln863">static void _NIGHT_unequip(item_def */*item*/, bool *show_msgs)</a>
<a name="ln864">{</a>
<a name="ln865">    update_vision_range();</a>
<a name="ln866">    _equip_mpr(show_msgs, &quot;The light returns to your surroundings.&quot;);</a>
<a name="ln867">}</a>
<a name="ln868"> </a>
<a name="ln869">///////////////////////////////////////////////////</a>
<a name="ln870"> </a>
<a name="ln871">static void _PLUTONIUM_SWORD_melee_effects(item_def* /*weapon*/,</a>
<a name="ln872">                                           actor* attacker, actor* defender,</a>
<a name="ln873">                                           bool mondied, int dam)</a>
<a name="ln874">{</a>
<a name="ln875">    if (!mondied &amp;&amp; one_chance_in(5) &amp;&amp; defender-&gt;can_mutate())</a>
<a name="ln876">    {</a>
<a name="ln877">        mpr(&quot;Mutagenic energy flows through the plutonium sword!&quot;);</a>
<a name="ln878"> </a>
<a name="ln879">        if (attacker-&gt;is_player())</a>
<a name="ln880">            did_god_conduct(DID_CHAOS, 3);</a>
<a name="ln881"> </a>
<a name="ln882">        if (one_chance_in(10))</a>
<a name="ln883">            defender-&gt;polymorph(0); // Low duration if applied to the player.</a>
<a name="ln884">        else</a>
<a name="ln885">        {</a>
<a name="ln886">            miscast_effect(*defender, attacker, {miscast_source::melee},</a>
<a name="ln887">                           spschool::transmutation, 5, random2(dam),</a>
<a name="ln888">                           &quot;the plutonium sword&quot;);</a>
<a name="ln889">        }</a>
<a name="ln890">    }</a>
<a name="ln891">}</a>
<a name="ln892"> </a>
<a name="ln893">///////////////////////////////////////////////////</a>
<a name="ln894"> </a>
<a name="ln895">static void _SNAKEBITE_melee_effects(item_def* /*weapon*/, actor* attacker,</a>
<a name="ln896">                                     actor* defender, bool mondied, int /*dam*/)</a>
<a name="ln897">{</a>
<a name="ln898">    if (!mondied &amp;&amp; x_chance_in_y(2, 5))</a>
<a name="ln899">    {</a>
<a name="ln900">        curare_actor(attacker, defender, 2, &quot;curare&quot;,</a>
<a name="ln901">                     attacker-&gt;name(DESC_PLAIN));</a>
<a name="ln902">    }</a>
<a name="ln903">}</a>
<a name="ln904"> </a>
<a name="ln905">///////////////////////////////////////////////////</a>
<a name="ln906"> </a>
<a name="ln907">static void _WOE_melee_effects(item_def* /*weapon*/, actor* attacker,</a>
<a name="ln908">                               actor* defender, bool mondied, int /*dam*/)</a>
<a name="ln909">{</a>
<a name="ln910">    const char *verb = &quot;bugger&quot;, *adv = &quot;&quot;;</a>
<a name="ln911">    switch (random2(8))</a>
<a name="ln912">    {</a>
<a name="ln913">    case 0: verb = &quot;cleave&quot;, adv = &quot; in twain&quot;; break;</a>
<a name="ln914">    case 1: verb = &quot;pulverise&quot;, adv = &quot; into a thin bloody mist&quot;; break;</a>
<a name="ln915">    case 2: verb = &quot;hew&quot;, adv = &quot; savagely&quot;; break;</a>
<a name="ln916">    case 3: verb = &quot;fatally mangle&quot;, adv = &quot;&quot;; break;</a>
<a name="ln917">    case 4: verb = &quot;dissect&quot;, adv = &quot; like a pig carcass&quot;; break;</a>
<a name="ln918">    case 5: verb = &quot;chop&quot;, adv = &quot; into pieces&quot;; break;</a>
<a name="ln919">    case 6: verb = &quot;butcher&quot;, adv = &quot; messily&quot;; break;</a>
<a name="ln920">    case 7: verb = &quot;slaughter&quot;, adv = &quot; joyfully&quot;; break;</a>
<a name="ln921">    }</a>
<a name="ln922">    if (you.see_cell(attacker-&gt;pos()) || you.see_cell(defender-&gt;pos()))</a>
<a name="ln923">    {</a>
<a name="ln924">        mprf(&quot;%s %s %s%s.&quot;, attacker-&gt;name(DESC_THE).c_str(),</a>
<a name="ln925">             attacker-&gt;conj_verb(verb).c_str(),</a>
<a name="ln926">             (attacker == defender ? defender-&gt;pronoun(PRONOUN_REFLEXIVE)</a>
<a name="ln927">                                   : defender-&gt;name(DESC_THE)).c_str(),</a>
<a name="ln928">             adv);</a>
<a name="ln929">    }</a>
<a name="ln930"> </a>
<a name="ln931">    if (!mondied)</a>
<a name="ln932">        defender-&gt;hurt(attacker, defender-&gt;stat_hp());</a>
<a name="ln933">}</a>
<a name="ln934"> </a>
<a name="ln935">///////////////////////////////////////////////////</a>
<a name="ln936"> </a>
<a name="ln937">static setup_missile_type _DAMNATION_launch(item_def* /*item*/, bolt* beam,</a>
<a name="ln938">                                           string* ammo_name, bool* /*returning*/)</a>
<a name="ln939">{</a>
<a name="ln940">    ASSERT(beam-&gt;item</a>
<a name="ln941">           &amp;&amp; beam-&gt;item-&gt;base_type == OBJ_MISSILES</a>
<a name="ln942">           &amp;&amp; !is_artefact(*(beam-&gt;item)));</a>
<a name="ln943">    beam-&gt;item-&gt;special = SPMSL_EXPLODING; // so that it mulches</a>
<a name="ln944">    beam-&gt;item-&gt;props[DAMNATION_BOLT_KEY].get_bool() = true;</a>
<a name="ln945"> </a>
<a name="ln946">    beam-&gt;name    = &quot;damnation bolt&quot;;</a>
<a name="ln947">    *ammo_name    = &quot;a damnation bolt&quot;;</a>
<a name="ln948">    beam-&gt;colour  = LIGHTRED;</a>
<a name="ln949">    beam-&gt;glyph   = DCHAR_FIRED_ZAP;</a>
<a name="ln950"> </a>
<a name="ln951">    bolt *expl   = new bolt(*beam);</a>
<a name="ln952">    expl-&gt;flavour = BEAM_DAMNATION;</a>
<a name="ln953">    expl-&gt;is_explosion = true;</a>
<a name="ln954">    expl-&gt;damage = dice_def(3, 14);</a>
<a name="ln955">    expl-&gt;name   = &quot;damnation&quot;;</a>
<a name="ln956"> </a>
<a name="ln957">    beam-&gt;special_explosion = expl;</a>
<a name="ln958">    return SM_FINISHED;</a>
<a name="ln959">}</a>
<a name="ln960"> </a>
<a name="ln961">///////////////////////////////////////////////////</a>
<a name="ln962"> </a>
<a name="ln963">/**</a>
<a name="ln964"> * Calculate the bonus damage that the Elemental Staff does with an attack of</a>
<a name="ln965"> * the given flavour.</a>
<a name="ln966"> *</a>
<a name="ln967"> * @param flavour   The elemental flavour of attack; may be BEAM_NONE for earth</a>
<a name="ln968"> *                  (physical) attacks.</a>
<a name="ln969"> * @param defender  The victim of the attack. (Not const because checking res</a>
<a name="ln970"> *                  may end up IDing items on monsters... )</a>
<a name="ln971"> * @return          The amount of damage that the defender will receive.</a>
<a name="ln972"> */</a>
<a name="ln973">static int _calc_elemental_staff_damage(beam_type flavour,</a>
<a name="ln974">                                        actor* defender)</a>
<a name="ln975">{</a>
<a name="ln976">    const int base_bonus_dam = 10 + random2(15);</a>
<a name="ln977"> </a>
<a name="ln978">    if (flavour == BEAM_NONE) // earth</a>
<a name="ln979">        return defender-&gt;apply_ac(base_bonus_dam);</a>
<a name="ln980"> </a>
<a name="ln981">    return resist_adjust_damage(defender, flavour, base_bonus_dam);</a>
<a name="ln982">}</a>
<a name="ln983"> </a>
<a name="ln984">static void _ELEMENTAL_STAFF_melee_effects(item_def*, actor* attacker,</a>
<a name="ln985">                                           actor* defender, bool mondied,</a>
<a name="ln986">                                           int)</a>
<a name="ln987">{</a>
<a name="ln988">    const int evoc = attacker-&gt;skill(SK_EVOCATIONS, 27);</a>
<a name="ln989">    if (mondied || !(x_chance_in_y(evoc, 27*27) || x_chance_in_y(evoc, 27*27)))</a>
<a name="ln990">        return;</a>
<a name="ln991"> </a>
<a name="ln992">    const char *verb = nullptr;</a>
<a name="ln993">    beam_type flavour = BEAM_NONE;</a>
<a name="ln994"> </a>
<a name="ln995">    switch (random2(4))</a>
<a name="ln996">    {</a>
<a name="ln997">    case 0:</a>
<a name="ln998">        verb = &quot;burn&quot;;</a>
<a name="ln999">        flavour = BEAM_FIRE;</a>
<a name="ln1000">        break;</a>
<a name="ln1001">    case 1:</a>
<a name="ln1002">        verb = &quot;freeze&quot;;</a>
<a name="ln1003">        flavour = BEAM_COLD;</a>
<a name="ln1004">        break;</a>
<a name="ln1005">    case 2:</a>
<a name="ln1006">        verb = &quot;electrocute&quot;;</a>
<a name="ln1007">        flavour = BEAM_ELECTRICITY;</a>
<a name="ln1008">        break;</a>
<a name="ln1009">    default:</a>
<a name="ln1010">        dprf(&quot;Bad damage type for elemental staff; defaulting to earth&quot;);</a>
<a name="ln1011">        // fallthrough to earth</a>
<a name="ln1012">    case 3:</a>
<a name="ln1013">        verb = &quot;crush&quot;;</a>
<a name="ln1014">        break;</a>
<a name="ln1015">    }</a>
<a name="ln1016"> </a>
<a name="ln1017">    const int bonus_dam = _calc_elemental_staff_damage(flavour, defender);</a>
<a name="ln1018"> </a>
<a name="ln1019">    if (bonus_dam &lt;= 0)</a>
<a name="ln1020">        return;</a>
<a name="ln1021"> </a>
<a name="ln1022">    mprf(&quot;%s %s %s%s&quot;,</a>
<a name="ln1023">         attacker-&gt;name(DESC_THE).c_str(),</a>
<a name="ln1024">         attacker-&gt;conj_verb(verb).c_str(),</a>
<a name="ln1025">         (attacker == defender ? defender-&gt;pronoun(PRONOUN_REFLEXIVE)</a>
<a name="ln1026">                               : defender-&gt;name(DESC_THE)).c_str(),</a>
<a name="ln1027">         attack_strength_punctuation(bonus_dam).c_str());</a>
<a name="ln1028"> </a>
<a name="ln1029">    defender-&gt;hurt(attacker, bonus_dam, flavour);</a>
<a name="ln1030"> </a>
<a name="ln1031">    if (defender-&gt;alive() &amp;&amp; flavour != BEAM_NONE)</a>
<a name="ln1032">        defender-&gt;expose_to_element(flavour, 2);</a>
<a name="ln1033">}</a>
<a name="ln1034"> </a>
<a name="ln1035">///////////////////////////////////////////////////</a>
<a name="ln1036"> </a>
<a name="ln1037">static void _ARC_BLADE_equip(item_def */*item*/, bool *show_msgs, bool /*unmeld*/)</a>
<a name="ln1038">{</a>
<a name="ln1039">    _equip_mpr(show_msgs, &quot;The arc blade crackles to life.&quot;);</a>
<a name="ln1040">}</a>
<a name="ln1041"> </a>
<a name="ln1042">static void _ARC_BLADE_unequip(item_def */*item*/, bool *show_msgs)</a>
<a name="ln1043">{</a>
<a name="ln1044">    _equip_mpr(show_msgs, &quot;The arc blade stops crackling.&quot;);</a>
<a name="ln1045">}</a>
<a name="ln1046"> </a>
<a name="ln1047">static void _ARC_BLADE_melee_effects(item_def* /*weapon*/, actor* attacker,</a>
<a name="ln1048">                                     actor* /*defender*/, bool /*mondied*/,</a>
<a name="ln1049">                                     int /*dam*/)</a>
<a name="ln1050">{</a>
<a name="ln1051">    if (one_chance_in(3))</a>
<a name="ln1052">    {</a>
<a name="ln1053">        const int pow = 100 + random2avg(100, 2);</a>
<a name="ln1054"> </a>
<a name="ln1055">        if (you.can_see(*attacker))</a>
<a name="ln1056">            mpr(&quot;The arc blade crackles.&quot;);</a>
<a name="ln1057">        else</a>
<a name="ln1058">            mpr(&quot;You hear the crackle of electricity.&quot;);</a>
<a name="ln1059"> </a>
<a name="ln1060">        cast_discharge(pow, *attacker, false, false);</a>
<a name="ln1061">    }</a>
<a name="ln1062">}</a>
<a name="ln1063"> </a>
<a name="ln1064">///////////////////////////////////////////////////</a>
<a name="ln1065"> </a>
<a name="ln1066">static void _SPELLBINDER_melee_effects(item_def* /*weapon*/, actor* attacker,</a>
<a name="ln1067">                                       actor* defender, bool mondied,</a>
<a name="ln1068">                                       int dam)</a>
<a name="ln1069">{</a>
<a name="ln1070">    // Only cause miscasts if the target has magic to disrupt.</a>
<a name="ln1071">    if (defender-&gt;antimagic_susceptible()</a>
<a name="ln1072">        &amp;&amp; !mondied)</a>
<a name="ln1073">    {</a>
<a name="ln1074">        miscast_effect(*defender, attacker, {miscast_source::melee},</a>
<a name="ln1075">                       spschool::random, random_range(1, 9), dam,</a>
<a name="ln1076">                       &quot;the demon whip \&quot;Spellbinder\&quot;&quot;);</a>
<a name="ln1077">    }</a>
<a name="ln1078">}</a>
<a name="ln1079"> </a>
<a name="ln1080">///////////////////////////////////////////////////</a>
<a name="ln1081"> </a>
<a name="ln1082">static void _ORDER_melee_effects(item_def* /*item*/, actor* attacker,</a>
<a name="ln1083">                                         actor* defender, bool mondied, int dam)</a>
<a name="ln1084">{</a>
<a name="ln1085">    if (!mondied)</a>
<a name="ln1086">    {</a>
<a name="ln1087">        string msg = &quot;&quot;;</a>
<a name="ln1088">        int silver_dam = silver_damages_victim(defender, dam, msg);</a>
<a name="ln1089">        if (silver_dam)</a>
<a name="ln1090">        {</a>
<a name="ln1091">            if (you.can_see(*defender))</a>
<a name="ln1092">                mpr(msg);</a>
<a name="ln1093">            defender-&gt;hurt(attacker, silver_dam);</a>
<a name="ln1094">        }</a>
<a name="ln1095">        else if (dam &gt; 0)</a>
<a name="ln1096">            defender-&gt;hurt(attacker, 1 + random2(dam) / 3);</a>
<a name="ln1097">    }</a>
<a name="ln1098">}</a>
<a name="ln1099"> </a>
<a name="ln1100">///////////////////////////////////////////////////</a>
<a name="ln1101"> </a>
<a name="ln1102">static void _FIRESTARTER_equip(item_def */*item*/, bool *show_msgs,</a>
<a name="ln1103">                               bool /*unmeld*/)</a>
<a name="ln1104">{</a>
<a name="ln1105">    _equip_mpr(show_msgs, &quot;You are filled with an inner flame.&quot;);</a>
<a name="ln1106">}</a>
<a name="ln1107"> </a>
<a name="ln1108">static void _FIRESTARTER_unequip(item_def */*item*/, bool *show_msgs)</a>
<a name="ln1109">{</a>
<a name="ln1110">    _equip_mpr(show_msgs, &quot;Your inner flame fades away.&quot;);</a>
<a name="ln1111">}</a>
<a name="ln1112"> </a>
<a name="ln1113">static void _FIRESTARTER_melee_effects(item_def* /*weapon*/, actor* attacker,</a>
<a name="ln1114">                                   actor* defender, bool mondied, int dam)</a>
<a name="ln1115">{</a>
<a name="ln1116">    if (dam)</a>
<a name="ln1117">    {</a>
<a name="ln1118">        if (defender-&gt;is_monster()</a>
<a name="ln1119">            &amp;&amp; !mondied</a>
<a name="ln1120">            &amp;&amp; !defender-&gt;as_monster()-&gt;has_ench(ENCH_INNER_FLAME))</a>
<a name="ln1121">        {</a>
<a name="ln1122">            mprf(&quot;%s is filled with an inner flame.&quot;,</a>
<a name="ln1123">                 defender-&gt;name(DESC_THE).c_str());</a>
<a name="ln1124">            defender-&gt;as_monster()-&gt;add_ench(</a>
<a name="ln1125">                mon_enchant(ENCH_INNER_FLAME, 0, attacker,</a>
<a name="ln1126">                            (3 + random2(dam)) * BASELINE_DELAY));</a>
<a name="ln1127">        }</a>
<a name="ln1128">    }</a>
<a name="ln1129">}</a>
<a name="ln1130"> </a>
<a name="ln1131">///////////////////////////////////////////////////</a>
<a name="ln1132"> </a>
<a name="ln1133">#if TAG_MAJOR_VERSION == 34</a>
<a name="ln1134">static void _CHILLY_DEATH_equip(item_def */*item*/, bool *show_msgs,</a>
<a name="ln1135">                                bool /*unmeld*/)</a>
<a name="ln1136">{</a>
<a name="ln1137">    _equip_mpr(show_msgs, &quot;The dagger glows with an icy blue light!&quot;);</a>
<a name="ln1138">}</a>
<a name="ln1139"> </a>
<a name="ln1140">static void _CHILLY_DEATH_unequip(item_def */*item*/, bool *show_msgs)</a>
<a name="ln1141">{</a>
<a name="ln1142">    _equip_mpr(show_msgs, &quot;The dagger stops glowing.&quot;);</a>
<a name="ln1143">}</a>
<a name="ln1144"> </a>
<a name="ln1145">static void _CHILLY_DEATH_melee_effects(item_def* /*weapon*/, actor* attacker,</a>
<a name="ln1146">                                   actor* defender, bool mondied, int dam)</a>
<a name="ln1147">{</a>
<a name="ln1148">    if (dam)</a>
<a name="ln1149">    {</a>
<a name="ln1150">        if (defender-&gt;is_monster()</a>
<a name="ln1151">            &amp;&amp; !mondied</a>
<a name="ln1152">            &amp;&amp; !defender-&gt;as_monster()-&gt;has_ench(ENCH_FROZEN))</a>
<a name="ln1153">        {</a>
<a name="ln1154">            mprf(&quot;%s is flash-frozen.&quot;,</a>
<a name="ln1155">                 defender-&gt;name(DESC_THE).c_str());</a>
<a name="ln1156">            defender-&gt;as_monster()-&gt;add_ench(</a>
<a name="ln1157">                mon_enchant(ENCH_FROZEN, 0, attacker,</a>
<a name="ln1158">                            (5 + random2(dam)) * BASELINE_DELAY));</a>
<a name="ln1159">        }</a>
<a name="ln1160">        else if (defender-&gt;is_player()</a>
<a name="ln1161">            &amp;&amp; !you.duration[DUR_FROZEN])</a>
<a name="ln1162">        {</a>
<a name="ln1163">            mprf(MSGCH_WARN, &quot;You are encased in ice.&quot;);</a>
<a name="ln1164">            you.increase_duration(DUR_FROZEN, 5 + random2(dam));</a>
<a name="ln1165">        }</a>
<a name="ln1166">    }</a>
<a name="ln1167">}</a>
<a name="ln1168">#endif</a>
<a name="ln1169"> </a>
<a name="ln1170">///////////////////////////////////////////////////</a>
<a name="ln1171"> </a>
<a name="ln1172">#if TAG_MAJOR_VERSION == 34</a>
<a name="ln1173">static void _FLAMING_DEATH_equip(item_def */*item*/, bool *show_msgs,</a>
<a name="ln1174">                                 bool /*unmeld*/)</a>
<a name="ln1175">{</a>
<a name="ln1176">    _equip_mpr(show_msgs, &quot;The scimitar bursts into red hot flame!&quot;);</a>
<a name="ln1177">}</a>
<a name="ln1178"> </a>
<a name="ln1179">static void _FLAMING_DEATH_unequip(item_def */*item*/, bool *show_msgs)</a>
<a name="ln1180">{</a>
<a name="ln1181">    _equip_mpr(show_msgs, &quot;The scimitar stops flaming.&quot;);</a>
<a name="ln1182">}</a>
<a name="ln1183"> </a>
<a name="ln1184">static void _FLAMING_DEATH_melee_effects(item_def* /*weapon*/, actor* attacker,</a>
<a name="ln1185">                                   actor* defender, bool mondied, int dam)</a>
<a name="ln1186">{</a>
<a name="ln1187">    if (!mondied &amp;&amp; (dam &gt; 2 &amp;&amp; one_chance_in(3)))</a>
<a name="ln1188">    {</a>
<a name="ln1189">        if (defender-&gt;is_player())</a>
<a name="ln1190">            napalm_player(random2avg(7, 3) + 1, attacker-&gt;name(DESC_A, true));</a>
<a name="ln1191">        else</a>
<a name="ln1192">        {</a>
<a name="ln1193">            napalm_monster(</a>
<a name="ln1194">                defender-&gt;as_monster(),</a>
<a name="ln1195">                attacker,</a>
<a name="ln1196">                min(4, 1 + random2(attacker-&gt;get_hit_dice())/2));</a>
<a name="ln1197">        }</a>
<a name="ln1198">    }</a>
<a name="ln1199">}</a>
<a name="ln1200">#endif</a>
<a name="ln1201"> </a>
<a name="ln1202">///////////////////////////////////////////////////</a>
<a name="ln1203"> </a>
<a name="ln1204">static void _MAJIN_equip(item_def *item, bool *show_msgs, bool /*unmeld*/)</a>
<a name="ln1205">{</a>
<a name="ln1206">    if (!you.max_magic_points)</a>
<a name="ln1207">        return;</a>
<a name="ln1208"> </a>
<a name="ln1209">    const bool should_msg = !show_msgs || *show_msgs;</a>
<a name="ln1210">    _equip_mpr(show_msgs, &quot;You feel a darkness envelop your magic.&quot;);</a>
<a name="ln1211"> </a>
<a name="ln1212">    if (!item-&gt;props.exists(MB_WELCOME_KEY) &amp;&amp; should_msg)</a>
<a name="ln1213">    {</a>
<a name="ln1214">        const string msg = &quot;A voice whispers, \&quot;&quot; +</a>
<a name="ln1215">                           getSpeakString(&quot;majin-bo greeting&quot;) + &quot;\&quot;&quot;;</a>
<a name="ln1216">        mprf(MSGCH_TALK, &quot;%s&quot;, msg.c_str());</a>
<a name="ln1217">        item-&gt;props[MB_WELCOME_KEY].get_bool() = true;</a>
<a name="ln1218">    }</a>
<a name="ln1219">}</a>
<a name="ln1220"> </a>
<a name="ln1221">static void _MAJIN_unequip(item_def */*item*/, bool *show_msgs)</a>
<a name="ln1222">{</a>
<a name="ln1223">    if (you.max_magic_points)</a>
<a name="ln1224">    {</a>
<a name="ln1225">        _equip_mpr(show_msgs,</a>
<a name="ln1226">                   &quot;The darkness slowly releases its grasp on your magic.&quot;);</a>
<a name="ln1227">    }</a>
<a name="ln1228">}</a>
<a name="ln1229"> </a>
<a name="ln1230">///////////////////////////////////////////////////</a>
<a name="ln1231"> </a>
<a name="ln1232">static int _octorings_worn()</a>
<a name="ln1233">{</a>
<a name="ln1234">    int worn = 0;</a>
<a name="ln1235"> </a>
<a name="ln1236">    for (int i = EQ_LEFT_RING; i &lt; NUM_EQUIP; ++i)</a>
<a name="ln1237">    {</a>
<a name="ln1238">        if (you.melded[i] || you.equip[i] == -1)</a>
<a name="ln1239">            continue;</a>
<a name="ln1240"> </a>
<a name="ln1241">        item_def&amp; ring = you.inv[you.equip[i]];</a>
<a name="ln1242">        if (is_unrandom_artefact(ring, UNRAND_OCTOPUS_KING_RING))</a>
<a name="ln1243">            worn++;</a>
<a name="ln1244">    }</a>
<a name="ln1245"> </a>
<a name="ln1246">    return worn;</a>
<a name="ln1247">}</a>
<a name="ln1248"> </a>
<a name="ln1249">static void _OCTOPUS_KING_equip(item_def *item, bool *show_msgs,</a>
<a name="ln1250">                                bool /*unmeld*/)</a>
<a name="ln1251">{</a>
<a name="ln1252">    int rings = _octorings_worn();</a>
<a name="ln1253"> </a>
<a name="ln1254">    if (rings == 8)</a>
<a name="ln1255">        _equip_mpr(show_msgs, &quot;You feel like a king!&quot;);</a>
<a name="ln1256">    else if (rings)</a>
<a name="ln1257">        _equip_mpr(show_msgs, &quot;You feel regal.&quot;);</a>
<a name="ln1258">    item-&gt;plus = 8 + 2 * rings;</a>
<a name="ln1259">}</a>
<a name="ln1260"> </a>
<a name="ln1261">static void _OCTOPUS_KING_world_reacts(item_def *item)</a>
<a name="ln1262">{</a>
<a name="ln1263">    item-&gt;plus = 8 + 2 * _octorings_worn();</a>
<a name="ln1264">}</a>
<a name="ln1265"> </a>
<a name="ln1266">///////////////////////////////////////////////////</a>
<a name="ln1267"> </a>
<a name="ln1268">static void _CAPTAIN_melee_effects(item_def* /*weapon*/, actor* attacker,</a>
<a name="ln1269">                                actor* defender, bool mondied, int dam)</a>
<a name="ln1270">{</a>
<a name="ln1271">    // Player disarming sounds like a bad idea; monster-on-monster might</a>
<a name="ln1272">    // work but would be complicated.</a>
<a name="ln1273">    if (coinflip()</a>
<a name="ln1274">        &amp;&amp; dam &gt;= (3 + random2(defender-&gt;get_hit_dice()))</a>
<a name="ln1275">        &amp;&amp; !x_chance_in_y(defender-&gt;get_hit_dice(), random2(20) + dam*4)</a>
<a name="ln1276">        &amp;&amp; attacker-&gt;is_player()</a>
<a name="ln1277">        &amp;&amp; defender-&gt;is_monster()</a>
<a name="ln1278">        &amp;&amp; !mondied)</a>
<a name="ln1279">    {</a>
<a name="ln1280">        item_def *wpn = defender-&gt;as_monster()-&gt;disarm();</a>
<a name="ln1281">        if (wpn)</a>
<a name="ln1282">        {</a>
<a name="ln1283">            mprf(&quot;The captain's cutlass flashes! You lacerate %s!!&quot;,</a>
<a name="ln1284">                defender-&gt;name(DESC_THE).c_str());</a>
<a name="ln1285">            mprf(&quot;%s %s falls to the floor!&quot;,</a>
<a name="ln1286">                apostrophise(defender-&gt;name(DESC_THE)).c_str(),</a>
<a name="ln1287">                wpn-&gt;name(DESC_PLAIN).c_str());</a>
<a name="ln1288">            defender-&gt;hurt(attacker, 18 + random2(18));</a>
<a name="ln1289">        }</a>
<a name="ln1290">    }</a>
<a name="ln1291">}</a>
<a name="ln1292"> </a>
<a name="ln1293">///////////////////////////////////////////////////</a>
<a name="ln1294"> </a>
<a name="ln1295">static void _FENCERS_equip(item_def */*item*/, bool *show_msgs, bool /*unmeld*/)</a>
<a name="ln1296">{</a>
<a name="ln1297">    _equip_mpr(show_msgs, &quot;En garde!&quot;);</a>
<a name="ln1298">}</a>
<a name="ln1299"> </a>
<a name="ln1300">#if TAG_MAJOR_VERSION == 34</a>
<a name="ln1301">///////////////////////////////////////////////////</a>
<a name="ln1302"> </a>
<a name="ln1303">static void _ETHERIC_CAGE_equip(item_def */*item*/, bool *show_msgs,</a>
<a name="ln1304">                                bool /*unmeld*/)</a>
<a name="ln1305">{</a>
<a name="ln1306">    _equip_mpr(show_msgs, &quot;You sense a greater flux of ambient magical fields.&quot;);</a>
<a name="ln1307">}</a>
<a name="ln1308"> </a>
<a name="ln1309">static void _ETHERIC_CAGE_world_reacts(item_def */*item*/)</a>
<a name="ln1310">{</a>
<a name="ln1311">    const int delay = you.time_taken;</a>
<a name="ln1312">    ASSERT(delay &gt; 0);</a>
<a name="ln1313"> </a>
<a name="ln1314">    // coinflip() chance of 1 MP per turn. Be sure to change</a>
<a name="ln1315">    // _get_overview_resistances to match!</a>
<a name="ln1316">    if (player_regenerates_mp())</a>
<a name="ln1317">        inc_mp(binomial(div_rand_round(delay, BASELINE_DELAY), 1, 2));</a>
<a name="ln1318">}</a>
<a name="ln1319"> </a>
<a name="ln1320">///////////////////////////////////////////////////</a>
<a name="ln1321"> </a>
<a name="ln1322">static void _ETERNAL_TORMENT_equip(item_def */*item*/, bool */*show_msgs*/,</a>
<a name="ln1323">                                   bool /*unmeld*/)</a>
<a name="ln1324">{</a>
<a name="ln1325">    calc_hp();</a>
<a name="ln1326">}</a>
<a name="ln1327"> </a>
<a name="ln1328">static void _ETERNAL_TORMENT_world_reacts(item_def */*item*/)</a>
<a name="ln1329">{</a>
<a name="ln1330">    if (one_chance_in(10))</a>
<a name="ln1331">        did_god_conduct(DID_EVIL, 1);</a>
<a name="ln1332">}</a>
<a name="ln1333"> </a>
<a name="ln1334"> </a>
<a name="ln1335">static void _ETERNAL_TORMENT_unequip(item_def */*item*/, bool */*show_msgs*/)</a>
<a name="ln1336">{</a>
<a name="ln1337">    calc_hp();</a>
<a name="ln1338">}</a>
<a name="ln1339">#endif</a>
<a name="ln1340"> </a>
<a name="ln1341">///////////////////////////////////////////////////</a>
<a name="ln1342"> </a>
<a name="ln1343">static void _VINES_equip(item_def */*item*/, bool *show_msgs, bool /*unmeld*/)</a>
<a name="ln1344">{</a>
<a name="ln1345">    _equip_mpr(show_msgs, &quot;The vines latch onto your body!&quot;);</a>
<a name="ln1346">}</a>
<a name="ln1347"> </a>
<a name="ln1348">static void _VINES_unequip(item_def */*item*/, bool *show_msgs)</a>
<a name="ln1349">{</a>
<a name="ln1350">    _equip_mpr(show_msgs, &quot;The vines fall away from your body!&quot;);</a>
<a name="ln1351">}</a>
<a name="ln1352"> </a>
<a name="ln1353">///////////////////////////////////////////////////</a>
<a name="ln1354"> </a>
<a name="ln1355">static void _KRYIAS_equip(item_def */*item*/, bool *show_msgs, bool /*unmeld*/)</a>
<a name="ln1356">{</a>
<a name="ln1357">    _equip_mpr(show_msgs, &quot;Your attunement to healing potions increases.&quot;);</a>
<a name="ln1358">}</a>
<a name="ln1359"> </a>
<a name="ln1360">static void _KRYIAS_unequip(item_def */*item*/, bool *show_msgs)</a>
<a name="ln1361">{</a>
<a name="ln1362">    _equip_mpr(show_msgs, &quot;Your attunement to healing potions decreases.&quot;);</a>
<a name="ln1363">}</a>
<a name="ln1364"> </a>
<a name="ln1365">///////////////////////////////////////////////////</a>
<a name="ln1366"> </a>
<a name="ln1367">static void _FROSTBITE_melee_effects(item_def* /*weapon*/, actor* attacker,</a>
<a name="ln1368">                                     actor* defender, bool /*mondied*/,</a>
<a name="ln1369">                                     int /*dam*/)</a>
<a name="ln1370">{</a>
<a name="ln1371">    coord_def spot = defender-&gt;pos();</a>
<a name="ln1372">    if (!cell_is_solid(spot)</a>
<a name="ln1373">        &amp;&amp; !cloud_at(spot)</a>
<a name="ln1374">        &amp;&amp; one_chance_in(5))</a>
<a name="ln1375">    {</a>
<a name="ln1376">         place_cloud(CLOUD_COLD, spot, random_range(4, 8), attacker, 0);</a>
<a name="ln1377">    }</a>
<a name="ln1378">}</a>
<a name="ln1379"> </a>
<a name="ln1380">///////////////////////////////////////////////////</a>
<a name="ln1381"> </a>
<a name="ln1382">// Vampiric effect triggers on every hit, see attack::apply_damage_brand()</a>
<a name="ln1383"> </a>
<a name="ln1384">static void _LEECH_equip(item_def */*item*/, bool *show_msgs, bool /*unmeld*/)</a>
<a name="ln1385">{</a>
<a name="ln1386">    if (you.undead_state() == US_ALIVE</a>
<a name="ln1387">        &amp;&amp; (you.species == SP_VAMPIRE || !you_foodless()))</a>
<a name="ln1388">    {</a>
<a name="ln1389">        _equip_mpr(show_msgs, &quot;You feel a powerful hunger.&quot;);</a>
<a name="ln1390">    }</a>
<a name="ln1391">    else if (you.species != SP_VAMPIRE)</a>
<a name="ln1392">        _equip_mpr(show_msgs, &quot;You feel very empty.&quot;);</a>
<a name="ln1393">    // else let player-equip.cc handle message</a>
<a name="ln1394">}</a>
<a name="ln1395"> </a>
<a name="ln1396"> </a>
<a name="ln1397">///////////////////////////////////////////////////</a>
<a name="ln1398"> </a>
<a name="ln1399">static void _THERMIC_ENGINE_equip(item_def *item, bool *show_msgs,</a>
<a name="ln1400">                                  bool /*unmeld*/)</a>
<a name="ln1401">{</a>
<a name="ln1402">    _equip_mpr(show_msgs, &quot;The engine hums to life!&quot;);</a>
<a name="ln1403">    item-&gt;plus = 2;</a>
<a name="ln1404">}</a>
<a name="ln1405"> </a>
<a name="ln1406">static void _THERMIC_ENGINE_unequip(item_def *item, bool *show_msgs)</a>
<a name="ln1407">{</a>
<a name="ln1408">    _equip_mpr(show_msgs, &quot;The engine shudders to a halt.&quot;);</a>
<a name="ln1409">    item-&gt;plus = 2;</a>
<a name="ln1410">}</a>
<a name="ln1411"> </a>
<a name="ln1412">static void _THERMIC_ENGINE_melee_effects(item_def* weapon, actor* attacker,</a>
<a name="ln1413">                                   actor* defender, bool mondied, int dam)</a>
<a name="ln1414">{</a>
<a name="ln1415">    if (weapon-&gt;plus &lt; 14)</a>
<a name="ln1416">    {</a>
<a name="ln1417">        weapon-&gt;plus += 2;</a>
<a name="ln1418"> </a>
<a name="ln1419">        if (weapon-&gt;plus &gt; 14)</a>
<a name="ln1420">            weapon-&gt;plus = 14;</a>
<a name="ln1421"> </a>
<a name="ln1422">        you.wield_change = true;</a>
<a name="ln1423">    }</a>
<a name="ln1424"> </a>
<a name="ln1425">    if (mondied)</a>
<a name="ln1426">        return;</a>
<a name="ln1427"> </a>
<a name="ln1428">    // the flaming brand has already been applied at this point</a>
<a name="ln1429">    const int bonus_dam = resist_adjust_damage(defender, BEAM_COLD,</a>
<a name="ln1430">                                               random2(dam) / 2 + 1);</a>
<a name="ln1431">    if (bonus_dam &gt; 0)</a>
<a name="ln1432">    {</a>
<a name="ln1433">        mprf(&quot;%s %s %s.&quot;,</a>
<a name="ln1434">            attacker-&gt;name(DESC_THE).c_str(),</a>
<a name="ln1435">            attacker-&gt;conj_verb(&quot;freeze&quot;).c_str(),</a>
<a name="ln1436">            (attacker == defender ? defender-&gt;pronoun(PRONOUN_REFLEXIVE)</a>
<a name="ln1437">                                : defender-&gt;name(DESC_THE)).c_str());</a>
<a name="ln1438"> </a>
<a name="ln1439">        defender-&gt;hurt(attacker, bonus_dam, BEAM_COLD);</a>
<a name="ln1440">        if (defender-&gt;alive())</a>
<a name="ln1441">            defender-&gt;expose_to_element(BEAM_COLD, 2);</a>
<a name="ln1442">    }</a>
<a name="ln1443">}</a>
<a name="ln1444"> </a>
<a name="ln1445">static void _THERMIC_ENGINE_world_reacts(item_def *item)</a>
<a name="ln1446">{</a>
<a name="ln1447">    if (item-&gt;plus &gt; 2)</a>
<a name="ln1448">    {</a>
<a name="ln1449">        item-&gt;plus -= div_rand_round(you.time_taken, BASELINE_DELAY);</a>
<a name="ln1450"> </a>
<a name="ln1451">        if (item-&gt;plus &lt; 2)</a>
<a name="ln1452">            item-&gt;plus = 2;</a>
<a name="ln1453"> </a>
<a name="ln1454">        you.wield_change = true;</a>
<a name="ln1455">    }</a>
<a name="ln1456">}</a>
<a name="ln1457"> </a>
<a name="ln1458">///////////////////////////////////////////////////</a>
<a name="ln1459"> </a>
<a name="ln1460">static void _ZHOR_world_reacts(item_def */*item*/)</a>
<a name="ln1461">{</a>
<a name="ln1462">    if (there_are_monsters_nearby(true, false, false)</a>
<a name="ln1463">        &amp;&amp; one_chance_in(7 * div_rand_round(BASELINE_DELAY, you.time_taken)))</a>
<a name="ln1464">    {</a>
<a name="ln1465">        cast_englaciation(30, false);</a>
<a name="ln1466">    }</a>
<a name="ln1467">}</a>
<a name="ln1468"> </a>
<a name="ln1469">////////////////////////////////////////////////////</a>
<a name="ln1470"> </a>
<a name="ln1471">// XXX: Staff of Battle giving a boost to conjuration spells is hardcoded in</a>
<a name="ln1472">// player_spec_conj().</a>
<a name="ln1473"> </a>
<a name="ln1474">static void _BATTLE_unequip(item_def */*item*/, bool */*show_msgs*/)</a>
<a name="ln1475">{</a>
<a name="ln1476">    end_battlesphere(find_battlesphere(&amp;you), false);</a>
<a name="ln1477">}</a>
<a name="ln1478"> </a>
<a name="ln1479">static void _BATTLE_world_reacts(item_def */*item*/)</a>
<a name="ln1480">{</a>
<a name="ln1481">    if (!find_battlesphere(&amp;you) &amp;&amp; there_are_monsters_nearby(true, true, false))</a>
<a name="ln1482">    {</a>
<a name="ln1483">        your_spells(SPELL_BATTLESPHERE, 0, false);</a>
<a name="ln1484">        did_god_conduct(DID_WIZARDLY_ITEM, 10);</a>
<a name="ln1485">    }</a>
<a name="ln1486">}</a>
<a name="ln1487"> </a>
<a name="ln1488">////////////////////////////////////////////////////</a>
<a name="ln1489"> </a>
<a name="ln1490">static void _EMBRACE_unequip(item_def *item, bool *show_msgs)</a>
<a name="ln1491">{</a>
<a name="ln1492">    int &amp;armour = item-&gt;props[EMBRACE_ARMOUR_KEY].get_int();</a>
<a name="ln1493">    if (armour &gt; 0)</a>
<a name="ln1494">    {</a>
<a name="ln1495">        _equip_mpr(show_msgs, &quot;Your corpse armour falls away.&quot;);</a>
<a name="ln1496">        armour = 0;</a>
<a name="ln1497">        item-&gt;plus = get_unrand_entry(item-&gt;unrand_idx)-&gt;plus;</a>
<a name="ln1498">    }</a>
<a name="ln1499">}</a>
<a name="ln1500"> </a>
<a name="ln1501">/**</a>
<a name="ln1502"> * Iterate over all corpses in LOS and harvest them.</a>
<a name="ln1503"> *</a>
<a name="ln1504"> * @return            The total number of corpses destroyed.</a>
<a name="ln1505"> */</a>
<a name="ln1506">static int _harvest_corpses()</a>
<a name="ln1507">{</a>
<a name="ln1508">    int harvested = 0;</a>
<a name="ln1509"> </a>
<a name="ln1510">    for (radius_iterator ri(you.pos(), LOS_NO_TRANS); ri; ++ri)</a>
<a name="ln1511">    {</a>
<a name="ln1512">        for (stack_iterator si(*ri, true); si; ++si)</a>
<a name="ln1513">        {</a>
<a name="ln1514">            item_def &amp;item = *si;</a>
<a name="ln1515">            if (item.base_type != OBJ_CORPSES)</a>
<a name="ln1516">                continue;</a>
<a name="ln1517"> </a>
<a name="ln1518">            // forbid harvesting orcs under Beogh</a>
<a name="ln1519">            const monster_type monnum</a>
<a name="ln1520">                = static_cast&lt;monster_type&gt;(item.orig_monnum);</a>
<a name="ln1521">            if (you.religion == GOD_BEOGH &amp;&amp; mons_genus(monnum) == MONS_ORC)</a>
<a name="ln1522">                continue;</a>
<a name="ln1523"> </a>
<a name="ln1524">            did_god_conduct(DID_EVIL, 1);</a>
<a name="ln1525"> </a>
<a name="ln1526">             // apply these in addition to use of an evil item</a>
<a name="ln1527">             if (mons_class_holiness(item.mon_type) &amp; MH_HOLY)</a>
<a name="ln1528">                 did_god_conduct(DID_DESECRATE_HOLY_REMAINS, 4);</a>
<a name="ln1529">             else if (corpse_intelligence(item) &gt;= I_HUMAN)</a>
<a name="ln1530">                 did_god_conduct(DID_DESECRATE_SOULED_BEING, 1);</a>
<a name="ln1531"> </a>
<a name="ln1532">            ++harvested;</a>
<a name="ln1533"> </a>
<a name="ln1534">            // don't spam animations</a>
<a name="ln1535">            if (harvested &lt;= 5)</a>
<a name="ln1536">            {</a>
<a name="ln1537">                bolt beam;</a>
<a name="ln1538">                beam.source = *ri;</a>
<a name="ln1539">                beam.target = you.pos();</a>
<a name="ln1540">                beam.glyph = get_item_glyph(item).ch;</a>
<a name="ln1541">                beam.colour = item.get_colour();</a>
<a name="ln1542">                beam.range = LOS_RADIUS;</a>
<a name="ln1543">                beam.aimed_at_spot = true;</a>
<a name="ln1544">                beam.item = &amp;item;</a>
<a name="ln1545">                beam.flavour = BEAM_VISUAL;</a>
<a name="ln1546">                beam.draw_delay = 3;</a>
<a name="ln1547">                beam.fire();</a>
<a name="ln1548">                viewwindow();</a>
<a name="ln1549">            }</a>
<a name="ln1550"> </a>
<a name="ln1551">            destroy_item(item.index());</a>
<a name="ln1552">        }</a>
<a name="ln1553">    }</a>
<a name="ln1554"> </a>
<a name="ln1555">    return harvested;</a>
<a name="ln1556">}</a>
<a name="ln1557"> </a>
<a name="ln1558">static void _EMBRACE_world_reacts(item_def *item)</a>
<a name="ln1559">{</a>
<a name="ln1560">    int &amp;armour = item-&gt;props[EMBRACE_ARMOUR_KEY].get_int();</a>
<a name="ln1561">    const int harvested = _harvest_corpses();</a>
<a name="ln1562">    // diminishing returns for more corpses</a>
<a name="ln1563">    for (int i = 0; i &lt; harvested; i++)</a>
<a name="ln1564">        armour += div_rand_round(100 * 100, (armour + 100));</a>
<a name="ln1565"> </a>
<a name="ln1566">    // decay over time - 1 turn per 'armour' base, 0.5 turns at 400 'armour'</a>
<a name="ln1567">    armour -= div_rand_round(you.time_taken * (armour + 400), 10 * 400);</a>
<a name="ln1568"> </a>
<a name="ln1569">    const int last_plus = item-&gt;plus;</a>
<a name="ln1570">    const int base_plus = get_unrand_entry(item-&gt;unrand_idx)-&gt;plus;</a>
<a name="ln1571">    if (armour &lt;= 0)</a>
<a name="ln1572">    {</a>
<a name="ln1573">        armour = 0;</a>
<a name="ln1574">        item-&gt;plus = base_plus;</a>
<a name="ln1575">        if (last_plus &gt; base_plus)</a>
<a name="ln1576">            mpr(&quot;Your corpse armour falls away.&quot;);</a>
<a name="ln1577">    }</a>
<a name="ln1578">    else</a>
<a name="ln1579">    {</a>
<a name="ln1580">        item-&gt;plus = base_plus + 1 + (armour-1) * 6 / 100;</a>
<a name="ln1581">        if (item-&gt;plus &lt; last_plus)</a>
<a name="ln1582">            mpr(&quot;A chunk of your corpse armour falls away.&quot;);</a>
<a name="ln1583">        else if (last_plus == base_plus)</a>
<a name="ln1584">            mpr(&quot;The bodies of the dead rush to embrace you!&quot;);</a>
<a name="ln1585">        else if (item-&gt;plus &gt; last_plus)</a>
<a name="ln1586">            mpr(&quot;Your shell of carrion and bone grows thicker.&quot;);</a>
<a name="ln1587">    }</a>
<a name="ln1588"> </a>
<a name="ln1589">    if (item-&gt;plus != last_plus)</a>
<a name="ln1590">        you.redraw_armour_class = true;</a>
<a name="ln1591">}</a>

</code></pre>
<div class="balloon" rel="989"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v501/" target="_blank">V501</a> There are identical sub-expressions 'x_chance_in_y(evoc, 27 * 27)' to the left and to the right of the '||' operator.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
