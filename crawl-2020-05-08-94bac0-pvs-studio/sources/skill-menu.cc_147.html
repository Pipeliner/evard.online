
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=US-ASCII" />
  <title>skill-menu.cc</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">/**</a>
<a name="ln2"> * @file</a>
<a name="ln3"> * @brief Skill menu.</a>
<a name="ln4">**/</a>
<a name="ln5"> </a>
<a name="ln6">#include &lt;cmath&gt;</a>
<a name="ln7"> </a>
<a name="ln8">#include &quot;AppHdr.h&quot;</a>
<a name="ln9"> </a>
<a name="ln10">#include &quot;skill-menu.h&quot;</a>
<a name="ln11"> </a>
<a name="ln12">#include &quot;cio.h&quot;</a>
<a name="ln13">#include &quot;clua.h&quot;</a>
<a name="ln14">#include &quot;command.h&quot;</a>
<a name="ln15">#include &quot;describe.h&quot;</a>
<a name="ln16">#include &quot;english.h&quot; // apostrophise</a>
<a name="ln17">#include &quot;evoke.h&quot;</a>
<a name="ln18">#include &quot;god-passive.h&quot; // passive_t::bondage_skill_boost</a>
<a name="ln19">#include &quot;hints.h&quot;</a>
<a name="ln20">#include &quot;options.h&quot;</a>
<a name="ln21">#include &quot;output.h&quot;</a>
<a name="ln22">#include &quot;religion.h&quot;</a>
<a name="ln23">#include &quot;state.h&quot;</a>
<a name="ln24">#include &quot;stringutil.h&quot;</a>
<a name="ln25">#include &quot;tilefont.h&quot;</a>
<a name="ln26">#ifdef USE_TILE</a>
<a name="ln27"> #include &quot;tilepick.h&quot;</a>
<a name="ln28"> #include &quot;tilereg-crt.h&quot;</a>
<a name="ln29">#endif</a>
<a name="ln30">#include &quot;ui.h&quot;</a>
<a name="ln31">#include &quot;unwind.h&quot;</a>
<a name="ln32"> </a>
<a name="ln33">using namespace ui;</a>
<a name="ln34"> </a>
<a name="ln35">menu_letter2 SkillMenuEntry::m_letter;</a>
<a name="ln36">SkillMenu skm;</a>
<a name="ln37"> </a>
<a name="ln38">#ifdef USE_TILE_LOCAL</a>
<a name="ln39">bool SkillTextTileItem::handle_mouse(const wm_mouse_event&amp; me)</a>
<a name="ln40">{</a>
<a name="ln41">    if (me.event == wm_mouse_event::PRESS</a>
<a name="ln42">        &amp;&amp; (me.button == wm_mouse_event::LEFT &amp;&amp; me.mod &amp; TILES_MOD_SHIFT))</a>
<a name="ln43">    {</a>
<a name="ln44">        skill_type sk = skill_type(get_id());</a>
<a name="ln45">        if (is_invalid_skill(sk))</a>
<a name="ln46">            return false;</a>
<a name="ln47"> </a>
<a name="ln48">        skm.select(sk, 'A');</a>
<a name="ln49">        return true;</a>
<a name="ln50">    }</a>
<a name="ln51">    else</a>
<a name="ln52">        return false;</a>
<a name="ln53">}</a>
<a name="ln54">#endif</a>
<a name="ln55"> </a>
<a name="ln56">#define NAME_SIZE 20</a>
<a name="ln57">#define LEVEL_SIZE 5</a>
<a name="ln58">#define PROGRESS_SIZE 6</a>
<a name="ln59">#define APTITUDE_SIZE 5</a>
<a name="ln60">SkillMenuEntry::SkillMenuEntry(coord_def coord)</a>
<a name="ln61">{</a>
<a name="ln62">#ifdef USE_TILE_LOCAL</a>
<a name="ln63">    m_name = new SkillTextTileItem();</a>
<a name="ln64">#else</a>
<a name="ln65">    m_name = new TextItem();</a>
<a name="ln66">#endif</a>
<a name="ln67"> </a>
<a name="ln68">    m_level = new NoSelectTextItem();</a>
<a name="ln69">    m_progress = new EditableTextItem();</a>
<a name="ln70">    m_progress-&gt;set_editable(false);</a>
<a name="ln71">    m_aptitude = new FormattedTextItem();</a>
<a name="ln72">    m_aptitude-&gt;allow_highlight(false);</a>
<a name="ln73"> </a>
<a name="ln74">#ifdef USE_TILE_LOCAL</a>
<a name="ln75">    const int height = skm.get_line_height();</a>
<a name="ln76">    m_name-&gt;set_height(height);</a>
<a name="ln77">    if (is_set(SKMF_SKILL_ICONS))</a>
<a name="ln78">    {</a>
<a name="ln79">        m_level-&gt;set_height(height);</a>
<a name="ln80">        m_progress-&gt;set_height(height);</a>
<a name="ln81">        m_aptitude-&gt;set_height(height);</a>
<a name="ln82">    }</a>
<a name="ln83">#endif</a>
<a name="ln84"> </a>
<a name="ln85">    skm.add_item(m_name, NAME_SIZE + (is_set(SKMF_SKILL_ICONS) ? 4 : 0), coord);</a>
<a name="ln86">    m_name-&gt;set_highlight_colour(RED);</a>
<a name="ln87">    skm.add_item(m_level, LEVEL_SIZE, coord);</a>
<a name="ln88">    skm.add_item(m_progress, PROGRESS_SIZE, coord);</a>
<a name="ln89">    skm.add_item(m_aptitude, APTITUDE_SIZE, coord);</a>
<a name="ln90">}</a>
<a name="ln91"> </a>
<a name="ln92">// Public methods</a>
<a name="ln93">int SkillMenuEntry::get_id()</a>
<a name="ln94">{</a>
<a name="ln95">    return m_name-&gt;get_id();</a>
<a name="ln96">}</a>
<a name="ln97"> </a>
<a name="ln98">TextItem* SkillMenuEntry::get_name_item() const</a>
<a name="ln99">{</a>
<a name="ln100">    return m_name;</a>
<a name="ln101">}</a>
<a name="ln102"> </a>
<a name="ln103">skill_type SkillMenuEntry::get_skill() const</a>
<a name="ln104">{</a>
<a name="ln105">    return m_sk;</a>
<a name="ln106">}</a>
<a name="ln107"> </a>
<a name="ln108">static bool _show_skill(skill_type sk, skill_menu_state state)</a>
<a name="ln109">{</a>
<a name="ln110">    switch (state)</a>
<a name="ln111">    {</a>
<a name="ln112">    case SKM_SHOW_DEFAULT:</a>
<a name="ln113">        return you.can_currently_train[sk] || you.skill(sk, 10, false, false)</a>
<a name="ln114">               || sk == you.transfer_from_skill || sk == you.transfer_to_skill;</a>
<a name="ln115">    case SKM_SHOW_ALL:     return true;</a>
<a name="ln116">    default:               return false;</a>
<a name="ln117">    }</a>
<a name="ln118">}</a>
<a name="ln119"> </a>
<a name="ln120">bool SkillMenuEntry::is_selectable(bool keep_hotkey)</a>
<a name="ln121">{</a>
<a name="ln122">    if (is_invalid_skill(m_sk))</a>
<a name="ln123">        return false;</a>
<a name="ln124"> </a>
<a name="ln125">    if (is_set(SKMF_HELP))</a>
<a name="ln126">        return true;</a>
<a name="ln127"> </a>
<a name="ln128">    if (you.species == SP_GNOLL)</a>
<a name="ln129">        return false;</a>
<a name="ln130"> </a>
<a name="ln131">    if (!_show_skill(m_sk, skm.get_state(SKM_SHOW)))</a>
<a name="ln132">        return false;</a>
<a name="ln133"> </a>
<a name="ln134">    if (is_set(SKMF_RESKILL_TO) &amp;&amp; you.transfer_from_skill == m_sk)</a>
<a name="ln135">    {</a>
<a name="ln136">        if (!keep_hotkey)</a>
<a name="ln137">            ++m_letter;</a>
<a name="ln138">        return false;</a>
<a name="ln139">    }</a>
<a name="ln140"> </a>
<a name="ln141">    if (is_set(SKMF_RESKILL_TO) &amp;&amp; is_useless_skill(m_sk))</a>
<a name="ln142">        return false;</a>
<a name="ln143"> </a>
<a name="ln144">    if (is_set(SKMF_RESKILL_FROM) &amp;&amp; !you.skill_points[m_sk])</a>
<a name="ln145">    {</a>
<a name="ln146">        if (!keep_hotkey)</a>
<a name="ln147">            ++m_letter;</a>
<a name="ln148">        return false;</a>
<a name="ln149">    }</a>
<a name="ln150"> </a>
<a name="ln151">    if (!you.can_currently_train[m_sk] &amp;&amp; !is_set(SKMF_RESKILL_TO)</a>
<a name="ln152">        &amp;&amp; !is_set(SKMF_RESKILL_FROM))</a>
<a name="ln153">    {</a>
<a name="ln154">        return false;</a>
<a name="ln155">    }</a>
<a name="ln156"> </a>
<a name="ln157">    if (mastered())</a>
<a name="ln158">    {</a>
<a name="ln159">        if (is_set(SKMF_RESKILL_TO) &amp;&amp; !keep_hotkey)</a>
<a name="ln160">            ++m_letter;</a>
<a name="ln161">        if (!is_set(SKMF_RESKILL_FROM))</a>
<a name="ln162">            return false;</a>
<a name="ln163">    }</a>
<a name="ln164"> </a>
<a name="ln165">    return true;</a>
<a name="ln166">}</a>
<a name="ln167"> </a>
<a name="ln168">bool SkillMenuEntry::is_set(int flag) const</a>
<a name="ln169">{</a>
<a name="ln170">    return skm.is_set(flag);</a>
<a name="ln171">}</a>
<a name="ln172"> </a>
<a name="ln173">bool SkillMenuEntry::mastered() const</a>
<a name="ln174">{</a>
<a name="ln175">    return (is_set(SKMF_EXPERIENCE) ? skm.get_raw_skill_level(m_sk)</a>
<a name="ln176">                                    : you.skills[m_sk]) &gt;= MAX_SKILL_LEVEL;</a>
<a name="ln177">}</a>
<a name="ln178"> </a>
<a name="ln179">void SkillMenuEntry::refresh(bool keep_hotkey)</a>
<a name="ln180">{</a>
<a name="ln181">    if (m_sk == SK_TITLE)</a>
<a name="ln182">        set_title();</a>
<a name="ln183">    else if (is_invalid_skill(m_sk) || is_useless_skill(m_sk))</a>
<a name="ln184">        _clear();</a>
<a name="ln185">    else</a>
<a name="ln186">    {</a>
<a name="ln187">        set_name(keep_hotkey);</a>
<a name="ln188">        set_display();</a>
<a name="ln189">        if (is_set(SKMF_APTITUDE))</a>
<a name="ln190">            set_aptitude();</a>
<a name="ln191">    }</a>
<a name="ln192">}</a>
<a name="ln193"> </a>
<a name="ln194">void SkillMenuEntry::set_display()</a>
<a name="ln195">{</a>
<a name="ln196">    if (m_sk == SK_TITLE)</a>
<a name="ln197">        set_title();</a>
<a name="ln198"> </a>
<a name="ln199">    if (is_invalid_skill(m_sk))</a>
<a name="ln200">        return;</a>
<a name="ln201"> </a>
<a name="ln202">    switch (skm.get_state(SKM_VIEW))</a>
<a name="ln203">    {</a>
<a name="ln204">    case SKM_VIEW_TRAINING:  set_training();         break;</a>
<a name="ln205">    case SKM_VIEW_COST:      set_cost();             break;</a>
<a name="ln206">    case SKM_VIEW_TARGETS:   set_targets();          break;</a>
<a name="ln207">    case SKM_VIEW_PROGRESS:  set_progress();         break;</a>
<a name="ln208">    case SKM_VIEW_TRANSFER:  set_reskill_progress(); break;</a>
<a name="ln209">    case SKM_VIEW_NEW_LEVEL: set_new_level();        break;</a>
<a name="ln210">    case SKM_VIEW_POINTS:    set_points();           break;</a>
<a name="ln211">    default: die(&quot;Invalid view state.&quot;);</a>
<a name="ln212">    }</a>
<a name="ln213">}</a>
<a name="ln214"> </a>
<a name="ln215">void SkillMenuEntry::set_name(bool keep_hotkey)</a>
<a name="ln216">{</a>
<a name="ln217">    if (is_invalid_skill(m_sk))</a>
<a name="ln218">        return;</a>
<a name="ln219"> </a>
<a name="ln220">    if (!keep_hotkey)</a>
<a name="ln221">        m_name-&gt;clear_hotkeys();</a>
<a name="ln222"> </a>
<a name="ln223">    if (is_selectable(keep_hotkey))</a>
<a name="ln224">    {</a>
<a name="ln225">        if (!keep_hotkey)</a>
<a name="ln226">        {</a>
<a name="ln227">            m_name-&gt;add_hotkey(++m_letter);</a>
<a name="ln228">            m_name-&gt;add_hotkey(toupper_safe(m_letter));</a>
<a name="ln229">        }</a>
<a name="ln230">        m_name-&gt;set_id(m_sk);</a>
<a name="ln231">        m_name-&gt;allow_highlight(true);</a>
<a name="ln232">    }</a>
<a name="ln233">    else</a>
<a name="ln234">    {</a>
<a name="ln235">        m_name-&gt;set_id(-1);</a>
<a name="ln236">        m_name-&gt;allow_highlight(false);</a>
<a name="ln237">    }</a>
<a name="ln238"> </a>
<a name="ln239">    m_name-&gt;set_text(make_stringf(&quot;%s %-15s&quot;, get_prefix().c_str(),</a>
<a name="ln240">                                skill_name(m_sk)));</a>
<a name="ln241">    m_name-&gt;set_fg_colour(get_colour());</a>
<a name="ln242">#ifdef USE_TILE_LOCAL</a>
<a name="ln243">    if (is_set(SKMF_SKILL_ICONS))</a>
<a name="ln244">    {</a>
<a name="ln245">        m_name-&gt;clear_tile();</a>
<a name="ln246">        if (you.skills[m_sk] &gt;= MAX_SKILL_LEVEL)</a>
<a name="ln247">        {</a>
<a name="ln248">            m_name-&gt;add_tile(tile_def(tileidx_skill(m_sk, TRAINING_MASTERED),</a>
<a name="ln249">                                      TEX_GUI));</a>
<a name="ln250">        }</a>
<a name="ln251">        else if (you.training[m_sk] == TRAINING_DISABLED)</a>
<a name="ln252">        {</a>
<a name="ln253">            m_name-&gt;add_tile(tile_def(tileidx_skill(m_sk, TRAINING_INACTIVE),</a>
<a name="ln254">                                      TEX_GUI));</a>
<a name="ln255">        }</a>
<a name="ln256">        else</a>
<a name="ln257">        {</a>
<a name="ln258">            m_name-&gt;add_tile(tile_def(tileidx_skill(m_sk, you.train[m_sk]),</a>
<a name="ln259">                                      TEX_GUI));</a>
<a name="ln260">        }</a>
<a name="ln261">    }</a>
<a name="ln262">#endif</a>
<a name="ln263">    set_level();</a>
<a name="ln264">}</a>
<a name="ln265"> </a>
<a name="ln266">void SkillMenuEntry::set_skill(skill_type sk)</a>
<a name="ln267">{</a>
<a name="ln268">    m_sk = sk;</a>
<a name="ln269">    refresh(false);</a>
<a name="ln270">}</a>
<a name="ln271"> </a>
<a name="ln272">// Private Methods</a>
<a name="ln273">void SkillMenuEntry::_clear()</a>
<a name="ln274">{</a>
<a name="ln275">    m_sk = SK_NONE;</a>
<a name="ln276"> </a>
<a name="ln277">    m_name-&gt;set_text(&quot;&quot;);</a>
<a name="ln278">    m_level-&gt;set_text(&quot;&quot;);</a>
<a name="ln279">    m_progress-&gt;set_text(&quot;&quot;);</a>
<a name="ln280">    m_aptitude-&gt;set_text(&quot;&quot;);</a>
<a name="ln281"> </a>
<a name="ln282">    m_name-&gt;set_id(-1);</a>
<a name="ln283">    m_name-&gt;clear_hotkeys();</a>
<a name="ln284">    m_name-&gt;allow_highlight(false);</a>
<a name="ln285">#ifdef USE_TILE_LOCAL</a>
<a name="ln286">    if (is_set(SKMF_SKILL_ICONS))</a>
<a name="ln287">        m_name-&gt;clear_tile();</a>
<a name="ln288">#endif</a>
<a name="ln289">}</a>
<a name="ln290">COLOURS SkillMenuEntry::get_colour() const</a>
<a name="ln291">{</a>
<a name="ln292">    // Skills being actively trained may get further distinction.</a>
<a name="ln293">    bool use_bright_colour = you.train[m_sk] == TRAINING_ENABLED</a>
<a name="ln294">        || you.train[m_sk] == TRAINING_FOCUSED;</a>
<a name="ln295"> </a>
<a name="ln296">    if (is_set(SKMF_HELP))</a>
<a name="ln297">        return LIGHTGRAY;</a>
<a name="ln298">    else if (is_set(SKMF_RESKILL_TO) &amp;&amp; m_sk == you.transfer_from_skill)</a>
<a name="ln299">        return BROWN;</a>
<a name="ln300">    else if (skm.get_state(SKM_VIEW) == SKM_VIEW_TRANSFER</a>
<a name="ln301">             &amp;&amp; (m_sk == you.transfer_from_skill</a>
<a name="ln302">                 || m_sk == you.transfer_to_skill))</a>
<a name="ln303">    {</a>
<a name="ln304">        return CYAN;</a>
<a name="ln305">    }</a>
<a name="ln306">    else if (skm.get_state(SKM_LEVEL) == SKM_LEVEL_ENHANCED</a>
<a name="ln307">             &amp;&amp; (you.skill(m_sk, 10, true) != you.skill(m_sk, 10, false)</a>
<a name="ln308">                 // Drained a tiny but nonzero amount.</a>
<a name="ln309">                 || you.attribute[ATTR_XP_DRAIN] &amp;&amp; you.skill_points[m_sk]))</a>
<a name="ln310">    {</a>
<a name="ln311">        if (you.skill(m_sk, 10, true) &lt; you.skill(m_sk, 10, false))</a>
<a name="ln312">            return use_bright_colour ? LIGHTGREEN : GREEN;</a>
<a name="ln313">        else</a>
<a name="ln314">            return use_bright_colour ? LIGHTMAGENTA : MAGENTA;</a>
<a name="ln315">    }</a>
<a name="ln316">    else if (mastered())</a>
<a name="ln317">        return YELLOW;</a>
<a name="ln318">    else if (!you.training[m_sk])</a>
<a name="ln319">        return DARKGREY;</a>
<a name="ln320">    else if (skill_has_manual(m_sk))</a>
<a name="ln321">        return LIGHTBLUE;</a>
<a name="ln322">    else if (you.train[m_sk] == TRAINING_FOCUSED)</a>
<a name="ln323">        return WHITE;</a>
<a name="ln324">    else</a>
<a name="ln325">        return LIGHTGREY;</a>
<a name="ln326">}</a>
<a name="ln327"> </a>
<a name="ln328">string SkillMenuEntry::get_prefix()</a>
<a name="ln329">{</a>
<a name="ln330">    int letter;</a>
<a name="ln331">    const vector&lt;int&gt; hotkeys = m_name-&gt;get_hotkeys();</a>
<a name="ln332"> </a>
<a name="ln333">    if (!hotkeys.empty())</a>
<a name="ln334">        letter = hotkeys[0];</a>
<a name="ln335">    else</a>
<a name="ln336">        letter = ' ';</a>
<a name="ln337"> </a>
<a name="ln338">    const int sign = (!you.can_currently_train[m_sk] || mastered()) ? ' ' :</a>
<a name="ln339">                                   (you.train[m_sk] == TRAINING_FOCUSED) ? '*' :</a>
<a name="ln340">                                          you.train[m_sk] ? '+'</a>
<a name="ln341">                                                          : '-';</a>
<a name="ln342">    return make_stringf(&quot; %c %c&quot;, letter, sign);</a>
<a name="ln343">}</a>
<a name="ln344"> </a>
<a name="ln345">void SkillMenuEntry::set_aptitude()</a>
<a name="ln346">{</a>
<a name="ln347">    string text = &quot;&lt;white&gt;&quot;;</a>
<a name="ln348"> </a>
<a name="ln349">    const bool manual = skill_has_manual(m_sk);</a>
<a name="ln350">    const int apt = species_apt(m_sk, you.species);</a>
<a name="ln351"> </a>
<a name="ln352">    if (apt != 0)</a>
<a name="ln353">        text += make_stringf(&quot;%+d&quot;, apt);</a>
<a name="ln354">    else</a>
<a name="ln355">        text += make_stringf(&quot; %d&quot;, apt);</a>
<a name="ln356"> </a>
<a name="ln357">    text += &quot;&lt;/white&gt; &quot;;</a>
<a name="ln358"> </a>
<a name="ln359">    if (manual)</a>
<a name="ln360">    {</a>
<a name="ln361">        skm.set_flag(SKMF_MANUAL);</a>
<a name="ln362">        text += &quot;&lt;lightred&gt;+4&lt;/lightred&gt;&quot;;</a>
<a name="ln363">    }</a>
<a name="ln364"> </a>
<a name="ln365">    m_aptitude-&gt;set_text(text);</a>
<a name="ln366">}</a>
<a name="ln367"> </a>
<a name="ln368">void SkillMenuEntry::set_level()</a>
<a name="ln369">{</a>
<a name="ln370">    int level;</a>
<a name="ln371">    const bool real = skm.get_state(SKM_LEVEL) != SKM_LEVEL_ENHANCED;</a>
<a name="ln372"> </a>
<a name="ln373">    if (is_set(SKMF_EXPERIENCE))</a>
<a name="ln374">        level = skm.get_saved_skill_level(m_sk, real);</a>
<a name="ln375">    else</a>
<a name="ln376">        level = you.skill(m_sk, 10, real);</a>
<a name="ln377"> </a>
<a name="ln378">    if (mastered() &amp;&amp; !you.attribute[ATTR_XP_DRAIN])</a>
<a name="ln379">        m_level-&gt;set_text(to_string(level / 10));</a>
<a name="ln380">    else</a>
<a name="ln381">        m_level-&gt;set_text(make_stringf(&quot;%4.1f&quot;, level / 10.0));</a>
<a name="ln382">    m_level-&gt;set_fg_colour(get_colour());</a>
<a name="ln383">}</a>
<a name="ln384"> </a>
<a name="ln385">void SkillMenuEntry::set_new_level()</a>
<a name="ln386">{</a>
<a name="ln387">    m_progress-&gt;set_editable(false);</a>
<a name="ln388"> </a>
<a name="ln389">    const bool real = skm.get_state(SKM_LEVEL) != SKM_LEVEL_ENHANCED;</a>
<a name="ln390">    int new_level = 0;</a>
<a name="ln391">    if (is_set(SKMF_EXPERIENCE) &amp;&amp; is_selectable())</a>
<a name="ln392">    {</a>
<a name="ln393">        new_level = you.skill(m_sk, 10, real);</a>
<a name="ln394">        m_progress-&gt;set_fg_colour(CYAN);</a>
<a name="ln395">        if (you.training[m_sk])</a>
<a name="ln396">            m_progress-&gt;set_text(make_stringf(&quot;&gt; %4.1f&quot;, new_level / 10.0));</a>
<a name="ln397">        else</a>
<a name="ln398">            m_progress-&gt;set_text(string(PROGRESS_SIZE, ' '));</a>
<a name="ln399">        return;</a>
<a name="ln400">    }</a>
<a name="ln401"> </a>
<a name="ln402">    if (you.skills[m_sk] &gt; 0 &amp;&amp; is_set(SKMF_RESKILL_FROM)</a>
<a name="ln403">        || m_sk == you.transfer_from_skill)</a>
<a name="ln404">    {</a>
<a name="ln405">        new_level = transfer_skill_points(m_sk, m_sk,</a>
<a name="ln406">                                          skill_transfer_amount(m_sk), true,</a>
<a name="ln407">                                          !real);</a>
<a name="ln408">        m_progress-&gt;set_fg_colour(BROWN);</a>
<a name="ln409">    }</a>
<a name="ln410">    else if (is_set(SKMF_RESKILL_TO))</a>
<a name="ln411">    {</a>
<a name="ln412">        new_level = transfer_skill_points(you.transfer_from_skill, m_sk,</a>
<a name="ln413">                                          you.transfer_skill_points, true,</a>
<a name="ln414">                                          !real);</a>
<a name="ln415">        m_progress-&gt;set_fg_colour(CYAN);</a>
<a name="ln416">    }</a>
<a name="ln417"> </a>
<a name="ln418">    if (is_selectable() || m_sk == you.transfer_from_skill)</a>
<a name="ln419">        m_progress-&gt;set_text(make_stringf(&quot;&gt; %4.1f&quot;, new_level / 10.0));</a>
<a name="ln420">    else</a>
<a name="ln421">        m_progress-&gt;set_text(&quot;&quot;);</a>
<a name="ln422"> </a>
<a name="ln423">}</a>
<a name="ln424"> </a>
<a name="ln425">void SkillMenuEntry::set_points()</a>
<a name="ln426">{</a>
<a name="ln427">    m_progress-&gt;set_text(make_stringf(&quot;%5d&quot;, you.skill_points[m_sk]));</a>
<a name="ln428">    m_progress-&gt;set_fg_colour(LIGHTGREY);</a>
<a name="ln429">    m_progress-&gt;set_editable(false);</a>
<a name="ln430">}</a>
<a name="ln431"> </a>
<a name="ln432">void SkillMenuEntry::set_progress()</a>
<a name="ln433">{</a>
<a name="ln434">    if (mastered())</a>
<a name="ln435">        m_progress-&gt;set_text(&quot;&quot;);</a>
<a name="ln436">    else</a>
<a name="ln437">    {</a>
<a name="ln438">        m_progress-&gt;set_text(make_stringf(&quot; %2d%%&quot;,</a>
<a name="ln439">                                          get_skill_percentage(m_sk)));</a>
<a name="ln440">    }</a>
<a name="ln441">    m_progress-&gt;set_fg_colour(CYAN);</a>
<a name="ln442">    m_progress-&gt;set_editable(false);</a>
<a name="ln443">}</a>
<a name="ln444"> </a>
<a name="ln445">EditableTextItem *SkillMenuEntry::get_progress()</a>
<a name="ln446">{</a>
<a name="ln447">    return m_progress;</a>
<a name="ln448">}</a>
<a name="ln449"> </a>
<a name="ln450">void SkillMenuEntry::set_targets()</a>
<a name="ln451">{</a>
<a name="ln452">    int target = you.get_training_target(m_sk);</a>
<a name="ln453">    if (target == 0)</a>
<a name="ln454">    {</a>
<a name="ln455">        m_progress-&gt;set_text(&quot;--&quot;);</a>
<a name="ln456">        m_progress-&gt;set_fg_colour(DARKGREY);</a>
<a name="ln457">    }</a>
<a name="ln458">    else</a>
<a name="ln459">    {</a>
<a name="ln460">        m_progress-&gt;set_text(make_stringf(&quot;%d.%d&quot;, target / 10, target % 10));</a>
<a name="ln461">        if (target_met(m_sk))</a>
<a name="ln462">            m_progress-&gt;set_fg_colour(DARKGREY); // mainly comes up in wizmode</a>
<a name="ln463">        else</a>
<a name="ln464">            m_progress-&gt;set_fg_colour(get_colour());</a>
<a name="ln465">    }</a>
<a name="ln466">    m_progress-&gt;set_editable(true, 4);</a>
<a name="ln467">}</a>
<a name="ln468"> </a>
<a name="ln469">void SkillMenuEntry::set_reskill_progress()</a>
<a name="ln470">{</a>
<a name="ln471">    string text;</a>
<a name="ln472">    if (m_sk == you.transfer_from_skill)</a>
<a name="ln473">        text = &quot;  *  &quot;;</a>
<a name="ln474">    else if (m_sk == you.transfer_to_skill)</a>
<a name="ln475">    {</a>
<a name="ln476">        text += make_stringf(&quot; %2d%%&quot;,</a>
<a name="ln477">                             (you.transfer_total_skill_points</a>
<a name="ln478">                             - you.transfer_skill_points)</a>
<a name="ln479">                                 * 100 / you.transfer_total_skill_points);</a>
<a name="ln480">    }</a>
<a name="ln481">    else</a>
<a name="ln482">        text = &quot;&quot;;</a>
<a name="ln483"> </a>
<a name="ln484">    m_progress-&gt;set_text(text);</a>
<a name="ln485">    m_progress-&gt;set_fg_colour(CYAN);</a>
<a name="ln486">}</a>
<a name="ln487"> </a>
<a name="ln488">void SkillMenuEntry::set_title()</a>
<a name="ln489">{</a>
<a name="ln490">    m_name-&gt;allow_highlight(false);</a>
<a name="ln491">    m_name-&gt;set_text(&quot;     Skill&quot;);</a>
<a name="ln492">    m_level-&gt;set_text(&quot;Level&quot;);</a>
<a name="ln493"> </a>
<a name="ln494">    m_name-&gt;set_fg_colour(BLUE);</a>
<a name="ln495">    m_level-&gt;set_fg_colour(BLUE);</a>
<a name="ln496">    m_progress-&gt;set_fg_colour(BLUE);</a>
<a name="ln497"> </a>
<a name="ln498">    if (is_set(SKMF_APTITUDE))</a>
<a name="ln499">        m_aptitude-&gt;set_text(&quot;&lt;blue&gt;Apt &lt;/blue&gt;&quot;);</a>
<a name="ln500"> </a>
<a name="ln501">    if (is_set(SKMF_RESKILLING))</a>
<a name="ln502">    {</a>
<a name="ln503">        if (is_set(SKMF_RESKILL_FROM))</a>
<a name="ln504">            m_progress-&gt;set_text(&quot;Source&quot;);</a>
<a name="ln505">        else</a>
<a name="ln506">            m_progress-&gt;set_text(&quot;Target&quot;);</a>
<a name="ln507">        return;</a>
<a name="ln508">    }</a>
<a name="ln509"> </a>
<a name="ln510">    switch (skm.get_state(SKM_VIEW))</a>
<a name="ln511">    {</a>
<a name="ln512">    case SKM_VIEW_TRAINING:  m_progress-&gt;set_text(&quot;Train&quot;); break;</a>
<a name="ln513">    case SKM_VIEW_TARGETS:   m_progress-&gt;set_text(&quot;Target&quot;); break;</a>
<a name="ln514">    case SKM_VIEW_PROGRESS:  m_progress-&gt;set_text(&quot;Progr&quot;); break;</a>
<a name="ln515">    case SKM_VIEW_TRANSFER:  m_progress-&gt;set_text(&quot;Trnsf&quot;); break;</a>
<a name="ln516">    case SKM_VIEW_POINTS:    m_progress-&gt;set_text(&quot;Points&quot;);break;</a>
<a name="ln517">    case SKM_VIEW_COST:      m_progress-&gt;set_text(&quot;Cost&quot;);  break;</a>
<a name="ln518">    case SKM_VIEW_NEW_LEVEL: m_progress-&gt;set_text(&quot;&gt; New&quot;); break;</a>
<a name="ln519">    default: die(&quot;Invalid view state.&quot;);</a>
<a name="ln520">    }</a>
<a name="ln521">}</a>
<a name="ln522"> </a>
<a name="ln523">void SkillMenuEntry::set_training()</a>
<a name="ln524">{</a>
<a name="ln525">    m_progress-&gt;set_editable(false);</a>
<a name="ln526"> </a>
<a name="ln527">    if (!you.training[m_sk])</a>
<a name="ln528">        m_progress-&gt;set_text(&quot;&quot;);</a>
<a name="ln529">    else</a>
<a name="ln530">        m_progress-&gt;set_text(make_stringf(&quot;%2d%%&quot;, you.training[m_sk]));</a>
<a name="ln531">    m_progress-&gt;set_fg_colour(BROWN);</a>
<a name="ln532">}</a>
<a name="ln533"> </a>
<a name="ln534">void SkillMenuEntry::set_cost()</a>
<a name="ln535">{</a>
<a name="ln536">    m_progress-&gt;set_editable(false);</a>
<a name="ln537"> </a>
<a name="ln538">    if (you.skills[m_sk] == MAX_SKILL_LEVEL)</a>
<a name="ln539">        return;</a>
<a name="ln540">    if (skill_has_manual(m_sk))</a>
<a name="ln541">        m_progress-&gt;set_fg_colour(LIGHTRED);</a>
<a name="ln542">    else</a>
<a name="ln543">        m_progress-&gt;set_fg_colour(CYAN);</a>
<a name="ln544"> </a>
<a name="ln545">    auto ratio = scaled_skill_cost(m_sk);</a>
<a name="ln546">    // Don't let the displayed number go greater than 4 characters</a>
<a name="ln547">    if (ratio &gt; 0)</a>
<a name="ln548">        m_progress-&gt;set_text(make_stringf(&quot;%4.*f&quot;, ratio &lt; 100 ? 1 : 0, ratio));</a>
<a name="ln549">}</a>
<a name="ln550"> </a>
<a name="ln551">SkillMenuSwitch::SkillMenuSwitch(string name, int hotkey) : m_name(name)</a>
<a name="ln552">{</a>
<a name="ln553">    add_hotkey(hotkey);</a>
<a name="ln554">    set_highlight_colour(YELLOW);</a>
<a name="ln555">}</a>
<a name="ln556"> </a>
<a name="ln557">void SkillMenuSwitch::add(skill_menu_state state)</a>
<a name="ln558">{</a>
<a name="ln559">    m_states.push_back(state);</a>
<a name="ln560">    if (m_states.size() == 1)</a>
<a name="ln561">        m_state = state;</a>
<a name="ln562">}</a>
<a name="ln563">skill_menu_state SkillMenuSwitch::get_state()</a>
<a name="ln564">{</a>
<a name="ln565">    return m_state;</a>
<a name="ln566">}</a>
<a name="ln567"> </a>
<a name="ln568">static bool _any_crosstrained()</a>
<a name="ln569">{</a>
<a name="ln570">    for (skill_type sk = SK_FIRST_SKILL; sk &lt; NUM_SKILLS; ++sk)</a>
<a name="ln571">    {</a>
<a name="ln572">        // Assumes crosstraining is symmetric; otherwise we should</a>
<a name="ln573">        // iterate over the result of get_crosstrain_skills and</a>
<a name="ln574">        // check the levels of *those* skills</a>
<a name="ln575">        if (you.skill_points[sk]</a>
<a name="ln576">            &amp;&amp; !get_crosstrain_skills(sk).empty())</a>
<a name="ln577">        {</a>
<a name="ln578">            // Didn't necessarily boost us by a noticeable amount,</a>
<a name="ln579">            // but close enough.</a>
<a name="ln580">            return true;</a>
<a name="ln581">        }</a>
<a name="ln582">    }</a>
<a name="ln583">    return false;</a>
<a name="ln584">}</a>
<a name="ln585"> </a>
<a name="ln586">string SkillMenuSwitch::get_help()</a>
<a name="ln587">{</a>
<a name="ln588">    switch (m_state)</a>
<a name="ln589">    {</a>
<a name="ln590">    case SKM_MODE_AUTO:</a>
<a name="ln591">        return &quot;In automatic mode, skills are trained as you use them.&quot;;</a>
<a name="ln592">    case SKM_MODE_MANUAL:</a>
<a name="ln593">        return &quot;In manual mode, experience is spread evenly across all &quot;</a>
<a name="ln594">                &quot;activated skills.&quot;;</a>
<a name="ln595">    case SKM_DO_PRACTISE:</a>
<a name="ln596">        if (skm.is_set(SKMF_SIMPLE))</a>
<a name="ln597">            return hints_skills_info();</a>
<a name="ln598">        else</a>
<a name="ln599">            return &quot;Press the letter of a skill to choose whether you want to &quot;</a>
<a name="ln600">                   &quot;practise it. Skills marked with '&lt;darkgrey&gt;-&lt;/darkgrey&gt;' &quot;</a>
<a name="ln601">                   &quot;will not be trained.&quot;;</a>
<a name="ln602">    case SKM_DO_FOCUS:</a>
<a name="ln603">        return &quot;Press the letter of a skill to cycle between &quot;</a>
<a name="ln604">               &quot;&lt;darkgrey&gt;disabled&lt;/darkgrey&gt; (&lt;darkgrey&gt;-&lt;/darkgrey&gt;), &quot;</a>
<a name="ln605">               &quot;enabled (+) and &lt;white&gt;focused&lt;/white&gt; (&lt;white&gt;*&lt;/white&gt;). &quot;</a>
<a name="ln606">               &quot;Focused skills train twice as fast relative to others.&quot;;</a>
<a name="ln607">    case SKM_LEVEL_ENHANCED:</a>
<a name="ln608">    {</a>
<a name="ln609">        string result;</a>
<a name="ln610">        if (skm.is_set(SKMF_ENHANCED))</a>
<a name="ln611">        {</a>
<a name="ln612">            vector&lt;string&gt; causes;</a>
<a name="ln613">            if (you.duration[DUR_HEROISM])</a>
<a name="ln614">                causes.push_back(&quot;Heroism&quot;);</a>
<a name="ln615"> </a>
<a name="ln616">            if (!you.skill_boost.empty()</a>
<a name="ln617">                &amp;&amp; have_passive(passive_t::bondage_skill_boost))</a>
<a name="ln618">            {</a>
<a name="ln619">                causes.push_back(apostrophise(god_name(you.religion))</a>
<a name="ln620">                                 + &quot; power&quot;);</a>
<a name="ln621">            }</a>
<a name="ln622">            if (_any_crosstrained())</a>
<a name="ln623">                causes.push_back(&quot;cross-training&quot;);</a>
<a name="ln624">            result = &quot;Skills enhanced by &quot;</a>
<a name="ln625">                     + comma_separated_line(causes.begin(), causes.end())</a>
<a name="ln626">                     + &quot; are in &lt;green&gt;green&lt;/green&gt;.&quot;;</a>
<a name="ln627">        }</a>
<a name="ln628"> </a>
<a name="ln629">        if (skm.is_set(SKMF_REDUCED))</a>
<a name="ln630">        {</a>
<a name="ln631">            vector&lt;const char *&gt; causes;</a>
<a name="ln632">            if (you.attribute[ATTR_XP_DRAIN])</a>
<a name="ln633">                causes.push_back(&quot;draining&quot;);</a>
<a name="ln634">            if (player_under_penance(GOD_ASHENZARI))</a>
<a name="ln635">                causes.push_back(&quot;Ashenzari's anger&quot;);</a>
<a name="ln636"> </a>
<a name="ln637">            if (!result.empty())</a>
<a name="ln638">                result += &quot;\n&quot;;</a>
<a name="ln639">            result += &quot;Skills reduced by &quot;</a>
<a name="ln640">                      + comma_separated_line(causes.begin(), causes.end())</a>
<a name="ln641">                      + &quot; are in &lt;magenta&gt;magenta&lt;/magenta&gt;.&quot;;</a>
<a name="ln642">        }</a>
<a name="ln643"> </a>
<a name="ln644">        if (!result.empty())</a>
<a name="ln645">            return result;</a>
<a name="ln646">    }</a>
<a name="ln647">    case SKM_VIEW_TRAINING:</a>
<a name="ln648">        if (skm.is_set(SKMF_SIMPLE))</a>
<a name="ln649">            return hints_skill_training_info();</a>
<a name="ln650">        else</a>
<a name="ln651">            return &quot;The percentage of incoming experience used&quot;</a>
<a name="ln652">                   &quot; to train each skill is in &lt;brown&gt;brown&lt;/brown&gt;.\n&quot;;</a>
<a name="ln653">    case SKM_VIEW_TARGETS:</a>
<a name="ln654">        if (skm.is_set(SKMF_SIMPLE))</a>
<a name="ln655">            return hints_skill_targets_info();</a>
<a name="ln656">        else</a>
<a name="ln657">            return &quot;The current training targets, if any.\n&quot;;</a>
<a name="ln658">    case SKM_VIEW_PROGRESS:</a>
<a name="ln659">        return &quot;The percentage of the progress done before reaching next &quot;</a>
<a name="ln660">               &quot;level is in &lt;cyan&gt;cyan&lt;/cyan&gt;.\n&quot;;</a>
<a name="ln661">    case SKM_VIEW_TRANSFER:</a>
<a name="ln662">        return &quot;The progress of the knowledge transfer is displayed in &quot;</a>
<a name="ln663">               &quot;&lt;cyan&gt;cyan&lt;/cyan&gt; in front of the skill receiving the &quot;</a>
<a name="ln664">               &quot;knowledge. The donating skill is marked with &lt;cyan&gt;*&lt;/cyan&gt;.&quot;;</a>
<a name="ln665">    case SKM_VIEW_COST:</a>
<a name="ln666">    {</a>
<a name="ln667">        if (skm.is_set(SKMF_SIMPLE))</a>
<a name="ln668">            return hints_skill_costs_info();</a>
<a name="ln669"> </a>
<a name="ln670">        string result =</a>
<a name="ln671">               &quot;The relative cost of raising each skill is in &quot;</a>
<a name="ln672">               &quot;&lt;cyan&gt;cyan&lt;/cyan&gt;&quot;;</a>
<a name="ln673">        if (skm.is_set(SKMF_MANUAL))</a>
<a name="ln674">        {</a>
<a name="ln675">            result += &quot; (or &lt;lightred&gt;red&lt;/lightred&gt; if enhanced by a &quot;</a>
<a name="ln676">                      &quot;manual)&quot;;</a>
<a name="ln677">        }</a>
<a name="ln678">        result += &quot;.\n&quot;;</a>
<a name="ln679">        return result;</a>
<a name="ln680">    }</a>
<a name="ln681">    default: return &quot;&quot;;</a>
<a name="ln682">    }</a>
<a name="ln683">}</a>
<a name="ln684"> </a>
<a name="ln685">string SkillMenuSwitch::get_name(skill_menu_state state)</a>
<a name="ln686">{</a>
<a name="ln687">    switch (state)</a>
<a name="ln688">    {</a>
<a name="ln689">    case SKM_MODE_AUTO:      return &quot;auto&quot;;</a>
<a name="ln690">    case SKM_MODE_MANUAL:    return &quot;manual&quot;;</a>
<a name="ln691">    case SKM_DO_PRACTISE:    return &quot;train&quot;;</a>
<a name="ln692">    case SKM_DO_FOCUS:       return &quot;focus&quot;;</a>
<a name="ln693">    case SKM_SHOW_DEFAULT:   return &quot;trainable&quot;;</a>
<a name="ln694">    case SKM_SHOW_ALL:       return &quot;all&quot;;</a>
<a name="ln695">    case SKM_LEVEL_ENHANCED:</a>
<a name="ln696">        return (skm.is_set(SKMF_ENHANCED)</a>
<a name="ln697">                &amp;&amp; skm.is_set(SKMF_REDUCED)) ? &quot;modified&quot; :</a>
<a name="ln698">                   skm.is_set(SKMF_ENHANCED) ? &quot;enhanced&quot;</a>
<a name="ln699">                                             : &quot;reduced&quot;;</a>
<a name="ln700">    case SKM_LEVEL_NORMAL:   return &quot;base&quot;;</a>
<a name="ln701">    case SKM_VIEW_TRAINING:  return &quot;training&quot;;</a>
<a name="ln702">    case SKM_VIEW_TARGETS:   return &quot;targets&quot;;</a>
<a name="ln703">    case SKM_VIEW_PROGRESS:  return &quot;progress&quot;;</a>
<a name="ln704">    case SKM_VIEW_TRANSFER:  return &quot;transfer&quot;;</a>
<a name="ln705">    case SKM_VIEW_POINTS:    return &quot;points&quot;;</a>
<a name="ln706">    case SKM_VIEW_NEW_LEVEL: return &quot;new level&quot;;</a>
<a name="ln707">    case SKM_VIEW_COST:      return &quot;cost&quot;;</a>
<a name="ln708">    default: die (&quot;Invalid switch state.&quot;);</a>
<a name="ln709">    }</a>
<a name="ln710">}</a>
<a name="ln711"> </a>
<a name="ln712">void SkillMenuSwitch::set_state(skill_menu_state state)</a>
<a name="ln713">{</a>
<a name="ln714">    // We only set it if it's a valid state.</a>
<a name="ln715">    for (auto candidate : m_states)</a>
<a name="ln716">    {</a>
<a name="ln717">        if (candidate == state)</a>
<a name="ln718">        {</a>
<a name="ln719">            m_state = state;</a>
<a name="ln720">            return;</a>
<a name="ln721">        }</a>
<a name="ln722">    }</a>
<a name="ln723">}</a>
<a name="ln724"> </a>
<a name="ln725">int SkillMenuSwitch::size() const</a>
<a name="ln726">{</a>
<a name="ln727">    if (m_states.size() &lt;= 1)</a>
<a name="ln728">        return 0;</a>
<a name="ln729">    else</a>
<a name="ln730">        return formatted_string::parse_string(m_text).width();</a>
<a name="ln731">}</a>
<a name="ln732"> </a>
<a name="ln733">bool SkillMenuSwitch::toggle()</a>
<a name="ln734">{</a>
<a name="ln735">    if (m_states.size() &lt;= 1)</a>
<a name="ln736">        return false;</a>
<a name="ln737"> </a>
<a name="ln738">    auto it = find(begin(m_states), end(m_states), m_state);</a>
<a name="ln739">    ASSERT(it != m_states.end());</a>
<a name="ln740">    ++it;</a>
<a name="ln741">    if (it == m_states.end())</a>
<a name="ln742">        it = m_states.begin();</a>
<a name="ln743"> </a>
<a name="ln744">    m_state = *it;</a>
<a name="ln745">    update();</a>
<a name="ln746">    return true;</a>
<a name="ln747">}</a>
<a name="ln748"> </a>
<a name="ln749">void SkillMenuSwitch::update()</a>
<a name="ln750">{</a>
<a name="ln751">    if (m_states.size() &lt;= 1)</a>
<a name="ln752">    {</a>
<a name="ln753">        set_text(&quot;&quot;);</a>
<a name="ln754">        return;</a>
<a name="ln755">    }</a>
<a name="ln756"> </a>
<a name="ln757">    const vector&lt;int&gt; hotkeys = get_hotkeys();</a>
<a name="ln758">    ASSERT(hotkeys.size());</a>
<a name="ln759">    string text = make_stringf(&quot; [&lt;yellow&gt;%c&lt;/yellow&gt;] &quot;, hotkeys[0]);</a>
<a name="ln760">    for (auto it = m_states.begin(); it != m_states.end(); ++it)</a>
<a name="ln761">    {</a>
<a name="ln762">        if (it != m_states.begin())</a>
<a name="ln763">            text += '|';</a>
<a name="ln764"> </a>
<a name="ln765">        const string col = (*it == m_state) ? &quot;white&quot; : &quot;darkgrey&quot;;</a>
<a name="ln766">        text += make_stringf(&quot;&lt;%s&gt;%s&lt;/%s&gt;&quot;, col.c_str(), get_name(*it).c_str(),</a>
<a name="ln767">                             col.c_str());</a>
<a name="ln768">    }</a>
<a name="ln769">    if (m_name.empty())</a>
<a name="ln770">        text += &quot;  &quot;;</a>
<a name="ln771">    else</a>
<a name="ln772">        text += make_stringf(&quot; %s  &quot;, m_name.c_str());</a>
<a name="ln773">    set_text(text);</a>
<a name="ln774">}</a>
<a name="ln775"> </a>
<a name="ln776">#define TILES_COL 6</a>
<a name="ln777">SkillMenu::SkillMenu() : PrecisionMenu(), m_min_coord(), m_max_coord(),</a>
<a name="ln778">                         m_help_button(nullptr)</a>
<a name="ln779">{</a>
<a name="ln780">}</a>
<a name="ln781"> </a>
<a name="ln782">void SkillMenu::init_experience()</a>
<a name="ln783">{</a>
<a name="ln784">    if (is_set(SKMF_EXPERIENCE) &amp;&amp; !m_skill_backup.state_saved())</a>
<a name="ln785">    {</a>
<a name="ln786">        m_skill_backup.save();</a>
<a name="ln787">        you.auto_training = false;</a>
<a name="ln788">        reset_training();</a>
<a name="ln789">        you.clear_training_targets();</a>
<a name="ln790"> </a>
<a name="ln791">        for (int i = 0; i &lt; NUM_SKILLS; ++i)</a>
<a name="ln792">        {</a>
<a name="ln793">            const skill_type sk = skill_type(i);</a>
<a name="ln794">            if (!is_useless_skill(sk) &amp;&amp; !you.can_currently_train[sk])</a>
<a name="ln795">            {</a>
<a name="ln796">                you.can_currently_train.set(sk);</a>
<a name="ln797">                you.train[sk] = TRAINING_DISABLED;</a>
<a name="ln798">            }</a>
<a name="ln799">        }</a>
<a name="ln800">    }</a>
<a name="ln801">}</a>
<a name="ln802"> </a>
<a name="ln803">/**</a>
<a name="ln804"> * resolve the player's experience state at the end of the skill menu, dealing</a>
<a name="ln805"> * with any experience applied to this skill menu instance (e.g. by a potion</a>
<a name="ln806"> * of experience).</a>
<a name="ln807"> *</a>
<a name="ln808"> * @param experience_change whether to actually do the experience change, or</a>
<a name="ln809"> *                          just do cleanup.</a>
<a name="ln810"> */</a>
<a name="ln811">void SkillMenu::finish_experience(bool experience_change)</a>
<a name="ln812">{</a>
<a name="ln813">    if (is_set(SKMF_EXPERIENCE) &amp;&amp; m_skill_backup.state_saved())</a>
<a name="ln814">    {</a>
<a name="ln815">        if (experience_change)</a>
<a name="ln816">        {</a>
<a name="ln817">            redraw_screen();</a>
<a name="ln818">            unwind_bool change_xp_for_real(crawl_state.simulating_xp_gain, false);</a>
<a name="ln819">            train_skills();</a>
<a name="ln820">        }</a>
<a name="ln821">        m_skill_backup.restore_training();</a>
<a name="ln822">        m_skill_backup = skill_state();</a>
<a name="ln823">    }</a>
<a name="ln824">}</a>
<a name="ln825"> </a>
<a name="ln826">void SkillMenu::init(int flag, int region_height)</a>
<a name="ln827">{</a>
<a name="ln828">    m_flags = flag;</a>
<a name="ln829">    init_flags();</a>
<a name="ln830"> </a>
<a name="ln831">    init_experience();</a>
<a name="ln832"> </a>
<a name="ln833">#ifdef USE_TILE_LOCAL</a>
<a name="ln834">    const int char_height = tiles.get_crt_font()-&gt;char_height();</a>
<a name="ln835">    if (Options.tile_menu_icons)</a>
<a name="ln836">    {</a>
<a name="ln837">        line_height = min((region_height - char_height * 6) / SK_ARR_LN,</a>
<a name="ln838">                          Options.tile_cell_pixels);</a>
<a name="ln839">        set_flag(SKMF_SKILL_ICONS);</a>
<a name="ln840">    }</a>
<a name="ln841">    else</a>
<a name="ln842">        line_height = char_height;</a>
<a name="ln843">#endif</a>
<a name="ln844"> </a>
<a name="ln845">    m_min_coord.x = 1;</a>
<a name="ln846">    m_min_coord.y = 1;</a>
<a name="ln847">    m_pos = m_min_coord;</a>
<a name="ln848">    m_ff = new MenuFreeform();</a>
<a name="ln849"> </a>
<a name="ln850">    m_max_coord.x = MIN_COLS + 1;</a>
<a name="ln851"> </a>
<a name="ln852">#ifdef USE_TILE_LOCAL</a>
<a name="ln853">    m_max_coord.y = region_height / char_height;</a>
<a name="ln854">    if (is_set(SKMF_SKILL_ICONS))</a>
<a name="ln855">    {</a>
<a name="ln856">        m_ff-&gt;set_height(line_height);</a>
<a name="ln857">        m_max_coord.x += 2 * TILES_COL;</a>
<a name="ln858">    }</a>
<a name="ln859">#else</a>
<a name="ln860">    m_max_coord.y = region_height + 1;</a>
<a name="ln861">#endif</a>
<a name="ln862"> </a>
<a name="ln863">    m_ff-&gt;init(m_min_coord, m_max_coord, &quot;freeform&quot;);</a>
<a name="ln864">    attach_object(m_ff);</a>
<a name="ln865">    set_active_object(m_ff);</a>
<a name="ln866"> </a>
<a name="ln867">    if (is_set(SKMF_SPECIAL))</a>
<a name="ln868">        init_title();</a>
<a name="ln869"> </a>
<a name="ln870">    m_pos.x++;</a>
<a name="ln871">    const int col_split = MIN_COLS / 2</a>
<a name="ln872">                          + (is_set(SKMF_SKILL_ICONS) ? TILES_COL : 0);</a>
<a name="ln873">    for (int col = 0; col &lt; SK_ARR_COL; ++col)</a>
<a name="ln874">        for (int ln = 0; ln &lt; SK_ARR_LN; ++ln)</a>
<a name="ln875">        {</a>
<a name="ln876">            m_skills[ln][col] = SkillMenuEntry(coord_def(m_pos.x</a>
<a name="ln877">                                                         + col_split * col,</a>
<a name="ln878">                                                         m_pos.y + ln));</a>
<a name="ln879">        }</a>
<a name="ln880"> </a>
<a name="ln881">    m_pos.y += SK_ARR_LN;</a>
<a name="ln882">#ifdef USE_TILE_LOCAL</a>
<a name="ln883">    if (is_set(SKMF_SKILL_ICONS))</a>
<a name="ln884">        m_pos.y = tiles.to_lines(m_pos.y, line_height);</a>
<a name="ln885">    else</a>
<a name="ln886">        ++m_pos.y;</a>
<a name="ln887">#endif</a>
<a name="ln888"> </a>
<a name="ln889">    init_button_row();</a>
<a name="ln890">    --m_pos.x;</a>
<a name="ln891">    init_switches();</a>
<a name="ln892"> </a>
<a name="ln893">    if (m_pos.y &lt; m_max_coord.y - 1)</a>
<a name="ln894">        shift_bottom_down();</a>
<a name="ln895"> </a>
<a name="ln896">    if (is_set(SKMF_SPECIAL))</a>
<a name="ln897">        set_title();</a>
<a name="ln898">    set_skills();</a>
<a name="ln899">    set_default_help();</a>
<a name="ln900"> </a>
<a name="ln901">    if (is_set(SKMF_EXPERIENCE))</a>
<a name="ln902">        refresh_display();</a>
<a name="ln903"> </a>
<a name="ln904">    m_highlighter = new BoxMenuHighlighter(this);</a>
<a name="ln905">    m_highlighter-&gt;init(coord_def(-1,-1), coord_def(-1,-1), &quot;highlighter&quot;);</a>
<a name="ln906">    attach_object(m_highlighter);</a>
<a name="ln907"> </a>
<a name="ln908">    m_ff-&gt;set_visible(true);</a>
<a name="ln909">    m_highlighter-&gt;set_visible(true);</a>
<a name="ln910">    refresh_button_row();</a>
<a name="ln911">    do_skill_enabled_check();</a>
<a name="ln912">}</a>
<a name="ln913"> </a>
<a name="ln914">static keyfun_action _keyfun_target_input(int &amp;ch)</a>
<a name="ln915">{</a>
<a name="ln916">    if (ch == '-')</a>
<a name="ln917">        return KEYFUN_BREAK; // reset to 0</a>
<a name="ln918">    if (ch == CONTROL('K') || ch == CONTROL('D') || ch == CONTROL('W') ||</a>
<a name="ln919">            ch == CONTROL('U') || ch == CONTROL('A') || ch == CONTROL('E') ||</a>
<a name="ln920">            ch == CK_ENTER || ch == CK_BKSP || ch == CK_ESCAPE ||</a>
<a name="ln921">            ch &lt; 0 || // this should get all other special keys</a>
<a name="ln922">            ch == '.' || isadigit(ch))</a>
<a name="ln923">    {</a>
<a name="ln924">        return KEYFUN_PROCESS;</a>
<a name="ln925">    }</a>
<a name="ln926">    return KEYFUN_IGNORE;</a>
<a name="ln927">}</a>
<a name="ln928"> </a>
<a name="ln929">int SkillMenu::read_skill_target(skill_type sk)</a>
<a name="ln930">{</a>
<a name="ln931">    SkillMenuEntry *entry = find_entry(sk);</a>
<a name="ln932">    ASSERT(entry);</a>
<a name="ln933">    EditableTextItem *progress = entry-&gt;get_progress();</a>
<a name="ln934">    ASSERT(progress);</a>
<a name="ln935"> </a>
<a name="ln936">    const int old_target = you.get_training_target(sk);</a>
<a name="ln937">    const string prefill = old_target &lt;= 0 ? &quot;0&quot;</a>
<a name="ln938">                    : make_stringf(&quot;%d.%d&quot;, old_target / 10, old_target % 10);</a>
<a name="ln939"> </a>
<a name="ln940">    progress-&gt;set_editable(true, 5);</a>
<a name="ln941">    progress-&gt;set_highlight_colour(RED);</a>
<a name="ln942"> </a>
<a name="ln943">    // for webtiles dialog input</a>
<a name="ln944">    progress-&gt;set_prompt(make_stringf(&quot;Enter a skill target for %s: &quot;,</a>
<a name="ln945">                                            skill_name(sk)));</a>
<a name="ln946">    progress-&gt;set_tag(&quot;skill_target&quot;);</a>
<a name="ln947"> </a>
<a name="ln948">    edit_result r = progress-&gt;edit(&amp;prefill, _keyfun_target_input);</a>
<a name="ln949"> </a>
<a name="ln950">    const char *result_buf = r.text.c_str();</a>
<a name="ln951"> </a>
<a name="ln952">    int input;</a>
<a name="ln953">    if (r.reader_result == '-')</a>
<a name="ln954">        input = 0;</a>
<a name="ln955">    else if (r.reader_result || result_buf[0] == '\0')</a>
<a name="ln956">    {</a>
<a name="ln957">        // editing canceled</a>
<a name="ln958">        cancel_set_target();</a>
<a name="ln959">        return -1;</a>
<a name="ln960">    }</a>
<a name="ln961">    else</a>
<a name="ln962">        input = round(atof(result_buf) * 10.0);    // TODO: parse fixed point?</a>
<a name="ln963"> </a>
<a name="ln964">    you.set_training_target(sk, input);</a>
<a name="ln965">    cancel_set_target();</a>
<a name="ln966">    refresh_display();</a>
<a name="ln967">    return input;</a>
<a name="ln968">}</a>
<a name="ln969"> </a>
<a name="ln970">void SkillMenu::clear()</a>
<a name="ln971">{</a>
<a name="ln972">    PrecisionMenu::clear(); // deletes m_ff, which deletes its entries</a>
<a name="ln973">    m_switches.clear();</a>
<a name="ln974">    m_ff = nullptr;</a>
<a name="ln975">    m_help_button = nullptr;</a>
<a name="ln976">    m_middle_button = nullptr;</a>
<a name="ln977">    m_clear_targets_button = nullptr;</a>
<a name="ln978">    m_skill_backup = skill_state();</a>
<a name="ln979">    m_flags = 0;</a>
<a name="ln980">}</a>
<a name="ln981"> </a>
<a name="ln982">//Public methods</a>
<a name="ln983">void SkillMenu::clear_flag(int flag)</a>
<a name="ln984">{</a>
<a name="ln985">    m_flags &amp;= ~flag;</a>
<a name="ln986">}</a>
<a name="ln987"> </a>
<a name="ln988">bool SkillMenu::is_set(int flag) const</a>
<a name="ln989">{</a>
<a name="ln990">    return m_flags &amp; flag;</a>
<a name="ln991">}</a>
<a name="ln992"> </a>
<a name="ln993">void SkillMenu::set_flag(int flag)</a>
<a name="ln994">{</a>
<a name="ln995">    m_flags |= flag;</a>
<a name="ln996">}</a>
<a name="ln997"> </a>
<a name="ln998">void SkillMenu::toggle_flag(int flag)</a>
<a name="ln999">{</a>
<a name="ln1000">    m_flags ^= flag;</a>
<a name="ln1001">}</a>
<a name="ln1002"> </a>
<a name="ln1003">void SkillMenu::add_item(TextItem* item, const int size, coord_def &amp;coord)</a>
<a name="ln1004">{</a>
<a name="ln1005">    if (coord.x + size &gt; m_max_coord.x)</a>
<a name="ln1006">    {</a>
<a name="ln1007">        coord.x = 1;</a>
<a name="ln1008">        ++coord.y;</a>
<a name="ln1009">    }</a>
<a name="ln1010">    item-&gt;set_bounds(coord, coord_def(coord.x + size, coord.y + 1));</a>
<a name="ln1011">    item-&gt;set_visible(true);</a>
<a name="ln1012">    m_ff-&gt;attach_item(item);</a>
<a name="ln1013">    if (size)</a>
<a name="ln1014">        coord.x += size + 1;</a>
<a name="ln1015">}</a>
<a name="ln1016"> </a>
<a name="ln1017">void SkillMenu::cancel_help()</a>
<a name="ln1018">{</a>
<a name="ln1019">    clear_flag(SKMF_HELP);</a>
<a name="ln1020">    refresh_names();</a>
<a name="ln1021">    set_default_help();</a>
<a name="ln1022">}</a>
<a name="ln1023"> </a>
<a name="ln1024">/**</a>
<a name="ln1025"> * Does the player have at least one skill enabled?</a>
<a name="ln1026"> * Side effect: will set an error message in the help line if not.</a>
<a name="ln1027"> *</a>
<a name="ln1028"> * @return true if the check passes: either a skill is enabled or no skills</a>
<a name="ln1029"> *         can be enabled.</a>
<a name="ln1030"> */</a>
<a name="ln1031">bool SkillMenu::do_skill_enabled_check()</a>
<a name="ln1032">{</a>
<a name="ln1033">    if (skills_being_trained())</a>
<a name="ln1034">        return true;</a>
<a name="ln1035"> </a>
<a name="ln1036">    if (trainable_skills())</a>
<a name="ln1037">    {</a>
<a name="ln1038">        // Shouldn't happen, but crash rather than locking the player in the</a>
<a name="ln1039">        // menu. Training will be fixed up on load.</a>
<a name="ln1040">        ASSERT(you.species != SP_GNOLL);</a>
<a name="ln1041">        set_help(&quot;&lt;lightred&gt;You need to enable at least one skill.&lt;/lightred&gt;&quot;);</a>
<a name="ln1042">        return false;</a>
<a name="ln1043">    }</a>
<a name="ln1044">    return true;</a>
<a name="ln1045">}</a>
<a name="ln1046"> </a>
<a name="ln1047">bool SkillMenu::exit(bool just_reset)</a>
<a name="ln1048">{</a>
<a name="ln1049">    if (just_reset)</a>
<a name="ln1050">    {</a>
<a name="ln1051">        finish_experience(false);</a>
<a name="ln1052">        clear();</a>
<a name="ln1053">        return true;</a>
<a name="ln1054">    }</a>
<a name="ln1055">    if (crawl_state.seen_hups)</a>
<a name="ln1056">    {</a>
<a name="ln1057">        clear();</a>
<a name="ln1058">        return true;</a>
<a name="ln1059">    }</a>
<a name="ln1060"> </a>
<a name="ln1061">    // Before we exit, make sure there's at least one skill enabled.</a>
<a name="ln1062">    if (!do_skill_enabled_check())</a>
<a name="ln1063">        return false;</a>
<a name="ln1064"> </a>
<a name="ln1065">    finish_experience(true);</a>
<a name="ln1066"> </a>
<a name="ln1067">    clear();</a>
<a name="ln1068">    return true;</a>
<a name="ln1069">}</a>
<a name="ln1070"> </a>
<a name="ln1071">#ifdef USE_TILE_LOCAL</a>
<a name="ln1072">int SkillMenu::get_line_height()</a>
<a name="ln1073">{</a>
<a name="ln1074">    return line_height;</a>
<a name="ln1075">}</a>
<a name="ln1076">#endif</a>
<a name="ln1077"> </a>
<a name="ln1078">int SkillMenu::get_raw_skill_level(skill_type sk)</a>
<a name="ln1079">{</a>
<a name="ln1080">    return m_skill_backup.skills[sk];</a>
<a name="ln1081">}</a>
<a name="ln1082"> </a>
<a name="ln1083">int SkillMenu::get_saved_skill_level(skill_type sk, bool real)</a>
<a name="ln1084">{</a>
<a name="ln1085">    if (real)</a>
<a name="ln1086">        return m_skill_backup.real_skills[sk];</a>
<a name="ln1087">    else</a>
<a name="ln1088">        return m_skill_backup.changed_skills[sk];</a>
<a name="ln1089">}</a>
<a name="ln1090"> </a>
<a name="ln1091">skill_menu_state SkillMenu::get_state(skill_menu_switch sw)</a>
<a name="ln1092">{</a>
<a name="ln1093">    if (is_set(SKMF_EXPERIENCE))</a>
<a name="ln1094">    {</a>
<a name="ln1095">        switch (sw)</a>
<a name="ln1096">        {</a>
<a name="ln1097">        case SKM_MODE:  return SKM_MODE_MANUAL;</a>
<a name="ln1098">        case SKM_DO:    return SKM_DO_FOCUS;</a>
<a name="ln1099">        case SKM_SHOW:  return SKM_SHOW_DEFAULT;</a>
<a name="ln1100">        case SKM_LEVEL: return SKM_LEVEL_NORMAL;</a>
<a name="ln1101">        case SKM_VIEW:  return SKM_VIEW_NEW_LEVEL;</a>
<a name="ln1102">        default:        return SKM_NONE;</a>
<a name="ln1103">        }</a>
<a name="ln1104">    }</a>
<a name="ln1105">    else if (!m_switches[sw])</a>
<a name="ln1106">    {</a>
<a name="ln1107">        if (you.species == SP_GNOLL)</a>
<a name="ln1108">        {</a>
<a name="ln1109">            switch (sw)</a>
<a name="ln1110">            {</a>
<a name="ln1111">            case SKM_MODE:  return SKM_MODE_MANUAL;</a>
<a name="ln1112">            case SKM_DO:    return SKM_DO_FOCUS;</a>
<a name="ln1113">            case SKM_SHOW:  return SKM_SHOW_ALL;</a>
<a name="ln1114">            default:        return SKM_NONE;</a>
<a name="ln1115">            }</a>
<a name="ln1116">        }</a>
<a name="ln1117">        else</a>
<a name="ln1118">            return SKM_NONE;</a>
<a name="ln1119">    }</a>
<a name="ln1120">    else</a>
<a name="ln1121">        return m_switches[sw]-&gt;get_state();</a>
<a name="ln1122">}</a>
<a name="ln1123"> </a>
<a name="ln1124">void SkillMenu::set_target_mode()</a>
<a name="ln1125">{</a>
<a name="ln1126">    if (get_state(SKM_VIEW) != SKM_VIEW_TARGETS &amp;&amp; m_switches[SKM_VIEW])</a>
<a name="ln1127">    {</a>
<a name="ln1128">        m_switches[SKM_VIEW]-&gt;set_state(SKM_VIEW_TARGETS);</a>
<a name="ln1129">        m_switches[SKM_VIEW]-&gt;update();</a>
<a name="ln1130">        refresh_display();</a>
<a name="ln1131">    }</a>
<a name="ln1132">    set_flag(SKMF_SET_TARGET);</a>
<a name="ln1133">    refresh_names();</a>
<a name="ln1134">}</a>
<a name="ln1135"> </a>
<a name="ln1136">void SkillMenu::cancel_set_target()</a>
<a name="ln1137">{</a>
<a name="ln1138">    clear_flag(SKMF_SET_TARGET);</a>
<a name="ln1139">    refresh_names();</a>
<a name="ln1140">}</a>
<a name="ln1141"> </a>
<a name="ln1142">void SkillMenu::clear_targets()</a>
<a name="ln1143">{</a>
<a name="ln1144">    if (get_state(SKM_VIEW) != SKM_VIEW_TARGETS)</a>
<a name="ln1145">        return;</a>
<a name="ln1146">    you.clear_training_targets();</a>
<a name="ln1147">    refresh_display();</a>
<a name="ln1148">}</a>
<a name="ln1149"> </a>
<a name="ln1150">void SkillMenu::help()</a>
<a name="ln1151">{</a>
<a name="ln1152">    if (!is_set(SKMF_HELP))</a>
<a name="ln1153">    {</a>
<a name="ln1154">        string text;</a>
<a name="ln1155">        if (is_set(SKMF_SIMPLE))</a>
<a name="ln1156">            text = hints_skills_description_info();</a>
<a name="ln1157">        else</a>
<a name="ln1158">            text = &quot;Press the letter of a skill to read its description.\n&quot;</a>
<a name="ln1159">                   &quot;Press &lt;w&gt;?&lt;/w&gt; for a general explanation&quot;</a>
<a name="ln1160">                   &quot; of skilling and the various toggles.&quot;;</a>
<a name="ln1161">        set_help(text);</a>
<a name="ln1162">    }</a>
<a name="ln1163">    else</a>
<a name="ln1164">    {</a>
<a name="ln1165">        if (!is_set(SKMF_SIMPLE))</a>
<a name="ln1166">            show_skill_menu_help();</a>
<a name="ln1167">        set_default_help();</a>
<a name="ln1168">    }</a>
<a name="ln1169">    toggle_flag(SKMF_HELP);</a>
<a name="ln1170">    refresh_names();</a>
<a name="ln1171">}</a>
<a name="ln1172"> </a>
<a name="ln1173">void SkillMenu::select(skill_type sk, int keyn)</a>
<a name="ln1174">{</a>
<a name="ln1175">    if (is_set(SKMF_HELP))</a>
<a name="ln1176">        show_description(sk);</a>
<a name="ln1177">    else if (is_set(SKMF_RESKILL_FROM))</a>
<a name="ln1178">        you.transfer_from_skill = sk;</a>
<a name="ln1179">    else if (is_set(SKMF_RESKILL_TO))</a>
<a name="ln1180">        you.transfer_to_skill = sk;</a>
<a name="ln1181">    else if (skm.get_state(SKM_VIEW) == SKM_VIEW_TARGETS</a>
<a name="ln1182">                                            &amp;&amp; skm.is_set(SKMF_SET_TARGET))</a>
<a name="ln1183">    {</a>
<a name="ln1184">        read_skill_target(sk);</a>
<a name="ln1185">    }</a>
<a name="ln1186">    else if (get_state(SKM_DO) == SKM_DO_PRACTISE</a>
<a name="ln1187">             || get_state(SKM_DO) == SKM_DO_FOCUS)</a>
<a name="ln1188">    {</a>
<a name="ln1189">        toggle_practise(sk, keyn);</a>
<a name="ln1190">        if (get_state(SKM_VIEW) == SKM_VIEW_TRAINING || is_set(SKMF_EXPERIENCE)</a>
<a name="ln1191">            || keyn &gt;= 'A' &amp;&amp; keyn &lt;= 'Z')</a>
<a name="ln1192">        {</a>
<a name="ln1193">            refresh_display();</a>
<a name="ln1194">        }</a>
<a name="ln1195">    }</a>
<a name="ln1196">}</a>
<a name="ln1197"> </a>
<a name="ln1198">void SkillMenu::toggle(skill_menu_switch sw)</a>
<a name="ln1199">{</a>
<a name="ln1200">    if (!m_switches[sw]-&gt;toggle())</a>
<a name="ln1201">        return;</a>
<a name="ln1202"> </a>
<a name="ln1203">    // XXX: should use a pointer instead.</a>
<a name="ln1204">    FixedVector&lt;training_status, NUM_SKILLS&gt; tmp;</a>
<a name="ln1205"> </a>
<a name="ln1206">    switch (sw)</a>
<a name="ln1207">    {</a>
<a name="ln1208">    case SKM_MODE:</a>
<a name="ln1209">        you.auto_training = !you.auto_training;</a>
<a name="ln1210"> </a>
<a name="ln1211">        // Switch the skill train state with the saved version.</a>
<a name="ln1212">        tmp = you.train;</a>
<a name="ln1213">        you.train = you.train_alt;</a>
<a name="ln1214">        you.train_alt = tmp;</a>
<a name="ln1215"> </a>
<a name="ln1216">        reset_training();</a>
<a name="ln1217">        break;</a>
<a name="ln1218">    case SKM_DO:</a>
<a name="ln1219">        you.skill_menu_do = get_state(SKM_DO);</a>
<a name="ln1220">        refresh_names();</a>
<a name="ln1221">        if (m_ff-&gt;get_active_item() != nullptr</a>
<a name="ln1222">            &amp;&amp; !m_ff-&gt;get_active_item()-&gt;can_be_highlighted())</a>
<a name="ln1223">        {</a>
<a name="ln1224">            m_ff-&gt;activate_default_item();</a>
<a name="ln1225">        }</a>
<a name="ln1226">        break;</a>
<a name="ln1227">    case SKM_SHOW:</a>
<a name="ln1228">        set_skills();</a>
<a name="ln1229">        break;</a>
<a name="ln1230">    case SKM_VIEW:</a>
<a name="ln1231">        you.skill_menu_view = get_state(SKM_VIEW);</a>
<a name="ln1232">        break;</a>
<a name="ln1233">    case SKM_LEVEL: break;</a>
<a name="ln1234">    }</a>
<a name="ln1235">    refresh_display();</a>
<a name="ln1236">    set_help(m_switches[sw]-&gt;get_help());</a>
<a name="ln1237">}</a>
<a name="ln1238"> </a>
<a name="ln1239">// Private methods</a>
<a name="ln1240">SkillMenuEntry* SkillMenu::find_entry(skill_type sk)</a>
<a name="ln1241">{</a>
<a name="ln1242">    for (int col = 0; col &lt; SK_ARR_COL; ++col)</a>
<a name="ln1243">        for (int ln = 0; ln &lt; SK_ARR_LN; ++ln)</a>
<a name="ln1244">            if (m_skills[ln][col].get_skill() == sk)</a>
<a name="ln1245">                return &amp;m_skills[ln][col];</a>
<a name="ln1246"> </a>
<a name="ln1247">    return nullptr;</a>
<a name="ln1248">}</a>
<a name="ln1249"> </a>
<a name="ln1250">void SkillMenu::init_flags()</a>
<a name="ln1251">{</a>
<a name="ln1252">    if (crawl_state.game_is_hints_tutorial())</a>
<a name="ln1253">        set_flag(SKMF_SIMPLE);</a>
<a name="ln1254">    else</a>
<a name="ln1255">        set_flag(SKMF_APTITUDE);</a>
<a name="ln1256"> </a>
<a name="ln1257">    for (unsigned int i = 0; i &lt; NUM_SKILLS; ++i)</a>
<a name="ln1258">    {</a>
<a name="ln1259">        skill_type type = skill_type(i);</a>
<a name="ln1260">        if (you.skill(type, 10) &gt; you.skill(type, 10, true))</a>
<a name="ln1261">            set_flag(SKMF_ENHANCED);</a>
<a name="ln1262">        else if (you.skill(type, 10) &lt; you.skill(type, 10, true))</a>
<a name="ln1263">            set_flag(SKMF_REDUCED);</a>
<a name="ln1264">    }</a>
<a name="ln1265"> </a>
<a name="ln1266">    // You might be drained by a small enough amount to not affect the</a>
<a name="ln1267">    // rounded numbers.</a>
<a name="ln1268">    if (you.attribute[ATTR_XP_DRAIN])</a>
<a name="ln1269">        set_flag(SKMF_REDUCED);</a>
<a name="ln1270">}</a>
<a name="ln1271"> </a>
<a name="ln1272">void SkillMenu::init_title()</a>
<a name="ln1273">{</a>
<a name="ln1274">    m_title = new NoSelectTextItem();</a>
<a name="ln1275">    m_title-&gt;set_bounds(m_pos,</a>
<a name="ln1276">                        coord_def(m_max_coord.x, m_pos.y + 1));</a>
<a name="ln1277">    ++m_pos.y;</a>
<a name="ln1278">    m_title-&gt;set_fg_colour(WHITE);</a>
<a name="ln1279">    m_ff-&gt;attach_item(m_title);</a>
<a name="ln1280">    m_title-&gt;set_visible(true);</a>
<a name="ln1281">}</a>
<a name="ln1282"> </a>
<a name="ln1283">void SkillMenu::init_button_row()</a>
<a name="ln1284">{</a>
<a name="ln1285">    m_help = new FormattedTextItem();</a>
<a name="ln1286">    int help_height = 3;</a>
<a name="ln1287">    if (is_set(SKMF_SIMPLE))</a>
<a name="ln1288">    {</a>
<a name="ln1289">        // We just assume that the player won't learn too many skills while</a>
<a name="ln1290">        // in tutorial/hint mode.</a>
<a name="ln1291">        m_pos.y -= 1;</a>
<a name="ln1292">        help_height += 2;</a>
<a name="ln1293">    }</a>
<a name="ln1294"> </a>
<a name="ln1295">    m_help-&gt;set_bounds(m_pos, coord_def(m_max_coord.x, m_pos.y + help_height));</a>
<a name="ln1296">    m_pos.y += help_height;</a>
<a name="ln1297">    m_ff-&gt;attach_item(m_help);</a>
<a name="ln1298">    m_help-&gt;set_fg_colour(LIGHTGREY);</a>
<a name="ln1299">    m_help-&gt;set_visible(true);</a>
<a name="ln1300"> </a>
<a name="ln1301">    if (!is_set(SKMF_SPECIAL))</a>
<a name="ln1302">    {</a>
<a name="ln1303">        // left button always display help.</a>
<a name="ln1304">        m_help_button = new FormattedTextItem();</a>
<a name="ln1305">        m_help_button-&gt;set_id(SKM_HELP);</a>
<a name="ln1306">        m_help_button-&gt;add_hotkey('?');</a>
<a name="ln1307">        m_help_button-&gt;set_highlight_colour(YELLOW);</a>
<a name="ln1308">        add_item(m_help_button, 23, m_pos);</a>
<a name="ln1309"> </a>
<a name="ln1310">        // middle button is used to display [a-z] legends, and also to set a</a>
<a name="ln1311">        // skill target in the proper mode.</a>
<a name="ln1312">        m_middle_button = new FormattedTextItem();</a>
<a name="ln1313">        m_middle_button-&gt;add_hotkey('=');</a>
<a name="ln1314">        m_middle_button-&gt;set_id(SKM_SET_TARGET);</a>
<a name="ln1315">        m_middle_button-&gt;set_highlight_colour(YELLOW);</a>
<a name="ln1316">        add_item(m_middle_button, 27, m_pos);</a>
<a name="ln1317"> </a>
<a name="ln1318">        // right button is either blank or shows target clearing options.</a>
<a name="ln1319">        m_clear_targets_button = new FormattedTextItem();</a>
<a name="ln1320">        m_clear_targets_button-&gt;set_id(SKM_CLEAR_TARGETS);</a>
<a name="ln1321">        m_clear_targets_button-&gt;add_hotkey('-');</a>
<a name="ln1322">        m_clear_targets_button-&gt;set_highlight_colour(YELLOW);</a>
<a name="ln1323">        add_item(m_clear_targets_button, 25, m_pos);</a>
<a name="ln1324">        refresh_button_row();</a>
<a name="ln1325">    }</a>
<a name="ln1326">}</a>
<a name="ln1327"> </a>
<a name="ln1328">void SkillMenu::init_switches()</a>
<a name="ln1329">{</a>
<a name="ln1330">    SkillMenuSwitch* sw;</a>
<a name="ln1331">    if (you.species != SP_GNOLL)</a>
<a name="ln1332">    {</a>
<a name="ln1333">        sw = new SkillMenuSwitch(&quot;mode&quot;, '/');</a>
<a name="ln1334">        m_switches[SKM_MODE] = sw;</a>
<a name="ln1335">        sw-&gt;add(SKM_MODE_AUTO);</a>
<a name="ln1336">        if (!is_set(SKMF_SPECIAL) &amp;&amp; !is_set(SKMF_SIMPLE))</a>
<a name="ln1337">            sw-&gt;add(SKM_MODE_MANUAL);</a>
<a name="ln1338">        if (!you.auto_training)</a>
<a name="ln1339">            sw-&gt;set_state(SKM_MODE_MANUAL);</a>
<a name="ln1340">        sw-&gt;update();</a>
<a name="ln1341">        sw-&gt;set_id(SKM_MODE);</a>
<a name="ln1342">        add_item(sw, sw-&gt;size(), m_pos);</a>
<a name="ln1343"> </a>
<a name="ln1344">        sw = new SkillMenuSwitch(&quot;skill&quot;, '|');</a>
<a name="ln1345">        m_switches[SKM_DO] = sw;</a>
<a name="ln1346">        if (!is_set(SKMF_EXPERIENCE)</a>
<a name="ln1347">            &amp;&amp; (is_set(SKMF_SIMPLE) || Options.skill_focus != SKM_FOCUS_ON))</a>
<a name="ln1348">        {</a>
<a name="ln1349">            sw-&gt;add(SKM_DO_PRACTISE);</a>
<a name="ln1350">        }</a>
<a name="ln1351">        if (!is_set(SKMF_RESKILLING) &amp;&amp; !is_set(SKMF_SIMPLE)</a>
<a name="ln1352">            &amp;&amp; Options.skill_focus != SKM_FOCUS_OFF)</a>
<a name="ln1353">        {</a>
<a name="ln1354">            sw-&gt;add(SKM_DO_FOCUS);</a>
<a name="ln1355">        }</a>
<a name="ln1356">        sw-&gt;set_state(you.skill_menu_do);</a>
<a name="ln1357">        sw-&gt;add_hotkey('\t');</a>
<a name="ln1358">        sw-&gt;update();</a>
<a name="ln1359">        sw-&gt;set_id(SKM_DO);</a>
<a name="ln1360">        add_item(sw, sw-&gt;size(), m_pos);</a>
<a name="ln1361"> </a>
<a name="ln1362">        sw = new SkillMenuSwitch(&quot;skills&quot;, '*');</a>
<a name="ln1363">        m_switches[SKM_SHOW] = sw;</a>
<a name="ln1364">        sw-&gt;add(SKM_SHOW_DEFAULT);</a>
<a name="ln1365">        if (!is_set(SKMF_SIMPLE) &amp;&amp; !is_set(SKMF_EXPERIENCE))</a>
<a name="ln1366">        {</a>
<a name="ln1367">            sw-&gt;add(SKM_SHOW_ALL);</a>
<a name="ln1368">            if (Options.default_show_all_skills)</a>
<a name="ln1369">                sw-&gt;set_state(SKM_SHOW_ALL);</a>
<a name="ln1370">        }</a>
<a name="ln1371">        sw-&gt;update();</a>
<a name="ln1372">        sw-&gt;set_id(SKM_SHOW);</a>
<a name="ln1373">        add_item(sw, sw-&gt;size(), m_pos);</a>
<a name="ln1374">    }</a>
<a name="ln1375"> </a>
<a name="ln1376">    if (is_set(SKMF_CHANGED))</a>
<a name="ln1377">    {</a>
<a name="ln1378">        sw = new SkillMenuSwitch(&quot;level&quot;, '_');</a>
<a name="ln1379">        m_switches[SKM_LEVEL] = sw;</a>
<a name="ln1380">        sw-&gt;add(SKM_LEVEL_ENHANCED);</a>
<a name="ln1381">        sw-&gt;add(SKM_LEVEL_NORMAL);</a>
<a name="ln1382">        sw-&gt;update();</a>
<a name="ln1383">        sw-&gt;set_id(SKM_LEVEL);</a>
<a name="ln1384">        add_item(sw, sw-&gt;size(), m_pos);</a>
<a name="ln1385">    }</a>
<a name="ln1386"> </a>
<a name="ln1387">    sw = new SkillMenuSwitch(&quot;&quot;, '!');</a>
<a name="ln1388">    m_switches[SKM_VIEW] = sw;</a>
<a name="ln1389">    const bool transferring = !is_invalid_skill(you.transfer_to_skill);</a>
<a name="ln1390">    if (!is_set(SKMF_SPECIAL) || you.wizard)</a>
<a name="ln1391">    {</a>
<a name="ln1392">        sw-&gt;add(SKM_VIEW_TRAINING);</a>
<a name="ln1393"> </a>
<a name="ln1394">        if (transferring)</a>
<a name="ln1395">        {</a>
<a name="ln1396">            sw-&gt;add(SKM_VIEW_TRANSFER);</a>
<a name="ln1397">            sw-&gt;set_state(SKM_VIEW_TRANSFER);</a>
<a name="ln1398">        }</a>
<a name="ln1399"> </a>
<a name="ln1400">        sw-&gt;add(SKM_VIEW_COST);</a>
<a name="ln1401"> </a>
<a name="ln1402">        if (!you.auto_training)</a>
<a name="ln1403">            sw-&gt;set_state(SKM_VIEW_COST);</a>
<a name="ln1404">    }</a>
<a name="ln1405"> </a>
<a name="ln1406">    if (you.species != SP_GNOLL)</a>
<a name="ln1407">        sw-&gt;add(SKM_VIEW_TARGETS);</a>
<a name="ln1408"> </a>
<a name="ln1409">    if (you.wizard)</a>
<a name="ln1410">    {</a>
<a name="ln1411">        sw-&gt;add(SKM_VIEW_PROGRESS);</a>
<a name="ln1412">        sw-&gt;add(SKM_VIEW_POINTS);</a>
<a name="ln1413">    }</a>
<a name="ln1414"> </a>
<a name="ln1415">    if (is_set(SKMF_SPECIAL))</a>
<a name="ln1416">    {</a>
<a name="ln1417">        sw-&gt;add(SKM_VIEW_NEW_LEVEL);</a>
<a name="ln1418">        sw-&gt;set_state(SKM_VIEW_NEW_LEVEL);</a>
<a name="ln1419">    }</a>
<a name="ln1420">    else</a>
<a name="ln1421">        sw-&gt;set_state(you.skill_menu_view);</a>
<a name="ln1422"> </a>
<a name="ln1423">    sw-&gt;update();</a>
<a name="ln1424">    sw-&gt;set_id(SKM_VIEW);</a>
<a name="ln1425">    add_item(sw, sw-&gt;size(), m_pos);</a>
<a name="ln1426">}</a>
<a name="ln1427"> </a>
<a name="ln1428">void SkillMenu::refresh_display()</a>
<a name="ln1429">{</a>
<a name="ln1430">    if (is_set(SKMF_EXPERIENCE))</a>
<a name="ln1431">        train_skills(true);</a>
<a name="ln1432"> </a>
<a name="ln1433">    for (int ln = 0; ln &lt; SK_ARR_LN; ++ln)</a>
<a name="ln1434">        for (int col = 0; col &lt; SK_ARR_COL; ++col)</a>
<a name="ln1435">            m_skills[ln][col].refresh(true);</a>
<a name="ln1436"> </a>
<a name="ln1437">    if (is_set(SKMF_EXPERIENCE))</a>
<a name="ln1438">        m_skill_backup.restore_levels();</a>
<a name="ln1439">    refresh_button_row();</a>
<a name="ln1440">}</a>
<a name="ln1441"> </a>
<a name="ln1442">void SkillMenu::refresh_button_row()</a>
<a name="ln1443">{</a>
<a name="ln1444">    if (is_set(SKMF_SPECIAL))</a>
<a name="ln1445">        return;</a>
<a name="ln1446">    const string helpstring = &quot;[&lt;yellow&gt;?&lt;/yellow&gt;] &quot;;</a>
<a name="ln1447">    const string azstring = &quot;[&lt;yellow&gt;a&lt;/yellow&gt;-&lt;yellow&gt;z&lt;/yellow&gt;] &quot;;</a>
<a name="ln1448"> </a>
<a name="ln1449">    string legend = is_set(SKMF_SIMPLE) ? &quot;Skill descriptions&quot; : &quot;Help&quot;;</a>
<a name="ln1450">    string midlegend = &quot;&quot;;</a>
<a name="ln1451">    string clearlegend = &quot;&quot;;</a>
<a name="ln1452">    if (is_set(SKMF_HELP))</a>
<a name="ln1453">    {</a>
<a name="ln1454">        legend = is_set(SKMF_SIMPLE) ? &quot;Return to skill selection&quot;</a>
<a name="ln1455">                 : &quot;&lt;w&gt;Help&lt;/w&gt;&quot;;</a>
<a name="ln1456">        midlegend = azstring + &quot;skill descriptions&quot;;</a>
<a name="ln1457">    }</a>
<a name="ln1458">    else if (!is_set(SKMF_SIMPLE) &amp;&amp; get_state(SKM_VIEW) == SKM_VIEW_TARGETS)</a>
<a name="ln1459">    {</a>
<a name="ln1460">        if (is_set(SKMF_SET_TARGET))</a>
<a name="ln1461">        {</a>
<a name="ln1462">            midlegend = azstring + &quot;set skill target&quot;;</a>
<a name="ln1463">            clearlegend = &quot;[&lt;yellow&gt;-&lt;/yellow&gt;] clear selected target&quot;;</a>
<a name="ln1464">        }</a>
<a name="ln1465">        else</a>
<a name="ln1466">        {</a>
<a name="ln1467">            midlegend = &quot;[&lt;yellow&gt;=&lt;/yellow&gt;] set a skill target&quot;;</a>
<a name="ln1468">            clearlegend = &quot;[&lt;yellow&gt;-&lt;/yellow&gt;] clear all targets&quot;;</a>
<a name="ln1469">        }</a>
<a name="ln1470">    }</a>
<a name="ln1471">    else if (you.species != SP_GNOLL) // SKM_VIEW_TARGETS unavailable for Gn</a>
<a name="ln1472">        midlegend = &quot;[&lt;yellow&gt;=&lt;/yellow&gt;] set a skill target&quot;;</a>
<a name="ln1473"> </a>
<a name="ln1474">    m_help_button-&gt;set_text(helpstring + legend);</a>
<a name="ln1475">    m_middle_button-&gt;set_text(midlegend);</a>
<a name="ln1476">    m_clear_targets_button-&gt;set_text(clearlegend + &quot;\n&quot;);</a>
<a name="ln1477">}</a>
<a name="ln1478"> </a>
<a name="ln1479">void SkillMenu::refresh_names()</a>
<a name="ln1480">{</a>
<a name="ln1481">    SkillMenuEntry::m_letter = '9';</a>
<a name="ln1482">    bool default_set = false;</a>
<a name="ln1483">    for (int col = 0; col &lt; SK_ARR_COL; ++col)</a>
<a name="ln1484">        for (int ln = 0; ln &lt; SK_ARR_LN; ++ln)</a>
<a name="ln1485">        {</a>
<a name="ln1486">            SkillMenuEntry&amp; skme = m_skills[ln][col];</a>
<a name="ln1487">            if (!default_set &amp;&amp; skme.is_selectable())</a>
<a name="ln1488">            {</a>
<a name="ln1489">                m_ff-&gt;set_default_item(skme.get_name_item());</a>
<a name="ln1490">                default_set = true;</a>
<a name="ln1491">            }</a>
<a name="ln1492">            skme.set_name(false);</a>
<a name="ln1493">        }</a>
<a name="ln1494">    set_links();</a>
<a name="ln1495">    if (m_ff-&gt;get_active_item() != nullptr</a>
<a name="ln1496">        &amp;&amp; !m_ff-&gt;get_active_item()-&gt;can_be_highlighted())</a>
<a name="ln1497">    {</a>
<a name="ln1498">        m_ff-&gt;activate_default_item();</a>
<a name="ln1499">    }</a>
<a name="ln1500">    refresh_button_row();</a>
<a name="ln1501">}</a>
<a name="ln1502"> </a>
<a name="ln1503">void SkillMenu::set_default_help()</a>
<a name="ln1504">{</a>
<a name="ln1505">    string text;</a>
<a name="ln1506">    if (is_set(SKMF_RESKILL_FROM))</a>
<a name="ln1507">    {</a>
<a name="ln1508">        text = &quot;Select a skill as the source of the knowledge transfer. The &quot;</a>
<a name="ln1509">               &quot;chosen skill will be reduced to the level shown in &quot;</a>
<a name="ln1510">               &quot;&lt;brown&gt;brown&lt;/brown&gt;.&quot;;</a>
<a name="ln1511">    }</a>
<a name="ln1512">    else if (is_set(SKMF_RESKILL_TO))</a>
<a name="ln1513">    {</a>
<a name="ln1514">        text = &quot;Select a skill as the destination of the knowledge transfer. &quot;</a>
<a name="ln1515">               &quot;The chosen skill will be raised to the level shown in &quot;</a>
<a name="ln1516">               &quot;&lt;cyan&gt;cyan&lt;/cyan&gt;.&quot;;</a>
<a name="ln1517">    }</a>
<a name="ln1518">    else if (is_set(SKMF_EXPERIENCE))</a>
<a name="ln1519">    {</a>
<a name="ln1520">        text = &quot;Select the skills you want to be trained. &quot;</a>
<a name="ln1521">               &quot;The chosen skills will be raised to the level shown in &quot;</a>
<a name="ln1522">               &quot;&lt;cyan&gt;cyan&lt;/cyan&gt;.&quot;;</a>
<a name="ln1523">    }</a>
<a name="ln1524">    else if (is_set(SKMF_SIMPLE))</a>
<a name="ln1525">        text = hints_skills_info();</a>
<a name="ln1526">    else</a>
<a name="ln1527">    {</a>
<a name="ln1528">        if (!is_set(SKMF_MANUAL))</a>
<a name="ln1529">            text = m_switches[SKM_VIEW]-&gt;get_help();</a>
<a name="ln1530"> </a>
<a name="ln1531">        if (get_state(SKM_LEVEL) == SKM_LEVEL_ENHANCED)</a>
<a name="ln1532">            text += m_switches[SKM_LEVEL]-&gt;get_help() + &quot; &quot;;</a>
<a name="ln1533">        else</a>
<a name="ln1534">            text += &quot;The species aptitude is in &lt;white&gt;white&lt;/white&gt;. &quot;;</a>
<a name="ln1535"> </a>
<a name="ln1536">        if (is_set(SKMF_MANUAL))</a>
<a name="ln1537">            text += &quot;Bonus from skill manuals is in &lt;lightred&gt;red&lt;/lightred&gt;. &quot;;</a>
<a name="ln1538">    }</a>
<a name="ln1539"> </a>
<a name="ln1540">    // This one takes priority.</a>
<a name="ln1541">    if (get_state(SKM_VIEW) == SKM_VIEW_TRANSFER)</a>
<a name="ln1542">        text = m_switches[SKM_VIEW]-&gt;get_help();</a>
<a name="ln1543"> </a>
<a name="ln1544">    m_help-&gt;set_text(text);</a>
<a name="ln1545">}</a>
<a name="ln1546"> </a>
<a name="ln1547">void SkillMenu::set_help(string msg)</a>
<a name="ln1548">{</a>
<a name="ln1549">    if (msg.empty())</a>
<a name="ln1550">        set_default_help();</a>
<a name="ln1551">    else</a>
<a name="ln1552">        m_help-&gt;set_text(msg);</a>
<a name="ln1553">}</a>
<a name="ln1554"> </a>
<a name="ln1555">void SkillMenu::set_skills()</a>
<a name="ln1556">{</a>
<a name="ln1557">    int previous_active;</a>
<a name="ln1558">    if (m_ff-&gt;get_active_item() != nullptr)</a>
<a name="ln1559">        previous_active = m_ff-&gt;get_active_item()-&gt;get_id();</a>
<a name="ln1560">    else</a>
<a name="ln1561">        previous_active = -1;</a>
<a name="ln1562"> </a>
<a name="ln1563">    SkillMenuEntry::m_letter = '9';</a>
<a name="ln1564">    bool default_set = false;</a>
<a name="ln1565">    clear_flag(SKMF_MANUAL);</a>
<a name="ln1566"> </a>
<a name="ln1567">    int col = 0, ln = 0;</a>
<a name="ln1568"> </a>
<a name="ln1569">    for (int i = 0; i &lt; ndisplayed_skills; ++i)</a>
<a name="ln1570">    {</a>
<a name="ln1571">        skill_type sk = skill_display_order[i];</a>
<a name="ln1572">        SkillMenuEntry&amp; skme = m_skills[ln][col];</a>
<a name="ln1573"> </a>
<a name="ln1574">        if (sk == SK_COLUMN_BREAK)</a>
<a name="ln1575">        {</a>
<a name="ln1576">            while (ln &lt; SK_ARR_LN)</a>
<a name="ln1577">            {</a>
<a name="ln1578">                m_skills[ln][col].set_skill();</a>
<a name="ln1579">                ln++;</a>
<a name="ln1580">            }</a>
<a name="ln1581">            col++;</a>
<a name="ln1582">            ln = 0;</a>
<a name="ln1583">            continue;</a>
<a name="ln1584">        }</a>
<a name="ln1585">        else if (!is_invalid_skill(sk) &amp;&amp; !_show_skill(sk, get_state(SKM_SHOW)))</a>
<a name="ln1586">            continue;</a>
<a name="ln1587">        else</a>
<a name="ln1588">        {</a>
<a name="ln1589">            skme.set_skill(sk);</a>
<a name="ln1590">            if (!default_set &amp;&amp; skme.is_selectable())</a>
<a name="ln1591">            {</a>
<a name="ln1592">                m_ff-&gt;set_default_item(skme.get_name_item());</a>
<a name="ln1593">                default_set = true;</a>
<a name="ln1594">            }</a>
<a name="ln1595">        }</a>
<a name="ln1596">        ++ln;</a>
<a name="ln1597">    }</a>
<a name="ln1598">    if (previous_active != -1)</a>
<a name="ln1599">        m_ff-&gt;set_active_item(previous_active);</a>
<a name="ln1600"> </a>
<a name="ln1601">    set_links();</a>
<a name="ln1602">}</a>
<a name="ln1603"> </a>
<a name="ln1604">void SkillMenu::toggle_practise(skill_type sk, int keyn)</a>
<a name="ln1605">{</a>
<a name="ln1606">    ASSERT(you.can_currently_train[sk]);</a>
<a name="ln1607">    if (keyn &gt;= 'A' &amp;&amp; keyn &lt;= 'Z')</a>
<a name="ln1608">        you.train.init(TRAINING_DISABLED);</a>
<a name="ln1609">    if (get_state(SKM_DO) == SKM_DO_PRACTISE)</a>
<a name="ln1610">        you.train[sk] = (you.train[sk] ? TRAINING_DISABLED : TRAINING_ENABLED);</a>
<a name="ln1611">    else if (get_state(SKM_DO) == SKM_DO_FOCUS)</a>
<a name="ln1612">    {</a>
<a name="ln1613">        you.train[sk]</a>
<a name="ln1614">            = (training_status)((you.train[sk] + 1) % NUM_TRAINING_STATUSES);</a>
<a name="ln1615">    }</a>
<a name="ln1616">    else</a>
<a name="ln1617">        die(&quot;Invalid state.&quot;);</a>
<a name="ln1618">    reset_training();</a>
<a name="ln1619">    SkillMenuEntry* skme = find_entry(sk);</a>
<a name="ln1620">    skme-&gt;set_name(true);</a>
<a name="ln1621">    const vector&lt;int&gt; hotkeys = skme-&gt;get_name_item()-&gt;get_hotkeys();</a>
<a name="ln1622"> </a>
<a name="ln1623">    if (!hotkeys.empty())</a>
<a name="ln1624">    {</a>
<a name="ln1625">        int letter;</a>
<a name="ln1626">        letter = hotkeys[0];</a>
<a name="ln1627">        MenuItem* next_item = m_ff-&gt;find_item_by_hotkey(++letter);</a>
<a name="ln1628">        if (next_item != nullptr)</a>
<a name="ln1629">        {</a>
<a name="ln1630">            if (m_ff-&gt;get_active_item() != nullptr &amp;&amp; keyn == CK_ENTER)</a>
<a name="ln1631">                m_ff-&gt;set_active_item(next_item);</a>
<a name="ln1632">            else</a>
<a name="ln1633">                m_ff-&gt;set_default_item(next_item);</a>
<a name="ln1634">        }</a>
<a name="ln1635">    }</a>
<a name="ln1636">}</a>
<a name="ln1637"> </a>
<a name="ln1638">void SkillMenu::set_title()</a>
<a name="ln1639">{</a>
<a name="ln1640">    const char* format = is_set(SKMF_RESKILLING)</a>
<a name="ln1641">                                ? &quot;Transfer Knowledge: select the %s skill&quot;</a>
<a name="ln1642">                                : &quot;You have %s. Select the skills to train.&quot;;</a>
<a name="ln1643">    string t;</a>
<a name="ln1644">    if (is_set(SKMF_RESKILL_FROM))</a>
<a name="ln1645">        t = make_stringf(format, &quot;source&quot;);</a>
<a name="ln1646">    else if (is_set(SKMF_RESKILL_TO))</a>
<a name="ln1647">        t = make_stringf(format, &quot;destination&quot;);</a>
<a name="ln1648">    else if (is_set(SKMF_EXPERIENCE))</a>
<a name="ln1649">        t = make_stringf(format, &quot;quaffed a potion of experience&quot;);</a>
<a name="ln1650"> </a>
<a name="ln1651">    m_title-&gt;set_text(t);</a>
<a name="ln1652">}</a>
<a name="ln1653"> </a>
<a name="ln1654">void SkillMenu::shift_bottom_down()</a>
<a name="ln1655">{</a>
<a name="ln1656">    const coord_def down(0, 1);</a>
<a name="ln1657">    m_help-&gt;move(down);</a>
<a name="ln1658">    for (auto &amp;entry : m_switches)</a>
<a name="ln1659">        entry.second-&gt;move(down);</a>
<a name="ln1660"> </a>
<a name="ln1661">    if (m_help_button)</a>
<a name="ln1662">    {</a>
<a name="ln1663">        m_help_button-&gt;move(down);</a>
<a name="ln1664">        m_middle_button-&gt;move(down);</a>
<a name="ln1665">        m_clear_targets_button-&gt;move(down);</a>
<a name="ln1666">    }</a>
<a name="ln1667">}</a>
<a name="ln1668"> </a>
<a name="ln1669">void SkillMenu::show_description(skill_type sk)</a>
<a name="ln1670">{</a>
<a name="ln1671">    describe_skill(sk);</a>
<a name="ln1672">}</a>
<a name="ln1673"> </a>
<a name="ln1674">TextItem* SkillMenu::find_closest_selectable(int start_ln, int col)</a>
<a name="ln1675">{</a>
<a name="ln1676">    int delta = 0;</a>
<a name="ln1677">    while (1)</a>
<a name="ln1678">    {</a>
<a name="ln1679">        int ln_up = max(0, start_ln - delta);</a>
<a name="ln1680">        int ln_down = min(SK_ARR_LN, start_ln + delta);</a>
<a name="ln1681">        if (m_skills[ln_up][col].is_selectable())</a>
<a name="ln1682">            return m_skills[ln_up][col].get_name_item();</a>
<a name="ln1683">        else if (m_skills[ln_down][col].is_selectable())</a>
<a name="ln1684">            return m_skills[ln_down][col].get_name_item();</a>
<a name="ln1685">        else if (ln_up == 0 &amp;&amp; ln_down == SK_ARR_LN)</a>
<a name="ln1686">            return nullptr;</a>
<a name="ln1687"> </a>
<a name="ln1688">        ++delta;</a>
<a name="ln1689">    }</a>
<a name="ln1690">}</a>
<a name="ln1691"> </a>
<a name="ln1692">void SkillMenu::set_links()</a>
<a name="ln1693">{</a>
<a name="ln1694">    TextItem* top_left = nullptr;</a>
<a name="ln1695">    TextItem* top_right = nullptr;</a>
<a name="ln1696">    TextItem* bottom_left = nullptr;</a>
<a name="ln1697">    TextItem* bottom_right = nullptr;</a>
<a name="ln1698"> </a>
<a name="ln1699">    for (int ln = 0; ln &lt; SK_ARR_LN; ++ln)</a>
<a name="ln1700">    {</a>
<a name="ln1701">        if (m_skills[ln][0].is_selectable())</a>
<a name="ln1702">        {</a>
<a name="ln1703">            TextItem* left = m_skills[ln][0].get_name_item();</a>
<a name="ln1704">            left-&gt;set_link_up(nullptr);</a>
<a name="ln1705">            left-&gt;set_link_down(nullptr);</a>
<a name="ln1706">            left-&gt;set_link_right(find_closest_selectable(ln, 1));</a>
<a name="ln1707">            if (top_left == nullptr)</a>
<a name="ln1708">                top_left = left;</a>
<a name="ln1709">            bottom_left = left;</a>
<a name="ln1710">        }</a>
<a name="ln1711">        if (m_skills[ln][1].is_selectable())</a>
<a name="ln1712">        {</a>
<a name="ln1713">            TextItem* right = m_skills[ln][1].get_name_item();</a>
<a name="ln1714">            right-&gt;set_link_up(nullptr);</a>
<a name="ln1715">            right-&gt;set_link_down(nullptr);</a>
<a name="ln1716">            right-&gt;set_link_left(find_closest_selectable(ln, 0));</a>
<a name="ln1717">            if (top_right == nullptr)</a>
<a name="ln1718">                top_right = right;</a>
<a name="ln1719">            bottom_right = right;</a>
<a name="ln1720">        }</a>
<a name="ln1721">    }</a>
<a name="ln1722">    if (top_left != nullptr)</a>
<a name="ln1723">    {</a>
<a name="ln1724">        top_left-&gt;set_link_up(bottom_right);</a>
<a name="ln1725">        bottom_left-&gt;set_link_down(top_right);</a>
<a name="ln1726">    }</a>
<a name="ln1727">    if (top_right != nullptr)</a>
<a name="ln1728">    {</a>
<a name="ln1729">        top_right-&gt;set_link_up(bottom_left);</a>
<a name="ln1730">        bottom_right-&gt;set_link_down(top_left);</a>
<a name="ln1731">    }</a>
<a name="ln1732">}</a>
<a name="ln1733"> </a>
<a name="ln1734">class UISkillMenu : public Widget</a>
<a name="ln1735">{</a>
<a name="ln1736">public:</a>
<a name="ln1737">    UISkillMenu(int _flag) : flag(_flag) {};</a>
<a name="ln1738">    ~UISkillMenu() {};</a>
<a name="ln1739"> </a>
<a name="ln1740">    virtual void _render() override;</a>
<a name="ln1741">    virtual SizeReq _get_preferred_size(Direction dim, int prosp_width) override;</a>
<a name="ln1742">    virtual void _allocate_region() override;</a>
<a name="ln1743">#ifdef USE_TILE_LOCAL</a>
<a name="ln1744">    virtual bool on_event(const Event&amp; ev) override;</a>
<a name="ln1745">#endif</a>
<a name="ln1746"> </a>
<a name="ln1747">protected:</a>
<a name="ln1748">    int flag;</a>
<a name="ln1749">};</a>
<a name="ln1750"> </a>
<a name="ln1751">SizeReq UISkillMenu::_get_preferred_size(Direction dim, int /*prosp_width*/)</a>
<a name="ln1752">{</a>
<a name="ln1753">#ifdef USE_TILE_LOCAL</a>
<a name="ln1754">    SizeReq ret;</a>
<a name="ln1755">    if (!dim)</a>
<a name="ln1756">        ret = { 90, 90 };</a>
<a name="ln1757">    else</a>
<a name="ln1758">        ret = { 25, 38 };</a>
<a name="ln1759"> </a>
<a name="ln1760">    const FontWrapper* font = tiles.get_crt_font();</a>
<a name="ln1761">    const int f = !dim ? font-&gt;char_width() : font-&gt;char_height();</a>
<a name="ln1762">    ret.min *= f;</a>
<a name="ln1763">    ret.nat *= f;</a>
<a name="ln1764"> </a>
<a name="ln1765">    return ret;</a>
<a name="ln1766">#else</a>
<a name="ln1767">    if (!dim)</a>
<a name="ln1768">        return { 80, 80 };</a>
<a name="ln1769">    else</a>
<a name="ln1770">        return { 24, 24 };</a>
<a name="ln1771">#endif</a>
<a name="ln1772">}</a>
<a name="ln1773"> </a>
<a name="ln1774">void UISkillMenu::_allocate_region()</a>
<a name="ln1775">{</a>
<a name="ln1776">    skm.exit(true);</a>
<a name="ln1777">    skm.init(flag, m_region.height);</a>
<a name="ln1778">}</a>
<a name="ln1779"> </a>
<a name="ln1780">void UISkillMenu::_render()</a>
<a name="ln1781">{</a>
<a name="ln1782">#ifdef USE_TILE_LOCAL</a>
<a name="ln1783">    GLW_3VF t = {(float)m_region.x, (float)m_region.y, 0}, s = {1, 1, 1};</a>
<a name="ln1784">    glmanager-&gt;set_transform(t, s);</a>
<a name="ln1785">#endif</a>
<a name="ln1786">    skm.draw_menu();</a>
<a name="ln1787">#ifdef USE_TILE_LOCAL</a>
<a name="ln1788">    glmanager-&gt;reset_transform();</a>
<a name="ln1789">#endif</a>
<a name="ln1790">}</a>
<a name="ln1791"> </a>
<a name="ln1792">#ifdef USE_TILE_LOCAL</a>
<a name="ln1793">bool UISkillMenu::on_event(const Event&amp; ev)</a>
<a name="ln1794">{</a>
<a name="ln1795">    if (ev.type() != Event::Type::MouseMove</a>
<a name="ln1796">     &amp;&amp; ev.type() != Event::Type::MouseDown</a>
<a name="ln1797">     &amp;&amp; ev.type() != Event::Type::MouseWheel)</a>
<a name="ln1798">    {</a>
<a name="ln1799">        return Widget::on_event(ev);</a>
<a name="ln1800">    }</a>
<a name="ln1801"> </a>
<a name="ln1802">    const auto mouse_event = static_cast&lt;const MouseEvent&amp;&gt;(ev);</a>
<a name="ln1803"> </a>
<a name="ln1804">    // XXX: convert Event back into a wm_mouse_event for the PrecisionMenu</a>
<a name="ln1805">    // code. once skill-menu is widgified, PrecisionMenu can be removed</a>
<a name="ln1806">    wm_mouse_event mev;</a>
<a name="ln1807">    mev.event = ev.type() == Event::Type::MouseMove ? wm_mouse_event::MOVE :</a>
<a name="ln1808">                ev.type() == Event::Type::MouseDown ? wm_mouse_event::PRESS :</a>
<a name="ln1809">                wm_mouse_event::WHEEL;</a>
<a name="ln1810">    mev.button = static_cast&lt;wm_mouse_event::mouse_event_button&gt;(</a>
<a name="ln1811">            mouse_event.button());</a>
<a name="ln1812">    mev.mod = wm-&gt;get_mod_state();</a>
<a name="ln1813">    int x, y;</a>
<a name="ln1814">    mev.held = wm-&gt;get_mouse_state(&amp;x, &amp;y);</a>
<a name="ln1815">    mev.px = x - m_region.x;</a>
<a name="ln1816">    mev.py = y - m_region.y;</a>
<a name="ln1817"> </a>
<a name="ln1818">    int key = skm.handle_mouse(mev);</a>
<a name="ln1819">    if (key &amp;&amp; key != CK_NO_KEY)</a>
<a name="ln1820">    {</a>
<a name="ln1821">        wm_keyboard_event fake_key = {0};</a>
<a name="ln1822">        fake_key.keysym.sym = key;</a>
<a name="ln1823">        KeyEvent key_ev(Event::Type::KeyDown, fake_key);</a>
<a name="ln1824">        Widget::on_event(key_ev);</a>
<a name="ln1825">    }</a>
<a name="ln1826"> </a>
<a name="ln1827">    if (ev.type() == Event::Type::MouseMove)</a>
<a name="ln1828">        _expose();</a>
<a name="ln1829"> </a>
<a name="ln1830">    return true;</a>
<a name="ln1831">}</a>
<a name="ln1832">#endif</a>
<a name="ln1833"> </a>
<a name="ln1834">void skill_menu(int flag, int exp)</a>
<a name="ln1835">{</a>
<a name="ln1836">    // experience potion; you may elect to put experience in normally</a>
<a name="ln1837">    // untrainable skills (skills where you aren't carrying the right item,</a>
<a name="ln1838">    // or skills that your god hates). The only case where we abort is if all</a>
<a name="ln1839">    // in-principle trainable skills are maxed.</a>
<a name="ln1840">    if (flag &amp; SKMF_EXPERIENCE &amp;&amp; !trainable_skills(true))</a>
<a name="ln1841">    {</a>
<a name="ln1842">        mpr(&quot;You feel omnipotent.&quot;);</a>
<a name="ln1843">        return;</a>
<a name="ln1844">    }</a>
<a name="ln1845"> </a>
<a name="ln1846">    unwind_bool xp_gain(crawl_state.simulating_xp_gain, flag &amp; SKMF_EXPERIENCE);</a>
<a name="ln1847"> </a>
<a name="ln1848">    // notify the player again</a>
<a name="ln1849">    you.received_noskill_warning = false;</a>
<a name="ln1850"> </a>
<a name="ln1851">    you.exp_available += exp;</a>
<a name="ln1852"> </a>
<a name="ln1853">    bool done = false;</a>
<a name="ln1854">    auto skill_menu_ui = make_shared&lt;UISkillMenu&gt;(flag);</a>
<a name="ln1855">    auto popup = make_shared&lt;ui::Popup&gt;(skill_menu_ui);</a>
<a name="ln1856"> </a>
<a name="ln1857">    skill_menu_ui-&gt;on_keydown_event([&amp;done, &amp;skill_menu_ui](const KeyEvent&amp; ev) {</a>
<a name="ln1858">        const auto keyn = ev.key();</a>
<a name="ln1859"> </a>
<a name="ln1860">        skill_menu_ui-&gt;_expose();</a>
<a name="ln1861"> </a>
<a name="ln1862">        if (!skm.process_key(keyn))</a>
<a name="ln1863">        {</a>
<a name="ln1864">            switch (keyn)</a>
<a name="ln1865">            {</a>
<a name="ln1866">            case CK_UP:</a>
<a name="ln1867">            case CK_DOWN:</a>
<a name="ln1868">            case CK_LEFT:</a>
<a name="ln1869">            case CK_RIGHT:</a>
<a name="ln1870">            case 1004:</a>
<a name="ln1871">            case 1002:</a>
<a name="ln1872">            case 1008:</a>
<a name="ln1873">            case 1006:</a>
<a name="ln1874">                return true;</a>
<a name="ln1875">            case CK_ENTER:</a>
<a name="ln1876">                if (!skm.is_set(SKMF_EXPERIENCE))</a>
<a name="ln1877">                    return true;</a>
<a name="ln1878">            // Fallthrough. In experience mode, you can exit with enter.</a>
<a name="ln1879">            case CK_ESCAPE:</a>
<a name="ln1880">                // Escape cancels help if it is being displayed.</a>
<a name="ln1881">                if (skm.is_set(SKMF_HELP))</a>
<a name="ln1882">                {</a>
<a name="ln1883">                    skm.cancel_help();</a>
<a name="ln1884">                    return true;</a>
<a name="ln1885">                }</a>
<a name="ln1886">                else if (skm.is_set(SKMF_SET_TARGET))</a>
<a name="ln1887">                {</a>
<a name="ln1888">                    skm.cancel_set_target();</a>
<a name="ln1889">                    return true;</a>
<a name="ln1890">                }</a>
<a name="ln1891">            // Fallthrough</a>
<a name="ln1892">            case ' ':</a>
<a name="ln1893">                // Space and escape exit in any mode.</a>
<a name="ln1894">                if (skm.exit(false))</a>
<a name="ln1895">                    return done = true;</a>
<a name="ln1896">            default:</a>
<a name="ln1897">                // Don't exit from !experience on random keys.</a>
<a name="ln1898">                if (!skm.is_set(SKMF_EXPERIENCE) &amp;&amp; skm.exit(false))</a>
<a name="ln1899">                    return done = true;</a>
<a name="ln1900">            }</a>
<a name="ln1901">        }</a>
<a name="ln1902">        else</a>
<a name="ln1903">        {</a>
<a name="ln1904">            vector&lt;MenuItem*&gt; selection = skm.get_selected_items();</a>
<a name="ln1905">            skm.clear_selections();</a>
<a name="ln1906">            // There should only be one selection, otherwise something broke</a>
<a name="ln1907">            if (selection.size() != 1)</a>
<a name="ln1908">                return true;</a>
<a name="ln1909">            int sel_id = selection.at(0)-&gt;get_id();</a>
<a name="ln1910">            if (sel_id == SKM_HELP)</a>
<a name="ln1911">                skm.help();</a>
<a name="ln1912">            else if (sel_id == SKM_CLEAR_TARGETS)</a>
<a name="ln1913">                skm.clear_targets();</a>
<a name="ln1914">            else if (sel_id == SKM_SET_TARGET)</a>
<a name="ln1915">                skm.set_target_mode();</a>
<a name="ln1916">            else if (sel_id &lt; 0)</a>
<a name="ln1917">            {</a>
<a name="ln1918">                if (sel_id &lt;= SKM_SWITCH_FIRST)</a>
<a name="ln1919">                    skm.toggle((skill_menu_switch)sel_id);</a>
<a name="ln1920">                else</a>
<a name="ln1921">                    dprf(&quot;Unhandled menu switch %d&quot;, sel_id);</a>
<a name="ln1922">            }</a>
<a name="ln1923">            else</a>
<a name="ln1924">            {</a>
<a name="ln1925">                skill_type sk = static_cast&lt;skill_type&gt;(sel_id);</a>
<a name="ln1926">                ASSERT(!is_invalid_skill(sk));</a>
<a name="ln1927">                skm.select(sk, keyn);</a>
<a name="ln1928">                skill_menu_ui-&gt;_expose();</a>
<a name="ln1929">                if (skm.is_set(SKMF_RESKILLING))</a>
<a name="ln1930">                {</a>
<a name="ln1931">                    skm.clear();</a>
<a name="ln1932">                    return done = true;</a>
<a name="ln1933">                }</a>
<a name="ln1934">            }</a>
<a name="ln1935">        }</a>
<a name="ln1936"> </a>
<a name="ln1937">        return true;</a>
<a name="ln1938">    });</a>
<a name="ln1939"> </a>
<a name="ln1940">#ifdef USE_TILE_WEB</a>
<a name="ln1941">    tiles_crt_popup show_as_popup(&quot;skills&quot;);</a>
<a name="ln1942">#endif</a>
<a name="ln1943">    // XXX: this is, in theory, an arbitrary initial height. In practice,</a>
<a name="ln1944">    // there's a bug where an item in the MenuFreeform stays at its original</a>
<a name="ln1945">    // position even after skm.init is called again, crashing when the screen</a>
<a name="ln1946">    // size is actually too small; ideally, the skill menu will get rewritten</a>
<a name="ln1947">    // to use the new ui framework; until then, this fixes the crash.</a>
<a name="ln1948">    skm.init(flag, MIN_LINES);</a>
<a name="ln1949"> </a>
<a name="ln1950">    // Calling a user lua function here to let players automatically accept</a>
<a name="ln1951">    // the given skill distribution for a potion of experience.</a>
<a name="ln1952">    if (skm.is_set(SKMF_EXPERIENCE)</a>
<a name="ln1953">        &amp;&amp; clua.callbooleanfn(false, &quot;auto_experience&quot;, nullptr)</a>
<a name="ln1954">        &amp;&amp; skm.exit(false))</a>
<a name="ln1955">    {</a>
<a name="ln1956">        return;</a>
<a name="ln1957">    }</a>
<a name="ln1958"> </a>
<a name="ln1959">    ui::run_layout(move(popup), done);</a>
<a name="ln1960"> </a>
<a name="ln1961">    skm.clear();</a>
<a name="ln1962">}</a>

</code></pre>
<div class="balloon" rel="309"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v648/" target="_blank">V648</a> Priority of the '&&' operation is higher than that of the '||' operation.</p></div>
<div class="balloon" rel="1191"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v648/" target="_blank">V648</a> Priority of the '&&' operation is higher than that of the '||' operation.</p></div>
<div class="balloon" rel="1895"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v796/" target="_blank">V796</a> It is possible that 'break' statement is missing in switch statement.</p></div>
<div class="balloon" rel="1918"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v547/" target="_blank">V547</a> Expression 'sel_id <= SKM_SWITCH_FIRST' is always true.</p></div>
<div class="balloon" rel="60"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v730/" target="_blank">V730</a> Not all members of a class are initialized inside the constructor. Consider inspecting: m_sk.</p></div>
<div class="balloon" rel="551"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v730/" target="_blank">V730</a> Not all members of a class are initialized inside the constructor. Consider inspecting: m_state.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
