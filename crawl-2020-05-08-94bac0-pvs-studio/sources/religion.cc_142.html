
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=US-ASCII" />
  <title>religion.cc</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">/**</a>
<a name="ln2"> * @file</a>
<a name="ln3"> * @brief Misc religion related functions.</a>
<a name="ln4">**/</a>
<a name="ln5"> </a>
<a name="ln6">#include &quot;AppHdr.h&quot;</a>
<a name="ln7"> </a>
<a name="ln8">#include &quot;religion.h&quot;</a>
<a name="ln9"> </a>
<a name="ln10">#include &lt;algorithm&gt;</a>
<a name="ln11">#include &lt;cmath&gt;</a>
<a name="ln12">#include &lt;cstdio&gt;</a>
<a name="ln13">#include &lt;cstdlib&gt;</a>
<a name="ln14">#include &lt;cstring&gt;</a>
<a name="ln15">#include &lt;functional&gt;</a>
<a name="ln16">#include &lt;sstream&gt;</a>
<a name="ln17"> </a>
<a name="ln18">#include &quot;ability.h&quot;</a>
<a name="ln19">#include &quot;acquire.h&quot;</a>
<a name="ln20">#include &quot;act-iter.h&quot;</a>
<a name="ln21">#include &quot;areas.h&quot;</a>
<a name="ln22">#include &quot;attitude-change.h&quot;</a>
<a name="ln23">#include &quot;branch.h&quot;</a>
<a name="ln24">#include &quot;chardump.h&quot;</a>
<a name="ln25">#include &quot;coordit.h&quot;</a>
<a name="ln26">#include &quot;dactions.h&quot;</a>
<a name="ln27">#include &quot;database.h&quot;</a>
<a name="ln28">#include &quot;decks.h&quot;</a>
<a name="ln29">#include &quot;delay.h&quot;</a>
<a name="ln30">#include &quot;describe-god.h&quot;</a>
<a name="ln31">#include &quot;dgn-event.h&quot;</a>
<a name="ln32">#include &quot;dlua.h&quot;</a>
<a name="ln33">#include &quot;english.h&quot;</a>
<a name="ln34">#include &quot;env.h&quot;</a>
<a name="ln35">#include &quot;god-abil.h&quot;</a>
<a name="ln36">#include &quot;god-companions.h&quot;</a>
<a name="ln37">#include &quot;god-conduct.h&quot;</a>
<a name="ln38">#include &quot;god-item.h&quot;</a>
<a name="ln39">#include &quot;god-passive.h&quot;</a>
<a name="ln40">#include &quot;god-prayer.h&quot;</a>
<a name="ln41">#include &quot;god-wrath.h&quot;</a>
<a name="ln42">#include &quot;hints.h&quot;</a>
<a name="ln43">#include &quot;hiscores.h&quot;</a>
<a name="ln44">#include &quot;invent.h&quot;</a>
<a name="ln45">#include &quot;item-name.h&quot;</a>
<a name="ln46">#include &quot;item-prop.h&quot;</a>
<a name="ln47">#include &quot;item-status-flag-type.h&quot;</a>
<a name="ln48">#include &quot;items.h&quot;</a>
<a name="ln49">#include &quot;level-state-type.h&quot;</a>
<a name="ln50">#include &quot;libutil.h&quot;</a>
<a name="ln51">#include &quot;makeitem.h&quot;</a>
<a name="ln52">#include &quot;message.h&quot;</a>
<a name="ln53">#include &quot;mon-gear.h&quot; // give_shield</a>
<a name="ln54">#include &quot;mon-place.h&quot;</a>
<a name="ln55">#include &quot;mutation.h&quot;</a>
<a name="ln56">#include &quot;nearby-danger.h&quot;</a>
<a name="ln57">#include &quot;notes.h&quot;</a>
<a name="ln58">#include &quot;output.h&quot;</a>
<a name="ln59">#include &quot;player-stats.h&quot;</a>
<a name="ln60">#include &quot;prompt.h&quot;</a>
<a name="ln61">#include &quot;randbook.h&quot;</a>
<a name="ln62">#include &quot;shopping.h&quot;</a>
<a name="ln63">#include &quot;skills.h&quot;</a>
<a name="ln64">#include &quot;spl-book.h&quot;</a>
<a name="ln65">#include &quot;sprint.h&quot;</a>
<a name="ln66">#include &quot;state.h&quot;</a>
<a name="ln67">#include &quot;stringutil.h&quot;</a>
<a name="ln68">#include &quot;terrain.h&quot;</a>
<a name="ln69">#include &quot;transform.h&quot;</a>
<a name="ln70">#include &quot;view.h&quot;</a>
<a name="ln71"> </a>
<a name="ln72">#ifdef DEBUG_RELIGION</a>
<a name="ln73">#    define DEBUG_DIAGNOSTICS</a>
<a name="ln74">#    define DEBUG_GIFTS</a>
<a name="ln75">#    define DEBUG_SACRIFICE</a>
<a name="ln76">#    define DEBUG_PIETY</a>
<a name="ln77">#endif</a>
<a name="ln78"> </a>
<a name="ln79">#define PIETY_HYSTERESIS_LIMIT 1</a>
<a name="ln80"> </a>
<a name="ln81">static weapon_type _hepliaklqana_weapon_type(monster_type mc, int HD);</a>
<a name="ln82">static brand_type _hepliaklqana_weapon_brand(monster_type mc, int HD);</a>
<a name="ln83">static armour_type _hepliaklqana_shield_type(monster_type mc, int HD);</a>
<a name="ln84">static special_armour_type _hepliaklqana_shield_ego(int HD);</a>
<a name="ln85"> </a>
<a name="ln86">const vector&lt;god_power&gt; god_powers[NUM_GODS] =</a>
<a name="ln87">{</a>
<a name="ln88">    // no god</a>
<a name="ln89">    { },</a>
<a name="ln90"> </a>
<a name="ln91">    // Zin</a>
<a name="ln92">    { { 1, ABIL_ZIN_RECITE, &quot;recite Zin's Axioms of Law&quot; },</a>
<a name="ln93">      { 2, ABIL_ZIN_VITALISATION, &quot;call upon Zin for vitalisation&quot; },</a>
<a name="ln94">      { 3, ABIL_ZIN_IMPRISON, &quot;call upon Zin to imprison the lawless&quot; },</a>
<a name="ln95">      { 5, ABIL_ZIN_SANCTUARY, &quot;call upon Zin to create a sanctuary&quot; },</a>
<a name="ln96">      { 6, &quot;Zin will now cleanse your potions of mutation.&quot;,</a>
<a name="ln97">           &quot;Zin will no longer cleanse your potions of mutation.&quot;,</a>
<a name="ln98">           &quot;Zin will cleanse your potions of mutation.&quot; },</a>
<a name="ln99">      {-1, ABIL_ZIN_DONATE_GOLD, &quot;donate money to Zin&quot; },</a>
<a name="ln100">    },</a>
<a name="ln101"> </a>
<a name="ln102">    // TSO</a>
<a name="ln103">    { { 1, &quot;You and your allies can now gain power from killing the unholy and evil.&quot;,</a>
<a name="ln104">           &quot;You and your allies can no longer gain power from killing the unholy and evil.&quot;,</a>
<a name="ln105">           &quot;You and your allies can gain power from killing the unholy and evil.&quot; },</a>
<a name="ln106">      { 2, ABIL_TSO_DIVINE_SHIELD, &quot;call upon the Shining One for a divine shield&quot; },</a>
<a name="ln107">      { 4, ABIL_TSO_CLEANSING_FLAME, &quot;channel blasts of cleansing flame&quot;, },</a>
<a name="ln108">      { 5, ABIL_TSO_SUMMON_DIVINE_WARRIOR, &quot;summon a divine warrior&quot; },</a>
<a name="ln109">      { 7, ABIL_TSO_BLESS_WEAPON,</a>
<a name="ln110">           &quot;The Shining One will bless your weapon with holy wrath... once.&quot;,</a>
<a name="ln111">           &quot;The Shining One is no longer ready to bless your weapon.&quot; },</a>
<a name="ln112">    },</a>
<a name="ln113"> </a>
<a name="ln114">    // Kikubaaqudgha</a>
<a name="ln115">    { { 1, ABIL_KIKU_RECEIVE_CORPSES, &quot;receive cadavers from Kikubaaqudgha&quot; },</a>
<a name="ln116">      { 2, &quot;Kikubaaqudgha is now protecting you from necromantic miscasts and death curses.&quot;,</a>
<a name="ln117">           &quot;Kikubaaqudgha will no longer protect you from necromantic miscasts or death curses.&quot;,</a>
<a name="ln118">           &quot;Kikubaaqudgha protects you from necromantic miscasts and death curses.&quot; },</a>
<a name="ln119">      { 4, &quot;Kikubaaqudgha is now protecting you from unholy torment.&quot;,</a>
<a name="ln120">           &quot;Kikubaaqudgha will no longer protect you from unholy torment.&quot;,</a>
<a name="ln121">           &quot;Kikubaaqudgha protects you from unholy torment.&quot; },</a>
<a name="ln122">      { 5, ABIL_KIKU_TORMENT, &quot;invoke torment by sacrificing a corpse&quot; },</a>
<a name="ln123">      { 7, ABIL_KIKU_BLESS_WEAPON,</a>
<a name="ln124">           &quot;Kikubaaqudgha will grant you a Necronomicon or bloody your weapon with pain... once.&quot;,</a>
<a name="ln125">           &quot;Kikubaaqudgha is no longer ready to enhance your necromancy.&quot; },</a>
<a name="ln126">      { 7, ABIL_KIKU_GIFT_NECRONOMICON,</a>
<a name="ln127">           &quot;Kikubaaqudgha will grant you a Necronomicon.&quot;,</a>
<a name="ln128">           &quot;Kikubaaqudgha is no longer ready to enhance your necromancy.&quot; },</a>
<a name="ln129">    },</a>
<a name="ln130"> </a>
<a name="ln131">    // Yredelemnul</a>
<a name="ln132">    { { 1, ABIL_YRED_ANIMATE_REMAINS, &quot;animate remains&quot; },</a>
<a name="ln133">      { 2, ABIL_YRED_RECALL_UNDEAD_SLAVES, &quot;recall your undead slaves&quot; },</a>
<a name="ln134">      { 2, ABIL_YRED_INJURY_MIRROR, &quot;mirror injuries on your foes&quot; },</a>
<a name="ln135">      { 3, ABIL_YRED_ANIMATE_DEAD, &quot;animate legions of the dead&quot; },</a>
<a name="ln136">      { 3, &quot;Yredelemnul will now gift you servants as you gain piety.&quot;,</a>
<a name="ln137">           &quot;Yredelemnul will no longer gift you servants.&quot;,</a>
<a name="ln138">           &quot;Yredelemnul will gift you servants as you gain piety.&quot; },</a>
<a name="ln139">      { 4, ABIL_YRED_DRAIN_LIFE, &quot;drain ambient life force&quot; },</a>
<a name="ln140">      { 5, ABIL_YRED_ENSLAVE_SOUL, &quot;enslave living souls&quot; },</a>
<a name="ln141">    },</a>
<a name="ln142"> </a>
<a name="ln143">    // Xom</a>
<a name="ln144">    { },</a>
<a name="ln145"> </a>
<a name="ln146">    // Vehumet</a>
<a name="ln147">    { { 1, &quot;gain magical power from killing&quot; },</a>
<a name="ln148">      { 3, &quot;Vehumet is now aiding your destructive spells.&quot;,</a>
<a name="ln149">           &quot;Vehumet will no longer aid your destructive spells.&quot;,</a>
<a name="ln150">           &quot;Vehumet aids your destructive spells.&quot; },</a>
<a name="ln151">      { 4, &quot;Vehumet is now extending the range of your destructive spells.&quot;,</a>
<a name="ln152">           &quot;Vehumet will no longer extend the range of your destructive spells.&quot;,</a>
<a name="ln153">           &quot;Vehumet extends the range of your destructive spells.&quot; },</a>
<a name="ln154">    },</a>
<a name="ln155"> </a>
<a name="ln156">    // Okawaru</a>
<a name="ln157">    { { 1, ABIL_OKAWARU_HEROISM, &quot;gain great but temporary skills&quot; },</a>
<a name="ln158">      { 3, &quot;Okawaru will now gift you ammunition as you gain piety.&quot;,</a>
<a name="ln159">           &quot;Okawaru will no longer gift you ammunition.&quot;,</a>
<a name="ln160">           &quot;Okawaru will gift you ammunition as you gain piety.&quot; },</a>
<a name="ln161">      { 5, ABIL_OKAWARU_FINESSE, &quot;speed up your combat&quot; },</a>
<a name="ln162">      { 5, &quot;Okawaru will now gift you equipment as you gain piety.&quot;,</a>
<a name="ln163">           &quot;Okawaru will no longer gift you equipment.&quot;,</a>
<a name="ln164">           &quot;Okawaru will gift you equipment as you gain piety.&quot; },</a>
<a name="ln165">    },</a>
<a name="ln166"> </a>
<a name="ln167">    // Makhleb</a>
<a name="ln168">    { { 1, &quot;gain health from killing&quot; },</a>
<a name="ln169">      { 2, ABIL_MAKHLEB_MINOR_DESTRUCTION,</a>
<a name="ln170">           &quot;harness Makhleb's destructive might&quot; },</a>
<a name="ln171">      { 3, ABIL_MAKHLEB_LESSER_SERVANT_OF_MAKHLEB,</a>
<a name="ln172">           &quot;summon a lesser servant of Makhleb&quot; },</a>
<a name="ln173">      { 4, ABIL_MAKHLEB_MAJOR_DESTRUCTION,</a>
<a name="ln174">           &quot;hurl Makhleb's greater destruction&quot; },</a>
<a name="ln175">      { 5, ABIL_MAKHLEB_GREATER_SERVANT_OF_MAKHLEB,</a>
<a name="ln176">           &quot;summon a greater servant of Makhleb&quot; },</a>
<a name="ln177">    },</a>
<a name="ln178"> </a>
<a name="ln179">    // Sif Muna</a>
<a name="ln180">    { { 1, ABIL_SIF_MUNA_CHANNEL_ENERGY,</a>
<a name="ln181">           &quot;call upon Sif Muna for magical energy&quot; },</a>
<a name="ln182">      { 3, ABIL_SIF_MUNA_FORGET_SPELL,</a>
<a name="ln183">           &quot;freely open your mind to new spells&quot;,</a>
<a name="ln184">           &quot;forget spells at will&quot; },</a>
<a name="ln185">      { 4, ABIL_SIF_MUNA_DIVINE_EXEGESIS,</a>
<a name="ln186">           &quot;call upon Sif Muna to cast any spell from your library&quot; },</a>
<a name="ln187">      { 5, &quot;Sif Muna will now gift you books as you gain piety.&quot;,</a>
<a name="ln188">           &quot;Sif Muna will no longer gift you books.&quot;,</a>
<a name="ln189">           &quot;Sif Muna will gift you books as you gain piety.&quot; },</a>
<a name="ln190">    },</a>
<a name="ln191"> </a>
<a name="ln192">    // Trog</a>
<a name="ln193">    {</a>
<a name="ln194">      { 1, ABIL_TROG_BERSERK, &quot;go berserk at will&quot; },</a>
<a name="ln195">      { 2, ABIL_TROG_REGEN_MR,</a>
<a name="ln196">           &quot;call upon Trog for regeneration and magic resistance&quot; },</a>
<a name="ln197">      { 4, ABIL_TROG_BROTHERS_IN_ARMS, &quot;call in reinforcements&quot; },</a>
<a name="ln198">      { 5, &quot;Trog will now gift you melee weapons as you gain piety.&quot;,</a>
<a name="ln199">           &quot;Trog will no longer gift you weapons.&quot;,</a>
<a name="ln200">           &quot;Trog will gift you melee weapons as you gain piety.&quot; },</a>
<a name="ln201">    },</a>
<a name="ln202"> </a>
<a name="ln203">    // Nemelex</a>
<a name="ln204">    {</a>
<a name="ln205">      { 0, &quot;draw from decks of power&quot; },</a>
<a name="ln206">      { 3, ABIL_NEMELEX_TRIPLE_DRAW, &quot;choose one out of three cards&quot; },</a>
<a name="ln207">      { 4, ABIL_NEMELEX_DEAL_FOUR, &quot;deal four cards at a time&quot; },</a>
<a name="ln208">      { 5, ABIL_NEMELEX_STACK_FIVE, &quot;stack five cards from your decks&quot;,</a>
<a name="ln209">                                    &quot;stack cards&quot; },</a>
<a name="ln210">    },</a>
<a name="ln211"> </a>
<a name="ln212">    // Elyvilon</a>
<a name="ln213">    { { 1, ABIL_ELYVILON_LESSER_HEALING, &quot;provide lesser healing for yourself&quot; },</a>
<a name="ln214">      { 2, ABIL_ELYVILON_HEAL_OTHER, &quot;heal and attempt to pacify others&quot; },</a>
<a name="ln215">      { 3, ABIL_ELYVILON_PURIFICATION, &quot;purify yourself&quot; },</a>
<a name="ln216">      { 4, ABIL_ELYVILON_GREATER_HEALING, &quot;provide greater healing for yourself&quot; },</a>
<a name="ln217">      { 5, ABIL_ELYVILON_DIVINE_VIGOUR, &quot;call upon Elyvilon for divine vigour&quot; },</a>
<a name="ln218">      { 1, ABIL_ELYVILON_LIFESAVING, &quot;call on Elyvilon to save your life&quot; },</a>
<a name="ln219">    },</a>
<a name="ln220"> </a>
<a name="ln221">    // Lugonu</a>
<a name="ln222">    { { 1, ABIL_LUGONU_ABYSS_EXIT,</a>
<a name="ln223">           &quot;depart the Abyss&quot;,</a>
<a name="ln224">           &quot;depart the Abyss at will&quot; },</a>
<a name="ln225">      { 2, ABIL_LUGONU_BEND_SPACE, &quot;bend space around yourself&quot; },</a>
<a name="ln226">      { 3, ABIL_LUGONU_BANISH, &quot;banish your foes&quot; },</a>
<a name="ln227">      { 4, ABIL_LUGONU_CORRUPT, &quot;corrupt the fabric of space&quot; },</a>
<a name="ln228">      { 5, ABIL_LUGONU_ABYSS_ENTER, &quot;gate yourself to the Abyss&quot; },</a>
<a name="ln229">      { 7, ABIL_LUGONU_BLESS_WEAPON,</a>
<a name="ln230">           &quot;Lugonu will corrupt your weapon with distortion... once.&quot;,</a>
<a name="ln231">           &quot;Lugonu is no longer ready to corrupt your weapon.&quot; },</a>
<a name="ln232">    },</a>
<a name="ln233"> </a>
<a name="ln234">    // Beogh</a>
<a name="ln235">    { { 2, ABIL_BEOGH_SMITING, &quot;smite your foes&quot; },</a>
<a name="ln236">      { 3, &quot;gain orcish followers&quot; },</a>
<a name="ln237">      { 4, ABIL_BEOGH_RECALL_ORCISH_FOLLOWERS, &quot;recall your orcish followers&quot; },</a>
<a name="ln238">      { 5, &quot;walk on water&quot; },</a>
<a name="ln239">      { 5, ABIL_BEOGH_GIFT_ITEM, &quot;give items to your followers&quot; },</a>
<a name="ln240">      { 6, ABIL_BEOGH_RESURRECTION, &quot;revive fallen orcs&quot; },</a>
<a name="ln241">    },</a>
<a name="ln242"> </a>
<a name="ln243">    // Jiyva</a>
<a name="ln244">    { { 1, ABIL_JIYVA_CALL_JELLY, &quot;request a jelly&quot; },</a>
<a name="ln245">      { 3, &quot;Jiyva will now mutate your body and modify your attributes as you gain piety.&quot;,</a>
<a name="ln246">           &quot;Jiyva will no longer mutate your body and modify your attributes.&quot;,</a>
<a name="ln247">           &quot;Jiyva will mutate your body and modify your attributes as you gain piety.&quot; },</a>
<a name="ln248">      { 3, &quot;Jiyva is now protecting you from corrosive effects.&quot;,</a>
<a name="ln249">           &quot;Jiyva will no longer protect you from corrosive effects.&quot;,</a>
<a name="ln250">           &quot;Jiyva protects you from corrosive effects.&quot; },</a>
<a name="ln251">      { 4, ABIL_JIYVA_SLIMIFY, &quot;turn your foes to slime&quot; },</a>
<a name="ln252">      { 5, &quot;You may now expel jellies when seriously injured.&quot;,</a>
<a name="ln253">           &quot;You will no longer expel jellies when injured.&quot;,</a>
<a name="ln254">           &quot;You may expel jellies when seriously injured.&quot; },</a>
<a name="ln255">      { 5, ABIL_JIYVA_CURE_BAD_MUTATION,</a>
<a name="ln256">           &quot;call upon Jiyva to remove your harmful mutations&quot; },</a>
<a name="ln257">    },</a>
<a name="ln258"> </a>
<a name="ln259">    // Fedhas</a>
<a name="ln260">    {</a>
<a name="ln261">      { 2, ABIL_FEDHAS_WALL_OF_BRIARS, &quot;encircle yourself with summoned briar patches&quot;},</a>
<a name="ln262">      { 3, ABIL_FEDHAS_GROW_BALLISTOMYCETE, &quot;grow a ballistomycete&quot; },</a>
<a name="ln263">      { 4, ABIL_FEDHAS_OVERGROW, &quot;transform dungeon walls and trees into plant allies&quot;},</a>
<a name="ln264">      { 5, ABIL_FEDHAS_GROW_OKLOB, &quot;grow an oklob plant&quot; },</a>
<a name="ln265">    },</a>
<a name="ln266"> </a>
<a name="ln267">    // Cheibriados</a>
<a name="ln268">    { { 0, ABIL_CHEIBRIADOS_TIME_BEND, &quot;bend time to slow others&quot; },</a>
<a name="ln269">      { 1, &quot;Cheibriados is now slowing and strengthening your metabolism.&quot;,</a>
<a name="ln270">           &quot;Cheibriados will no longer slow and strengthen your metabolism.&quot;,</a>
<a name="ln271">           &quot;Cheibriados slows and strengthens your metabolism.&quot; },</a>
<a name="ln272">      { 3, ABIL_CHEIBRIADOS_DISTORTION, &quot;warp the flow of time around you&quot; },</a>
<a name="ln273">      { 4, ABIL_CHEIBRIADOS_SLOUCH, &quot;inflict damage on those overly hasty&quot; },</a>
<a name="ln274">      { 5, ABIL_CHEIBRIADOS_TIME_STEP, &quot;step out of the flow of time&quot; },</a>
<a name="ln275">    },</a>
<a name="ln276"> </a>
<a name="ln277">    // Ashenzari</a>
<a name="ln278">    { { 0, ABIL_ASHENZARI_CURSE, &quot;curse your items&quot; },</a>
<a name="ln279">      { 1, ABIL_ASHENZARI_SCRYING, &quot;scry through walls&quot; },</a>
<a name="ln280">      { 2, &quot;The more cursed you are, the more Ashenzari will now support your skills.&quot;,</a>
<a name="ln281">           &quot;Ashenzari will no longer support your skills.&quot;,</a>
<a name="ln282">           &quot;The more cursed you are, the more Ashenzari supports your skills.&quot; },</a>
<a name="ln283">      { 3, &quot;Ashenzari will now reveal the unseen.&quot;,</a>
<a name="ln284">           &quot;Ashenzari will no longer reveal the unseen.&quot;,</a>
<a name="ln285">           &quot;Ashenzari reveals the unseen.&quot; },</a>
<a name="ln286">      { 4, &quot;Ashenzari will now keep your mind clear.&quot;,</a>
<a name="ln287">           &quot;Ashenzari will no longer keep your mind clear.&quot;,</a>
<a name="ln288">           &quot;Ashenzari keeps your mind clear.&quot; },</a>
<a name="ln289">      { 5, ABIL_ASHENZARI_TRANSFER_KNOWLEDGE,</a>
<a name="ln290">           &quot;Ashenzari will help you to reconsider your skills.&quot;,</a>
<a name="ln291">           &quot;Ashenzari will no longer help you to reconsider your skills.&quot; },</a>
<a name="ln292">    },</a>
<a name="ln293"> </a>
<a name="ln294">    // Dithmenos</a>
<a name="ln295">    { { 2, ABIL_DITHMENOS_SHADOW_STEP,</a>
<a name="ln296">           &quot;step into the shadows of nearby creatures&quot; },</a>
<a name="ln297">      { 3, &quot;You will now sometimes bleed smoke when heavily injured by enemies.&quot;,</a>
<a name="ln298">           &quot;You will no longer bleed smoke.&quot;,</a>
<a name="ln299">           &quot;You sometimes bleed smoke when heavily injured by enemies.&quot; },</a>
<a name="ln300">      { 4, &quot;Your shadow now sometimes tangibly mimics your actions.&quot;,</a>
<a name="ln301">           &quot;Your shadow no longer tangibly mimics your actions.&quot;,</a>
<a name="ln302">           &quot;Your shadow sometimes tangibly mimics your actions.&quot; },</a>
<a name="ln303">      { 5, ABIL_DITHMENOS_SHADOW_FORM,</a>
<a name="ln304">           &quot;transform into a swirling mass of shadows&quot; },</a>
<a name="ln305">    },</a>
<a name="ln306"> </a>
<a name="ln307">    // Gozag</a>
<a name="ln308">    { { 0, ABIL_GOZAG_POTION_PETITION, &quot;petition Gozag for potion effects&quot; },</a>
<a name="ln309">      { 0, ABIL_GOZAG_CALL_MERCHANT,</a>
<a name="ln310">           &quot;fund merchants seeking to open stores in the dungeon&quot; },</a>
<a name="ln311">      { 0, ABIL_GOZAG_BRIBE_BRANCH,</a>
<a name="ln312">           &quot;bribe branches to halt enemies' attacks and recruit allies&quot; },</a>
<a name="ln313">    },</a>
<a name="ln314"> </a>
<a name="ln315">    // Qazlal</a>
<a name="ln316">    {</a>
<a name="ln317">      { 0, &quot;Qazlal grants you and your divine allies immunity to clouds.&quot; },</a>
<a name="ln318">      { 1, &quot;You are now surrounded by a storm.&quot;,</a>
<a name="ln319">           &quot;Your storm dissipates completely.&quot;,</a>
<a name="ln320">           &quot;You are surrounded by a storm.&quot; },</a>
<a name="ln321">      { 2, ABIL_QAZLAL_UPHEAVAL, &quot;call upon nature to destroy your foes&quot; },</a>
<a name="ln322">      { 3, ABIL_QAZLAL_ELEMENTAL_FORCE, &quot;give life to nearby clouds&quot; },</a>
<a name="ln323">      { 4, &quot;The storm surrounding you is now powerful enough to repel missiles.&quot;,</a>
<a name="ln324">           &quot;The storm surrounding you is now too weak to repel missiles.&quot;,</a>
<a name="ln325">           &quot;The storm surrounding you is powerful enough to repel missiles.&quot; },</a>
<a name="ln326">      { 4, &quot;You will now adapt resistances upon receiving elemental damage.&quot;,</a>
<a name="ln327">           &quot;You will no longer adapt resistances upon receiving elemental damage.&quot;,</a>
<a name="ln328">           &quot;You adapt resistances upon receiving elemental damage.&quot; },</a>
<a name="ln329">      { 5, ABIL_QAZLAL_DISASTER_AREA,</a>
<a name="ln330">           &quot;call upon nature's wrath in a wide area around you&quot; },</a>
<a name="ln331">    },</a>
<a name="ln332"> </a>
<a name="ln333">    // Ru</a>
<a name="ln334">    { { 1, &quot;You now exude an aura of power that intimidates your foes.&quot;,</a>
<a name="ln335">           &quot;You no longer exude an aura of power that intimidates your foes.&quot;,</a>
<a name="ln336">           &quot;You now exude an aura of power that intimidates your foes.&quot; },</a>
<a name="ln337">      { 2, &quot;Your aura of power can now strike those that harm you.&quot;,</a>
<a name="ln338">           &quot;Your aura of power no longer strikes those that harm you.&quot;,</a>
<a name="ln339">           &quot;Your aura of power can strike those that harm you.&quot; },</a>
<a name="ln340">      { 3, ABIL_RU_DRAW_OUT_POWER, &quot;heal your body and restore your magic&quot; },</a>
<a name="ln341">      { 4, ABIL_RU_POWER_LEAP, &quot;gather your power into a mighty leap&quot; },</a>
<a name="ln342">      { 5, ABIL_RU_APOCALYPSE, &quot;wreak a terrible wrath on your foes&quot; },</a>
<a name="ln343">    },</a>
<a name="ln344"> </a>
<a name="ln345">#if TAG_MAJOR_VERSION == 34</a>
<a name="ln346">    // Pakellas</a>
<a name="ln347">    {</a>
<a name="ln348">      { 0, &quot;gain magical power from killing&quot; },</a>
<a name="ln349">      { 3, ABIL_PAKELLAS_DEVICE_SURGE,</a>
<a name="ln350">           &quot;spend magic to empower your devices&quot; },</a>
<a name="ln351">    },</a>
<a name="ln352">#endif</a>
<a name="ln353"> </a>
<a name="ln354">    // Uskayaw</a>
<a name="ln355">    {</a>
<a name="ln356">      { 1, ABIL_USKAYAW_STOMP, &quot;stomp with the beat&quot; },</a>
<a name="ln357">      { 2, ABIL_USKAYAW_LINE_PASS, &quot;pass through a line of other dancers&quot; },</a>
<a name="ln358">      { 3, &quot;Uskayaw will force your foes to helplessly watch your dance.&quot;,</a>
<a name="ln359">           &quot;Uskayaw will no longer force your foes to helplessly watch your dance.&quot;},</a>
<a name="ln360">      { 4, &quot;Uskayaw will force your foes to share their pain.&quot;,</a>
<a name="ln361">           &quot;Uskayaw will no longer force your foes to share their pain.&quot;},</a>
<a name="ln362">      { 5, ABIL_USKAYAW_GRAND_FINALE, &quot;merge with and destroy a victim&quot; },</a>
<a name="ln363">    },</a>
<a name="ln364"> </a>
<a name="ln365">    // Hepliaklqana</a>
<a name="ln366">    { { 0, ABIL_HEPLIAKLQANA_RECALL, &quot;recall your ancestor&quot; },</a>
<a name="ln367">      { 0, ABIL_HEPLIAKLQANA_IDENTITY, &quot;remember your ancestor's identity&quot; },</a>
<a name="ln368">      { 3, ABIL_HEPLIAKLQANA_TRANSFERENCE, &quot;swap creatures with your ancestor&quot; },</a>
<a name="ln369">      { 4, ABIL_HEPLIAKLQANA_IDEALISE, &quot;heal and protect your ancestor&quot; },</a>
<a name="ln370">      { 5, &quot;drain nearby creatures when transferring your ancestor&quot;},</a>
<a name="ln371">    },</a>
<a name="ln372"> </a>
<a name="ln373">    // Wu Jian</a>
<a name="ln374">    { { 0, &quot;perform damaging attacks by moving towards foes&quot;,</a>
<a name="ln375">           &quot;perform lunging strikes&quot; },</a>
<a name="ln376">      { 1, &quot;lightly attack monsters by moving around them&quot;,</a>
<a name="ln377">           &quot;perform spinning attacks&quot; },</a>
<a name="ln378">      { 2, ABIL_WU_JIAN_WALLJUMP,</a>
<a name="ln379">           &quot;perform airborne attacks&quot; },</a>
<a name="ln380">      { 3, ABIL_WU_JIAN_SERPENTS_LASH, &quot;briefly move at supernatural speeds&quot;,</a>
<a name="ln381">           &quot;move at supernatural speeds&quot; },</a>
<a name="ln382">      { 5, ABIL_WU_JIAN_HEAVENLY_STORM,</a>
<a name="ln383">           &quot;summon a storm of heavenly clouds to empower your attacks&quot;,</a>
<a name="ln384">           &quot;summon a storm of heavenly clouds&quot; },</a>
<a name="ln385">    },</a>
<a name="ln386">};</a>
<a name="ln387"> </a>
<a name="ln388">vector&lt;god_power&gt; get_god_powers(god_type god)</a>
<a name="ln389">{</a>
<a name="ln390">    vector&lt;god_power&gt; ret;</a>
<a name="ln391">    for (const auto&amp; power : god_powers[god])</a>
<a name="ln392">    {</a>
<a name="ln393">        if (!(power.abil != ABIL_NON_ABILITY</a>
<a name="ln394">              &amp;&amp; fixup_ability(power.abil) == ABIL_NON_ABILITY))</a>
<a name="ln395">        {</a>
<a name="ln396">            ret.push_back(power);</a>
<a name="ln397">        }</a>
<a name="ln398">    }</a>
<a name="ln399">    return ret;</a>
<a name="ln400">}</a>
<a name="ln401"> </a>
<a name="ln402">/**</a>
<a name="ln403"> * Print a description of getting/losing this power.</a>
<a name="ln404"> *</a>
<a name="ln405"> * @param gaining If true, use this-&gt;gain; otherwise, use this-&gt;loss.</a>
<a name="ln406"> * @param fmt  A string containing &quot;%s&quot; that will be used as a format</a>
<a name="ln407"> *             string with our string as parameter; it is not used if</a>
<a name="ln408"> *             our string begins with a capital letter. IF THIS DOES</a>
<a name="ln409"> *             NOT CONTAIN &quot;%s&quot;, OR CONTAINS OTHER FORMAT SPECIFIERS,</a>
<a name="ln410"> *             BEHAVIOUR IS UNDEFINED.</a>
<a name="ln411"> * @return a string suitable for being read by the user.</a>
<a name="ln412"> */</a>
<a name="ln413">void god_power::display(bool gaining, const char* fmt) const</a>
<a name="ln414">{</a>
<a name="ln415">    // hack: don't mention the necronomicon alone unless it wasn't</a>
<a name="ln416">    // already mentioned by the other message</a>
<a name="ln417">    if (abil == ABIL_KIKU_GIFT_NECRONOMICON</a>
<a name="ln418">        &amp;&amp; you.species != SP_FELID)</a>
<a name="ln419">    {</a>
<a name="ln420">        return;</a>
<a name="ln421">    }</a>
<a name="ln422">    const char* str = gaining ? gain : loss;</a>
<a name="ln423">    if (isupper(str[0]))</a>
<a name="ln424">        god_speaks(you.religion, str);</a>
<a name="ln425">    else</a>
<a name="ln426">        god_speaks(you.religion, make_stringf(fmt, str).c_str());</a>
<a name="ln427">}</a>
<a name="ln428"> </a>
<a name="ln429">static void _place_delayed_monsters();</a>
<a name="ln430"> </a>
<a name="ln431">bool is_evil_god(god_type god)</a>
<a name="ln432">{</a>
<a name="ln433">    return god == GOD_KIKUBAAQUDGHA</a>
<a name="ln434">           || god == GOD_MAKHLEB</a>
<a name="ln435">           || god == GOD_YREDELEMNUL</a>
<a name="ln436">           || god == GOD_BEOGH</a>
<a name="ln437">           || god == GOD_LUGONU</a>
<a name="ln438">           || god == GOD_DITHMENOS;</a>
<a name="ln439">}</a>
<a name="ln440"> </a>
<a name="ln441">bool is_good_god(god_type god)</a>
<a name="ln442">{</a>
<a name="ln443">    return god == GOD_ZIN</a>
<a name="ln444">           || god == GOD_SHINING_ONE</a>
<a name="ln445">           || god == GOD_ELYVILON;</a>
<a name="ln446">}</a>
<a name="ln447"> </a>
<a name="ln448">bool is_chaotic_god(god_type god)</a>
<a name="ln449">{</a>
<a name="ln450">    return god == GOD_XOM</a>
<a name="ln451">           || god == GOD_MAKHLEB</a>
<a name="ln452">           || god == GOD_LUGONU</a>
<a name="ln453">           || god == GOD_JIYVA;</a>
<a name="ln454">}</a>
<a name="ln455"> </a>
<a name="ln456">bool is_unknown_god(god_type god)</a>
<a name="ln457">{</a>
<a name="ln458">    return god == GOD_NAMELESS;</a>
<a name="ln459">}</a>
<a name="ln460"> </a>
<a name="ln461">// Not appearing in new games, but still extant.</a>
<a name="ln462">static bool _is_disabled_god(god_type god)</a>
<a name="ln463">{</a>
<a name="ln464">    switch (god)</a>
<a name="ln465">    {</a>
<a name="ln466">#if TAG_MAJOR_VERSION == 34</a>
<a name="ln467">    // Disabled, pending a rework.</a>
<a name="ln468">    case GOD_PAKELLAS:</a>
<a name="ln469">        return true;</a>
<a name="ln470">#endif</a>
<a name="ln471"> </a>
<a name="ln472">    default:</a>
<a name="ln473">        return false;</a>
<a name="ln474">    }</a>
<a name="ln475">}</a>
<a name="ln476"> </a>
<a name="ln477">bool is_unavailable_god(god_type god)</a>
<a name="ln478">{</a>
<a name="ln479">    if (_is_disabled_god(god))</a>
<a name="ln480">        return true;</a>
<a name="ln481"> </a>
<a name="ln482">    if (god == GOD_JIYVA &amp;&amp; jiyva_is_dead())</a>
<a name="ln483">        return true;</a>
<a name="ln484"> </a>
<a name="ln485">    return false;</a>
<a name="ln486">}</a>
<a name="ln487"> </a>
<a name="ln488">bool god_has_name(god_type god)</a>
<a name="ln489">{</a>
<a name="ln490">    return god != GOD_NO_GOD &amp;&amp; god != GOD_NAMELESS;</a>
<a name="ln491">}</a>
<a name="ln492"> </a>
<a name="ln493">god_type random_god()</a>
<a name="ln494">{</a>
<a name="ln495">    god_type god;</a>
<a name="ln496"> </a>
<a name="ln497">    do</a>
<a name="ln498">    {</a>
<a name="ln499">        god = static_cast&lt;god_type&gt;(random2(NUM_GODS - 1) + 1);</a>
<a name="ln500">    }</a>
<a name="ln501">    while (is_unavailable_god(god));</a>
<a name="ln502"> </a>
<a name="ln503">    return god;</a>
<a name="ln504">}</a>
<a name="ln505"> </a>
<a name="ln506"> </a>
<a name="ln507">god_iterator::god_iterator() :</a>
<a name="ln508">    i(0) { } // might be ok to start with GOD_ZIN instead?</a>
<a name="ln509"> </a>
<a name="ln510">god_iterator::operator bool() const</a>
<a name="ln511">{</a>
<a name="ln512">    return i &lt; NUM_GODS;</a>
<a name="ln513">}</a>
<a name="ln514"> </a>
<a name="ln515">god_type god_iterator::operator*() const</a>
<a name="ln516">{</a>
<a name="ln517">    if (i &lt; NUM_GODS)</a>
<a name="ln518">        return (god_type)i;</a>
<a name="ln519">    else</a>
<a name="ln520">        return GOD_NO_GOD;</a>
<a name="ln521">}</a>
<a name="ln522"> </a>
<a name="ln523">god_type god_iterator::operator-&gt;() const</a>
<a name="ln524">{</a>
<a name="ln525">    return **this;</a>
<a name="ln526">}</a>
<a name="ln527"> </a>
<a name="ln528">god_iterator&amp; god_iterator::operator++()</a>
<a name="ln529">{</a>
<a name="ln530">    ++i;</a>
<a name="ln531">    return *this;</a>
<a name="ln532">}</a>
<a name="ln533"> </a>
<a name="ln534">god_iterator god_iterator::operator++(int)</a>
<a name="ln535">{</a>
<a name="ln536">    god_iterator copy = *this;</a>
<a name="ln537">    ++(*this);</a>
<a name="ln538">    return copy;</a>
<a name="ln539">}</a>
<a name="ln540"> </a>
<a name="ln541"> </a>
<a name="ln542">bool active_penance(god_type god)</a>
<a name="ln543">{</a>
<a name="ln544">    // Good gods only have active wrath when they hate your current god.</a>
<a name="ln545">    return player_under_penance(god)</a>
<a name="ln546">           &amp;&amp; !is_unavailable_god(god)</a>
<a name="ln547">           &amp;&amp; god != GOD_ASHENZARI</a>
<a name="ln548">           &amp;&amp; god != GOD_GOZAG</a>
<a name="ln549">           &amp;&amp; god != GOD_RU</a>
<a name="ln550">           &amp;&amp; god != GOD_HEPLIAKLQANA</a>
<a name="ln551">#if TAG_MAJOR_VERSION == 34</a>
<a name="ln552">           &amp;&amp; god != GOD_PAKELLAS</a>
<a name="ln553">#endif</a>
<a name="ln554">           &amp;&amp; god != GOD_ELYVILON</a>
<a name="ln555">           &amp;&amp; (god == you.religion &amp;&amp; !is_good_god(god)</a>
<a name="ln556">               || god_hates_your_god(god, you.religion));</a>
<a name="ln557">}</a>
<a name="ln558"> </a>
<a name="ln559">// True for gods whose wrath is passive and expires with XP gain.</a>
<a name="ln560">bool xp_penance(god_type god)</a>
<a name="ln561">{</a>
<a name="ln562">    return player_under_penance(god)</a>
<a name="ln563">           &amp;&amp; !is_unavailable_god(god)</a>
<a name="ln564">           &amp;&amp; (god == GOD_ASHENZARI</a>
<a name="ln565">               || god == GOD_GOZAG</a>
<a name="ln566">               || god == GOD_HEPLIAKLQANA</a>
<a name="ln567">#if TAG_MAJOR_VERSION == 34</a>
<a name="ln568">               || god == GOD_PAKELLAS</a>
<a name="ln569">#endif</a>
<a name="ln570">               || god == GOD_ELYVILON)</a>
<a name="ln571">           &amp;&amp; god_hates_your_god(god, you.religion);</a>
<a name="ln572">}</a>
<a name="ln573"> </a>
<a name="ln574">void dec_penance(god_type god, int val)</a>
<a name="ln575">{</a>
<a name="ln576">    if (val &lt;= 0 || you.penance[god] &lt;= 0)</a>
<a name="ln577">        return;</a>
<a name="ln578"> </a>
<a name="ln579">#ifdef DEBUG_PIETY</a>
<a name="ln580">    mprf(MSGCH_DIAGNOSTICS, &quot;Decreasing penance by %d&quot;, val);</a>
<a name="ln581">#endif</a>
<a name="ln582">    if (you.penance[god] &lt;= val)</a>
<a name="ln583">    {</a>
<a name="ln584">        const bool had_halo = have_passive(passive_t::halo);</a>
<a name="ln585">        const bool had_umbra = have_passive(passive_t::umbra);</a>
<a name="ln586"> </a>
<a name="ln587">        you.penance[god] = 0;</a>
<a name="ln588"> </a>
<a name="ln589">        mark_milestone(&quot;god.mollify&quot;,</a>
<a name="ln590">                       &quot;mollified &quot; + god_name(god) + &quot;.&quot;);</a>
<a name="ln591"> </a>
<a name="ln592">        const bool dead_jiyva = (god == GOD_JIYVA &amp;&amp; jiyva_is_dead());</a>
<a name="ln593"> </a>
<a name="ln594">        simple_god_message(</a>
<a name="ln595">            make_stringf(&quot; seems mollified%s.&quot;,</a>
<a name="ln596">                         dead_jiyva ? &quot;, and vanishes&quot; : &quot;&quot;).c_str(),</a>
<a name="ln597">            god);</a>
<a name="ln598"> </a>
<a name="ln599">        if (dead_jiyva)</a>
<a name="ln600">            add_daction(DACT_REMOVE_JIYVA_ALTARS);</a>
<a name="ln601"> </a>
<a name="ln602">        take_note(Note(NOTE_MOLLIFY_GOD, god));</a>
<a name="ln603"> </a>
<a name="ln604">        if (you_worship(god))</a>
<a name="ln605">        {</a>
<a name="ln606">            // Redraw piety display and, in case the best skill is Invocations,</a>
<a name="ln607">            // redraw the god title.</a>
<a name="ln608">            you.redraw_title = true;</a>
<a name="ln609"> </a>
<a name="ln610">            // TSO's halo is once more available.</a>
<a name="ln611">            if (!had_halo &amp;&amp; have_passive(passive_t::halo))</a>
<a name="ln612">            {</a>
<a name="ln613">                mprf(MSGCH_GOD, &quot;Your divine halo returns!&quot;);</a>
<a name="ln614">                invalidate_agrid(true);</a>
<a name="ln615">            }</a>
<a name="ln616">            if (!had_umbra &amp;&amp; have_passive(passive_t::umbra))</a>
<a name="ln617">            {</a>
<a name="ln618">                mprf(MSGCH_GOD, &quot;Your aura of darkness returns!&quot;);</a>
<a name="ln619">                invalidate_agrid(true);</a>
<a name="ln620">            }</a>
<a name="ln621">            if (have_passive(passive_t::sinv))</a>
<a name="ln622">            {</a>
<a name="ln623">                mprf(MSGCH_GOD, &quot;Your vision regains its divine sight.&quot;);</a>
<a name="ln624">                autotoggle_autopickup(false);</a>
<a name="ln625">            }</a>
<a name="ln626">            if (have_passive(passive_t::stat_boost))</a>
<a name="ln627">            {</a>
<a name="ln628">                simple_god_message(&quot; restores the support of your attributes.&quot;);</a>
<a name="ln629">                redraw_screen();</a>
<a name="ln630">                notify_stat_change();</a>
<a name="ln631">            }</a>
<a name="ln632">            if (have_passive(passive_t::storm_shield))</a>
<a name="ln633">            {</a>
<a name="ln634">                mprf(MSGCH_GOD, &quot;A storm instantly forms around you!&quot;);</a>
<a name="ln635">                you.redraw_armour_class = true; // also handles shields</a>
<a name="ln636">            }</a>
<a name="ln637">            // When you've worked through all your penance, you get</a>
<a name="ln638">            // another chance to make hostile slimes strict neutral.</a>
<a name="ln639"> </a>
<a name="ln640">            if (have_passive(passive_t::neutral_slimes))</a>
<a name="ln641">                add_daction(DACT_SLIME_NEW_ATTEMPT);</a>
<a name="ln642"> </a>
<a name="ln643">            if (have_passive(passive_t::friendly_plants)</a>
<a name="ln644">                &amp;&amp; env.forest_awoken_until)</a>
<a name="ln645">            {</a>
<a name="ln646">                // XXX: add a dact here &amp; on-join to handle offlevel</a>
<a name="ln647">                // awakened forests?</a>
<a name="ln648">                for (monster_iterator mi; mi; ++mi)</a>
<a name="ln649">                     mi-&gt;del_ench(ENCH_AWAKEN_FOREST);</a>
<a name="ln650">            }</a>
<a name="ln651">        }</a>
<a name="ln652">        else</a>
<a name="ln653">        {</a>
<a name="ln654">#if TAG_MAJOR_VERSION == 34</a>
<a name="ln655">            if (god == GOD_PAKELLAS)</a>
<a name="ln656">            {</a>
<a name="ln657">                // Penance just ended w/o worshipping Pakellas;</a>
<a name="ln658">                // notify the player that MP regeneration will start again.</a>
<a name="ln659">                mprf(MSGCH_GOD, god, &quot;You begin regenerating magic.&quot;);</a>
<a name="ln660">            }</a>
<a name="ln661">            else</a>
<a name="ln662">#endif</a>
<a name="ln663">            if (god == GOD_HEPLIAKLQANA)</a>
<a name="ln664">            {</a>
<a name="ln665">                calc_hp(); // frailty ends</a>
<a name="ln666">                mprf(MSGCH_GOD, god, &quot;Your full life essence returns.&quot;);</a>
<a name="ln667">            }</a>
<a name="ln668">        }</a>
<a name="ln669">    }</a>
<a name="ln670">    else</a>
<a name="ln671">    {</a>
<a name="ln672">        you.penance[god] -= val;</a>
<a name="ln673">        return;</a>
<a name="ln674">    }</a>
<a name="ln675"> </a>
<a name="ln676">    // We only get this far if we just mollified a god.</a>
<a name="ln677">    // If we just mollified a god, see if we have any angry gods left.</a>
<a name="ln678">    // If we don't, clear the stored wrath / XP counter.</a>
<a name="ln679">    god_iterator it;</a>
<a name="ln680">    for (; it; ++it)</a>
<a name="ln681">    {</a>
<a name="ln682">        if (active_penance(*it))</a>
<a name="ln683">            break;</a>
<a name="ln684">    }</a>
<a name="ln685"> </a>
<a name="ln686">    if (it)</a>
<a name="ln687">        return;</a>
<a name="ln688"> </a>
<a name="ln689">    you.attribute[ATTR_GOD_WRATH_COUNT] = 0;</a>
<a name="ln690">    you.attribute[ATTR_GOD_WRATH_XP] = 0;</a>
<a name="ln691">}</a>
<a name="ln692"> </a>
<a name="ln693">void dec_penance(int val)</a>
<a name="ln694">{</a>
<a name="ln695">    dec_penance(you.religion, val);</a>
<a name="ln696">}</a>
<a name="ln697"> </a>
<a name="ln698">// TODO: find out what this is duplicating &amp; deduplicate it</a>
<a name="ln699">static bool _need_water_walking()</a>
<a name="ln700">{</a>
<a name="ln701">    return you.ground_level() &amp;&amp; you.species != SP_MERFOLK</a>
<a name="ln702">           &amp;&amp; grd(you.pos()) == DNGN_DEEP_WATER;</a>
<a name="ln703">}</a>
<a name="ln704"> </a>
<a name="ln705">static void _grant_temporary_waterwalk()</a>
<a name="ln706">{</a>
<a name="ln707">    mprf(&quot;Your water-walking will last only until you reach solid ground.&quot;);</a>
<a name="ln708">    you.props[TEMP_WATERWALK_KEY] = true;</a>
<a name="ln709">}</a>
<a name="ln710"> </a>
<a name="ln711">bool jiyva_is_dead()</a>
<a name="ln712">{</a>
<a name="ln713">    return you.royal_jelly_dead</a>
<a name="ln714">           &amp;&amp; !you_worship(GOD_JIYVA) &amp;&amp; !you.penance[GOD_JIYVA];</a>
<a name="ln715">}</a>
<a name="ln716"> </a>
<a name="ln717">void set_penance_xp_timeout()</a>
<a name="ln718">{</a>
<a name="ln719">    if (you.attribute[ATTR_GOD_WRATH_XP] &gt; 0)</a>
<a name="ln720">        return;</a>
<a name="ln721"> </a>
<a name="ln722">    // TODO: make this more random?</a>
<a name="ln723">    you.attribute[ATTR_GOD_WRATH_XP] +=</a>
<a name="ln724">        max(div_rand_round(exp_needed(you.experience_level + 1)</a>
<a name="ln725">                          - exp_needed(you.experience_level),</a>
<a name="ln726">                          200),</a>
<a name="ln727">            1);</a>
<a name="ln728">}</a>
<a name="ln729"> </a>
<a name="ln730">static void _inc_penance(god_type god, int val)</a>
<a name="ln731">{</a>
<a name="ln732">    if (val &lt;= 0)</a>
<a name="ln733">        return;</a>
<a name="ln734"> </a>
<a name="ln735">    if (!player_under_penance(god))</a>
<a name="ln736">    {</a>
<a name="ln737">        god_acting gdact(god, true);</a>
<a name="ln738"> </a>
<a name="ln739">        take_note(Note(NOTE_PENANCE, god));</a>
<a name="ln740"> </a>
<a name="ln741">        const bool had_halo = have_passive(passive_t::halo);</a>
<a name="ln742">        const bool had_umbra = have_passive(passive_t::umbra);</a>
<a name="ln743"> </a>
<a name="ln744">        you.penance[god] += val;</a>
<a name="ln745">        you.penance[god] = min((uint8_t)MAX_PENANCE, you.penance[god]);</a>
<a name="ln746"> </a>
<a name="ln747">        if (had_halo &amp;&amp; !have_passive(passive_t::halo))</a>
<a name="ln748">        {</a>
<a name="ln749">            mprf(MSGCH_GOD, god, &quot;Your divine halo fades away.&quot;);</a>
<a name="ln750">            invalidate_agrid();</a>
<a name="ln751">        }</a>
<a name="ln752">        if (had_umbra &amp;&amp; !have_passive(passive_t::umbra))</a>
<a name="ln753">        {</a>
<a name="ln754">            mprf(MSGCH_GOD, god, &quot;Your aura of darkness fades away.&quot;);</a>
<a name="ln755">            invalidate_agrid();</a>
<a name="ln756">        }</a>
<a name="ln757"> </a>
<a name="ln758">        if (will_have_passive(passive_t::water_walk)</a>
<a name="ln759">            &amp;&amp; _need_water_walking() &amp;&amp; !have_passive(passive_t::water_walk))</a>
<a name="ln760">        {</a>
<a name="ln761">            _grant_temporary_waterwalk();</a>
<a name="ln762">        }</a>
<a name="ln763"> </a>
<a name="ln764">        if (will_have_passive(passive_t::stat_boost))</a>
<a name="ln765">        {</a>
<a name="ln766">            redraw_screen();</a>
<a name="ln767">            notify_stat_change();</a>
<a name="ln768">        }</a>
<a name="ln769"> </a>
<a name="ln770">        if (god == GOD_TROG)</a>
<a name="ln771">        {</a>
<a name="ln772">            if (you.duration[DUR_TROGS_HAND])</a>
<a name="ln773">                trog_remove_trogs_hand();</a>
<a name="ln774"> </a>
<a name="ln775">            make_god_gifts_disappear();</a>
<a name="ln776">        }</a>
<a name="ln777">        else if (god == GOD_ZIN)</a>
<a name="ln778">        {</a>
<a name="ln779">            if (you.duration[DUR_DIVINE_STAMINA])</a>
<a name="ln780">                zin_remove_divine_stamina();</a>
<a name="ln781">            if (env.sanctuary_time)</a>
<a name="ln782">                remove_sanctuary();</a>
<a name="ln783">        }</a>
<a name="ln784">        else if (god == GOD_SHINING_ONE)</a>
<a name="ln785">        {</a>
<a name="ln786">            if (you.duration[DUR_DIVINE_SHIELD])</a>
<a name="ln787">                tso_remove_divine_shield();</a>
<a name="ln788"> </a>
<a name="ln789">            make_god_gifts_disappear();</a>
<a name="ln790">        }</a>
<a name="ln791">        else if (god == GOD_ELYVILON)</a>
<a name="ln792">        {</a>
<a name="ln793">            if (you.duration[DUR_DIVINE_VIGOUR])</a>
<a name="ln794">                elyvilon_remove_divine_vigour();</a>
<a name="ln795">        }</a>
<a name="ln796">        else if (god == GOD_JIYVA)</a>
<a name="ln797">        {</a>
<a name="ln798">            if (you.duration[DUR_SLIMIFY])</a>
<a name="ln799">                you.duration[DUR_SLIMIFY] = 0;</a>
<a name="ln800">        }</a>
<a name="ln801">        else if (god == GOD_QAZLAL)</a>
<a name="ln802">        {</a>
<a name="ln803">            // Can't use have_passive(passive_t::storm_shield) because we</a>
<a name="ln804">            // just gained penance.</a>
<a name="ln805">            if (you.piety &gt;= piety_breakpoint(0))</a>
<a name="ln806">            {</a>
<a name="ln807">                mprf(MSGCH_GOD, god, &quot;The storm surrounding you dissipates.&quot;);</a>
<a name="ln808">                you.redraw_armour_class = true;</a>
<a name="ln809">            }</a>
<a name="ln810">            if (you.duration[DUR_QAZLAL_FIRE_RES])</a>
<a name="ln811">            {</a>
<a name="ln812">                mprf(MSGCH_DURATION, &quot;Your resistance to fire fades away.&quot;);</a>
<a name="ln813">                you.duration[DUR_QAZLAL_FIRE_RES] = 0;</a>
<a name="ln814">            }</a>
<a name="ln815">            if (you.duration[DUR_QAZLAL_COLD_RES])</a>
<a name="ln816">            {</a>
<a name="ln817">                mprf(MSGCH_DURATION, &quot;Your resistance to cold fades away.&quot;);</a>
<a name="ln818">                you.duration[DUR_QAZLAL_COLD_RES] = 0;</a>
<a name="ln819">            }</a>
<a name="ln820">            if (you.duration[DUR_QAZLAL_ELEC_RES])</a>
<a name="ln821">            {</a>
<a name="ln822">                mprf(MSGCH_DURATION,</a>
<a name="ln823">                     &quot;Your resistance to electricity fades away.&quot;);</a>
<a name="ln824">                you.duration[DUR_QAZLAL_ELEC_RES] = 0;</a>
<a name="ln825">            }</a>
<a name="ln826">            if (you.duration[DUR_QAZLAL_AC])</a>
<a name="ln827">            {</a>
<a name="ln828">                mprf(MSGCH_DURATION,</a>
<a name="ln829">                     &quot;Your resistance to physical damage fades away.&quot;);</a>
<a name="ln830">                you.duration[DUR_QAZLAL_AC] = 0;</a>
<a name="ln831">                you.redraw_armour_class = true;</a>
<a name="ln832">            }</a>
<a name="ln833">        }</a>
<a name="ln834">#if TAG_MAJOR_VERSION == 34</a>
<a name="ln835">        else if (god == GOD_PAKELLAS)</a>
<a name="ln836">        {</a>
<a name="ln837">            if (you.duration[DUR_DEVICE_SURGE])</a>
<a name="ln838">                you.duration[DUR_DEVICE_SURGE] = 0;</a>
<a name="ln839">        }</a>
<a name="ln840">#endif</a>
<a name="ln841">        else if (god == GOD_SIF_MUNA)</a>
<a name="ln842">        {</a>
<a name="ln843">            if (you.duration[DUR_CHANNEL_ENERGY])</a>
<a name="ln844">                you.duration[DUR_CHANNEL_ENERGY] = 0;</a>
<a name="ln845">#if TAG_MAJOR_VERSION == 34</a>
<a name="ln846">            if (you.attribute[ATTR_DIVINE_ENERGY])</a>
<a name="ln847">                you.attribute[ATTR_DIVINE_ENERGY] = 0;</a>
<a name="ln848">#endif</a>
<a name="ln849">        }</a>
<a name="ln850"> </a>
<a name="ln851">        if (you_worship(god))</a>
<a name="ln852">        {</a>
<a name="ln853">            // Redraw piety display and, in case the best skill is Invocations,</a>
<a name="ln854">            // redraw the god title.</a>
<a name="ln855">            you.redraw_title = true;</a>
<a name="ln856">        }</a>
<a name="ln857">    }</a>
<a name="ln858">    else</a>
<a name="ln859">    {</a>
<a name="ln860">        you.penance[god] += val;</a>
<a name="ln861">        you.penance[god] = min((uint8_t)MAX_PENANCE, you.penance[god]);</a>
<a name="ln862">    }</a>
<a name="ln863"> </a>
<a name="ln864">    set_penance_xp_timeout();</a>
<a name="ln865">}</a>
<a name="ln866"> </a>
<a name="ln867">static void _inc_penance(int val)</a>
<a name="ln868">{</a>
<a name="ln869">    _inc_penance(you.religion, val);</a>
<a name="ln870">}</a>
<a name="ln871"> </a>
<a name="ln872">static void _set_penance(god_type god, int val)</a>
<a name="ln873">{</a>
<a name="ln874">    you.penance[god] = val;</a>
<a name="ln875">}</a>
<a name="ln876"> </a>
<a name="ln877">static void _set_wrath_penance(god_type god)</a>
<a name="ln878">{</a>
<a name="ln879">    _set_penance(god, initial_wrath_penance_for(god));</a>
<a name="ln880">}</a>
<a name="ln881"> </a>
<a name="ln882">static void _inc_gift_timeout(int val)</a>
<a name="ln883">{</a>
<a name="ln884">    if (200 - you.gift_timeout &lt; val)</a>
<a name="ln885">        you.gift_timeout = 200;</a>
<a name="ln886">    else</a>
<a name="ln887">        you.gift_timeout += val;</a>
<a name="ln888">}</a>
<a name="ln889"> </a>
<a name="ln890">// These are sorted in order of power.</a>
<a name="ln891">static monster_type _yred_servants[] =</a>
<a name="ln892">{</a>
<a name="ln893">    MONS_MUMMY, MONS_WIGHT, MONS_FLYING_SKULL, MONS_WRAITH,</a>
<a name="ln894">    MONS_VAMPIRE, MONS_PHANTASMAL_WARRIOR, MONS_SKELETAL_WARRIOR,</a>
<a name="ln895">    MONS_FLAYED_GHOST, MONS_VAMPIRE_KNIGHT, MONS_GHOUL, MONS_BONE_DRAGON,</a>
<a name="ln896">    MONS_PROFANE_SERVITOR</a>
<a name="ln897">};</a>
<a name="ln898"> </a>
<a name="ln899">#define MIN_YRED_SERVANT_THRESHOLD 3</a>
<a name="ln900">#define MAX_YRED_SERVANT_THRESHOLD ARRAYSZ(_yred_servants)</a>
<a name="ln901"> </a>
<a name="ln902">static bool _yred_high_level_servant(monster_type type)</a>
<a name="ln903">{</a>
<a name="ln904">    return type == MONS_BONE_DRAGON</a>
<a name="ln905">           || type == MONS_PROFANE_SERVITOR;</a>
<a name="ln906">}</a>
<a name="ln907"> </a>
<a name="ln908">int yred_random_servants(unsigned int threshold, bool force_hostile)</a>
<a name="ln909">{</a>
<a name="ln910">    if (threshold == 0)</a>
<a name="ln911">    {</a>
<a name="ln912">        if (force_hostile)</a>
<a name="ln913">        {</a>
<a name="ln914">            // This implies wrath - scale the threshold with XL.</a>
<a name="ln915">            threshold =</a>
<a name="ln916">                MIN_YRED_SERVANT_THRESHOLD</a>
<a name="ln917">                + (MAX_YRED_SERVANT_THRESHOLD - MIN_YRED_SERVANT_THRESHOLD)</a>
<a name="ln918">                  * you.experience_level / 27;</a>
<a name="ln919">        }</a>
<a name="ln920">        else</a>
<a name="ln921">            threshold = ARRAYSZ(_yred_servants);</a>
<a name="ln922">    }</a>
<a name="ln923">    else</a>
<a name="ln924">    {</a>
<a name="ln925">        threshold = min(static_cast&lt;unsigned int&gt;(ARRAYSZ(_yred_servants)),</a>
<a name="ln926">                        threshold);</a>
<a name="ln927">    }</a>
<a name="ln928"> </a>
<a name="ln929">    const unsigned int servant = random2(threshold);</a>
<a name="ln930"> </a>
<a name="ln931">    // Skip some of the weakest servants, once the threshold is high.</a>
<a name="ln932">    if ((servant + 2) * 2 &lt; threshold)</a>
<a name="ln933">        return -1;</a>
<a name="ln934"> </a>
<a name="ln935">    monster_type mon_type = _yred_servants[servant];</a>
<a name="ln936"> </a>
<a name="ln937">    // Cap some of the strongest servants.</a>
<a name="ln938">    if (!force_hostile &amp;&amp; _yred_high_level_servant(mon_type))</a>
<a name="ln939">    {</a>
<a name="ln940">        int current_high_level = 0;</a>
<a name="ln941">        for (auto &amp;entry : companion_list)</a>
<a name="ln942">        {</a>
<a name="ln943">            monster* mons = monster_by_mid(entry.first);</a>
<a name="ln944">            if (!mons)</a>
<a name="ln945">                mons = &amp;entry.second.mons.mons;</a>
<a name="ln946">            if (_yred_high_level_servant(mons-&gt;type))</a>
<a name="ln947">                current_high_level++;</a>
<a name="ln948">        }</a>
<a name="ln949"> </a>
<a name="ln950">        if (current_high_level &gt;= 3)</a>
<a name="ln951">            return -1;</a>
<a name="ln952">    }</a>
<a name="ln953"> </a>
<a name="ln954">    int how_many = (mon_type == MONS_FLYING_SKULL) ? 2 + random2(4)</a>
<a name="ln955">                                                   : 1;</a>
<a name="ln956"> </a>
<a name="ln957">    mgen_data mg(mon_type, !force_hostile ? BEH_FRIENDLY : BEH_HOSTILE,</a>
<a name="ln958">                 you.pos(), MHITYOU);</a>
<a name="ln959">    mg.set_summoned(!force_hostile ? &amp;you : 0, 0, 0, GOD_YREDELEMNUL);</a>
<a name="ln960"> </a>
<a name="ln961">    if (force_hostile)</a>
<a name="ln962">        mg.non_actor_summoner = &quot;the anger of Yredelemnul&quot;;</a>
<a name="ln963"> </a>
<a name="ln964">    int created = 0;</a>
<a name="ln965">    if (force_hostile)</a>
<a name="ln966">    {</a>
<a name="ln967">        mg.extra_flags |= (MF_NO_REWARD | MF_HARD_RESET);</a>
<a name="ln968"> </a>
<a name="ln969">        for (; how_many &gt; 0; --how_many)</a>
<a name="ln970">        {</a>
<a name="ln971">            if (create_monster(mg))</a>
<a name="ln972">                created++;</a>
<a name="ln973">        }</a>
<a name="ln974">    }</a>
<a name="ln975">    else</a>
<a name="ln976">    {</a>
<a name="ln977">        for (; how_many &gt; 0; --how_many)</a>
<a name="ln978">            delayed_monster(mg);</a>
<a name="ln979">    }</a>
<a name="ln980"> </a>
<a name="ln981">    return created;</a>
<a name="ln982">}</a>
<a name="ln983"> </a>
<a name="ln984">static bool _want_missile_gift()</a>
<a name="ln985">{</a>
<a name="ln986">    skill_type sk = best_skill(SK_SLINGS, SK_THROWING);</a>
<a name="ln987">    // Default to throwing if all missile skills are at zero.</a>
<a name="ln988">    if (you.skills[sk] == 0)</a>
<a name="ln989">        sk = SK_THROWING;</a>
<a name="ln990">    return you.piety &gt;= piety_breakpoint(2)</a>
<a name="ln991">           &amp;&amp; random2(you.piety) &gt; 70</a>
<a name="ln992">           &amp;&amp; one_chance_in(8)</a>
<a name="ln993">           &amp;&amp; x_chance_in_y(1 + you.skills[sk], 12);</a>
<a name="ln994">}</a>
<a name="ln995"> </a>
<a name="ln996">static bool _give_nemelex_gift(bool forced = false)</a>
<a name="ln997">{</a>
<a name="ln998">    // Nemelex will give at least one gift early.</a>
<a name="ln999">    if (forced</a>
<a name="ln1000">        || !you.num_total_gifts[GOD_NEMELEX_XOBEH]</a>
<a name="ln1001">           &amp;&amp; x_chance_in_y(you.piety + 1, piety_breakpoint(1))</a>
<a name="ln1002">        || one_chance_in(3) &amp;&amp; x_chance_in_y(you.piety + 1, MAX_PIETY))</a>
<a name="ln1003">    {</a>
<a name="ln1004">        if (gift_cards())</a>
<a name="ln1005">        {</a>
<a name="ln1006">            simple_god_message(&quot; deals you some cards!&quot;);</a>
<a name="ln1007">            mprf(MSGCH_GOD, &quot;You now have %s.&quot;, deck_summary().c_str());</a>
<a name="ln1008">        }</a>
<a name="ln1009">        else</a>
<a name="ln1010">            simple_god_message(&quot; goes to deal, but finds you have enough cards.&quot;);</a>
<a name="ln1011">        _inc_gift_timeout(5 + random2avg(9, 2));</a>
<a name="ln1012">        you.num_current_gifts[you.religion]++;</a>
<a name="ln1013">        you.num_total_gifts[you.religion]++;</a>
<a name="ln1014">        take_note(Note(NOTE_GOD_GIFT, you.religion));</a>
<a name="ln1015">        return true;</a>
<a name="ln1016">    }</a>
<a name="ln1017"> </a>
<a name="ln1018">    return false;</a>
<a name="ln1019">}</a>
<a name="ln1020"> </a>
<a name="ln1021">#if TAG_MAJOR_VERSION == 34</a>
<a name="ln1022">/**</a>
<a name="ln1023"> * From the given list of items, return a random unseen item, if there are any.</a>
<a name="ln1024"> * Otherwise, just return any of them at random.</a>
<a name="ln1025"> *</a>
<a name="ln1026"> * If we cared, we could make this a template function to return more specific</a>
<a name="ln1027"> * types than 'int'. (That's probably not important, though.)</a>
<a name="ln1028"> *</a>
<a name="ln1029"> * @param item_types        A list of item types to choose from.</a>
<a name="ln1030"> * @param seen_func         How to tell whether the item was seen.</a>
<a name="ln1031"> * @return                  A random item type; e.g. WAND_ACID.</a>
<a name="ln1032"> */</a>
<a name="ln1033">static int _preferably_unseen_item(const vector&lt;int&gt; &amp;item_types,</a>
<a name="ln1034">                                   function&lt;bool(int)&gt; seen_func)</a>
<a name="ln1035">{</a>
<a name="ln1036">    ASSERT(item_types.size());</a>
<a name="ln1037">    vector&lt;int&gt; unseen;</a>
<a name="ln1038">    for (auto item : item_types)</a>
<a name="ln1039">        if (!seen_func(item))</a>
<a name="ln1040">            unseen.emplace_back(item);</a>
<a name="ln1041"> </a>
<a name="ln1042">    if (unseen.size())</a>
<a name="ln1043">        return unseen[random2(unseen.size())];</a>
<a name="ln1044">    return item_types[random2(item_types.size())];</a>
<a name="ln1045">}</a>
<a name="ln1046">#endif</a>
<a name="ln1047"> </a>
<a name="ln1048">static void _delayed_gift_callback(const mgen_data &amp;/*mg*/, monster *&amp;mon,</a>
<a name="ln1049">                                   int placed)</a>
<a name="ln1050">{</a>
<a name="ln1051">    if (placed &lt;= 0)</a>
<a name="ln1052">        return;</a>
<a name="ln1053">    ASSERT(mon);</a>
<a name="ln1054"> </a>
<a name="ln1055">    // Make sure monsters are shown.</a>
<a name="ln1056">    viewwindow();</a>
<a name="ln1057">    more();</a>
<a name="ln1058">    _inc_gift_timeout(4 + random2avg(7, 2));</a>
<a name="ln1059">    you.num_current_gifts[you.religion]++;</a>
<a name="ln1060">    you.num_total_gifts[you.religion]++;</a>
<a name="ln1061">    string gift;</a>
<a name="ln1062">    if (placed == 1)</a>
<a name="ln1063">        gift = mon-&gt;name(DESC_A);</a>
<a name="ln1064">    else</a>
<a name="ln1065">    {</a>
<a name="ln1066">        gift = make_stringf(&quot;%d %s&quot;, placed,</a>
<a name="ln1067">                            pluralise(mon-&gt;name(DESC_PLAIN)).c_str());</a>
<a name="ln1068">    }</a>
<a name="ln1069"> </a>
<a name="ln1070">    take_note(Note(NOTE_GOD_GIFT, you.religion, 0, gift));</a>
<a name="ln1071">}</a>
<a name="ln1072"> </a>
<a name="ln1073">static bool _jiyva_mutate()</a>
<a name="ln1074">{</a>
<a name="ln1075">    simple_god_message(&quot; alters your body.&quot;);</a>
<a name="ln1076"> </a>
<a name="ln1077">    const int rand = random2(100);</a>
<a name="ln1078"> </a>
<a name="ln1079">    if (rand &lt; 5)</a>
<a name="ln1080">        return delete_mutation(RANDOM_SLIME_MUTATION, &quot;Jiyva's grace&quot;, true, false, true);</a>
<a name="ln1081">    else if (rand &lt; 30)</a>
<a name="ln1082">        return delete_mutation(RANDOM_NON_SLIME_MUTATION, &quot;Jiyva's grace&quot;, true, false, true);</a>
<a name="ln1083">    else if (rand &lt; 55)</a>
<a name="ln1084">        return mutate(RANDOM_MUTATION, &quot;Jiyva's grace&quot;, true, false, true);</a>
<a name="ln1085">    else if (rand &lt; 75)</a>
<a name="ln1086">        return mutate(RANDOM_SLIME_MUTATION, &quot;Jiyva's grace&quot;, true, false, true);</a>
<a name="ln1087">    else</a>
<a name="ln1088">        return mutate(RANDOM_GOOD_MUTATION, &quot;Jiyva's grace&quot;, true, false, true);</a>
<a name="ln1089">}</a>
<a name="ln1090"> </a>
<a name="ln1091">bool vehumet_is_offering(spell_type spell)</a>
<a name="ln1092">{</a>
<a name="ln1093">    return you.vehumet_gifts.count(spell);</a>
<a name="ln1094">}</a>
<a name="ln1095"> </a>
<a name="ln1096">void vehumet_accept_gift(spell_type spell)</a>
<a name="ln1097">{</a>
<a name="ln1098">    if (vehumet_is_offering(spell))</a>
<a name="ln1099">    {</a>
<a name="ln1100">        you.vehumet_gifts.erase(spell);</a>
<a name="ln1101">        you.duration[DUR_VEHUMET_GIFT] = 0;</a>
<a name="ln1102">    }</a>
<a name="ln1103">}</a>
<a name="ln1104"> </a>
<a name="ln1105">static void _add_to_old_gifts(spell_type spell)</a>
<a name="ln1106">{</a>
<a name="ln1107">    you.old_vehumet_gifts.insert(spell);</a>
<a name="ln1108">}</a>
<a name="ln1109"> </a>
<a name="ln1110">static bool _is_old_gift(spell_type spell)</a>
<a name="ln1111">{</a>
<a name="ln1112">    return you.old_vehumet_gifts.count(spell);</a>
<a name="ln1113">}</a>
<a name="ln1114"> </a>
<a name="ln1115">static set&lt;spell_type&gt; _vehumet_eligible_gift_spells(set&lt;spell_type&gt; excluded_spells)</a>
<a name="ln1116">{</a>
<a name="ln1117">    set&lt;spell_type&gt; eligible_spells;</a>
<a name="ln1118"> </a>
<a name="ln1119">    const int gifts = you.num_total_gifts[you.religion];</a>
<a name="ln1120">    if (gifts &gt;= NUM_VEHUMET_GIFTS)</a>
<a name="ln1121">        return eligible_spells;</a>
<a name="ln1122"> </a>
<a name="ln1123">    const int min_lev[] = {1,1,2,3,3,4,4,5,5,5,5,6,8};</a>
<a name="ln1124">    const int max_lev[] = {1,2,3,4,5,7,7,7,7,7,7,8,9};</a>
<a name="ln1125">    COMPILE_CHECK(ARRAYSZ(min_lev) == NUM_VEHUMET_GIFTS);</a>
<a name="ln1126">    COMPILE_CHECK(ARRAYSZ(max_lev) == NUM_VEHUMET_GIFTS);</a>
<a name="ln1127">    int min_level = min_lev[gifts];</a>
<a name="ln1128">    int max_level = max_lev[gifts];</a>
<a name="ln1129"> </a>
<a name="ln1130">    if (min_level &gt; you.experience_level)</a>
<a name="ln1131">        return eligible_spells;</a>
<a name="ln1132"> </a>
<a name="ln1133">    set&lt;spell_type&gt; backup_spells;</a>
<a name="ln1134">    for (int i = 0; i &lt; NUM_SPELLS; ++i)</a>
<a name="ln1135">    {</a>
<a name="ln1136">        spell_type spell = static_cast&lt;spell_type&gt;(i);</a>
<a name="ln1137">        if (!is_valid_spell(spell))</a>
<a name="ln1138">            continue;</a>
<a name="ln1139"> </a>
<a name="ln1140">        if (excluded_spells.count(spell))</a>
<a name="ln1141">            continue;</a>
<a name="ln1142"> </a>
<a name="ln1143">        if (vehumet_supports_spell(spell)</a>
<a name="ln1144">            &amp;&amp; !you.has_spell(spell)</a>
<a name="ln1145">            &amp;&amp; !you.spell_library[spell]</a>
<a name="ln1146">            &amp;&amp; is_player_spell(spell)</a>
<a name="ln1147">            &amp;&amp; spell_difficulty(spell) &lt;= max_level</a>
<a name="ln1148">            &amp;&amp; spell_difficulty(spell) &gt;= min_level)</a>
<a name="ln1149">        {</a>
<a name="ln1150">            if (!_is_old_gift(spell))</a>
<a name="ln1151">                eligible_spells.insert(spell);</a>
<a name="ln1152">            else</a>
<a name="ln1153">                backup_spells.insert(spell);</a>
<a name="ln1154">        }</a>
<a name="ln1155">    }</a>
<a name="ln1156">    // Don't get stuck just because all spells have been seen/offered.</a>
<a name="ln1157">    if (eligible_spells.empty())</a>
<a name="ln1158">    {</a>
<a name="ln1159">        if (backup_spells.empty())</a>
<a name="ln1160">        {</a>
<a name="ln1161">            // This is quite improbable to happen, but in this case just</a>
<a name="ln1162">            // skip the gift and increment the gift counter.</a>
<a name="ln1163">            if (gifts &lt;= 12)</a>
<a name="ln1164">            {</a>
<a name="ln1165">                you.num_current_gifts[you.religion]++;</a>
<a name="ln1166">                you.num_total_gifts[you.religion]++;</a>
<a name="ln1167">            }</a>
<a name="ln1168">        }</a>
<a name="ln1169">        return backup_spells;</a>
<a name="ln1170">    }</a>
<a name="ln1171">    return eligible_spells;</a>
<a name="ln1172">}</a>
<a name="ln1173"> </a>
<a name="ln1174">static int _vehumet_weighting(spell_type spell)</a>
<a name="ln1175">{</a>
<a name="ln1176">    int bias = 100 + elemental_preference(spell, 10);</a>
<a name="ln1177">    return bias;</a>
<a name="ln1178">}</a>
<a name="ln1179"> </a>
<a name="ln1180">static spell_type _vehumet_find_spell_gift(set&lt;spell_type&gt; excluded_spells)</a>
<a name="ln1181">{</a>
<a name="ln1182">    set&lt;spell_type&gt; eligible_spells = _vehumet_eligible_gift_spells(excluded_spells);</a>
<a name="ln1183">    spell_type spell = SPELL_NO_SPELL;</a>
<a name="ln1184">    int total_weight = 0;</a>
<a name="ln1185">    int this_weight = 0;</a>
<a name="ln1186">    for (auto elig : eligible_spells)</a>
<a name="ln1187">    {</a>
<a name="ln1188">        this_weight = _vehumet_weighting(elig);</a>
<a name="ln1189">        total_weight += this_weight;</a>
<a name="ln1190">        if (x_chance_in_y(this_weight, total_weight))</a>
<a name="ln1191">            spell = elig;</a>
<a name="ln1192">    }</a>
<a name="ln1193">    return spell;</a>
<a name="ln1194">}</a>
<a name="ln1195"> </a>
<a name="ln1196">static set&lt;spell_type&gt; _vehumet_get_spell_gifts()</a>
<a name="ln1197">{</a>
<a name="ln1198">    set&lt;spell_type&gt; offers;</a>
<a name="ln1199">    unsigned int num_offers = you.num_total_gifts[you.religion] == 12 ? 3 : 1;</a>
<a name="ln1200">    while (offers.size() &lt; num_offers)</a>
<a name="ln1201">    {</a>
<a name="ln1202">        spell_type offer = _vehumet_find_spell_gift(offers);</a>
<a name="ln1203">        if (offer == SPELL_NO_SPELL)</a>
<a name="ln1204">            break;</a>
<a name="ln1205">        offers.insert(offer);</a>
<a name="ln1206">    }</a>
<a name="ln1207">    return offers;</a>
<a name="ln1208">}</a>
<a name="ln1209"> </a>
<a name="ln1210">#if TAG_MAJOR_VERSION == 34</a>
<a name="ln1211">/// Has the player ID'd the given type of wand?</a>
<a name="ln1212">static bool _seen_wand(int wand)</a>
<a name="ln1213">{</a>
<a name="ln1214">    return get_ident_type(OBJ_WANDS, wand);</a>
<a name="ln1215">}</a>
<a name="ln1216"> </a>
<a name="ln1217">static int _pakellas_low_wand()</a>
<a name="ln1218">{</a>
<a name="ln1219">    static const vector&lt;int&gt; low_wands = {</a>
<a name="ln1220">        WAND_FLAME,</a>
<a name="ln1221">        WAND_POLYMORPH,</a>
<a name="ln1222">        WAND_RANDOM_EFFECTS,</a>
<a name="ln1223">    };</a>
<a name="ln1224"> </a>
<a name="ln1225">    return _preferably_unseen_item(low_wands, _seen_wand);</a>
<a name="ln1226">}</a>
<a name="ln1227"> </a>
<a name="ln1228">static int _pakellas_high_wand()</a>
<a name="ln1229">{</a>
<a name="ln1230">    vector&lt;int&gt; high_wands = {</a>
<a name="ln1231">        WAND_PARALYSIS,</a>
<a name="ln1232">        WAND_ICEBLAST,</a>
<a name="ln1233">        WAND_ACID,</a>
<a name="ln1234">    };</a>
<a name="ln1235">    if (!you.get_mutation_level(MUT_NO_LOVE))</a>
<a name="ln1236">        high_wands.emplace_back(WAND_ENSLAVEMENT);</a>
<a name="ln1237"> </a>
<a name="ln1238">    return _preferably_unseen_item(high_wands, _seen_wand);</a>
<a name="ln1239">}</a>
<a name="ln1240"> </a>
<a name="ln1241">static int _pakellas_low_misc()</a>
<a name="ln1242">{</a>
<a name="ln1243">    // Limited uses, so any of these are fine even if they've been seen before.</a>
<a name="ln1244">    return random_choose(MISC_BOX_OF_BEASTS,</a>
<a name="ln1245">                         MISC_PHANTOM_MIRROR);</a>
<a name="ln1246">}</a>
<a name="ln1247"> </a>
<a name="ln1248">static int _pakellas_high_misc()</a>
<a name="ln1249">{</a>
<a name="ln1250">    static const vector&lt;int&gt; high_miscs = {</a>
<a name="ln1251">        MISC_PHIAL_OF_FLOODS,</a>
<a name="ln1252">        MISC_LIGHTNING_ROD,</a>
<a name="ln1253">    };</a>
<a name="ln1254"> </a>
<a name="ln1255">    return _preferably_unseen_item(high_miscs, [](int misc) {</a>
<a name="ln1256">        return you.seen_misc[misc];</a>
<a name="ln1257">    });</a>
<a name="ln1258">}</a>
<a name="ln1259"> </a>
<a name="ln1260">static bool _give_pakellas_gift()</a>
<a name="ln1261">{</a>
<a name="ln1262">    // Break early if giving a gift now means it would be lost.</a>
<a name="ln1263">    if (!(feat_has_solid_floor(grd(you.pos()))</a>
<a name="ln1264">        || feat_is_watery(grd(you.pos())) &amp;&amp; species_likes_water(you.species)))</a>
<a name="ln1265">    {</a>
<a name="ln1266">        return false;</a>
<a name="ln1267">    }</a>
<a name="ln1268"> </a>
<a name="ln1269">    bool success = false;</a>
<a name="ln1270">    object_class_type basetype = OBJ_UNASSIGNED;</a>
<a name="ln1271">    int subtype = -1;</a>
<a name="ln1272"> </a>
<a name="ln1273">    if (you.piety &gt;= piety_breakpoint(0)</a>
<a name="ln1274">        &amp;&amp; you.num_total_gifts[GOD_PAKELLAS] == 0)</a>
<a name="ln1275">    {</a>
<a name="ln1276">        basetype = OBJ_WANDS;</a>
<a name="ln1277">        subtype = _pakellas_low_wand();</a>
<a name="ln1278">    }</a>
<a name="ln1279">    else if (you.piety &gt;= piety_breakpoint(1)</a>
<a name="ln1280">             &amp;&amp; you.num_total_gifts[GOD_PAKELLAS] == 1)</a>
<a name="ln1281">    {</a>
<a name="ln1282">        // All the evoker options here are summon-based, so give another</a>
<a name="ln1283">        // low-level wand instead under Sacrifice Love.</a>
<a name="ln1284">        if (you.get_mutation_level(MUT_NO_LOVE))</a>
<a name="ln1285">        {</a>
<a name="ln1286">            basetype = OBJ_WANDS;</a>
<a name="ln1287">            subtype = _pakellas_low_wand();</a>
<a name="ln1288">        }</a>
<a name="ln1289">        else</a>
<a name="ln1290">        {</a>
<a name="ln1291">            basetype = OBJ_MISCELLANY;</a>
<a name="ln1292">            subtype = _pakellas_low_misc();</a>
<a name="ln1293">        }</a>
<a name="ln1294">    }</a>
<a name="ln1295">    else if (you.piety &gt;= piety_breakpoint(2)</a>
<a name="ln1296">             &amp;&amp; you.num_total_gifts[GOD_PAKELLAS] == 2)</a>
<a name="ln1297">    {</a>
<a name="ln1298">        basetype = OBJ_WANDS;</a>
<a name="ln1299">        subtype = _pakellas_high_wand();</a>
<a name="ln1300">    }</a>
<a name="ln1301">    else if (you.piety &gt;= piety_breakpoint(3)</a>
<a name="ln1302">             &amp;&amp; you.num_total_gifts[GOD_PAKELLAS] == 3)</a>
<a name="ln1303">    {</a>
<a name="ln1304">        basetype = OBJ_MISCELLANY;</a>
<a name="ln1305">        subtype = _pakellas_high_misc();</a>
<a name="ln1306">    }</a>
<a name="ln1307">    else if (you.piety &gt;= piety_breakpoint(4)</a>
<a name="ln1308">             &amp;&amp; you.num_total_gifts[GOD_PAKELLAS] == 4)</a>
<a name="ln1309">    {</a>
<a name="ln1310">        basetype = random_choose(OBJ_WANDS, OBJ_MISCELLANY);</a>
<a name="ln1311">        subtype = (basetype == OBJ_WANDS) ? _pakellas_high_wand()</a>
<a name="ln1312">                                          : _pakellas_high_misc();</a>
<a name="ln1313">    }</a>
<a name="ln1314"> </a>
<a name="ln1315">    if (basetype == OBJ_UNASSIGNED)</a>
<a name="ln1316">        return false;</a>
<a name="ln1317">    else</a>
<a name="ln1318">    {</a>
<a name="ln1319">        ASSERT(subtype &gt;= 0);</a>
<a name="ln1320">        int thing_created = items(true, basetype, subtype, 1, 0,</a>
<a name="ln1321">                                  you.religion);</a>
<a name="ln1322"> </a>
<a name="ln1323">        if (thing_created == NON_ITEM)</a>
<a name="ln1324">            return false;</a>
<a name="ln1325"> </a>
<a name="ln1326">        move_item_to_grid(&amp;thing_created, you.pos(), true);</a>
<a name="ln1327"> </a>
<a name="ln1328">        if (thing_created != NON_ITEM)</a>
<a name="ln1329">            success = true;</a>
<a name="ln1330">    }</a>
<a name="ln1331"> </a>
<a name="ln1332">    if (success)</a>
<a name="ln1333">    {</a>
<a name="ln1334">        simple_god_message(&quot; grants you a gift!&quot;);</a>
<a name="ln1335">        // included in default force_more_message</a>
<a name="ln1336"> </a>
<a name="ln1337">        you.num_current_gifts[you.religion]++;</a>
<a name="ln1338">        you.num_total_gifts[you.religion]++;</a>
<a name="ln1339">        take_note(Note(NOTE_GOD_GIFT, you.religion));</a>
<a name="ln1340"> </a>
<a name="ln1341">        return true;</a>
<a name="ln1342">    }</a>
<a name="ln1343"> </a>
<a name="ln1344">    return false;</a>
<a name="ln1345">}</a>
<a name="ln1346">#endif</a>
<a name="ln1347"> </a>
<a name="ln1348">static bool _give_trog_oka_gift(bool forced)</a>
<a name="ln1349">{</a>
<a name="ln1350">    // Break early if giving a gift now means it would be lost.</a>
<a name="ln1351">    if (!(feat_has_solid_floor(grd(you.pos()))</a>
<a name="ln1352">        || feat_is_watery(grd(you.pos())) &amp;&amp; species_likes_water(you.species)))</a>
<a name="ln1353">    {</a>
<a name="ln1354">        return false;</a>
<a name="ln1355">    }</a>
<a name="ln1356"> </a>
<a name="ln1357">    // Should gift catnip instead.</a>
<a name="ln1358">    if (you.species == SP_FELID)</a>
<a name="ln1359">        return false;</a>
<a name="ln1360"> </a>
<a name="ln1361">    const bool want_equipment = forced</a>
<a name="ln1362">                                || (you.piety &gt;= piety_breakpoint(4)</a>
<a name="ln1363">                                    &amp;&amp; random2(you.piety) &gt; 120</a>
<a name="ln1364">                                    &amp;&amp; one_chance_in(4));</a>
<a name="ln1365">    // Oka can gift missiles, but if equipment is successful, we choose</a>
<a name="ln1366">    // equipment unless the gift was forced by wizard mode. In that case,</a>
<a name="ln1367">    // missiles, weapons, and armour all get equal weight below.</a>
<a name="ln1368">    const bool want_missiles = you_worship(GOD_OKAWARU)</a>
<a name="ln1369">                               &amp;&amp; (forced</a>
<a name="ln1370">                                   || !want_equipment &amp;&amp; _want_missile_gift());</a>
<a name="ln1371">    object_class_type gift_type;</a>
<a name="ln1372"> </a>
<a name="ln1373">    if (you_worship(GOD_TROG) &amp;&amp; want_equipment)</a>
<a name="ln1374">        gift_type = OBJ_WEAPONS;</a>
<a name="ln1375">    else if (you_worship(GOD_OKAWARU) &amp;&amp; (want_equipment || want_missiles))</a>
<a name="ln1376">    {</a>
<a name="ln1377">        gift_type = random_choose_weighted(</a>
<a name="ln1378">                want_equipment, OBJ_WEAPONS,</a>
<a name="ln1379">                want_equipment, OBJ_ARMOUR,</a>
<a name="ln1380">                want_missiles,  OBJ_MISSILES);</a>
<a name="ln1381">    }</a>
<a name="ln1382">    else</a>
<a name="ln1383">        return false;</a>
<a name="ln1384"> </a>
<a name="ln1385">    const bool success =</a>
<a name="ln1386">        acquirement_create_item(gift_type, you.religion,</a>
<a name="ln1387">                false, you.pos()) != NON_ITEM;</a>
<a name="ln1388">    if (success)</a>
<a name="ln1389">    {</a>
<a name="ln1390">        if (gift_type == OBJ_MISSILES)</a>
<a name="ln1391">        {</a>
<a name="ln1392">            simple_god_message(&quot; grants you ammunition!&quot;);</a>
<a name="ln1393">            _inc_gift_timeout(4 + roll_dice(2, 4));</a>
<a name="ln1394">        }</a>
<a name="ln1395">        else</a>
<a name="ln1396">        {</a>
<a name="ln1397">            if (gift_type == OBJ_WEAPONS)</a>
<a name="ln1398">                simple_god_message(&quot; grants you a weapon!&quot;);</a>
<a name="ln1399">            else</a>
<a name="ln1400">                simple_god_message(&quot; grants you armour!&quot;);</a>
<a name="ln1401">            // Okawaru charges extra for armour acquirements.</a>
<a name="ln1402">            if (you_worship(GOD_OKAWARU) &amp;&amp; gift_type == OBJ_ARMOUR)</a>
<a name="ln1403">                _inc_gift_timeout(30 + random2avg(15, 2));</a>
<a name="ln1404"> </a>
<a name="ln1405">            _inc_gift_timeout(30 + random2avg(19, 2));</a>
<a name="ln1406">        }</a>
<a name="ln1407">        you.num_current_gifts[you.religion]++;</a>
<a name="ln1408">        you.num_total_gifts[you.religion]++;</a>
<a name="ln1409">        take_note(Note(NOTE_GOD_GIFT, you.religion));</a>
<a name="ln1410">    }</a>
<a name="ln1411">    return success;</a>
<a name="ln1412">}</a>
<a name="ln1413"> </a>
<a name="ln1414">static bool _give_yred_gift(bool forced)</a>
<a name="ln1415">{</a>
<a name="ln1416">    bool success = false;</a>
<a name="ln1417">    if (forced || (random2(you.piety) &gt;= piety_breakpoint(2)</a>
<a name="ln1418">                   &amp;&amp; one_chance_in(4)))</a>
<a name="ln1419">    {</a>
<a name="ln1420">        unsigned int threshold = MIN_YRED_SERVANT_THRESHOLD</a>
<a name="ln1421">                                 + you.num_current_gifts[you.religion] / 2;</a>
<a name="ln1422">        threshold = max(threshold,</a>
<a name="ln1423">            static_cast&lt;unsigned int&gt;(MIN_YRED_SERVANT_THRESHOLD));</a>
<a name="ln1424">        threshold = min(threshold,</a>
<a name="ln1425">            static_cast&lt;unsigned int&gt;(MAX_YRED_SERVANT_THRESHOLD));</a>
<a name="ln1426"> </a>
<a name="ln1427">        if (yred_random_servants(threshold) != -1)</a>
<a name="ln1428">        {</a>
<a name="ln1429">            delayed_monster_done(&quot; grants you @servant@!&quot;,</a>
<a name="ln1430">                                 _delayed_gift_callback);</a>
<a name="ln1431">            success = true;</a>
<a name="ln1432">        }</a>
<a name="ln1433">    }</a>
<a name="ln1434">    return success;</a>
<a name="ln1435">}</a>
<a name="ln1436"> </a>
<a name="ln1437">static bool _gift_jiyva_gift(bool forced)</a>
<a name="ln1438">{</a>
<a name="ln1439">    if (forced || you.piety &gt;= piety_breakpoint(2)</a>
<a name="ln1440">                  &amp;&amp; random2(you.piety) &gt; 50</a>
<a name="ln1441">                  &amp;&amp; one_chance_in(4) &amp;&amp; !you.gift_timeout</a>
<a name="ln1442">                  &amp;&amp; you.can_safely_mutate())</a>
<a name="ln1443">    {</a>
<a name="ln1444">        if (_jiyva_mutate())</a>
<a name="ln1445">        {</a>
<a name="ln1446">            _inc_gift_timeout(15 + roll_dice(2, 4));</a>
<a name="ln1447">            you.num_current_gifts[you.religion]++;</a>
<a name="ln1448">            you.num_total_gifts[you.religion]++;</a>
<a name="ln1449">            return true;</a>
<a name="ln1450">        }</a>
<a name="ln1451">        else</a>
<a name="ln1452">            mpr(&quot;You feel as though nothing has changed.&quot;);</a>
<a name="ln1453">    }</a>
<a name="ln1454">    return false;</a>
<a name="ln1455">}</a>
<a name="ln1456"> </a>
<a name="ln1457">static bool _handle_uskayaw_ability_unlocks()</a>
<a name="ln1458">{</a>
<a name="ln1459">    bool success = false;</a>
<a name="ln1460">    // Uskayaw's triggered abilities trigger if you set the timer to -1.</a>
<a name="ln1461">    // We do this so that we trigger at the end of the round instead of</a>
<a name="ln1462">    // at the time we deal damage.</a>
<a name="ln1463">    if (you.piety == piety_breakpoint(2)</a>
<a name="ln1464">        &amp;&amp; you.props[USKAYAW_AUDIENCE_TIMER].get_int() == 0)</a>
<a name="ln1465">    {</a>
<a name="ln1466">        you.props[USKAYAW_AUDIENCE_TIMER] = -1;</a>
<a name="ln1467">        success = true;</a>
<a name="ln1468">    }</a>
<a name="ln1469">    else if (you.piety == piety_breakpoint(3)</a>
<a name="ln1470">        &amp;&amp; you.props[USKAYAW_BOND_TIMER].get_int() == 0)</a>
<a name="ln1471">    {</a>
<a name="ln1472">        you.props[USKAYAW_BOND_TIMER] = -1;</a>
<a name="ln1473">        success = true;</a>
<a name="ln1474">    }</a>
<a name="ln1475">    return success;</a>
<a name="ln1476">}</a>
<a name="ln1477"> </a>
<a name="ln1478">static bool _gift_sif_kiku_gift(bool forced)</a>
<a name="ln1479">{</a>
<a name="ln1480">    bool success = false;</a>
<a name="ln1481">    book_type gift = NUM_BOOKS;</a>
<a name="ln1482">    // Break early if giving a gift now means it would be lost.</a>
<a name="ln1483">    if (!feat_has_solid_floor(grd(you.pos())))</a>
<a name="ln1484">        return false;</a>
<a name="ln1485"> </a>
<a name="ln1486">    // Kikubaaqudgha gives the lesser Necromancy books in a quick</a>
<a name="ln1487">    // succession.</a>
<a name="ln1488">    if (you_worship(GOD_KIKUBAAQUDGHA))</a>
<a name="ln1489">    {</a>
<a name="ln1490">        if (you.piety &gt;= piety_breakpoint(0)</a>
<a name="ln1491">            &amp;&amp; you.num_total_gifts[you.religion] == 0)</a>
<a name="ln1492">        {</a>
<a name="ln1493">            gift = BOOK_NECROMANCY;</a>
<a name="ln1494">        }</a>
<a name="ln1495">        else if (you.piety &gt;= piety_breakpoint(2)</a>
<a name="ln1496">                 &amp;&amp; you.num_total_gifts[you.religion] == 1)</a>
<a name="ln1497">        {</a>
<a name="ln1498">            gift = BOOK_DEATH;</a>
<a name="ln1499">        }</a>
<a name="ln1500">    }</a>
<a name="ln1501">    else if (forced</a>
<a name="ln1502">             || you.piety &gt;= piety_breakpoint(4) &amp;&amp; random2(you.piety) &gt; 100)</a>
<a name="ln1503">    {</a>
<a name="ln1504">        // Sif Muna special: Keep quiet if acquirement fails</a>
<a name="ln1505">        // because the player already has seen all spells.</a>
<a name="ln1506">        if (you_worship(GOD_SIF_MUNA))</a>
<a name="ln1507">        {</a>
<a name="ln1508">            int item_index = acquirement_create_item(OBJ_BOOKS, you.religion,</a>
<a name="ln1509">                                                     true, you.pos());</a>
<a name="ln1510">            success = (item_index != NON_ITEM);</a>
<a name="ln1511">        }</a>
<a name="ln1512">    }</a>
<a name="ln1513"> </a>
<a name="ln1514">    if (gift != NUM_BOOKS)</a>
<a name="ln1515">    {</a>
<a name="ln1516">        int thing_created = items(true, OBJ_BOOKS, gift, 1, 0,</a>
<a name="ln1517">                                  you.religion);</a>
<a name="ln1518">        // Replace a Kiku gift by a custom-random book.</a>
<a name="ln1519">        if (you_worship(GOD_KIKUBAAQUDGHA))</a>
<a name="ln1520">        {</a>
<a name="ln1521">            make_book_kiku_gift(mitm[thing_created],</a>
<a name="ln1522">                                gift == BOOK_NECROMANCY);</a>
<a name="ln1523">        }</a>
<a name="ln1524">        if (thing_created == NON_ITEM)</a>
<a name="ln1525">            return false;</a>
<a name="ln1526"> </a>
<a name="ln1527">        move_item_to_grid(&amp;thing_created, you.pos(), true);</a>
<a name="ln1528"> </a>
<a name="ln1529">        if (thing_created != NON_ITEM)</a>
<a name="ln1530">            success = true;</a>
<a name="ln1531">    }</a>
<a name="ln1532"> </a>
<a name="ln1533">    if (success)</a>
<a name="ln1534">    {</a>
<a name="ln1535">        simple_god_message(&quot; grants you a gift!&quot;);</a>
<a name="ln1536">        // included in default force_more_message</a>
<a name="ln1537"> </a>
<a name="ln1538">        you.num_current_gifts[you.religion]++;</a>
<a name="ln1539">        you.num_total_gifts[you.religion]++;</a>
<a name="ln1540">        // Timeouts are meaningless for Kiku.</a>
<a name="ln1541">        if (!you_worship(GOD_KIKUBAAQUDGHA))</a>
<a name="ln1542">            _inc_gift_timeout(40 + random2avg(19, 2));</a>
<a name="ln1543">        take_note(Note(NOTE_GOD_GIFT, you.religion));</a>
<a name="ln1544">    }</a>
<a name="ln1545"> </a>
<a name="ln1546">    return success;</a>
<a name="ln1547">}</a>
<a name="ln1548"> </a>
<a name="ln1549">static bool _handle_veh_gift(bool forced)</a>
<a name="ln1550">{</a>
<a name="ln1551">    bool success = false;</a>
<a name="ln1552">    const int gifts = you.num_total_gifts[you.religion];</a>
<a name="ln1553">    if (forced || !you.duration[DUR_VEHUMET_GIFT]</a>
<a name="ln1554">                  &amp;&amp; (you.piety &gt;= piety_breakpoint(0) &amp;&amp; gifts == 0</a>
<a name="ln1555">                      || you.piety &gt;= piety_breakpoint(0) + random2(6) + 18 * gifts &amp;&amp; gifts &lt;= 5</a>
<a name="ln1556">                      || you.piety &gt;= piety_breakpoint(4) &amp;&amp; gifts &lt;= 11 &amp;&amp; one_chance_in(20)</a>
<a name="ln1557">                      || you.piety &gt;= piety_breakpoint(5) &amp;&amp; gifts &lt;= 12 &amp;&amp; one_chance_in(20)))</a>
<a name="ln1558">    {</a>
<a name="ln1559">        set&lt;spell_type&gt; offers = _vehumet_get_spell_gifts();</a>
<a name="ln1560">        if (!offers.empty())</a>
<a name="ln1561">        {</a>
<a name="ln1562">            you.vehumet_gifts = offers;</a>
<a name="ln1563">            string prompt = &quot; offers you knowledge of &quot;;</a>
<a name="ln1564">            for (auto it = offers.begin(); it != offers.end(); ++it)</a>
<a name="ln1565">            {</a>
<a name="ln1566">                if (it != offers.begin())</a>
<a name="ln1567">                {</a>
<a name="ln1568">                    if (offers.size() &gt; 2)</a>
<a name="ln1569">                        prompt += &quot;,&quot;;</a>
<a name="ln1570">                    prompt += &quot; &quot;;</a>
<a name="ln1571">                    auto next = it;</a>
<a name="ln1572">                    next++;</a>
<a name="ln1573">                    if (next == offers.end())</a>
<a name="ln1574">                        prompt += &quot;and &quot;;</a>
<a name="ln1575">                }</a>
<a name="ln1576">                prompt += spell_title(*it);</a>
<a name="ln1577">                _add_to_old_gifts(*it);</a>
<a name="ln1578">                take_note(Note(NOTE_OFFERED_SPELL, *it));</a>
<a name="ln1579">            }</a>
<a name="ln1580">            prompt += &quot;.&quot;;</a>
<a name="ln1581">            if (gifts &gt;= NUM_VEHUMET_GIFTS - 1)</a>
<a name="ln1582">            {</a>
<a name="ln1583">                prompt += &quot; These spells will remain available&quot;</a>
<a name="ln1584">                          &quot; as long as you worship Vehumet.&quot;;</a>
<a name="ln1585">            }</a>
<a name="ln1586"> </a>
<a name="ln1587">            you.duration[DUR_VEHUMET_GIFT] = (100 + random2avg(100, 2)) * BASELINE_DELAY;</a>
<a name="ln1588">            if (gifts &gt;= 5)</a>
<a name="ln1589">                _inc_gift_timeout(30 + random2avg(30, 2));</a>
<a name="ln1590">            you.num_current_gifts[you.religion]++;</a>
<a name="ln1591">            you.num_total_gifts[you.religion]++;</a>
<a name="ln1592"> </a>
<a name="ln1593">            simple_god_message(prompt.c_str());</a>
<a name="ln1594">            // included in default force_more_message</a>
<a name="ln1595"> </a>
<a name="ln1596">            success = true;</a>
<a name="ln1597">        }</a>
<a name="ln1598">    }</a>
<a name="ln1599">    return success;</a>
<a name="ln1600">}</a>
<a name="ln1601"> </a>
<a name="ln1602">void mons_make_god_gift(monster&amp; mon, god_type god)</a>
<a name="ln1603">{</a>
<a name="ln1604">    const god_type acting_god =</a>
<a name="ln1605">        (crawl_state.is_god_acting()) ? crawl_state.which_god_acting()</a>
<a name="ln1606">                                      : GOD_NO_GOD;</a>
<a name="ln1607"> </a>
<a name="ln1608">    if (god == GOD_NO_GOD &amp;&amp; acting_god == GOD_NO_GOD)</a>
<a name="ln1609">        return;</a>
<a name="ln1610"> </a>
<a name="ln1611">    if (god == GOD_NO_GOD)</a>
<a name="ln1612">        god = acting_god;</a>
<a name="ln1613"> </a>
<a name="ln1614">    if (mon.flags &amp; MF_GOD_GIFT)</a>
<a name="ln1615">    {</a>
<a name="ln1616">        dprf(&quot;Monster '%s' was already a gift of god '%s', now god '%s'.&quot;,</a>
<a name="ln1617">             mon.name(DESC_PLAIN, true).c_str(),</a>
<a name="ln1618">             god_name(mon.god).c_str(),</a>
<a name="ln1619">             god_name(god).c_str());</a>
<a name="ln1620">    }</a>
<a name="ln1621"> </a>
<a name="ln1622">    mon.god = god;</a>
<a name="ln1623">    mon.flags |= MF_GOD_GIFT;</a>
<a name="ln1624">}</a>
<a name="ln1625"> </a>
<a name="ln1626">bool mons_is_god_gift(const monster&amp; mon, god_type god)</a>
<a name="ln1627">{</a>
<a name="ln1628">    return (mon.flags &amp; MF_GOD_GIFT) &amp;&amp; mon.god == god;</a>
<a name="ln1629">}</a>
<a name="ln1630"> </a>
<a name="ln1631">bool is_yred_undead_slave(const monster&amp; mon)</a>
<a name="ln1632">{</a>
<a name="ln1633">    return mon.alive() &amp;&amp; mon.holiness() &amp; MH_UNDEAD</a>
<a name="ln1634">           &amp;&amp; mon.attitude == ATT_FRIENDLY</a>
<a name="ln1635">           &amp;&amp; mons_is_god_gift(mon, GOD_YREDELEMNUL);</a>
<a name="ln1636">}</a>
<a name="ln1637"> </a>
<a name="ln1638">bool is_orcish_follower(const monster&amp; mon)</a>
<a name="ln1639">{</a>
<a name="ln1640">    return mon.alive() &amp;&amp; mon.attitude == ATT_FRIENDLY</a>
<a name="ln1641">           &amp;&amp; mons_is_god_gift(mon, GOD_BEOGH);</a>
<a name="ln1642">}</a>
<a name="ln1643"> </a>
<a name="ln1644">bool is_fellow_slime(const monster&amp; mon)</a>
<a name="ln1645">{</a>
<a name="ln1646">    return mon.alive() &amp;&amp; mons_is_slime(mon)</a>
<a name="ln1647">           &amp;&amp; mon.attitude == ATT_STRICT_NEUTRAL</a>
<a name="ln1648">           &amp;&amp; mons_is_god_gift(mon, GOD_JIYVA);</a>
<a name="ln1649">}</a>
<a name="ln1650"> </a>
<a name="ln1651">static bool _is_plant_follower(const monster* mon)</a>
<a name="ln1652">{</a>
<a name="ln1653">    return mon-&gt;alive() &amp;&amp; mons_is_plant(*mon)</a>
<a name="ln1654">           &amp;&amp; mon-&gt;attitude == ATT_FRIENDLY;</a>
<a name="ln1655">}</a>
<a name="ln1656"> </a>
<a name="ln1657">static bool _has_jelly()</a>
<a name="ln1658">{</a>
<a name="ln1659">    ASSERT(you_worship(GOD_JIYVA));</a>
<a name="ln1660"> </a>
<a name="ln1661">    for (monster_iterator mi; mi; ++mi)</a>
<a name="ln1662">        if (mons_is_god_gift(**mi, GOD_JIYVA))</a>
<a name="ln1663">            return true;</a>
<a name="ln1664">    return false;</a>
<a name="ln1665">}</a>
<a name="ln1666"> </a>
<a name="ln1667">bool is_follower(const monster&amp; mon)</a>
<a name="ln1668">{</a>
<a name="ln1669">    if (you_worship(GOD_YREDELEMNUL))</a>
<a name="ln1670">        return is_yred_undead_slave(mon);</a>
<a name="ln1671">    else if (will_have_passive(passive_t::convert_orcs))</a>
<a name="ln1672">        return is_orcish_follower(mon);</a>
<a name="ln1673">    else if (you_worship(GOD_JIYVA))</a>
<a name="ln1674">        return is_fellow_slime(mon);</a>
<a name="ln1675">    else if (you_worship(GOD_FEDHAS))</a>
<a name="ln1676">        return _is_plant_follower(&amp;mon);</a>
<a name="ln1677">    else</a>
<a name="ln1678">        return mon.alive() &amp;&amp; mon.attitude == ATT_FRIENDLY;</a>
<a name="ln1679">}</a>
<a name="ln1680"> </a>
<a name="ln1681">/**</a>
<a name="ln1682"> * What's the name of the ally Hepliaklqana granted the player?</a>
<a name="ln1683"> *</a>
<a name="ln1684"> * @return      The ally's name.</a>
<a name="ln1685"> */</a>
<a name="ln1686">string hepliaklqana_ally_name()</a>
<a name="ln1687">{</a>
<a name="ln1688">    return you.props[HEPLIAKLQANA_ALLY_NAME_KEY].get_string();</a>
<a name="ln1689">}</a>
<a name="ln1690"> </a>
<a name="ln1691">/**</a>
<a name="ln1692"> * How much HD should the ally granted by Hepliaklqana have?</a>
<a name="ln1693"> *</a>
<a name="ln1694"> * @return      The player's xl * 2/3.</a>
<a name="ln1695"> */</a>
<a name="ln1696">static int _hepliaklqana_ally_hd()</a>
<a name="ln1697">{</a>
<a name="ln1698">    if (!crawl_state.need_save) // on main menu or otherwise don't have 'you'</a>
<a name="ln1699">        return 27; // v0v</a>
<a name="ln1700">    // round up</a>
<a name="ln1701">    return (you.experience_level - 1) * 2 / 3 + 1;</a>
<a name="ln1702">}</a>
<a name="ln1703"> </a>
<a name="ln1704">/**</a>
<a name="ln1705"> * How much max HP should the ally granted by Hepliaklqana have?</a>
<a name="ln1706"> *</a>
<a name="ln1707"> * @return      5/hd from 1-11 HD, 10/hd from 12-18.</a>
<a name="ln1708"> *              (That is, 5 HP at 1 HD, 120 at 18.)</a>
<a name="ln1709"> */</a>
<a name="ln1710">int hepliaklqana_ally_hp()</a>
<a name="ln1711">{</a>
<a name="ln1712">    const int HD = _hepliaklqana_ally_hd();</a>
<a name="ln1713">    return HD * 5 + max(0, (HD - 12) * 5);</a>
<a name="ln1714">}</a>
<a name="ln1715"> </a>
<a name="ln1716">/**</a>
<a name="ln1717"> * Creates a mgen_data with the information needed to create the ancestor</a>
<a name="ln1718"> * granted by Hepliaklqana.</a>
<a name="ln1719"> *</a>
<a name="ln1720"> * XXX: should this be populating a mgen_data passed by reference, rather than</a>
<a name="ln1721"> * returning one on the stack?</a>
<a name="ln1722"> *</a>
<a name="ln1723"> * @return    The mgen_data that creates a hepliaklqana ancestor.</a>
<a name="ln1724"> */</a>
<a name="ln1725">mgen_data hepliaklqana_ancestor_gen_data()</a>
<a name="ln1726">{</a>
<a name="ln1727">    const monster_type type = you.props.exists(HEPLIAKLQANA_ALLY_TYPE_KEY) ?</a>
<a name="ln1728">        (monster_type)you.props[HEPLIAKLQANA_ALLY_TYPE_KEY].get_int() :</a>
<a name="ln1729">        MONS_ANCESTOR;</a>
<a name="ln1730">    mgen_data mg(type, BEH_FRIENDLY, you.pos(), MHITYOU, MG_AUTOFOE);</a>
<a name="ln1731">    mg.set_summoned(&amp;you, 0, 0, GOD_HEPLIAKLQANA);</a>
<a name="ln1732">    mg.hd = _hepliaklqana_ally_hd();</a>
<a name="ln1733">    mg.hp = hepliaklqana_ally_hp();</a>
<a name="ln1734">    mg.extra_flags |= MF_NO_REWARD;</a>
<a name="ln1735">    mg.mname = hepliaklqana_ally_name();</a>
<a name="ln1736">    mg.props[MON_GENDER_KEY]</a>
<a name="ln1737">        = you.props[HEPLIAKLQANA_ALLY_GENDER_KEY].get_int();</a>
<a name="ln1738">    return mg;</a>
<a name="ln1739">}</a>
<a name="ln1740"> </a>
<a name="ln1741">/// Print a message for an ancestor's *something* being gained.</a>
<a name="ln1742">static void _regain_memory(const monster &amp;ancestor, string memory)</a>
<a name="ln1743">{</a>
<a name="ln1744">    mprf(&quot;%s regains the memory of %s %s.&quot;,</a>
<a name="ln1745">         ancestor.name(DESC_YOUR, true).c_str(),</a>
<a name="ln1746">         ancestor.pronoun(PRONOUN_POSSESSIVE, true).c_str(),</a>
<a name="ln1747">         memory.c_str());</a>
<a name="ln1748">}</a>
<a name="ln1749"> </a>
<a name="ln1750">static string _item_ego_name(object_class_type base_type, int brand)</a>
<a name="ln1751">{</a>
<a name="ln1752">    switch (base_type)</a>
<a name="ln1753">    {</a>
<a name="ln1754">    case OBJ_WEAPONS:</a>
<a name="ln1755">    {</a>
<a name="ln1756">        // 'remembers... draining' reads better than 'drain', but 'flame'</a>
<a name="ln1757">        // reads better than 'flaming'</a>
<a name="ln1758">        const bool terse = brand == SPWPN_FLAMING</a>
<a name="ln1759">                           || brand == SPWPN_ANTIMAGIC;</a>
<a name="ln1760">        return brand_type_name((brand_type) brand, terse);</a>
<a name="ln1761">    }</a>
<a name="ln1762">    case OBJ_ARMOUR:</a>
<a name="ln1763">        // XXX: hack</a>
<a name="ln1764">        return &quot;reflection&quot;;</a>
<a name="ln1765">    default:</a>
<a name="ln1766">        die(&quot;unsupported object type&quot;);</a>
<a name="ln1767">    }</a>
<a name="ln1768">}</a>
<a name="ln1769"> </a>
<a name="ln1770">/// Print a message for an ancestor's item being gained/type upgraded.</a>
<a name="ln1771">static void _regain_item_memory(const monster &amp;ancestor,</a>
<a name="ln1772">                                object_class_type base_type,</a>
<a name="ln1773">                                int sub_type,</a>
<a name="ln1774">                                int brand)</a>
<a name="ln1775">{</a>
<a name="ln1776">    const string base_name = item_base_name(base_type, sub_type);</a>
<a name="ln1777">    if (!brand)</a>
<a name="ln1778">    {</a>
<a name="ln1779">        _regain_memory(ancestor, base_name);</a>
<a name="ln1780">        return;</a>
<a name="ln1781">    }</a>
<a name="ln1782"> </a>
<a name="ln1783">    const string ego_name = _item_ego_name(base_type, brand);</a>
<a name="ln1784">    const string item_name</a>
<a name="ln1785">        = make_stringf(&quot;%s of %s&quot;,</a>
<a name="ln1786">                       item_base_name(base_type, sub_type).c_str(),</a>
<a name="ln1787">                       ego_name.c_str());</a>
<a name="ln1788">    _regain_memory(ancestor, item_name);</a>
<a name="ln1789">}</a>
<a name="ln1790"> </a>
<a name="ln1791">/**</a>
<a name="ln1792"> * Update the ancestor's stats after the player levels up. Upgrade HD and HP,</a>
<a name="ln1793"> * and give appropriate messaging for that and any other notable upgrades</a>
<a name="ln1794"> * (spells, resists, etc).</a>
<a name="ln1795"> *</a>
<a name="ln1796"> * @param quiet_force     Whether to squash messages &amp; force upgrades,</a>
<a name="ln1797"> *                        even if the HD is unchanged.</a>
<a name="ln1798"> */</a>
<a name="ln1799">void upgrade_hepliaklqana_ancestor(bool quiet_force)</a>
<a name="ln1800">{</a>
<a name="ln1801">    monster* ancestor = hepliaklqana_ancestor_mon();</a>
<a name="ln1802">    if (!ancestor || !ancestor-&gt;alive())</a>
<a name="ln1803">        return;</a>
<a name="ln1804"> </a>
<a name="ln1805">    // housekeeping</a>
<a name="ln1806">    ancestor-&gt;mname = hepliaklqana_ally_name();</a>
<a name="ln1807">    ancestor-&gt;props[MON_GENDER_KEY]</a>
<a name="ln1808">        = you.props[HEPLIAKLQANA_ALLY_GENDER_KEY].get_int();</a>
<a name="ln1809"> </a>
<a name="ln1810">    const int old_hd = ancestor-&gt;get_experience_level();</a>
<a name="ln1811">    const int hd = _hepliaklqana_ally_hd();</a>
<a name="ln1812">    ancestor-&gt;set_hit_dice(hd);</a>
<a name="ln1813">    if (old_hd == hd &amp;&amp; !quiet_force)</a>
<a name="ln1814">        return; // assume nothing changes except at different HD</a>
<a name="ln1815"> </a>
<a name="ln1816">    const int old_mhp = ancestor-&gt;max_hit_points;</a>
<a name="ln1817">    ancestor-&gt;max_hit_points = hepliaklqana_ally_hp();</a>
<a name="ln1818">    ancestor-&gt;hit_points =</a>
<a name="ln1819">        div_rand_round(ancestor-&gt;hit_points * ancestor-&gt;max_hit_points,</a>
<a name="ln1820">                       old_mhp);</a>
<a name="ln1821"> </a>
<a name="ln1822">    if (!quiet_force)</a>
<a name="ln1823">    {</a>
<a name="ln1824">        mprf(&quot;%s remembers more of %s old skill.&quot;,</a>
<a name="ln1825">             ancestor-&gt;name(DESC_YOUR, true).c_str(),</a>
<a name="ln1826">             ancestor-&gt;pronoun(PRONOUN_POSSESSIVE, true).c_str());</a>
<a name="ln1827">    }</a>
<a name="ln1828"> </a>
<a name="ln1829">    set_ancestor_spells(*ancestor, !quiet_force);</a>
<a name="ln1830"> </a>
<a name="ln1831">    const bool ancestor_offlevel = companion_is_elsewhere(ancestor-&gt;mid);</a>
<a name="ln1832">    if (ancestor_offlevel)</a>
<a name="ln1833">        add_daction(DACT_UPGRADE_ANCESTOR);</a>
<a name="ln1834"> </a>
<a name="ln1835">    // assumption: ancestors can lose weapons (very rarely - tukima's),</a>
<a name="ln1836">    // and it's weird for them to just reappear, so only upgrade existing ones</a>
<a name="ln1837">    if (ancestor-&gt;weapon())</a>
<a name="ln1838">    {</a>
<a name="ln1839">        if (!ancestor_offlevel)</a>
<a name="ln1840">            upgrade_hepliaklqana_weapon(ancestor-&gt;type, *ancestor-&gt;weapon());</a>
<a name="ln1841"> </a>
<a name="ln1842">        const weapon_type wpn = _hepliaklqana_weapon_type(ancestor-&gt;type, hd);</a>
<a name="ln1843">        const brand_type brand = _hepliaklqana_weapon_brand(ancestor-&gt;type, hd);</a>
<a name="ln1844">        if (wpn != _hepliaklqana_weapon_type(ancestor-&gt;type, old_hd)</a>
<a name="ln1845">            &amp;&amp; !quiet_force)</a>
<a name="ln1846">        {</a>
<a name="ln1847">            _regain_item_memory(*ancestor, OBJ_WEAPONS, wpn, brand);</a>
<a name="ln1848">        }</a>
<a name="ln1849">        else if (brand != _hepliaklqana_weapon_brand(ancestor-&gt;type, old_hd)</a>
<a name="ln1850">                 &amp;&amp; !quiet_force)</a>
<a name="ln1851">        {</a>
<a name="ln1852">            mprf(&quot;%s remembers %s %s %s.&quot;,</a>
<a name="ln1853">                 ancestor-&gt;name(DESC_YOUR, true).c_str(),</a>
<a name="ln1854">                 ancestor-&gt;pronoun(PRONOUN_POSSESSIVE, true).c_str(),</a>
<a name="ln1855">                 apostrophise(item_base_name(OBJ_WEAPONS, wpn)).c_str(),</a>
<a name="ln1856">                 brand_type_name(brand, brand != SPWPN_DRAINING));</a>
<a name="ln1857">        }</a>
<a name="ln1858">    }</a>
<a name="ln1859">    // but shields can't be lost, and *can* be gained (knight at hd 5)</a>
<a name="ln1860">    // so give them out as appropriate</a>
<a name="ln1861">    if (!ancestor_offlevel)</a>
<a name="ln1862">    {</a>
<a name="ln1863">        if (ancestor-&gt;shield())</a>
<a name="ln1864">            upgrade_hepliaklqana_shield(*ancestor, *ancestor-&gt;shield());</a>
<a name="ln1865">        else</a>
<a name="ln1866">            give_shield(ancestor);</a>
<a name="ln1867">    }</a>
<a name="ln1868"> </a>
<a name="ln1869">    const armour_type shld = _hepliaklqana_shield_type(ancestor-&gt;type, hd);</a>
<a name="ln1870">    if (shld != _hepliaklqana_shield_type(ancestor-&gt;type, old_hd)</a>
<a name="ln1871">        &amp;&amp; !quiet_force)</a>
<a name="ln1872">    {</a>
<a name="ln1873">        // doesn't currently support egos varying separately from shield types</a>
<a name="ln1874">        _regain_item_memory(*ancestor, OBJ_ARMOUR, shld,</a>
<a name="ln1875">                            _hepliaklqana_shield_ego(hd));</a>
<a name="ln1876">    }</a>
<a name="ln1877"> </a>
<a name="ln1878">    if (quiet_force)</a>
<a name="ln1879">        return;</a>
<a name="ln1880">}</a>
<a name="ln1881"> </a>
<a name="ln1882">/**</a>
<a name="ln1883"> * What type of weapon should an ancestor of the given HD have?</a>
<a name="ln1884"> *</a>
<a name="ln1885"> * @param mc   The type of ancestor in question.</a>
<a name="ln1886"> * @param HD   The HD of the ancestor in question.</a>
<a name="ln1887"> * @return     An appropriate weapon_type.</a>
<a name="ln1888"> */</a>
<a name="ln1889">static weapon_type _hepliaklqana_weapon_type(monster_type mc, int HD)</a>
<a name="ln1890">{</a>
<a name="ln1891">    switch (mc)</a>
<a name="ln1892">    {</a>
<a name="ln1893">    case MONS_ANCESTOR_HEXER:</a>
<a name="ln1894">        return HD &lt; 16 ? WPN_DAGGER : WPN_QUICK_BLADE;</a>
<a name="ln1895">    case MONS_ANCESTOR_KNIGHT:</a>
<a name="ln1896">        return HD &lt; 10 ? WPN_FLAIL : WPN_BROAD_AXE;</a>
<a name="ln1897">    case MONS_ANCESTOR_BATTLEMAGE:</a>
<a name="ln1898">        return HD &lt; 13 ? WPN_QUARTERSTAFF : WPN_LAJATANG;</a>
<a name="ln1899">    default:</a>
<a name="ln1900">        return NUM_WEAPONS; // should never happen</a>
<a name="ln1901">    }</a>
<a name="ln1902">}</a>
<a name="ln1903"> </a>
<a name="ln1904">/**</a>
<a name="ln1905"> * What brand should an ancestor of the given HD's weapon have, if any?</a>
<a name="ln1906"> *</a>
<a name="ln1907"> * @param mc   The type of ancestor in question.</a>
<a name="ln1908"> * @param HD   The HD of the ancestor in question.</a>
<a name="ln1909"> * @return     An appropriate weapon_type.</a>
<a name="ln1910"> */</a>
<a name="ln1911">static brand_type _hepliaklqana_weapon_brand(monster_type mc, int HD)</a>
<a name="ln1912">{</a>
<a name="ln1913">    switch (mc)</a>
<a name="ln1914">    {</a>
<a name="ln1915">        case MONS_ANCESTOR_HEXER:</a>
<a name="ln1916">            return HD &lt; 16 ?   SPWPN_DRAINING :</a>
<a name="ln1917">                               SPWPN_ANTIMAGIC;</a>
<a name="ln1918">        case MONS_ANCESTOR_KNIGHT:</a>
<a name="ln1919">            return HD &lt; 10 ?   SPWPN_NORMAL :</a>
<a name="ln1920">                   HD &lt; 16 ?   SPWPN_FLAMING :</a>
<a name="ln1921">                               SPWPN_SPEED;</a>
<a name="ln1922">        case MONS_ANCESTOR_BATTLEMAGE:</a>
<a name="ln1923">            return HD &lt; 13 ?   SPWPN_NORMAL :</a>
<a name="ln1924">                               SPWPN_FREEZING;</a>
<a name="ln1925">        default:</a>
<a name="ln1926">            return SPWPN_NORMAL;</a>
<a name="ln1927">    }</a>
<a name="ln1928">}</a>
<a name="ln1929"> </a>
<a name="ln1930">/**</a>
<a name="ln1931"> * Setup an ancestor's weapon after their class is chosen, when the player</a>
<a name="ln1932"> * levels up, or after they're resummoned (or initially created for wrath).</a>
<a name="ln1933"> *</a>
<a name="ln1934"> * @param[in]   mtyp          The ancestor for whom the weapon is intended.</a>
<a name="ln1935"> * @param[out]  item          The item to be configured.</a>
<a name="ln1936"> * @param       notify        Whether messages should be printed when something</a>
<a name="ln1937"> *                            changes. (Weapon type or brand.)</a>
<a name="ln1938"> */</a>
<a name="ln1939">void upgrade_hepliaklqana_weapon(monster_type mtyp, item_def &amp;item)</a>
<a name="ln1940">{</a>
<a name="ln1941">    ASSERT(mons_is_hepliaklqana_ancestor(mtyp));</a>
<a name="ln1942">    if (mtyp == MONS_ANCESTOR)</a>
<a name="ln1943">        return; // bare-handed!</a>
<a name="ln1944"> </a>
<a name="ln1945">    item.base_type = OBJ_WEAPONS;</a>
<a name="ln1946">    item.sub_type = _hepliaklqana_weapon_type(mtyp,</a>
<a name="ln1947">                                              _hepliaklqana_ally_hd());</a>
<a name="ln1948">    item.brand = _hepliaklqana_weapon_brand(mtyp,</a>
<a name="ln1949">                                            _hepliaklqana_ally_hd());</a>
<a name="ln1950">    item.plus = 0;</a>
<a name="ln1951">    item.flags |= ISFLAG_KNOW_TYPE | ISFLAG_SUMMONED;</a>
<a name="ln1952">}</a>
<a name="ln1953"> </a>
<a name="ln1954">/**</a>
<a name="ln1955"> * What kind of shield should an ancestor of the given HD be given?</a>
<a name="ln1956"> *</a>
<a name="ln1957"> * @param mc        The type of ancestor in question.</a>
<a name="ln1958"> * @param HD        The HD (XL) of the ancestor in question.</a>
<a name="ln1959"> * @return          An appropriate type of shield, or NUM_ARMOURS.</a>
<a name="ln1960"> */</a>
<a name="ln1961">static armour_type _hepliaklqana_shield_type(monster_type mc, int HD)</a>
<a name="ln1962">{</a>
<a name="ln1963">    if (mc != MONS_ANCESTOR_KNIGHT)</a>
<a name="ln1964">        return NUM_ARMOURS;</a>
<a name="ln1965">    if (HD &lt; 13)</a>
<a name="ln1966">        return ARM_KITE_SHIELD;</a>
<a name="ln1967">    return ARM_TOWER_SHIELD;</a>
<a name="ln1968">}</a>
<a name="ln1969"> </a>
<a name="ln1970">static special_armour_type _hepliaklqana_shield_ego(int HD)</a>
<a name="ln1971">{</a>
<a name="ln1972">    return HD &lt; 13 ? SPARM_NORMAL : SPARM_REFLECTION;</a>
<a name="ln1973">}</a>
<a name="ln1974"> </a>
<a name="ln1975">/**</a>
<a name="ln1976"> * Setup an ancestor's weapon after their class is chosen, when the player</a>
<a name="ln1977"> * levels up, or after they're resummoned (or initially created for wrath).</a>
<a name="ln1978"> *</a>
<a name="ln1979"> * @param[in]   ancestor      The ancestor for whom the weapon is intended.</a>
<a name="ln1980"> * @param[out]  item          The item to be configured.</a>
<a name="ln1981"> * @return                    True iff the ancestor should have a weapon.</a>
<a name="ln1982"> */</a>
<a name="ln1983">void upgrade_hepliaklqana_shield(const monster &amp;ancestor, item_def &amp;item)</a>
<a name="ln1984">{</a>
<a name="ln1985">    ASSERT(mons_is_hepliaklqana_ancestor(ancestor.type));</a>
<a name="ln1986">    const int HD = ancestor.get_experience_level();</a>
<a name="ln1987">    const armour_type shield_type = _hepliaklqana_shield_type(ancestor.type,</a>
<a name="ln1988">                                                              HD);</a>
<a name="ln1989">    if (shield_type == NUM_ARMOURS)</a>
<a name="ln1990">        return; // no shield yet!</a>
<a name="ln1991"> </a>
<a name="ln1992">    item.base_type = OBJ_ARMOUR;</a>
<a name="ln1993">    item.sub_type = shield_type;</a>
<a name="ln1994">    item.brand = _hepliaklqana_shield_ego(HD);</a>
<a name="ln1995">    item.plus = 0;</a>
<a name="ln1996">    item.flags |= ISFLAG_KNOW_TYPE | ISFLAG_SUMMONED;</a>
<a name="ln1997">    item.quantity = 1;</a>
<a name="ln1998">}</a>
<a name="ln1999"> </a>
<a name="ln2000">///////////////////////////////</a>
<a name="ln2001">bool do_god_gift(bool forced)</a>
<a name="ln2002">{</a>
<a name="ln2003">    ASSERT(!you_worship(GOD_NO_GOD));</a>
<a name="ln2004"> </a>
<a name="ln2005">    god_acting gdact;</a>
<a name="ln2006"> </a>
<a name="ln2007">#if defined(DEBUG_DIAGNOSTICS) || defined(DEBUG_GIFTS)</a>
<a name="ln2008">    int old_num_current_gifts = you.num_current_gifts[you.religion];</a>
<a name="ln2009">    int old_num_total_gifts = you.num_total_gifts[you.religion];</a>
<a name="ln2010">#endif</a>
<a name="ln2011"> </a>
<a name="ln2012">    bool success = false;</a>
<a name="ln2013"> </a>
<a name="ln2014">    // Consider a gift if we don't have a timeout and aren't under penance</a>
<a name="ln2015">    if (forced || !player_under_penance() &amp;&amp; !you.gift_timeout)</a>
<a name="ln2016">    {</a>
<a name="ln2017">        // Remember to check for water/lava.</a>
<a name="ln2018">        switch (you.religion)</a>
<a name="ln2019">        {</a>
<a name="ln2020">        default:</a>
<a name="ln2021">            break;</a>
<a name="ln2022"> </a>
<a name="ln2023">        case GOD_NEMELEX_XOBEH:</a>
<a name="ln2024">            success = _give_nemelex_gift(forced);</a>
<a name="ln2025">            break;</a>
<a name="ln2026"> </a>
<a name="ln2027">#if TAG_MAJOR_VERSION == 34</a>
<a name="ln2028">        case GOD_PAKELLAS:</a>
<a name="ln2029">            success = _give_pakellas_gift();</a>
<a name="ln2030">            break;</a>
<a name="ln2031">#endif</a>
<a name="ln2032"> </a>
<a name="ln2033">        case GOD_OKAWARU:</a>
<a name="ln2034">        case GOD_TROG:</a>
<a name="ln2035">            success = _give_trog_oka_gift(forced);</a>
<a name="ln2036">            break;</a>
<a name="ln2037"> </a>
<a name="ln2038">        case GOD_YREDELEMNUL:</a>
<a name="ln2039">            success = _give_yred_gift(forced);</a>
<a name="ln2040">            break;</a>
<a name="ln2041"> </a>
<a name="ln2042">        case GOD_JIYVA:</a>
<a name="ln2043">            success = _gift_jiyva_gift(forced);</a>
<a name="ln2044">            break;</a>
<a name="ln2045"> </a>
<a name="ln2046">        case GOD_USKAYAW:</a>
<a name="ln2047">            success = _handle_uskayaw_ability_unlocks();</a>
<a name="ln2048">            break;</a>
<a name="ln2049"> </a>
<a name="ln2050">        case GOD_KIKUBAAQUDGHA:</a>
<a name="ln2051">        case GOD_SIF_MUNA:</a>
<a name="ln2052">            success = _gift_sif_kiku_gift(forced);</a>
<a name="ln2053">            break;</a>
<a name="ln2054"> </a>
<a name="ln2055">        case GOD_VEHUMET:</a>
<a name="ln2056">            success = _handle_veh_gift(forced);</a>
<a name="ln2057">            break;</a>
<a name="ln2058">        }                       // switch (you.religion)</a>
<a name="ln2059">    }                           // End of gift giving.</a>
<a name="ln2060"> </a>
<a name="ln2061">    if (success)</a>
<a name="ln2062">        stop_running(false);</a>
<a name="ln2063"> </a>
<a name="ln2064">#if defined(DEBUG_DIAGNOSTICS) || defined(DEBUG_GIFTS)</a>
<a name="ln2065">    if (old_num_current_gifts &lt; you.num_current_gifts[you.religion])</a>
<a name="ln2066">    {</a>
<a name="ln2067">        mprf(MSGCH_DIAGNOSTICS, &quot;Current number of gifts from this god: %d&quot;,</a>
<a name="ln2068">             you.num_current_gifts[you.religion]);</a>
<a name="ln2069">    }</a>
<a name="ln2070">    if (old_num_total_gifts &lt; you.num_total_gifts[you.religion])</a>
<a name="ln2071">    {</a>
<a name="ln2072">        mprf(MSGCH_DIAGNOSTICS, &quot;Total number of gifts from this god: %d&quot;,</a>
<a name="ln2073">             you.num_total_gifts[you.religion]);</a>
<a name="ln2074">    }</a>
<a name="ln2075">#endif</a>
<a name="ln2076">    return success;</a>
<a name="ln2077">}</a>
<a name="ln2078"> </a>
<a name="ln2079">string god_name(god_type which_god, bool long_name)</a>
<a name="ln2080">{</a>
<a name="ln2081">    if (which_god == GOD_JIYVA)</a>
<a name="ln2082">    {</a>
<a name="ln2083">        return god_name_jiyva(long_name) +</a>
<a name="ln2084">               (long_name? &quot; the Shapeless&quot; : &quot;&quot;);</a>
<a name="ln2085">    }</a>
<a name="ln2086"> </a>
<a name="ln2087">    if (long_name)</a>
<a name="ln2088">    {</a>
<a name="ln2089">        const string shortname = god_name(which_god, false);</a>
<a name="ln2090">        const string longname = getMiscString(shortname + &quot; lastname&quot;);</a>
<a name="ln2091">        return longname.empty()? shortname : longname;</a>
<a name="ln2092">    }</a>
<a name="ln2093"> </a>
<a name="ln2094">    switch (which_god)</a>
<a name="ln2095">    {</a>
<a name="ln2096">    case GOD_NO_GOD:        return &quot;No God&quot;;</a>
<a name="ln2097">    case GOD_RANDOM:        return &quot;random&quot;;</a>
<a name="ln2098">    case GOD_NAMELESS:      return &quot;nameless&quot;;</a>
<a name="ln2099">    case GOD_ZIN:           return &quot;Zin&quot;;</a>
<a name="ln2100">    case GOD_SHINING_ONE:   return &quot;the Shining One&quot;;</a>
<a name="ln2101">    case GOD_KIKUBAAQUDGHA: return &quot;Kikubaaqudgha&quot;;</a>
<a name="ln2102">    case GOD_YREDELEMNUL:   return &quot;Yredelemnul&quot;;</a>
<a name="ln2103">    case GOD_VEHUMET:       return &quot;Vehumet&quot;;</a>
<a name="ln2104">    case GOD_OKAWARU:       return &quot;Okawaru&quot;;</a>
<a name="ln2105">    case GOD_MAKHLEB:       return &quot;Makhleb&quot;;</a>
<a name="ln2106">    case GOD_SIF_MUNA:      return &quot;Sif Muna&quot;;</a>
<a name="ln2107">    case GOD_TROG:          return &quot;Trog&quot;;</a>
<a name="ln2108">    case GOD_NEMELEX_XOBEH: return &quot;Nemelex Xobeh&quot;;</a>
<a name="ln2109">    case GOD_ELYVILON:      return &quot;Elyvilon&quot;;</a>
<a name="ln2110">    case GOD_LUGONU:        return &quot;Lugonu&quot;;</a>
<a name="ln2111">    case GOD_BEOGH:         return &quot;Beogh&quot;;</a>
<a name="ln2112">    case GOD_FEDHAS:        return &quot;Fedhas&quot;;</a>
<a name="ln2113">    case GOD_CHEIBRIADOS:   return &quot;Cheibriados&quot;;</a>
<a name="ln2114">    case GOD_XOM:           return &quot;Xom&quot;;</a>
<a name="ln2115">    case GOD_ASHENZARI:     return &quot;Ashenzari&quot;;</a>
<a name="ln2116">    case GOD_DITHMENOS:     return &quot;Dithmenos&quot;;</a>
<a name="ln2117">    case GOD_GOZAG:         return &quot;Gozag&quot;;</a>
<a name="ln2118">    case GOD_QAZLAL:        return &quot;Qazlal&quot;;</a>
<a name="ln2119">    case GOD_RU:            return &quot;Ru&quot;;</a>
<a name="ln2120">#if TAG_MAJOR_VERSION == 34</a>
<a name="ln2121">    case GOD_PAKELLAS:      return &quot;Pakellas&quot;;</a>
<a name="ln2122">#endif</a>
<a name="ln2123">    case GOD_USKAYAW:       return &quot;Uskayaw&quot;;</a>
<a name="ln2124">    case GOD_HEPLIAKLQANA:  return &quot;Hepliaklqana&quot;;</a>
<a name="ln2125">    case GOD_WU_JIAN:     return &quot;Wu Jian&quot;;</a>
<a name="ln2126">    case GOD_JIYVA: // This is handled at the beginning of the function</a>
<a name="ln2127">    case GOD_ECUMENICAL:    return &quot;an unknown god&quot;;</a>
<a name="ln2128">    case NUM_GODS:          return &quot;Buggy&quot;;</a>
<a name="ln2129">    }</a>
<a name="ln2130">    return &quot;&quot;;</a>
<a name="ln2131">}</a>
<a name="ln2132"> </a>
<a name="ln2133">string god_name_jiyva(bool second_name)</a>
<a name="ln2134">{</a>
<a name="ln2135">    string name = &quot;Jiyva&quot;;</a>
<a name="ln2136">    if (second_name)</a>
<a name="ln2137">        name += &quot; &quot; + you.jiyva_second_name;</a>
<a name="ln2138"> </a>
<a name="ln2139">    return name;</a>
<a name="ln2140">}</a>
<a name="ln2141"> </a>
<a name="ln2142">string wu_jian_random_sifu_name()</a>
<a name="ln2143">{</a>
<a name="ln2144">    switch (random2(7))</a>
<a name="ln2145">    {</a>
<a name="ln2146">        case 0: return &quot;Deng Ai&quot;;</a>
<a name="ln2147">        case 1: return &quot;Jiang Wei&quot;;</a>
<a name="ln2148">        case 2: return &quot;Zhang Bao&quot;;</a>
<a name="ln2149">        case 3: return &quot;Ma Yunglu&quot;;</a>
<a name="ln2150">        case 4: return &quot;Sun Luban&quot;;</a>
<a name="ln2151">        case 5: return &quot;Gene Jian Bin&quot;;</a>
<a name="ln2152">        case 6: return &quot;Cai Fang&quot;;</a>
<a name="ln2153">        default: return &quot;Bug&quot;;</a>
<a name="ln2154">    }</a>
<a name="ln2155">}</a>
<a name="ln2156"> </a>
<a name="ln2157">god_type str_to_god(const string &amp;_name, bool exact)</a>
<a name="ln2158">{</a>
<a name="ln2159">    string target(_name);</a>
<a name="ln2160">    trim_string(target);</a>
<a name="ln2161">    lowercase(target);</a>
<a name="ln2162"> </a>
<a name="ln2163">    if (target.empty())</a>
<a name="ln2164">        return GOD_NO_GOD;</a>
<a name="ln2165"> </a>
<a name="ln2166">    int      num_partials = 0;</a>
<a name="ln2167">    god_type partial      = GOD_NO_GOD;</a>
<a name="ln2168">    for (god_iterator it; it; ++it)</a>
<a name="ln2169">    {</a>
<a name="ln2170">        god_type god = *it;</a>
<a name="ln2171">        string name = lowercase_string(god_name(god, false));</a>
<a name="ln2172"> </a>
<a name="ln2173">        if (name == target)</a>
<a name="ln2174">            return god;</a>
<a name="ln2175"> </a>
<a name="ln2176">        if (!exact &amp;&amp; name.find(target) != string::npos)</a>
<a name="ln2177">        {</a>
<a name="ln2178">            // Return nothing for ambiguous partial names.</a>
<a name="ln2179">            num_partials++;</a>
<a name="ln2180">            if (num_partials &gt; 1)</a>
<a name="ln2181">                return GOD_NO_GOD;</a>
<a name="ln2182">            partial = god;</a>
<a name="ln2183">        }</a>
<a name="ln2184">    }</a>
<a name="ln2185"> </a>
<a name="ln2186">    if (!exact &amp;&amp; num_partials == 1)</a>
<a name="ln2187">        return partial;</a>
<a name="ln2188"> </a>
<a name="ln2189">    return GOD_NO_GOD;</a>
<a name="ln2190">}</a>
<a name="ln2191"> </a>
<a name="ln2192">void god_speaks(god_type god, const char *mesg)</a>
<a name="ln2193">{</a>
<a name="ln2194">    ASSERT(!crawl_state.game_is_arena());</a>
<a name="ln2195"> </a>
<a name="ln2196">    int orig_mon = mgrd(you.pos());</a>
<a name="ln2197"> </a>
<a name="ln2198">    monster fake_mon;</a>
<a name="ln2199">    fake_mon.type       = MONS_PROGRAM_BUG;</a>
<a name="ln2200">    fake_mon.mid        = MID_NOBODY;</a>
<a name="ln2201">    fake_mon.hit_points = 1;</a>
<a name="ln2202">    fake_mon.god        = god;</a>
<a name="ln2203">    fake_mon.set_position(you.pos());</a>
<a name="ln2204">    fake_mon.foe        = MHITYOU;</a>
<a name="ln2205">    fake_mon.mname      = &quot;FAKE GOD MONSTER&quot;;</a>
<a name="ln2206"> </a>
<a name="ln2207">    mprf(MSGCH_GOD, god, &quot;%s&quot;, do_mon_str_replacements(mesg, fake_mon).c_str());</a>
<a name="ln2208"> </a>
<a name="ln2209">    fake_mon.reset();</a>
<a name="ln2210">    mgrd(you.pos()) = orig_mon;</a>
<a name="ln2211">}</a>
<a name="ln2212"> </a>
<a name="ln2213">void religion_turn_start()</a>
<a name="ln2214">{</a>
<a name="ln2215">    if (you.turn_is_over)</a>
<a name="ln2216">        religion_turn_end();</a>
<a name="ln2217"> </a>
<a name="ln2218">    crawl_state.clear_god_acting();</a>
<a name="ln2219">}</a>
<a name="ln2220"> </a>
<a name="ln2221">void religion_turn_end()</a>
<a name="ln2222">{</a>
<a name="ln2223">    ASSERT(you.turn_is_over);</a>
<a name="ln2224">    _place_delayed_monsters();</a>
<a name="ln2225">}</a>
<a name="ln2226"> </a>
<a name="ln2227">/** Punish the character for some divine transgression.</a>
<a name="ln2228"> *</a>
<a name="ln2229"> * @param piety_loss The amount of penance imposed; may be scaled.</a>
<a name="ln2230"> * @param penance The amount of penance imposed; may be scaled.</a>
<a name="ln2231"> */</a>
<a name="ln2232">void dock_piety(int piety_loss, int penance)</a>
<a name="ln2233">{</a>
<a name="ln2234">    static int last_piety_lecture   = -1;</a>
<a name="ln2235">    static int last_penance_lecture = -1;</a>
<a name="ln2236"> </a>
<a name="ln2237">    if (piety_loss &lt;= 0 &amp;&amp; penance &lt;= 0)</a>
<a name="ln2238">        return;</a>
<a name="ln2239"> </a>
<a name="ln2240">    piety_loss = piety_scale(piety_loss);</a>
<a name="ln2241">    penance    = piety_scale(penance);</a>
<a name="ln2242"> </a>
<a name="ln2243">    if (piety_loss)</a>
<a name="ln2244">    {</a>
<a name="ln2245">        if (last_piety_lecture != you.num_turns)</a>
<a name="ln2246">        {</a>
<a name="ln2247">            // output guilt message:</a>
<a name="ln2248">            mprf(&quot;You feel%sguilty.&quot;,</a>
<a name="ln2249">                 (piety_loss == 1) ? &quot; a little &quot; :</a>
<a name="ln2250">                 (piety_loss &lt;  5) ? &quot; &quot; :</a>
<a name="ln2251">                 (piety_loss &lt; 10) ? &quot; very &quot;</a>
<a name="ln2252">                                   : &quot; extremely &quot;);</a>
<a name="ln2253">        }</a>
<a name="ln2254"> </a>
<a name="ln2255">        last_piety_lecture = you.num_turns;</a>
<a name="ln2256">        lose_piety(piety_loss);</a>
<a name="ln2257">    }</a>
<a name="ln2258"> </a>
<a name="ln2259">    if (you.piety &lt; 1)</a>
<a name="ln2260">        excommunication();</a>
<a name="ln2261">    else if (penance)       // only if still in religion</a>
<a name="ln2262">    {</a>
<a name="ln2263">        if (last_penance_lecture != you.num_turns)</a>
<a name="ln2264">        {</a>
<a name="ln2265">            god_speaks(you.religion,</a>
<a name="ln2266">                       &quot;\&quot;You will pay for your transgression, mortal!\&quot;&quot;);</a>
<a name="ln2267">        }</a>
<a name="ln2268">        last_penance_lecture = you.num_turns;</a>
<a name="ln2269">        _inc_penance(penance);</a>
<a name="ln2270">    }</a>
<a name="ln2271">}</a>
<a name="ln2272"> </a>
<a name="ln2273">// Scales a piety number, applying modifiers (faith).</a>
<a name="ln2274">int piety_scale(int piety)</a>
<a name="ln2275">{</a>
<a name="ln2276">    return piety + (you.faith() * div_rand_round(piety, 4));</a>
<a name="ln2277">}</a>
<a name="ln2278"> </a>
<a name="ln2279">/** Gain or lose piety to reach a certain value.</a>
<a name="ln2280"> *</a>
<a name="ln2281"> * If the player cannot gain piety (because they worship Xom, Gozag, or</a>
<a name="ln2282"> * no god), their piety will be unchanged.</a>
<a name="ln2283"> *</a>
<a name="ln2284"> * @param piety The new piety value.</a>
<a name="ln2285"> * @pre piety is between 0 and MAX_PIETY, inclusive.</a>
<a name="ln2286"> */</a>
<a name="ln2287">void set_piety(int piety)</a>
<a name="ln2288">{</a>
<a name="ln2289">    ASSERT(piety &gt;= 0);</a>
<a name="ln2290">    ASSERT(piety &lt;= MAX_PIETY);</a>
<a name="ln2291"> </a>
<a name="ln2292">    // Ru max piety is 6*</a>
<a name="ln2293">    if (you_worship(GOD_RU) &amp;&amp; piety &gt; piety_breakpoint(5))</a>
<a name="ln2294">        piety = piety_breakpoint(5);</a>
<a name="ln2295"> </a>
<a name="ln2296">    // We have to set the exact piety value this way, because diff may</a>
<a name="ln2297">    // be decreased to account for things like penance and gift timeout.</a>
<a name="ln2298">    int diff;</a>
<a name="ln2299">    do</a>
<a name="ln2300">    {</a>
<a name="ln2301">        diff = piety - you.piety;</a>
<a name="ln2302">        if (diff &gt; 0)</a>
<a name="ln2303">        {</a>
<a name="ln2304">            if (!gain_piety(diff, 1, false))</a>
<a name="ln2305">                break;</a>
<a name="ln2306">        }</a>
<a name="ln2307">        else if (diff &lt; 0)</a>
<a name="ln2308">            lose_piety(-diff);</a>
<a name="ln2309">    }</a>
<a name="ln2310">    while (diff != 0);</a>
<a name="ln2311">}</a>
<a name="ln2312"> </a>
<a name="ln2313">static void _gain_piety_point()</a>
<a name="ln2314">{</a>
<a name="ln2315">    // check to see if we owe anything first</a>
<a name="ln2316">    if (player_under_penance(you.religion))</a>
<a name="ln2317">    {</a>
<a name="ln2318">        dec_penance(1);</a>
<a name="ln2319">        return;</a>
<a name="ln2320">    }</a>
<a name="ln2321">    else if (you.gift_timeout &gt; 0)</a>
<a name="ln2322">    {</a>
<a name="ln2323">        you.gift_timeout--;</a>
<a name="ln2324"> </a>
<a name="ln2325">        // Slow down piety gain to account for the fact that gifts</a>
<a name="ln2326">        // no longer have a piety cost for getting them.</a>
<a name="ln2327">        // Jiyva is an exception because there's usually a time-out and</a>
<a name="ln2328">        // the gifts aren't that precious.</a>
<a name="ln2329">        if (!one_chance_in(4) &amp;&amp; !you_worship(GOD_JIYVA)</a>
<a name="ln2330">            &amp;&amp; !you_worship(GOD_NEMELEX_XOBEH))</a>
<a name="ln2331">        {</a>
<a name="ln2332">#ifdef DEBUG_PIETY</a>
<a name="ln2333">            mprf(MSGCH_DIAGNOSTICS, &quot;Piety slowdown due to gift timeout.&quot;);</a>
<a name="ln2334">#endif</a>
<a name="ln2335">            return;</a>
<a name="ln2336">        }</a>
<a name="ln2337">    }</a>
<a name="ln2338"> </a>
<a name="ln2339">    // slow down gain at upper levels of piety</a>
<a name="ln2340">    if (!you_worship(GOD_RU))</a>
<a name="ln2341">    {</a>
<a name="ln2342">        if (you.piety &gt;= MAX_PIETY</a>
<a name="ln2343">            || you.piety &gt;= piety_breakpoint(5) &amp;&amp; one_chance_in(3)</a>
<a name="ln2344">            || you.piety &gt;= piety_breakpoint(3) &amp;&amp; one_chance_in(3))</a>
<a name="ln2345">        {</a>
<a name="ln2346">            do_god_gift();</a>
<a name="ln2347">            return;</a>
<a name="ln2348">        }</a>
<a name="ln2349">    }</a>
<a name="ln2350">    else</a>
<a name="ln2351">    {</a>
<a name="ln2352">      // Ru piety doesn't modulate or taper and Ru doesn't give gifts.</a>
<a name="ln2353">      // Ru max piety is 160 (6*)</a>
<a name="ln2354">      if (you.piety &gt;= piety_breakpoint(5))</a>
<a name="ln2355">          return;</a>
<a name="ln2356">    }</a>
<a name="ln2357"> </a>
<a name="ln2358">    int old_piety = you.piety;</a>
<a name="ln2359">    // Apply hysteresis.</a>
<a name="ln2360">    // piety_hysteresis is the amount of _loss_ stored up, so this</a>
<a name="ln2361">    // may look backwards.</a>
<a name="ln2362">    if (you.piety_hysteresis)</a>
<a name="ln2363">        you.piety_hysteresis--;</a>
<a name="ln2364">    else if (you.piety &lt; MAX_PIETY)</a>
<a name="ln2365">        you.piety++;</a>
<a name="ln2366"> </a>
<a name="ln2367">    if (piety_rank() &gt; piety_rank(old_piety))</a>
<a name="ln2368">    {</a>
<a name="ln2369">        // Redraw piety display and, in case the best skill is Invocations,</a>
<a name="ln2370">        // redraw the god title.</a>
<a name="ln2371">        you.redraw_title = true;</a>
<a name="ln2372"> </a>
<a name="ln2373">        const int rank = piety_rank();</a>
<a name="ln2374">        take_note(Note(NOTE_PIETY_RANK, you.religion, rank));</a>
<a name="ln2375">        for (const auto&amp; power : get_god_powers(you.religion))</a>
<a name="ln2376">        {</a>
<a name="ln2377">            if (power.rank == rank</a>
<a name="ln2378">                || power.rank == 7 &amp;&amp; can_do_capstone_ability(you.religion))</a>
<a name="ln2379">            {</a>
<a name="ln2380">                power.display(true, &quot;You can now %s.&quot;);</a>
<a name="ln2381">#ifdef USE_TILE_LOCAL</a>
<a name="ln2382">                tiles.layout_statcol();</a>
<a name="ln2383">                redraw_screen();</a>
<a name="ln2384">#endif</a>
<a name="ln2385">                learned_something_new(HINT_NEW_ABILITY_GOD);</a>
<a name="ln2386">                // Preserve the old hotkey</a>
<a name="ln2387">                if (power.abil == ABIL_YRED_ANIMATE_DEAD)</a>
<a name="ln2388">                {</a>
<a name="ln2389">                    replace(begin(you.ability_letter_table),</a>
<a name="ln2390">                            end(you.ability_letter_table),</a>
<a name="ln2391">                            ABIL_YRED_ANIMATE_REMAINS, ABIL_YRED_ANIMATE_DEAD);</a>
<a name="ln2392">                }</a>
<a name="ln2393">            }</a>
<a name="ln2394">        }</a>
<a name="ln2395">        if (rank == rank_for_passive(passive_t::halo))</a>
<a name="ln2396">            mprf(MSGCH_GOD, &quot;A divine halo surrounds you!&quot;);</a>
<a name="ln2397">        if (rank == rank_for_passive(passive_t::umbra))</a>
<a name="ln2398">            mprf(MSGCH_GOD, &quot;You are shrouded in an aura of darkness!&quot;);</a>
<a name="ln2399">        if (rank == rank_for_passive(passive_t::sinv))</a>
<a name="ln2400">            autotoggle_autopickup(false);</a>
<a name="ln2401">        if (rank == rank_for_passive(passive_t::clarity))</a>
<a name="ln2402">        {</a>
<a name="ln2403">            // Inconsistent with donning amulets, but matches the</a>
<a name="ln2404">            // message better and is not abusable.</a>
<a name="ln2405">            you.duration[DUR_CONF] = 0;</a>
<a name="ln2406">        }</a>
<a name="ln2407">        if (rank &gt;= rank_for_passive(passive_t::identify_items))</a>
<a name="ln2408">            auto_id_inventory();</a>
<a name="ln2409"> </a>
<a name="ln2410">        // TODO: add one-time ability check in have_passive</a>
<a name="ln2411">        if (have_passive(passive_t::unlock_slime_vaults) &amp;&amp; can_do_capstone_ability(you.religion))</a>
<a name="ln2412">        {</a>
<a name="ln2413">            simple_god_message(&quot; will now unseal the treasures of the &quot;</a>
<a name="ln2414">                               &quot;Slime Pits.&quot;);</a>
<a name="ln2415">            dlua.callfn(&quot;dgn_set_persistent_var&quot;, &quot;sb&quot;,</a>
<a name="ln2416">                        &quot;fix_slime_vaults&quot;, true);</a>
<a name="ln2417">            // If we're on Slime:$, pretend we just entered the level</a>
<a name="ln2418">            // in order to bring down the vault walls.</a>
<a name="ln2419">            if (level_id::current() == level_id(BRANCH_SLIME, brdepth[BRANCH_SLIME]))</a>
<a name="ln2420">                dungeon_events.fire_event(DET_ENTERED_LEVEL);</a>
<a name="ln2421"> </a>
<a name="ln2422">            you.one_time_ability_used.set(you.religion);</a>
<a name="ln2423">        }</a>
<a name="ln2424">        if (you_worship(GOD_HEPLIAKLQANA)</a>
<a name="ln2425">            &amp;&amp; rank == 2 &amp;&amp; !you.props.exists(HEPLIAKLQANA_ALLY_TYPE_KEY))</a>
<a name="ln2426">        {</a>
<a name="ln2427">           god_speaks(you.religion,</a>
<a name="ln2428">                      &quot;You may now remember your ancestor's life.&quot;);</a>
<a name="ln2429">        }</a>
<a name="ln2430">    }</a>
<a name="ln2431"> </a>
<a name="ln2432">    // The player's symbol depends on Beogh piety.</a>
<a name="ln2433">    if (you_worship(GOD_BEOGH))</a>
<a name="ln2434">        update_player_symbol();</a>
<a name="ln2435"> </a>
<a name="ln2436">    if (have_passive(passive_t::stat_boost)</a>
<a name="ln2437">        &amp;&amp; chei_stat_boost(old_piety) &lt; chei_stat_boost())</a>
<a name="ln2438">    {</a>
<a name="ln2439">        string msg = &quot; raises the support of your attributes&quot;;</a>
<a name="ln2440">        if (have_passive(passive_t::slowed))</a>
<a name="ln2441">            msg += &quot; as your movement slows&quot;;</a>
<a name="ln2442">        msg += &quot;.&quot;;</a>
<a name="ln2443">        simple_god_message(msg.c_str());</a>
<a name="ln2444">        notify_stat_change();</a>
<a name="ln2445">    }</a>
<a name="ln2446"> </a>
<a name="ln2447">    if (you_worship(GOD_QAZLAL)</a>
<a name="ln2448">        &amp;&amp; qazlal_sh_boost(old_piety) != qazlal_sh_boost())</a>
<a name="ln2449">    {</a>
<a name="ln2450">        you.redraw_armour_class = true;</a>
<a name="ln2451">    }</a>
<a name="ln2452"> </a>
<a name="ln2453">    if (have_passive(passive_t::halo) || have_passive(passive_t::umbra))</a>
<a name="ln2454">    {</a>
<a name="ln2455">        // Piety change affects halo / umbra radius.</a>
<a name="ln2456">        invalidate_agrid(true);</a>
<a name="ln2457">    }</a>
<a name="ln2458"> </a>
<a name="ln2459">    do_god_gift();</a>
<a name="ln2460">}</a>
<a name="ln2461"> </a>
<a name="ln2462">/**</a>
<a name="ln2463"> * Gain an amount of piety.</a>
<a name="ln2464"> *</a>
<a name="ln2465"> * @param original_gain The numerator of the nominal piety gain.</a>
<a name="ln2466"> * @param denominator The denominator of the nominal piety gain.</a>
<a name="ln2467"> * @param should_scale_piety Should the piety gain be scaled by faith/Sprint?</a>
<a name="ln2468"> * @return True if something happened, or if another call with the same</a>
<a name="ln2469"> *   arguments might cause something to happen (because of random number</a>
<a name="ln2470"> *   rolls).</a>
<a name="ln2471"> */</a>
<a name="ln2472">bool gain_piety(int original_gain, int denominator, bool should_scale_piety)</a>
<a name="ln2473">{</a>
<a name="ln2474">    if (original_gain &lt;= 0)</a>
<a name="ln2475">        return false;</a>
<a name="ln2476"> </a>
<a name="ln2477">    // Xom uses piety differently; Gozag doesn't at all.</a>
<a name="ln2478">    if (you_worship(GOD_NO_GOD)</a>
<a name="ln2479">        || you_worship(GOD_XOM)</a>
<a name="ln2480">        || you_worship(GOD_GOZAG))</a>
<a name="ln2481">    {</a>
<a name="ln2482">        return false;</a>
<a name="ln2483">    }</a>
<a name="ln2484"> </a>
<a name="ln2485">    int pgn = should_scale_piety ? piety_scale(original_gain) : original_gain;</a>
<a name="ln2486"> </a>
<a name="ln2487">    if (crawl_state.game_is_sprint() &amp;&amp; should_scale_piety)</a>
<a name="ln2488">        pgn = sprint_modify_piety(pgn);</a>
<a name="ln2489"> </a>
<a name="ln2490">    pgn = div_rand_round(pgn, denominator);</a>
<a name="ln2491">    while (pgn-- &gt; 0)</a>
<a name="ln2492">        _gain_piety_point();</a>
<a name="ln2493">    if (you.piety &gt; you.piety_max[you.religion])</a>
<a name="ln2494">    {</a>
<a name="ln2495">        if (you.piety &gt;= piety_breakpoint(5)</a>
<a name="ln2496">            &amp;&amp; you.piety_max[you.religion] &lt; piety_breakpoint(5))</a>
<a name="ln2497">        {</a>
<a name="ln2498">            mark_milestone(&quot;god.maxpiety&quot;, &quot;became the Champion of &quot;</a>
<a name="ln2499">                           + god_name(you.religion) + &quot;.&quot;);</a>
<a name="ln2500">        }</a>
<a name="ln2501">        you.piety_max[you.religion] = you.piety;</a>
<a name="ln2502">    }</a>
<a name="ln2503">    return true;</a>
<a name="ln2504">}</a>
<a name="ln2505"> </a>
<a name="ln2506">/** Reduce piety and handle side-effects.</a>
<a name="ln2507"> *</a>
<a name="ln2508"> * Appropriate for cases where the player has not sinned, but must lose piety</a>
<a name="ln2509"> * anyway, such as costs for abilities.</a>
<a name="ln2510"> *</a>
<a name="ln2511"> * @param pgn The precise amount of piety lost.</a>
<a name="ln2512"> */</a>
<a name="ln2513">void lose_piety(int pgn)</a>
<a name="ln2514">{</a>
<a name="ln2515">    if (pgn &lt;= 0)</a>
<a name="ln2516">        return;</a>
<a name="ln2517"> </a>
<a name="ln2518">    const int old_piety = you.piety;</a>
<a name="ln2519"> </a>
<a name="ln2520">    // Apply hysteresis.</a>
<a name="ln2521">    const int old_hysteresis = you.piety_hysteresis;</a>
<a name="ln2522">    you.piety_hysteresis = min&lt;int&gt;(PIETY_HYSTERESIS_LIMIT,</a>
<a name="ln2523">                                    you.piety_hysteresis + pgn);</a>
<a name="ln2524">    const int pgn_borrowed = (you.piety_hysteresis - old_hysteresis);</a>
<a name="ln2525">    pgn -= pgn_borrowed;</a>
<a name="ln2526">#ifdef DEBUG_PIETY</a>
<a name="ln2527">    mprf(MSGCH_DIAGNOSTICS,</a>
<a name="ln2528">         &quot;Piety decreasing by %d (and %d added to hysteresis)&quot;,</a>
<a name="ln2529">         pgn, pgn_borrowed);</a>
<a name="ln2530">#endif</a>
<a name="ln2531"> </a>
<a name="ln2532">    if (you.piety - pgn &lt; 0)</a>
<a name="ln2533">        you.piety = 0;</a>
<a name="ln2534">    else</a>
<a name="ln2535">        you.piety -= pgn;</a>
<a name="ln2536"> </a>
<a name="ln2537">    // Don't bother printing out these messages if you're under</a>
<a name="ln2538">    // penance, you wouldn't notice since all these abilities</a>
<a name="ln2539">    // are withheld.</a>
<a name="ln2540">    if (!player_under_penance()</a>
<a name="ln2541">        &amp;&amp; piety_rank(old_piety) &gt; piety_rank())</a>
<a name="ln2542">    {</a>
<a name="ln2543">        // Redraw piety display and, in case the best skill is Invocations,</a>
<a name="ln2544">        // redraw the god title.</a>
<a name="ln2545">        you.redraw_title = true;</a>
<a name="ln2546"> </a>
<a name="ln2547">        const int old_rank = piety_rank(old_piety);</a>
<a name="ln2548"> </a>
<a name="ln2549">        for (const auto&amp; power : get_god_powers(you.religion))</a>
<a name="ln2550">        {</a>
<a name="ln2551">            if (power.rank == old_rank</a>
<a name="ln2552">                || power.rank == 7 &amp;&amp; old_rank == 6</a>
<a name="ln2553">                   &amp;&amp; !you.one_time_ability_used[you.religion])</a>
<a name="ln2554">            {</a>
<a name="ln2555">                power.display(false, &quot;You can no longer %s.&quot;);</a>
<a name="ln2556">                // Preserve the old hotkey</a>
<a name="ln2557">                if (power.abil == ABIL_YRED_ANIMATE_DEAD)</a>
<a name="ln2558">                {</a>
<a name="ln2559">                    replace(begin(you.ability_letter_table),</a>
<a name="ln2560">                            end(you.ability_letter_table),</a>
<a name="ln2561">                            ABIL_YRED_ANIMATE_DEAD, ABIL_YRED_ANIMATE_REMAINS);</a>
<a name="ln2562">                }</a>
<a name="ln2563">#if TAG_MAJOR_VERSION == 34</a>
<a name="ln2564">                // Deactivate the toggle</a>
<a name="ln2565">                if (power.abil == ABIL_SIF_MUNA_DIVINE_ENERGY)</a>
<a name="ln2566">                    you.attribute[ATTR_DIVINE_ENERGY] = 0;</a>
<a name="ln2567">#endif</a>
<a name="ln2568">            }</a>
<a name="ln2569">        }</a>
<a name="ln2570">#ifdef USE_TILE_LOCAL</a>
<a name="ln2571">        tiles.layout_statcol();</a>
<a name="ln2572">        redraw_screen();</a>
<a name="ln2573">#endif</a>
<a name="ln2574">    }</a>
<a name="ln2575"> </a>
<a name="ln2576">    if (you.piety &gt; 0 &amp;&amp; you.piety &lt;= 5)</a>
<a name="ln2577">        learned_something_new(HINT_GOD_DISPLEASED);</a>
<a name="ln2578"> </a>
<a name="ln2579">    if (will_have_passive(passive_t::water_walk) &amp;&amp; _need_water_walking()</a>
<a name="ln2580">        &amp;&amp; !have_passive(passive_t::water_walk))</a>
<a name="ln2581">    {</a>
<a name="ln2582">        _grant_temporary_waterwalk();</a>
<a name="ln2583">    }</a>
<a name="ln2584">    if (will_have_passive(passive_t::stat_boost)</a>
<a name="ln2585">        &amp;&amp; chei_stat_boost(old_piety) &gt; chei_stat_boost())</a>
<a name="ln2586">    {</a>
<a name="ln2587">        string msg = &quot; lowers the support of your attributes&quot;;</a>
<a name="ln2588">        if (will_have_passive(passive_t::slowed))</a>
<a name="ln2589">            msg += &quot; as your movement quickens&quot;;</a>
<a name="ln2590">        msg += &quot;.&quot;;</a>
<a name="ln2591">        simple_god_message(msg.c_str());</a>
<a name="ln2592">        notify_stat_change();</a>
<a name="ln2593">    }</a>
<a name="ln2594"> </a>
<a name="ln2595">    if (you_worship(GOD_QAZLAL)</a>
<a name="ln2596">        &amp;&amp; qazlal_sh_boost(old_piety) != qazlal_sh_boost())</a>
<a name="ln2597">    {</a>
<a name="ln2598">        you.redraw_armour_class = true;</a>
<a name="ln2599">    }</a>
<a name="ln2600"> </a>
<a name="ln2601">    if (will_have_passive(passive_t::halo)</a>
<a name="ln2602">        || will_have_passive(passive_t::umbra))</a>
<a name="ln2603">    {</a>
<a name="ln2604">        // Piety change affects halo / umbra radius.</a>
<a name="ln2605">        invalidate_agrid(true);</a>
<a name="ln2606">    }</a>
<a name="ln2607">}</a>
<a name="ln2608"> </a>
<a name="ln2609">// Fedhas worshipers are on the hook for most plants and fungi</a>
<a name="ln2610">//</a>
<a name="ln2611">// If fedhas worshipers kill a protected monster they lose piety,</a>
<a name="ln2612">// if they attack a friendly one they get penance,</a>
<a name="ln2613">// if a friendly one dies they lose piety.</a>
<a name="ln2614">static bool _fedhas_protects_species(monster_type mc)</a>
<a name="ln2615">{</a>
<a name="ln2616">    return mons_class_is_plant(mc)</a>
<a name="ln2617">           &amp;&amp; mons_class_holiness(mc) &amp; MH_PLANT;</a>
<a name="ln2618">}</a>
<a name="ln2619"> </a>
<a name="ln2620">bool fedhas_protects(const monster *target)</a>
<a name="ln2621">{</a>
<a name="ln2622">    return target</a>
<a name="ln2623">        ? _fedhas_protects_species(mons_base_type(*target))</a>
<a name="ln2624">        : false;</a>
<a name="ln2625">}</a>
<a name="ln2626"> </a>
<a name="ln2627">// Fedhas neutralises most plants and fungi</a>
<a name="ln2628">bool fedhas_neutralises(const monster&amp; target)</a>
<a name="ln2629">{</a>
<a name="ln2630">    return mons_is_plant(target)</a>
<a name="ln2631">           &amp;&amp; target.holiness() &amp; MH_PLANT</a>
<a name="ln2632">           &amp;&amp; target.type != MONS_SNAPLASHER_VINE</a>
<a name="ln2633">           &amp;&amp; target.type != MONS_SNAPLASHER_VINE_SEGMENT;</a>
<a name="ln2634">}</a>
<a name="ln2635"> </a>
<a name="ln2636">static string _god_hates_your_god_reaction(god_type god, god_type your_god)</a>
<a name="ln2637">{</a>
<a name="ln2638">    if (god_hates_your_god(god, your_god))</a>
<a name="ln2639">    {</a>
<a name="ln2640">        // Non-good gods always hate your current god.</a>
<a name="ln2641">        if (!is_good_god(god))</a>
<a name="ln2642">            return &quot;&quot;;</a>
<a name="ln2643"> </a>
<a name="ln2644">        // Zin hates chaotic gods.</a>
<a name="ln2645">        if (god == GOD_ZIN &amp;&amp; is_chaotic_god(your_god))</a>
<a name="ln2646">            return &quot; for chaos&quot;;</a>
<a name="ln2647"> </a>
<a name="ln2648">        if (is_evil_god(your_god))</a>
<a name="ln2649">            return &quot; for evil&quot;;</a>
<a name="ln2650">    }</a>
<a name="ln2651"> </a>
<a name="ln2652">    return &quot;&quot;;</a>
<a name="ln2653">}</a>
<a name="ln2654"> </a>
<a name="ln2655">/**</a>
<a name="ln2656"> * When you abandon this god, how much penance do you gain? (How long does the</a>
<a name="ln2657"> * wrath last?</a>
<a name="ln2658"> *</a>
<a name="ln2659"> * @param god   The god in question.</a>
<a name="ln2660"> * @return      The initial penance for the given god's wrath.</a>
<a name="ln2661"> */</a>
<a name="ln2662">int initial_wrath_penance_for(god_type god)</a>
<a name="ln2663">{</a>
<a name="ln2664">    // TODO: transform to data (tables)</a>
<a name="ln2665">    switch (god)</a>
<a name="ln2666">    {</a>
<a name="ln2667">        case GOD_ASHENZARI:</a>
<a name="ln2668">        case GOD_BEOGH:</a>
<a name="ln2669">        case GOD_ELYVILON:</a>
<a name="ln2670">        case GOD_GOZAG:</a>
<a name="ln2671">        case GOD_HEPLIAKLQANA:</a>
<a name="ln2672">        case GOD_LUGONU:</a>
<a name="ln2673">        case GOD_NEMELEX_XOBEH:</a>
<a name="ln2674">        case GOD_TROG:</a>
<a name="ln2675">        case GOD_XOM:</a>
<a name="ln2676">            return 50;</a>
<a name="ln2677">        case GOD_FEDHAS:</a>
<a name="ln2678">        case GOD_KIKUBAAQUDGHA:</a>
<a name="ln2679">        case GOD_JIYVA:</a>
<a name="ln2680">        case GOD_SHINING_ONE:</a>
<a name="ln2681">        case GOD_SIF_MUNA:</a>
<a name="ln2682">        case GOD_YREDELEMNUL:</a>
<a name="ln2683">            return 30;</a>
<a name="ln2684">        case GOD_CHEIBRIADOS:</a>
<a name="ln2685">        case GOD_DITHMENOS:</a>
<a name="ln2686">        case GOD_MAKHLEB:</a>
<a name="ln2687">#if TAG_MAJOR_VERSION == 34</a>
<a name="ln2688">        case GOD_PAKELLAS:</a>
<a name="ln2689">#endif</a>
<a name="ln2690">        case GOD_QAZLAL:</a>
<a name="ln2691">        case GOD_VEHUMET:</a>
<a name="ln2692">        case GOD_ZIN:</a>
<a name="ln2693">        default:</a>
<a name="ln2694">            return 25;</a>
<a name="ln2695">    }</a>
<a name="ln2696">}</a>
<a name="ln2697"> </a>
<a name="ln2698">void excommunication(bool voluntary, god_type new_god)</a>
<a name="ln2699">{</a>
<a name="ln2700">    const god_type old_god = you.religion;</a>
<a name="ln2701">    ASSERT(old_god != new_god);</a>
<a name="ln2702">    ASSERT(old_god != GOD_NO_GOD);</a>
<a name="ln2703"> </a>
<a name="ln2704">    const bool had_halo       = have_passive(passive_t::halo);</a>
<a name="ln2705">    const bool had_umbra      = have_passive(passive_t::umbra);</a>
<a name="ln2706">    const bool had_water_walk = have_passive(passive_t::water_walk);</a>
<a name="ln2707">    const bool had_stat_boost = have_passive(passive_t::stat_boost);</a>
<a name="ln2708">    const int  old_piety      = you.piety;</a>
<a name="ln2709"> </a>
<a name="ln2710">    god_acting gdact(old_god, true);</a>
<a name="ln2711"> </a>
<a name="ln2712">    take_note(Note(NOTE_LOSE_GOD, old_god));</a>
<a name="ln2713"> </a>
<a name="ln2714">    you.duration[DUR_PIETY_POOL] = 0; // your loss</a>
<a name="ln2715">    you.duration[DUR_RECITE] = 0;</a>
<a name="ln2716">    you.piety = 0;</a>
<a name="ln2717">    you.piety_hysteresis = 0;</a>
<a name="ln2718"> </a>
<a name="ln2719">    // so that the player isn't punished for &quot;switching&quot; between good gods via aX</a>
<a name="ln2720">    if (is_good_god(old_god) &amp;&amp; voluntary)</a>
<a name="ln2721">    {</a>
<a name="ln2722">        you.saved_good_god_piety = old_piety;</a>
<a name="ln2723">        you.previous_good_god = old_god;</a>
<a name="ln2724">    }</a>
<a name="ln2725">    else</a>
<a name="ln2726">    {</a>
<a name="ln2727">        you.saved_good_god_piety = 0;</a>
<a name="ln2728">        you.previous_good_god = GOD_NO_GOD;</a>
<a name="ln2729">    }</a>
<a name="ln2730"> </a>
<a name="ln2731">    if (old_god == GOD_ASHENZARI)</a>
<a name="ln2732">        ash_init_bondage(&amp;you);</a>
<a name="ln2733"> </a>
<a name="ln2734">    you.num_current_gifts[old_god] = 0;</a>
<a name="ln2735"> </a>
<a name="ln2736">    you.religion = GOD_NO_GOD;</a>
<a name="ln2737"> </a>
<a name="ln2738">    you.redraw_title = true;</a>
<a name="ln2739"> </a>
<a name="ln2740">    // Renouncing may have changed the conducts on our wielded or</a>
<a name="ln2741">    // quivered weapons, so refresh the display.</a>
<a name="ln2742">    you.wield_change = true;</a>
<a name="ln2743">    you.redraw_quiver = true;</a>
<a name="ln2744"> </a>
<a name="ln2745">    mpr(&quot;You have lost your religion!&quot;);</a>
<a name="ln2746">    // included in default force_more_message</a>
<a name="ln2747"> </a>
<a name="ln2748">    if (old_god == GOD_BEOGH)</a>
<a name="ln2749">    {</a>
<a name="ln2750">        // The player's symbol depends on Beogh worship.</a>
<a name="ln2751">        update_player_symbol();</a>
<a name="ln2752">    }</a>
<a name="ln2753"> </a>
<a name="ln2754">    mark_milestone(&quot;god.renounce&quot;, &quot;abandoned &quot; + god_name(old_god) + &quot;.&quot;);</a>
<a name="ln2755">#ifdef DGL_WHEREIS</a>
<a name="ln2756">    whereis_record();</a>
<a name="ln2757">#endif</a>
<a name="ln2758"> </a>
<a name="ln2759">    if (god_hates_your_god(old_god, new_god))</a>
<a name="ln2760">    {</a>
<a name="ln2761">        simple_god_message(</a>
<a name="ln2762">            make_stringf(&quot; does not appreciate desertion%s!&quot;,</a>
<a name="ln2763">                         _god_hates_your_god_reaction(old_god, new_god).c_str()).c_str(),</a>
<a name="ln2764">            old_god);</a>
<a name="ln2765">    }</a>
<a name="ln2766"> </a>
<a name="ln2767">    if (had_halo)</a>
<a name="ln2768">    {</a>
<a name="ln2769">        mprf(MSGCH_GOD, old_god, &quot;Your divine halo fades away.&quot;);</a>
<a name="ln2770">        invalidate_agrid(true);</a>
<a name="ln2771">    }</a>
<a name="ln2772">    if (had_umbra)</a>
<a name="ln2773">    {</a>
<a name="ln2774">        mprf(MSGCH_GOD, old_god, &quot;Your aura of darkness fades away.&quot;);</a>
<a name="ln2775">        invalidate_agrid(true);</a>
<a name="ln2776">    }</a>
<a name="ln2777">    // You might have lost water walking at a bad time...</a>
<a name="ln2778">    if (had_water_walk &amp;&amp; _need_water_walking())</a>
<a name="ln2779">        _grant_temporary_waterwalk();</a>
<a name="ln2780">    if (had_stat_boost)</a>
<a name="ln2781">    {</a>
<a name="ln2782">        redraw_screen();</a>
<a name="ln2783">        notify_stat_change();</a>
<a name="ln2784">    }</a>
<a name="ln2785"> </a>
<a name="ln2786">    switch (old_god)</a>
<a name="ln2787">    {</a>
<a name="ln2788">    case GOD_KIKUBAAQUDGHA:</a>
<a name="ln2789">        mprf(MSGCH_GOD, old_god, &quot;You sense decay.&quot;); // in the state of Denmark</a>
<a name="ln2790">        add_daction(DACT_ROT_CORPSES);</a>
<a name="ln2791">        break;</a>
<a name="ln2792"> </a>
<a name="ln2793">    case GOD_YREDELEMNUL:</a>
<a name="ln2794">        you.duration[DUR_MIRROR_DAMAGE] = 0;</a>
<a name="ln2795">        if (query_daction_counter(DACT_ALLY_YRED_SLAVE))</a>
<a name="ln2796">        {</a>
<a name="ln2797">            simple_god_message(&quot; reclaims all of your granted undead slaves!&quot;,</a>
<a name="ln2798">                               old_god);</a>
<a name="ln2799">            add_daction(DACT_ALLY_YRED_SLAVE);</a>
<a name="ln2800">            remove_all_companions(GOD_YREDELEMNUL);</a>
<a name="ln2801">        }</a>
<a name="ln2802">        break;</a>
<a name="ln2803"> </a>
<a name="ln2804">    case GOD_VEHUMET:</a>
<a name="ln2805">        you.vehumet_gifts.clear();</a>
<a name="ln2806">        you.duration[DUR_VEHUMET_GIFT] = 0;</a>
<a name="ln2807">        break;</a>
<a name="ln2808"> </a>
<a name="ln2809">    case GOD_MAKHLEB:</a>
<a name="ln2810">        make_god_gifts_disappear();</a>
<a name="ln2811">        break;</a>
<a name="ln2812"> </a>
<a name="ln2813">    case GOD_TROG:</a>
<a name="ln2814">        if (you.duration[DUR_TROGS_HAND])</a>
<a name="ln2815">            trog_remove_trogs_hand();</a>
<a name="ln2816">        make_god_gifts_disappear();</a>
<a name="ln2817">        break;</a>
<a name="ln2818"> </a>
<a name="ln2819">    case GOD_BEOGH:</a>
<a name="ln2820">        if (query_daction_counter(DACT_ALLY_BEOGH))</a>
<a name="ln2821">        {</a>
<a name="ln2822">            simple_god_message(&quot;'s voice booms out, \&quot;Who do you think you &quot;</a>
<a name="ln2823">                               &quot;are?\&quot;&quot;, old_god);</a>
<a name="ln2824">            mprf(MSGCH_MONSTER_ENCHANT, &quot;All of your followers decide to abandon you.&quot;);</a>
<a name="ln2825">            add_daction(DACT_ALLY_BEOGH);</a>
<a name="ln2826">            remove_all_companions(GOD_BEOGH);</a>
<a name="ln2827">        }</a>
<a name="ln2828"> </a>
<a name="ln2829">        env.level_state |= LSTATE_BEOGH;</a>
<a name="ln2830">        break;</a>
<a name="ln2831"> </a>
<a name="ln2832">    case GOD_SIF_MUNA:</a>
<a name="ln2833">        if (you.duration[DUR_CHANNEL_ENERGY])</a>
<a name="ln2834">            you.duration[DUR_CHANNEL_ENERGY] = 0;</a>
<a name="ln2835">#if TAG_MAJOR_VERSION == 34</a>
<a name="ln2836">        if (you.attribute[ATTR_DIVINE_ENERGY])</a>
<a name="ln2837">            you.attribute[ATTR_DIVINE_ENERGY] = 0;</a>
<a name="ln2838">#endif</a>
<a name="ln2839">        break;</a>
<a name="ln2840"> </a>
<a name="ln2841">    case GOD_NEMELEX_XOBEH:</a>
<a name="ln2842">        reset_cards();</a>
<a name="ln2843">        mprf(MSGCH_GOD, old_god, &quot;Your access to %s's decks is revoked.&quot;,</a>
<a name="ln2844">             god_name(old_god).c_str());</a>
<a name="ln2845">        break;</a>
<a name="ln2846"> </a>
<a name="ln2847">    case GOD_SHINING_ONE:</a>
<a name="ln2848">        if (you.duration[DUR_DIVINE_SHIELD])</a>
<a name="ln2849">            tso_remove_divine_shield();</a>
<a name="ln2850"> </a>
<a name="ln2851">        make_god_gifts_disappear();</a>
<a name="ln2852">        break;</a>
<a name="ln2853"> </a>
<a name="ln2854">    case GOD_ZIN:</a>
<a name="ln2855">        if (you.duration[DUR_DIVINE_STAMINA])</a>
<a name="ln2856">            zin_remove_divine_stamina();</a>
<a name="ln2857"> </a>
<a name="ln2858">        if (env.sanctuary_time)</a>
<a name="ln2859">            remove_sanctuary();</a>
<a name="ln2860">        break;</a>
<a name="ln2861"> </a>
<a name="ln2862">    case GOD_ELYVILON:</a>
<a name="ln2863">        you.duration[DUR_LIFESAVING] = 0;</a>
<a name="ln2864">        if (you.duration[DUR_DIVINE_VIGOUR])</a>
<a name="ln2865">            elyvilon_remove_divine_vigour();</a>
<a name="ln2866">        you.exp_docked[old_god] = exp_needed(min&lt;int&gt;(you.max_level, 27) + 1)</a>
<a name="ln2867">                                  - exp_needed(min&lt;int&gt;(you.max_level, 27));</a>
<a name="ln2868">        you.exp_docked_total[old_god] = you.exp_docked[old_god];</a>
<a name="ln2869">        break;</a>
<a name="ln2870"> </a>
<a name="ln2871">    case GOD_JIYVA:</a>
<a name="ln2872">        if (you.duration[DUR_SLIMIFY])</a>
<a name="ln2873">            you.duration[DUR_SLIMIFY] = 0;</a>
<a name="ln2874"> </a>
<a name="ln2875">        if (query_daction_counter(DACT_ALLY_SLIME))</a>
<a name="ln2876">        {</a>
<a name="ln2877">            mprf(MSGCH_MONSTER_ENCHANT, &quot;All of your fellow slimes turn on you.&quot;);</a>
<a name="ln2878">            add_daction(DACT_ALLY_SLIME);</a>
<a name="ln2879">        }</a>
<a name="ln2880">        break;</a>
<a name="ln2881"> </a>
<a name="ln2882">    case GOD_FEDHAS:</a>
<a name="ln2883">        if (query_daction_counter(DACT_ALLY_PLANT))</a>
<a name="ln2884">        {</a>
<a name="ln2885">            mprf(MSGCH_MONSTER_ENCHANT, &quot;The plants of the dungeon turn on you.&quot;);</a>
<a name="ln2886">            add_daction(DACT_ALLY_PLANT);</a>
<a name="ln2887">        }</a>
<a name="ln2888">        break;</a>
<a name="ln2889"> </a>
<a name="ln2890">    case GOD_ASHENZARI:</a>
<a name="ln2891">        if (you.transfer_skill_points &gt; 0)</a>
<a name="ln2892">            ashenzari_end_transfer(false, true);</a>
<a name="ln2893">        you.duration[DUR_SCRYING] = 0;</a>
<a name="ln2894">        you.xray_vision = false;</a>
<a name="ln2895">        you.exp_docked[old_god] = exp_needed(min&lt;int&gt;(you.max_level, 27) + 1)</a>
<a name="ln2896">                                  - exp_needed(min&lt;int&gt;(you.max_level, 27));</a>
<a name="ln2897">        you.exp_docked_total[old_god] = you.exp_docked[old_god];</a>
<a name="ln2898">        break;</a>
<a name="ln2899"> </a>
<a name="ln2900">    case GOD_DITHMENOS:</a>
<a name="ln2901">        if (you.form == transformation::shadow)</a>
<a name="ln2902">            untransform();</a>
<a name="ln2903">        break;</a>
<a name="ln2904"> </a>
<a name="ln2905">    case GOD_GOZAG:</a>
<a name="ln2906">        if (you.attribute[ATTR_GOZAG_SHOPS_CURRENT])</a>
<a name="ln2907">        {</a>
<a name="ln2908">            mprf(MSGCH_GOD, old_god, &quot;Your funded stores close, unable to pay &quot;</a>
<a name="ln2909">                                     &quot;their debts without your funds.&quot;);</a>
<a name="ln2910">            you.attribute[ATTR_GOZAG_SHOPS_CURRENT] = 0;</a>
<a name="ln2911">        }</a>
<a name="ln2912">        you.duration[DUR_GOZAG_GOLD_AURA] = 0;</a>
<a name="ln2913">        for (branch_iterator it; it; ++it)</a>
<a name="ln2914">            branch_bribe[it-&gt;id] = 0;</a>
<a name="ln2915">        add_daction(DACT_BRIBE_TIMEOUT);</a>
<a name="ln2916">        add_daction(DACT_REMOVE_GOZAG_SHOPS);</a>
<a name="ln2917">        shopping_list.remove_dead_shops();</a>
<a name="ln2918">        you.exp_docked[old_god] = exp_needed(min&lt;int&gt;(you.max_level, 27) + 1)</a>
<a name="ln2919">                                  - exp_needed(min&lt;int&gt;(you.max_level, 27));</a>
<a name="ln2920">        you.exp_docked_total[old_god] = you.exp_docked[old_god];</a>
<a name="ln2921">        break;</a>
<a name="ln2922"> </a>
<a name="ln2923">    case GOD_QAZLAL:</a>
<a name="ln2924">        if (old_piety &gt;= piety_breakpoint(0))</a>
<a name="ln2925">        {</a>
<a name="ln2926">            mprf(MSGCH_GOD, old_god, &quot;Your storm instantly dissipates.&quot;);</a>
<a name="ln2927">            you.redraw_armour_class = true;</a>
<a name="ln2928">        }</a>
<a name="ln2929">        if (you.duration[DUR_QAZLAL_FIRE_RES])</a>
<a name="ln2930">        {</a>
<a name="ln2931">            mprf(MSGCH_DURATION, &quot;Your resistance to fire fades away.&quot;);</a>
<a name="ln2932">            you.duration[DUR_QAZLAL_FIRE_RES] = 0;</a>
<a name="ln2933">        }</a>
<a name="ln2934">        if (you.duration[DUR_QAZLAL_COLD_RES])</a>
<a name="ln2935">        {</a>
<a name="ln2936">            mprf(MSGCH_DURATION, &quot;Your resistance to cold fades away.&quot;);</a>
<a name="ln2937">            you.duration[DUR_QAZLAL_COLD_RES] = 0;</a>
<a name="ln2938">        }</a>
<a name="ln2939">        if (you.duration[DUR_QAZLAL_ELEC_RES])</a>
<a name="ln2940">        {</a>
<a name="ln2941">            mprf(MSGCH_DURATION,</a>
<a name="ln2942">                 &quot;Your resistance to electricity fades away.&quot;);</a>
<a name="ln2943">            you.duration[DUR_QAZLAL_ELEC_RES] = 0;</a>
<a name="ln2944">        }</a>
<a name="ln2945">        if (you.duration[DUR_QAZLAL_AC])</a>
<a name="ln2946">        {</a>
<a name="ln2947">            mprf(MSGCH_DURATION,</a>
<a name="ln2948">                 &quot;Your resistance to physical damage fades away.&quot;);</a>
<a name="ln2949">            you.duration[DUR_QAZLAL_AC] = 0;</a>
<a name="ln2950">            you.redraw_armour_class = true;</a>
<a name="ln2951">        }</a>
<a name="ln2952">        break;</a>
<a name="ln2953"> </a>
<a name="ln2954">#if TAG_MAJOR_VERSION == 34</a>
<a name="ln2955">    case GOD_PAKELLAS:</a>
<a name="ln2956">        simple_god_message(&quot; continues to block your magic from regenerating.&quot;,</a>
<a name="ln2957">                           old_god);</a>
<a name="ln2958">        if (you.duration[DUR_DEVICE_SURGE])</a>
<a name="ln2959">            you.duration[DUR_DEVICE_SURGE] = 0;</a>
<a name="ln2960">        you.exp_docked[old_god] = exp_needed(min&lt;int&gt;(you.max_level, 27) + 1)</a>
<a name="ln2961">                                  - exp_needed(min&lt;int&gt;(you.max_level, 27));</a>
<a name="ln2962">        you.exp_docked_total[old_god] = you.exp_docked[old_god];</a>
<a name="ln2963">        break;</a>
<a name="ln2964">#endif</a>
<a name="ln2965"> </a>
<a name="ln2966">    case GOD_CHEIBRIADOS:</a>
<a name="ln2967">        simple_god_message(&quot; continues to slow your movements.&quot;, old_god);</a>
<a name="ln2968">        break;</a>
<a name="ln2969"> </a>
<a name="ln2970">    case GOD_HEPLIAKLQANA:</a>
<a name="ln2971">        add_daction(DACT_ALLY_HEPLIAKLQANA);</a>
<a name="ln2972">        remove_all_companions(GOD_HEPLIAKLQANA);</a>
<a name="ln2973"> </a>
<a name="ln2974">        you.exp_docked[old_god] = exp_needed(min&lt;int&gt;(you.max_level, 27) + 1)</a>
<a name="ln2975">                                    - exp_needed(min&lt;int&gt;(you.max_level, 27));</a>
<a name="ln2976">        you.exp_docked_total[old_god] = you.exp_docked[old_god];</a>
<a name="ln2977">        break;</a>
<a name="ln2978"> </a>
<a name="ln2979">    case GOD_WU_JIAN:</a>
<a name="ln2980">        you.attribute[ATTR_SERPENTS_LASH] = 0;</a>
<a name="ln2981">        if (you.props.exists(WU_JIAN_HEAVENLY_STORM_KEY))</a>
<a name="ln2982">            wu_jian_end_heavenly_storm();</a>
<a name="ln2983">        break;</a>
<a name="ln2984"> </a>
<a name="ln2985">    default:</a>
<a name="ln2986">        break;</a>
<a name="ln2987">    }</a>
<a name="ln2988"> </a>
<a name="ln2989">    _set_wrath_penance(old_god);</a>
<a name="ln2990"> </a>
<a name="ln2991">#ifdef USE_TILE_LOCAL</a>
<a name="ln2992">    tiles.layout_statcol();</a>
<a name="ln2993">    redraw_screen();</a>
<a name="ln2994">#endif</a>
<a name="ln2995"> </a>
<a name="ln2996">    // Evil hack.</a>
<a name="ln2997">    learned_something_new(HINT_EXCOMMUNICATE,</a>
<a name="ln2998">                          coord_def((int)new_god, old_piety));</a>
<a name="ln2999"> </a>
<a name="ln3000">    for (ability_type abil : get_god_abilities())</a>
<a name="ln3001">        you.stop_train.insert(abil_skill(abil));</a>
<a name="ln3002"> </a>
<a name="ln3003">    update_can_currently_train();</a>
<a name="ln3004">    you.can_currently_train.set(SK_INVOCATIONS, false);</a>
<a name="ln3005">    reset_training();</a>
<a name="ln3006"> </a>
<a name="ln3007">    // Perhaps we abandoned Trog with everything but Spellcasting maxed out.</a>
<a name="ln3008">    check_selected_skills();</a>
<a name="ln3009">}</a>
<a name="ln3010"> </a>
<a name="ln3011">void nemelex_death_message()</a>
<a name="ln3012">{</a>
<a name="ln3013">    const int rank = min(random2(you.piety) / 30, 2);</a>
<a name="ln3014"> </a>
<a name="ln3015">    static const char *messages[NUM_PIETY_GAIN] =</a>
<a name="ln3016">    {</a>
<a name="ln3017">        &quot;&lt;lightgrey&gt;Your body disappears without a glow.&lt;/lightgrey&gt;&quot;,</a>
<a name="ln3018">        &quot;Your body glows slightly and disappears.&quot;,</a>
<a name="ln3019">        &quot;&lt;white&gt;Your body glows with a rainbow of weird colours and disappears.&lt;/white&gt;&quot;,</a>
<a name="ln3020">    };</a>
<a name="ln3021"> </a>
<a name="ln3022">    static const char *glowing_messages[NUM_PIETY_GAIN] =</a>
<a name="ln3023">    {</a>
<a name="ln3024">        &quot;&lt;lightgrey&gt;Your body disappears without additional glow.&lt;/lightgrey&gt;&quot;,</a>
<a name="ln3025">        &quot;Your body glows slightly brighter and disappears.&quot;,</a>
<a name="ln3026">        &quot;&lt;white&gt;Your body glows with a rainbow of weird colours and disappears.&lt;/white&gt;&quot;,</a>
<a name="ln3027">    };</a>
<a name="ln3028"> </a>
<a name="ln3029">    mpr((you.backlit() ? glowing_messages : messages)[rank]);</a>
<a name="ln3030">}</a>
<a name="ln3031"> </a>
<a name="ln3032">bool god_hates_attacking_friend(god_type god, const monster&amp; fr)</a>
<a name="ln3033">{</a>
<a name="ln3034">    if (fr.kill_alignment() != KC_FRIENDLY)</a>
<a name="ln3035">        return false;</a>
<a name="ln3036"> </a>
<a name="ln3037">    monster_type species = fr.mons_species();</a>
<a name="ln3038"> </a>
<a name="ln3039">    if (mons_is_object(species))</a>
<a name="ln3040">        return false;</a>
<a name="ln3041">    switch (god)</a>
<a name="ln3042">    {</a>
<a name="ln3043">        case GOD_ZIN:</a>
<a name="ln3044">        case GOD_SHINING_ONE:</a>
<a name="ln3045">        case GOD_ELYVILON:</a>
<a name="ln3046">        case GOD_OKAWARU:</a>
<a name="ln3047">            return true;</a>
<a name="ln3048">        case GOD_BEOGH: // added penance to avoid killings for loot</a>
<a name="ln3049">            return mons_genus(species) == MONS_ORC;</a>
<a name="ln3050">        case GOD_JIYVA:</a>
<a name="ln3051">            return mons_class_is_slime(species);</a>
<a name="ln3052">        case GOD_FEDHAS:</a>
<a name="ln3053">            return _fedhas_protects_species(species);</a>
<a name="ln3054">        default:</a>
<a name="ln3055">            return false;</a>
<a name="ln3056">    }</a>
<a name="ln3057">}</a>
<a name="ln3058"> </a>
<a name="ln3059">static bool _transformed_player_can_join_god(god_type which_god)</a>
<a name="ln3060">{</a>
<a name="ln3061">    if (which_god == GOD_ZIN &amp;&amp; you.form != transformation::none)</a>
<a name="ln3062">        return false; // zin hates everything</a>
<a name="ln3063">    // all these clauses are written with a ! in front of them, so that</a>
<a name="ln3064">    // the stuff to the right of that is uniformly &quot;gods that hate this form&quot;</a>
<a name="ln3065">    switch (you.form)</a>
<a name="ln3066">    {</a>
<a name="ln3067">    case transformation::lich:</a>
<a name="ln3068">        return !is_good_god(which_god);</a>
<a name="ln3069">    case transformation::statue:</a>
<a name="ln3070">    case transformation::wisp:</a>
<a name="ln3071">        return !(which_god == GOD_YREDELEMNUL);</a>
<a name="ln3072">    default:</a>
<a name="ln3073">        return true;</a>
<a name="ln3074">    }</a>
<a name="ln3075">}</a>
<a name="ln3076"> </a>
<a name="ln3077">int gozag_service_fee()</a>
<a name="ln3078">{</a>
<a name="ln3079">    if (you.char_class == JOB_MONK &amp;&amp; had_gods() == 0)</a>
<a name="ln3080">        return 0;</a>
<a name="ln3081"> </a>
<a name="ln3082">    if (crawl_state.game_is_sprint())</a>
<a name="ln3083">        return 0;</a>
<a name="ln3084"> </a>
<a name="ln3085">    const int gold = you.attribute[ATTR_GOLD_GENERATED];</a>
<a name="ln3086">    int fee = (int)(gold - gold / log10(gold + 10.0))/2;</a>
<a name="ln3087"> </a>
<a name="ln3088">    dprf(&quot;found %d gold, fee %d&quot;, gold, fee);</a>
<a name="ln3089">    return fee;</a>
<a name="ln3090">}</a>
<a name="ln3091"> </a>
<a name="ln3092">static bool _god_rejects_loveless(god_type god)</a>
<a name="ln3093">{</a>
<a name="ln3094">    switch (god)</a>
<a name="ln3095">    {</a>
<a name="ln3096">    case GOD_BEOGH:</a>
<a name="ln3097">    case GOD_JIYVA:</a>
<a name="ln3098">    case GOD_HEPLIAKLQANA:</a>
<a name="ln3099">    case GOD_FEDHAS:</a>
<a name="ln3100">    case GOD_YREDELEMNUL:</a>
<a name="ln3101">        return true;</a>
<a name="ln3102">    default:</a>
<a name="ln3103">        return false;</a>
<a name="ln3104">    }</a>
<a name="ln3105">}</a>
<a name="ln3106"> </a>
<a name="ln3107">bool player_can_join_god(god_type which_god)</a>
<a name="ln3108">{</a>
<a name="ln3109">    if (you.species == SP_DEMIGOD)</a>
<a name="ln3110">        return false;</a>
<a name="ln3111"> </a>
<a name="ln3112">    if (is_good_god(which_god) &amp;&amp; you.undead_or_demonic())</a>
<a name="ln3113">        return false;</a>
<a name="ln3114"> </a>
<a name="ln3115">    if (which_god == GOD_YREDELEMNUL &amp;&amp; you.is_nonliving())</a>
<a name="ln3116">        return false;</a>
<a name="ln3117"> </a>
<a name="ln3118">    if (which_god == GOD_BEOGH &amp;&amp; !species_is_orcish(you.species))</a>
<a name="ln3119">        return false;</a>
<a name="ln3120"> </a>
<a name="ln3121">    if (which_god == GOD_GOZAG &amp;&amp; you.gold &lt; gozag_service_fee())</a>
<a name="ln3122">        return false;</a>
<a name="ln3123"> </a>
<a name="ln3124">    if (you.get_mutation_level(MUT_NO_LOVE) &amp;&amp; _god_rejects_loveless(which_god))</a>
<a name="ln3125">        return false;</a>
<a name="ln3126"> </a>
<a name="ln3127">#if TAG_MAJOR_VERSION == 34</a>
<a name="ln3128">    if (you.get_mutation_level(MUT_NO_ARTIFICE)</a>
<a name="ln3129">        &amp;&amp; which_god == GOD_PAKELLAS)</a>
<a name="ln3130">    {</a>
<a name="ln3131">      return false;</a>
<a name="ln3132">    }</a>
<a name="ln3133">#endif</a>
<a name="ln3134"> </a>
<a name="ln3135">    return _transformed_player_can_join_god(which_god);</a>
<a name="ln3136">}</a>
<a name="ln3137"> </a>
<a name="ln3138">// Handle messaging and identification for items/equipment on conversion.</a>
<a name="ln3139">static void _god_welcome_handle_gear()</a>
<a name="ln3140">{</a>
<a name="ln3141">    // Check for amulets of faith.</a>
<a name="ln3142">    item_def *amulet = you.slot_item(EQ_AMULET, false);</a>
<a name="ln3143">    if (amulet &amp;&amp; amulet-&gt;sub_type == AMU_FAITH &amp;&amp; !is_useless_item(*amulet))</a>
<a name="ln3144">    {</a>
<a name="ln3145">        mprf(MSGCH_GOD, &quot;Your amulet flashes!&quot;);</a>
<a name="ln3146">        flash_view_delay(UA_PLAYER, god_colour(you.religion), 300);</a>
<a name="ln3147">    }</a>
<a name="ln3148"> </a>
<a name="ln3149">    if (you_worship(GOD_ASHENZARI))</a>
<a name="ln3150">    {</a>
<a name="ln3151">        if (!item_type_known(OBJ_SCROLLS, SCR_REMOVE_CURSE))</a>
<a name="ln3152">        {</a>
<a name="ln3153">            set_ident_type(OBJ_SCROLLS, SCR_REMOVE_CURSE, true);</a>
<a name="ln3154">            pack_item_identify_message(OBJ_SCROLLS, SCR_REMOVE_CURSE);</a>
<a name="ln3155">        }</a>
<a name="ln3156">    }</a>
<a name="ln3157"> </a>
<a name="ln3158">    if (have_passive(passive_t::identify_items))</a>
<a name="ln3159">    {</a>
<a name="ln3160">        // Seemingly redundant with auto_id_inventory(), but we don't want to</a>
<a name="ln3161">        // announce items where the only new information is their cursedness.</a>
<a name="ln3162">        for (auto &amp;item : you.inv)</a>
<a name="ln3163">            if (item.defined())</a>
<a name="ln3164">                item.flags |= ISFLAG_KNOW_CURSE;</a>
<a name="ln3165"> </a>
<a name="ln3166">        auto_id_inventory();</a>
<a name="ln3167">    }</a>
<a name="ln3168"> </a>
<a name="ln3169">    if (have_passive(passive_t::detect_portals))</a>
<a name="ln3170">        ash_detect_portals(true);</a>
<a name="ln3171"> </a>
<a name="ln3172">    // Give a reminder to remove any disallowed equipment.</a>
<a name="ln3173">    for (int i = EQ_FIRST_EQUIP; i &lt; NUM_EQUIP; i++)</a>
<a name="ln3174">    {</a>
<a name="ln3175">        const item_def* item = you.slot_item(static_cast&lt;equipment_type&gt;(i));</a>
<a name="ln3176">        if (item &amp;&amp; god_hates_item(*item))</a>
<a name="ln3177">        {</a>
<a name="ln3178">            mprf(MSGCH_GOD, &quot;%s warns you to remove %s.&quot;,</a>
<a name="ln3179">                 uppercase_first(god_name(you.religion)).c_str(),</a>
<a name="ln3180">                 item-&gt;name(DESC_YOUR, false, false, false).c_str());</a>
<a name="ln3181">        }</a>
<a name="ln3182">    }</a>
<a name="ln3183"> </a>
<a name="ln3184">    // Refresh wielded/quivered weapons in case we have a new conduct</a>
<a name="ln3185">    // on them.</a>
<a name="ln3186">    you.wield_change = true;</a>
<a name="ln3187">    you.redraw_quiver = true;</a>
<a name="ln3188">}</a>
<a name="ln3189"> </a>
<a name="ln3190">/* Make a CrawlStoreValue an empty vector with the requested item type.</a>
<a name="ln3191"> * It is an error if the value already had a different type.</a>
<a name="ln3192"> */</a>
<a name="ln3193">static void _make_empty_vec(CrawlStoreValue &amp;v, store_val_type vectype)</a>
<a name="ln3194">{</a>
<a name="ln3195">    const store_val_type currtype = v.get_type();</a>
<a name="ln3196">    ASSERT(currtype == SV_NONE || currtype == SV_VEC);</a>
<a name="ln3197"> </a>
<a name="ln3198">    if (currtype == SV_NONE)</a>
<a name="ln3199">        v.new_vector(vectype);</a>
<a name="ln3200">    else</a>
<a name="ln3201">    {</a>
<a name="ln3202">        CrawlVector &amp;vec = v.get_vector();</a>
<a name="ln3203">        const store_val_type old_vectype = vec.get_type();</a>
<a name="ln3204">        ASSERT(old_vectype == SV_NONE || old_vectype == vectype);</a>
<a name="ln3205">        vec.clear();</a>
<a name="ln3206">    }</a>
<a name="ln3207">}</a>
<a name="ln3208"> </a>
<a name="ln3209">// Note: we're trying for a behaviour where the player gets</a>
<a name="ln3210">// to keep their assigned invocation slots if they get excommunicated</a>
<a name="ln3211">// and then rejoin (but if they spend time with another god we consider</a>
<a name="ln3212">// the old invocation slots void and erase them). We also try to</a>
<a name="ln3213">// protect any bindings the character might have made into the</a>
<a name="ln3214">// traditional invocation slots (a-e and X). -- bwr</a>
<a name="ln3215">void set_god_ability_slots()</a>
<a name="ln3216">{</a>
<a name="ln3217">    ASSERT(!you_worship(GOD_NO_GOD));</a>
<a name="ln3218"> </a>
<a name="ln3219">    if (find(begin(you.ability_letter_table), end(you.ability_letter_table),</a>
<a name="ln3220">             ABIL_RENOUNCE_RELIGION) == end(you.ability_letter_table)</a>
<a name="ln3221">        &amp;&amp; you.ability_letter_table[letter_to_index('X')] == ABIL_NON_ABILITY)</a>
<a name="ln3222">    {</a>
<a name="ln3223">        you.ability_letter_table[letter_to_index('X')] = ABIL_RENOUNCE_RELIGION;</a>
<a name="ln3224">    }</a>
<a name="ln3225"> </a>
<a name="ln3226">    // Clear out other god invocations.</a>
<a name="ln3227">    for (ability_type&amp; slot : you.ability_letter_table)</a>
<a name="ln3228">    {</a>
<a name="ln3229">        for (god_iterator it; it; ++it)</a>
<a name="ln3230">        {</a>
<a name="ln3231">            if (slot == ABIL_NON_ABILITY)</a>
<a name="ln3232">                break;</a>
<a name="ln3233">            if (*it == you.religion)</a>
<a name="ln3234">                continue;</a>
<a name="ln3235">            for (const god_power&amp; power : god_powers[*it])</a>
<a name="ln3236">                if (slot == power.abil)</a>
<a name="ln3237">                    slot = ABIL_NON_ABILITY;</a>
<a name="ln3238">        }</a>
<a name="ln3239">    }</a>
<a name="ln3240"> </a>
<a name="ln3241">    int num = letter_to_index('a');</a>
<a name="ln3242">    // Not using get_god_powers, so that hotkeys remain stable across games</a>
<a name="ln3243">    // even if you can't use a particular ability in a given game.</a>
<a name="ln3244">    for (const god_power&amp; power : god_powers[you.religion])</a>
<a name="ln3245">    {</a>
<a name="ln3246">        if (power.abil != ABIL_NON_ABILITY</a>
<a name="ln3247">            // Animate Dead doesn't have its own hotkey; it steals</a>
<a name="ln3248">            // Animate Remains'</a>
<a name="ln3249">            &amp;&amp; power.abil != ABIL_YRED_ANIMATE_DEAD</a>
<a name="ln3250">            // hep ident goes to G, so don't take b for it (hack alert)</a>
<a name="ln3251">            &amp;&amp; power.abil != ABIL_HEPLIAKLQANA_IDENTITY</a>
<a name="ln3252">            &amp;&amp; find(begin(you.ability_letter_table),</a>
<a name="ln3253">                    end(you.ability_letter_table), power.abil)</a>
<a name="ln3254">               == end(you.ability_letter_table)</a>
<a name="ln3255">            &amp;&amp; you.ability_letter_table[num] == ABIL_NON_ABILITY)</a>
<a name="ln3256">        {</a>
<a name="ln3257">            // Assign sequentially: first ability 'a', third ability 'c',</a>
<a name="ln3258">            // etc., even if one is remapped.</a>
<a name="ln3259">            if (find_ability_slot(power.abil, index_to_letter(num)) &lt; 0)</a>
<a name="ln3260">            {</a>
<a name="ln3261">                you.ability_letter_table[num] = power.abil;</a>
<a name="ln3262">                auto_assign_ability_slot(num);</a>
<a name="ln3263">            }</a>
<a name="ln3264">            ++num;</a>
<a name="ln3265">        }</a>
<a name="ln3266">    }</a>
<a name="ln3267">}</a>
<a name="ln3268"> </a>
<a name="ln3269">/// Check if the monk's joining bonus should be given. (Except Gozag's.)</a>
<a name="ln3270">static void _apply_monk_bonus()</a>
<a name="ln3271">{</a>
<a name="ln3272">    if (you.char_class != JOB_MONK || had_gods() &gt; 0)</a>
<a name="ln3273">        return;</a>
<a name="ln3274"> </a>
<a name="ln3275">    // monks get bonus piety for first god</a>
<a name="ln3276">    if (you_worship(GOD_RU))</a>
<a name="ln3277">        you.props[RU_SACRIFICE_PROGRESS_KEY] = 9999;</a>
<a name="ln3278">    else if (you_worship(GOD_USKAYAW))  // Gaining piety past this point does nothing</a>
<a name="ln3279">        gain_piety(15, 1, false); // of value with this god and looks weird.</a>
<a name="ln3280">    else</a>
<a name="ln3281">        gain_piety(35, 1, false);</a>
<a name="ln3282">}</a>
<a name="ln3283"> </a>
<a name="ln3284">/// Transfer some piety from an old good god to a new one, if applicable.</a>
<a name="ln3285">static void _transfer_good_god_piety()</a>
<a name="ln3286">{</a>
<a name="ln3287">    if (!is_good_god(you.religion))</a>
<a name="ln3288">        return;</a>
<a name="ln3289"> </a>
<a name="ln3290">    const god_type old_god = you.previous_good_god;</a>
<a name="ln3291">    const uint8_t old_piety = you.saved_good_god_piety;</a>
<a name="ln3292"> </a>
<a name="ln3293">    if (!is_good_god(old_god))</a>
<a name="ln3294">        return;</a>
<a name="ln3295"> </a>
<a name="ln3296">    if (you.religion != old_god)</a>
<a name="ln3297">    {</a>
<a name="ln3298">        static const map&lt;god_type, const char*&gt; farewell_messages = {</a>
<a name="ln3299">            { GOD_ELYVILON, &quot;aid the meek&quot; },</a>
<a name="ln3300">            { GOD_SHINING_ONE, &quot;vanquish evil&quot; },</a>
<a name="ln3301">            { GOD_ZIN, &quot;enforce order&quot; },</a>
<a name="ln3302">        };</a>
<a name="ln3303"> </a>
<a name="ln3304">        // Some feedback that piety moved over.</a>
<a name="ln3305">        simple_god_message(make_stringf(&quot; says: Farewell. Go and %s with %s.&quot;,</a>
<a name="ln3306">                                        lookup(farewell_messages, you.religion,</a>
<a name="ln3307">                                               &quot;become a bug&quot;),</a>
<a name="ln3308">                                        god_name(you.religion).c_str()).c_str(),</a>
<a name="ln3309"> </a>
<a name="ln3310">                           old_god);</a>
<a name="ln3311">    }</a>
<a name="ln3312"> </a>
<a name="ln3313">    // Give a piety bonus when switching between good gods, or back to the</a>
<a name="ln3314">    // same good god.</a>
<a name="ln3315">    if (old_piety &gt; piety_breakpoint(0))</a>
<a name="ln3316">        gain_piety(old_piety - piety_breakpoint(0), 2, false);</a>
<a name="ln3317">}</a>
<a name="ln3318"> </a>
<a name="ln3319"> </a>
<a name="ln3320">/**</a>
<a name="ln3321"> * Give an appropriate message for the given good god to give in response to</a>
<a name="ln3322"> * the player joining a god that brings down their wrath.</a>
<a name="ln3323"> *</a>
<a name="ln3324"> * @param good_god    The good god in question.</a>
<a name="ln3325"> */</a>
<a name="ln3326">static string _good_god_wrath_message(god_type good_god)</a>
<a name="ln3327">{</a>
<a name="ln3328">    switch (good_god)</a>
<a name="ln3329">    {</a>
<a name="ln3330">        case GOD_ELYVILON:</a>
<a name="ln3331">            return &quot;Your evil deeds will not go unpunished&quot;;</a>
<a name="ln3332">        case GOD_SHINING_ONE:</a>
<a name="ln3333">            return &quot;You will pay for your evil ways, mortal&quot;;</a>
<a name="ln3334">        case GOD_ZIN:</a>
<a name="ln3335">            return make_stringf(&quot;You will suffer for embracing such %s&quot;,</a>
<a name="ln3336">                                is_chaotic_god(you.religion) ? &quot;chaos&quot;</a>
<a name="ln3337">                                                             : &quot;evil&quot;);</a>
<a name="ln3338">        default:</a>
<a name="ln3339">            return &quot;You will be buggily punished for this&quot;;</a>
<a name="ln3340">    }</a>
<a name="ln3341">}</a>
<a name="ln3342"> </a>
<a name="ln3343">/**</a>
<a name="ln3344"> * Check if joining the current god will cause wrath for any previously-</a>
<a name="ln3345"> * worshipped good gods. If so, message &amp; set penance timeouts.</a>
<a name="ln3346"> *</a>
<a name="ln3347"> * @param old_god    The previous god worshipped; may be GOD_NO_GOD.</a>
<a name="ln3348"> */</a>
<a name="ln3349">static void _check_good_god_wrath(god_type old_god)</a>
<a name="ln3350">{</a>
<a name="ln3351">    for (god_type good_god : { GOD_ELYVILON, GOD_SHINING_ONE, GOD_ZIN })</a>
<a name="ln3352">    {</a>
<a name="ln3353">        if (old_god == good_god || !you.penance[good_god]</a>
<a name="ln3354">            || !god_hates_your_god(good_god, you.religion))</a>
<a name="ln3355">        {</a>
<a name="ln3356">            continue;</a>
<a name="ln3357">        }</a>
<a name="ln3358"> </a>
<a name="ln3359">        const string wrath_message</a>
<a name="ln3360">            = make_stringf(&quot; says: %s!&quot;,</a>
<a name="ln3361">                           _good_god_wrath_message(good_god).c_str());</a>
<a name="ln3362">        simple_god_message(wrath_message.c_str(), good_god);</a>
<a name="ln3363">        set_penance_xp_timeout();</a>
<a name="ln3364">    }</a>
<a name="ln3365">}</a>
<a name="ln3366"> </a>
<a name="ln3367">/// Handle basic god piety &amp; related setup for a new-joined god.</a>
<a name="ln3368">static void _set_initial_god_piety()</a>
<a name="ln3369">{</a>
<a name="ln3370">    // Currently, penance is just zeroed. This could be much more</a>
<a name="ln3371">    // interesting.</a>
<a name="ln3372">    you.penance[you.religion] = 0;</a>
<a name="ln3373"> </a>
<a name="ln3374">    switch (you.religion)</a>
<a name="ln3375">    {</a>
<a name="ln3376">    case GOD_XOM:</a>
<a name="ln3377">        // Xom uses piety and gift_timeout differently.</a>
<a name="ln3378">        you.piety = HALF_MAX_PIETY;</a>
<a name="ln3379">        you.gift_timeout = random2(40) + random2(40);</a>
<a name="ln3380">        break;</a>
<a name="ln3381"> </a>
<a name="ln3382">    case GOD_RU:</a>
<a name="ln3383">        you.piety = 10; // one moderate sacrifice should get you to *.</a>
<a name="ln3384">        you.piety_hysteresis = 0;</a>
<a name="ln3385">        you.gift_timeout = 0;</a>
<a name="ln3386"> </a>
<a name="ln3387">        // I'd rather this be in on_join(), but then it overrides the</a>
<a name="ln3388">        // monk bonus...</a>
<a name="ln3389">        you.props[RU_SACRIFICE_PROGRESS_KEY] = 0;</a>
<a name="ln3390">        // offer the first sacrifice faster than normal</a>
<a name="ln3391">        {</a>
<a name="ln3392">            int delay = 50;</a>
<a name="ln3393">            if (crawl_state.game_is_sprint())</a>
<a name="ln3394">                delay /= SPRINT_MULTIPLIER;</a>
<a name="ln3395">            you.props[RU_SACRIFICE_DELAY_KEY] = delay;</a>
<a name="ln3396">        }</a>
<a name="ln3397">        you.props[RU_SACRIFICE_PENALTY_KEY] = 0;</a>
<a name="ln3398">        break;</a>
<a name="ln3399"> </a>
<a name="ln3400">    default:</a>
<a name="ln3401">        you.piety = 15; // to prevent near instant excommunication</a>
<a name="ln3402">        if (you.piety_max[you.religion] &lt; 15)</a>
<a name="ln3403">            you.piety_max[you.religion] = 15;</a>
<a name="ln3404">        you.piety_hysteresis = 0;</a>
<a name="ln3405">        you.gift_timeout = 0;</a>
<a name="ln3406">        break;</a>
<a name="ln3407">    }</a>
<a name="ln3408"> </a>
<a name="ln3409">    // Tutorial needs berserk usable.</a>
<a name="ln3410">    if (crawl_state.game_is_tutorial())</a>
<a name="ln3411">        gain_piety(30, 1, false);</a>
<a name="ln3412"> </a>
<a name="ln3413">    _apply_monk_bonus();</a>
<a name="ln3414">    _transfer_good_god_piety();</a>
<a name="ln3415">}</a>
<a name="ln3416"> </a>
<a name="ln3417">/// Setup when joining the greedy magnates of Gozag.</a>
<a name="ln3418">static void _join_gozag()</a>
<a name="ln3419">{</a>
<a name="ln3420">    // Handle the fee.</a>
<a name="ln3421">    const int fee = gozag_service_fee();</a>
<a name="ln3422">    if (fee &gt; 0)</a>
<a name="ln3423">    {</a>
<a name="ln3424">        ASSERT(you.gold &gt;= fee);</a>
<a name="ln3425">        mprf(MSGCH_GOD, &quot;You pay a service fee of %d gold.&quot;, fee);</a>
<a name="ln3426">        you.gold -= fee;</a>
<a name="ln3427">        you.attribute[ATTR_GOZAG_GOLD_USED] += fee;</a>
<a name="ln3428">    }</a>
<a name="ln3429">    else</a>
<a name="ln3430">        simple_god_message(&quot; waives the service fee.&quot;);</a>
<a name="ln3431"> </a>
<a name="ln3432">    // Note relevant powers.</a>
<a name="ln3433">    bool needs_redraw = false;</a>
<a name="ln3434">    for (const auto&amp; power : get_god_powers(you.religion))</a>
<a name="ln3435">    {</a>
<a name="ln3436">        if (power.abil == ABIL_GOZAG_POTION_PETITION</a>
<a name="ln3437">            &amp;&amp; !you.attribute[ATTR_GOZAG_FIRST_POTION])</a>
<a name="ln3438">        {</a>
<a name="ln3439">            simple_god_message(&quot; offers you a free set of potion effects!&quot;);</a>
<a name="ln3440">            needs_redraw = true;</a>
<a name="ln3441">            continue;</a>
<a name="ln3442">        }</a>
<a name="ln3443">        if (you.gold &gt;= get_gold_cost(power.abil))</a>
<a name="ln3444">        {</a>
<a name="ln3445">            power.display(true, &quot;You have enough gold to %s.&quot;);</a>
<a name="ln3446">            needs_redraw = true;</a>
<a name="ln3447">        }</a>
<a name="ln3448">    }</a>
<a name="ln3449"> </a>
<a name="ln3450">    if (needs_redraw)</a>
<a name="ln3451">    {</a>
<a name="ln3452">#ifdef USE_TILE_LOCAL</a>
<a name="ln3453">        tiles.layout_statcol();</a>
<a name="ln3454">        redraw_screen();</a>
<a name="ln3455">#else</a>
<a name="ln3456">        ;</a>
<a name="ln3457">#endif</a>
<a name="ln3458">    }</a>
<a name="ln3459"> </a>
<a name="ln3460">    // Move gold to top of piles &amp; detect it.</a>
<a name="ln3461">    add_daction(DACT_GOLD_ON_TOP);</a>
<a name="ln3462">}</a>
<a name="ln3463"> </a>
<a name="ln3464">/**</a>
<a name="ln3465"> * Choose an antique name for a Hepliaklqana-granted ancestor.</a>
<a name="ln3466"> *</a>
<a name="ln3467"> * @param female    Whether the ancestor is female or male.</a>
<a name="ln3468"> * @return          An appropriate name; e.g. Hrodulf, Citali, Aat.</a>
<a name="ln3469"> */</a>
<a name="ln3470">static string _make_ancestor_name(bool female)</a>
<a name="ln3471">{</a>
<a name="ln3472">    const string gender_name = female ? &quot;female&quot; : &quot;male&quot;;</a>
<a name="ln3473">    const string suffix = &quot; &quot; + gender_name + &quot; name&quot;;</a>
<a name="ln3474">    const string name = getRandNameString(&quot;ancestor&quot;, suffix);</a>
<a name="ln3475">    return name.empty() ? make_name() : name;</a>
<a name="ln3476">}</a>
<a name="ln3477"> </a>
<a name="ln3478">/// Setup when joining the devoted followers of Hepliaklqana.</a>
<a name="ln3479">static void _join_hepliaklqana()</a>
<a name="ln3480">{</a>
<a name="ln3481">    // initial setup.</a>
<a name="ln3482">    if (!you.props.exists(HEPLIAKLQANA_ALLY_NAME_KEY))</a>
<a name="ln3483">    {</a>
<a name="ln3484">        const bool female = coinflip();</a>
<a name="ln3485">        you.props[HEPLIAKLQANA_ALLY_NAME_KEY] = _make_ancestor_name(female);</a>
<a name="ln3486">        you.props[HEPLIAKLQANA_ALLY_GENDER_KEY] = female ? GENDER_FEMALE</a>
<a name="ln3487">                                                         : GENDER_MALE;</a>
<a name="ln3488">    }</a>
<a name="ln3489"> </a>
<a name="ln3490">    calc_hp(); // adjust for frailty</a>
<a name="ln3491"> </a>
<a name="ln3492">    // Complimentary ancestor upon joining.</a>
<a name="ln3493">    const mgen_data mg = hepliaklqana_ancestor_gen_data();</a>
<a name="ln3494">    delayed_monster(mg);</a>
<a name="ln3495">    simple_god_message(make_stringf(&quot; forms a fragment of your life essence&quot;</a>
<a name="ln3496">                                    &quot; into the memory of your ancestor, %s!&quot;,</a>
<a name="ln3497">                                    mg.mname.c_str()).c_str());</a>
<a name="ln3498">}</a>
<a name="ln3499"> </a>
<a name="ln3500">/// Setup when joining the gelatinous groupies of Jiyva.</a>
<a name="ln3501">static void _join_jiyva()</a>
<a name="ln3502">{</a>
<a name="ln3503">    // Complimentary jelly upon joining.</a>
<a name="ln3504">    if (_has_jelly())</a>
<a name="ln3505">        return;</a>
<a name="ln3506"> </a>
<a name="ln3507">    mgen_data mg(MONS_JELLY, BEH_STRICT_NEUTRAL, you.pos());</a>
<a name="ln3508">    mg.set_summoned(&amp;you, 0, 0, GOD_JIYVA);</a>
<a name="ln3509"> </a>
<a name="ln3510">    delayed_monster(mg);</a>
<a name="ln3511">    simple_god_message(&quot; grants you a jelly!&quot;);</a>
<a name="ln3512">}</a>
<a name="ln3513"> </a>
<a name="ln3514">/// Setup when joining the sacred cult of Ru.</a>
<a name="ln3515">static void _join_ru()</a>
<a name="ln3516">{</a>
<a name="ln3517">    _make_empty_vec(you.props[AVAILABLE_SAC_KEY], SV_INT);</a>
<a name="ln3518">    _make_empty_vec(you.props[HEALTH_SAC_KEY], SV_INT);</a>
<a name="ln3519">    _make_empty_vec(you.props[ESSENCE_SAC_KEY], SV_INT);</a>
<a name="ln3520">    _make_empty_vec(you.props[PURITY_SAC_KEY], SV_INT);</a>
<a name="ln3521">    _make_empty_vec(you.props[ARCANA_SAC_KEY], SV_INT);</a>
<a name="ln3522">}</a>
<a name="ln3523"> </a>
<a name="ln3524">/// Setup for joining the furious barbarians of Trog.</a>
<a name="ln3525">static void _join_trog()</a>
<a name="ln3526">{</a>
<a name="ln3527">    if (you.species != SP_GNOLL)</a>
<a name="ln3528">        for (int sk = SK_SPELLCASTING; sk &lt;= SK_LAST_MAGIC; ++sk)</a>
<a name="ln3529">            you.train[sk] = you.train_alt[sk] = TRAINING_DISABLED;</a>
<a name="ln3530"> </a>
<a name="ln3531">    // When you start worshipping Trog, you make all non-hostile magic</a>
<a name="ln3532">    // users hostile.</a>
<a name="ln3533">    if (query_daction_counter(DACT_ALLY_SPELLCASTER))</a>
<a name="ln3534">    {</a>
<a name="ln3535">        add_daction(DACT_ALLY_SPELLCASTER);</a>
<a name="ln3536">        mprf(MSGCH_MONSTER_ENCHANT, &quot;Your magic-using allies forsake you.&quot;);</a>
<a name="ln3537">    }</a>
<a name="ln3538">}</a>
<a name="ln3539"> </a>
<a name="ln3540">// Setup for joining the orderly ascetics of Zin.</a>
<a name="ln3541">static void _join_zin()</a>
<a name="ln3542">{</a>
<a name="ln3543">    // When you start worshipping Zin, you make all non-hostile unclean and</a>
<a name="ln3544">    // chaotic beings hostile.</a>
<a name="ln3545">    if (query_daction_counter(DACT_ALLY_UNCLEAN_CHAOTIC))</a>
<a name="ln3546">    {</a>
<a name="ln3547">        add_daction(DACT_ALLY_UNCLEAN_CHAOTIC);</a>
<a name="ln3548">        mprf(MSGCH_MONSTER_ENCHANT, &quot;Your unclean and chaotic allies forsake you.&quot;);</a>
<a name="ln3549">    }</a>
<a name="ln3550"> </a>
<a name="ln3551">    // Need to pay St. Peters.</a>
<a name="ln3552">    if (you.attribute[ATTR_DONATIONS] * 9 &lt; you.gold)</a>
<a name="ln3553">    {</a>
<a name="ln3554">        item_def lucre;</a>
<a name="ln3555">        lucre.base_type = OBJ_GOLD;</a>
<a name="ln3556">        // If you worshipped Zin before, the already tithed for part is fine.</a>
<a name="ln3557">        lucre.quantity = you.gold - you.attribute[ATTR_DONATIONS] * 9;</a>
<a name="ln3558">        // Use the harsh acquirement pricing -- with a cap at +50 piety.</a>
<a name="ln3559">        // We don't want you get max piety at start just because you're filthy</a>
<a name="ln3560">        // rich. In that case, you have to donate again more... That the poor</a>
<a name="ln3561">        // widow is not spared doesn't mean the rich can't be milked for more.</a>
<a name="ln3562">        lucre.props[ACQUIRE_KEY] = 0;</a>
<a name="ln3563">        you.gold -= zin_tithe(lucre, lucre.quantity, true);</a>
<a name="ln3564">    }</a>
<a name="ln3565">}</a>
<a name="ln3566"> </a>
<a name="ln3567">#if TAG_MAJOR_VERSION == 34</a>
<a name="ln3568">// Setup when becoming an overworked assistant to Pakellas.</a>
<a name="ln3569">static void _join_pakellas()</a>
<a name="ln3570">{</a>
<a name="ln3571">    mprf(MSGCH_GOD, &quot;You stop regenerating magic.&quot;);</a>
<a name="ln3572">    you.attribute[ATTR_PAKELLAS_EXTRA_MP] = POT_MAGIC_MP;</a>
<a name="ln3573">}</a>
<a name="ln3574">#endif</a>
<a name="ln3575"> </a>
<a name="ln3576">// Setup for joining the easygoing followers of Cheibriados.</a>
<a name="ln3577">static void _join_cheibriados()</a>
<a name="ln3578">{</a>
<a name="ln3579">    simple_god_message(&quot; begins to support your attributes as your &quot;</a>
<a name="ln3580">                       &quot;movement slows.&quot;);</a>
<a name="ln3581">    notify_stat_change();</a>
<a name="ln3582">}</a>
<a name="ln3583"> </a>
<a name="ln3584">/// What special things happen when you join a god?</a>
<a name="ln3585">static const map&lt;god_type, function&lt;void ()&gt;&gt; on_join = {</a>
<a name="ln3586">    { GOD_ASHENZARI, []() { ash_check_bondage(); }},</a>
<a name="ln3587">    { GOD_BEOGH, update_player_symbol },</a>
<a name="ln3588">    { GOD_CHEIBRIADOS, _join_cheibriados },</a>
<a name="ln3589">    { GOD_FEDHAS, []() {</a>
<a name="ln3590">        mprf(MSGCH_MONSTER_ENCHANT, &quot;The plants of the dungeon cease their &quot;</a>
<a name="ln3591">             &quot;hostilities.&quot;);</a>
<a name="ln3592">        if (env.forest_awoken_until)</a>
<a name="ln3593">            for (monster_iterator mi; mi; ++mi)</a>
<a name="ln3594">                mi-&gt;del_ench(ENCH_AWAKEN_FOREST);</a>
<a name="ln3595">    }},</a>
<a name="ln3596">    { GOD_GOZAG, _join_gozag },</a>
<a name="ln3597">    { GOD_JIYVA, _join_jiyva },</a>
<a name="ln3598">    { GOD_HEPLIAKLQANA, _join_hepliaklqana },</a>
<a name="ln3599">    { GOD_LUGONU, []() {</a>
<a name="ln3600">        if (you.worshipped[GOD_LUGONU] == 0)</a>
<a name="ln3601">            gain_piety(20, 1, false);  // allow instant access to first power</a>
<a name="ln3602">    }},</a>
<a name="ln3603">#if TAG_MAJOR_VERSION == 34</a>
<a name="ln3604">    { GOD_PAKELLAS, _join_pakellas },</a>
<a name="ln3605">#endif</a>
<a name="ln3606">    { GOD_RU, _join_ru },</a>
<a name="ln3607">    { GOD_TROG, _join_trog },</a>
<a name="ln3608">    { GOD_ZIN, _join_zin },</a>
<a name="ln3609">};</a>
<a name="ln3610"> </a>
<a name="ln3611">void join_religion(god_type which_god)</a>
<a name="ln3612">{</a>
<a name="ln3613">    ASSERT(which_god != GOD_NO_GOD);</a>
<a name="ln3614">    ASSERT(which_god != GOD_ECUMENICAL);</a>
<a name="ln3615">    ASSERT(you.species != SP_DEMIGOD);</a>
<a name="ln3616"> </a>
<a name="ln3617">    redraw_screen();</a>
<a name="ln3618"> </a>
<a name="ln3619">    const god_type old_god = you.religion;</a>
<a name="ln3620">    if (you.previous_good_god == GOD_NO_GOD)</a>
<a name="ln3621">    {</a>
<a name="ln3622">        you.previous_good_god = old_god;</a>
<a name="ln3623">        you.saved_good_god_piety = you.piety;</a>
<a name="ln3624">        // doesn't matter if old_god isn't actually a good god; we check later</a>
<a name="ln3625">        // and then wipe it at the end of the function regardless</a>
<a name="ln3626">    }</a>
<a name="ln3627"> </a>
<a name="ln3628">    // Leave your prior religion first.</a>
<a name="ln3629">    if (!you_worship(GOD_NO_GOD))</a>
<a name="ln3630">        excommunication(true, which_god);</a>
<a name="ln3631"> </a>
<a name="ln3632">    // Welcome to the fold!</a>
<a name="ln3633">    you.religion = static_cast&lt;god_type&gt;(which_god);</a>
<a name="ln3634"> </a>
<a name="ln3635">    mark_milestone(&quot;god.worship&quot;, &quot;became a worshipper of &quot;</a>
<a name="ln3636">                   + god_name(you.religion) + &quot;.&quot;);</a>
<a name="ln3637">    take_note(Note(NOTE_GET_GOD, you.religion));</a>
<a name="ln3638"> </a>
<a name="ln3639">    simple_god_message(make_stringf(&quot; welcomes you%s!&quot;,</a>
<a name="ln3640">                                    you.worshipped[which_god] ? &quot; back&quot;</a>
<a name="ln3641">                                                              : &quot;&quot;).c_str());</a>
<a name="ln3642">    // included in default force_more_message</a>
<a name="ln3643">#ifdef DGL_WHEREIS</a>
<a name="ln3644">    whereis_record();</a>
<a name="ln3645">#endif</a>
<a name="ln3646"> </a>
<a name="ln3647">    set_god_ability_slots();    // remove old god's slots, reserve new god's</a>
<a name="ln3648"> </a>
<a name="ln3649">    _set_initial_god_piety();</a>
<a name="ln3650"> </a>
<a name="ln3651">    // When you start worshipping a good god, you make all non-hostile</a>
<a name="ln3652">    // unholy and evil beings hostile.</a>
<a name="ln3653">    if (is_good_god(you.religion)</a>
<a name="ln3654">        &amp;&amp; query_daction_counter(DACT_ALLY_UNHOLY_EVIL))</a>
<a name="ln3655">    {</a>
<a name="ln3656">        add_daction(DACT_ALLY_UNHOLY_EVIL);</a>
<a name="ln3657">        mprf(MSGCH_MONSTER_ENCHANT, &quot;Your unholy and evil allies forsake you.&quot;);</a>
<a name="ln3658">    }</a>
<a name="ln3659"> </a>
<a name="ln3660">    const function&lt;void ()&gt; *join_effect = map_find(on_join, you.religion);</a>
<a name="ln3661">    if (join_effect != nullptr)</a>
<a name="ln3662">        (*join_effect)();</a>
<a name="ln3663"> </a>
<a name="ln3664">    // after join_effect() so that gozag's service fee is right for monks</a>
<a name="ln3665">    if (you.worshipped[you.religion] &lt; 100)</a>
<a name="ln3666">        you.worshipped[you.religion]++;</a>
<a name="ln3667"> </a>
<a name="ln3668">    // after join_effect so that ru is initialized correctly for get_abilities</a>
<a name="ln3669">    // when flash_view_delay redraws the screen in local tiles</a>
<a name="ln3670">    _god_welcome_handle_gear();</a>
<a name="ln3671"> </a>
<a name="ln3672">    // Warn if a good god is starting wrath now.</a>
<a name="ln3673">    _check_good_god_wrath(old_god);</a>
<a name="ln3674"> </a>
<a name="ln3675">    if (!you_worship(GOD_GOZAG))</a>
<a name="ln3676">        for (const auto&amp; power : get_god_powers(you.religion))</a>
<a name="ln3677">            if (power.rank &lt;= 0)</a>
<a name="ln3678">                power.display(true, &quot;You can now %s.&quot;);</a>
<a name="ln3679"> </a>
<a name="ln3680">    // Allow training all divine ability skills immediately.</a>
<a name="ln3681">    vector&lt;ability_type&gt; abilities = get_god_abilities();</a>
<a name="ln3682">    for (ability_type abil : abilities)</a>
<a name="ln3683">        you.start_train.insert(abil_skill(abil));</a>
<a name="ln3684">    update_can_currently_train();</a>
<a name="ln3685"> </a>
<a name="ln3686">    // now that you have a god, you can't save any piety from your prev god</a>
<a name="ln3687">    you.previous_good_god = GOD_NO_GOD;</a>
<a name="ln3688">    you.saved_good_god_piety = 0;</a>
<a name="ln3689"> </a>
<a name="ln3690">    you.redraw_title = true;</a>
<a name="ln3691"> </a>
<a name="ln3692">#ifdef USE_TILE_LOCAL</a>
<a name="ln3693">    tiles.layout_statcol();</a>
<a name="ln3694">    redraw_screen();</a>
<a name="ln3695">#endif</a>
<a name="ln3696"> </a>
<a name="ln3697">    learned_something_new(HINT_CONVERT);</a>
<a name="ln3698">}</a>
<a name="ln3699"> </a>
<a name="ln3700">void god_pitch(god_type which_god)</a>
<a name="ln3701">{</a>
<a name="ln3702">    if (which_god == GOD_BEOGH &amp;&amp; grd(you.pos()) != DNGN_ALTAR_BEOGH)</a>
<a name="ln3703">        mpr(&quot;You bow before the missionary of Beogh.&quot;);</a>
<a name="ln3704">    else</a>
<a name="ln3705">    {</a>
<a name="ln3706">        mprf(&quot;You %s the altar of %s.&quot;,</a>
<a name="ln3707">             get_form()-&gt;player_prayer_action().c_str(),</a>
<a name="ln3708">             god_name(which_god).c_str());</a>
<a name="ln3709">    }</a>
<a name="ln3710">    // these are included in default force_more_message</a>
<a name="ln3711"> </a>
<a name="ln3712">    const int fee = (which_god == GOD_GOZAG) ? gozag_service_fee() : 0;</a>
<a name="ln3713"> </a>
<a name="ln3714">    // Note: using worship we could make some gods not allow followers to</a>
<a name="ln3715">    // return, or not allow worshippers from other religions. - bwr</a>
<a name="ln3716"> </a>
<a name="ln3717">    // Gods can be racist...</a>
<a name="ln3718">    if (!player_can_join_god(which_god))</a>
<a name="ln3719">    {</a>
<a name="ln3720">        you.turn_is_over = false;</a>
<a name="ln3721">        if (which_god == GOD_GOZAG)</a>
<a name="ln3722">        {</a>
<a name="ln3723">            simple_god_message(&quot; does not accept service from beggars like you!&quot;,</a>
<a name="ln3724">                               which_god);</a>
<a name="ln3725">            if (you.gold == 0)</a>
<a name="ln3726">            {</a>
<a name="ln3727">                mprf(&quot;The service fee for joining is currently %d gold; you have&quot;</a>
<a name="ln3728">                     &quot; none.&quot;, fee);</a>
<a name="ln3729">            }</a>
<a name="ln3730">            else</a>
<a name="ln3731">            {</a>
<a name="ln3732">                mprf(&quot;The service fee for joining is currently %d gold; you only&quot;</a>
<a name="ln3733">                     &quot; have %d.&quot;, fee, you.gold);</a>
<a name="ln3734">            }</a>
<a name="ln3735">        }</a>
<a name="ln3736">        else if (you.get_mutation_level(MUT_NO_LOVE)</a>
<a name="ln3737">                 &amp;&amp; _god_rejects_loveless(which_god))</a>
<a name="ln3738">        {</a>
<a name="ln3739">            simple_god_message(&quot; does not accept worship from the loveless!&quot;,</a>
<a name="ln3740">                               which_god);</a>
<a name="ln3741">        }</a>
<a name="ln3742">#if TAG_MAJOR_VERSION == 34</a>
<a name="ln3743">        else if (you.get_mutation_level(MUT_NO_ARTIFICE)</a>
<a name="ln3744">                 &amp;&amp; which_god == GOD_PAKELLAS)</a>
<a name="ln3745">        {</a>
<a name="ln3746">            simple_god_message(&quot; does not accept worship from those who are &quot;</a>
<a name="ln3747">                               &quot;unable to use magical devices!&quot;, which_god);</a>
<a name="ln3748">        }</a>
<a name="ln3749">#endif</a>
<a name="ln3750">        else if (!_transformed_player_can_join_god(which_god))</a>
<a name="ln3751">        {</a>
<a name="ln3752">            simple_god_message(&quot; says: How dare you approach in such a &quot;</a>
<a name="ln3753">                               &quot;loathsome form!&quot;,</a>
<a name="ln3754">                               which_god);</a>
<a name="ln3755">        }</a>
<a name="ln3756">        else</a>
<a name="ln3757">        {</a>
<a name="ln3758">            simple_god_message(&quot; does not accept worship from those such as&quot;</a>
<a name="ln3759">                               &quot; you!&quot;,</a>
<a name="ln3760">                               which_god);</a>
<a name="ln3761">        }</a>
<a name="ln3762">        return;</a>
<a name="ln3763">    }</a>
<a name="ln3764"> </a>
<a name="ln3765">    if (which_god == GOD_LUGONU &amp;&amp; you.penance[GOD_LUGONU])</a>
<a name="ln3766">    {</a>
<a name="ln3767">        you.turn_is_over = false;</a>
<a name="ln3768">        simple_god_message(&quot; refuses to forgive you so easily!&quot;, which_god);</a>
<a name="ln3769">        return;</a>
<a name="ln3770">    }</a>
<a name="ln3771"> </a>
<a name="ln3772">    if (describe_god_with_join(which_god))</a>
<a name="ln3773">        join_religion(which_god);</a>
<a name="ln3774">    else</a>
<a name="ln3775">    {</a>
<a name="ln3776">        you.turn_is_over = false;</a>
<a name="ln3777">        redraw_screen();</a>
<a name="ln3778">    }</a>
<a name="ln3779">}</a>
<a name="ln3780"> </a>
<a name="ln3781">/** Ask the user for a god by name.</a>
<a name="ln3782"> *</a>
<a name="ln3783"> * @param def_god The god to use if the user presses just ENTER</a>
<a name="ln3784"> *                (default NUM_GODS).</a>
<a name="ln3785"> * @return the best match for the user's input, or def_god if the user</a>
<a name="ln3786"> *         pressed ENTER without providing input, or NUM_GODS if the</a>
<a name="ln3787"> *         user cancelled or there was no match.</a>
<a name="ln3788"> */</a>
<a name="ln3789">god_type choose_god(god_type def_god)</a>
<a name="ln3790">{</a>
<a name="ln3791">    char specs[80];</a>
<a name="ln3792"> </a>
<a name="ln3793">    string help = def_god == NUM_GODS ? &quot;by name&quot;</a>
<a name="ln3794">                                      : &quot;default &quot; + god_name(def_god);</a>
<a name="ln3795">    string prompt = make_stringf(&quot;Which god (%s)? &quot;, help.c_str());</a>
<a name="ln3796"> </a>
<a name="ln3797">    if (msgwin_get_line(prompt, specs, sizeof(specs)) != 0)</a>
<a name="ln3798">        return NUM_GODS; // FIXME: distinguish cancellation from no match</a>
<a name="ln3799"> </a>
<a name="ln3800">    // If they pressed enter with no input.</a>
<a name="ln3801">    if (specs[0] == '\0')</a>
<a name="ln3802">        return def_god;</a>
<a name="ln3803"> </a>
<a name="ln3804">    string spec = lowercase_string(specs);</a>
<a name="ln3805"> </a>
<a name="ln3806">    return find_earliest_match(spec, GOD_NO_GOD, NUM_GODS,</a>
<a name="ln3807">                               always_true&lt;god_type&gt;,</a>
<a name="ln3808">                               bind(god_name, placeholders::_1, false));</a>
<a name="ln3809">}</a>
<a name="ln3810"> </a>
<a name="ln3811">int had_gods()</a>
<a name="ln3812">{</a>
<a name="ln3813">    int count = 0;</a>
<a name="ln3814">    for (god_iterator it; it; ++it)</a>
<a name="ln3815">        count += you.worshipped[*it];</a>
<a name="ln3816">    return count;</a>
<a name="ln3817">}</a>
<a name="ln3818"> </a>
<a name="ln3819">bool god_likes_your_god(god_type god, god_type your_god)</a>
<a name="ln3820">{</a>
<a name="ln3821">    return is_good_god(god) &amp;&amp; is_good_god(your_god);</a>
<a name="ln3822">}</a>
<a name="ln3823"> </a>
<a name="ln3824">bool god_hates_your_god(god_type god, god_type your_god)</a>
<a name="ln3825">{</a>
<a name="ln3826">    // Ru doesn't care.</a>
<a name="ln3827">    if (god == GOD_RU)</a>
<a name="ln3828">        return false;</a>
<a name="ln3829"> </a>
<a name="ln3830">    // Gods do not hate themselves.</a>
<a name="ln3831">    if (god == your_god)</a>
<a name="ln3832">        return false;</a>
<a name="ln3833"> </a>
<a name="ln3834">    // Non-good gods always hate your current god.</a>
<a name="ln3835">    if (!is_good_god(god))</a>
<a name="ln3836">        return true;</a>
<a name="ln3837"> </a>
<a name="ln3838">    // Zin hates chaotic gods.</a>
<a name="ln3839">    if (god == GOD_ZIN &amp;&amp; is_chaotic_god(your_god))</a>
<a name="ln3840">        return true;</a>
<a name="ln3841"> </a>
<a name="ln3842">    return is_evil_god(your_god);</a>
<a name="ln3843">}</a>
<a name="ln3844"> </a>
<a name="ln3845">bool god_hates_killing(god_type god, const monster&amp; mon)</a>
<a name="ln3846">{</a>
<a name="ln3847">    // Must be at least a creature of sorts. Smacking down an enchanted</a>
<a name="ln3848">    // weapon or disrupting a lightning doesn't count. Technically, this</a>
<a name="ln3849">    // might raise a concern about necromancy but zombies traditionally</a>
<a name="ln3850">    // count as creatures and that's the average person's (even if not ours)</a>
<a name="ln3851">    // intuition.</a>
<a name="ln3852">    if (mons_is_object(mon.type))</a>
<a name="ln3853">        return false;</a>
<a name="ln3854"> </a>
<a name="ln3855">    // kill as many illusions as you want.</a>
<a name="ln3856">    if (mon.is_illusion())</a>
<a name="ln3857">        return false;</a>
<a name="ln3858"> </a>
<a name="ln3859">    bool retval = false;</a>
<a name="ln3860">    const mon_holy_type holiness = mon.holiness();</a>
<a name="ln3861"> </a>
<a name="ln3862">    if (holiness &amp; MH_HOLY)</a>
<a name="ln3863">        retval = (is_good_god(god));</a>
<a name="ln3864">    else if (holiness &amp; MH_NATURAL)</a>
<a name="ln3865">        retval = (god == GOD_ELYVILON);</a>
<a name="ln3866"> </a>
<a name="ln3867">    if (god == GOD_FEDHAS)</a>
<a name="ln3868">        retval = (fedhas_protects(&amp;mon));</a>
<a name="ln3869"> </a>
<a name="ln3870">    return retval;</a>
<a name="ln3871">}</a>
<a name="ln3872"> </a>
<a name="ln3873">/**</a>
<a name="ln3874"> * Will the given god object if you eat a monster of this type?</a>
<a name="ln3875"> *</a>
<a name="ln3876"> * @param god       The god in question.</a>
<a name="ln3877"> * @param mc        The monster type to be eaten.</a>
<a name="ln3878"> * @return          Whether eating this monster will incur penance.</a>
<a name="ln3879"> */</a>
<a name="ln3880">bool god_hates_eating(god_type god, monster_type mc)</a>
<a name="ln3881">{</a>
<a name="ln3882">    if (god_hates_cannibalism(god) &amp;&amp; is_player_same_genus(mc))</a>
<a name="ln3883">        return true;</a>
<a name="ln3884">    if (is_good_god(you.religion) &amp;&amp; mons_class_holiness(mc) &amp; MH_HOLY)</a>
<a name="ln3885">        return true;</a>
<a name="ln3886">    if (you_worship(GOD_ZIN) &amp;&amp; mons_class_intel(mc) &gt;= I_HUMAN)</a>
<a name="ln3887">        return true;</a>
<a name="ln3888">    return false;</a>
<a name="ln3889">}</a>
<a name="ln3890"> </a>
<a name="ln3891">bool god_likes_spell(spell_type spell, god_type god)</a>
<a name="ln3892">{</a>
<a name="ln3893">    switch (god)</a>
<a name="ln3894">    {</a>
<a name="ln3895">    case GOD_VEHUMET:</a>
<a name="ln3896">        return vehumet_supports_spell(spell);</a>
<a name="ln3897">    case GOD_KIKUBAAQUDGHA:</a>
<a name="ln3898">        return spell_typematch(spell, spschool::necromancy);</a>
<a name="ln3899">    default: // quash unhandled constants warnings</a>
<a name="ln3900">        return false;</a>
<a name="ln3901">    }</a>
<a name="ln3902">}</a>
<a name="ln3903"> </a>
<a name="ln3904">/**</a>
<a name="ln3905"> * Does your god hate spellcasting?</a>
<a name="ln3906"> *</a>
<a name="ln3907"> * @param god           The god to check against</a>
<a name="ln3908"> * @return              Whether the god hates spellcasting</a>
<a name="ln3909"> */</a>
<a name="ln3910">bool god_hates_spellcasting(god_type god)</a>
<a name="ln3911">{</a>
<a name="ln3912">    return god == GOD_TROG;</a>
<a name="ln3913">}</a>
<a name="ln3914"> </a>
<a name="ln3915">/**</a>
<a name="ln3916"> * Will your god put you under penance if you actually cast spell?</a>
<a name="ln3917"> *</a>
<a name="ln3918"> * @param spell         The spell to check against</a>
<a name="ln3919"> * @param god           The god to check against</a>
<a name="ln3920"> * @param fake_spell    true if the spell is evoked or from an innate or divine ability</a>
<a name="ln3921"> *                      false if it is a spell being cast normally.</a>
<a name="ln3922"> * @return              true if the god hates the spell</a>
<a name="ln3923"> */</a>
<a name="ln3924">bool god_hates_spell(spell_type spell, god_type god, bool fake_spell)</a>
<a name="ln3925">{</a>
<a name="ln3926">    if (god_hates_spellcasting(god))</a>
<a name="ln3927">        return !fake_spell;</a>
<a name="ln3928"> </a>
<a name="ln3929">    if (god_punishes_spell(spell, god))</a>
<a name="ln3930">        return true;</a>
<a name="ln3931"> </a>
<a name="ln3932">    switch (god)</a>
<a name="ln3933">    {</a>
<a name="ln3934">    case GOD_CHEIBRIADOS:</a>
<a name="ln3935">        if (is_hasty_spell(spell))</a>
<a name="ln3936">            return true;</a>
<a name="ln3937">        break;</a>
<a name="ln3938">#if TAG_MAJOR_VERSION == 34</a>
<a name="ln3939">    case GOD_PAKELLAS:</a>
<a name="ln3940">        if (spell == SPELL_SUBLIMATION_OF_BLOOD)</a>
<a name="ln3941">            return true;</a>
<a name="ln3942">        break;</a>
<a name="ln3943">#endif</a>
<a name="ln3944">    default:</a>
<a name="ln3945">        break;</a>
<a name="ln3946">    }</a>
<a name="ln3947">    return false;</a>
<a name="ln3948">}</a>
<a name="ln3949"> </a>
<a name="ln3950">/**</a>
<a name="ln3951"> * Will your god excommunicate you if you actually cast spell?</a>
<a name="ln3952"> *</a>
<a name="ln3953"> * @param spell         The spell to check against</a>
<a name="ln3954"> * @param god           The god to check against</a>
<a name="ln3955"> * @return              Whether the god loathes the spell</a>
<a name="ln3956"> */</a>
<a name="ln3957">bool god_loathes_spell(spell_type spell, god_type god)</a>
<a name="ln3958">{</a>
<a name="ln3959">    if (spell == SPELL_NECROMUTATION &amp;&amp; is_good_god(god))</a>
<a name="ln3960">        return true;</a>
<a name="ln3961">    if (spell == SPELL_STATUE_FORM &amp;&amp; god == GOD_YREDELEMNUL)</a>
<a name="ln3962">        return true;</a>
<a name="ln3963">    return false;</a>
<a name="ln3964">}</a>
<a name="ln3965"> </a>
<a name="ln3966">/**</a>
<a name="ln3967"> * Checks to see if your god hates or loathes this spell,</a>
<a name="ln3968"> * or just hates spellcasting in general, and returns a warning string</a>
<a name="ln3969"> *</a>
<a name="ln3970"> * @param spell         The spell to check against</a>
<a name="ln3971"> * @param god           The god to check against</a>
<a name="ln3972"> * @return              Warning string if god has strong opinions on spell</a>
<a name="ln3973"> *                      Empty string if god doesn't care about spell</a>
<a name="ln3974"> */</a>
<a name="ln3975">string god_spell_warn_string(spell_type spell, god_type god)</a>
<a name="ln3976">{</a>
<a name="ln3977">    if (god_loathes_spell(spell, god))</a>
<a name="ln3978">        return &quot;Your god extremely despises this spell!&quot;;</a>
<a name="ln3979">    else if (god_hates_spellcasting(god))</a>
<a name="ln3980">        return &quot;Your god hates spellcasting!&quot;;</a>
<a name="ln3981">    else if (god_hates_spell(spell, god))</a>
<a name="ln3982">        return &quot;Your god hates this spell!&quot;;</a>
<a name="ln3983">    else</a>
<a name="ln3984">        return &quot;&quot;;</a>
<a name="ln3985">}</a>
<a name="ln3986"> </a>
<a name="ln3987">bool god_hates_ability(ability_type ability, god_type god)</a>
<a name="ln3988">{</a>
<a name="ln3989">    switch (ability)</a>
<a name="ln3990">    {</a>
<a name="ln3991">        case ABIL_EVOKE_BERSERK:</a>
<a name="ln3992">            return god == GOD_CHEIBRIADOS;</a>
<a name="ln3993">        default:</a>
<a name="ln3994">            break;</a>
<a name="ln3995">    }</a>
<a name="ln3996">    return false;</a>
<a name="ln3997">}</a>
<a name="ln3998"> </a>
<a name="ln3999">lifesaving_chance elyvilon_lifesaving()</a>
<a name="ln4000">{</a>
<a name="ln4001">    if (!you_worship(GOD_ELYVILON))</a>
<a name="ln4002">        return lifesaving_chance::never;</a>
<a name="ln4003"> </a>
<a name="ln4004">    if (you.piety &lt; piety_breakpoint(0))</a>
<a name="ln4005">        return lifesaving_chance::never;</a>
<a name="ln4006"> </a>
<a name="ln4007">    return you.piety &gt;= piety_breakpoint(4) ? lifesaving_chance::always</a>
<a name="ln4008">                           : lifesaving_chance::sometimes;</a>
<a name="ln4009">}</a>
<a name="ln4010"> </a>
<a name="ln4011">bool god_protects_from_harm()</a>
<a name="ln4012">{</a>
<a name="ln4013">    if (you.duration[DUR_LIFESAVING])</a>
<a name="ln4014">    {</a>
<a name="ln4015">        switch (elyvilon_lifesaving())</a>
<a name="ln4016">        {</a>
<a name="ln4017">        case lifesaving_chance::sometimes:</a>
<a name="ln4018">            if (random2(you.piety) &gt;= piety_breakpoint(0))</a>
<a name="ln4019">                return true;</a>
<a name="ln4020">            break;</a>
<a name="ln4021">        case lifesaving_chance::always:</a>
<a name="ln4022">            // Reliable lifesaving is costly.</a>
<a name="ln4023">            lose_piety(21 + random2(20));</a>
<a name="ln4024">            return true;</a>
<a name="ln4025">        default:</a>
<a name="ln4026">            break;</a>
<a name="ln4027">        }</a>
<a name="ln4028">    }</a>
<a name="ln4029"> </a>
<a name="ln4030">    if (have_passive(passive_t::protect_from_harm)</a>
<a name="ln4031">        &amp;&amp; (one_chance_in(10) || x_chance_in_y(you.piety, 1000)))</a>
<a name="ln4032">    {</a>
<a name="ln4033">        return true;</a>
<a name="ln4034">    }</a>
<a name="ln4035"> </a>
<a name="ln4036">    return false;</a>
<a name="ln4037">}</a>
<a name="ln4038"> </a>
<a name="ln4039">void handle_god_time(int /*time_delta*/)</a>
<a name="ln4040">{</a>
<a name="ln4041">    if (you.attribute[ATTR_GOD_WRATH_COUNT] &gt; 0)</a>
<a name="ln4042">    {</a>
<a name="ln4043">        vector&lt;god_type&gt; angry_gods;</a>
<a name="ln4044">        // First count the number of gods to whom we owe penance.</a>
<a name="ln4045">        for (god_iterator it; it; ++it)</a>
<a name="ln4046">        {</a>
<a name="ln4047">            if (active_penance(*it))</a>
<a name="ln4048">                angry_gods.push_back(*it);</a>
<a name="ln4049">        }</a>
<a name="ln4050">        if (x_chance_in_y(angry_gods.size(), 20))</a>
<a name="ln4051">        {</a>
<a name="ln4052">            // This should be guaranteed; otherwise the god wouldn't have</a>
<a name="ln4053">            // appeared in the angry_gods list.</a>
<a name="ln4054">            const bool succ = divine_retribution(*random_iterator(angry_gods));</a>
<a name="ln4055">            ASSERT(succ);</a>
<a name="ln4056">        }</a>
<a name="ln4057">        you.attribute[ATTR_GOD_WRATH_COUNT]--;</a>
<a name="ln4058">    }</a>
<a name="ln4059"> </a>
<a name="ln4060">    // Update the god's opinion of the player.</a>
<a name="ln4061">    if (!you_worship(GOD_NO_GOD))</a>
<a name="ln4062">    {</a>
<a name="ln4063">        int delay;</a>
<a name="ln4064">        int sacrifice_count;</a>
<a name="ln4065">        switch (you.religion)</a>
<a name="ln4066">        {</a>
<a name="ln4067">        case GOD_TROG:</a>
<a name="ln4068">        case GOD_OKAWARU:</a>
<a name="ln4069">        case GOD_MAKHLEB:</a>
<a name="ln4070">        case GOD_BEOGH:</a>
<a name="ln4071">        case GOD_LUGONU:</a>
<a name="ln4072">        case GOD_DITHMENOS:</a>
<a name="ln4073">        case GOD_QAZLAL:</a>
<a name="ln4074">        case GOD_YREDELEMNUL:</a>
<a name="ln4075">        case GOD_KIKUBAAQUDGHA:</a>
<a name="ln4076">        case GOD_VEHUMET:</a>
<a name="ln4077">        case GOD_ZIN:</a>
<a name="ln4078">#if TAG_MAJOR_VERSION == 34</a>
<a name="ln4079">        case GOD_PAKELLAS:</a>
<a name="ln4080">#endif</a>
<a name="ln4081">        case GOD_JIYVA:</a>
<a name="ln4082">        case GOD_WU_JIAN:</a>
<a name="ln4083">        case GOD_SIF_MUNA:</a>
<a name="ln4084">            if (one_chance_in(17))</a>
<a name="ln4085">                lose_piety(1);</a>
<a name="ln4086">            break;</a>
<a name="ln4087"> </a>
<a name="ln4088">        case GOD_ASHENZARI:</a>
<a name="ln4089">        case GOD_ELYVILON:</a>
<a name="ln4090">        case GOD_HEPLIAKLQANA:</a>
<a name="ln4091">        case GOD_FEDHAS:</a>
<a name="ln4092">        case GOD_CHEIBRIADOS:</a>
<a name="ln4093">        case GOD_SHINING_ONE:</a>
<a name="ln4094">        case GOD_NEMELEX_XOBEH:</a>
<a name="ln4095">            if (one_chance_in(35))</a>
<a name="ln4096">                lose_piety(1);</a>
<a name="ln4097">            break;</a>
<a name="ln4098"> </a>
<a name="ln4099">        case GOD_RU:</a>
<a name="ln4100">            ASSERT(you.props.exists(RU_SACRIFICE_PROGRESS_KEY));</a>
<a name="ln4101">            ASSERT(you.props.exists(RU_SACRIFICE_DELAY_KEY));</a>
<a name="ln4102">            ASSERT(you.props.exists(AVAILABLE_SAC_KEY));</a>
<a name="ln4103"> </a>
<a name="ln4104">            delay = you.props[RU_SACRIFICE_DELAY_KEY].get_int();</a>
<a name="ln4105">            sacrifice_count = you.props[AVAILABLE_SAC_KEY].get_vector().size();</a>
<a name="ln4106"> </a>
<a name="ln4107">            // 6* is max piety for Ru</a>
<a name="ln4108">            if (sacrifice_count == 0 &amp;&amp; you.piety &lt; piety_breakpoint(5)</a>
<a name="ln4109">                &amp;&amp; you.props[RU_SACRIFICE_PROGRESS_KEY].get_int() &gt;= delay)</a>
<a name="ln4110">            {</a>
<a name="ln4111">              ru_offer_new_sacrifices();</a>
<a name="ln4112">            }</a>
<a name="ln4113"> </a>
<a name="ln4114">            break;</a>
<a name="ln4115"> </a>
<a name="ln4116">        case GOD_USKAYAW:</a>
<a name="ln4117">            // We handle Uskayaw elsewhere because this func gets called rarely</a>
<a name="ln4118">        case GOD_GOZAG:</a>
<a name="ln4119">        case GOD_XOM:</a>
<a name="ln4120">            // Gods without normal piety do nothing each tick.</a>
<a name="ln4121">            return;</a>
<a name="ln4122"> </a>
<a name="ln4123">        case GOD_NO_GOD:</a>
<a name="ln4124">        case GOD_RANDOM:</a>
<a name="ln4125">        case GOD_ECUMENICAL:</a>
<a name="ln4126">        case GOD_NAMELESS:</a>
<a name="ln4127">        case NUM_GODS:</a>
<a name="ln4128">            die(&quot;Bad god, no bishop!&quot;);</a>
<a name="ln4129">            return;</a>
<a name="ln4130"> </a>
<a name="ln4131">        }</a>
<a name="ln4132"> </a>
<a name="ln4133">        if (you.piety &lt; 1)</a>
<a name="ln4134">            excommunication();</a>
<a name="ln4135">    }</a>
<a name="ln4136">}</a>
<a name="ln4137"> </a>
<a name="ln4138">int god_colour(god_type god) // mv - added</a>
<a name="ln4139">{</a>
<a name="ln4140">    switch (god)</a>
<a name="ln4141">    {</a>
<a name="ln4142">    case GOD_ZIN:</a>
<a name="ln4143">    case GOD_SHINING_ONE:</a>
<a name="ln4144">    case GOD_ELYVILON:</a>
<a name="ln4145">    case GOD_OKAWARU:</a>
<a name="ln4146">    case GOD_FEDHAS:</a>
<a name="ln4147">        return CYAN;</a>
<a name="ln4148"> </a>
<a name="ln4149">    case GOD_YREDELEMNUL:</a>
<a name="ln4150">    case GOD_KIKUBAAQUDGHA:</a>
<a name="ln4151">    case GOD_MAKHLEB:</a>
<a name="ln4152">    case GOD_VEHUMET:</a>
<a name="ln4153">    case GOD_TROG:</a>
<a name="ln4154">    case GOD_BEOGH:</a>
<a name="ln4155">    case GOD_LUGONU:</a>
<a name="ln4156">    case GOD_ASHENZARI:</a>
<a name="ln4157">    case GOD_WU_JIAN:</a>
<a name="ln4158">        return LIGHTRED;</a>
<a name="ln4159"> </a>
<a name="ln4160">    case GOD_GOZAG:</a>
<a name="ln4161">    case GOD_XOM:</a>
<a name="ln4162">        return YELLOW;</a>
<a name="ln4163"> </a>
<a name="ln4164">    case GOD_NEMELEX_XOBEH:</a>
<a name="ln4165">        return LIGHTMAGENTA;</a>
<a name="ln4166"> </a>
<a name="ln4167">    case GOD_SIF_MUNA:</a>
<a name="ln4168">        return LIGHTBLUE;</a>
<a name="ln4169"> </a>
<a name="ln4170">    case GOD_JIYVA:</a>
<a name="ln4171">        return GREEN;</a>
<a name="ln4172"> </a>
<a name="ln4173">    case GOD_CHEIBRIADOS:</a>
<a name="ln4174">    case GOD_HEPLIAKLQANA:</a>
<a name="ln4175">        return LIGHTCYAN;</a>
<a name="ln4176"> </a>
<a name="ln4177">    case GOD_DITHMENOS:</a>
<a name="ln4178">    case GOD_USKAYAW:</a>
<a name="ln4179">        return MAGENTA;</a>
<a name="ln4180"> </a>
<a name="ln4181">    case GOD_QAZLAL:</a>
<a name="ln4182">    case GOD_RU:</a>
<a name="ln4183">        return BROWN;</a>
<a name="ln4184"> </a>
<a name="ln4185">#if TAG_MAJOR_VERSION == 34</a>
<a name="ln4186">    case GOD_PAKELLAS:</a>
<a name="ln4187">        return LIGHTGREEN;</a>
<a name="ln4188">#endif</a>
<a name="ln4189"> </a>
<a name="ln4190">    case GOD_NO_GOD:</a>
<a name="ln4191">    case NUM_GODS:</a>
<a name="ln4192">    case GOD_RANDOM:</a>
<a name="ln4193">    case GOD_NAMELESS:</a>
<a name="ln4194">    default:</a>
<a name="ln4195">        break;</a>
<a name="ln4196">    }</a>
<a name="ln4197"> </a>
<a name="ln4198">    return YELLOW;</a>
<a name="ln4199">}</a>
<a name="ln4200"> </a>
<a name="ln4201">colour_t god_message_altar_colour(god_type god)</a>
<a name="ln4202">{</a>
<a name="ln4203">    int rnd;</a>
<a name="ln4204"> </a>
<a name="ln4205">    switch (god)</a>
<a name="ln4206">    {</a>
<a name="ln4207">    case GOD_SHINING_ONE:</a>
<a name="ln4208">        return YELLOW;</a>
<a name="ln4209"> </a>
<a name="ln4210">    case GOD_ZIN:</a>
<a name="ln4211">        return WHITE;</a>
<a name="ln4212"> </a>
<a name="ln4213">    case GOD_ELYVILON:</a>
<a name="ln4214">        return LIGHTBLUE;     // Really, LIGHTGREY but that's plain text.</a>
<a name="ln4215"> </a>
<a name="ln4216">    case GOD_OKAWARU:</a>
<a name="ln4217">        return CYAN;</a>
<a name="ln4218"> </a>
<a name="ln4219">    case GOD_YREDELEMNUL:</a>
<a name="ln4220">        return random_choose(DARKGREY, RED);</a>
<a name="ln4221"> </a>
<a name="ln4222">    case GOD_BEOGH:</a>
<a name="ln4223">        return random_choose(BROWN, LIGHTRED);</a>
<a name="ln4224"> </a>
<a name="ln4225">    case GOD_KIKUBAAQUDGHA:</a>
<a name="ln4226">        return DARKGREY;</a>
<a name="ln4227"> </a>
<a name="ln4228">    case GOD_FEDHAS:</a>
<a name="ln4229">        return random_choose(BROWN, GREEN);</a>
<a name="ln4230"> </a>
<a name="ln4231">    case GOD_XOM:</a>
<a name="ln4232">        return random2(15) + 1;</a>
<a name="ln4233"> </a>
<a name="ln4234">    case GOD_VEHUMET:</a>
<a name="ln4235">        rnd = random2(3);</a>
<a name="ln4236">        return (rnd == 0) ? LIGHTMAGENTA :</a>
<a name="ln4237">               (rnd == 1) ? LIGHTRED</a>
<a name="ln4238">                          : LIGHTBLUE;</a>
<a name="ln4239"> </a>
<a name="ln4240">    case GOD_MAKHLEB:</a>
<a name="ln4241">        rnd = random2(3);</a>
<a name="ln4242">        return (rnd == 0) ? RED :</a>
<a name="ln4243">               (rnd == 1) ? LIGHTRED</a>
<a name="ln4244">                          : YELLOW;</a>
<a name="ln4245"> </a>
<a name="ln4246">    case GOD_TROG:</a>
<a name="ln4247">        return RED;</a>
<a name="ln4248"> </a>
<a name="ln4249">    case GOD_NEMELEX_XOBEH:</a>
<a name="ln4250">        return LIGHTMAGENTA;</a>
<a name="ln4251"> </a>
<a name="ln4252">    case GOD_SIF_MUNA:</a>
<a name="ln4253">        return BLUE;</a>
<a name="ln4254"> </a>
<a name="ln4255">    case GOD_LUGONU:</a>
<a name="ln4256">    case GOD_WU_JIAN:</a>
<a name="ln4257">        return LIGHTRED;</a>
<a name="ln4258"> </a>
<a name="ln4259">    case GOD_CHEIBRIADOS:</a>
<a name="ln4260">        return LIGHTCYAN;</a>
<a name="ln4261"> </a>
<a name="ln4262">    case GOD_JIYVA:</a>
<a name="ln4263">        return random_choose(GREEN, LIGHTGREEN);</a>
<a name="ln4264"> </a>
<a name="ln4265">    case GOD_DITHMENOS:</a>
<a name="ln4266">        return MAGENTA;</a>
<a name="ln4267"> </a>
<a name="ln4268">    case GOD_GOZAG:</a>
<a name="ln4269">        return random_choose(YELLOW, BROWN);</a>
<a name="ln4270"> </a>
<a name="ln4271">    case GOD_QAZLAL:</a>
<a name="ln4272">    case GOD_RU:</a>
<a name="ln4273">        return BROWN;</a>
<a name="ln4274"> </a>
<a name="ln4275">#if TAG_MAJOR_VERSION == 34</a>
<a name="ln4276">    case GOD_PAKELLAS:</a>
<a name="ln4277">        return random_choose(LIGHTMAGENTA, LIGHTGREEN, LIGHTCYAN);</a>
<a name="ln4278">#endif</a>
<a name="ln4279"> </a>
<a name="ln4280">    case GOD_USKAYAW:</a>
<a name="ln4281">        return random_choose(RED, MAGENTA);</a>
<a name="ln4282"> </a>
<a name="ln4283">    case GOD_HEPLIAKLQANA:</a>
<a name="ln4284">        return random_choose(LIGHTGREEN, LIGHTBLUE);</a>
<a name="ln4285"> </a>
<a name="ln4286">    default:</a>
<a name="ln4287">        return YELLOW;</a>
<a name="ln4288">    }</a>
<a name="ln4289">}</a>
<a name="ln4290"> </a>
<a name="ln4291">int piety_rank(int piety)</a>
<a name="ln4292">{</a>
<a name="ln4293">    // XXX: this seems to be used only in dat/database/godspeak.txt?</a>
<a name="ln4294">    if (you_worship(GOD_XOM))</a>
<a name="ln4295">    {</a>
<a name="ln4296">        const int breakpoints[] = { 20, 50, 80, 120, 180, INT_MAX };</a>
<a name="ln4297">        for (unsigned int i = 0; i &lt; ARRAYSZ(breakpoints); ++i)</a>
<a name="ln4298">            if (piety &lt;= breakpoints[i])</a>
<a name="ln4299">                return i + 1;</a>
<a name="ln4300">        die(&quot;INT_MAX is no good&quot;);</a>
<a name="ln4301">    }</a>
<a name="ln4302"> </a>
<a name="ln4303">    for (int i = NUM_PIETY_STARS; i &gt;= 1; --i)</a>
<a name="ln4304">        if (piety &gt;= piety_breakpoint(i - 1))</a>
<a name="ln4305">            return i;</a>
<a name="ln4306"> </a>
<a name="ln4307">    return 0;</a>
<a name="ln4308">}</a>
<a name="ln4309"> </a>
<a name="ln4310">int piety_breakpoint(int i)</a>
<a name="ln4311">{</a>
<a name="ln4312">    int breakpoints[NUM_PIETY_STARS] = { 30, 50, 75, 100, 120, 160 };</a>
<a name="ln4313">    if (i &gt;= NUM_PIETY_STARS || i &lt; 0)</a>
<a name="ln4314">        return 255;</a>
<a name="ln4315">    else</a>
<a name="ln4316">        return breakpoints[i];</a>
<a name="ln4317">}</a>
<a name="ln4318"> </a>
<a name="ln4319">int get_monster_tension(const monster&amp; mons, god_type god)</a>
<a name="ln4320">{</a>
<a name="ln4321">    if (!mons.alive())</a>
<a name="ln4322">        return 0;</a>
<a name="ln4323"> </a>
<a name="ln4324">    if (you.see_cell(mons.pos()))</a>
<a name="ln4325">    {</a>
<a name="ln4326">        if (!mons_can_hurt_player(&amp;mons))</a>
<a name="ln4327">            return 0;</a>
<a name="ln4328">    }</a>
<a name="ln4329"> </a>
<a name="ln4330">    const mon_attitude_type att = mons_attitude(mons);</a>
<a name="ln4331">    if (att == ATT_GOOD_NEUTRAL || att == ATT_NEUTRAL)</a>
<a name="ln4332">        return 0;</a>
<a name="ln4333"> </a>
<a name="ln4334">    if (mons.cannot_act() || mons.asleep() || mons_is_fleeing(mons))</a>
<a name="ln4335">        return 0;</a>
<a name="ln4336"> </a>
<a name="ln4337">    int exper = exper_value(mons);</a>
<a name="ln4338">    if (exper &lt;= 0)</a>
<a name="ln4339">        return 0;</a>
<a name="ln4340"> </a>
<a name="ln4341">    // Almost dead monsters don't count as much.</a>
<a name="ln4342">    exper *= mons.hit_points;</a>
<a name="ln4343">    exper /= mons.max_hit_points;</a>
<a name="ln4344"> </a>
<a name="ln4345">    bool gift = false;</a>
<a name="ln4346"> </a>
<a name="ln4347">    if (god != GOD_NO_GOD)</a>
<a name="ln4348">        gift = mons_is_god_gift(mons, god);</a>
<a name="ln4349"> </a>
<a name="ln4350">    if (att == ATT_HOSTILE)</a>
<a name="ln4351">    {</a>
<a name="ln4352">        // God is punishing you with a hostile gift, so it doesn't</a>
<a name="ln4353">        // count towards tension.</a>
<a name="ln4354">        if (gift)</a>
<a name="ln4355">            return 0;</a>
<a name="ln4356">    }</a>
<a name="ln4357">    else if (att == ATT_FRIENDLY)</a>
<a name="ln4358">    {</a>
<a name="ln4359">        // Friendly monsters being around to help you reduce</a>
<a name="ln4360">        // tension.</a>
<a name="ln4361">        exper = -exper;</a>
<a name="ln4362"> </a>
<a name="ln4363">        // If it's a god gift, it reduces tension even more, since</a>
<a name="ln4364">        // the god is already helping you out.</a>
<a name="ln4365">        if (gift)</a>
<a name="ln4366">            exper *= 2;</a>
<a name="ln4367">    }</a>
<a name="ln4368"> </a>
<a name="ln4369">    if (att != ATT_FRIENDLY)</a>
<a name="ln4370">    {</a>
<a name="ln4371">        if (!you.visible_to(&amp;mons))</a>
<a name="ln4372">            exper /= 2;</a>
<a name="ln4373">        if (!mons.visible_to(&amp;you))</a>
<a name="ln4374">            exper *= 2;</a>
<a name="ln4375">    }</a>
<a name="ln4376"> </a>
<a name="ln4377">    if (mons.confused() || mons.caught())</a>
<a name="ln4378">        exper /= 2;</a>
<a name="ln4379"> </a>
<a name="ln4380">    if (mons.has_ench(ENCH_SLOW))</a>
<a name="ln4381">    {</a>
<a name="ln4382">        exper *= 2;</a>
<a name="ln4383">        exper /= 3;</a>
<a name="ln4384">    }</a>
<a name="ln4385"> </a>
<a name="ln4386">    if (mons.has_ench(ENCH_HASTE))</a>
<a name="ln4387">    {</a>
<a name="ln4388">        exper *= 3;</a>
<a name="ln4389">        exper /= 2;</a>
<a name="ln4390">    }</a>
<a name="ln4391"> </a>
<a name="ln4392">    if (mons.has_ench(ENCH_MIGHT))</a>
<a name="ln4393">    {</a>
<a name="ln4394">        exper *= 5;</a>
<a name="ln4395">        exper /= 4;</a>
<a name="ln4396">    }</a>
<a name="ln4397"> </a>
<a name="ln4398">    if (mons.berserk_or_insane())</a>
<a name="ln4399">    {</a>
<a name="ln4400">        // in addition to haste and might bonuses above</a>
<a name="ln4401">        exper *= 3;</a>
<a name="ln4402">        exper /= 2;</a>
<a name="ln4403">    }</a>
<a name="ln4404"> </a>
<a name="ln4405">    return exper;</a>
<a name="ln4406">}</a>
<a name="ln4407"> </a>
<a name="ln4408">int get_tension(god_type god)</a>
<a name="ln4409">{</a>
<a name="ln4410">    int total = 0;</a>
<a name="ln4411"> </a>
<a name="ln4412">    bool nearby_monster = false;</a>
<a name="ln4413">    for (radius_iterator ri(you.pos(), LOS_NO_TRANS); ri; ++ri)</a>
<a name="ln4414">    {</a>
<a name="ln4415">        const monster* mon = monster_at(*ri);</a>
<a name="ln4416"> </a>
<a name="ln4417">        if (mon &amp;&amp; mon-&gt;alive() &amp;&amp; you.can_see(*mon))</a>
<a name="ln4418">        {</a>
<a name="ln4419">            int exper = get_monster_tension(*mon, god);</a>
<a name="ln4420"> </a>
<a name="ln4421">            if (!mon-&gt;wont_attack())</a>
<a name="ln4422">                nearby_monster = true;</a>
<a name="ln4423"> </a>
<a name="ln4424">            total += exper;</a>
<a name="ln4425">        }</a>
<a name="ln4426">    }</a>
<a name="ln4427"> </a>
<a name="ln4428">    // At least one monster has to be nearby, for tension to count.</a>
<a name="ln4429">    if (!nearby_monster)</a>
<a name="ln4430">        return 0;</a>
<a name="ln4431"> </a>
<a name="ln4432">    const int scale = 1;</a>
<a name="ln4433"> </a>
<a name="ln4434">    int tension = total;</a>
<a name="ln4435"> </a>
<a name="ln4436">    // Tension goes up inversely proportional to the percentage of max</a>
<a name="ln4437">    // hp you have.</a>
<a name="ln4438">    tension *= (scale + 1) * you.hp_max;</a>
<a name="ln4439">    tension /= max(you.hp_max + scale * you.hp, 1);</a>
<a name="ln4440"> </a>
<a name="ln4441">    // Divides by 1 at level 1, 200 at level 27.</a>
<a name="ln4442">    const int exp_lev  = you.get_experience_level();</a>
<a name="ln4443">    const int exp_need = exp_needed(exp_lev);</a>
<a name="ln4444">    const int factor   = (int)ceil(sqrt(exp_need / 30.0));</a>
<a name="ln4445">    const int div      = 1 + factor;</a>
<a name="ln4446"> </a>
<a name="ln4447">    tension /= div;</a>
<a name="ln4448"> </a>
<a name="ln4449">    if (player_in_branch(BRANCH_ABYSS))</a>
<a name="ln4450">    {</a>
<a name="ln4451">        if (tension &lt; 2)</a>
<a name="ln4452">            tension = 2;</a>
<a name="ln4453">        else</a>
<a name="ln4454">        {</a>
<a name="ln4455">            tension *= 3;</a>
<a name="ln4456">            tension /= 2;</a>
<a name="ln4457">        }</a>
<a name="ln4458">    }</a>
<a name="ln4459"> </a>
<a name="ln4460">    if (you.cannot_act())</a>
<a name="ln4461">    {</a>
<a name="ln4462">        tension *= 10;</a>
<a name="ln4463">        tension  = max(1, tension);</a>
<a name="ln4464"> </a>
<a name="ln4465">        return tension;</a>
<a name="ln4466">    }</a>
<a name="ln4467"> </a>
<a name="ln4468">    if (you.confused())</a>
<a name="ln4469">        tension *= 2;</a>
<a name="ln4470"> </a>
<a name="ln4471">    if (you.caught())</a>
<a name="ln4472">        tension *= 2;</a>
<a name="ln4473"> </a>
<a name="ln4474">    if (you.duration[DUR_SLOW])</a>
<a name="ln4475">    {</a>
<a name="ln4476">        tension *= 3;</a>
<a name="ln4477">        tension /= 2;</a>
<a name="ln4478">    }</a>
<a name="ln4479"> </a>
<a name="ln4480">    if (you.duration[DUR_HASTE])</a>
<a name="ln4481">    {</a>
<a name="ln4482">        tension *= 2;</a>
<a name="ln4483">        tension /= 3;</a>
<a name="ln4484">    }</a>
<a name="ln4485"> </a>
<a name="ln4486">    return max(0, tension);</a>
<a name="ln4487">}</a>
<a name="ln4488"> </a>
<a name="ln4489">int get_fuzzied_monster_difficulty(const monster&amp; mons)</a>
<a name="ln4490">{</a>
<a name="ln4491">    double factor = sqrt(exp_needed(you.experience_level) / 30.0);</a>
<a name="ln4492">    int exp = exper_value(mons) * 100;</a>
<a name="ln4493">    exp = random2(exp) + random2(exp);</a>
<a name="ln4494">    return exp / (1 + factor);</a>
<a name="ln4495">}</a>
<a name="ln4496"> </a>
<a name="ln4497">/////////////////////////////////////////////////////////////////////////////</a>
<a name="ln4498">// Stuff for placing god gift monsters after the player's turn has ended.</a>
<a name="ln4499">/////////////////////////////////////////////////////////////////////////////</a>
<a name="ln4500"> </a>
<a name="ln4501">static vector&lt;mgen_data&gt;       _delayed_data;</a>
<a name="ln4502">static deque&lt;delayed_callback&gt; _delayed_callbacks;</a>
<a name="ln4503">static deque&lt;unsigned int&gt;     _delayed_done_trigger_pos;</a>
<a name="ln4504">static deque&lt;delayed_callback&gt; _delayed_done_callbacks;</a>
<a name="ln4505">static deque&lt;string&gt;      _delayed_success;</a>
<a name="ln4506"> </a>
<a name="ln4507">void delayed_monster(const mgen_data &amp;mg, delayed_callback callback)</a>
<a name="ln4508">{</a>
<a name="ln4509">    _delayed_data.push_back(mg);</a>
<a name="ln4510">    _delayed_callbacks.push_back(callback);</a>
<a name="ln4511">}</a>
<a name="ln4512"> </a>
<a name="ln4513">void delayed_monster_done(string success, delayed_callback callback)</a>
<a name="ln4514">{</a>
<a name="ln4515">    const unsigned int size = _delayed_data.size();</a>
<a name="ln4516">    ASSERT(size &gt; 0);</a>
<a name="ln4517"> </a>
<a name="ln4518">    _delayed_done_trigger_pos.push_back(size - 1);</a>
<a name="ln4519">    _delayed_success.push_back(success);</a>
<a name="ln4520">    _delayed_done_callbacks.push_back(callback);</a>
<a name="ln4521">}</a>
<a name="ln4522"> </a>
<a name="ln4523">static void _place_delayed_monsters()</a>
<a name="ln4524">{</a>
<a name="ln4525">    // Last monster that was successfully placed (so far).</a>
<a name="ln4526">    monster *lastmon  = nullptr;</a>
<a name="ln4527">    int      placed   = 0;</a>
<a name="ln4528">    god_type prev_god = GOD_NO_GOD;</a>
<a name="ln4529"> </a>
<a name="ln4530">    for (unsigned int i = 0; i &lt; _delayed_data.size(); i++)</a>
<a name="ln4531">    {</a>
<a name="ln4532">        mgen_data &amp;mg          = _delayed_data[i];</a>
<a name="ln4533">        delayed_callback cback = _delayed_callbacks[i];</a>
<a name="ln4534"> </a>
<a name="ln4535">        if (prev_god != mg.god)</a>
<a name="ln4536">        {</a>
<a name="ln4537">            lastmon  = nullptr;</a>
<a name="ln4538">            placed   = 0;</a>
<a name="ln4539">            prev_god = mg.god;</a>
<a name="ln4540">        }</a>
<a name="ln4541"> </a>
<a name="ln4542">        monster *mon = create_monster(mg);</a>
<a name="ln4543"> </a>
<a name="ln4544">        if (cback)</a>
<a name="ln4545">            (*cback)(mg, mon, placed);</a>
<a name="ln4546"> </a>
<a name="ln4547">        if (mon)</a>
<a name="ln4548">        {</a>
<a name="ln4549">            if (you_worship(GOD_YREDELEMNUL)</a>
<a name="ln4550">                || you_worship(GOD_HEPLIAKLQANA)</a>
<a name="ln4551">                || have_passive(passive_t::convert_orcs))</a>
<a name="ln4552">            {</a>
<a name="ln4553">                add_companion(mon);</a>
<a name="ln4554">            }</a>
<a name="ln4555">            lastmon = mon;</a>
<a name="ln4556">            placed++;</a>
<a name="ln4557">        }</a>
<a name="ln4558"> </a>
<a name="ln4559">        if (!_delayed_done_trigger_pos.empty()</a>
<a name="ln4560">            &amp;&amp; _delayed_done_trigger_pos[0] == i)</a>
<a name="ln4561">        {</a>
<a name="ln4562">            cback = _delayed_done_callbacks[0];</a>
<a name="ln4563"> </a>
<a name="ln4564">            string msg;</a>
<a name="ln4565">            if (lastmon)</a>
<a name="ln4566">            {</a>
<a name="ln4567">                ASSERT(placed &gt; 0);</a>
<a name="ln4568">                msg = replace_all(_delayed_success[0], &quot;@servant@&quot;,</a>
<a name="ln4569">                                  placed == 1</a>
<a name="ln4570">                                      ? lastmon-&gt;name(DESC_A)</a>
<a name="ln4571">                                      : pluralise(lastmon-&gt;name(DESC_PLAIN)));</a>
<a name="ln4572">            }</a>
<a name="ln4573">            else</a>
<a name="ln4574">                ASSERT(placed == 0);</a>
<a name="ln4575"> </a>
<a name="ln4576">            prev_god = GOD_NO_GOD;</a>
<a name="ln4577">            _delayed_done_trigger_pos.pop_front();</a>
<a name="ln4578">            _delayed_success.pop_front();</a>
<a name="ln4579">            _delayed_done_callbacks.pop_front();</a>
<a name="ln4580"> </a>
<a name="ln4581">            if (msg.empty())</a>
<a name="ln4582">            {</a>
<a name="ln4583">                if (cback)</a>
<a name="ln4584">                    (*cback)(mg, lastmon, placed);</a>
<a name="ln4585">                continue;</a>
<a name="ln4586">            }</a>
<a name="ln4587"> </a>
<a name="ln4588">            // Fake its coming from simple_god_message().</a>
<a name="ln4589">            if (msg[0] == ' ' || msg[0] == '\'')</a>
<a name="ln4590">                msg = uppercase_first(god_name(mg.god)) + msg;</a>
<a name="ln4591"> </a>
<a name="ln4592">            trim_string(msg);</a>
<a name="ln4593"> </a>
<a name="ln4594">            god_speaks(mg.god, msg.c_str());</a>
<a name="ln4595"> </a>
<a name="ln4596">            if (cback)</a>
<a name="ln4597">                (*cback)(mg, lastmon, placed);</a>
<a name="ln4598">        }</a>
<a name="ln4599">    }</a>
<a name="ln4600"> </a>
<a name="ln4601">    _delayed_data.clear();</a>
<a name="ln4602">    _delayed_callbacks.clear();</a>
<a name="ln4603">    _delayed_done_trigger_pos.clear();</a>
<a name="ln4604">    _delayed_success.clear();</a>
<a name="ln4605">}</a>
<a name="ln4606"> </a>
<a name="ln4607">static bool _is_god(god_type god)</a>
<a name="ln4608">{</a>
<a name="ln4609">    return god &gt; GOD_NO_GOD &amp;&amp; god &lt; NUM_GODS;</a>
<a name="ln4610">}</a>
<a name="ln4611"> </a>
<a name="ln4612">static bool _is_temple_god(god_type god)</a>
<a name="ln4613">{</a>
<a name="ln4614">    if (!_is_god(god) || _is_disabled_god(god))</a>
<a name="ln4615">        return false;</a>
<a name="ln4616"> </a>
<a name="ln4617">    switch (god)</a>
<a name="ln4618">    {</a>
<a name="ln4619">    case GOD_NO_GOD:</a>
<a name="ln4620">    case GOD_LUGONU:</a>
<a name="ln4621">    case GOD_BEOGH:</a>
<a name="ln4622">    case GOD_JIYVA:</a>
<a name="ln4623">        return false;</a>
<a name="ln4624"> </a>
<a name="ln4625">    default:</a>
<a name="ln4626">        return true;</a>
<a name="ln4627">    }</a>
<a name="ln4628">}</a>
<a name="ln4629"> </a>
<a name="ln4630">static bool _is_nontemple_god(god_type god)</a>
<a name="ln4631">{</a>
<a name="ln4632">    return _is_god(god) &amp;&amp; !_is_temple_god(god) &amp;&amp; !_is_disabled_god(god);</a>
<a name="ln4633">}</a>
<a name="ln4634"> </a>
<a name="ln4635">static bool _cmp_god_by_name(god_type god1, god_type god2)</a>
<a name="ln4636">{</a>
<a name="ln4637">    return god_name(god1, false) &lt; god_name(god2, false);</a>
<a name="ln4638">}</a>
<a name="ln4639"> </a>
<a name="ln4640">// Vector of temple gods.</a>
<a name="ln4641">// Sorted by name for the benefit of the overview.</a>
<a name="ln4642">vector&lt;god_type&gt; temple_god_list()</a>
<a name="ln4643">{</a>
<a name="ln4644">    vector&lt;god_type&gt; god_list;</a>
<a name="ln4645">    for (god_iterator it; it; ++it)</a>
<a name="ln4646">        if (_is_temple_god(*it))</a>
<a name="ln4647">            god_list.push_back(*it);</a>
<a name="ln4648">    sort(god_list.begin(), god_list.end(), _cmp_god_by_name);</a>
<a name="ln4649">    return god_list;</a>
<a name="ln4650">}</a>
<a name="ln4651"> </a>
<a name="ln4652">// Vector of non-temple gods.</a>
<a name="ln4653">// Sorted by name for the benefit of the overview.</a>
<a name="ln4654">vector&lt;god_type&gt; nontemple_god_list()</a>
<a name="ln4655">{</a>
<a name="ln4656">    vector&lt;god_type&gt; god_list;</a>
<a name="ln4657">    for (god_iterator it; it; ++it)</a>
<a name="ln4658">        if (_is_nontemple_god(*it))</a>
<a name="ln4659">            god_list.push_back(*it);</a>
<a name="ln4660">    sort(god_list.begin(), god_list.end(), _cmp_god_by_name);</a>
<a name="ln4661">    return god_list;</a>
<a name="ln4662">}</a>
<a name="ln4663"> </a>
<a name="ln4664">bool god_power_usable(const god_power&amp; power, bool ignore_piety, bool ignore_penance)</a>
<a name="ln4665">{</a>
<a name="ln4666">    // not an activated power</a>
<a name="ln4667">    if (power.abil == ABIL_NON_ABILITY)</a>
<a name="ln4668">        return false;</a>
<a name="ln4669">    const ability_type abil = fixup_ability(power.abil);</a>
<a name="ln4670">    ASSERT(abil != ABIL_NON_ABILITY);</a>
<a name="ln4671">    return (power.rank &lt;= 0</a>
<a name="ln4672">            || power.rank == 7 &amp;&amp; can_do_capstone_ability(you.religion)</a>
<a name="ln4673">            || piety_rank() &gt;= power.rank</a>
<a name="ln4674">            || ignore_piety)</a>
<a name="ln4675">           &amp;&amp; (!player_under_penance()</a>
<a name="ln4676">               || power.rank == -1</a>
<a name="ln4677">               || ignore_penance);</a>
<a name="ln4678">}</a>
<a name="ln4679"> </a>
<a name="ln4680">const god_power* god_power_from_ability(ability_type abil)</a>
<a name="ln4681">{</a>
<a name="ln4682">    for (int god = GOD_NO_GOD; god &lt; NUM_GODS; god++)</a>
<a name="ln4683">    {</a>
<a name="ln4684">        for (const auto&amp; power : god_powers[god])</a>
<a name="ln4685">        {</a>
<a name="ln4686">            if (power.abil == abil)</a>
<a name="ln4687">                return &amp;power;</a>
<a name="ln4688">        }</a>
<a name="ln4689">    }</a>
<a name="ln4690">    return nullptr;</a>
<a name="ln4691">}</a>

</code></pre>
<div class="balloon" rel="1000"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v648/" target="_blank">V648</a> Priority of the '&&' operation is higher than that of the '||' operation.</p></div>
<div class="balloon" rel="1163"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v547/" target="_blank">V547</a> Expression 'gifts <= 12' is always true.</p></div>
<div class="balloon" rel="1264"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v648/" target="_blank">V648</a> Priority of the '&&' operation is higher than that of the '||' operation.</p></div>
<div class="balloon" rel="1352"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v648/" target="_blank">V648</a> Priority of the '&&' operation is higher than that of the '||' operation.</p></div>
<div class="balloon" rel="1370"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v648/" target="_blank">V648</a> Priority of the '&&' operation is higher than that of the '||' operation.</p></div>
<div class="balloon" rel="1502"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v648/" target="_blank">V648</a> Priority of the '&&' operation is higher than that of the '||' operation.</p></div>
<div class="balloon" rel="1553"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v648/" target="_blank">V648</a> Priority of the '&&' operation is higher than that of the '||' operation.</p></div>
<div class="balloon" rel="2015"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v648/" target="_blank">V648</a> Priority of the '&&' operation is higher than that of the '||' operation.</p></div>
<div class="balloon" rel="2343"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v648/" target="_blank">V648</a> Priority of the '&&' operation is higher than that of the '||' operation.</p></div>
<div class="balloon" rel="2378"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v648/" target="_blank">V648</a> Priority of the '&&' operation is higher than that of the '||' operation.</p></div>
<div class="balloon" rel="4672"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v648/" target="_blank">V648</a> Priority of the '&&' operation is higher than that of the '||' operation.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
