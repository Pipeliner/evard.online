
<html>
<head>

  <meta http-equiv="Content-Type" content="text/html; charset=US-ASCII" />
  <title>describe-god.cc</title>

  <link rel="stylesheet" href="../style.css"/>
  <script src="../jquery-3.2.1.min.js"></script>
</head>
<body>

<pre><code class = "cpp">
<a name="ln1">/**</a>
<a name="ln2"> * @file</a>
<a name="ln3"> * @brief Functions used to print information about gods.</a>
<a name="ln4"> **/</a>
<a name="ln5"> </a>
<a name="ln6">#include &quot;AppHdr.h&quot;</a>
<a name="ln7"> </a>
<a name="ln8">#include &quot;describe-god.h&quot;</a>
<a name="ln9"> </a>
<a name="ln10">#include &lt;iomanip&gt;</a>
<a name="ln11"> </a>
<a name="ln12">#include &quot;act-iter.h&quot;</a>
<a name="ln13">#include &quot;ability.h&quot;</a>
<a name="ln14">#include &quot;branch.h&quot;</a>
<a name="ln15">#include &quot;cio.h&quot;</a>
<a name="ln16">#include &quot;database.h&quot;</a>
<a name="ln17">#include &quot;decks.h&quot;</a>
<a name="ln18">#include &quot;describe.h&quot;</a>
<a name="ln19">#include &quot;english.h&quot;</a>
<a name="ln20">#include &quot;env.h&quot;</a>
<a name="ln21">#include &quot;eq-type-flags.h&quot;</a>
<a name="ln22">#include &quot;food.h&quot;</a>
<a name="ln23">#include &quot;god-abil.h&quot;</a>
<a name="ln24">#include &quot;god-companions.h&quot;</a>
<a name="ln25">#include &quot;god-conduct.h&quot;</a>
<a name="ln26">#include &quot;god-passive.h&quot;</a>
<a name="ln27">#include &quot;god-type.h&quot;</a>
<a name="ln28">#include &quot;item-name.h&quot;</a>
<a name="ln29">#include &quot;libutil.h&quot;</a>
<a name="ln30">#include &quot;menu.h&quot;</a>
<a name="ln31">#include &quot;message.h&quot;</a>
<a name="ln32">#include &quot;religion.h&quot;</a>
<a name="ln33">#include &quot;skills.h&quot;</a>
<a name="ln34">#include &quot;spl-util.h&quot;</a>
<a name="ln35">#include &quot;stringutil.h&quot;</a>
<a name="ln36">#include &quot;terrain.h&quot;</a>
<a name="ln37">#include &quot;tilepick.h&quot;</a>
<a name="ln38">#include &quot;unicode.h&quot;</a>
<a name="ln39">#include &quot;xom.h&quot;</a>
<a name="ln40"> </a>
<a name="ln41">using namespace ui;</a>
<a name="ln42"> </a>
<a name="ln43">static int _piety_level(int piety)</a>
<a name="ln44">{</a>
<a name="ln45">    return (piety &gt;= piety_breakpoint(5)) ? 7 :</a>
<a name="ln46">           (piety &gt;= piety_breakpoint(4)) ? 6 :</a>
<a name="ln47">           (piety &gt;= piety_breakpoint(3)) ? 5 :</a>
<a name="ln48">           (piety &gt;= piety_breakpoint(2)) ? 4 :</a>
<a name="ln49">           (piety &gt;= piety_breakpoint(1)) ? 3 :</a>
<a name="ln50">           (piety &gt;= piety_breakpoint(0)) ? 2 :</a>
<a name="ln51">           (piety &gt;                    0) ? 1</a>
<a name="ln52">                                          : 0;</a>
<a name="ln53">}</a>
<a name="ln54"> </a>
<a name="ln55">static int _gold_level()</a>
<a name="ln56">{</a>
<a name="ln57">    return (you.gold &gt;= 50000) ? 7 :</a>
<a name="ln58">           (you.gold &gt;= 10000) ? 6 :</a>
<a name="ln59">           (you.gold &gt;=  5000) ? 5 :</a>
<a name="ln60">           (you.gold &gt;=  1000) ? 4 :</a>
<a name="ln61">           (you.gold &gt;=   500) ? 3 :</a>
<a name="ln62">           (you.gold &gt;=   100) ? 2</a>
<a name="ln63">                               : 1;</a>
<a name="ln64">}</a>
<a name="ln65"> </a>
<a name="ln66">static int _invocations_level()</a>
<a name="ln67">{</a>
<a name="ln68">    int invo = you.skills[SK_INVOCATIONS];</a>
<a name="ln69">    return (invo == 27) ? 7 :</a>
<a name="ln70">           (invo &gt;= 24) ? 6 :</a>
<a name="ln71">           (invo &gt;= 20) ? 5 :</a>
<a name="ln72">           (invo &gt;= 16) ? 4 :</a>
<a name="ln73">           (invo &gt;= 12) ? 3 :</a>
<a name="ln74">           (invo &gt;= 8)  ? 2</a>
<a name="ln75">                        : 1;</a>
<a name="ln76">}</a>
<a name="ln77"> </a>
<a name="ln78">int god_favour_rank(god_type which_god)</a>
<a name="ln79">{</a>
<a name="ln80">    if (which_god == GOD_GOZAG)</a>
<a name="ln81">        return _gold_level();</a>
<a name="ln82">    else if (which_god == GOD_USKAYAW)</a>
<a name="ln83">        return _invocations_level();</a>
<a name="ln84">    else</a>
<a name="ln85">        return _piety_level(you.piety);</a>
<a name="ln86">}</a>
<a name="ln87"> </a>
<a name="ln88">static string _describe_favour(god_type which_god)</a>
<a name="ln89">{</a>
<a name="ln90">    if (player_under_penance())</a>
<a name="ln91">    {</a>
<a name="ln92">        const int penance = you.penance[which_god];</a>
<a name="ln93">        return (penance &gt;= 50) ? &quot;Godly wrath is upon you!&quot; :</a>
<a name="ln94">               (penance &gt;= 20) ? &quot;You've transgressed heavily! Be penitent!&quot; :</a>
<a name="ln95">               (penance &gt;=  5) ? &quot;You are under penance.&quot;</a>
<a name="ln96">                               : &quot;You should show more discipline.&quot;;</a>
<a name="ln97">    }</a>
<a name="ln98"> </a>
<a name="ln99">    if (which_god == GOD_XOM)</a>
<a name="ln100">        return uppercase_first(describe_xom_favour());</a>
<a name="ln101"> </a>
<a name="ln102"> </a>
<a name="ln103">    const string godname = god_name(which_god);</a>
<a name="ln104">    switch (god_favour_rank(which_god))</a>
<a name="ln105">    {</a>
<a name="ln106">        case 7:  return &quot;A prized avatar of &quot; + godname;</a>
<a name="ln107">        case 6:  return &quot;A favoured servant of &quot; + godname + &quot;.&quot;;</a>
<a name="ln108">        case 5:</a>
<a name="ln109"> </a>
<a name="ln110">            if (you_worship(GOD_DITHMENOS))</a>
<a name="ln111">                return &quot;A glorious shadow in the eyes of &quot; + godname + &quot;.&quot;;</a>
<a name="ln112">            else</a>
<a name="ln113">                return &quot;A shining star in the eyes of &quot; + godname + &quot;.&quot;;</a>
<a name="ln114"> </a>
<a name="ln115">        case 4:</a>
<a name="ln116"> </a>
<a name="ln117">            if (you_worship(GOD_DITHMENOS))</a>
<a name="ln118">                return &quot;A rising shadow in the eyes of &quot; + godname + &quot;.&quot;;</a>
<a name="ln119">            else</a>
<a name="ln120">                return &quot;A rising star in the eyes of &quot; + godname + &quot;.&quot;;</a>
<a name="ln121"> </a>
<a name="ln122">        case 3:  return uppercase_first(godname) + &quot; is pleased with you.&quot;;</a>
<a name="ln123">        case 2:  return uppercase_first(godname) + &quot; is aware of your devotion.&quot;;</a>
<a name="ln124">        default: return uppercase_first(godname) + &quot; is noncommittal.&quot;;</a>
<a name="ln125">    }</a>
<a name="ln126">}</a>
<a name="ln127"> </a>
<a name="ln128">// The various titles granted by the god of your choice. Note that Xom</a>
<a name="ln129">// doesn't use piety the same way as the other gods, so these are just</a>
<a name="ln130">// placeholders.</a>
<a name="ln131">static const char *divine_title[][8] =</a>
<a name="ln132">{</a>
<a name="ln133">    // No god.</a>
<a name="ln134">    {&quot;Buglet&quot;,             &quot;Firebug&quot;,               &quot;Bogeybug&quot;,                 &quot;Bugger&quot;,</a>
<a name="ln135">        &quot;Bugbear&quot;,            &quot;Bugged One&quot;,            &quot;Giant Bug&quot;,                &quot;Lord of the Bugs&quot;},</a>
<a name="ln136"> </a>
<a name="ln137">    // Zin.</a>
<a name="ln138">    {&quot;Blasphemer&quot;,         &quot;Anchorite&quot;,             &quot;Apologist&quot;,                &quot;Pious&quot;,</a>
<a name="ln139">        &quot;Devout&quot;,             &quot;Orthodox&quot;,              &quot;Immaculate&quot;,               &quot;Bringer of Law&quot;},</a>
<a name="ln140"> </a>
<a name="ln141">    // The Shining One.</a>
<a name="ln142">    {&quot;Honourless&quot;,         &quot;Acolyte&quot;,               &quot;Righteous&quot;,                &quot;Unflinching&quot;,</a>
<a name="ln143">        &quot;Holy Warrior&quot;,       &quot;Exorcist&quot;,              &quot;Demon Slayer&quot;,             &quot;Bringer of Light&quot;},</a>
<a name="ln144"> </a>
<a name="ln145">    // Kikubaaqudgha -- scholarly death.</a>
<a name="ln146">    {&quot;Tormented&quot;,          &quot;Purveyor of Pain&quot;,      &quot;Scholar of Death&quot;,         &quot;Merchant of Misery&quot;,</a>
<a name="ln147">        &quot;Artisan of Death&quot;,   &quot;Dealer of Despair&quot;,     &quot;Black Sun&quot;,                &quot;Lord of Darkness&quot;},</a>
<a name="ln148"> </a>
<a name="ln149">    // Yredelemnul -- zombie death.</a>
<a name="ln150">    {&quot;Traitor&quot;,            &quot;Tainted&quot;,                &quot;Torchbearer&quot;,             &quot;Fey @Genus@&quot;,</a>
<a name="ln151">        &quot;Black Crusader&quot;,     &quot;Sculptor of Flesh&quot;,     &quot;Harbinger of Death&quot;,       &quot;Grim Reaper&quot;},</a>
<a name="ln152"> </a>
<a name="ln153">    // Xom.</a>
<a name="ln154">    {&quot;Toy&quot;,                &quot;Toy&quot;,                   &quot;Toy&quot;,                      &quot;Toy&quot;,</a>
<a name="ln155">        &quot;Toy&quot;,                &quot;Toy&quot;,                   &quot;Toy&quot;,                      &quot;Toy&quot;},</a>
<a name="ln156"> </a>
<a name="ln157">    // Vehumet -- battle mage theme.</a>
<a name="ln158">    {&quot;Meek&quot;,               &quot;Sorcerer's Apprentice&quot;, &quot;Scholar of Destruction&quot;,   &quot;Caster of Ruination&quot;,</a>
<a name="ln159">        &quot;Traumaturge&quot;,        &quot;Battlemage&quot;,            &quot;Warlock&quot;,                  &quot;Luminary of Lethal Lore&quot;},</a>
<a name="ln160"> </a>
<a name="ln161">    // Okawaru -- battle theme.</a>
<a name="ln162">    {&quot;Coward&quot;,             &quot;Struggler&quot;,             &quot;Combatant&quot;,                &quot;Warrior&quot;,</a>
<a name="ln163">        &quot;Knight&quot;,             &quot;Warmonger&quot;,             &quot;Commander&quot;,                &quot;Victor of a Thousand Battles&quot;},</a>
<a name="ln164"> </a>
<a name="ln165">    // Makhleb -- chaos theme.</a>
<a name="ln166">    {&quot;Orderly&quot;,            &quot;Spawn of Chaos&quot;,        &quot;Disciple of Destruction&quot;,  &quot;Fanfare of Bloodshed&quot;,</a>
<a name="ln167">        &quot;Fiendish&quot;,           &quot;Demolition @Genus@&quot;,    &quot;Pandemonic&quot;,               &quot;Champion of Chaos&quot;},</a>
<a name="ln168"> </a>
<a name="ln169">    // Sif Muna -- scholarly theme.</a>
<a name="ln170">    {&quot;Ignorant&quot;,           &quot;Disciple&quot;,              &quot;Student&quot;,                  &quot;Adept&quot;,</a>
<a name="ln171">        &quot;Scribe&quot;,             &quot;Scholar&quot;,               &quot;Sage&quot;,                     &quot;Genius of the Arcane&quot;},</a>
<a name="ln172"> </a>
<a name="ln173">    // Trog -- anger theme.</a>
<a name="ln174">    {&quot;Puny&quot;,               &quot;Troglodyte&quot;,            &quot;Angry Troglodyte&quot;,         &quot;Frenzied&quot;,</a>
<a name="ln175">        &quot;@Genus@ of Prey&quot;,    &quot;Rampant&quot;,               &quot;Wild @Genus@&quot;,             &quot;Bane of Scribes&quot;},</a>
<a name="ln176"> </a>
<a name="ln177">    // Nemelex Xobeh -- alluding to Tarot and cards.</a>
<a name="ln178">    {&quot;Unlucky @Genus@&quot;,    &quot;Pannier&quot;,               &quot;Jester&quot;,                   &quot;Fortune-Teller&quot;,</a>
<a name="ln179">        &quot;Soothsayer&quot;,         &quot;Magus&quot;,                 &quot;Cardsharp&quot;,                &quot;Hand of Fortune&quot;},</a>
<a name="ln180"> </a>
<a name="ln181">    // Elyvilon.</a>
<a name="ln182">    {&quot;Sinner&quot;,                &quot;Practitioner&quot;,       &quot;Comforter&quot;,             &quot;Caregiver&quot;,</a>
<a name="ln183">        &quot;Mender&quot;,           &quot;Pacifist&quot;,                &quot;Purifying @Genus@&quot;,        &quot;Bringer of Life&quot;},</a>
<a name="ln184"> </a>
<a name="ln185">    // Lugonu -- distortion theme.</a>
<a name="ln186">    {&quot;Pure&quot;,               &quot;Abyss-Baptised&quot;,        &quot;Unweaver&quot;,                 &quot;Distorting @Genus@&quot;,</a>
<a name="ln187">        &quot;Agent of Entropy&quot;,   &quot;Schismatic&quot;,            &quot;Envoy of Void&quot;,            &quot;Corrupter of Planes&quot;},</a>
<a name="ln188"> </a>
<a name="ln189">    // Beogh -- messiah theme.</a>
<a name="ln190">    {&quot;Apostate&quot;,           &quot;Messenger&quot;,             &quot;Proselytiser&quot;,             &quot;Priest&quot;,</a>
<a name="ln191">        &quot;Missionary&quot;,         &quot;Evangelist&quot;,            &quot;Apostle&quot;,                  &quot;Messiah&quot;},</a>
<a name="ln192"> </a>
<a name="ln193">    // Jiyva -- slime and jelly theme.</a>
<a name="ln194">    {&quot;Scum&quot;,               &quot;Squelcher&quot;,             &quot;Ooze&quot;,                     &quot;Jelly&quot;,</a>
<a name="ln195">        &quot;Slime Creature&quot;,     &quot;Dissolving @Genus@&quot;,    &quot;Blob&quot;,                     &quot;Royal Jelly&quot;},</a>
<a name="ln196"> </a>
<a name="ln197">    // Fedhas Madash -- nature theme.</a>
<a name="ln198">    {&quot;@Walking@ Fertiliser&quot;, &quot;Fungal&quot;,              &quot;Green @Genus@&quot;,            &quot;Cultivator&quot;,</a>
<a name="ln199">        &quot;Fruitful&quot;,           &quot;Photosynthesist&quot;,       &quot;Green Death&quot;,              &quot;Force of Nature&quot;},</a>
<a name="ln200"> </a>
<a name="ln201">    // Cheibriados -- slow theme</a>
<a name="ln202">    {&quot;Hasty&quot;,              &quot;Sluggish @Genus@&quot;,      &quot;Deliberate&quot;,               &quot;Unhurried&quot;,</a>
<a name="ln203">     &quot;Contemplative&quot;,         &quot;Epochal&quot;,               &quot;Timeless&quot;,                 &quot;@Adj@ Aeon&quot;},</a>
<a name="ln204"> </a>
<a name="ln205">    // Ashenzari -- divination theme</a>
<a name="ln206">    {&quot;Star-crossed&quot;,       &quot;Cursed&quot;,                &quot;Initiated&quot;,                &quot;Soothsayer&quot;,</a>
<a name="ln207">        &quot;Seer&quot;,               &quot;Oracle&quot;,                &quot;Illuminatus&quot;,              &quot;Omniscient&quot;},</a>
<a name="ln208"> </a>
<a name="ln209">    // Dithmenos -- darkness theme</a>
<a name="ln210">    {&quot;Ember&quot;,              &quot;Gloomy&quot;,                &quot;Darkened&quot;,                 &quot;Extinguished&quot;,</a>
<a name="ln211">        &quot;Caliginous&quot;,         &quot;Umbral&quot;,                &quot;Hand of Shadow&quot;,           &quot;Eternal Night&quot;},</a>
<a name="ln212"> </a>
<a name="ln213">    // Gozag -- entrepreneur theme</a>
<a name="ln214">    {&quot;Profligate&quot;,         &quot;Pauper&quot;,                &quot;Entrepreneur&quot;,             &quot;Capitalist&quot;,</a>
<a name="ln215">        &quot;Rich&quot;,               &quot;Opulent&quot;,               &quot;Tycoon&quot;,                   &quot;Plutocrat&quot;},</a>
<a name="ln216"> </a>
<a name="ln217">    // Qazlal -- natural disaster theme</a>
<a name="ln218">    {&quot;Unspoiled&quot;,          &quot;@Adj@ Mishap&quot;,          &quot;Lightning Rod&quot;,            &quot;@Adj@ Disaster&quot;,</a>
<a name="ln219">        &quot;Eye of the Storm&quot;,   &quot;@Adj@ Catastrophe&quot;,     &quot;@Adj@ Cataclysm&quot;,          &quot;End of an Era&quot;},</a>
<a name="ln220"> </a>
<a name="ln221">    // Ru -- enlightenment theme</a>
<a name="ln222">    {&quot;Sleeper&quot;,           &quot;Questioner&quot;,             &quot;Initiate&quot;,                 &quot;Seeker of Truth&quot;,</a>
<a name="ln223">        &quot;@Walker@ of the Path&quot;,&quot;Lifter of the Veil&quot;,     &quot;Transcendent&quot;,     &quot;Drop of Water&quot;},</a>
<a name="ln224"> </a>
<a name="ln225">#if TAG_MAJOR_VERSION == 34</a>
<a name="ln226">    // Pakellas -- inventor theme</a>
<a name="ln227">    {&quot;Reactionary&quot;,       &quot;Apprentice&quot;,             &quot;Inquisitive&quot;,              &quot;Experimenter&quot;,</a>
<a name="ln228">        &quot;Inventor&quot;,           &quot;Pioneer&quot;,               &quot;Brilliant&quot;,                &quot;Grand Gadgeteer&quot;},</a>
<a name="ln229">#endif</a>
<a name="ln230"> </a>
<a name="ln231">    // Uskayaw -- reveler theme</a>
<a name="ln232">    {&quot;Prude&quot;,             &quot;Wallflower&quot;,             &quot;Party-goer&quot;,              &quot;Dancer&quot;,</a>
<a name="ln233">        &quot;Impassioned&quot;,        &quot;Rapturous&quot;,             &quot;Ecstatic&quot;,                &quot;Rhythm of Life and Death&quot;},</a>
<a name="ln234"> </a>
<a name="ln235">    // Hepliaklqana -- memory/ancestry theme</a>
<a name="ln236">    {&quot;Damnatio Memoriae&quot;,       &quot;Hazy&quot;,             &quot;@Adj@ Child&quot;,              &quot;Storyteller&quot;,</a>
<a name="ln237">        &quot;Brooding&quot;,           &quot;Anamnesiscian&quot;,               &quot;Grand Scion&quot;,                &quot;Unforgettable&quot;},</a>
<a name="ln238"> </a>
<a name="ln239">    // Wu Jian -- animal/chinese martial arts monk theme</a>
<a name="ln240">    {&quot;Wooden Rat&quot;,          &quot;Young Dog&quot;,             &quot;Young Crane&quot;,              &quot;Young Tiger&quot;,</a>
<a name="ln241">        &quot;Young Dragon&quot;,     &quot;Red Sash&quot;,               &quot;Golden Sash&quot;,              &quot;Sifu&quot;},</a>
<a name="ln242">};</a>
<a name="ln243">COMPILE_CHECK(ARRAYSZ(divine_title) == NUM_GODS);</a>
<a name="ln244"> </a>
<a name="ln245">string god_title(god_type which_god, species_type which_species, int piety)</a>
<a name="ln246">{</a>
<a name="ln247">    string title;</a>
<a name="ln248">    if (player_under_penance(which_god))</a>
<a name="ln249">        title = divine_title[which_god][0];</a>
<a name="ln250">    else if (which_god == GOD_USKAYAW)</a>
<a name="ln251">        title = divine_title[which_god][_invocations_level()];</a>
<a name="ln252">    else if (which_god == GOD_GOZAG)</a>
<a name="ln253">        title = divine_title[which_god][_gold_level()];</a>
<a name="ln254">    else</a>
<a name="ln255">        title = divine_title[which_god][_piety_level(piety)];</a>
<a name="ln256"> </a>
<a name="ln257">    const map&lt;string, string&gt; replacements =</a>
<a name="ln258">    {</a>
<a name="ln259">        { &quot;Adj&quot;, species_name(which_species, SPNAME_ADJ) },</a>
<a name="ln260">        { &quot;Genus&quot;, species_name(which_species, SPNAME_GENUS) },</a>
<a name="ln261">        { &quot;Walking&quot;, species_walking_verb(which_species) + &quot;ing&quot; },</a>
<a name="ln262">        { &quot;Walker&quot;, species_walking_verb(which_species) + &quot;er&quot; },</a>
<a name="ln263">    };</a>
<a name="ln264"> </a>
<a name="ln265">    return replace_keys(title, replacements);</a>
<a name="ln266">}</a>
<a name="ln267"> </a>
<a name="ln268">static string _describe_ash_skill_boost()</a>
<a name="ln269">{</a>
<a name="ln270">    if (!you.bondage_level)</a>
<a name="ln271">    {</a>
<a name="ln272">        return &quot;Ashenzari won't support your skills until you bind yourself &quot;</a>
<a name="ln273">               &quot;with cursed items.&quot;;</a>
<a name="ln274">    }</a>
<a name="ln275"> </a>
<a name="ln276">    static const char* bondage_parts[NUM_ET] = { &quot;Weapon hand&quot;, &quot;Shield hand&quot;,</a>
<a name="ln277">                                                 &quot;Armour&quot;, &quot;Jewellery&quot; };</a>
<a name="ln278">    static const char* bonus_level[3] = { &quot;Low&quot;, &quot;Medium&quot;, &quot;High&quot; };</a>
<a name="ln279">    ostringstream desc;</a>
<a name="ln280">    desc.setf(ios::left);</a>
<a name="ln281">    desc &lt;&lt; &quot;&lt;white&gt;&quot;;</a>
<a name="ln282">    desc &lt;&lt; setw(18) &lt;&lt; &quot;Bound part&quot;;</a>
<a name="ln283">    desc &lt;&lt; setw(30) &lt;&lt; &quot;Boosted skills&quot;;</a>
<a name="ln284">    desc &lt;&lt; &quot;Bonus\n&quot;;</a>
<a name="ln285">    desc &lt;&lt; &quot;&lt;/white&gt;&quot;;</a>
<a name="ln286"> </a>
<a name="ln287">    for (int i = ET_WEAPON; i &lt; NUM_ET; i++)</a>
<a name="ln288">    {</a>
<a name="ln289">        if (you.bondage[i] &lt;= 0 || i == ET_SHIELD &amp;&amp; you.bondage[i] == 3)</a>
<a name="ln290">            continue;</a>
<a name="ln291"> </a>
<a name="ln292">        desc &lt;&lt; setw(18);</a>
<a name="ln293">        if (i == ET_WEAPON &amp;&amp; you.bondage[i] == 3)</a>
<a name="ln294">            desc &lt;&lt; &quot;Hands&quot;;</a>
<a name="ln295">        else</a>
<a name="ln296">            desc &lt;&lt; bondage_parts[i];</a>
<a name="ln297"> </a>
<a name="ln298">        string skills;</a>
<a name="ln299">        map&lt;skill_type, int8_t&gt; boosted_skills = ash_get_boosted_skills(eq_type(i));</a>
<a name="ln300">        const int8_t bonus = boosted_skills.begin()-&gt;second;</a>
<a name="ln301">        auto it = boosted_skills.begin();</a>
<a name="ln302"> </a>
<a name="ln303">        // First, we keep only one magic school skill (conjuration).</a>
<a name="ln304">        // No need to list all of them since we boost all or none.</a>
<a name="ln305">        while (it != boosted_skills.end())</a>
<a name="ln306">        {</a>
<a name="ln307">            if (it-&gt;first &gt; SK_CONJURATIONS &amp;&amp; it-&gt;first &lt;= SK_LAST_MAGIC)</a>
<a name="ln308">            {</a>
<a name="ln309">                boosted_skills.erase(it);</a>
<a name="ln310">                it = boosted_skills.begin();</a>
<a name="ln311">            }</a>
<a name="ln312">            else</a>
<a name="ln313">                ++it;</a>
<a name="ln314">        }</a>
<a name="ln315"> </a>
<a name="ln316">        it = boosted_skills.begin();</a>
<a name="ln317">        while (!boosted_skills.empty())</a>
<a name="ln318">        {</a>
<a name="ln319">            // For now, all the bonuses from the same bounded part have</a>
<a name="ln320">            // the same level.</a>
<a name="ln321">            ASSERT(bonus == it-&gt;second);</a>
<a name="ln322">            if (it-&gt;first == SK_CONJURATIONS)</a>
<a name="ln323">                skills += &quot;Magic schools&quot;;</a>
<a name="ln324">            else</a>
<a name="ln325">                skills += skill_name(it-&gt;first);</a>
<a name="ln326"> </a>
<a name="ln327">            if (boosted_skills.size() &gt; 2)</a>
<a name="ln328">                skills += &quot;, &quot;;</a>
<a name="ln329">            else if (boosted_skills.size() == 2)</a>
<a name="ln330">                skills += &quot; and &quot;;</a>
<a name="ln331"> </a>
<a name="ln332">            boosted_skills.erase(it++);</a>
<a name="ln333">        }</a>
<a name="ln334"> </a>
<a name="ln335">        desc &lt;&lt; setw(30) &lt;&lt; skills;</a>
<a name="ln336">        desc &lt;&lt; bonus_level[bonus -1] &lt;&lt; &quot;\n&quot;;</a>
<a name="ln337">    }</a>
<a name="ln338"> </a>
<a name="ln339">    return desc.str();</a>
<a name="ln340">}</a>
<a name="ln341"> </a>
<a name="ln342">typedef pair&lt;int, string&gt; ancestor_upgrade;</a>
<a name="ln343"> </a>
<a name="ln344">static const map&lt;monster_type, vector&lt;ancestor_upgrade&gt; &gt; ancestor_data =</a>
<a name="ln345">{</a>
<a name="ln346">    { MONS_ANCESTOR_KNIGHT,</a>
<a name="ln347">      { { 1,  &quot;Flail&quot; },</a>
<a name="ln348">        { 1,  &quot;Shield&quot; },</a>
<a name="ln349">        { 1,  &quot;Chain mail (+AC)&quot; },</a>
<a name="ln350">        { 15, &quot;Broad axe (flame)&quot; },</a>
<a name="ln351">        { 19, &quot;Tower shield (reflect)&quot; },</a>
<a name="ln352">        { 19, &quot;Haste&quot; },</a>
<a name="ln353">        { 24, &quot;Broad axe (speed)&quot; },</a>
<a name="ln354">      }</a>
<a name="ln355">    },</a>
<a name="ln356">    { MONS_ANCESTOR_BATTLEMAGE,</a>
<a name="ln357">      { { 1,  &quot;Quarterstaff&quot; },</a>
<a name="ln358">        { 1,  &quot;Throw Frost&quot; },</a>
<a name="ln359">        { 1,  &quot;Stone Arrow&quot; },</a>
<a name="ln360">        { 1,  &quot;Increased melee damage&quot; },</a>
<a name="ln361">        { 15, &quot;Bolt of Magma&quot; },</a>
<a name="ln362">        { 19, &quot;Lajatang (freeze)&quot; },</a>
<a name="ln363">        { 19, &quot;Haste&quot; },</a>
<a name="ln364">        { 24, &quot;Lehudib's Crystal Spear&quot; },</a>
<a name="ln365">      }</a>
<a name="ln366">    },</a>
<a name="ln367">    { MONS_ANCESTOR_HEXER,</a>
<a name="ln368">      { { 1,  &quot;Dagger (drain)&quot; },</a>
<a name="ln369">        { 1,  &quot;Slow&quot; },</a>
<a name="ln370">        { 1,  &quot;Confuse&quot; },</a>
<a name="ln371">        { 15, &quot;Paralyse&quot; },</a>
<a name="ln372">        { 19, &quot;Mass Confusion&quot; },</a>
<a name="ln373">        { 19, &quot;Haste&quot; },</a>
<a name="ln374">        { 24, &quot;Quick blade (antimagic)&quot; },</a>
<a name="ln375">      }</a>
<a name="ln376">    },</a>
<a name="ln377">};</a>
<a name="ln378"> </a>
<a name="ln379">/// Build &amp; return a table of Hep's upgrades for your chosen ancestor type.</a>
<a name="ln380">static string _describe_ancestor_upgrades()</a>
<a name="ln381">{</a>
<a name="ln382">    if (!you.props.exists(HEPLIAKLQANA_ALLY_TYPE_KEY))</a>
<a name="ln383">        return &quot;&quot;;</a>
<a name="ln384"> </a>
<a name="ln385">    string desc;</a>
<a name="ln386">    const monster_type ancestor =</a>
<a name="ln387">        static_cast&lt;monster_type&gt;(you.props[HEPLIAKLQANA_ALLY_TYPE_KEY].get_int());</a>
<a name="ln388">    const vector&lt;ancestor_upgrade&gt; *upgrades = map_find(ancestor_data,</a>
<a name="ln389">                                                        ancestor);</a>
<a name="ln390"> </a>
<a name="ln391">    if (upgrades)</a>
<a name="ln392">    {</a>
<a name="ln393">        desc = &quot;Ancestor Upgrades:\n\n&lt;white&gt;XL              Upgrade\n&lt;/white&gt;&quot;;</a>
<a name="ln394">        for (auto &amp;entry : *upgrades)</a>
<a name="ln395">        {</a>
<a name="ln396">            desc += make_stringf(&quot;%s%2d              %s%s\n&quot;,</a>
<a name="ln397">                                 you.experience_level &lt; entry.first</a>
<a name="ln398">                                     ? &quot;&lt;darkgrey&gt;&quot; : &quot;&quot;,</a>
<a name="ln399">                                 entry.first,</a>
<a name="ln400">                                 entry.second.c_str(),</a>
<a name="ln401">                                 you.experience_level &lt; entry.first</a>
<a name="ln402">                                     ? &quot;&lt;/darkgrey&gt;&quot; : &quot;&quot;);</a>
<a name="ln403">        }</a>
<a name="ln404">    }</a>
<a name="ln405"> </a>
<a name="ln406">    // XXX: maybe it'd be nice to let you see other ancestor types'...?</a>
<a name="ln407">    return desc;</a>
<a name="ln408">}</a>
<a name="ln409"> </a>
<a name="ln410">// from dgn-overview.cc</a>
<a name="ln411">extern map&lt;branch_type, set&lt;level_id&gt; &gt; stair_level;</a>
<a name="ln412"> </a>
<a name="ln413">/**</a>
<a name="ln414"> * Populate a provided vector with a list of bribable branches which are known</a>
<a name="ln415"> * to the player.</a>
<a name="ln416"> *</a>
<a name="ln417"> * @param[out] targets      A list of bribable branches.</a>
<a name="ln418"> */</a>
<a name="ln419">static void _list_bribable_branches(vector&lt;branch_type&gt; &amp;targets)</a>
<a name="ln420">{</a>
<a name="ln421">    for (branch_iterator it; it; ++it)</a>
<a name="ln422">    {</a>
<a name="ln423">        const branch_type br = it-&gt;id;</a>
<a name="ln424">        if (!gozag_branch_bribable(br))</a>
<a name="ln425">            continue;</a>
<a name="ln426"> </a>
<a name="ln427">        // Only list the Hells once.</a>
<a name="ln428">        if (is_hell_subbranch(br))</a>
<a name="ln429">            continue;</a>
<a name="ln430"> </a>
<a name="ln431">        // If you don't know the branch exists, don't list it;</a>
<a name="ln432">        // this mainly plugs info leaks about Lair branch structure.</a>
<a name="ln433">        if (!stair_level.count(br))</a>
<a name="ln434">            continue;</a>
<a name="ln435"> </a>
<a name="ln436">        targets.push_back(br);</a>
<a name="ln437">    }</a>
<a name="ln438">}</a>
<a name="ln439"> </a>
<a name="ln440">/**</a>
<a name="ln441"> * Describe the current options for Gozag's bribe branch ability.</a>
<a name="ln442"> *</a>
<a name="ln443"> * @return      A description of branches' bribe status.</a>
<a name="ln444"> */</a>
<a name="ln445">static string _describe_branch_bribability()</a>
<a name="ln446">{</a>
<a name="ln447">    string ret = &quot;You can bribe the following branches of the dungeon:\n&quot;;</a>
<a name="ln448">    vector&lt;branch_type&gt; targets;</a>
<a name="ln449">    _list_bribable_branches(targets);</a>
<a name="ln450"> </a>
<a name="ln451">    size_t width = 0;</a>
<a name="ln452">    for (branch_type br : targets)</a>
<a name="ln453">        width = max(width, strlen(branches[br].shortname));</a>
<a name="ln454"> </a>
<a name="ln455">    for (branch_type br : targets)</a>
<a name="ln456">    {</a>
<a name="ln457">        string line = &quot; &quot;;</a>
<a name="ln458">        line += branches[br].shortname;</a>
<a name="ln459">        line += string(width + 3 - strwidth(line), ' ');</a>
<a name="ln460"> </a>
<a name="ln461">        if (!branch_bribe[br])</a>
<a name="ln462">            line += &quot;not bribed&quot;;</a>
<a name="ln463">        else</a>
<a name="ln464">            line += make_stringf(&quot;$%d&quot;, branch_bribe[br]);</a>
<a name="ln465"> </a>
<a name="ln466">        ret += line + &quot;\n&quot;;</a>
<a name="ln467">    }</a>
<a name="ln468"> </a>
<a name="ln469">    return ret;</a>
<a name="ln470">}</a>
<a name="ln471"> </a>
<a name="ln472">static inline void _add_par(formatted_string &amp;desc, const string &amp;str)</a>
<a name="ln473">{</a>
<a name="ln474">    if (!str.empty())</a>
<a name="ln475">        desc += formatted_string::parse_string(trimmed_string(str) + &quot;\n\n&quot;);</a>
<a name="ln476">}</a>
<a name="ln477"> </a>
<a name="ln478">/**</a>
<a name="ln479"> * Describe the causes of the given god's wrath.</a>
<a name="ln480"> *</a>
<a name="ln481"> * @param which_god     The god in question.</a>
<a name="ln482"> * @return              A description of the actions that cause this god's</a>
<a name="ln483"> *                      wrath.</a>
<a name="ln484"> */</a>
<a name="ln485">static string _describe_god_wrath_causes(god_type which_god)</a>
<a name="ln486">{</a>
<a name="ln487">    if (which_god == GOD_RU)</a>
<a name="ln488">        return &quot;&quot;; // no wrath</a>
<a name="ln489">    vector&lt;god_type&gt; evil_gods;</a>
<a name="ln490">    vector&lt;god_type&gt; chaotic_gods;</a>
<a name="ln491">    for (god_iterator it; it; ++it)</a>
<a name="ln492">    {</a>
<a name="ln493">        const god_type god = *it;</a>
<a name="ln494">        if (is_evil_god(god))</a>
<a name="ln495">            evil_gods.push_back(god);</a>
<a name="ln496">        else if (is_chaotic_god(god)) // intentionally not including evil!</a>
<a name="ln497">            chaotic_gods.push_back(god);</a>
<a name="ln498">        // XXX: refactor this if any god hates chaotic but not evil gods</a>
<a name="ln499">    }</a>
<a name="ln500"> </a>
<a name="ln501">    switch (which_god)</a>
<a name="ln502">    {</a>
<a name="ln503">        case GOD_SHINING_ONE:</a>
<a name="ln504">        case GOD_ELYVILON:</a>
<a name="ln505">            return uppercase_first(god_name(which_god)) +</a>
<a name="ln506">                   &quot; forgives followers for abandonment; however, those who&quot;</a>
<a name="ln507">                   &quot; later take up the worship of an evil god will be&quot;</a>
<a name="ln508">                   &quot; punished. (&quot; +</a>
<a name="ln509">                   comma_separated_fn(begin(evil_gods), end(evil_gods),</a>
<a name="ln510">                                      bind(god_name, placeholders::_1, false)) +</a>
<a name="ln511">                   &quot; are evil gods.)&quot;;</a>
<a name="ln512"> </a>
<a name="ln513">        case GOD_ZIN:</a>
<a name="ln514">            return uppercase_first(god_name(which_god)) +</a>
<a name="ln515">                   &quot; forgives followers for abandonment; however, those who&quot;</a>
<a name="ln516">                   &quot; later take up the worship of an evil or chaotic god will&quot;</a>
<a name="ln517">                   &quot; be scourged. (&quot; +</a>
<a name="ln518">                   comma_separated_fn(begin(evil_gods), end(evil_gods),</a>
<a name="ln519">                                      bind(god_name, placeholders::_1, false)) +</a>
<a name="ln520">                   &quot; are evil, and &quot; +</a>
<a name="ln521">                   comma_separated_fn(begin(chaotic_gods), end(chaotic_gods),</a>
<a name="ln522">                                      bind(god_name, placeholders::_1, false)) +</a>
<a name="ln523">                   &quot; are chaotic.)&quot;;</a>
<a name="ln524">        default:</a>
<a name="ln525">            return uppercase_first(god_name(which_god)) +</a>
<a name="ln526">                   &quot; does not appreciate abandonment, and will call down&quot;</a>
<a name="ln527">                   &quot; fearful punishments on disloyal followers!&quot;;</a>
<a name="ln528">    }</a>
<a name="ln529">}</a>
<a name="ln530"> </a>
<a name="ln531">/**</a>
<a name="ln532"> * Print a description of the given god's dislikes &amp; wrath effects.</a>
<a name="ln533"> *</a>
<a name="ln534"> * @param which_god     The god in question.</a>
<a name="ln535"> */</a>
<a name="ln536">static formatted_string _god_wrath_description(god_type which_god)</a>
<a name="ln537">{</a>
<a name="ln538">    formatted_string desc;</a>
<a name="ln539"> </a>
<a name="ln540">    _add_par(desc, get_god_dislikes(which_god));</a>
<a name="ln541">    _add_par(desc, _describe_god_wrath_causes(which_god));</a>
<a name="ln542">    _add_par(desc, getLongDescription(god_name(which_god) + &quot; wrath&quot;));</a>
<a name="ln543"> </a>
<a name="ln544">    if (which_god != GOD_RU) // Permanent wrath.</a>
<a name="ln545">    {</a>
<a name="ln546">        const bool long_wrath = initial_wrath_penance_for(which_god) &gt; 30;</a>
<a name="ln547">        _add_par(desc, apostrophise(uppercase_first(god_name(which_god)))</a>
<a name="ln548">                              + &quot; wrath lasts for a relatively &quot; +</a>
<a name="ln549">                              (long_wrath ? &quot;long&quot; : &quot;short&quot;) + &quot; duration.&quot;);</a>
<a name="ln550">    }</a>
<a name="ln551"> </a>
<a name="ln552">    return desc;</a>
<a name="ln553">}</a>
<a name="ln554"> </a>
<a name="ln555">static formatted_string _beogh_extra_description()</a>
<a name="ln556">{</a>
<a name="ln557">    formatted_string desc;</a>
<a name="ln558"> </a>
<a name="ln559">    _add_par(desc, &quot;Named Followers:&quot;);</a>
<a name="ln560"> </a>
<a name="ln561">    vector&lt;monster*&gt; followers;</a>
<a name="ln562"> </a>
<a name="ln563">    for (monster_iterator mi; mi; ++mi)</a>
<a name="ln564">        if (is_orcish_follower(**mi))</a>
<a name="ln565">            followers.push_back(*mi);</a>
<a name="ln566">    for (auto &amp;entry : companion_list)</a>
<a name="ln567">        // if not elsewhere, follower already seen by monster_iterator</a>
<a name="ln568">        if (companion_is_elsewhere(entry.second.mons.mons.mid, true))</a>
<a name="ln569">            followers.push_back(&amp;entry.second.mons.mons);</a>
<a name="ln570"> </a>
<a name="ln571">    sort(followers.begin(), followers.end(),</a>
<a name="ln572">        [] (monster* a, monster* b) { return a-&gt;experience &gt; b-&gt;experience;});</a>
<a name="ln573"> </a>
<a name="ln574">    bool has_named_followers = false;</a>
<a name="ln575">    for (auto mons : followers)</a>
<a name="ln576">    {</a>
<a name="ln577">        if (!mons-&gt;is_named()) continue;</a>
<a name="ln578">        has_named_followers = true;</a>
<a name="ln579"> </a>
<a name="ln580">        desc += mons-&gt;full_name(DESC_PLAIN);</a>
<a name="ln581">        if (companion_is_elsewhere(mons-&gt;mid))</a>
<a name="ln582">        {</a>
<a name="ln583">            desc += formatted_string::parse_string(</a>
<a name="ln584">                            &quot; (&lt;blue&gt;on another level&lt;/blue&gt;)&quot;);</a>
<a name="ln585">        }</a>
<a name="ln586">        else if (given_gift(mons))</a>
<a name="ln587">        {</a>
<a name="ln588">            mon_inv_type slot =</a>
<a name="ln589">                mons-&gt;props.exists(BEOGH_SH_GIFT_KEY) ? MSLOT_SHIELD :</a>
<a name="ln590">                mons-&gt;props.exists(BEOGH_ARM_GIFT_KEY) ? MSLOT_ARMOUR :</a>
<a name="ln591">                mons-&gt;props.exists(BEOGH_RANGE_WPN_GIFT_KEY) ? MSLOT_ALT_WEAPON :</a>
<a name="ln592">                MSLOT_WEAPON;</a>
<a name="ln593"> </a>
<a name="ln594">            // An orc can still lose its gift, e.g. by being turned into a</a>
<a name="ln595">            // shapeshifter via a chaos cloud. TODO: should the gift prop be</a>
<a name="ln596">            // deleted at that point?</a>
<a name="ln597">            if (mons-&gt;inv[slot] != NON_ITEM)</a>
<a name="ln598">            {</a>
<a name="ln599">                desc.cprintf(&quot; (&quot;);</a>
<a name="ln600"> </a>
<a name="ln601">                item_def &amp;gift = mitm[mons-&gt;inv[slot]];</a>
<a name="ln602">                desc += formatted_string::parse_string(</a>
<a name="ln603">                                    menu_colour_item_name(gift,DESC_PLAIN));</a>
<a name="ln604">                desc.cprintf(&quot;)&quot;);</a>
<a name="ln605">            }</a>
<a name="ln606">        }</a>
<a name="ln607">        desc.cprintf(&quot;\n&quot;);</a>
<a name="ln608">    }</a>
<a name="ln609"> </a>
<a name="ln610">    if (!has_named_followers)</a>
<a name="ln611">        _add_par(desc, &quot;None&quot;);</a>
<a name="ln612"> </a>
<a name="ln613">    return desc;</a>
<a name="ln614">}</a>
<a name="ln615"> </a>
<a name="ln616">static string _describe_deck_summary()</a>
<a name="ln617">{</a>
<a name="ln618">    ostringstream desc;</a>
<a name="ln619">    desc &lt;&lt; &quot;Decks of power:\n&quot;;</a>
<a name="ln620">    for (int i = FIRST_PLAYER_DECK; i &lt;= LAST_PLAYER_DECK; i++)</a>
<a name="ln621">        desc &lt;&lt; &quot; &quot; &lt;&lt; deck_status((deck_type) i) &lt;&lt; &quot;\n&quot;;</a>
<a name="ln622"> </a>
<a name="ln623">    string stack = stack_contents();</a>
<a name="ln624">    if (!stack.empty())</a>
<a name="ln625">        desc &lt;&lt; &quot;\n stacked deck: &quot; &lt;&lt; stack &lt;&lt; &quot;\n&quot;;</a>
<a name="ln626"> </a>
<a name="ln627">    return desc.str();</a>
<a name="ln628">}</a>
<a name="ln629"> </a>
<a name="ln630">static formatted_string _god_extra_description(god_type which_god)</a>
<a name="ln631">{</a>
<a name="ln632">    formatted_string desc;</a>
<a name="ln633"> </a>
<a name="ln634">    switch (which_god)</a>
<a name="ln635">    {</a>
<a name="ln636">        case GOD_ASHENZARI:</a>
<a name="ln637">            if (have_passive(passive_t::bondage_skill_boost))</a>
<a name="ln638">            {</a>
<a name="ln639">                _add_par(desc, &quot;Ashenzari supports the following skills because of your curses:&quot;);</a>
<a name="ln640">                _add_par(desc,  _describe_ash_skill_boost());</a>
<a name="ln641">            }</a>
<a name="ln642">            break;</a>
<a name="ln643">        case GOD_BEOGH:</a>
<a name="ln644">            if (you_worship(GOD_BEOGH))</a>
<a name="ln645">                desc = _beogh_extra_description();</a>
<a name="ln646">            break;</a>
<a name="ln647">        case GOD_GOZAG:</a>
<a name="ln648">            if (you_worship(GOD_GOZAG))</a>
<a name="ln649">                _add_par(desc, _describe_branch_bribability());</a>
<a name="ln650">            break;</a>
<a name="ln651">        case GOD_HEPLIAKLQANA:</a>
<a name="ln652">            if (you_worship(GOD_HEPLIAKLQANA))</a>
<a name="ln653">                desc = formatted_string::parse_string(_describe_ancestor_upgrades());</a>
<a name="ln654">            break;</a>
<a name="ln655">        case GOD_NEMELEX_XOBEH:</a>
<a name="ln656">            if (you_worship(GOD_NEMELEX_XOBEH))</a>
<a name="ln657">                _add_par(desc, _describe_deck_summary());</a>
<a name="ln658">            break;</a>
<a name="ln659">        case GOD_WU_JIAN:</a>
<a name="ln660">            _add_par(desc, &quot;Martial attacks:&quot;);</a>
<a name="ln661">            desc += formatted_string::parse_string(</a>
<a name="ln662">                        getLongDescription(god_name(which_god) + &quot; extra&quot;));</a>
<a name="ln663">            break;</a>
<a name="ln664">        default:</a>
<a name="ln665">            break;</a>
<a name="ln666">    }</a>
<a name="ln667"> </a>
<a name="ln668">    return desc;</a>
<a name="ln669">}</a>
<a name="ln670"> </a>
<a name="ln671">/**</a>
<a name="ln672"> * Describe miscellaneous information about the given god.</a>
<a name="ln673"> *</a>
<a name="ln674"> * @param which_god     The god in question.</a>
<a name="ln675"> * @return              Info about gods which isn't covered by their powers,</a>
<a name="ln676"> *                      likes, or dislikes.</a>
<a name="ln677"> */</a>
<a name="ln678">static string _get_god_misc_info(god_type which_god)</a>
<a name="ln679">{</a>
<a name="ln680">    string info = &quot;&quot;;</a>
<a name="ln681">    skill_type skill = invo_skill(which_god);</a>
<a name="ln682"> </a>
<a name="ln683">    switch (skill)</a>
<a name="ln684">    {</a>
<a name="ln685">        case SK_INVOCATIONS:</a>
<a name="ln686">            break;</a>
<a name="ln687">        case SK_NONE:</a>
<a name="ln688">            if (which_god == GOD_GOZAG || which_god == GOD_WU_JIAN)</a>
<a name="ln689">                break; // XXX: no space for details</a>
<a name="ln690">            info += uppercase_first(apostrophise(god_name(which_god))) +</a>
<a name="ln691">                    &quot; powers are based on piety instead of Invocations skill.&quot;;</a>
<a name="ln692">            break;</a>
<a name="ln693">        default:</a>
<a name="ln694">            info += uppercase_first(apostrophise(god_name(which_god))) +</a>
<a name="ln695">                    &quot; powers are based on &quot; + skill_name(skill) + &quot; instead&quot;</a>
<a name="ln696">                    &quot; of Invocations skill.&quot;;</a>
<a name="ln697">            break;</a>
<a name="ln698">    }</a>
<a name="ln699"> </a>
<a name="ln700">    if (!info.empty())</a>
<a name="ln701">        info += &quot;\n\n&quot;;</a>
<a name="ln702"> </a>
<a name="ln703">    return info;</a>
<a name="ln704">}</a>
<a name="ln705"> </a>
<a name="ln706">/**</a>
<a name="ln707"> * Print a detailed description of the given god's likes and powers.</a>
<a name="ln708"> *</a>
<a name="ln709"> * @param god       The god in question.</a>
<a name="ln710"> */</a>
<a name="ln711">static formatted_string _detailed_god_description(god_type which_god)</a>
<a name="ln712">{</a>
<a name="ln713">    formatted_string desc;</a>
<a name="ln714">    _add_par(desc, getLongDescription(god_name(which_god) + &quot; powers&quot;));</a>
<a name="ln715">    _add_par(desc, get_god_likes(which_god));</a>
<a name="ln716">    _add_par(desc, _get_god_misc_info(which_god));</a>
<a name="ln717">    return desc;</a>
<a name="ln718">}</a>
<a name="ln719"> </a>
<a name="ln720">/**</a>
<a name="ln721"> * Describe the given god's level of irritation at the player.</a>
<a name="ln722"> *</a>
<a name="ln723"> * Player may or may not be currently under penance.</a>
<a name="ln724"> *</a>
<a name="ln725"> * @param which_god     The god in question.</a>
<a name="ln726"> * @return              A format string, describing the god's ire (or lack of).</a>
<a name="ln727"> */</a>
<a name="ln728">static string _raw_penance_message(god_type which_god)</a>
<a name="ln729">{</a>
<a name="ln730">    const int penance = you.penance[which_god];</a>
<a name="ln731"> </a>
<a name="ln732">    // Give more appropriate message for the good gods.</a>
<a name="ln733">    if (penance &gt; 0 &amp;&amp; is_good_god(which_god))</a>
<a name="ln734">    {</a>
<a name="ln735">        if (is_good_god(you.religion))</a>
<a name="ln736">            return &quot;%s is ambivalent towards you.&quot;;</a>
<a name="ln737">        if (!god_hates_your_god(which_god))</a>
<a name="ln738">        {</a>
<a name="ln739">            return &quot;%s is almost ready to forgive your sins.&quot;;</a>
<a name="ln740">                 // == &quot;Come back to the one true church!&quot;</a>
<a name="ln741">        }</a>
<a name="ln742">    }</a>
<a name="ln743"> </a>
<a name="ln744">    const int initial_penance = initial_wrath_penance_for(which_god);</a>
<a name="ln745">    // could do some math tricks to turn this into a table, but it seems fiddly</a>
<a name="ln746">    if (penance &gt; initial_penance * 3 / 4)</a>
<a name="ln747">        return &quot;%s's wrath is upon you!&quot;;</a>
<a name="ln748">    if (penance &gt; initial_penance / 2)</a>
<a name="ln749">        return &quot;%s well remembers your sins.&quot;;</a>
<a name="ln750">    if (penance &gt; initial_penance / 4)</a>
<a name="ln751">        return &quot;%s's wrath is beginning to fade.&quot;;</a>
<a name="ln752">    if (penance &gt; 0)</a>
<a name="ln753">        return &quot;%s is almost ready to forgive your sins.&quot;;</a>
<a name="ln754">    return &quot;%s is neutral towards you.&quot;;</a>
<a name="ln755">}</a>
<a name="ln756"> </a>
<a name="ln757">/**</a>
<a name="ln758"> * Describe the given god's level of irritation at the player.</a>
<a name="ln759"> *</a>
<a name="ln760"> * Player may or may not be currently under penance.</a>
<a name="ln761"> *</a>
<a name="ln762"> * @param which_god     The god in question.</a>
<a name="ln763"> * @return              A description of the god's ire (or lack thereof).</a>
<a name="ln764"> */</a>
<a name="ln765">static string _god_penance_message(god_type which_god)</a>
<a name="ln766">{</a>
<a name="ln767">    const string message = _raw_penance_message(which_god);</a>
<a name="ln768">    return make_stringf(message.c_str(),</a>
<a name="ln769">                        uppercase_first(god_name(which_god)).c_str());</a>
<a name="ln770">}</a>
<a name="ln771"> </a>
<a name="ln772">/**</a>
<a name="ln773"> * Print a description of the powers &amp; abilities granted to the player by the</a>
<a name="ln774"> * given god. If player worships the god, the currently available powers are</a>
<a name="ln775"> * highlighted.</a>
<a name="ln776"> *</a>
<a name="ln777"> * @param which_god     The god in question.</a>
<a name="ln778"> */</a>
<a name="ln779">static formatted_string _describe_god_powers(god_type which_god)</a>
<a name="ln780">{</a>
<a name="ln781">    formatted_string desc;</a>
<a name="ln782"> </a>
<a name="ln783">    int piety = you_worship(which_god) ? you.piety : 0;</a>
<a name="ln784"> </a>
<a name="ln785">    desc.textcolour(LIGHTGREY);</a>
<a name="ln786">    const char *header = &quot;Granted powers:&quot;;</a>
<a name="ln787">    const char *cost   = &quot;(Cost)&quot;;</a>
<a name="ln788">    desc.cprintf(&quot;\n\n%s%*s%s\n&quot;, header,</a>
<a name="ln789">            80 - strwidth(header) - strwidth(cost),</a>
<a name="ln790">            &quot;&quot;, cost);</a>
<a name="ln791"> </a>
<a name="ln792">    bool have_any = false;</a>
<a name="ln793"> </a>
<a name="ln794">    // set default color here, so we don't have to set in multiple places for</a>
<a name="ln795">    // always available passive abilities</a>
<a name="ln796">    if (!you_worship(which_god))</a>
<a name="ln797">        desc.textcolour(DARKGREY);</a>
<a name="ln798">    else</a>
<a name="ln799">        desc.textcolour(god_colour(which_god));</a>
<a name="ln800"> </a>
<a name="ln801">    // mv: Some gods can protect you from harm.</a>
<a name="ln802">    // The god isn't really protecting the player - only sometimes saving</a>
<a name="ln803">    // his life.</a>
<a name="ln804">    if (have_passive(passive_t::protect_from_harm))</a>
<a name="ln805">    {</a>
<a name="ln806">        have_any = true;</a>
<a name="ln807"> </a>
<a name="ln808">        int prot_chance = 10 + piety/10; // chance * 100</a>
<a name="ln809">        const char *when = &quot;&quot;;</a>
<a name="ln810"> </a>
<a name="ln811">        if (which_god == GOD_ELYVILON)</a>
<a name="ln812">        {</a>
<a name="ln813">            switch (elyvilon_lifesaving())</a>
<a name="ln814">            {</a>
<a name="ln815">                case lifesaving_chance::sometimes:</a>
<a name="ln816">                    when = &quot;, especially when called upon&quot;;</a>
<a name="ln817">                    prot_chance += 100 - 3000/piety;</a>
<a name="ln818">                    break;</a>
<a name="ln819">                case lifesaving_chance::always:</a>
<a name="ln820">                    when = &quot;, and always does so when called upon&quot;;</a>
<a name="ln821">                    prot_chance = 100;</a>
<a name="ln822">                    break;</a>
<a name="ln823">                default:</a>
<a name="ln824">                    break;</a>
<a name="ln825">            }</a>
<a name="ln826">        }</a>
<a name="ln827"> </a>
<a name="ln828">        const char *how = (prot_chance &gt;= 85) ? &quot;carefully&quot; :</a>
<a name="ln829">                          (prot_chance &gt;= 55) ? &quot;often&quot; :</a>
<a name="ln830">                          (prot_chance &gt;= 25) ? &quot;sometimes&quot;</a>
<a name="ln831">                                              : &quot;occasionally&quot;;</a>
<a name="ln832"> </a>
<a name="ln833">        desc.cprintf(&quot;%s %s watches over you%s.\n&quot;,</a>
<a name="ln834">                uppercase_first(god_name(which_god)).c_str(),</a>
<a name="ln835">                how,</a>
<a name="ln836">                when);</a>
<a name="ln837">    }</a>
<a name="ln838"> </a>
<a name="ln839">    switch (which_god)</a>
<a name="ln840">    {</a>
<a name="ln841">    case GOD_ZIN:</a>
<a name="ln842">    {</a>
<a name="ln843">        have_any = true;</a>
<a name="ln844">        const char *how =</a>
<a name="ln845">            (piety &gt;= piety_breakpoint(5)) ? &quot;always&quot; :</a>
<a name="ln846">            (piety &gt;= piety_breakpoint(3)) ? &quot;often&quot; :</a>
<a name="ln847">            (piety &gt;= piety_breakpoint(1)) ? &quot;sometimes&quot; :</a>
<a name="ln848">                                             &quot;occasionally&quot;;</a>
<a name="ln849"> </a>
<a name="ln850">        desc.cprintf(&quot;%s %s shields you from chaos.\n&quot;,</a>
<a name="ln851">                uppercase_first(god_name(which_god)).c_str(), how);</a>
<a name="ln852">        break;</a>
<a name="ln853">    }</a>
<a name="ln854"> </a>
<a name="ln855">    case GOD_SHINING_ONE:</a>
<a name="ln856">    {</a>
<a name="ln857">        have_any = true;</a>
<a name="ln858">        desc.cprintf(&quot;%s prevents you from stabbing unaware foes.\n&quot;,</a>
<a name="ln859">                uppercase_first(god_name(which_god)).c_str());</a>
<a name="ln860">        if (piety &lt; piety_breakpoint(1))</a>
<a name="ln861">            desc.textcolour(DARKGREY);</a>
<a name="ln862">        else</a>
<a name="ln863">            desc.textcolour(god_colour(which_god));</a>
<a name="ln864">        const char *how =</a>
<a name="ln865">            (piety &gt;= piety_breakpoint(5)) ? &quot;completely&quot; :</a>
<a name="ln866">            (piety &gt;= piety_breakpoint(3)) ? &quot;mostly&quot; :</a>
<a name="ln867">                                             &quot;partially&quot;;</a>
<a name="ln868"> </a>
<a name="ln869">        desc.cprintf(&quot;%s %s shields you from negative energy.\n&quot;,</a>
<a name="ln870">                uppercase_first(god_name(which_god)).c_str(), how);</a>
<a name="ln871"> </a>
<a name="ln872">        const int halo_size = you_worship(which_god) ? you.halo_radius() : -1;</a>
<a name="ln873">        if (halo_size &lt; 0)</a>
<a name="ln874">            desc.textcolour(DARKGREY);</a>
<a name="ln875">        else</a>
<a name="ln876">            desc.textcolour(god_colour(which_god));</a>
<a name="ln877">        desc.cprintf(&quot;You radiate a%s righteous aura, and others within it are &quot;</a>
<a name="ln878">                &quot;easier to hit.\n&quot;,</a>
<a name="ln879">                halo_size &gt; 5 ? &quot; large&quot; :</a>
<a name="ln880">                halo_size &gt; 3 ? &quot;&quot; :</a>
<a name="ln881">                                &quot; small&quot;);</a>
<a name="ln882">        break;</a>
<a name="ln883">    }</a>
<a name="ln884"> </a>
<a name="ln885">    case GOD_JIYVA:</a>
<a name="ln886">        have_any = true;</a>
<a name="ln887">        if (have_passive(passive_t::slime_feed))</a>
<a name="ln888">            desc.textcolour(god_colour(which_god));</a>
<a name="ln889">        else</a>
<a name="ln890">            desc.textcolour(DARKGREY);</a>
<a name="ln891">        desc.cprintf(&quot;You gain nutrition%s when your fellow slimes consume items.\n&quot;,</a>
<a name="ln892">                have_passive(passive_t::slime_hp) ? &quot;, magic and health&quot; :</a>
<a name="ln893">                have_passive(passive_t::slime_mp) ? &quot; and magic&quot; :</a>
<a name="ln894">                                                    &quot;&quot;);</a>
<a name="ln895">        break;</a>
<a name="ln896"> </a>
<a name="ln897">    case GOD_FEDHAS:</a>
<a name="ln898">        have_any = true;</a>
<a name="ln899">        desc.cprintf(&quot;You can walk through plants and fire through allied plants.\n&quot;);</a>
<a name="ln900">        break;</a>
<a name="ln901"> </a>
<a name="ln902">    case GOD_ASHENZARI:</a>
<a name="ln903">        have_any = true;</a>
<a name="ln904">        desc.cprintf(&quot;You are provided with a bounty of information.\n&quot;);</a>
<a name="ln905">        break;</a>
<a name="ln906"> </a>
<a name="ln907">    case GOD_CHEIBRIADOS:</a>
<a name="ln908">        have_any = true;</a>
<a name="ln909">        if (have_passive(passive_t::stat_boost))</a>
<a name="ln910">            desc.textcolour(god_colour(which_god));</a>
<a name="ln911">        else</a>
<a name="ln912">            desc.textcolour(DARKGREY);</a>
<a name="ln913">        desc.cprintf(&quot;%s %sslows your movement.\n&quot;,</a>
<a name="ln914">                uppercase_first(god_name(which_god)).c_str(),</a>
<a name="ln915">                piety &gt;= piety_breakpoint(5) ? &quot;greatly &quot; :</a>
<a name="ln916">                piety &gt;= piety_breakpoint(2) ? &quot;&quot; :</a>
<a name="ln917">                                               &quot;slightly &quot;);</a>
<a name="ln918">        desc.cprintf(&quot;%s supports your attributes. (+%d)\n&quot;,</a>
<a name="ln919">                uppercase_first(god_name(which_god)).c_str(),</a>
<a name="ln920">                chei_stat_boost(piety));</a>
<a name="ln921">        break;</a>
<a name="ln922"> </a>
<a name="ln923">    case GOD_VEHUMET:</a>
<a name="ln924">        have_any = true;</a>
<a name="ln925">        if (const int numoffers = you.vehumet_gifts.size())</a>
<a name="ln926">        {</a>
<a name="ln927">            const char* offer = numoffers == 1</a>
<a name="ln928">                               ? spell_title(*you.vehumet_gifts.begin())</a>
<a name="ln929">                               : &quot;some of Vehumet's most lethal spells&quot;;</a>
<a name="ln930">            desc.cprintf(&quot;You can memorise %s.\n&quot;, offer);</a>
<a name="ln931">        }</a>
<a name="ln932">        else</a>
<a name="ln933">        {</a>
<a name="ln934">            desc.textcolour(DARKGREY);</a>
<a name="ln935">            desc.cprintf(&quot;You can memorise some of Vehumet's spells.\n&quot;);</a>
<a name="ln936">        }</a>
<a name="ln937">        break;</a>
<a name="ln938"> </a>
<a name="ln939">    case GOD_DITHMENOS:</a>
<a name="ln940">    {</a>
<a name="ln941">        have_any = true;</a>
<a name="ln942">        const int umbra_size = you_worship(which_god) ? you.umbra_radius() : -1;</a>
<a name="ln943">        if (umbra_size &lt; 0)</a>
<a name="ln944">            desc.textcolour(DARKGREY);</a>
<a name="ln945">        else</a>
<a name="ln946">            desc.textcolour(god_colour(which_god));</a>
<a name="ln947">        desc.cprintf(&quot;You radiate a%s aura of darkness, enhancing your stealth &quot;</a>
<a name="ln948">                &quot;and reducing the accuracy of your foes.\n&quot;,</a>
<a name="ln949">                umbra_size &gt; 5 ? &quot; large&quot; :</a>
<a name="ln950">                umbra_size &gt; 3 ? &quot;n&quot; :</a>
<a name="ln951">                                 &quot; small&quot;);</a>
<a name="ln952">        break;</a>
<a name="ln953">    }</a>
<a name="ln954"> </a>
<a name="ln955">    case GOD_GOZAG:</a>
<a name="ln956">        have_any = true;</a>
<a name="ln957">        desc.cprintf(&quot;You passively detect gold.\n&quot;);</a>
<a name="ln958">        desc.cprintf(&quot;%s turns your defeated foes' bodies to gold.\n&quot;,</a>
<a name="ln959">                uppercase_first(god_name(which_god)).c_str());</a>
<a name="ln960">        desc.cprintf(&quot;Your enemies may become distracted by gold.\n&quot;);</a>
<a name="ln961">        break;</a>
<a name="ln962"> </a>
<a name="ln963">    case GOD_HEPLIAKLQANA:</a>
<a name="ln964">        have_any = true;</a>
<a name="ln965">        desc.cprintf(&quot;Your life essence is reduced. (-10%% HP)\n&quot;);</a>
<a name="ln966">        break;</a>
<a name="ln967"> </a>
<a name="ln968">#if TAG_MAJOR_VERSION == 34</a>
<a name="ln969">    case GOD_PAKELLAS:</a>
<a name="ln970">    {</a>
<a name="ln971">        have_any = true;</a>
<a name="ln972">        desc.cprintf(&quot;%s prevents your magic from regenerating.\n&quot;,</a>
<a name="ln973">                uppercase_first(god_name(which_god)).c_str());</a>
<a name="ln974">        desc.cprintf(&quot;%s identifies device charges for you.\n&quot;,</a>
<a name="ln975">                uppercase_first(god_name(which_god)).c_str());</a>
<a name="ln976">        if (!you_foodless(false))</a>
<a name="ln977">        {</a>
<a name="ln978">            if (have_passive(passive_t::bottle_mp))</a>
<a name="ln979">                desc.textcolour(god_colour(which_god));</a>
<a name="ln980">            else</a>
<a name="ln981">                desc.textcolour(DARKGREY);</a>
<a name="ln982"> </a>
<a name="ln983">            desc.cprintf(&quot;%s will collect and distill excess magic from your &quot;</a>
<a name="ln984">                    &quot;kills.\n&quot;,</a>
<a name="ln985">                    uppercase_first(god_name(which_god)).c_str());</a>
<a name="ln986">        }</a>
<a name="ln987">        break;</a>
<a name="ln988">    }</a>
<a name="ln989">#endif</a>
<a name="ln990"> </a>
<a name="ln991">    case GOD_LUGONU:</a>
<a name="ln992">        have_any = true;</a>
<a name="ln993">        desc.cprintf(&quot;You are protected from the effects of unwielding distortion weapons.\n&quot;);</a>
<a name="ln994">        break;</a>
<a name="ln995"> </a>
<a name="ln996">    default:</a>
<a name="ln997">        break;</a>
<a name="ln998">    }</a>
<a name="ln999"> </a>
<a name="ln1000">    for (const auto&amp; power : get_god_powers(which_god))</a>
<a name="ln1001">    {</a>
<a name="ln1002">        // hack: don't mention the necronomicon alone unless it</a>
<a name="ln1003">        // wasn't already mentioned by the other description</a>
<a name="ln1004">        if (power.abil == ABIL_KIKU_GIFT_NECRONOMICON</a>
<a name="ln1005">            &amp;&amp; you.species != SP_FELID)</a>
<a name="ln1006">        {</a>
<a name="ln1007">            continue;</a>
<a name="ln1008">        }</a>
<a name="ln1009">        have_any = true;</a>
<a name="ln1010"> </a>
<a name="ln1011">        if (you_worship(which_god)</a>
<a name="ln1012">            &amp;&amp; (power.rank &lt;= 0</a>
<a name="ln1013">                || power.rank == 7 &amp;&amp; can_do_capstone_ability(which_god)</a>
<a name="ln1014">                || piety_rank(piety) &gt;= power.rank)</a>
<a name="ln1015">            &amp;&amp; (!player_under_penance()</a>
<a name="ln1016">                || power.rank == -1))</a>
<a name="ln1017">        {</a>
<a name="ln1018">            desc.textcolour(god_colour(which_god));</a>
<a name="ln1019">        }</a>
<a name="ln1020">        else</a>
<a name="ln1021">            desc.textcolour(DARKGREY);</a>
<a name="ln1022"> </a>
<a name="ln1023">        string buf = power.general;</a>
<a name="ln1024">        if (!isupper(buf[0])) // Complete sentence given?</a>
<a name="ln1025">            buf = &quot;You can &quot; + buf + &quot;.&quot;;</a>
<a name="ln1026">        const int desc_len = buf.size();</a>
<a name="ln1027"> </a>
<a name="ln1028">        string abil_cost = &quot;(&quot; + make_cost_description(power.abil) + &quot;)&quot;;</a>
<a name="ln1029">        if (abil_cost == &quot;(None)&quot;)</a>
<a name="ln1030">            abil_cost = &quot;&quot;;</a>
<a name="ln1031"> </a>
<a name="ln1032">        desc.cprintf(&quot;%s%*s%s\n&quot;, buf.c_str(), 80 - desc_len - (int)abil_cost.size(),</a>
<a name="ln1033">                &quot;&quot;, abil_cost.c_str());</a>
<a name="ln1034">    }</a>
<a name="ln1035"> </a>
<a name="ln1036">    if (!have_any)</a>
<a name="ln1037">        desc.cprintf(&quot;None.\n&quot;);</a>
<a name="ln1038"> </a>
<a name="ln1039">    return desc;</a>
<a name="ln1040">}</a>
<a name="ln1041"> </a>
<a name="ln1042">static formatted_string _god_overview_description(god_type which_god)</a>
<a name="ln1043">{</a>
<a name="ln1044">    formatted_string desc;</a>
<a name="ln1045"> </a>
<a name="ln1046">    // Print god's description.</a>
<a name="ln1047">    const string god_desc = getLongDescription(god_name(which_god));</a>
<a name="ln1048">    desc += trimmed_string(god_desc) + &quot;\n&quot;;</a>
<a name="ln1049"> </a>
<a name="ln1050">    // Title only shown for our own god.</a>
<a name="ln1051">    if (you_worship(which_god))</a>
<a name="ln1052">    {</a>
<a name="ln1053">        // Print title based on piety.</a>
<a name="ln1054">        desc.cprintf(&quot;\nTitle  - &quot;);</a>
<a name="ln1055">        desc.textcolour(god_colour(which_god));</a>
<a name="ln1056"> </a>
<a name="ln1057">        string title = god_title(which_god, you.species, you.piety);</a>
<a name="ln1058">        desc.cprintf(&quot;%s&quot;, title.c_str());</a>
<a name="ln1059">    }</a>
<a name="ln1060"> </a>
<a name="ln1061">    // mv: Now let's print favour as Brent suggested.</a>
<a name="ln1062">    // I know these messages aren't perfect so if you can think up</a>
<a name="ln1063">    // something better, do it.</a>
<a name="ln1064"> </a>
<a name="ln1065">    desc.textcolour(LIGHTGREY);</a>
<a name="ln1066">    desc.cprintf(&quot;\nFavour - &quot;);</a>
<a name="ln1067">    desc.textcolour(god_colour(which_god));</a>
<a name="ln1068"> </a>
<a name="ln1069">    if (!you_worship(which_god))</a>
<a name="ln1070">        desc.cprintf(&quot;%s&quot;, _god_penance_message(which_god).c_str());</a>
<a name="ln1071">    else</a>
<a name="ln1072">    {</a>
<a name="ln1073">        desc.cprintf(&quot;%s&quot;, _describe_favour(which_god).c_str());</a>
<a name="ln1074">        if (which_god == GOD_ASHENZARI)</a>
<a name="ln1075">            desc.cprintf(&quot;\n%s&quot;, ash_describe_bondage(ETF_ALL, true).c_str());</a>
<a name="ln1076">    }</a>
<a name="ln1077">    desc += _describe_god_powers(which_god);</a>
<a name="ln1078">    desc.cprintf(&quot;\n\n&quot;);</a>
<a name="ln1079"> </a>
<a name="ln1080">    return desc;</a>
<a name="ln1081">}</a>
<a name="ln1082"> </a>
<a name="ln1083">static void build_partial_god_ui(god_type which_god, shared_ptr&lt;ui::Popup&gt;&amp; popup, shared_ptr&lt;Switcher&gt;&amp; desc_sw, shared_ptr&lt;Switcher&gt;&amp; more_sw)</a>
<a name="ln1084">{</a>
<a name="ln1085">    formatted_string topline;</a>
<a name="ln1086">    topline.textcolour(god_colour(which_god));</a>
<a name="ln1087">    topline += formatted_string(uppercase_first(god_name(which_god, true)));</a>
<a name="ln1088"> </a>
<a name="ln1089">    auto vbox = make_shared&lt;Box&gt;(Widget::VERT);</a>
<a name="ln1090">    vbox-&gt;set_cross_alignment(Widget::STRETCH);</a>
<a name="ln1091">    auto title_hbox = make_shared&lt;Box&gt;(Widget::HORZ);</a>
<a name="ln1092"> </a>
<a name="ln1093">#ifdef USE_TILE</a>
<a name="ln1094">    auto icon = make_shared&lt;Image&gt;();</a>
<a name="ln1095">    const tileidx_t idx = tileidx_feature_base(altar_for_god(which_god));</a>
<a name="ln1096">    icon-&gt;set_tile(tile_def(idx, get_dngn_tex(idx)));</a>
<a name="ln1097">    title_hbox-&gt;add_child(move(icon));</a>
<a name="ln1098">#endif</a>
<a name="ln1099"> </a>
<a name="ln1100">    auto title = make_shared&lt;Text&gt;(topline.trim());</a>
<a name="ln1101">    title-&gt;set_margin_for_sdl(0, 0, 0, 16);</a>
<a name="ln1102">    title_hbox-&gt;add_child(move(title));</a>
<a name="ln1103"> </a>
<a name="ln1104">    title_hbox-&gt;set_main_alignment(Widget::CENTER);</a>
<a name="ln1105">    title_hbox-&gt;set_cross_alignment(Widget::CENTER);</a>
<a name="ln1106">    vbox-&gt;add_child(move(title_hbox));</a>
<a name="ln1107"> </a>
<a name="ln1108">    desc_sw = make_shared&lt;Switcher&gt;();</a>
<a name="ln1109">    more_sw = make_shared&lt;Switcher&gt;();</a>
<a name="ln1110">    desc_sw-&gt;current() = 0;</a>
<a name="ln1111">    more_sw-&gt;current() = 0;</a>
<a name="ln1112"> </a>
<a name="ln1113">    const formatted_string descs[4] = {</a>
<a name="ln1114">        _god_overview_description(which_god),</a>
<a name="ln1115">        _detailed_god_description(which_god),</a>
<a name="ln1116">        _god_wrath_description(which_god),</a>
<a name="ln1117">        _god_extra_description(which_god)</a>
<a name="ln1118">    };</a>
<a name="ln1119"> </a>
<a name="ln1120">#ifdef USE_TILE_LOCAL</a>
<a name="ln1121"># define MORE_PREFIX &quot;[&lt;w&gt;!&lt;/w&gt;/&lt;w&gt;^&lt;/w&gt;&quot; &quot;|&lt;w&gt;Right-click&lt;/w&gt;&quot; &quot;]: &quot;</a>
<a name="ln1122">#else</a>
<a name="ln1123"># define MORE_PREFIX &quot;[&lt;w&gt;!&lt;/w&gt;/&lt;w&gt;^&lt;/w&gt;&quot; &quot;]: &quot;</a>
<a name="ln1124">#endif</a>
<a name="ln1125"> </a>
<a name="ln1126">    int mores_index = descs[3].empty() ? 0 : 1;</a>
<a name="ln1127">    const char* mores[2][4] =</a>
<a name="ln1128">    {</a>
<a name="ln1129">        {</a>
<a name="ln1130">            MORE_PREFIX &quot;&lt;w&gt;Overview&lt;/w&gt;|Powers|Wrath&quot;,</a>
<a name="ln1131">            MORE_PREFIX &quot;Overview|&lt;w&gt;Powers&lt;/w&gt;|Wrath&quot;,</a>
<a name="ln1132">            MORE_PREFIX &quot;Overview|Powers|&lt;w&gt;Wrath&lt;/w&gt;&quot;,</a>
<a name="ln1133">            MORE_PREFIX &quot;Overview|Powers|Wrath&quot;</a>
<a name="ln1134">        },</a>
<a name="ln1135">        {</a>
<a name="ln1136">            MORE_PREFIX &quot;&lt;w&gt;Overview&lt;/w&gt;|Powers|Wrath|Extra&quot;,</a>
<a name="ln1137">            MORE_PREFIX &quot;Overview|&lt;w&gt;Powers&lt;/w&gt;|Wrath|Extra&quot;,</a>
<a name="ln1138">            MORE_PREFIX &quot;Overview|Powers|&lt;w&gt;Wrath&lt;/w&gt;|Extra&quot;,</a>
<a name="ln1139">            MORE_PREFIX &quot;Overview|Powers|Wrath|&lt;w&gt;Extra&lt;/w&gt;&quot;</a>
<a name="ln1140">        }</a>
<a name="ln1141">    };</a>
<a name="ln1142"> </a>
<a name="ln1143">    for (int i = 0; i &lt; 4; i++)</a>
<a name="ln1144">    {</a>
<a name="ln1145">        const auto &amp;desc = descs[i];</a>
<a name="ln1146">        if (desc.empty())</a>
<a name="ln1147">            continue;</a>
<a name="ln1148"> </a>
<a name="ln1149">        auto scroller = make_shared&lt;Scroller&gt;();</a>
<a name="ln1150">        auto text = make_shared&lt;Text&gt;(desc.trim());</a>
<a name="ln1151">        text-&gt;set_wrap_text(true);</a>
<a name="ln1152">        scroller-&gt;set_child(text);</a>
<a name="ln1153">        desc_sw-&gt;add_child(move(scroller));</a>
<a name="ln1154"> </a>
<a name="ln1155">        more_sw-&gt;add_child(make_shared&lt;Text&gt;(</a>
<a name="ln1156">                formatted_string::parse_string(mores[mores_index][i])));</a>
<a name="ln1157">    }</a>
<a name="ln1158"> </a>
<a name="ln1159">    desc_sw-&gt;set_margin_for_sdl(20, 0);</a>
<a name="ln1160">    desc_sw-&gt;set_margin_for_crt(1, 0);</a>
<a name="ln1161">    desc_sw-&gt;expand_h = false;</a>
<a name="ln1162">#ifdef USE_TILE_LOCAL</a>
<a name="ln1163">    desc_sw-&gt;max_size().width = tiles.get_crt_font()-&gt;char_width()*80;</a>
<a name="ln1164">#endif</a>
<a name="ln1165">    vbox-&gt;add_child(desc_sw);</a>
<a name="ln1166"> </a>
<a name="ln1167">    vbox-&gt;add_child(more_sw);</a>
<a name="ln1168"> </a>
<a name="ln1169">    popup = make_shared&lt;ui::Popup&gt;(vbox);</a>
<a name="ln1170">}</a>
<a name="ln1171"> </a>
<a name="ln1172">static const string _god_service_fee_description(god_type which_god)</a>
<a name="ln1173">{</a>
<a name="ln1174">    const int fee = (which_god == GOD_GOZAG) ? gozag_service_fee() : 0;</a>
<a name="ln1175"> </a>
<a name="ln1176">    if (which_god == GOD_GOZAG)</a>
<a name="ln1177">    {</a>
<a name="ln1178">        if (fee == 0)</a>
<a name="ln1179">        {</a>
<a name="ln1180">            return string(&quot; (no fee if you &quot;)</a>
<a name="ln1181">                          + random_choose(&quot;act now&quot;, &quot;join today&quot;) + &quot;)&quot;;</a>
<a name="ln1182">        }</a>
<a name="ln1183">        else</a>
<a name="ln1184">            return make_stringf(&quot; (%d gold; you have %d)&quot;, fee, you.gold);</a>
<a name="ln1185">    }</a>
<a name="ln1186"> </a>
<a name="ln1187">    return &quot;&quot;;</a>
<a name="ln1188">}</a>
<a name="ln1189"> </a>
<a name="ln1190">#ifdef USE_TILE_WEB</a>
<a name="ln1191">static void _send_god_ui(god_type god, bool is_altar)</a>
<a name="ln1192">{</a>
<a name="ln1193">    tiles.json_open_object();</a>
<a name="ln1194"> </a>
<a name="ln1195">    const tileidx_t idx = tileidx_feature_base(altar_for_god(god));</a>
<a name="ln1196">    tiles.json_open_object(&quot;tile&quot;);</a>
<a name="ln1197">    tiles.json_write_int(&quot;t&quot;, idx);</a>
<a name="ln1198">    tiles.json_write_int(&quot;tex&quot;, get_dngn_tex(idx));</a>
<a name="ln1199">    tiles.json_close_object();</a>
<a name="ln1200"> </a>
<a name="ln1201">    tiles.json_write_int(&quot;colour&quot;, god_colour(god));</a>
<a name="ln1202">    tiles.json_write_string(&quot;name&quot;, god_name(god, true));</a>
<a name="ln1203">    tiles.json_write_bool(&quot;is_altar&quot;, is_altar);</a>
<a name="ln1204"> </a>
<a name="ln1205">    tiles.json_write_string(&quot;description&quot;, getLongDescription(god_name(god)));</a>
<a name="ln1206">    if (you_worship(god))</a>
<a name="ln1207">    {</a>
<a name="ln1208">        tiles.json_write_string(&quot;title&quot;, god_title(god, you.species, you.piety));</a>
<a name="ln1209">        if (god == GOD_ASHENZARI)</a>
<a name="ln1210">            tiles.json_write_string(&quot;bondage&quot;, ash_describe_bondage(ETF_ALL, true));</a>
<a name="ln1211">    }</a>
<a name="ln1212">    tiles.json_write_string(&quot;favour&quot;, you_worship(god) ?</a>
<a name="ln1213">            _describe_favour(god) : _god_penance_message(god));</a>
<a name="ln1214">    tiles.json_write_string(&quot;powers_list&quot;,</a>
<a name="ln1215">            _describe_god_powers(god).to_colour_string());</a>
<a name="ln1216">    tiles.json_write_string(&quot;info_table&quot;, &quot;&quot;);</a>
<a name="ln1217"> </a>
<a name="ln1218">    tiles.json_write_string(&quot;powers&quot;,</a>
<a name="ln1219">            _detailed_god_description(god).to_colour_string());</a>
<a name="ln1220">    tiles.json_write_string(&quot;wrath&quot;,</a>
<a name="ln1221">            _god_wrath_description(god).to_colour_string());</a>
<a name="ln1222">    tiles.json_write_string(&quot;extra&quot;,</a>
<a name="ln1223">            _god_extra_description(god).to_colour_string());</a>
<a name="ln1224">    tiles.json_write_string(&quot;service_fee&quot;,</a>
<a name="ln1225">            _god_service_fee_description(god));</a>
<a name="ln1226">    tiles.push_ui_layout(&quot;describe-god&quot;, 1);</a>
<a name="ln1227">}</a>
<a name="ln1228">#endif</a>
<a name="ln1229"> </a>
<a name="ln1230">void describe_god(god_type which_god)</a>
<a name="ln1231">{</a>
<a name="ln1232">    if (which_god == GOD_NO_GOD) //mv: No god -&gt; say it and go away.</a>
<a name="ln1233">    {</a>
<a name="ln1234">        mpr(&quot;You are not religious.&quot;);</a>
<a name="ln1235">        return;</a>
<a name="ln1236">    }</a>
<a name="ln1237"> </a>
<a name="ln1238">    shared_ptr&lt;ui::Popup&gt; popup;</a>
<a name="ln1239">    shared_ptr&lt;Switcher&gt; desc_sw;</a>
<a name="ln1240">    shared_ptr&lt;Switcher&gt; more_sw;</a>
<a name="ln1241">    build_partial_god_ui(which_god, popup, desc_sw, more_sw);</a>
<a name="ln1242"> </a>
<a name="ln1243">    bool done = false;</a>
<a name="ln1244">    popup-&gt;on_keydown_event([&amp;](const KeyEvent&amp; ev) {</a>
<a name="ln1245">        const auto key = ev.key();</a>
<a name="ln1246">        if (key == '!' || key == CK_MOUSE_CMD || key == '^')</a>
<a name="ln1247">        {</a>
<a name="ln1248">            int n = (desc_sw-&gt;current() + 1) % desc_sw-&gt;num_children();</a>
<a name="ln1249">            desc_sw-&gt;current() = more_sw-&gt;current() = n;</a>
<a name="ln1250">#ifdef USE_TILE_WEB</a>
<a name="ln1251">                tiles.json_open_object();</a>
<a name="ln1252">                tiles.json_write_int(&quot;pane&quot;, n);</a>
<a name="ln1253">                tiles.ui_state_change(&quot;describe-god&quot;, 0);</a>
<a name="ln1254">#endif</a>
<a name="ln1255">            return true;</a>
<a name="ln1256">        }</a>
<a name="ln1257">        return done = !desc_sw-&gt;current_widget()-&gt;on_event(ev);</a>
<a name="ln1258">    });</a>
<a name="ln1259"> </a>
<a name="ln1260">#ifdef USE_TILE_WEB</a>
<a name="ln1261">    _send_god_ui(which_god, false);</a>
<a name="ln1262">    popup-&gt;on_layout_pop([](){ tiles.pop_ui_layout(); });</a>
<a name="ln1263">#endif</a>
<a name="ln1264"> </a>
<a name="ln1265">    ui::run_layout(popup, done);</a>
<a name="ln1266">}</a>
<a name="ln1267"> </a>
<a name="ln1268">bool describe_god_with_join(god_type which_god)</a>
<a name="ln1269">{</a>
<a name="ln1270">    const string service_fee = _god_service_fee_description(which_god);</a>
<a name="ln1271"> </a>
<a name="ln1272">    shared_ptr&lt;ui::Popup&gt; popup;</a>
<a name="ln1273">    shared_ptr&lt;Switcher&gt; desc_sw;</a>
<a name="ln1274">    shared_ptr&lt;Switcher&gt; more_sw;</a>
<a name="ln1275">    build_partial_god_ui(which_god, popup, desc_sw, more_sw);</a>
<a name="ln1276"> </a>
<a name="ln1277">    for (auto&amp; child : *more_sw)</a>
<a name="ln1278">    {</a>
<a name="ln1279">        Text* label = static_cast&lt;Text*&gt;(child.get());</a>
<a name="ln1280">        formatted_string text = label-&gt;get_text();</a>
<a name="ln1281">        text += formatted_string::parse_string(&quot;  [&lt;w&gt;J&lt;/w&gt;/&lt;w&gt;Enter&lt;/w&gt;]: &quot;</a>
<a name="ln1282">                                               &quot;join&quot;);</a>
<a name="ln1283"> </a>
<a name="ln1284">        // We assume that a player who has enough gold such that</a>
<a name="ln1285">        // the join fee plus accumulated gold overflows knows what this menu</a>
<a name="ln1286">        // does.</a>
<a name="ln1287">        if (text.width() + service_fee.length() + 9 &lt;= MIN_COLS)</a>
<a name="ln1288">            text += &quot; religion&quot;;</a>
<a name="ln1289">        if (!service_fee.empty())</a>
<a name="ln1290">            text += service_fee;</a>
<a name="ln1291">        label-&gt;set_text(text);</a>
<a name="ln1292">    }</a>
<a name="ln1293"> </a>
<a name="ln1294">    // States for the state machine</a>
<a name="ln1295">    enum join_step_type {</a>
<a name="ln1296">        SHOW = -1, // Show the usual god UI</a>
<a name="ln1297">        ABANDON, // Ask whether to abandon god, if applicable</a>
<a name="ln1298">    };</a>
<a name="ln1299"> </a>
<a name="ln1300">    // Add separate text widgets the possible abandon-god prompts;</a>
<a name="ln1301">    // then when a different prompt needs to be shown, we switch to that prompt.</a>
<a name="ln1302">    // This is somewhat brittle, but ensures that the UI doesn't resize when</a>
<a name="ln1303">    // switching between prompts.</a>
<a name="ln1304">    const string abandon_prompt =</a>
<a name="ln1305">        make_stringf(&quot;Are you sure you want to abandon %s?&quot;,</a>
<a name="ln1306">                god_name(you.religion).c_str());</a>
<a name="ln1307">    formatted_string prompt_fs(abandon_prompt, channel_to_colour(MSGCH_PROMPT));</a>
<a name="ln1308"> </a>
<a name="ln1309">    more_sw-&gt;add_child(make_shared&lt;Text&gt;(prompt_fs));</a>
<a name="ln1310"> </a>
<a name="ln1311">    prompt_fs.cprintf(&quot; [Y]es or [n]o only, please.&quot;);</a>
<a name="ln1312">    more_sw-&gt;add_child(make_shared&lt;Text&gt;(prompt_fs));</a>
<a name="ln1313"> </a>
<a name="ln1314">    join_step_type step = SHOW;</a>
<a name="ln1315">    bool yesno_only = false;</a>
<a name="ln1316">    bool done = false, join = false;</a>
<a name="ln1317"> </a>
<a name="ln1318">    // The join-god UI state machine transition function</a>
<a name="ln1319">    popup-&gt;on_keydown_event([&amp;](const KeyEvent&amp; ev) {</a>
<a name="ln1320">        const auto keyin = ev.key();</a>
<a name="ln1321"> </a>
<a name="ln1322">        // Always handle escape and pane-switching keys the same way</a>
<a name="ln1323">        if (keyin == CK_ESCAPE)</a>
<a name="ln1324">            return done = true;</a>
<a name="ln1325">        if (keyin == '!' || keyin == CK_MOUSE_CMD || keyin == '^')</a>
<a name="ln1326">        {</a>
<a name="ln1327">            int n = (desc_sw-&gt;current() + 1) % desc_sw-&gt;num_children();</a>
<a name="ln1328">            desc_sw-&gt;current() = n;</a>
<a name="ln1329">#ifdef USE_TILE_WEB</a>
<a name="ln1330">            tiles.json_open_object();</a>
<a name="ln1331">            tiles.json_write_int(&quot;pane&quot;, n);</a>
<a name="ln1332">            tiles.ui_state_change(&quot;describe-god&quot;, 0);</a>
<a name="ln1333">#endif</a>
<a name="ln1334">            if (step == SHOW)</a>
<a name="ln1335">            {</a>
<a name="ln1336">                more_sw-&gt;current() = n;</a>
<a name="ln1337">                return true;</a>
<a name="ln1338">            }</a>
<a name="ln1339">            else</a>
<a name="ln1340">                yesno_only = false;</a>
<a name="ln1341">        }</a>
<a name="ln1342"> </a>
<a name="ln1343">        // Next, allow child widgets to handle scrolling keys</a>
<a name="ln1344">        // NOTE: these key exceptions are also specified in ui-layouts.js</a>
<a name="ln1345">        if (keyin != 'J' &amp;&amp; keyin != CK_ENTER)</a>
<a name="ln1346">        if (desc_sw-&gt;current_widget()-&gt;on_event(ev))</a>
<a name="ln1347">            return true;</a>
<a name="ln1348"> </a>
<a name="ln1349">        if (step == ABANDON)</a>
<a name="ln1350">        {</a>
<a name="ln1351">            if (keyin != 'Y' &amp;&amp; toupper_safe(keyin) != 'N')</a>
<a name="ln1352">                yesno_only = true;</a>
<a name="ln1353">            else</a>
<a name="ln1354">                yesno_only = false;</a>
<a name="ln1355"> </a>
<a name="ln1356">            if (toupper_safe(keyin) == 'N')</a>
<a name="ln1357">            {</a>
<a name="ln1358">                canned_msg(MSG_OK);</a>
<a name="ln1359">                return done = true;</a>
<a name="ln1360">            }</a>
<a name="ln1361"> </a>
<a name="ln1362">            if (keyin == 'Y')</a>
<a name="ln1363">                return done = join = true;</a>
<a name="ln1364">        }</a>
<a name="ln1365">        else if ((keyin == 'J' || keyin == CK_ENTER) &amp;&amp; step == SHOW)</a>
<a name="ln1366">        {</a>
<a name="ln1367">            if (you_worship(GOD_NO_GOD))</a>
<a name="ln1368">                return done = join = true;</a>
<a name="ln1369"> </a>
<a name="ln1370">            step = ABANDON;</a>
<a name="ln1371">        }</a>
<a name="ln1372">        else</a>
<a name="ln1373">            return done = true;</a>
<a name="ln1374"> </a>
<a name="ln1375">#ifdef USE_TILE_WEB</a>
<a name="ln1376">        tiles.json_open_object();</a>
<a name="ln1377">        string prompt = abandon_prompt + (yesno_only ? &quot; [Y]es or [n]o only, please.&quot; : &quot;&quot;);</a>
<a name="ln1378">        tiles.json_write_string(&quot;prompt&quot;, prompt);</a>
<a name="ln1379">        tiles.json_write_int(&quot;pane&quot;, desc_sw-&gt;current());</a>
<a name="ln1380">        tiles.ui_state_change(&quot;describe-god&quot;, 0);</a>
<a name="ln1381">#endif</a>
<a name="ln1382">        if (step == ABANDON)</a>
<a name="ln1383">            more_sw-&gt;current() = desc_sw-&gt;num_children() + step*2 + yesno_only;</a>
<a name="ln1384">        return true;</a>
<a name="ln1385">    });</a>
<a name="ln1386"> </a>
<a name="ln1387">#ifdef USE_TILE_WEB</a>
<a name="ln1388">    _send_god_ui(which_god, true);</a>
<a name="ln1389">    popup-&gt;on_layout_pop([](){ tiles.pop_ui_layout(); });</a>
<a name="ln1390">#endif</a>
<a name="ln1391"> </a>
<a name="ln1392">    ui::run_layout(popup, done);</a>
<a name="ln1393"> </a>
<a name="ln1394">    return join;</a>
<a name="ln1395">}</a>

</code></pre>
<div class="balloon" rel="289"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v648/" target="_blank">V648</a> Priority of the '&&' operation is higher than that of the '||' operation.</p></div>
<div class="balloon" rel="1013"><p><span style="font-size:18px">&uarr;</span> <a href="https://www.viva64.com/en/w/v648/" target="_blank">V648</a> Priority of the '&&' operation is higher than that of the '||' operation.</p></div>

<link rel="stylesheet" href="highlight.css">
<script src="highlight.pack.js"></script>
<script src="highlightjs-line-numbers.js"></script>
<script>hljs.initHighlightingOnLoad();</script>
<script>hljs.initLineNumbersOnLoad();</script>
<script>
  $(document).ready(function() {
      $('.balloon').each(function () {
          var bl = $(this);
          var line = bl.attr('rel');
          var text = $('a[name="ln'+line+'"]').text();

          var space_count = 0;
          for(var i = 0; i<text.length; i++){
              var char = text[i];
              if((char !== ' ')&&(char !== '\t'))break;
              if(char === '\t')space_count++;
              space_count++;
          }

          bl.css('margin-left', space_count*8);
          $('a[name="ln'+line+'"]').after(bl);
      });

      window.location = window.location;
  });
</script>
</body>
</html>
